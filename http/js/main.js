App.blink=function(e,t,a,n){let i=t||8;n=n||"background-color",i%2&&i++;let l=!0,s=function(){e&&(l?e.css(n,a):a&&e.css(n,""),l=!l,i--,i>0&&setTimeout(s,300))};setTimeout(s,300)},App.mobilePanel=function(e,t,a){return a=a||{},window.top.BootstrapDialog.show($.extend({type:"edit",message:t,draggable:!0,title:e,cssClass:"mobile-panel "+(a.buttons?" with-buttons":"")},a))},App.panelTimer=function(e,t,a){let n,i=t,l=$("<div>");l.html(i);let s=BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:e,message:l,onhide:function(){n&&clearTimeout(n)},buttons:[{action:function(e){n&&clearTimeout(n),e.close()},label:App.translate("Cancel")}]}),o=function(){--i<=0?(s.close(),a()):(l.html(i),n=setTimeout(o,1e3))};o()},App.panel=function(e,t,a){return a=a||{},window.top.BootstrapDialog.show($.extend({type:"edit",message:t,draggable:!0,title:e,cssClass:"web-panel "+(a.buttons?" with-buttons ":"")+(a.class||"")},a))},App.setSessionStorage=function(e,t){sessionStorage.setItem(e,JSON.stringify(t))},App.totumCodeEdit=function(e,t,a,n,i){return new Promise((l,s)=>{let o,r,d,c=$('<div class="HTMLEditor" id="bigOneCodemirror" style="height: 100%;"></div>'),p=$('<div class="totum-edit-codes"></div>').append(c),f=e,h=!1;n&&(r=$('<div class="flex">').appendTo(p),n.forEach(([e,t,a])=>{let n=$('<input type="checkbox">').attr("name",e),i=$('<div class="">').append(n).append($("<label>").text(t).on("click",()=>{n.trigger("click")}));a&&n.prop("checked",!0),r.append(i)}));const u=()=>{let e=[];return n&&p.find("input").each((function(){e[this.name]=this.checked})),e},m=()=>{h=!0,l({code:o.getValue(),checkboxes:u()}),d.close()};$("body").on("ctrlS.CodeEdit",()=>{m()});let b=[{action:m,cssClass:"btn-warning btn-save",label:App.translate("Save")+" Alt+S"},{action:()=>{d.close()},cssClass:"btn-default btn-save",label:'<i class="fa fa-times"></i>'}];i&&b.unshift({action:()=>{App.confirmation(App.translate("Disable code")+" "+t,{[App.translate("Cancel")]:e=>{e.close()},[App.translate("Disable")]:e=>{h=!0,l({code:o.getValue(),checkboxes:u(),switchoff:!0}),e.close(),d.close()}},App.translate("Code disabling"))},cssClass:"btn-default btn-save",label:App.translate("Disable")}),window.top.BootstrapDialog.show({message:p,type:null,title:t,buttons:b,cssClass:"fieldparams-edit-panel",draggable:!0,onhidden:()=>{$("body").off("ctrlS.CodeEdit"),h||s()},onshow:function(e){d=e,e.$modalHeader.css("cursor","pointer");let t=100;r&&(t+=r.height()),e.$modalContent.css({width:"90vw",minHeight:"calc(90vh - "+t+"px)"})},onshown:function(e){o=CodeMirror(c.get(0),{mode:"totum",value:f,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:m}),a&&(o.table=a);let t=Math.round(e.$modalContent.height()-e.$modalHeader.outerHeight()-40);o.getScrollerElement().style.minHeight=t+"px",c.find(".CodeMirror").css("min-heught",t),o.focus(),e.$modalContent.position({my:"center top",at:"center top+30px",of:window.top})}})})},App.translate=function(e,t){return App.lang&&App.lang.translates[e]&&(e=App.lang.translates[e]),t&&("object"!=typeof t&&(t=[t]),t.forEach(t=>{e=e.replace(/%s/,t)})),e},BootstrapDialog.BUTTON_SIZES[BootstrapDialog.SIZE_NORMAL]="btn-m",BootstrapDialog.defaultOptions.animate=!1,BootstrapDialog.defaultOptions.closeByBackdrop=!1,BootstrapDialog.defaultOptions.nl2br=!1,BootstrapDialog.defaultOptions.type=null,BootstrapDialog.TYPE_DANGER=null,BootstrapDialog.BootstrapDialogModal.prototype.resetScrollbar=function(){0===this.getGlobalOpenedDialogs().length&&this.$body.css("padding-right",5)},BootstrapDialog.prototype.initOptions=function(e){this.options=$.extend(!0,this.defaultOptions,e);let t=this.options.onshown;return this.options.onshown=e=>{let a;t&&"function"==typeof t&&t.call(this,e);let n=e.$modalFooter.find("button");const i=()=>{a=$('<div style="position: fixed; right: '+(e.$modal.width()-e.$modalBody.width()-e.$modalBody.offset().left-10)+'px; bottom: 20px; z-index: 1100">').appendTo(e.$modal).append(n)};setTimeout(()=>{e.$modalFooter.get(0).getBoundingClientRect().top>window.innerHeight-20&&i()},200),e.$modal.on("scroll",()=>{e.$modalFooter.get(0).getBoundingClientRect().top>window.innerHeight-20?a||i():a&&(e.$modalFooter.append(n),a.remove(),a=null)})},this},$((function(){window.top.lastCtrl=window.top.lastCtrl||0,$("body").on("keydown",e=>{if((e.ctrlKey||e.altKey)&&(window.top.lastCtrl=Date.now()),(window.top.wasCtrl(e)||e.metaKey||e.altKey)&&"s"===String.fromCharCode(e.which).toLowerCase()){let e=$._data(document.body,"events").ctrlS;if(e&&e.length){return e[e.length-1].handler.bind(document.body)(),!1}}}),window.top.wasCtrl=e=>e.ctrlKey||e.altKey||window.top&&window.top.lastCtrl>0&&Date.now()-window.top.lastCtrl<500})),function(){let e=0,t=-1;const a=(e,t)=>'<div id="'+e+'">'+App.translate("__clock_shelve_panel")+" <button>"+t+"</button></button></div>";let n,i;setTimeout(()=>{i=App.models.table("/Table/"),i.addPcTable({model:i})},10),App.checkNotificationManager=function(e){if(e=e||void 0,Object.keys(e).length>1){if(!n||!n.closest("body").length){let t;n=$('<div data-notify="container" class="col-xs-11 col-sm-4 alert alert-warning" role="alert" id="notifies_manager" ><button type="button" aria-hidden="true" class="close" data-notify="dismiss">&times;</button><button class="timer" id="notification_clock_panel_all_timer"><i class="fa fa-clock-o"></i></button></div>'),n.appendTo("body"),n.find("button.close").on("click",(function(){l(),n.remove(),n=null,i.notificationUpdate(Object.keys(e),"deactivate").then((function(){})),Object.values(e).forEach(e=>{e.forEach(e=>{e.$modal.remove()})}),e=[]})).on("remove",()=>{t&&t.popover("destroy")}),n.find("button.timer").on("click",(function(){if($(this).is(".active"))return!1;$(this).addClass("active"),t=$(this),$div=$("<div>").append(a("notification_clock_panel_all",App.translate("Shelve all"))),$div.on("click","button",(function(){let t=$div.find("input").val(),a=$div.find("select").val();l(),i.notificationUpdate(Object.keys(e),"later",t,a).then((function(){})),n.remove(),n=null,Object.values(e).forEach(e=>{e.forEach(e=>{e.$modal.remove()})}),e=[]})),t.popover({placement:"bottom",content:$div,html:!0,animation:!1,container:$("body")}).popover("show"),t.on("remove",l),setTimeout(()=>{$("body").on("click.notes",e=>{$(e.originalEvent.path[0]).closest("#notification_clock_panel_all").length||(t.popover("destroy"),l())})},20)}));const l=function(){$("body").off("click.notes"),$("#notification_clock_panel_all_timer").removeClass("active")}}}else n&&(n.remove(),n=null)},App.showLInks=function(a,n){a.forEach((function(a){if(-1!==["top-iframe","iframe"].indexOf(a.target)&&window.top!=window)return void window.top.App.showLInks([a],n);let i=function(l){"use strict";if(a.postData){let t,s="_self";if("iframe"===l||"top-iframe"===l){let l="iframe"+ ++e;s=l;let o,r=BootstrapDialog.show({message:o=$('<iframe style="width: 100%; '+(a.width?"":"min-width: 500px;")+' height: 70vh; border: none" name = "'+l+'"></iframe>'),size:BootstrapDialog.SIZE_WIDE,title:a.title,draggable:!0,cssClass:"target-iframe",onhidden:function(){if(a.refresh){$("#table").data("pctable");n.refresh(null,a.refresh)}},onshown:function(e){if(a.width){let t=500;a.width>t&&(t=a.width),e.$modalDialog.width(t)}let t=o.get(0).contentWindow,n=function(){try{t.App&&t.App.setSessionStorage?t.App.setSessionStorage.call(t,"linkObject",a):setTimeout(n,200)}catch(e){}};n()},buttons:[{label:App.translate("Refresh"),cssClass:"btn-m btn-default",action:function(){o.get(0).contentWindow.location.reload(),t.detach()}},{label:App.translate("Open"),cssClass:"btn-m btn-default",action:function(e){i("self")}},{label:App.translate("Tab"),cssClass:"btn-m btn-default",action:function(e){window.open(o.get(0).contentWindow.location,"_blank"),e.close()}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}]});o.on("load",(function(){let e=o.get(0).contentWindow;try{e.closeMe=function(){r.close()}}catch(e){}}))}else"blank"===l?s="_blank":"parent"===l?s="_parent":"top"===l?s="_top":window.parent!==window&&(sessionStorage.linkObject=JSON.stringify(a));t=$("<form>",{method:"post",action:a.uri,target:s});const o=function(e,a){"boolean"==typeof a&&(a=!0===a?"true":"false"),"string"==typeof a||"number"==typeof a||null===a?t.append($("<input>",{type:"hidden",name:e,value:a})):$.each(a,(function(t,a){o(e+"["+t+"]",a)}))};$.each(a.postData,(function(e,t){o(e,t)})),t.appendTo("body").submit(),t.detach()}else switch(l){case"top":window.top.location.href=a.uri;break;case"parent":window.parent.location.href=a.uri;break;case"blank":let e=$('<a href="'+a.uri+'" target="_blank">link</a>');e.appendTo("body"),e.get(0).click(),e.remove();break;case"iframe":case"top-iframe":let l=a.uri;if(a.elseData){let e=[];!1===a.elseData.header&&e.push("param"),!1===a.elseData.footer&&e.push("footer"),l+="#"+encodeURIComponent(JSON.stringify({wc:e}))}let s=$('<iframe src="'+l+'" style="width: 100%; height: 70vh; border: none"></iframe>'),o=BootstrapDialog.show({message:s,draggable:!0,size:BootstrapDialog.SIZE_WIDE,title:a.title,cssClass:"target-iframe",onhidden:function(){a.refresh&&n.refresh(null,a.refresh),t--},onshown:function(e){a.width&&e.$modalDialog.width(a.width),++t&&e.$modalDialog.css("margin-top",30+20*t);let n=s.get(0).contentWindow,i=function(){try{n.App&&n.App.setSessionStorage?n.App.setSessionStorage.call(n,"linkObject",a):setTimeout(i,200)}catch(e){}};i()},buttons:[{label:App.translate("Refresh"),cssClass:"btn-m btn-default",action:function(){s.get(0).contentWindow.location.reload()}},{label:App.translate("Open"),cssClass:"btn-m btn-default",action:function(e){try{s.get(0).contentWindow.sessionStorage.linkObject&&(a=JSON.parse(s.get(0).contentWindow.sessionStorage.linkObject))}catch(e){}i("self")}},{label:App.translate("Tab"),cssClass:"btn-m btn-default",action:function(e){window.open(s.get(0).contentWindow.location,"_blank"),e.close()}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}]});s.on("load",(function(){let e=s.get(0).contentWindow;try{e.closeMe=function(){o.close()}}catch(e){}}));break;default:window.parent!=window&&(sessionStorage.linkObject=JSON.stringify(a)),window.location.href=a.uri}};i(a.target)}))},App.showDatas=function(e,t,n){let i,s=[],o=this;return e.forEach((function(e){switch(e[0]){case"fileUpload":$('<input type="file" '+(e[1].limit>1?"multiple":"")+' accept="'+e[1].type+'" style="display:none">').appendTo("body").click().on("change",(function(){let t=[];if(this.files.length>e[1].limit)App.notify(App.translate("Upload limit exceeded"));else{for(var a=0;a<this.files.length;a++){let e=this.files.item(a);t.push(new Promise((t,a)=>{var n=new FileReader;n.onloadend=function(){t({name:e.name,base64:btoa(n.result)})},n.readAsBinaryString(e)}))}Promise.all(t).then(t=>{o.filesUpload(t,e[1].hash).then(()=>{e[1].refresh&&o.refresh(null,e[1].refresh)})})}}));break;case"files":e[1].files.forEach(e=>{for(var t=atob(e.string),a=[],n=0;n<t.length;n+=512){for(var i=t.slice(n,n+512),l=new Array(i.length),s=0;s<i.length;s++)l[s]=i.charCodeAt(s);var o=new Uint8Array(l);a.push(o)}let r=new Blob(a,{type:e.type});saveAs(r,e.name)});break;case"input":let r,d,c=$("<div>").html(e[1].html);c.find("#ttmInput").length?r=c.find("#ttmInput"):(r=$('<input type="text" class="form-control" id="ttmInput">'),e[1].type&&(r.attr("type",e[1].type),"password"===e[1].type&&r.attr("autocomplete","off")),e[1].value&&r.val(e[1].value),c.append(r),r.wrap("<div>"),r.on("keydown",e=>{13===e.keyCode&&p()}));let p=function(){o.inputClick(e[1].hash,r.val()).then((function(){e[1].close&&n&&n.closeMe?window.closeMe():e[1].refresh&&o.refresh(null,e[1].refresh),d.close()}))};setTimeout(()=>{r.focus()},1),i={buttons:[{label:e[1].button||App.translate("Save"),action:p},{label:App.translate("Cancel"),action:function(e){e.close()}}],class:"linkButtons"},screen.width<=window.MOBILE_MAX_WIDTH?d=App.mobilePanel(e[1].title,c,i):(!i.width&&i.html||(i.onshown=function(e){i.width&&e.$modalDialog.width(i.width)}),d=App.panel(e[1].title,c,i));break;case"buttons":i={...e[1],buttons:[],class:"linkButtons"},e[1].buttons.forEach((function(t,a){i.buttons.push({id:"link-btn"+a,label:t.text,action:function(t){o.buttonsClick(e[1].hash,a).then((function(){e[1].close&&n&&n.closeMe?window.closeMe():e[1].buttons[a].refresh&&o.refresh(null,e[1].buttons[a].refresh),t.close()}))},icon:t.icon?"fa fa-"+t.icon:null,background:t.background,color:t.color})})),screen.width<=window.MOBILE_MAX_WIDTH?App.mobilePanel(e[1].title,$("<div>").html(e[1].html),i):(!i.width&&i.html||(i.onshown=function(e){i.width&&e.$modalDialog.width(i.width),i.html||e.$modalBody.remove(),i.buttons.forEach(t=>{let a=e.getButton(t.id);t.background&&a.css("background-color",t.background),t.color&&a.css("color",t.color)})}),App.panel(e[1].title,$("<div>").html(e[1].html),i));break;case"table":if(window.top!=window)return window.top.App.showDatas.call(o,[e]);s.push(function(e,t){let a;e.height&&(a=e.height,/^\d+$/.test(e.height)&&(a+="px"));let n="/Table/0/"+e.table_id+"?sess_hash="+e.sess_hash+"&iframe=1";"/"===window.location.pathname||/^\/Table\//.test(window.location.pathname)||(n=e.table_id+"?sess_hash="+e.sess_hash+"&iframe=1");let i=$('<iframe style="width: 100%; height: '+(a||"80vh")+'; border: none;" src="'+n+'">');$("body").append(i);let s=[];$("#table").data("pctable")&&$("#table").data("pctable").isCreatorView&&s.push({label:App.translate("In a new tab"),cssClass:"btn-m btn-danger",action:function(e){window.open(i.get(0).contentWindow.location,"_blank");e.close()}});let o=l(e.title,i,e.width,e.refresh,null,t,s);i.on("load",(function(){i.get(0).contentWindow.closeMe=function(){o.close()}}))}(e[1],o));break;case"text":s.push(function(e,t){l(e.title,e.text,e.width,e.refresh,null,t)}(e[1],o));break;case"json":s.push(function(e,t){let a=$("<div>"),n=e.hash?{}:{mode:"view"},i=new JSONEditor(a.get(0),n,e.json),s=[];e.hash&&s.push({action:a=>{t.linkJsonClick(e.hash,JSON.stringify(i.get())),a.close()},label:e.buttontext,cssClass:"btn-warning btn-save"});l(e.title,a,e.width,e.refresh,null,t,s)}(e[1],o));break;case"print":s.push(function(e,t,a){if(App.fullScreenProcesses.showCog(),a){var n=new Blob([atob(a)],{type:"application/pdf"}),i=URL.createObjectURL(n),l=document.createElement("a");l.href=i,l.target="_blank",document.body.appendChild(l),l.click()}else{let a=$('<iframe style="width: 500px; height: 200px; position: absolute; top: -1000px; background: #fff;">').appendTo(window.top.document.body)[0],n=a.contentWindow?a.contentWindow:a.contentDocument.defaultView;n.document.head.innerHTML="<style>"+t+"</style>",n.document.body.innerHTML=e;let i=n.document.body,l=$.Deferred(),s=0;const o=function(){i.scrollTop=i.scrollHeight+100,++s<100&&i.scrollTop>=i.scrollHeight?setTimeout(o,50):setTimeout((function(){l.resolve()}),2e3)},r=function(){++s<100&&i.scrollHeight<200?setTimeout(r,50):(s=0,o())};r(),l.then((function(){App.fullScreenProcesses.hideCog(),setTimeout((function(){n.focus(),n.print()}),250),setTimeout((function(){}),1e4)}))}}(e[1].body,e[1].styles));break;case"notification":let f,h,u=function(e){let t={x:20,y:70};return screen.width<=window.MOBILE_MAX_WIDTH&&(t.x=.09*window.innerWidth/2),e&&(t.y+=60),t}();e[1].text?h="<div>"+e[1].text+"</div>":(h=e[1].title+'<div class="body"></div>',setTimeout(()=>{f.$ele.find(".body").append(function(e,t){let a;e.height&&(a=e.height,/^\d+$/.test(e.height)&&(a+="px"));let n="/Table/0/"+e.table_id+"?sess_hash="+e.sess_hash;/^\/Table\//.test(window.location.pathname)||window.location.pathname.match(/^\/(\?.*)?$/)||(n=e.table_id+"?sess_hash="+e.sess_hash);let i=$('<iframe style="width: 100%; height: '+(a||"80vh")+'; border: none;" src="'+n+'">');return i.on("load",(function(){let e=i.get(0).contentWindow;e.closeMe=t,$(e.document.body).css("background-color","transparent").addClass("notification-table")})),i}(e[1],()=>{f.$ele.remove()}))})),f=$.notify({message:h},{offset:u,type:"warning",allow_dismiss:!0,delay:0,onClose:function(){f.$ele.data("deactivated")||o.notificationUpdate(t,"deactivate").then((function(){f.$ele.trigger("hide.bs.modal")}))}}),f.$ele.find("button.close").after('<button class="timer"><i class="fa fa-clock-o"></i></button>'),f.$ele.css("transition","none"),f.$ele.on("click",".timer:not(.disabled)",(function(){let e=$(this);e.addClass("disabled"),$div=$("<div>").append(a("notification_clock_panel",App.translate("Shelve"))),$div.on("click","button",(function(){let a=$div.find("input").val(),i=$div.find("select").val();n(),o.notificationUpdate(t,"later",a,i).then((function(){})),e.popover("destroy"),f.$ele.data("deactivated",!0),f.$ele.find('button[data-notify="dismiss"]').click()}));const n=function(){$("body").off("click.note"+t),e.removeClass("disabled")};e.popover({placement:"bottom",content:$div,html:!0,animation:!1,container:$("body")}).popover("show"),e.on("remove",n),setTimeout(()=>{$("body").on("click.note"+t,t=>{$(t.originalEvent.path[0]).closest("#notification_clock_panel").length||(e.popover("destroy"),n())})},20)})),s.push({$modal:f.$ele,simpleClose:()=>{f.$ele.data("deactivated",!0),f.$ele.find('button[data-notify="dismiss"]').click()},notification:f})}})),s},App.getPcTableById=function(e,t,a,n){let i=$.Deferred();return new App.models.table("/Table/0/"+e.toString(),{},{}).getTableData(t?t.sess_hash:null).then((function(l){if(n&&(!1===n.withHeader||!1===n.withFooter)){Object.values(l.fields).forEach((function(e,t){("param"===e.category&&!1===n.withHeader||"footer"===e.category&&!1===n.withFooter)&&delete l.fields[e.name]})),delete n.withHeader,delete n.withFooter}l.model=new App.models.table("/Table/0/"+e.toString(),$.extend({updated:l.updated},t||{})),$.extend(!0,l,n);let s=new App.pcTableMain(a,l);i.resolve(s)})),i.promise()},App.showPanels=function(e,t){if(window.top!=window)return window.top.App.showPanels.call(window.top,e);let a={},n=$.Deferred();const i=function(){let l=e.shift(),s={},o={};l.id?s.id=l.id:l.field&&(s=l.field,o=s);const r=function(a){new EditPanel(a,null,s,e.length>0,o).then((function(a,s){(a||s)&&e.length?i():(l.refresh&&t.model.refresh(null,l.refresh),n.resolve())}))};l.uri!==window.location.pathname?a[l.uri]?r(a[l.uri]):new App.models.table(l.uri,{},{}).getTableData().then((function(e){e.model=new App.models.table(l.uri,{updated:e.updated}),a[l.uri]=new App.pcTableMain(null,e),r(a[l.uri])})):r($("#table").data("pctable"))};return i(),n};let l=function(e,a,n,i,l,s,o){return(o=o||[]).push({label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}),BootstrapDialog.show({message:a,title:e,type:l||null,draggable:!0,onhidden:function(){i&&("strong"===i?window.location.reload():s.refresh(null,i)),t--},onshown:function(e){n&&e.$modalDialog.width(n),++t&&e.$modalDialog.css("margin-top",30+20*t)},buttons:o})}}(),Object.equals=function(e,t){let a=[];return function e(t,n){if(t===n)return!0;if(t instanceof Date&&n instanceof Date)return+t==+n;if("object"!=typeof t||"object"!=typeof n||null===n||null===t)return!1;if(function(e,t){for(var n=a.length;n--;)if(!(a[n][0]!==e&&a[n][0]!==t||a[n][1]!==t&&a[n][1]!==e))return!0;return!1}(t,n))return!0;if(a.push([t,n]),Array.isArray(t)!==Array.isArray(n))return!1;if(Array.isArray(t)){if(t.length!==n.length)return!1;let a=t.length;for(;a--;)if(!e(t[a],n[a]))return!1}else{let a=Object.keys(t),i=a.length;if(Object.keys(n).length!==i)return!1;for(;i--;)if(!e(t[a[i]],n[a[i]]))return!1}return!0}(e,t)},Object.getPath=function(e,t,a){let n=e;for(let e=0;e<t.length;e++){let i=t[e];if("object"!=typeof n||!(i in n))return a;n=n[i]}return n},String.prototype.hashCode=function(){var e,t=0;if(0===this.length)return t;for(e=0;e<this.length;e++)t=(t<<5)-t+this.charCodeAt(e),t|=0;return t},App.confirmation=function(e,t,a){let n=[];return Object.keys(t).forEach((function(e){n.push({label:e,action:t[e]})})),BootstrapDialog.show({type:"edit",title:a,message:e,buttons:n,draggable:!0,onshow:function(e){e.$modalContent.css({width:"70vw",maxWidth:"800px"})},onshown:function(e){e.$modalContent.position({of:window})}})},App.copyMe=function(e){let t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)},$((function(){App.dateFormats={base:App.lang.dateFormat,db:"YYYY-MM-DD",covert:function(e,t,a){return moment(e,t).format(a)},covertToDb:function(e,t){t=t||this.base;return moment(e,t).format(this.db)},covertFromDb:function(e,t){t=t||this.base;return moment(e,this.db).format(t)},isValid:function(e,t){t=t||this.base;return moment(e,t).isValid()}},App.dateTimeFormats={base:App.lang.dateTimeFormat,db:"YYYY-MM-DD HH:mm",covert:function(e,t,a){return moment(e,t).format(a)},covertToDb:function(e,t){t=t||this.base;return moment(e,t).format(this.db)},covertFromDb:function(e,t){t=t||this.base;return moment(e,this.db).format(t)},isValid:function(e,t){t=t||this.base;return moment(e,t).isValid()}}})),function(){let e="fa-cog",t=$("#big_loading i"),a=0;App.fullScreenProcesses={showCog:function(){a++,1===a&&App.fullScreenProcesses.show("fa-cog",!0)},hideCog:function(){a--,a<1&&(a=0,App.fullScreenProcesses.hide())}},App.fullScreenProcesses.show=function(a,n){n=n||!1,$("body").addClass("lock"),n&&!t.is(".fa-spin")?t.addClass("fa-spin"):!n&&t.is(".fa-spin")&&t.removeClass("fa-spin"),e!=a&&(t.removeClass(e).addClass(a),e=a),$("#big_loading").show().animate({opacity:1},250)},App.fullScreenProcesses.hide=function(e){$("body").removeClass("lock"),$("#big_loading").animate({opacity:0},250,(function(){$("#big_loading").hide()}))}}(),App.hexToRGB=function(e,t){var a=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),i=parseInt(e.slice(5,7),16);return t?"rgba("+a+", "+n+", "+i+", "+t+")":"rgb("+a+", "+n+", "+i+")"},$.fn.extend({isAttached:function(){return 1===$(this).closest("html").length}}),App.isTopWindow=function(){let e=!1;try{e=window!=window.top||document!=top.document||self.location!=top.location}catch(t){e=!0}return!e},App.logOutput=function(e){let t=$('<div style="overflow-x: auto">'),a=[{label:App.translate("Expand All"),cssClass:"btn-m btn-default",action:function(e){t.jstree("open_all")}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];"string"==typeof e&&a.splice(0,1),window.top.BootstrapDialog.show({message:t,type:BootstrapDialog.TYPE_DANGER,title:App.translate("Scheme of calculation"),buttons:a,draggable:!0,cssClass:"log-output",onshown:function(a){a.$modalContent.position({of:window.top}),"string"==typeof e?t.html('<div style="color: white; ">'+e+"</div>"):t.jstree({state:{key:"leftTree"},core:{check_callback:!0,open_parents:!0,data:e,themes:{name:"default-dark"}},types:{folder:{},code:{icon:"fa fa-cog"},cogs:{icon:"fa fa-cogs"},error:{icon:"fa fa-exclamation-triangle"},list:{icon:"fa fa-code"},fixed:{icon:"fa fa-hand-rock-o"},param:{icon:"fa fa-hashtag"},execcode:{icon:"fa fa-magic"},recalcs:{icon:"fa fa-recycle"},clocks:{icon:"fa fa-clock-o"},mbs:{icon:"fa fa-database"},selects:{icon:"fa fa-navicon"},"!":{icon:"fa fa-exclamation"},table_simple:App.tableTypes.simple,table_version:App.tableTypes.version,table_calcs:App.tableTypes.calcs,table_tmp:App.tableTypes.tmp,table_globcalcs:App.tableTypes.globcalcs,table_cycles:App.tableTypes.cycles},plugins:["types","themes"]}).on("click","a.jstree-anchor",(function(){let e,a,n=t.jstree(!0).get_node(this.id);try{e=JSON.parse(n.text),a=""}catch(t){try{let t=n.text.match(/^([a-zA-Z_0-1]+)\s*:\s*(.*)$/);e=JSON.parse(t[2]),a=t[1]}catch(t){e=n.text}}if(e){if("string"==typeof e){element=$('<div class="HTMLEditor" id="bigOneCodemirror">').height(500);var i=new CodeMirror(element.get(0),{value:e,mode:"text/html",height:"500px",readOnly:!0,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0});let t=setInterval(()=>{element.isAttached()&&(i.refresh(),clearInterval(t))},50)}else element=$('<div class="JSONEditor">').height(500),i=new JSONEditor(element.get(0),{mode:"view"},e);window.top.BootstrapDialog.show({message:element,title:a,onshown:function(e){e.$modalContent.position({of:window.top})},onshow:function(e){let t=.8*window.top.innerWidth;e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:t})}})}}))},onshow:function(e){let t=.8*window.top.innerWidth;e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:t}),e.$modalContent.find(".modal-body").css("background-color","#333")}})},App.modal=function(e,t,a){var n=$('<div class="modal fade" id="appNotify" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title"></h4> </div> <div class="modal-body"> </div> <div class="modal-footer"> </div> </div> </div> </div>');if((l={body:n.find(".modal-body"),header:n.find(".modal-header"),title:n.find(".modal-title"),footer:n.find(".modal-footer"),block:n}).block.on("hidden.bs.modal",(function(){$(this).remove()})),"object"==typeof e&&e instanceof jQuery?l.body.empty().append(e):l.body.html(e),t?l.title.html(t):l.header.hide(),a)if("object"==typeof a){var i=$("<div>"),l=l;$.each(a,(function(e,t){if("close"!=t){var a="default";"object"==typeof t&&(t.class&&(a=t.class),t.func&&(t=t.func));var n=$('<button type="button" class="btn btn-'+a+'">'+e+"</button>");i.append(n),t&&"function"==typeof t&&n.on("click",(function(){t(l.block)}))}else i.append('<button type="button" class="btn btn-default" data-dismiss="modal">'+e+"</button>")})),l.footer.html(i.children())}else l.footer.html(a);else l.footer.hide();return l.block.modal("show").css("z-index","10000"),l.block},$.expr.pseudos.multiincludes=function(e,t,a){let n=$(e).find("a"),i=(n.data("tokens")||n.text()).toString(),l=a[3];return[i,l]=App.lang.search_prepare_function(i,l),l=l.split(" "),!l.some((function(e){return-1===i.indexOf(e)}))},App.notify=function(e,t,a){let n=$.Deferred();return window.top.BootstrapDialog.show({message:e,type:BootstrapDialog.TYPE_DEFAULT,title:t,buttons:[{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],onshow:function(e){t||e.$modalHeader.remove(),e.$modal.css("z-index",2e3),n.resolve(e)}}),n},App.topNotify=function(e,t,a){t=t||"",$("#notifies").append('<div class="alert alert-success"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>'+t+"</strong>"+e+"</div>")},App.popNotify=function(e,t,a,n,i){let l,s="bottom",o={},r={};return e.isParams&&(o=e,e.element&&(t=e.element),e.timeout&&(a=e.timeout),void 0!==e.container&&(n=e.container),e.trigger&&(i=e.trigger),e.placement&&(s=e.placement),e.class&&(l=e.class),e=e.$text),a=a||void 0,n=void 0===n?t.closest(".pcTable-scrollwrapper, .InsertPanel"):n,i=i||"manual",r=$.extend(r,{html:!0,content:e,trigger:i,container:n,placement:s,width:"70vw",animation:!1}),"default"==a&&(a=2e3),t.on("shown.bs.popover",(function(){let e=t.data("bs.popover"),a=parseInt(e.$tip.css("left")),i=parseInt(e.$arrow.css("left"));if(a<0&&(e.$tip.css("left",0),e.$arrow.css("left",i+a+"px")),"bottom"===s){let a=t.offset().top+t.outerHeight(),i=e.$tip.offset().top,l=n?n.scrollTop()-n.offset().top:0;i-a>10&&e.$tip.css("top",a+2+l+(n.is(".InsertPanel")?$(".modal-dialog").offset().top:0))}})),t.popover(r),"manual"==i&&(t.popover("show"),l&&$("#"+t.attr("aria-describedby")).addClass(l)),t.on("remove destroy",(function(){t&&t.attr("aria-describedby")&&t.popover("destroy")})),e.on&&e.on("remove destroy",(function(){t.length&&t.attr("aria-describedby")&&$("#"+t.attr("aria-describedby")).length&&t.popover("destroy")})),a&&setTimeout((function(){t&&t.attr("aria-describedby")&&t.popover("destroy")}),a),t.attr("aria-describedby")},App.ksort=function(e){var t=Object.keys(e).sort(),a={};for(var n in t)a[t[n]]=e[t[n]];return a},App.values=function(e){let t=[];for(let a in e)t.push(e[a]);return t},App.keys=function(e){let t=[];for(let a in e)t.push(a);return t},App.isEmpty=function(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;if("object"!=typeof e)return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0},App.filter=function(e,t){let a={};return Object.keys(e).forEach((function(n){t(n,e[n])&&(a[n]=e[n])})),a},App.openInIframe=function(e,t,a){a=a||"newIframe";let n=$('<iframe style="min-width: 500px; width: 100%; height: 70vh; border: none" name = "'+a+'"></iframe>');BootstrapDialog.show({message:n.attr("src",t),size:BootstrapDialog.SIZE_WIDE,title:e,buttons:[{label:App.translate("Refresh"),cssClass:"btn-m btn-default",action:function(e){let i;i=$('<iframe style="min-width: 500px; width: 100%; height: 70vh; border: none" name = "'+a+'"></iframe>').attr("src",t),n.replaceWith(i),n=i}},{label:App.translate("Open"),cssClass:"btn-m btn-default",action:function(e){$("<a>").attr("href",t).hide().appendTo("body").get(0).click(),e.close()}},{label:App.translate("Tab"),cssClass:"btn-m btn-default",action:function(e){let a=$("<a>").attr("href",t).attr("target","_blank").hide().appendTo("body");a.get(0).click(),a.remove(),e.close()}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}]})},App.aInIframe=function(e){return e=$(e),App.openInIframe(e.text(),e.attr("href")),!1},App.reUserInterface=function(e,t,a,n){let i=$("#UserFio");i.css("cursor","pointer");let l=App.models.table("/Table/",{},{isCreatorView:n}),s=$("#table").data("pctable")||{model:l};l.addPcTable(s),a&&App.blink(i,10,"#ffe486"),i.on("click",(function(a){if(i.attr("aria-describedby"))return!0;let s,o=$('<div class="tech-table" style="width: 200px;"></div>');if(t.length){o.height(125);let e=$('<div class="panel-buttons">');o.prepend(e),t.forEach(t=>{let a=$('<button class="btn btn-default btn-xxs"></button>').text(t.title).on("click",()=>{window.location.href="/Table/0/"+t.name});e.append(a)})}else if(!n){o.height(60);let e=$("<div>");o.prepend(e),l.loadUserButtons().then(t=>{t.panelFormats&&t.panelFormats.rows.forEach(a=>{switch(a.type){case"text":e.append($('<div class="panel-text">').text(a.value));break;case"html":e.append($('<div class="panel-html">').html(a.value));break;case"img":e.append($('<div class="panel-img">').append($("<img>").attr("src","/fls/"+a.value+"_thumb.jpg?rand="+Math.random())));break;case"buttons":if(a.value&&a.value.forEach){let n=[];a.value.forEach(e=>{let a=$('<button class="btn btn-default btn-xxs">').text(e.text);n.push(a),e.color&&a.css("color",e.color),e.background&&a.css("background-color",e.background),a.on("click",(function(){l.userButtonsClick(t.panelFormats.hash,e.ind).then((function(t){e.refresh&&l.refresh(null,e.refresh)}))}))}),e.append($('<div class="panel-buttons">').append(n))}}})})}if(Object.keys(e).length){let a=$('<div class="select-btn"></div>').appendTo(o);s=$('<select data-size="'+(t.length?13-t.length-1:n?13:11)+'" class="open" title="'+App.translate("Select user")+'" data-style="btn-sm btn-default" data-live-search="true" data-width="100%">'),Object.keys(e).forEach((function(t){s.append($("<option>").text(t).data("content",e[t]))})),a.append(s)}i.popover({html:!0,content:o,trigger:"manual",container:"body",placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),s&&(o.height(350),s.selectpicker("render").selectpicker("toggle"),s.data("container",o),s.on("hide.bs.select",(function(){return s.val()&&l.reUser(s.val()),!1})),setTimeout((function(){i.popover("show"),s.selectpicker("render"),$("#"+i.attr("aria-describedby")).css("top","45px"),s.data("selectpicker").$searchbox.focus()}),300)),setTimeout(()=>{i.popover("show"),$("body").one("click.FioPopover",(function(e){void 0!==e.altKey&&i.popover("destroy")}))},300)}))},App.rgb2hex=function(e){return(e=e.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i))&&4===e.length?"#"+("0"+parseInt(e[1],10).toString(16)).slice(-2)+("0"+parseInt(e[2],10).toString(16)).slice(-2)+("0"+parseInt(e[3],10).toString(16)).slice(-2):""},App.tableTypes={simple:{icon:"fa fa-table",title:App.translate("Simple")},calcs:{icon:"fa fa-calculator",title:App.translate("Calculated in the cycle")},globcalcs:{icon:"fa fa-calculator",title:App.translate("Calculated")},tmp:{icon:"fa fa-clock-o",title:App.translate("Temporary")},cycles:{icon:"fa fa-circle-o",title:App.translate("Cycles")}},App.textWithLinks=function(e){return $("<div>").text(e).html().replace(/(https?:\/\/[^\s]+)/g,(function(e){return'<a href="'+e+'" target="_blank">'+e+"</a>"}))},function(){var e=0;App.getUn=function(){return e++}}(),$((function(){if(screen.width>window.MOBILE_MAX_WIDTH){let e=$("#main-page");if(e.length){let t,a=$(".page_content"),n=!1;const i=function(){t=window.innerHeight;let a=$("#tables_tabls").length?200:100;e.height(window.innerHeight-a).niceScroll({cursorwidth:7,mousescrollstep:190,mousescroll:190,autohidemode:!1,enablekeyboard:!0,cursoropacitymin:1,railoffset:{left:4},cursorcolor:"#e1e0df"}),n=!0,e.getNiceScroll().resize()},l=function(){e.height("").getNiceScroll().remove(),n=!1},s=function(){a.is(".tree-minifyed")&&n||!e.is(":visible")?l():a.is(".tree-minifyed")||n&&window.innerHeight==t||i()};$("#tables_tabls").on("hidden.bs.tab",e=>{s()});const o=document.getElementsByClassName("page_content")[0],r={attributes:!0,childList:!1,subtree:!1};new MutationObserver(s).observe(o,r),s()}}})),LOGINJS=function(){let e=$('<div><div class="form-group"><label>Email:</label><input id="elseEmail"  type="text"\n                                                                      name="login"\n                                                                      value=""\n                                                                      class="form-control"\n                /></div></div>');if($("body").on("click","#recover",(function(){let t=[{action:function(e){if(""==$("#elseEmail").val().trim())return void $("#elseEmail").addClass("error");let t=$('<form method="post"><input type="hidden" name="login" value=""><input type="hidden" name="recover" value="true"></form>');t.find('[name="login"]').val($("#elseEmail").val()),t.appendTo("body"),t.submit(),e.close()},label:App.translate("Send password to email")},{action:function(e){e.close()},label:App.translate("Cancel")}];BootstrapDialog.show({message:e,title:App.translate("New password"),buttons:t,draggable:!0})})),$("body").on("click","#register",(function(){let t=[{action:function(e){if(""==$("#elseEmail").val().trim())return void $("#elseEmail").addClass("error");let t=$('<form method="post"><input type="hidden" name="login" value=""><input type="hidden" name="register" value="true"></form>');t.find('[name="login"]').val($("#elseEmail").val()),t.appendTo("body"),t.submit(),e.close()},label:App.translate("Register and send password to email")},{action:function(e){e.close()},label:App.translate("Cancel")}];BootstrapDialog.show({message:e,title:App.translate("Registration"),buttons:t,draggable:!0})})),sessionStorage.getItem("browserConfirm")||navigator.userAgent.match(/(chrome|safari|firefox|yandex(?=\/))\/?\s*(\d+)/i)&&!navigator.userAgent.match(/BlackBerry|iPod|Opera Mini|IEMobile/i))$("#auth_form").show();else{let e=$("#auth_form");$("body").html('<div style="width: 600px; margin: auto; padding-top: 50px; font-size: 16px; text-align: center;" id="comeinBlock"><img src="/imgs/start.png" alt=""><div style="padding-bottom: 10px;">'+App.translate("Service is optimized for browsers Chrome, Safari, Yandex, FireFox latest versions")+'.</div><div><a href="#" id="comein" class="btn-default btn">'+App.translate("I still want to see it")+"</a></div></div>"),$("#comein").on("click",(function(){sessionStorage.setItem("browserConfirm",!0),$("#comeinBlock").remove(),$("body").html(e),e.show()}))}},$.fn.datetimepicker.defaults.icons.close="glyphicon glyphicon-ok",setTimeout(()=>{$.fn.datetimepicker.defaults.tooltips.close=App.translate("Apply and close")}),function(){window.Hlps||(window.Hlps={});var e=window.Hlps;e.selectpicker={},e.selectpicker.open=function(e){var t=$(e).data("selectpicker").$newElement.children()[0];(t=$(t)).attr("aria-expanded")&&"false"!==t.attr("aria-expanded")||t.click()},e.selectpicker.focus=function(e){var t=function(){var a=e.data("this");if(a&&e.is(".selectpicker")){var n=a.$newElement.children()[0];(n=$(n)).focus()}else{var i=0;setTimeout((function(){if(!(++i<4))return!1;t()}),1+100*i)}};t()},e.selectpicker.getButton=function(e){var t=$(e).data("selectpicker").$newElement.children()[0];return t=$(t)}}(),function(){$((function(){let e=localStorage.getItem("topNavScroll"),t=$(".totbar-default.navbar-default");e>0&&t.scrollLeft(e),t.on("scroll",()=>{localStorage.setItem("topNavScroll",t.scrollLeft())})}));const e=function(e){if(e){let t=e.chdata.rows[Object.keys(e.chdata.rows)[0]];const a=function(e,t){App.getPcTableById("tree").then((function(a){a.model.checkEditRow({id:e}).then((function(e){window.location.href="/Table/"+e.row.top.v+"/"+t}))}))};"calcs"===t.type.v?App.getPcTableById(1).then((function(e){e.model.checkEditRow({id:t.tree_node_id.v}).then((function(e){a(e.row.tree_node_id.v,t.tree_node_id.v)}))})):a(t.tree_node_id.v,t.id)}};addTree=function(t,a,n){let i=$("div.page_content");if(!App.isTopWindow())return i.addClass("tree-minifyed iframed"),!1;window.TREE_DATA=a;let l=screen.width<=window.MOBILE_MAX_WIDTH;l?n=!1:($(window).on("resize",(function(){window.innerWidth<=660&&!i.is(".tree-minifyed")&&u(!0)})),localStorage.getItem("notCreator")&&(n=!1)),$.jstree.defaults.core.dblclick_toggle=!1,$.jstree.defaults.core.expand_selected_onload=!0,$.jstree.defaults.core.force_text=!0;let s,o=localStorage.getItem("tree")||"{}";o=JSON.parse(o),$.each(a,(function(e,i){if(a[e].data={type:i.type},i.id.match(/^table/)&&i.icon&&(a[e].icon="fa fa-"+i.icon),i.state&&i.state.selected&&(a[e].li_attr={class:"jstree-selected"}),o[i.id]&&(a[e].state||(a[e].state={}),a[e].state.opened=!0),i.href?a[e].a_attr={href:(i.href.toString().match(/\/Table\//)?"":t)+i.href}:i.link&&(a[e].a_attr={href:i.link}),n)switch(-1!==["link","anchor","folder"].indexOf(i.type)&&(i.a_attr=i.a_attr||{},i.a_attr={...i.a_attr,class:"edit-folder","data-id":i.id.substr(4)}),i.type){case"folder":a.push({type:"plus",id:"plus-table"+i.id.substring(4),text:App.translate("treeAddTable"),parent:i.id,li_attr:{class:"jstree-creatorView"}}),a.push({type:"plus",id:"plus-folder"+i.id.substring(4),text:App.translate("treeAddFolder"),parent:i.id,li_attr:{class:"jstree-creatorView"}});break;case"cycle_name":a.push({type:"plus",id:"plus-calcs"+i.parent.substring(4),text:App.translate("treeAddTable"),parent:i.id,li_attr:{class:"jstree-creatorView"}});break;case"table_cycles":i.a_attr={...i.a_attr,class:"add_calcs_table","data-id":i.id.substr(5)}}})),n&&(s=t.match(/^.*?(\d+)/))&&(a.push({type:"plus",id:"plus-table"+s[1],text:App.translate("treeAddTable"),parent:"#",li_attr:{class:"jstree-creatorView"}}),a.push({type:"plus",id:"plus-folder"+s[1],text:App.translate("treeAddFolder"),parent:"#",li_attr:{class:"jstree-creatorView"}}));let r=$("#leftTree");if(n?r.on("init.jstree",(function(t,a){let n=$.jstree.core.prototype.redraw_node;r.jstree(!0).redraw_node=function(t,a,i,l){let s=n.bind(this)(t,a,i,l);if(t.match(/^tree/)){"folder"==r.jstree(!0).get_node(t).data.type&&$(s).addClass("tree-folder")}let o=$(s).find(">a.edit-folder");if(o.length){let t=$('<i class="fa fa-edit edit-folder-icon"></i>');t.on("click",()=>(new EditPanel("tree",BootstrapDialog.TYPE_DANGER,{id:o.data("id")}).then(e),!1)),o.find(">i").after(t)}else{let t=$(s).find(">a.add_calcs_table");if(t.length){let a=$('<i class="fa fa-plus edit-folder-icon"></i>');a.on("click",()=>(new EditPanel(1,BootstrapDialog.TYPE_DANGER,{type:{v:"calcs"},tree_node_id:{v:t.data("id")}},{},{type:!0,tree_node_id:!0}).then(e),!1)),t.find(">i").after(a)}}return s}})):r.on("init.jstree",(function(e,t){let a=$.jstree.core.prototype.redraw_node;r.jstree(!0).redraw_node=function(e,t,n,i){let l=a.bind(this)(e,t,n,i);if(e.match(/^tree/)){"folder"==r.jstree(!0).get_node(e).data.type&&$(l).addClass("tree-folder")}return l}})),!l){let e,t=$('<input placeholder="'+App.translate("Tree search")+'" class="form-control">'),a=$('<div id="serverSearch"></div>');r.before(t),r.after(a),t.wrap('<div id="searchArea">');const n=(t,a)=>(e||(e=App.models.table("/Table/"),e.addPcTable({model:e})),new Promise(n=>{e.seachUserTables(t,a).then(e=>{let t=$("<div>");e.trees.forEach(e=>{let a=$("<div>").append($("<a>").attr("href",e.href||"/Table/"+e.id).text(e.title));e.icon&&a.prepend('<i class="icon fa fa-'+e.icon+'"></i>'),t.append(a)}),e.tables.forEach(e=>{let a=$("<div>").append($("<a>").attr("href","/Table/"+e.top+"/"+e.id).text(e.title));if(e.icon)a.prepend('<i class="icon fa fa-'+e.icon+'"></i>');else{let t={globcalcs:"calculator",calcs:"calculator",tmp:"clock-o",simple:"table",cycles:"circle-o"}[e.type];a.prepend('<i class="icon fa fa-'+t+'"></i>')}t.append(a)}),n(t.children())})}));let i;t.on("keyup",()=>{i&&clearTimeout(i),i=setTimeout(async()=>{let e=t.val().trim();r.jstree(!0).show_all(),r.jstree("search",e),""!=e?a.html(await n(e,window.top_branch||(window.location.pathname.match(/\/Table\/(\d+)/)||{1:0})[1])):a.html(""),f()},50)}),r.on("search.jstree",(function(e,t,a){0===t.nodes.length&&r.jstree(!0).hide_all()}))}let d=$("#LeftTree"),c=()=>"tree_scroll_part_"+(window.top_branch||(window.location.pathname.match(/\/Table\/(\d+)/)||{1:0})[1]);const p=function(){r.jstree({state:{key:"leftTree"},core:{check_callback:!0,expand_selected_onload:!0,open_parents:!0,data:a,themes:{name:"default"}},types:{folder:{},plus:{icon:"fa fa-plus"},cycle_name:{icon:"fa fa-dot-circle-o"},text:{icon:"jstree-file"},table:{icon:"jstree-file"},table_simple:App.tableTypes.simple,table_version:App.tableTypes.version,table_calcs:App.tableTypes.calcs,table_tmp:App.tableTypes.tmp,table_globcalcs:App.tableTypes.globcalcs,table_cycles:App.tableTypes.cycles,table_data:{icon:"jstree-file"}},plugins:["types","themes","search"],search:{case_sensitive:!1,show_only_matches:!0,search_callback:function(e,t){if("folder"===t.original.type)return!1;var a,n=[],i=e.toLowerCase().replace(/^\s+/g,"").replace(/\s+$/g,"");n=i.indexOf(" ")>=0?i.split(" "):[i];const l=e=>{for(var t=0;t<n.length;t++)if(a=n[t],-1===e.toLowerCase().indexOf(a))return!1;return!0};return l(t.text||"")||l(t.original.name||"")}}}),f()};r.on("loaded.jstree after_open.jstree",(function(e){let t=r.width();if(r.find("a.jstree-anchor").each((function(){let e=$(this),a=e.offset().left;e.width(t-a)})),"loaded"===e.type){let e=localStorage.getItem(c());e&&d.scrollTop(e),f()}})),r.on("select_node.jstree",(function(a,n){switch(localStorage.setItem(c(),d.scrollTop()),(n.node.data?n.node.data.type:null)||n.node.type){case"plus":let a=n.node.id.substring(5,10);if("calcs"===a){let e=n.node.id.substring(11);n.node.parent.substring(5);new EditPanel(1,BootstrapDialog.TYPE_DANGER,{tree_node_id:{v:e},type:{v:"calcs"}}).then((function(e){e&&window.location.reload(!0)}))}else if("table"===a){let t=n.node.id.length>10?n.node.id.substring(10):window.location.pathname.match(/^\/.*\/(\d+)\//)[1];new EditPanel(1,BootstrapDialog.TYPE_DANGER,{tree_node_id:{v:t}}).then(e)}else{let e=n.node.id.length>11?n.node.id.substring(11):window.location.pathname.match(/^\/.*\/(\d+)\//)[1];new EditPanel("tree",BootstrapDialog.TYPE_DANGER,{parent_id:{v:e}}).then((function(e){e&&window.location.reload(!0)}))}return!1;case"link":window.location.href=n.node.a_attr.href;break;case"folder":case"project":return n.node.state.opened?($("#leftTree").jstree("close_node",n.node),o[n.node.id]&&(delete o[n.node.id],localStorage.setItem("tree",JSON.stringify(o)))):($("#leftTree").jstree("open_node",n.node),o[n.node.id]=!0,localStorage.setItem("tree",JSON.stringify(o))),!1;default:window.location.pathname.match(/^\/Table\//)?window.location.href=n.node.original.link?n.node.original.link:"/"!==n.node.original.href[0]?t+n.node.original.href:n.node.original.href:window.location.href=n.node.original.href}return!1}));const f=function(){setTimeout((function(){d.getNiceScroll().resize()}),250)};r.on("open_node.jstree",(function(e,t){o[t.node.id]=!0,localStorage.setItem("tree",JSON.stringify(o)),f()})),r.on("close_node.jstree",(function(e,t){o[t.node.id]&&(delete o[t.node.id],localStorage.setItem("tree",JSON.stringify(o))),f()}));let h=localStorage.getItem("TreeMinimizer")||"false";h=JSON.parse(h);let u=function(e){h=e;const t=$("#page-tree");let a=$("#page-tree").length&&!($("#main-page").length||$("#tables_tabls").length);e?($("body>.page_content").addClass("tree-minifyed"),$("#LeftTree").getNiceScroll().resize(),a&&(t.append($("#branch-title, #searchArea, #serverSearch")),t.append(r),r.trigger("after_open"))):($("body>.page_content").removeClass("tree-minifyed"),a&&($(".TreeContainer").append($("#branch-title, #searchArea, #serverSearch")),$(".TreeContainer").append(r),r.trigger("after_open"))),$("#table").data("pctable")&&$("#table").data("pctable").setWidthes(),p(),localStorage.setItem("TreeMinimizer",JSON.stringify(h)),f()};l||d.niceScroll({cursorwidth:7,mousescrollstep:190,mousescroll:190,autohidemode:!1,enablekeyboard:!1,cursoropacitymin:1,railoffset:{left:4},cursorcolor:"#e1e0df"}),$("#TreeMaximizer").on("click",(function(){if(l||window.innerWidth<=660){let e=$("<div>");e.append($("#branch-title")),e.append($("#leftTree")),App.mobilePanel('<a class="totum-brand" href="/"><span>'+$(".totum-brand span:first").text()+"</span></a>",e,{onhide:function(){const e=$("#page-tree");1===e.length?(r.appendTo(e),p()):(r.appendTo(".TreeContainer"),p())},cssClass:"mobile-panel mobile-menu"}),r.trigger("after_open")}else u(!1)})),$("#TreeMinimizer").on("click",(function(){u(!0)})),!0===h?setTimeout((function(){u(h)}),1):l?setTimeout((function(){1===$("#page-tree").length&&r.appendTo($("#page-tree")),p()}),10):p()}}(),restModel=function(e){return{url:e,create:function(){return $.ajax({url:this.url,method:"post",data:data})},get:function(e){return $.ajax({url:this.url,method:"get",data:{id:e}})},save:function(e,t){return $.ajax({url:this.url,method:"PUT",data:$.extend(t,{id:e})})}}},$((function(){if(App.notifications=function(e){let t=App.models.table("/Table/");t.addPcTable({model:t}),e.data("withClick")||(e.data("withClick",!0),e.on("click",(function(e){t.getNotificationsTable()})));let a={},n={},i=e.data("periodicity")||0;const l=function(){switch(document.visibilityState){case"hidden":a.jqXHR&&a.jqXHR.abort&&a.jqXHR.abort(),a.aborted=!0;break;case"visible":delete a.aborted,t.checkForNotifications(i,Object.keys(n),a).then((function(e){e.notifications&&e.notifications.length&&(n[e.notification_id]=App.showDatas.call(t,e.notifications,e.notification_id),n[e.notification_id].forEach((function(t){t&&t.$modal&&t.$modal.length&&t.$modal.on("hide.bs.modal",(function(){delete n[e.notification_id]}))}))),e.deactivated&&e.deactivated.forEach&&e.deactivated.forEach((function(e){n[e]&&(n[e].forEach((function(e){e.simpleClose()})),delete n[e])})),App.checkNotificationManager(n),i>0&&l()})).fail((function(e){e&&e.error&&document.removeEventListener("visibilitychange",l)}))}};return i>0&&(document.addEventListener("visibilitychange",l),l()),l},App.isTopWindow()){let e=$("#bell-notifications");e.length&&App.notifications(e)}})),$((function(){let e=$("#docs-link");const t=function(){let a=$(this).data("type"),n=$('<div class="tech-table" id="DocsPopover" data-type="'+a+'" style="min-height: 250px"></div>');$.post("https://docs.totum.online/index_"+a+".json",(function(e){e&&e.length&&e.forEach((function(e){n.append('<div style="'+(e[2]||"")+'"><i class="fa fa-external-link"></i> <a href="http://docs.totum.online'+e[1]+'" target="totum-docs">'+e[0]+"</a></div>")}))})),e.popover({html:!0,content:n,trigger:"manual",container:"body",placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),setTimeout((function(){e.popover("show"),$("#"+e.attr("aria-describedby")).css("top","45px"),$("body").one("click.DocsPopover",(function(a){void 0!==a.altKey&&(e.popover("destroy"),e.one("click",t))}))}),50)};e.one("click",t)})),function(e,t){const a=e.MOBILE_MAX_WIDTH=1199,n={type:{isOn:!0,Val:"string"},width:{isOn:!0,Val:100},default:{isOn:!1,Val:""},regexp:{isOn:!1,Val:""},regexpErrorText:{isOn:!1,Val:""},required:{isOn:!0,Val:!1},showInWeb:{isOn:!0,Val:!0},insertable:{isOn:!0,Val:!0},dropdownView:{isOn:!0,Val:!0},addRoles:{isOn:!1,Val:["1"]},editable:{isOn:!0,Val:!0},editRoles:{isOn:!1,Val:["1"]},hidden:{isOn:!0,Val:!1},warningEditPanel:{isOn:!0,Val:!1},warningEditText:{isOn:!1,Val:App.translate("Surely to change?")},warningEditRegExp:{isOn:!1,Val:"/^someValue$/"},url:{isOn:!0,Val:!1},openIn:{isOn:!1,Val:"iframe"},tableBreakBefore:{isOn:!0,Val:!1},sectionTitle:{isOn:!1,Val:""},panelColor:{isOn:!1,Val:""},webRoles:{isOn:!1,Val:["1"]},logRoles:{isOn:!1,Val:["1"]},showInWebOtherPlace:{isOn:!0,Val:!1},showInWebOtherPlacement:{isOn:!1,Val:"param"},showInWebOtherOrd:{isOn:!1,Val:null},showInXml:{isOn:!0,Val:!1},apiEditable:{isOn:!1,Val:!1},xmlEditRoles:{isOn:!1,Val:["1"]},xmlRoles:{isOn:!1,Val:["1"]},logging:{isOn:!0,Val:!0},code:{isOn:!1,Val:"= : "},codeOnlyInAdd:{isOn:!1,Val:!1},errorText:{isOn:!1,Val:""},codeAction:{isOn:!1,Val:"= :"},CodeActionOnAdd:{isOn:!1,Val:!1},CodeActionOnChange:{isOn:!1,Val:!1},format:{isOn:!1,Val:"f1=:"},help:{isOn:!1,Val:""}},i="#ee0c1f",l="#3fbf46",s="pcTableInsertRowPanel";var o=0;CodeMirror.defineMode("sections",(function(){return{startState:function(){return{}},token:function(e,t){if(0===e.lineOracle.line)return e.skipToEnd(),t.isStart=!1,"sec-title";if(0===e.pos)return e.skipTo(":"),e.next(),t.isParamsPart=!0,"sec-param";{let a=e.string.substring(e.pos);if(t.isParamsPart&&a.match(":")){let n="sec-parts",i=":";return-1!==a.indexOf(",")?i=",":t.isParamsPart=!1,/^\s*\d+\s*$/.test(a.substring(0,a.indexOf(i)))&&(n="sec-num-parts"),e.skipTo(i),e.next(),n}return/^\s*(true|false)\s*$/.test(a)?(e.skipToEnd(),"boolean"):(e.skipToEnd(),"sec-value")}}}})),CodeMirror.sectionsAutoCloses=function(t){t.on("keyup",(function(t,a){t.options.bigOneDialog&&e.top.wasCtrl(a)&&"83"===(a.keyCode||a.which).toString()?(a.stopPropagation(),"function"==typeof t.options.bigOneDialog?t.options.bigOneDialog():t.options.bigOneDialog.close()):e.top.wasCtrl(a)&&"191"===(a.keyCode||a.which).toString()&&CodeMirror.commentMe(t),"27"===(a.keyCode||a.which).toString()?(t.state.completionActive&&t.state.completionActive.close(),a.stopPropagation()):{9:"tab",13:"enter",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",38:"up",40:"down",57:"("}[(a.keyCode||a.which).toString()]||CodeMirror.showHint(t,CodeMirror.hint.totumVars,{})}))},function(){let a=App.functions||[],n=[];a.forEach((function(e){e.d||n.push(e.name)}));let i={};a.forEach((function(e){i[e.name.toLowerCase()]=[e.t,0,e.p,e.n,e.m,e.name]}));let l=["where","order","field","sfield","bfield","tfield","preview","parent","section","table","filter","fieldtitle","fieldhide"];CodeMirror.defaults.scrollbarStyle="overlay",CodeMirror.defineInitHook((function(a){try{if(!a.options.bigOneDialog&&screen.width>e.MOBILE_MAX_WIDTH){let n,i=t('<i class="fa fa-expand codemirror-expander" style="position: absolute;\n    right: 10px;\n    bottom: 10px;\n    z-index: 10000;\n    font-family: FontAwesome; cursor: pointer"></i>');t(a.display.wrapper).append(i),i.on("click",(function(){n=t('<div class="HTMLEditor" id="bigOneCodemirror" style="height: 100%;"></div>');let i,l=a.getValue();e.top.BootstrapDialog.show({message:n,type:null,title:App.translate("Text field editing"),cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){a.setValue(i.getValue()),t("body").off("ctrlS.CodemirrorMax")},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"}),e.$modalHeader.find("button.close").css("font-size","16px").html('<i class="fa fa-compress"></i>'),t("body").on("ctrlS.CodemirrorMax",()=>{e.close()})},onshown:function(t){i=CodeMirror(n.get(0),{mode:a.options.mode,value:l,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:t}),a.table&&(i.table=a.table);let s=Math.round(t.$modalContent.height()-t.$modalHeader.outerHeight()-40);i.getScrollerElement().style.minHeight=s+"px",n.find(".CodeMirror").css("min-heught",s),i.focus(),t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top})}})}))}}catch(e){a.setValue(e.message)}}));CodeMirror.defineInitHook((function(e){try{t(e.display.wrapper).on("contextmenu",".cm-function",(function(){let e=t(this).text();return e=e.substring(0,e.length-1),async function(e,a){let n=e.toLowerCase(),s=t('<div style="width:200px" class="function-help">');t('<div class="func-template">').text(e+i[n][0]).appendTo(s).on("click",()=>!1);let o=t('<div class="func-params">').appendTo(s).on("click",()=>!1);i[n][2].forEach(e=>{let a=t("<span>").text(e);-1!==i[n][3].indexOf(e)&&a.addClass("req"),-1!==i[n][4].indexOf(e)&&a.addClass("multi"),-1!==l.indexOf(e)&&a.addClass("db"),o.append(a),o.append(" ")});let r=t("<a>").attr("href","https://docs.totum.online/functions#fn-"+i[n][5]).attr("target","_blank").html('<button class="btn btn-default btn-sm">'+App.translate("Documentaion")+"</button>");s.append(r.wrap('<div class="button">').parent()),App.popNotify({isParams:!0,$text:s,element:a,trigger:"manual",container:t("body")}),setTimeout(()=>{t("#table").data("pctable").closeCallbacks.push((function(){a&&a.length&&a.popover("destroy")}))},200),t("body").click()}(e,t(this)),!1}))}catch(e){console.log(e.message)}}));function s(e){if(e.getOption("disableInput")||"totum"!==e.getOption("mode"))return CodeMirror.Pass;var t=e.listSelections(),a=[];let n=!1;for(let r=0;r<t.length;r++){if(!t[r].empty())return CodeMirror.Pass;var l=t[r].head,s=e.getTokenAt(l,!0);if(s.state&&s.state.inFuncName||"function"==s.type||"error"==s.type){let d,c,p=s.string.toLowerCase(),f="";if(-1!==p.indexOf("/")?(d=p.substring(0,p.indexOf("/")),f=p.substring(p.indexOf("/")),c="/"):-1!==p.indexOf(";")?(d=p.substring(0,p.indexOf(";")),f=p.substring(p.indexOf(";")),c=";"):d=p.trimRight(),d=i[d]){let e="",t=0;if(f.length){e="(";let a=1,i=!0;f.split(/[\/;]/).forEach((function(t){if(0===t.length);else{i||(e+="; "),i=!1;let n=-1!==t.indexOf(":")&&""!==t.slice(t.indexOf(":")+1).trim();e+=t+(-1===t.indexOf(":")?": ":""),1!==a||n||(a=e.length)}})),1===a?a=e.length:n=!0,t+=a,e+=")"}else if(e=d[0],/:/.test(e)){let a=e.indexOf(":"),i=e.substring(a),l=i.substring(0,i.indexOf(";")||i.indexOf(")"));t+=a,-1!==l.indexOf("'")?t+=l.indexOf("'")+1:t+=2,n=!0}else t+=e.length;a[r]={text:e,newPos:CodeMirror.Pos(l.line,l.ch-f.length+t),replace:CodeMirror.Pos(l.line,l.ch-f.length)}}else a[r]={text:"()",newPos:CodeMirror.Pos(l.line,l.ch+1),replace:CodeMirror.Pos(l.line,l.ch)};let h=a[r];if(h){e.replaceRange(h.text,h.replace,t[r].anchor,"+insert");var o=e.listSelections().slice(0);o[r]={head:h.newPos,anchor:h.newPos},e.setSelections(o),n&&CodeMirror.showHint(e,CodeMirror.hint.totumVars,{})}}else e.replaceRange("()",CodeMirror.Pos(l.line,l.ch),t[r].anchor),e.setSelections([{head:CodeMirror.Pos(l.line,l.ch+1),anchor:CodeMirror.Pos(l.line,l.ch+1)}])}}CodeMirror.defineMode("totum",(function(){return{startState:function(){return{inString:!1,isStart:!0,inFunction:!1,lineName:"",inTotumBlock:!1}},token:function(e,a){function n(){return e.string.substring(e.start,e.pos)}function s(){"use strict";return a.inFunction=!1,e.skipToEnd(),"error"}function o(){let t=!1;for(;"["===e.peek()&&e.next();){if("["===e.peek()&&(t=!0,e.next()),'"'===e.peek()||"'"===e.peek()){let t=e.peek();for(e.next();e.peek()!==t&&e.next(););e.next()}else for(;/[a-z0-9_A-Z$#@.]/.test(e.peek())&&e.next(););if("]"!==e.peek())return!1;e.next()}if(t){if("]"!==e.peek())return!1;e.next()}return!0}a.lineNames=[];let r=[];if(0===e.lineStart&&0===e.start)try{e.lineOracle.doc.cm.lineNames=[];let t=null,a=null,n=null,i=[],l=[];e.lineOracle.doc.cm.codeBlocks=r,e.lineOracle.doc.cm.getValue().split("\n").forEach((function(s,o){let d;return t?("```"===s.trim()?(e.lineOracle.doc.cm.lineNames.push(t),r.push([n,o,a,t,i]),t=null,a=null,n=null,i=[]):(d=s.match(/^\s*~?\s*([a-zA-Z_0-9]+)\s*(=\s*[a-zA-Z0-9_]*)?:/))&&i.push(d[1]),void l.push(o)):(d=s.match(/^\s*```~?([a-zA-Z_0-9]+):([a-z]+)/))?(t=d[1],a=d[2],n=o,void l.push(o)):0===s.trim().length||0===s.indexOf("//")?"":(d=s.match(/^\s*~?\s*([a-zA-Z_0-9]+)\s*(=\s*[a-zA-Z0-9_]*)?:/))?e.lineOracle.doc.cm.lineNames.push(d[1]):""})),r.length&&(e.lineOracle.doc.cm.lineColorizeTimer&&clearTimeout(e.lineOracle.doc.cm.lineColorizeTimer),e.lineOracle.doc.cm.lineColorizeTimer=setTimeout(()=>{e.lineOracle.doc.eachLine(t=>{let a=e.lineOracle.doc.getLineNumber(t);"code-block"!==t.bgClass?-1!==l.indexOf(a)&&(e.lineOracle.doc.cm.addLineClass(t,"background","code-block"),e.lineOracle.doc.cm.addLineClass(t,"text","code-block-text")):-1===l.indexOf(a)&&(e.lineOracle.doc.cm.removeLineClass(t,"background","code-block"),e.lineOracle.doc.cm.removeLineClass(t,"text","code-block-text"))})},10))}catch(e){console.log(e)}else r=e.lineOracle.doc.cm.codeBlocks,a.lineNames=e.lineOracle.doc.cm.lineNames;a.inTotumBlock=!1;for(var d=0;d<r.length;d++){let t=r[d];if(t[0]===e.lineOracle.line&&0===e.start)return e.skipTo(":"),a.lineName=t[3],"start spec-code";if(t[0]<=e.lineOracle.line&&e.lineOracle.line<=t[1]){if(t[0]==e.lineOracle.line||e.lineOracle.line==t[1]||"totum"!==t[2])return e.skipToEnd(),"spec-code";a.inTotumBlock=!0,a.codeBlock=t}}if(0===e.pos||!0===a.isStart){if(e.string.match("^[\ts]*//"))return e.skipToEnd(),a.isStart=!1,"comment";let i="start";if(a.isStart=!0,/[\t\n]/.test(e.peek())&&e.next()){for(;/[\t\n]/.test(e.peek())&&e.next(););return"start-tabs"}if(!e.skipTo(":"))return s();if(a.lineName=n().trim(),"~"===a.lineName.substring(0,1)&&(i+=" fixed",a.lineName=a.lineName.substring(1)),a.lineName=a.lineName.replace(/=\s*[a-z0-9_]*\s*$/,"="),/^\s*=\s*$|^\s*[a-z]{1,2}\d+=$/i.test(a.lineName))i+=" exec";else if(!/^[a-z0-9_]+$/i.test(a.lineName))return s();return e.next(),t(e.lineOracle.doc.cm.getWrapperElement()).find(".cm-var-not-in").each((function(){let e=t(this).text();e=e.replace(/\[.*/,""),e!=="$"+a.lineName&&e!=="#$"+a.lineName&&e!=="$$"+a.lineName||t(this).removeClass("cm-var-not-in")})),a.lineNames.filter((function(e){return e===a.lineName})).length>1&&(i+=" dubbled"),a.inTotumBlock&&(i+=" totum-block"),a.isStart=!1,i}if(a.isStart=!1,e.match(/(math|json|str|cond)`[^`]*`/))return"spec";switch(e.peek()){case" ":return e.next(),null;case"{":return e.next(),e.skipTo("}")?(e.next(),"inVars"):s();case'"':let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string"):s();case"#":e.next();let n,i="db_name";if("$"===e.peek())return i;for(e.next();(n=e.string.substring(e.start+1,e.pos+1))&&/^[a-z0.-9_--]*$/.test(n)&&e.next(););if(!o())return s();let l=e.string.substring(e.start+1,e.pos).replace(/^([shcl]\.)?([a-z0-9_]+)$/,"$2");return"n"===l||/^[0-9a-z_]{2,}/.test(l.replace(/\[.*/g,""))||(i+=" tmp-error"),""===l?s():i;case"@":if(e.next(),"$"===e.peek()){for(e.next();/[a-zA-Z0-9_]/.test(e.peek())&&e.next(););return o()?"global-var":s()}{let t;for(;/[a-z0-9_.]/.test(t=e.peek())&&e.next(););if(!o())return s();let a=e.string.substring(e.start+1,e.pos);if(/^[a-z0-9_]{3,}\.[a-z0-9_]{2,}(\[\[?([a-zA-Z0-9_\$\#]+|"[^"]+"|'[^']+')\]?\])*$/i.test(a))return"db_name"}return s();case"$":if(e.next(),"@"===e.peek()){for(e.next();/[a-zA-Z0-9_]/.test(e.peek())&&e.next(););return o()?"process-var":s()}if("$"===e.peek()&&e.next(),"#"===e.peek()){for(e.next();/[a-zA-Z0-9_]/.test(e.peek())&&e.next(););return o()?"code-var":s()}{for(;/[a-zA-Z0-9_"]/i.test(e.peek())&&e.next(););if(!o())return s();let t=e.string.substring(e.start,e.pos);t=t.replace(/\[.*/g,"");let n="variable",i=t.substring(1);return"$"===i[0]&&(n+=" dollar-dollar",i=i.substring(1)),a.inTotumBlock||-1!==a.lineNames.indexOf(i)||(n+=" var-not-in"),n}case"t":if("true"===e.string.substring(e.start,e.start+4))return e.skipTo("e"),e.next(),"boolean";break;case"f":if("false"===e.string.substring(e.start,e.start+5))return e.skipTo("e"),e.next(),"boolean"}if(a.inFuncName=!1,!a.inFunction&&/[a-zA-Z]/.test(e.peek())){if(a.inFuncName=!0,e.skipTo("(")?a.inFunction=!0:e.skipToEnd(),!/^[a-zA-Z]+[0-9]*\s*$/.test(n()))return s();let t=i[n().trim().toLowerCase()];return t?(a.func=t,e.next(),"function"):s()}if(a.inFunction){if(")"===e.peek())return e.next(),a.inFunction=!1,a.functionParam="",delete a.func,"function";if(!a.functionParam&&/[a-z_]/.test(e.peek())){if(e.skipTo(":")){let t=e.string.substring(e.start,e.pos);if(/^[a-z_]+\s*$/.test(t)){if(a.functionParam=t,e.next(),-1===a.func[2].indexOf(t))return s();let n="functionParam";return-1!==l.indexOf(t)&&(n+=" fieldParam"),-1!==a.func[3].indexOf(t)&&(n+=" reqParam"),a.func[4]&&-1!==a.func[4].indexOf(t)&&(n+=" multiParam"),n}return s()}return e.skipTo(")")?"error fieldParam":s()}if(!a.functionParam)return s();if(";"===e.peek())return e.next(),a.functionParam="","";if("order"===a.functionParam&&/[ad]/.test(e.peek())){if("asc"===e.string.substring(e.start,e.start+3))return e.next(),e.next(),e.next(),"";if("desc"===e.string.substring(e.start,e.start+4))return e.next(),e.next(),e.next(),e.next(),""}if("'"===e.peek()){let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string-name"):s()}}if("'"===e.peek()){let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string"):s()}if(/\d|%/.test(e.peek())){for(e.next();/[0-9.%]/.test(e.peek())&&e.next(););return/^\d+(\.\d+)?%?$/.test(e.string.substring(e.start,e.pos))?"number":s()}return/[\^+-\/*!<>=]/.test(e.peek())?(e.next(),"operator"):s()}}})),CodeMirror.registerHelper("hint","totumVars",(function(e,a){return function(e,a,s,r){var d,f=e.getCursor(),u=s(e,f),m=e.getLine(f.line);if("string-name"!==u.type&&/\b(?:string|comment)\b/.test(u.type))return;var b=CodeMirror.innerMode(e.getMode(),u.state);if("json"===b.mode.helperType)return;u.state=b.state,u.inString=u.string,u.state.isDb_name=!1,u.state.showAll=!0,r.inStart=!0;let g,w=function(e,t,a){null!=a&&(e.replaceRange(a.text||a,t.from,t.to),a.curPos&&e.setCursor({line:t.from.line,ch:a.curPos}),a.showHint&&CodeMirror.showHint(e,CodeMirror.hint.totumVars,{}))},v={text:"math``",textVis:"math``",title:"",render:p,type:"",curPos:u.start+5,hint:w,tab:!0},_={text:"json``",textVis:"json``",title:"",render:p,type:"",curPos:u.start+5,hint:w,tab:!0},y={text:"cond``",textVis:"cond``",title:"",render:p,type:"",curPos:u.start+5,hint:w,tab:!0},x={text:"str``",textVis:"str``",title:"",render:p,type:"",curPos:u.start+4,hint:w,tab:!0};if(a=a.slice(),u.state.isStart||0===f.ch){if(!u.state.inTotumBlock){a=[],u.string=u.string.replace(/^[\t]+/,"");let n="";/^~/.test(u.string)&&(u.string.replace(/^~/,""),n="~"),t(e.getWrapperElement()).find(".cm-var-not-in:not(.cm-totum-block)").each((function(){let e=t(this).text().replace(/^(\#|\$)?\$/,"").replace(/\[.*/,"");a.push({text:n+e+": ",displayText:e})}))}}else if("error"===u.type&&u.state.func&&u.state.func[2].length&&-1!==[";","/"].indexOf(m[u.start])){a=[],d=u.string.substr(0,f.ch-u.start).replace(/^[;\/]+([a-z_]*).*/,"$1");let e=u.string.substr(f.ch-u.start).replace(/^[;\/]+[a-z_]*(.*)/,"$1");u.state.func[2].forEach((function(t){let n="",i="";-1!==[";",")"].indexOf(e.trim()[0])?i=e:e.match(/[)]/)&&(i=";"+e),-1!==u.state.func[3].indexOf(t)&&(n+=" item-reqParam"),-1!==u.state.func[4].indexOf(t)&&(n+=" item-multiParam"),-1!==l.indexOf(t)&&(n+=" item-fieldParam");let s="";-1===["("," "].indexOf(m[u.start-1])&&(s=" "),a.push({text:s+t+": "+i,textVis:t,title:"",render:p,type:n,hint:w,curPos:u.start+s.length+(t+": "+i).length-i.length})}))}else if(/^'.*?'?$/.test(u.string)&&-1!==l.indexOf(u.state.functionParam))if(u.state.showAll=!0,"''"===u.string?(u.end=u.end,u.start+=1,u.string=""):/'[a-z_0-9]+'/.test(u.string)?(u.start+=1,u.string=u.string.slice(1,f.ch-u.start)):(u.string=u.string.slice(1,f.ch-u.start),u.start+=1,u.end=f.ch,"'"===e.getLine(f.line)[f.ch]&&u.end++),"table"===u.state.functionParam){let e=c();a=[],Object.keys(e).forEach((function(t){a.push({text:t+"'",textVis:t,title:e[t].t,render:p,type:"item-string-name",hint:w,tab:!0})}))}else{let t,n=e.getLine(f.line),i=n.substring(0,f.ch),l=n.substring(f.ch),s=l.substring(0,l.indexOf(")"));if(i=i.substring(i.lastIndexOf("("))+s,t=i.match(/table:\s*((\$#ntn)|'([a-z_0-9]*)')/)){let n=t[2]?e.table:t[3];a=[],Object.keys(o[n].f).forEach((function(e){a.push({text:e+"'",textVis:e,title:o[n].f[e],render:p,type:"item-string-name",curPos:f.ch+e.length+1,tab:!0})})),a.push({text:"id'",textVis:"id",title:"",render:p,type:"item-string-name",curPos:f.ch+3,tab:!0})}}else if(u.end>f.ch&&(u.end=f.ch,u.string=u.string.slice(0,f.ch-u.start)),0===u.string.indexOf("@")){r.inStart=!1,a=[];let e,t=c();if(u.string=u.string.slice(1,f.ch-u.start),u.start=u.start+1,u.end=f.ch,e=u.string.match(/^([a-z_0-9]+)\./)){let n=e[1];u.start+=(n+".").length,u.string=u.string.slice((n+".").length),t[n]&&t[n]["@"].length&&t[n]["@"].forEach((function(e){a.push({text:e,title:t[n].f[e],render:p,type:"item-db_name"})}))}else Object.keys(t).forEach((function(e){t[e]["@"].length&&a.push({text:e+".",textVis:e,title:t[e].t,render:p,type:"item-db_name",showHint:!0,hint:w})}))}else if("$#"===u.string.slice(0,2)){a=[{text:"$#lc",title:App.translate("empty list"),render:p,type:"item-code-var"},{text:"$#nd",title:App.translate("date")+" - Y-m-d",render:p,type:"item-code-var"},{text:"$#ndt",title:App.translate("date-time")+" - Y-m-d H:i",render:p,type:"item-code-var"},{text:"$#ndts",title:App.translate("date-time with secongs")+" - Y-m-d H:i:s",render:p,type:"item-code-var"},{text:"$#nu",title:App.translate("user id"),render:p,type:"item-code-var"},{text:"$#nr",title:App.translate("user roles ids"),render:p,type:"item-code-var"},{text:"$#nti",title:App.translate("table id"),render:p,type:"item-code-var"},{text:"$#ntn",title:App.translate("table NAME"),render:p,type:"item-code-var"},{text:"$#nth",title:App.translate("temporary table HASH"),render:p,type:"item-code-var"},{text:"$#ih",title:App.translate("adding row HASH"),render:p,type:"item-code-var"},{text:"$#nci",title:App.translate("calcuated table cycle id"),render:p,type:"item-code-var"},{text:"$#nf",title:App.translate("field NAME"),render:p,type:"item-code-var"},{text:"$#nl",title:App.translate("new line"),render:p,type:"item-code-var"},{text:"$#tb",title:App.translate("tab"),render:p,type:"item-code-var"},{text:"$#tpa",title:App.translate("action code action type"),render:p,type:"item-code-var"},{text:"$#ids",title:App.translate("the ids of the checked fields"),render:p,type:"item-code-var"},{text:"$#nfv",title:App.translate("current field value (for selections/actions/formats)"),render:p,type:"item-code-var"},{text:"$#onfv",title:App.translate("past value of the current field"),render:p,type:"item-code-var"},{text:"$#nh",title:App.translate("current host-name"),render:p,type:"item-code-var"},{text:"$#duplicatedId",title:App.translate("duplicated row id"),render:p,type:"item-code-var"}];const e=function(e){let t=a.slice(),n=[];return t=t.filter((function(t){if(-1===e.indexOf(t.text))return!0;n.push(t)})),n.concat(t)};switch(u.state.functionParam){case"table":a=e(["$#ntn"]);break;case"cycle":a=e(["$#nci"]);break;case"field":a=e(["$#nf","$#nfv"])}}else if(g=u.string.match(/^(#?\$)/))a=[],u.string=u.string.slice(g[1].length,f.ch-u.start),u.start=u.start+g[1].length,u.end=f.ch,u.state.inTotumBlock?u.state.codeBlock[4].forEach((function(e){-1===e.indexOf("=")&&a.push(e)})):u.state.lineNames.forEach((function(e){-1===e.indexOf("=")&&a.push(e)}));else if(g=u.string.match(/^\#/)&&!u.state.inTotumBlock)a=[],u.string=u.string.slice(1,f.ch-u.start),u.start=u.start+1,u.end=f.ch,(g=u.string.match(/^([a-z]{1,3}\.)/))&&(u.string=u.string.slice(g[1].length),u.start+=g[1].length),e.table&&o[e.table]&&(Object.keys(o[e.table].f).forEach((function(t){a.push({text:t,title:o[e.table].f[t],render:p,type:"item-db-name"})})),a.push({text:"id",title:"",render:p,type:"item-db-name"}));else if(u.state.inFuncName){if(!u.state.inFunction)if(g=u.string.match(/^([a-zA-Z]+)([\/;])/)){let e;if(u.state.showAll=!0,e=i[g[1].toLowerCase()]){let t=u.start,n=u.string.lastIndexOf(";")>u.string.lastIndexOf("/")?u.string.lastIndexOf(";"):u.string.lastIndexOf("/");u.start=u.start+n+1,u.string=u.string.slice(n+1,f.ch-t),u.end=f.ch,a=[],e[2].forEach((function(t){let n="";-1!==e[3].indexOf(t)&&(n+=" item-reqParam"),-1!==e[4].indexOf(t)&&(n+=" item-multiParam"),-1!==l.indexOf(t)&&(n+=" item-fieldParam"),a.push({text:t+": ",textVis:t,title:"",render:p,type:n})}))}}else(a=n.slice()).push("true"),a.push("false"),a.unshift(v),a.unshift(_),a.unshift(y),a.unshift(x)}else u.state.func&&("error fieldParam"===u.type||/(\(|;\s*)$/.test(e.getLine(f.line).slice(0,u.start)))?(a=[],u.state.func[2].forEach((function(t){let n="",i="";")"!==e.getLine(f.line).slice(f.ch).trim()&&(i="; "),-1!==u.state.func[3].indexOf(t)&&(n+=" item-reqParam"),-1!==u.state.func[4].indexOf(t)&&(n+=" item-multiParam"),-1!==l.indexOf(t)&&(n+=" item-fieldParam"),a.push({text:t+": "+i,textVis:t,title:"",render:p,type:n,hint:w,curPos:u.start+(t+": "+i).length-i.length})}))):(a=["true","false",v,_,y,x],"order"===u.state.functionParam&&(a=a.concat(["asc","desc"])));return{list:h(u,a,r,d),from:CodeMirror.Pos(f.line,u.start),to:CodeMirror.Pos(f.line,u.end)}}(e,f,(function(e,t){return e.getTokenAt(t)}),a)}));let o=[],r=!1,d=null;const c=function(){if((!d||d<Math.floor(Date.now()/1e3)-40)&&(d=Math.floor(Date.now()/1e3),o=[]),0===o.length&&!r){r=!0;let e=t("#table").data("pctable");e&&e.isCreatorView&&e.model.getAllTables().then((function(e){o=e.tables,r=!1}))}return o},p=function(e,a,n){t(e).append('<span class="'+n.type+'">'+(n.textVis||n.text)+(""===n.title?"":' <span class="descr">'+n.title+"</span>")+"</span>")};let f=[];function h(e,t,a,n){var i=[],l=[];n=void 0===n?e.string.toLowerCase():n,a&&a.globalScope;if(!e.state.showAll&&""===n)return found;return t.forEach((function(e){let t,s="";if("string"==typeof e?t=e.toLowerCase():(t=e.text.toLowerCase(),e.title&&(s=e.title.toLowerCase())),!u(i,t)&&!u(l,t)){0===t.lastIndexOf(n,0)||0===s.lastIndexOf(n,0)?i.push(e):-1!==s.indexOf(n,0)?l.push(e):a.inStart||-1===t.indexOf(n)||l.push(e)}})),1===i.length&&i[0]===n||1===i.length&&i[0].text===n||1===l.length&&l[0]===n||1===l.length&&l[0].text===n?[]:i.concat(l)}function u(e,t){return-1!==e.indexOf(t)}CodeMirror.defineOption("autoCloseFunctions",!1,(function(a){"totum"===a.getOption("mode")&&function(a){c();var n={name:"autoCloseFunctions"};n["'('"]=s,n["')'"]=s,a.addKeyMap(n),a.on("keydown",(function(e,t){"9"===(t.keyCode||t.which).toString()&&function(e,t,a){var n=e.getCursor();if(e.getTokenAt(n).state.inFunction){let i,l,s=e.getLine(n.line);if(a||t){i=n.ch;let e=i;for(;" "===s[e];)e++;if(";"===s[e])for(i=e,l=i+1;";"!==s[l]&&")"!==s[l];)l++;else{for(l=i;";"!==s[l]&&")"!==s[l];)l++;for(";"===s[l]&&l++;"("!==s[i]&&";"!==s[i];)i--;i++}}else{for(i=n.ch;s[i]&&-1===[":",")"].indexOf(s[i]);)i++;for(":"===s[i]&&(i++," "===s[i]&&i++)," "===s[i]&&i++,l=i;s[l]&&-1===[";",")"].indexOf(s[l]);)l++}return e.setSelection({line:n.line,ch:i},{line:n.line,ch:l}),!0}}(e,t.altKey,t.shiftKey)&&t.preventDefault()})),a.on("keyup",(function(t,a){t.options.bigOneDialog&&e.top.wasCtrl(a)&&"83"===(a.keyCode||a.which).toString()?(a.stopPropagation(),"function"==typeof t.options.bigOneDialog?t.options.bigOneDialog():t.options.bigOneDialog.close()):e.top.wasCtrl(a)&&"191"===(a.keyCode||a.which).toString()&&CodeMirror.commentMe(t),"27"===(a.keyCode||a.which).toString()?(t.state.completionActive&&t.state.completionActive.close(),a.stopPropagation()):{9:"tab",13:"enter",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",38:"up",40:"down",57:"("}[(a.keyCode||a.which).toString()]||CodeMirror.showHint(t,CodeMirror.hint.totumVars,{})})),a.on("dblclick",(function(e){var n=a.getCursor(),i=a.getTokenAt(n).state;let l,s=t(a.getWrapperElement()),o=a.getLine(n.line),r=o.substring(0,n.ch);if(i.inTotumBlock)return!1;if(/^\s*~?(```)?\s*?[a-zA-Z0-9_]+$/.test(r))l=i.lineName;else{let e=n.ch-1;if(/[a-zA-Z0-9_]/.test(o[e])){for(;--e&&e>=0&&/[a-zA-Z0-9_]/.test(o[e]););if("$"===o[e]){let t=e+1;for(e=n.ch-1;++e&&o.length>e&&/[a-zA-Z0-9_]/.test(o[e]););l=o.substring(t,e)}}}if(l){if(new RegExp("^s*~?(```)?s*"+l+"s*:").test(s.find(".cm-start.light").text()))s.find(".light").removeClass("light");else{s.find(".light").removeClass("light");let e=new RegExp("\\$"+l+"\\b");s.find(".cm-variable,.cm-inVars,.cm-spec,.cm-db_name").filter(":not(.cm-totum-block)").each((function(){let a=t(this);a.text().match(e)&&a.addClass("light")})),s.find(".cm-start:not(.cm-totum-block)").each((function(){let e=t(this);e.text().trim().replace("~","").replace(":","").replace("```","")===l&&e.addClass("light")}))}}}))}(a),"sections"===a.getOption("mode")&&CodeMirror.sectionsAutoCloses(a)})),function(){"use strict";function t(e,t,a){this.cm=e,this.getHints=t,this.options=a,this.widget=this.onClose=null}function a(e){return"string"==typeof e?e:e.text}function n(t,n){this.completion=t,this.data=n;var i=this,l=t.cm,s=t.options,o=this.hints=e.top.document.createElement("ul");o.className="CodeMirror-hints",this.selectedHint=0;for(var r=n.list,d=0;d<r.length;++d){var c=o.appendChild(e.top.document.createElement("li")),p=r[d],f="CodeMirror-hint"+(d?"":" CodeMirror-hint-active");null!=p.className&&(f=p.className+" "+f),c.className=f,p.render?p.render(c,n,p):c.appendChild(e.top.document.createTextNode(p.displayText||a(p))),c.hintId=d}var h=l.cursorCoords(!1!==s.alignWithWord?n.from:null),u=h.left,m=h.bottom+3,b=!0;o.style.left=u+"px",o.style.top=m+"px";var g,w=e.innerWidth||Math.max(e.top.document.body.offsetWidth,e.top.document.documentElement.offsetWidth),v=e.innerHeight||Math.max(e.top.document.body.offsetHeight,e.top.document.documentElement.offsetHeight),_=o.getBoundingClientRect(),y=_.right-w,x=_.bottom-v;if(y>0&&(_.right-_.left>w&&(o.style.width=w-5+"px",y-=_.right-_.left-w),o.style.left=(u=h.left-y)+"px"),x>0){var C=_.bottom-_.top;_.top-(h.bottom-h.top)-C>0?(x=C+(h.bottom-h.top),b=!1):C>v&&(o.style.height=v-5+"px",x-=C-v),o.style.top=(m=h.bottom-x)+"px"}((s.container||e.top.document.body).appendChild(o),l.addKeyMap(this.keyMap=function(e,t){var a={Up:function(){t.moveFocus(-1)},Down:function(){t.moveFocus(1)},PageUp:function(){t.moveFocus(-t.menuSize())},PageDown:function(){t.moveFocus(t.menuSize())},Home:function(){t.setFocus(0)},End:function(){t.setFocus(t.length)},Enter:t.pick,Esc:t.close},n=e.customKeys?{}:a;function i(e,i){var l;l="string"!=typeof i?function(e){return i(e,t)}:a.hasOwnProperty(i)?a[i]:i,n[e]=l}if(e.customKeys)for(var l in e.customKeys)e.customKeys.hasOwnProperty(l)&&i(l,e.customKeys[l]);if(e.extraKeys)for(var l in e.extraKeys)e.extraKeys.hasOwnProperty(l)&&i(l,e.extraKeys[l]);return n}(s,{moveFocus:function(e){i.changeActive(i.selectedHint+e)},setFocus:function(e){i.changeActive(e)},menuSize:function(){return i.screenAmount()},length:r.length,close:function(){t.close()},pick:function(){i.pick()}})),!1!==s.closeOnUnfocus)&&(l.on("blur",this.onBlur=function(){g=setTimeout((function(){t.close()}),100)}),l.on("focus",this.onFocus=function(){clearTimeout(g)}));var k=l.getScrollInfo();return l.on("scroll",this.onScroll=function(){var a=l.getScrollInfo(),n=l.getWrapperElement().getBoundingClientRect(),i=m+k.top-a.top,s=i-(e.pageYOffset||(e.top.document.documentElement||e.top.document.body).scrollTop);if(b||(s+=o.offsetHeight),s<=n.top||s>=n.bottom)return t.close();o.style.top=i+"px",o.style.left=u+k.left-a.left+"px"}),CodeMirror.on(o,"click",(function(e){for(var t=e.target||e.srcElement;"SPAN"===t.nodeName;)t=t.parentNode;null!=t.hintId&&(i.changeActive(t.hintId),i.pick())})),CodeMirror.on(o,"mousedown",(function(){setTimeout((function(){l.focus()}),20)})),CodeMirror.signal(n,"select",r[0],o.firstChild),!0}CodeMirror.showHint=function(e,a,n){if(!e.somethingSelected()&&(null==a&&(a=e.getHelper(e.getCursor(),"hint")),null!=a)){e.state.completionActive&&e.state.completionActive.close();var i=e.state.completionActive=new t(e,a,n||{});if(CodeMirror.signal(e,"startCompletion",e),!i.options.async)return i.showHints(a(e,i.options));a(e,(function(e){i.showHints(e)}),i.options)}},CodeMirror.commentMe=function(e){var t=e.getCursor(),a=(e.getTokenAt(t).state,e.lineInfo(t.line));let n;(n=a.text.match(/^([\t\s]*)\/\//))?e.replaceRange("",{line:t.line,ch:n[1].length},{line:t.line,ch:n[0].length}):(n=a.text.match(/^[\t\s]*/),e.replaceRange("//",{line:t.line,ch:n[0].length},{line:t.line,ch:n[0].length}))},t.prototype={close:function(){this.active()&&(this.widget&&this.widget.close(),this.onClose&&this.onClose(),this.cm.state.completionActive=null,CodeMirror.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(e,t){var n=e.list[t];n.hint?n.hint(this.cm,e,n):this.cm.replaceRange(a(n),e.from,e.to),this.close();this.cm},showHints:function(e){if(!e||!e.list.length||!this.active())return this.close();this.showWidget(e)},showWidget:function(e){this.widget=new n(this,e),CodeMirror.signal(e,"shown");var t,a=null,i=this,l=this.options.closeCharacters||/[\s()\[\]{};:>,]/,s=this.cm.getCursor(),o=this.cm.getLine(s.line).length;function r(){t||(t=!0,i.close(),i.cm.off("cursorActivity",f),CodeMirror.signal(e,"close"))}function d(){return!!t||(i.widget?void 0:(r(),!0))}function c(){d()||(i.options.async?i.getHints(i.cm,p,i.options):p(i.getHints(i.cm,i.options)))}function p(e){if(!d()){if(!e||!e.list.length)return r();i.widget.close(),i.widget=new n(i,e)}}function f(){clearTimeout(a);var e=i.cm.getCursor(),t=i.cm.getLine(e.line);e.line!=s.line||t.length-e.ch!=o-s.ch||e.ch<s.ch||i.cm.somethingSelected()||e.ch&&l.test(t.charAt(e.ch-1))?i.close():a=setTimeout(c,170)}this.cm.on("cursorActivity",f),this.onClose=r}},n.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null,this.hints.parentNode.removeChild(this.hints),this.completion.cm.removeKeyMap(this.keyMap);var e=this.completion.cm;!1!==this.completion.options.closeOnUnfocus&&(e.off("blur",this.onBlur),e.off("focus",this.onFocus)),e.off("scroll",this.onScroll)}},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(e){if(e=Math.max(0,Math.min(e,this.data.list.length-1)),this.selectedHint!=e){var t=this.hints.childNodes[this.selectedHint];t.className=t.className.replace(" CodeMirror-hint-active",""),(t=this.hints.childNodes[this.selectedHint=e]).className+=" CodeMirror-hint-active",t.offsetTop<this.hints.scrollTop?this.hints.scrollTop=t.offsetTop-3:t.offsetTop+t.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=t.offsetTop+t.offsetHeight-this.hints.clientHeight+3),CodeMirror.signal(this.data,"select",this.data.list[this.selectedHint],t)}},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}}}()}(),function(){const e=function(e){return{doc:e.doc}};CodeMirror.extendMode("css",{commentStart:"/*",commentEnd:"*/",newlineAfterToken:function(e,t){return/^[;{}]$/.test(t)}}),CodeMirror.extendMode("javascript",{commentStart:"/*",commentEnd:"*/",newlineAfterToken:function(e,t,a,n){return this.jsonMode?/^[\[,{]$/.test(t)||/^}/.test(a):(";"!=t||!n.lexical||")"!=n.lexical.type)&&(/^[;{}]$/.test(t)&&!/^;/.test(a))}}),CodeMirror.extendMode("xml",{commentStart:"\x3c!--",commentEnd:"--\x3e",newlineAfterToken:function(e,t,a){return"tag"==e&&/>$/.test(t)||/^</.test(a)}}),CodeMirror.defineExtension("commentRange",(function(e,t,a){var n=this,i=CodeMirror.innerMode(n.getMode(),n.getTokenAt(t).state).mode;n.operation((function(){if(e)n.replaceRange(i.commentEnd,a),n.replaceRange(i.commentStart,t),t.line==a.line&&t.ch==a.ch&&n.setCursor(t.line,t.ch+i.commentStart.length);else{var l=n.getRange(t,a),s=l.indexOf(i.commentStart),o=l.lastIndexOf(i.commentEnd);s>-1&&o>-1&&o>s&&(l=l.substr(0,s)+l.substring(s+i.commentStart.length,o)+l.substr(o+i.commentEnd.length)),n.replaceRange(l,t,a)}}))})),CodeMirror.defineExtension("autoIndentRange",(function(e,t){var a=this;this.operation((function(){for(var n=e.line;n<=t.line;n++)a.indentLine(n,"smart")}))})),CodeMirror.defineExtension("autoFormatRange",(function(t,a){var n=this,i=n.getMode(),l=n.getRange(t,a).split("\n"),s=CodeMirror.copyState(i,n.getTokenAt(t).state),o=n.getOption("tabSize"),r="",d=0,c=0==t.ch;function p(){r+="\n",c=!0,++d}for(var f=0;f<l.length;++f){for(var h=new CodeMirror.StringStream(l[f],o,e(n));!h.eol();){var u=CodeMirror.innerMode(i,s),m=i.token(h,s),b=h.current();h.start=h.pos,c&&!/\S/.test(b)||(r+=b,c=!1),!c&&u.mode.newlineAfterToken&&u.mode.newlineAfterToken(m,b,h.string.slice(h.pos)||l[f+1]||"",u.state)&&p()}!h.pos&&i.blankLine&&i.blankLine(s),c||p()}n.operation((function(){n.replaceRange(r,t,a);for(var e=t.line+1,i=t.line+d;e<=i;++e)n.indentLine(e,"smart");n.setSelection(t,n.getCursor(!1))}))})),t((function(){}))}();let r={};var d={sortable:!1,width:50,icon:"fa-font",editable:!1,required:!0,insertable:!1,type:"string",getPanelVal:e=>e,getPanelFormats(e,a){let n=this;if(e.empty(),a){let i;a.rows.forEach(i=>{switch(i.type){case"text":e.append(t('<div class="panel-text">').text(i.value));break;case"html":e.append(t('<div class="panel-html">').html(i.value));break;case"img":e.append(t('<div class="panel-img">').append(t("<img>").attr("src","/fls/"+i.value+"_thumb.jpg?rand="+Math.random())));break;case"buttons":if(i.value&&i.value.forEach){let l=[];i.value.forEach(e=>{let i=t('<button class="btn btn-default btn-xxs">').text(e.text);l.push(i),e.color&&i.css("color",e.color),e.background&&i.css("background-color",e.background),i.on("click",(function(){n.pcTable.selectedCells.empty(),n.pcTable.selectedCells.selectPanelDestroy(),n.pcTable.model.panelButtonsClick(a.hash,e.ind).then((function(t){e.refresh&&n.pcTable.model.refresh(null,e.refresh)}))}))}),e.append(t('<div class="panel-buttons">').append(l))}}}),a.hash&&(i=setInterval(()=>{e.closest("body").length||(clearInterval(i),n.pcTable.model.panelButtonsClear(a.hash))},1e3))}},getEditVal:function(e){var t,a=e.val().trim(),n=!1;(!this.required||void 0!==a&&""!==a&&null!==a||(t=App.translate("The field %s must be entered",this.title),n=!0),this.regexp&&""!==a)&&(new RegExp(this.regexp).test(a)||(t=this.regexpErrorText||App.translate('Value fails regexp validation: "%s"',this.regexp),t=App.translate('Filled "%s" field  error: %s',[this.title,t]),n=!0));if(n)throw t;return a},getEditElement:function(e,a,n,i,l,s,o){var r=t('<input type="text" class="form-control" name="cell_edit" autocomplete="off" autocorrect="off" />');void 0!==o&&r.attr("tabindex",o);var d=this;return a=a.v,r.val(a).on("keydown",(function(e){switch(e.keyCode){case 13:case 9:try{r.data("enterClicked",!0),i(t(this),e)}catch(e){r.data("enterClicked",!1),App.popNotify(e,r,"default"),d.focusElement(r)}break;case 27:l(t(this),e)}})),r.on("blur",(function(e){s(r,e)})),r.select()},checkEditRegExp:function(e){if(!this.warningEditRegExp)return!0;try{let t=this.warningEditRegExp.match(/^\/(.*?)\/([a-z]*)$/);return new RegExp(t[1],t[2]).test(e)}catch(e){return!0}},getCellText:function(e){if(!0===this.url&&e){let a=this.openIn||"window";switch(a){case"window":a="_self";break;case"newWindow":a="_blank"}let n=t('<a class="uri" target="'+a+'">').attr("href",e).text(e);return"iframe"===a&&n.attr("onclick","return App.aInIframe(this);"),n}return e},getPanelText:function(e,t,a){return this.getCellText(e,t,a)},getCopyText:function(e,a){let n=this.getPanelText(e.v,null,a);if("string"==typeof n)return n;const i=function(e){if(e&&e.each&&"[object Function]"==={}.toString.call(e.each)){let a="";return e.each((function(){""!==a&&(a+="; "),a+=t(this).text().replace(/\n/g,"; ")})),a}return e};if(null===n)return"";if("object"==typeof n&&!(n instanceof jQuery)){let e=t.Deferred();return n.done((function(t){e.resolve(i(t))})).fail((function(){e.resolve(App.translate("Failed to load data"))})),e}return i(n)},focusElement:function(e){e.focus(),e.closest("tr").is(".InsertRow")&&(this.pcTable._insertRow.find(".active").removeClass("active"),e.closest("td").addClass("active"))},isDataModified:function(e,t){return"null"===(e+="")&&(e=""),"null"===(t+="")&&(t=""),t===(this.errorText||App.translate("ERR!"))&&(t=""),"undefined"===t&&(t=""),e!==t},getFilterDataByValue:function(e){let t=[];return this.addDataToFilter(t,e),Object.keys(t)},addDataToFilter:function(e,t){let a,n=App.translate("Empty");null===t.v||""===t.v?a="".hashCode():(a=t.v.toString().hashCode(),n="string"==typeof t.v?t.v.replace(/"/g,"&quot;"):t.v+" "),e[a]=n},checkIsFiltered:function(e,t){let a={};return this.addDataToFilter(a,e),t.some((function(e){return e in a}))},getCellTextInPanel:function(e,t,a){return this.getCellText(e,t,a)},getPanelColumnIndex:function(e){return e.f&&e.f.hide&&e.f.hide.panel?0:-1!==["text","comments","file","listRow"].indexOf(this.type)||this.multiple?1.5:1},getHighCelltext:function(e,t,a){return this.getPanelText?this.getPanelText(e,t,a):this.getCellText(e,t,a)}};r.text={width:50,icon:"fa-align-left",type:"Text",isPanelField:!0,getEditVal:function(e){return e.data("val").trim()},getCellText:function(e){if(null===e)return"";let a=(e=e.toString()).length;return t("<div>").text(e.substring(0,this.viewTextMaxLength)+(a>this.viewTextMaxLength?"...":"")).text()},getValue:function(e,a,n){"use strict";if(n||"string"==typeof e&&e.length<this.viewTextMaxLength&&!this.notLoaded){let a=t.Deferred();return setTimeout((function(){e||(e=""),a.resolve({value:e})}),20),a}let i={fieldName:this.name};return a.id&&(i.rowId=a.id),this.pcTable.model.getValue(i,this.table_id)},getPanelTextWithLinks:function(e,a=!0){let n;if("text"===this.textType)n=t("<div>"),n.html(App.textWithLinks(e));else if(n=t('<div class="codeEditor">'),e&&e.trim()){let t={value:e,mode:this.getMode(),readOnly:!0,theme:"eclipse",lineNumbers:!0,lineWrapping:!0,bigOneDialog:!0,height:200};a?setTimeout((function(){CodeMirror(n.get(0),t)}),10):n.html(App.textWithLinks(e)),n.on("panel-resize",(function(){n.empty(),CodeMirror(n.get(0),t)}))}return n},getHighCelltext:function(e,a,n){return"string"!=typeof e?"":t("<div>").text(e.trim())},getPanelText:function(e,a,n){if(null===e)return"";e=e.toString();let i=this;if(e.length<=this.viewTextMaxLength&&!this.notLoaded)return i.getPanelTextWithLinks(e,!1).data("text",e);let l=t.Deferred();return this.getValue(e,n,!1).then((function(e){l.resolve(t("<div>").append(i.getPanelTextWithLinks(e.value,!1)).data("text",e.value))})).fail((function(){l.reject()})),l.promise()},getMode(){let e="text";switch(this.textType){case"html":e="text/html";break;case"totum":e="totum";break;case"markdown":e="text/x-markdown";break;case"xml":e="application/xml";break;case"css":e="text/css";break;case"javascript":e="text/javascript"}return e},getEditElement:function(a,n,i,l,s,o,r,d){let c,p=this,f=t("<div>"),h=t("<div>"),u=t('<div class="HTMLEditor">');n=n.v||"";let m=function(){p.getValue(n,i,!d).then((function(a){let n;if(f.append(u),u.empty().appendTo(h),"json"===p.textType){n=new JSONEditor(u.get(0),{});try{""!==a.value&&n.setText(a.value)}catch(t){e.top.App.modal(App.translate("JSON format error"))}let i=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">'+App.translate("Manually")+"</a>").on("click",(function(){let a=t("<div>"),i=t('<textarea class="form-control">').val(JSON.stringify(n.get(),null,2)).appendTo(a);e.innerHeight>460&&(i.css("height",350),u.css("min-height",200));let l=[{label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:function(t){try{n.setText(i.val()),t.close()}catch(t){e.top.App.modal(App.translate("JSON format error"))}}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];return p.pcTable.isMobile?App.mobilePanel(App.translate("Manually changing the json field"),a,{buttons:l}):BootstrapDialog.show({message:a,type:null,title:App.translate("Manually changing the json field"),buttons:l,cssClass:"fieldparams-edit-panel",draggable:!0,onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1}));u.find(".jsoneditor-menu").append(i)}else{let l=p.getMode(),s=t("<div>").appendTo(u),o={value:(a.value||"").toString(),mode:l,minHeight:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0};"text"===l&&(o.lineNumbers=!1,o.lineWrapping=!0),n=CodeMirror(s.get(0),o),n.on("paste",(function(e,t){setTimeout((function(){n.refresh()}),1)})),p.pcTable&&"tables"===p.pcTable.tableRow.name&&(n.table=i.name.v||i.name),e.innerHeight>585&&(n.getScrollerElement().style.minHeight="350px",h.css("min-height",200)),n.focus()}u.data("editor",n),f.data("editor",n)}))};const b=function(e,t,a){"json"===p.textType?f.data("val",JSON.stringify(u.data("editor").get())):f.data("val",u.data("editor").getValue()),a||(l(f,{}),e.close())};c=[];let g={label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:b},w={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){s(f,{}),e.close()}};-1!==["xml","html"].indexOf(p.textType)&&c.unshift({label:App.translate("Format"),action:function(){let e=u.data("editor"),t=e.lineCount(),a=e.getValue().length;e.autoFormatRange({line:0,ch:0},{line:t,ch:a})}});let v=App.translate("Field <b>%s</b> text",this.title)+", <b>"+p.textType+"</b>"+this.pcTable._getRowTitleByMainField(i," (%s)"),_="ctrlS.textedit";if(d){let a=!1;setTimeout((function(){let n=f.closest("td").find(".cdiv");if(n.length>0?(n.data("bs.popover").options.content.find(".btn").each((function(){let e=t(this),n={};n.label=e.data("name"),n.cssClass=e.attr("class").replace("btn-sm","btn-m"),n.icon=e.find("i").attr("class"),n.save=e.data("save"),n.click=e.data("click"),n.action=function(e){n.save&&b(e,0,!0),n.click({}),a=!0,e.close()},c.push(n)})),n.popover("destroy")):(c.push(g),c.push(w)),p.pcTable.isMobile)App.mobilePanel(v,h,{buttons:c,onhide:function(e){t("body").off(_),a||o(f,{})},onshown:function(e){m()},onshow:function(e){t("body").on(_,(function(t){return b(e),!1}))}});else{let n=e.top.BootstrapDialog.show({message:h,type:null,title:v,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:c,onhide:function(n){t(e.top.document).find("body").off(_),a||s(f,{})},onshown:function(a){a.$modalContent.position({of:t(e.top.document).find("body"),my:"top+50px",at:"top"}),m()},onshow:function(a){a.$modalHeader.css("cursor","pointer"),a.$modalContent.css({width:"100%"}),t(e.top.document).find("body").on(_,(function(e){return b(a),!1}))}});f.data("Dialog",n)}}),1),f.text(App.translate("Editing in the form")).addClass("edit-in-form")}else{f.on("keydown click",(function(a){if("Tab"===a.key)return void o(h,a,null,!0);let n=c.splice();n.push(g),n.push(w);var i=t(this).closest("div");p.pcTable.isMobile?App.mobilePanel(v,h,{buttons:n,onhide:function(e){t("body").off(_),s(i,e)},onshown:function(e){m(),t("body").on(_,(function(t){return b(e),!1}))}}):e.top.BootstrapDialog.show({message:h,type:null,cssClass:"fieldparams-edit-panel",title:v,buttons:n,draggable:!0,onhide:function(a){t(e.top.document).find("body").off(_),s(i,a)},onshown:function(a){a.$modalHeader.css("cursor","pointer"),m(),a.$modalContent.css({width:900}),t(e.top.document).find("body").on(_,(function(e){return b(a),!1}))}})}));let a=t('<button class="btn btn-default btn-sm text-edit-button">').text(App.translate("Edit text"));r&&a.attr("tabindex",r),f.append(a)}return f.data("val",n)},getEditPanelText(e){return this.getPanelTextWithLinks(e.v)},getCellTextInPanel:function(e,t,a){return this.getPanelTextWithLinks(e)},addPlaceholder(e,t){setTimeout((function(){e.data("editor").setOption("placeholder",t),e.data("editor").refresh()}),100)}},r.checkbox={icon:"fa-check-square",getEditVal:function(e){return!!e.is(":checked")},getCellText:function(e){return!0===e?"":!1===e?"-":""},getEditElement:function(e,a,n,i,l,s,o){var r=t('<input type="checkbox" name="cell_edit"/>');o&&r.attr("tabindex",o);let d=!1;r.on("keydown",(function(e){switch(e.keyCode){case 13:case 9:d=!0,setTimeout((function(){i(r,e)}),20)}})),r.on("blur",(function(e){d||setTimeout((function(){r.length&&r.closest("body").length&&l(r,e)}),220)}));return!0===a.v&&r.prop("checked",!0),r.on("click",(function(e){d=!0,i(r,e)})),r}},r.string={addPlaceholder:function(e,t){e.attr("placeholder",t)}},r.number={icon:"fa-hashtag",getEditVal:function(e){let t=e.val().trim();if(void 0===t||""===t||null===t){if(this.required)throw App.translate("The field %s must be entered",this.title);return""}if(this.regexp&&!new RegExp(this.regexp).test(t)){let e=this.regexpErrorText||App.translate('Value fails regexp validation: "%s"',this.regexp);throw e=App.translate('Filled "%s" field  error: %s',[this.title||this.name,e]),e}let a=t.replace(/[^\-()\d/*+.,%:\/]/g,"");if(!/^(\+|\*|\%|\/|\:)?(\-?[\d]+((\.|\,)[\d]+)?)%?$/.test(a))throw App.translate("There must be a number");return t=t.replace(/,/,"."),t},getCopyText:function(e,t,a){return null==e||""===e||null===e.v?"":e.v.toString().replace(/\./g,",")},numberFormat:function(e,t,a,n){var i=isFinite(+e)?+e:0,l=isFinite(+t)?Math.abs(t):0,s=void 0===n?" ":n,o=void 0===a?",":a,r=(l?function(e,t){var a=Math.pow(10,t);return Math.round(e*a)/a}(i,l):Math.round(i)).toString().split(".");return r[0].length>3&&(r[0]=r[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,s)),(r[1]||"").length<l&&(r[1]=r[1]||"",r[1]+=new Array(l-r[1].length+1).join("0")),r.join(o)},getCellText:function(e,t,a){if(null==e||""===e)return"";if(this.currency){let t,a,n;"dectimalSeparator"in this&&(t=this.dectimalSeparator,t.match(/\*\*/)&&(t=t.split("**")[e>=0?0:1])),"thousandthSeparator"in this&&(a=this.thousandthSeparator,a.match(/\*\*/)&&(a=a.split("**")[e>=0?0:1])),n=this.postfix,n=n&&n.match(/\*\*/)?n.split("**")[e>=0?0:1]:"";let i=this.prefix||"";i.match(/\*\*/)&&(i=i.split("**")[e>=0?0:1],e=Math.abs(e));let l=this.dectimalPlaces||0;return i+this.numberFormat(parseFloat(e),l,t,a)+n}return e},addPlaceholder:function(e,t){e.attr("placeholder",t)}},r.date={icon:"fa-calendar-o",getEditVal:function(e){if(this.required&&""==e.val().trim())throw App.translate("The field must be entered");if(!e.val().trim())return"";let t=e.data("calendar").data("DateTimePicker").date();return this.getDbString(t)},getEditElement:function(e,a,n,i,l,s,o){var r=t('<input type="text" name="cell_edit" class="form-control" autocomplete="off" autocorrect="off" />');o&&r.attr("tabindex",o);var d=this;let c=this.getFormat();r.data("AppUin",App.getUn()),a=a.v,r.val(this.getViewString(a));let p,f=t("<div>");this.dateTime&&/d/i.test(c)&&(p="date-popover");var h=t("<div></div>").appendTo(f);let u,m,b;h.on("dp.change",(function(e){if(null!==e.oldDate||!d.dateTime||r.val()&&""!==r.val())r.val(e.date.format(c));else{let t=e.date,a=moment();t.format("HH:mm")===a.format("HH:mm")&&(t=t.hours(0).minutes(0)),r.val(t.format(c)),g()}})),r.on("keydown",(function(e){u&&clearTimeout(u),13===e.keyCode||9===e.keyCode?(g(),b&&b.is(":visible")&&b.hide(),i(t(this),e)):27===e.keyCode&&l(t(this),e)})),r.on("keyup",(function(e){e.keyCode>=48&&(u=setTimeout((function(){g()}),2e3))}));const g=function(){"use strict";let e=r.val(),t=c;e?(!c.match(/Y{4}/)&&c.match(/Y{2}/)&&e.length-moment().format(c).length==2&&(t=t.replace("YY","YYYY")),e=moment(e,t)):e="";try{h.data("DateTimePicker").date(e)}catch(e){}};if(setTimeout((function(){let e=r.closest("td").find(".cdiv");if(e.length>0){let a=e.data("bs.popover");a&&(f.append(a.options.content),e.popover("destroy")),b=t("#"+App.popNotify({$text:f,element:e,container:d.pcTable._container,isParams:!0,placement:"bottom",class:p})),r.on("focus click",(function(){b.show()}))}else{const e=function(){b&&r.popover("destroy"),m=App.popNotify(f,r,null),b=t(r.get(0).ownerDocument.getElementById(m)),h.data("DateTimePicker").show(),b.show(),g()};r.on("focus mouskeydown",e)}}),20),r.on("blur",(function(e){setTimeout((function(){b&&b.is(":visible")&&(b.hide(),g(),s(r,e))}),200)})),h.datetimepicker({inline:!0,format:c,useCurrent:!1,showClose:!1,locale:App.lang.localeDatetimepicker,sideBySide:!0,collapse:!1}),a)try{h.data("DateTimePicker").date(d.getMoment(a))}catch(e){}else r.val("");return r.data("calendar",h),r},getCellText:function(e){return e&&null!==e?this.getViewString(e):""},getViewString:function(e){return e?this.dateTime?App.dateTimeFormats.covertFromDb(e,this.getFormat()):App.dateFormats.covertFromDb(e,this.getFormat()):""},getDbString:function(e){return e?this.dateTime?App.dateTimeFormats.covertToDb(e,this.getFormat()):App.dateFormats.covertToDb(e,this.getFormat()):""},getMoment:function(e){return this.dateTime?moment(e,App.dateTimeFormats.db):moment(e,App.dateFormats.db)},addDataToFilter:function(e,t){let a,n=App.translate("Empty");null===t.v||""===t.v?a="".hashCode():(a=t.v.toString().hashCode(),n="string"==typeof t.v?this.getCellText(t.v):t.v),e[a]=n},getFormat:function(){let e=this.dateFormat;e||(e=this.dateTime?"d.m.y H:i":"d.m.y");let t={d:"DD",D:"ddd",j:"M",z:"DDD",W:"W",F:"MMMM",m:"MM",M:"MMM",n:"M",y:"YY",Y:"YYYY",H:"HH",i:"mm",s:"ss"},a="";for(let n=0;n<e.length;n++){let i=e[n];a+=t[i]||i}return a}},r.unic={icon:"fa-fire"},function(){const a=function(e,t){e.attr("data-fileviewpreview",JSON.stringify({name:t.name,file:t.file}))};r.file={icon:"fa-file-image-o",getSize:function(e){return e>102400?" "+(Math.round(e/1048576*10)/10).toLocaleString()+"Mb":" "+Math.round(e/1024).toLocaleString()+"Kb"},getCellText:function(e){if(!e||null===e||0==e.length)return"";let n=t('<span style=""></span>');const i=function(e){let i;-1!==["png","jpg"].indexOf(e.ext)?(i=t('<img src="/fls/'+e.file+'_thumb.jpg" style="z-index: 200; max-height: 24px; padding-right: 4px;" class="file-image-preview" data-filename="'+e.file+'"/>'),a(i,e)):i="pdf"===e.ext?'<img src="/imgs/file_ico_pdf.png" style="max-height: 24px;  padding-right: 4px;" class="file-pdf-preview" data-filename="/fls/'+e.file+'"/>':'<img src="/imgs/file_ico.png" style="max-height: 24px;  padding-right: 4px;"/>';let l=t('<a href="/fls/'+e.file+'"  class="file-sell-text" download="'+t("<div>").text(e.name).html()+'" style="padding-right: 5px"></a>');n.append(i),l.append(e.name),n.append(l)};return e.length&&e.forEach&&e.forEach(i),n.children()},getCopyText:function(t,a){if(!(t=t.v)||null===t||0==t.length)return"";let n=this,i="";return t.forEach((function(t){""!==i&&(i+="\n"),i+=t.name+" "+e.location.protocol+"//"+e.location.host+"/fls/"+t.file+" "+n.getSize(t.size)})),i},getPanelText:function(n){if(!n||null===n||0==n.length)return"";let i=t('<div class="file-mini-panel">'),l=this,s="",o=Math.random();return n.forEach((function(n){let r="",d="";-1!==["jpg","png"].indexOf(n.ext)&&(r=t('<img src="/fls/'+n.file+"_thumb.jpg?rand="+o+'"/>'),d="with-img",a(r,n)),t("<div>").addClass(d).appendTo(i).append(r).append(t('<br/><a href="/fls/'+n.file+'" download="'+t("<div>").text(n.name).html()+'">').text(n.name)).append(l.getSize(n.size)),""!==s&&(s+="\n"),s+=e.location.protocol+"//"+e.location.host+"/fls/"+n.file})),i.data("text",s)},getEditVal:function(e){if(this.required&&""==e.data("val"))throw App.translate("The field must be entered");return e.data("val")},getEditElement:function(a,n,i,l,s,o,r,d){let c,p,f=this,h=this.pcTable,u=t("<div>"),m=t("<div>").css("min-height",200),b=n.v||[],g=!1;const w=function(e){let a=t('<div class="filePart"><div><span class="name"></span><span class="size"></span><button class="btn btn-danger btn-xs remove"><i class="fa fa-remove"></i></button></div></div>'),n={name:e.name,type:e.type,tmpfile:e.tmpfile,size:e.size,file:e.file,ext:e.ext};new RegExp("^"+f.pcTable.tableRow.id+"_"+(i.id?i.id:""));if(a.data("file",n),a.find(".name").text(e.name),a.find(".size").text(f.getSize(e.size)),e.file){let n=t("<a>").attr("href","/fls/"+e.file).attr("download",e.name);a.find(".name").wrap(n),-1!==["jpg","png"].indexOf(e.ext)&&(t("<img>").attr("src","/fls/"+e.file+"_thumb.jpg?rand="+Math.random()).insertBefore(a.find(".name")),a.addClass("with-img"))}else a.append('<div class="progressbar">&nbsp;</div>');if(e.tmpfile){a.addClass("addFile"),a.find(".progressbar").text(App.translate("Required to save the item for file binding"))}return a},v=function(e){p.$modalFooter.find("button:first").prop("disabled",e)},_=function(){m.empty();let e=t('<input type="file" name = "file" '+(f.multiple?"multiple":"")+' accept="'+f.accept+'" style="display: block; position: absolute; top: -3000px"/>'),a=t("<div>").appendTo(m),n=t('<button class="btn btn-default btn-sm">'+App.translate(f.multiple?"Adding files":"Adding file")+"</button>");a.append(n),n.wrap('<div class="addFilesButton">'),n.wrap("<div>");let i=t('<div class="ttm-dropzone" id="ttmDropzone">'+App.translate("Drag and drop the file here")+"</div>").insertAfter(n.parent());i.on("dragenter",()=>i.addClass("highlight")),i.on("dragleave",()=>i.removeClass("highlight")),i.on("drop",e=>{if(e.preventDefault(),i.removeClass("highlight"),!i.is(".disabled")){if(!this.multiple&&e.originalEvent.dataTransfer.files.length>1)return App.notify(App.translate("The field accepts only one file"),App.translate("Error")),!1;s(e.originalEvent.dataTransfer.files)}return!1});const l=function(){f.multiple||(m.find(".filePart").length>0?(n.prop("disabled",!0),i.addClass("disabled")):(n.prop("disabled",!1),i.removeClass("disabled")))},s=function(e){if(e){let a=[];v(!0);for(let n=0,i=e.length;n<i;n++){let i=e[n],s=w(i).addClass("addFile").appendTo(m);l();let o=s.find(".progressbar"),r=new XMLHttpRequest,d=t.Deferred();s.on("click",".remove",(function(){s.remove(),r.abort(),d.resolve(),l()})),r.upload.onprogress=function(e){o.css("box-shadow","inset "+Math.round(parseInt(o.width())*e.loaded/e.total).toString()+"px 0px 0 0 #85FF82"),e.loaded===e.total&&o.text(App.translate("Checking the file with the server"))},r.onload=r.onerror=function(e){if(d.resolve(),200===this.status)try{let e=JSON.parse(this.responseText);if(e.fname)return o.text(App.translate("Done")),void(s.data("file").tmpfile=e.fname)}catch(e){}s.data("file",null),o.text(App.translate("Error")).css({"box-shadow":"none","background-color":"#ffe486"})},r.open("POST",h.model.getUri(),!0);let c=new FormData;c.append("file",i),c.append("method","tmpFileUpload"),c.append("ajax",!0),r.send(c),a.push(d.promise())}t.when(...a).then((function(){v(!1)}))}};b.forEach((function(e){let t=w(e).appendTo(m);t.on("click",".remove",(function(){t.remove(),l()}))})),l(),n.on("click",(function(){t("body").append(e),e.click(),e.on("change",(function(){s(this.files)}))}))},y=function(e){let a=[];e.$modalContent.find(".filePart").each((function(){let e=t(this).data("file");e&&a.push(e)})),u.data("val",a),b=a,g=!0,l(u,{}),e.close()};c=[{label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:y},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){l(u,{}),e.close()}}];let x=App.translate("Files form <b>%s</b>",this.title)+this.pcTable._getRowTitleByMainField(i," (%s)"),C="ctrlS.textdialog",k=function(a){f.pcTable.isMobile?p=App.mobilePanel(x,m,{buttons:c,onhide:function(e){t("body").off(C),g||s(a,e)},onshown:function(e){_(),t("body").on(C,(function(t){y(e)}))}}):(p=e.top.BootstrapDialog.show({message:m,type:null,cssClass:"fieldparams-edit-panel",title:x,draggable:!0,buttons:c,onhide:function(e){t("body").off(C),g||s(a,e)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:600}),_(),t("body").on(C,(function(t){y(e)}))}}),a.data("Dialog",p))};if(d)k(u),u.text(App.translate("Editing in the form")).addClass("edit-in-form");else{u.on("keydown",(function(e){"Tab"!==e.key?k(t(this).closest("div")):o(p,e,null,!0)})),u.on("focus click keydown","button",(function(){k(t(this).closest("div"))}));let e=t('<button class="btn btn-default btn-sm text-edit-button">').text(App.translate("Edit field"));r&&e.attr("tabindex",r),u.append(e)}return u.data("val",b)},getEditPanelText:function(e){return this.getCellTextInPanel(e.v).children()},getCellTextInPanel:function(e){let n=t('<div class="panel-preview"></div>');return e&&e.length&&e.forEach&&e.forEach((function(e){let i;-1!==["png","jpg"].indexOf(e.ext)?(i=t('<img src="/fls/'+e.file+'_thumb.jpg" />'),a(i,e)):i='<img src="/imgs/file_ico.png" />';let l=t('<div><a href="/fls/'+e.file+'" download="'+t("<div>").text(e.name).html()+'"></a></div>');l.prepend(i),l.find("a").append(e.name),n.append(l)})),n},isDataModified:function(e,t){return(-1===[null,""].indexOf(e)||-1===[null,""].indexOf(t))&&(-1!==[null,""].indexOf(e)||-1!==[null,""].indexOf(t)||!Object.equals(t,e))}}}(),r.n=t.extend({},r.default,{name:"n",width:52,title:App.translate("Order"),category:"column",hidden:!0,showInWeb:!0,getCellText:function(e,a,n){let i=n.f||{};if(a.addClass("n"),!n.id||i.block||i.blockorder||n.__inserted&&!this.pcTable.isTreeView||this.pcTable.nSortedTreeBlock)return"";let l='<button class="btn btn-xxs btn-default"><i class="fa fa-angle-up"></i></button><button class="btn btn-xxs btn-default"><i class="fa fa-angle-down"></i></button>';if(this.pcTable.isTreeView)if(n.__tree)l="";else if(void 0===this.pcTable.nSortedTree||this.pcTable.nSortedTree===n.tree.v){let e=this.pcTable.dataSorted.indexOf(n.id+"");l="",e>=1&&"object"!=typeof this.pcTable.dataSorted[e-1]?l+='<button class="btn btn-xxs btn-default"><i class="fa fa-angle-up"></i></button>':l+='<button class="btn btn-xxs btn-default arrow-disabled"><i class="fa fa-angle-up"></i></button>',e<this.pcTable.dataSorted.length-1&&"object"!=typeof this.pcTable.dataSorted[e+1]?l+='<button class="btn btn-xxs btn-default"><i class="fa fa-angle-down"></i></button>':l+='<button class="btn btn-xxs btn-default arrow-disabled"><i class="fa fa-angle-down"></i></button>'}else l="";return t('<span class="btns"></span>').html(l)}}),r.listRow=t.extend({},r.default,{icon:"fa-code",isPanelField:!0,getPanelTextAsTable:function(e){if("object"==typeof e&&null!==e&&e.settings&&e.data&&e.settings.columns&&e.settings.columns.length){const a=t('<table class="json-table">');let n=e.settings,i=n.columns;try{if(n.headRow){const e=t("<tr>").appendTo(a);"boolean"==typeof n.headRow?i.forEach((function(a){t("<td>").text(a).appendTo(e).addClass("head")})):i.forEach((function(a){t("<td>").text(n.headRow[a]).appendTo(e).addClass("head")}))}return e.data.forEach((function(e){const l=t("<tr>").appendTo(a);i.forEach((function(a){let n=e[a];"string"==typeof n&&""!==n||(n=JSON.stringify(n));t("<td>").text(n).appendTo(l)})),n.headColumn&&l.find("td:first").addClass("head")})),a}catch(e){console.log(e)}}},getPanelText:function(e,a,n){let i=t.Deferred(),l=this;const s=function(e){let a=l.getPanelTextAsTable.call(l,e);if(a)return a.copyText=JSON.stringify(e),void i.resolve(a);i.resolve(t("<div>").text(JSON.stringify(e,null,2)))};return"string"!=typeof e?s(e):this.getValue(e,n,!1).then((function(e){s(e.value)})).fail((function(){i.reject()})),i.promise()},getValue:function(e,a,n){"use strict";let i=t.Deferred();if(n||"filter"===this.category||"object"==typeof e||!e)return i.resolve({value:e}),i;{let e={fieldName:this.name};a.id&&(e.rowId=a.id),this.pcTable.model.getValue(e,this.table_id).then((function(e){i.resolve(e)}))}return i},getEditElement:function(a,n,i,l,s,o,r,d){let c,p,f=this,h=t("<div>"),u=t("<div>"),m=t('<div class="HTMLEditor">');n=n.v||"";let b=function(){f.getValue(n,i,!d).then((function(a){let n;h.append(m),m.empty().appendTo(u),n=new JSONEditor(m.get(0),{});try{""!==a.value&&n.setText(JSON.stringify(a.value))}catch(t){e.top.App.modal(App.translate("JSON format error"))}let i=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">'+App.translate("Manually")+"</a>").on("click",(function(){let a=t("<div>"),i=t('<textarea class="form-control">').val(JSON.stringify(n.get(),null,2)).appendTo(a);e.top.innerHeight>460&&(u.css("min-height",200),m.css("min-height",200),i.height(350));const l=function(t){try{n.setText(i.val()),t.close()}catch(t){e.top.App.modal(App.translate("JSON format error"))}};let s=App.translate("Manually changing the json field"),o=[{label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:l},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];if(f.pcTable.isMobile)App.mobilePanel(s,a,{buttons:o});else{let n="ctrlS.Manually";e.top.BootstrapDialog.show({message:a,type:null,title:s,draggable:!0,cssClass:"fieldparams-edit-panel",buttons:o,onhide:function(e){t("body").off(n)},onshown:function(a){a.$modalContent.position({of:e.top}),t("body").on(n,()=>{l(a)})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}})}return!1}));m.find(".jsoneditor-menu").append(i),m.data("editor",n)}))};const g=function(e,t,a){h.data("val",m.data("editor").get()),a||(l(h,{}),e.close())};p=[];let w={label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:g},v={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){s(h,{}),e.close()}},_=App.translate("Field <b>%s</b> text",this.title)+this.pcTable._getRowTitleByMainField(i," (%s)"),y="ctrlS.textedit";if(d){let a=!1;setTimeout((function(){let n=h.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each((function(){let e=t(this),n={};n.label=e.data("name"),n.cssClass=e.attr("class").replace("btn-sm","btn-m"),n.icon=e.find("i").attr("class"),n.save=e.data("save"),n.click=e.data("click"),n.action=function(e){n.save&&g(e,0,!0),n.click({}),a=!0,e.close()},p.push(n)})),n.popover("destroy")):(p.push(w),p.push(v)),f.pcTable.isMobile?App.mobilePanel(_,u,{buttons:p,onhide:function(e){t("body").off(y),a||o(h,{})},onshown:function(e){b()},onshow:function(e){t("body").on(y,(function(t){g(e)}))}}):c=e.top.BootstrapDialog.show({message:u,type:null,title:_,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:p,onhide:function(e){t("body").off(y),a||o(h,{})},onshown:function(a){a.$modalContent.position({of:t(e.top.document.body),my:"top+50px",at:"top"}),b()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:900,maxWidth:"99vw"}),t("body").on(y,(function(t){g(e)}))}}),h.data("Dialog",c)}),1),h.text(App.translate("Editing in the form")).addClass("edit-in-form")}else{h.on("focus click","button",(function(){let a=p.splice();a.push(w),a.push(v);var n=t(this).closest("div");f.pcTable.isMobile?App.mobilePanel(_,u,{buttons:a,onhide:function(e){t("body").off(y),s(n,e)},onshown:function(e){b(),t("body").on(y,(function(t){g(e)}))}}):e.top.BootstrapDialog.show({message:u,type:null,cssClass:"fieldparams-edit-panel",title:_,draggable:!0,buttons:a,onhide:function(a){t(e.top.document.body).off(y),s(n,a)},onshown:function(a){a.$modalHeader.css("cursor","pointer"),b(),a.$modalContent.css({width:900,maxWidth:"99vw"}),t(e.top.document.body).on(y,(function(e){g(a)}))}})}));let a=t('<button class="btn btn-default btn-sm text-edit-button">').text(App.translate("Edit list/json"));r&&a.attr("tabindex",r),h.append(a)}return h.data("val",n)},isDataModified:function(e,t){return""===e&&(e=null),""===t&&(t=null),t!==e&&!Object.equals(e,t)},getEditVal:function(e){return e.data("val")},getCellText:function(e){return"string"!=typeof e?JSON.stringify(e):e},getHighCelltext(e,t,a){return this.getCellText(e)},getEditPanelText(e){return this.getCellText(e.v)}}),r.password={icon:"fa-lock",getEditVal:function(e){var t=e.val().trim(),a=!1;if(void 0!==t&&""!==t&&null!==t||(notify=App.translate("The field %s must be entered",this.title),a=!0),a)throw notify;return t},getCellText:function(e){return"**PASSWORD**"},getEditElement:function(e,a,n,i,l,s,o){var r=t('<input type="password" name="cell_edit" class="form-control"  autocomplete="new-password" autocorrect="off" placeholder="'+App.translate(a&&a.v?"Change the password":"New password")+'"/>');r.on("save-me",(function(e){i(t(this),e)})),o&&r.attr("tabindex",o);var d=this;a=a.v,r.on("keydown",(function(e){switch(e.keyCode){case 13:case 9:try{return r.data("enterClicked",!0),i(t(this),e),!1}catch(e){r.data("enterClicked",!1),App.popNotify(e,r,"default"),d.focusElement(r)}break;case 27:return l(t(this),e),!1}}));return r.on("blur",(function(e){!function(e){s(r,e)}(e)})),r.select()}},r.select={icon:"fa-th-list",getEditVal:function(e){if(e.data("input")){var t=e.data("input").selectpicker("val");return null===t&&this.multiple&&(t=[]),t}},loadPreviewPanel(a,n,i,l){let s=t.Deferred();return a.html('<div class="center"><i class="fa fa-spinner fa-spin"></i></div>'),this.pcTable.model.loadPreviewHtml(n,i,l).then((function(n){if(a){let i=t("<div>");n.previews.forEach((function(a){let n=t('<div class="preview">');switch(a[2]){case"file":e.imgRand=e.imgRand||Math.random(),Array.isArray(a[1])&&a[1].forEach((function(a){-1!==["jpg","png"].indexOf(a.ext)&&n.append(t('<a href="/fls/'+a.file+'" target="_blank">').html('<img src="/fls/'+a.file+"_thumb.jpg?rand="+e.imgRand+'"/><br/>')),n.append(t('<a href="/fls/'+a.file+'" target="_blank">').text(a.name+" "+Math.round(a.size/1024).toLocaleString(App.langLocale)+" Kb"))}));break;case"html":n.text(a[0]);break;case"text":n.text(App.textWithLinks(a[1]));break;case"currency":case"number":if("currency"===a[2])try{n.text(parseFloat(a[1]).toLocaleString(App.lang.locale))}catch(e){n.text(a[1])}else n.text(a[1]);a[3].unitType&&n.append(" "+a[3].unitType);break;case"url":n=t("<div>").append(t('<a target="_blank">').text(a[1]).attr("href",a[1]));break;default:n=t("<div>").text(a[1])}i.append(t('<div class="title">').text(a[0])),i.append(n)})),0===n.previews.length&&i.text(App.translate("Element preview is empty")),a.empty().append(i)}s.resolve()})).fail((function(){s.reject()})),s},previewPanel:function(e,a){let n=t('<div id="selectPanel" class="text preview" style="white-space: pre-wrap; height: 200px;">'),i={};i="column"===this.category?e.data("id")?this.pcTable._getItemById(e.data("id")):this.pcTable._insertItem:this.pcTable.data_params,a.popover({html:!0,content:n,trigger:"manual",container:"body",placement:"auto right",animation:!1}).popover("show");let l=t("#"+a.attr("aria-describedby")).css("z-index",1e4);const s=function(){a.attr("aria-describedby")&&l.length&&(a.off(".preview"),l.off(".preview"),l.remove())};a.on("mouseout.preview",(function(){setTimeout((function(){l&&!l.is(":hover")&&s()}),300)})),l.on("mouseout.preview",(function(){l.is(":hover")||!a||a.is(":hover")||s()})),a.one("remove destroy",(function(){a.attr("aria-describedby")&&a.popover("destroy")})),this.loadPreviewPanel(n,e.data("field"),i,e.data("val")).then((function(){const e=function(){a&&!a.height()?s():setTimeout(e,500)};e()}))},getEditElement:function(a,n,i,l,s,o,r,d,c){"use strict";n||(n={}),n=t.extend(!0,{},n);let p,f,h,u=this,m=n.v||null;if(u.multiple&&"string"==typeof m)try{m=JSON.parse(m)}catch(e){m=[]}a&&a.data("input")?(f=a,p=f.data("input"),p.data("is-rendered",!0),h=p.data("LISTs")):(f=t("<div>"),h={isListForLoad:!0,innerList:[],innerIndexed:[],isSliced:!0,isPreview:!1},u.list&&(h=u.list));let b=[];f.on("remove",()=>{b.forEach(e=>{e.jqXHR&&e.jqXHR.abort?e.jqXHR.abort():e.aborted=!0})});let g=function(e){let a=t.Deferred(),n={};Object.keys(i).forEach((function(e){/^\$/.test(e)||("id"===e?n[e]=i[e]:e===u.name?n[e]=m:null!==i[e]&&"object"==typeof i[e]&&-1!==Object.keys(i[e]).indexOf("v")?n[e]=i[e].v:n[e]=i[e])})),f.isAttached()&&f.append('<i class="fa fa-cog fa-spin fa-3x loading" style="position: absolute; z-index: 1    right: 1px;    top: 1px;    font-size: 8px;"/>');let l={};return b.push(l),u.pcTable.model.getEditSelect(n,u.name,e,null,null,l).then((function(t){f.find(".loading").remove(),h.innerList=t.list?t.list:[],h.innerIndexed=t.indexed?t.indexed:{},h.isSliced=t.sliced,h.isPreview=t.previewdata,u.codeSelectIndividual||null!==e&&""!==e&&void 0!==e||h.isSliced||(u.list=h,h.isListForLoad=!1),a.resolve()}),(function(){a.reject()})),a.promise()};setTimeout((function(){f.length&&f.isAttached()&&f.find(".mark-loading").length&&f.find(".mark-loading").html('<i class="fa fa-spinner"></i>')}),200);let w=0;const v=function(){i[u.name]&&i[u.name].replaceViewValue&&h.innerIndexed[i[u.name].v]&&(i[u.name].replaceViewValue(h.innerIndexed[i[u.name].v]),delete i[u.name].replaceViewValue);let t=f.closest("body");if(t&&t.length){let n=t.get(0).ownerDocument==document?e.$:e.top.$;const d=function(e,t){let a={[App.translate("Selected")]:n('<optgroup label="'+App.translate("Selected")+'">'),"":n('<optgroup label="">')},l=a[App.translate("Selected")];const s=function(e,t,a,l){l=l?n('<small class="text-muted">').text(l):"";let s=n("<option>").attr("value",e),o=n("<div>").text(null===t||""===t?"["+e+"]":t);if(l&&o.append(l),o=o.html(),a)s.attr("data-content",'<span class="text" style="text-decoration: line-through">'+o+"</span>");else{let t=n('<span class="text" >'+o+"</span>");h.isPreview&&(t.addClass("select-with-preview"),t.attr("data-id",i.id),t.attr("data-field",u.name),t.attr("data-val",e)),s.data("content",t.get(0).outerHTML)}return s};let o=function(){return!0};if(t&&""!==t){let[e]=App.lang.search_prepare_function(t);e=e.split(" "),o=function(t){let a="";return null!==t&&([a]=App.lang.search_prepare_function(t.toString())),!e.some((function(e){return-1===a.indexOf(e)}))}}let r,d={};if(e||"filter"===u.category){const t=function(e){null===e&&(e="");let t,a=h.innerIndexed[e];return t=a?s(e,a[0],!1,a[1]):s(e,e,!0,null),l.append(t),d[e]=1,!!a&&(o(a[0])||t.addClass("hidden"),!0)};u.multiple?Array.isArray(e)?(e.forEach(t),r=Object.keys(d)):void 0!==e&&(t(e),r=[e]):(t(e),r=e)}if("onlyVals"!==t){u.multiple||u.withEmptyVal&&""!==u.withEmptyVal.trim()&&"filter"!==u.category&&a[""].append(n("<option>").data("content",u.withEmptyVal).text(""));for(let e in h.innerList){let t=h.innerList[e];if(1===d[t])continue;let i=h.innerIndexed[t];if(!h.isSliced&&!o(i[0]))continue;let l=s(t,i[0]),r=i[1]?i[1]:"";a[r]||(a[r]=n('<optgroup label="'+r+'">')),a[r].append(l)}}if(p.empty(),Object.keys(a).forEach((function(e){p.append(a[e])})),!0===h.isSliced){let e=s(0,App.translate("The data is incomplete. Use the search!"));e.prop("disabled",!0),e.css("text-align","center"),p.append(e)}return p.selectpicker("refresh"),p.selectpicker("val",r),r};if(!a||!a.data("input")){let e=!1;const t=function(){let t="-----";return"filter"===u.category?(t=App.translate("Empty"),u.selectFilterWithEmptyText&&(t=u.selectFilterWithEmptyText)):u.withEmptyVal&&""!==u.withEmptyVal.trim()?t=u.withEmptyVal:u.multiple&&c&&c.closest(".InsertPanel").length&&(t=App.translate("Select"),e=!0),t};p=n('<select class="form-control" '+(1==u.multiple?"multiple ":"")+' data-size="auto" style="display: none;" name="cell_insert" data-style="btn-sm btn-default" data-width="css-width" data-live-search="true" data-title="'+t()+'">').width(u.width),e&&p.attr("data-selected-text-format","static"),f.append(p),f.append('<div class="text-center mark-loading"></div>'),r&&p.attr("tabindex",r),p.data("AppUin",App.getUn()),f.data("input",p),p.data("LISTs",h)}f.find(".mark-loading").remove();let b=0===p.closest(".modal-body").length?u.pcTable._container:p.closest(".modal-body");if(p.data("container",b),d(m),!p.data("is-rendered")){let t;p.data("selectpicker").$searchbox.off().on("click.dropdown.data-api focus.dropdown.data-api touchend.dropdown.data-api",(function(e){e.stopPropagation()}));let a="";p.data("selectpicker").$searchbox.on("keyup",(function(e){if("Escape"===e.key)return p.data("selectpicker").$button.click(),!0;let i=n(this).val();a!==i&&(a=i,t&&clearTimeout(t),t=setTimeout((function(){h.isListForLoad||h.isSliced?g.call(u,i).then((function(){d.call(u,m,i)})):d.call(u,m,i)}),750))}));let i=n(u).closest("td, .cell");if(0===p.closest(".InsertRow, .InsertPanel").length){let e=p.data("container");p.on("remove",(function(){e.off("click.selectContainer."+p.data("AppUin")),e.off("keydown.selectContainer."+p.data("AppUin"))})),e.on("click.selectContainer."+p.data("AppUin"),(function(e){let t=n(e.target);t.closest("td").is(".editing")||t.closest(".bootstrap-select").length||o(f,e)})),e.on("keydown.selectContainer."+p.data("AppUin"),(function(e){if("Tab"===e.key)return l(f,e),!1;if(27===e.keyCode)return p.data("keyPressed","Esc"),s(f,e),!1;if(13===e.keyCode&&p.data("enterPressed",!0),9!==e.keyCode&&16!==e.keyCode&&i.data("edited"),e.altKey||e.shiftKey){let t=e.altKey?"altKey":!!e.shiftKey&&"shiftKey";p.data("keyPressed",t)}})).on("keyup",(function(e){p.removeData("keyPressed"),p.removeData("enterPressed")})),setTimeout((function(){if(p.data("selectpicker").$bsContainer.offset().top>f.find("button").offset().top){let e=p.closest("td").find(".cdiv").data("bs.popover");e.applyPlacement(e.getCalculatedOffset("top",e.getPosition(),e.$tip.width()+8,e.$tip.height()+33),"top"),e.$tip.removeClass("bottom").addClass("top")}}),10)}else if(1===p.closest(".InsertRow").length){p.data("container").on("keydown.selectContainer."+p.data("AppUin"),(function(e){if("Tab"===e.key)return(p.data("selectpicker").$newElement.get(0).contains(e.originalEvent.target)||p.data("selectpicker").$menu.get(0).contains(e.originalEvent.target))&&(p.data("selectpicker").$menu.is(".open")&&p.selectpicker("toggle"),l(f,e)),!1})),p.data("selectpicker").$newElement.on("keydown",e=>{"Tab"===e.code&&(l(f,event),e.stopPropagation())})}p.on("hidden.bs.select",(function(){let e=p.data("changed"),t={},a=p.data("keyPressed");a&&(t[a]=!0),u.multiple?e&&0===p.closest("td.edt").length&&l(f,t):setTimeout((function(){l(f,t)}),200),p.data("changed",!1)})),p.on("show.bs.select",(function(){d(m)})),p.on("shown.bs.select",(function(){let t=p.data("selectpicker");t.$bsContainer.addClass("pcTable-selectpicker"),h.isPreview&&t.$bsContainer.addClass("select-with-preview"),t.$menuInner.height()<100&&t.$menuInner.find("li").length>6&&t.$menuInner.height(300);let a=t.$menu.get(0).getBoundingClientRect();if(a.right>e.innerWidth-20){let n=a.right-e.innerWidth+20,i=t.$menuInner.width();t.$menuInner.width(i-n).css("overflow-x","scroll")}else t.$menuInner.width("auto");t.cropped||(t.cropped=!0,p.data("container").is(".pcTable-container")&&t.$menuInner.height(t.$menuInner.height()-4))})),p.on("changed.bs.select",(function(){p.data("changed",!0);let e=[];if(m&&m.forEach&&m.forEach((function(t){e.push(t)})),m=p.val(),"filter"===u.category&&u.multiple){let t=m.length;if(e.length>m.length)0===m.length&&m.push("*NONE*");else{let t;m.some((function(a){if(-1===e.indexOf(a))return t=a,!0})),-1!==["*NONE*","*ALL*"].indexOf(t)?m=[t]:["*NONE*","*ALL*"].some((function(e){let t;if(-1!==(t=m.indexOf(e)))return m.splice(t,1),!0}))}m.length!==t&&p.selectpicker("val",m)}})),p.on("remove",(function(){p.data("selectpicker").$bsContainer.remove(),p.data("container").off("keydown.selectContainer."+p.data("AppUin")).off("click.selectContainer."+p.data("AppUin"))})),0===p.closest(".InsertRow, .InsertPanel").length&&f.find("button").click()}}else w<50&&(setTimeout((function(){v(p,m)}),10*w+1),w++)};return!h||h.isListForLoad?g().then((function(){v.call(u)})):v(),f},getEditPanelText:function(e,t){if(this.multiple)return this.getPanelText(e.v,null,t)},getPanelText:function(e,a,n){let i=this,l=t("<div>"),s=n[i.name].v_;if(!i.multiple&&n[i.name].v_&&(s=[n[i.name].v_]),s)t.each(s,(function(e,a){"use strict";let o=t('<div class="select-val">').text(a[0]+(i.multiple&&i.unitType?" "+i.unitType:""));if(a[1]?o.addClass("deleted_value"):1!==s.length&&o.add("select-item"),i.withPreview&&1!==s.length){let a=t('<button class="btn btn-xxs btn-default "><i class="fa fa-eye"></i></button>').on("click",()=>{if(a.data("opened"))a.data("pr").hide(),a.data("opened",!1);else{if(a.data("pr"))a.data("pr").show();else{let l=t('<div class="loaded-preview">').appendTo(o);i.loadPreviewPanel(l,i.name,n,[n[i.name].v[e]]).then((function(){})),a.data("pr",l)}a.data("opened",!0)}});o.prepend(a)}l.append(o)}));else{if(null===e||""===e)return i.withEmptyVal?i.withEmptyVal:"";let a=e;if(i.multiple||(a=[a]),a||(a=[]),i.list){let e=[];for(let t=0;t<a.length;t++)e[t]=a[t].toString();for(let a=0;a<i.list.length;a++){let n=i.list[a];if(-1!==e.indexOf(n[2].toString())){let a=t("<span>").text(n[0]);n[1]?a.addClass("deleted_value"):1!==e.length&&a.add("select-item"),l.append(a)}}}}return l.children()},getCellText:function(e,a,n){let i=this,l=t("<div>"),s=n[i.name].v_;if(!i.multiple&&n[i.name].v_&&(s=[n[i.name].v_]),s)i.multiple&&s.length>1&&0==i.multySelectView?l.append('<span class="select-item">'+App.translate("%s elements",s.length)+"<span>"):0===s.length?l.append('<span class="select-item">'+this.getElementString(null)+"</span>"):t.each(s,(function(a,n){"use strict";let o=t("<span>"),r=null;e&&(r="object"==typeof e?e[a]:e),o.text(i.getElementString(r,n)),n[1]?o.addClass("deleted_value"):1!==s.length&&o.add("select-item"),l.append(o)}));else{if(null===e||""===e)return i.withEmptyVal?i.withEmptyVal:"";let a=e;if(i.multiple||(a=[a]),a||(a=[]),i.list){let e=[];for(let t=0;t<a.length;t++)e[t]=a[t].toString();for(let a=0;a<i.list.length;a++){let n=i.list[a];if(-1!==e.indexOf(n[2].toString())){let a=t("<span>").text(i.getElementString(n[2],n));n[1]?a.addClass("deleted_value"):1!==e.length&&a.add("select-item"),l.append(a)}}}}return l.children()},focusElement:function(e){let t=e.find("button"),a=this;0==t.length?setTimeout((function(){a.focusElement(e)}),50):t.focus(),e.closest("tr").is(".InsertRow")&&(this.pcTable._insertRow.find(".active").removeClass("active"),e.closest("td").addClass("active"))},isDataModified:function(e,t){return(-1===[null,""].indexOf(e)||-1===[null,""].indexOf(t))&&(-1!==[null,""].indexOf(e)||-1!==[null,""].indexOf(t)||!Object.equals(t,e))},checkEditRegExp:function(e){if(!this.warningEditRegExp)return!0;try{return this.multiple&&Array.isArray(e)?e.some(t=>new RegExp(this.warningEditRegExp).test(e)):new RegExp(this.warningEditRegExp).test(e)}catch(e){return!0}},addDataToFilter:function(e,t){const a=function(t){let a,n=t[0],i=App.translate("Empty");null===n||""===n?a="".hashCode():(a=n.toString().hashCode(),i=n.replace(/"/g,"&quot;")),e[a]=i};this.multiple?t&&t.v_.length?t.v_.forEach((function(e){a(e)})):a({0:""}):a(t.v_)},getElementString:function(e,t){"use strict";let a;return null==e&&(t&&t[0]||(a=this.withEmptyVal||"")),void 0!==a||null!==t[0]&&""!==t[0]||(a="["+(this.withEmptyVal||"")+"]"),void 0===a&&(a=t[0]),this.multiple&&this.unitType&&(a+=" "+this.unitType),a},sourceButtonClick:function(a,n){let i=t.Deferred(),l={},s=this,o=this.pcTable;t.each(a,(function(e,t){"$"!==e.substring(0,1)&&(l[e]=t)})),n&&(l[s.name]=null);let r,d=0;return t(e.top.document.body).on("pctable-opened.select-"+s.name,(function(){d++})).on("pctable-closed.select-"+s.name,(function(e,a){d--,a&&a.json&&(r=a);let n=a&&"insert"===a.method&&a.json&&a.json.chdata&&a.json.chdata.rows;setTimeout((function(){(0===d||n)&&(t("body").off(".select-"+s.name),i.resolve(r))}),100)})),o.model.selectSourceTableAction(s.name,l),i}},function(){t.jstree;r.tree={icon:"fa-tree",FullView:!1,getEditVal:function(e){return e.data("val")},getEditElement:function(a,n,i,l,s,o,r,d){let c,p,f,h=this,u=a||t("<div>"),m=u.data("dialog")||t("<div>").css("min-height",200);u.data("dialog",m),n=n.v||"";const b=function(e,t,a){let n=[];m.data("jstree").jstree("get_selected",!0).forEach((function(e){n.push(e.id)})),h.multiple||(n=n[0]||""),u.data("val",n),a||(l(u,{}),e.close())};let g=function(e){h.treePanel.call(h,m,i,n)};c=[];let w={label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:b},v={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){s(u,{}),e.close()}},_="<b>"+this.title+"</b>"+this.pcTable._getRowTitleByMainField(i," (%s)"),y="ctrlS.commentdialog";const x=function(e){h.pcTable.isMobile||(e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:.8*t("body").width()>800?800:.8*t("body").width()})),0===e.$modalBody.find("textarea").length&&g(),e.$modalContent.closest("body").on(y,(function(t){b(e,0,!1)}))};if(d){let a=!1;setTimeout((function(){let n=u.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each((function(){p=t(this);let e={};e.label=p.data("name"),e.cssClass=p.attr("class").replace("btn-sm","btn-m"),e.icon=p.find("i").attr("class"),e.save=p.data("save"),e.click=p.data("click"),e.action=function(t){e.save&&b(t,0,!0),e.click({}),a=!0,t.close()},c.push(e)})),n.popover("destroy")):(c.push(w),c.push(v)),h.pcTable.isMobile?App.mobilePanel(_,m,{buttons:c,onhide:function(e){t("body").off(y),a||o(u,{})},onshow:x}):(f=e.top.BootstrapDialog.show({message:m,type:null,title:_,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:c,onhide:function(n){t(e.top.document).find("body").off(y),a||o(u,{})},onshown:function(a){a.$modalContent.position({of:t(e.top.document).find("body"),my:"top+50px",at:"top"})},onshow:x}),u.data("Dialog",f))}),1),u.text(App.translate("Editing in the form")).addClass("edit-in-form")}else{let a=!1;u.off().on("click keydown",(function(n){if(a)return!1;if("Tab"===n.key)return void o(m,n,null,!0);a=!0;let i=c.slice(0);i.push(w),i.push(v);var l=t(this).closest("div");h.pcTable.isMobile?App.mobilePanel(_,m,{buttons:i,onhide:function(e){a=!1,t("body").off(y),s(l,e)},onshow:x}):e.top.BootstrapDialog.show({message:m,type:null,cssClass:"fieldparams-edit-panel",title:_,draggable:!0,size:BootstrapDialog.SIZE_WIDE,buttons:i,onhide:function(n){a=!1,t(e.top.document).find("body").off(y),s(l,n)},onshow:x})})),0===u.find("button").length&&(p=t('<button class="btn btn-default btn-sm text-edit-button">').text(App.translate("Editing in the form")),r&&p.attr("tabindex",r),u.append(p))}return u.data("val",n)},treePanel:function(e,a){let n=this,i=t.extend(!0,{},a),l=["themes","json_data","search"];n.multiple&&l.push("checkbox");let s=t('<div class="tree-search"><input class="form-control" type="text"></div>'),o=s.find("input");setTimeout(()=>{o.focus()},200);let r=t("<div></div>"),d=0,c=!1,p="";o.keyup((function(){c&&clearTimeout(c),c=setTimeout((function(){if(r.closest("body").length){let e=o.val();p!==e&&(p=e,r.jstree(!0).search(e,0===d))}}),750)})),e.html(s).append(r),e.data("jstree",r),!this.multiple&&this.withEmptyVal&&r.on("click",'li.jstree-node[aria-selected="true"]',(function(e){return r.jstree(!0).deselect_node(t(this)),!1}));let f=null;r.on("init.jstree",(function(e,a){if(a.instance.settings.checkbox.cascade="",n.changeSelectTable||n.multiple){let e=r.jstree(!0).redraw_node,a=r.jstree(!0);const l=(e,t)=>{let n=a.get_node(e);t>0?(a.select_node(n),2===t&&(!1===n.state.loaded?a.load_node(n,e=>{e.children.forEach(e=>{l(e,t)})}):n.children.forEach(e=>{l(e,t)}))):(a.deselect_node(n),!1===n.state.loaded?a.load_node(n,e=>{e.children.forEach(e=>{l(e,t)})}):n.children.forEach(e=>{l(e,t)}))};r.jstree(!0).redraw_node=function(a,s,o,d){let c,p=e.apply(this,arguments),h=this.get_node(a),u=n.changeSelectTable,m=2===n.changeSelectTable&&n.parentName;n.treeAutoTree||(h.original.id.toString().match(/^\d+$/)?m=!1:u=!1);const b=function(){r.jstree(!0).refresh(!1,!0)};let g=t(p).find(">a i:first");if(n.multiple&&(!1===h.state.loaded||h.children&&h.children.length)&&(c=t('<i class="fa fa-hand-lizard-o jstree-children-manage-lizard"></i>'),g.after(c),g=c.on("click",()=>(h.state.cascadeStep=h.state.cascadeStep>1?0:(h.state.cascadeStep||0)+1,!1===h.state.loaded?this.load_node(h,e=>{e.children.forEach(t=>{l(t,e.state.cascadeStep)})}):h.children.forEach(e=>{l(e,h.state.cascadeStep)}),!1))),u&&(c=t('<i class="fa fa-edit edit-tree-icon"></i>'),g.after(c),c.on("click",()=>(new EditPanel(n.selectTable,null,{id:h.id}).then(()=>{f={},Object.values(r.jstree(!0)._model.data).forEach(e=>{f[e.id]=!!e.state.opened}),b()}),!1)),g=c),m){let e=t('<i class="fa fa-plus edit-tree-icon"></i>');g.after(e),e.on("click",()=>(new EditPanel(n.selectTable,null,{[n.parentName]:{v:h.id.replace("PP/","")}}).then(e=>{if(f={},Object.values(r.jstree(!0)._model.data).forEach(e=>{f[e.id]=!!e.state.opened}),f[h.id]=!0,e.chdata.rows&&Object.keys(e.chdata.rows).length){let t=Object.keys(e.chdata.rows)[0];n.multiply?i[n.name].v.push(t):i[n.name].v=t}b()}),!1))}return p}}})).jstree({search:{show_only_matches:!0,case_insensitive:!0,show_only_matches_children:!0,search_callback:function(e,t){if(!t)return!1;let a=e.toLowerCase(),n=t.text.toLowerCase();return[n,a]=App.lang.search_prepare_function(n,a),a=a.split(" "),!a.some((function(e){return-1===n.indexOf(e)}))},ajax:function(e,t){var a=this;n.getEditSelect(i,e,null).then((function(e){t.call(a,e[0])}))}},massload:function(e,t){var a=this;d-=1,n.getEditSelect(i,"",e).then((function(e){Object.values(e[0]).forEach((function(e){e.forEach((function(e){!0===e.children&&(d+=1)}))})),t.call(a,e[0])}))},core:{check_callback:!0,open_parents:!0,data:function(e,t){var a=this;d-=1,n.getEditSelect(i,"","#"==e.id?null:e.id).then((function(e){e[0].forEach((function(e){f&&f[e.id]&&(e.state={opened:!0,...e.state||{}},!0===e.children&&(d+=1))})),t.call(a,e[0])}))},themes:{icons:!1,name:"default"}},plugins:l}),n.multiple&&"filter"===n.category&&r.on("select_node.jstree",(function(e,t){-1!==["*ALL*","*NONE*"].indexOf(t.node.id)?t.selected.length>1&&t.selected.forEach((function(e){e!==t.node.id&&t.instance.deselect_node(r.jstree(!0).get_node(e))})):["*ALL*","*NONE*"].forEach((function(e){-1!==t.selected.indexOf(e)&&t.instance.deselect_node(r.jstree(!0).get_node(e))}))}))},getEditPanelText(e,t){return this.getCellText(e.v,null,t)},getEditSelect:function(e,a,n){let i=this,l=t.Deferred(),s={};return Object.keys(e).forEach((function(t){/^\$/.test(t)||("id"===t||null===e[t]||"object"!=typeof e[t]||-1===Object.keys(e[t]).indexOf("v")?s[t]=e[t]:s[t]=e[t].v)})),this.pcTable.model.getEditSelect(s,this.name,a,n,!0).then((function(e){let t=[e.list,e.indexed];i.codeSelectIndividual||(i.list=t),i.parentName=e.parent,l.resolve(t)})),l},getPanelText:function(e,t,a){this.FullView=!0;let n=this.getCellText(e,t,a);return delete this.FullView,n},getCellText:function(e,a,n){let i=this;if("tree"===i.name&&n.__tree&&("self"===i.treeViewType||n.tree_category&&n.tree_category.v)){let e=n.__tree,a=n.tree.f||{},l=a.icon||(e.opened?"folder-open":"folder"),s=t('<i class="fa fa-'+l+'"></i>').data("treeRow",e.v),o=t('<span class="tree-view">').css("padding-left",22*e.level).append(s);return!1!==a.expand?(s.addClass("treeRow"),i.pcTable._treeFolderRowAddDropdown(o,n.__tree)):s.css("margin-right",8),"self"===this.treeViewType&&this.pcTable.isInsertable()&&o.append(t('<button class="btn btn-default btn-xxs treeRow ins"><i class="fa fa-plus"></i></button>')),o.append(a.text||e.t),o}{let a=n[i.name].v_;if(e){if(i.multiple){if(Array.isArray(e)){if(0===e.length)return i.getElementSpan(null);if(1===e.length)return i.getElementSpan(e[0],a[0]);if("0"!==i.multySelectView||i.FullView){let n=t('<span class="select-item">');return e.forEach((e,t)=>n.append(i.getElementSpan(e,a[t]))),n}return t('<span class="select-item">'+App.translate("%s el.",e.length)+"<span>")}return i.getElementSpan(e,[e,0])}return i.getElementSpan(e,a)}return i.getElementString(null)}},checkIsFiltered:function(e,t){let a,n;return this.multiple?(a=[],e&&e.v_&&e.v_.length&&e.v_.forEach((function(e){a.push(e[0].hashCode().toString())})),n=function(e){if(-1!==a.indexOf(e))return!0}):(a=null===e.v_[0]?"null":e.v_[0].toString(),a=a.hashCode().toString(),n=function(e){if(e===a)return!0}),t.some(n)},addDataToFilter:function(e,t){const a=function(t){let a;a=null===t[0]?"null".hashCode():t[0].toString().hashCode(),e[a]=t[0].replace(/"/g,"&quot;")};this.multiple?t&&t.v_.length&&t.v_.forEach((function(e){a(e)})):a(t.v_)},getElementSpan:function(e,a){let n=t("<span>");return null!==e&&(n.text(this.getElementString(e,a)),1===a[1]&&n.addClass("deleted_value")),n},getElementString:function(e,t){"use strict";return null!=e||t&&t[0]?null===t[0]||""===t[0]?"["+(this.withEmptyVal||"")+"]":this.FullView&&t[2]||t[0]:this.withEmptyVal||""}}}(),r.json={__addInput:function(e,a,n){var i=(a=a||{}).type||typeof n[e],l=12;"checkbox"==i&&(l=3),a.width&&(l=a.width);var s,o=t('<div class="field form-group">').attr("data-name",e).addClass("col-sm-"+l);switch(i){case"string":s=t("<input>").val(n[e]?n[e]:a.default?a.default:"");break;case"json":s=t('<div class="JSONEditor">').height(300);var r=new JSONEditor(s.get(0),{}),d=t('<a href="#">editText</a>').on("click",(function(){var e=t("<div>"),a=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(r.get(),null,2)).appendTo(e);return e.dialog({title:App.translate("The JSON field content"),width:500,height:600,buttons:{[App.translate("Save")]:function(){r.setText(a.val()),e.dialog("close")},[App.translate("Close")]:function(){e.dialog("close")}}}),!1}));s.find(".jsoneditor-menu").append(d),s.data("editor",r),r.set(n[e]?n[e]:a.default?JSON.parse(a.default):{});break;case"html":s=t('<div class="HTMLEditor">').height(300);var c=t("<div>").appendTo(s);r=CodeMirror(c.get(0),{value:n[e]?n[e]:a.default?a.default:"",mode:"text/html",height:"250px",readOnly:!1,theme:"eclipse",lineNumbers:!0,gutter:!0,indentWithTabs:!0,autoCloseTags:!0});setTimeout((function(){r.refresh()}),20),s.data("editor",r);break;case"integer":s=t("<input>").val(n[e]?n[e]:a.default?a.default:"").attr("type","number"),void 0!==a.min&&s.attr("min",a.min),void 0!==a.max&&s.attr("max",a.max),void 0!==a.step&&s.attr("step",a.step);break;case"checkbox":s=t("<input>").attr("type","checkbox"),(n[e]||void 0===n[e])&&s.prop("checked",!0);break;case"select":s=t("<select>"),a.values&&t.each(a.values,(function(e,a){s.append(t("<option>").attr("value",e).text(a))})),n[e]?s.val(n[e]):void 0===n[e]&&a.default&&s.val(a.default)}"checkbox"==i?(o.prepend(t("<label>").text(a.title?a.title:e).addClass("form-check-label")),s&&(s.data("type",i),o.find("label").prepend(s))):(o.prepend(t("<label>").text(a.title?a.title:e)),s&&s.data("type",i).addClass("form-control"),o.append(s)),o.data("type",i);var p=t(" <span>*</span>");return a.required?p.addClass("text-danger"):(p.text(""),p.addClass("glyphicon glyphicon-remove remove"),p.on("click",(function(){var e=t(this).closest(".field");e.data("name");e.remove()}))),o.find("label").after(p),o},getEditElement:function(e,a,n,i,l,s){var o,r=this,d=t("<div>"),c=t("<div>").css("min-height",200),p=t('<div class="jsonForm row">').appendTo(c);d.data("form",p),d.data("field",this);var f=this.jsonFields,h=a||{};"string"==typeof h&&(h=JSON.parse(h));var u=function(e){var t=r.__addInput(e,f[e],h);p.append(t)},m=t.extend({},h),b=0,g={"":[]};if(t.each(f,(function(e,t){if(1==t.required||1==t.showInForm)u(e),void 0!==m[e]&&delete m[e];else if(void 0===m[e]){var a="";t.fGroup&&(a=t.fGroup,g[t.fGroup]||(g[t.fGroup]=[])),g[a].push(e),b++}})),t.each(m,(function(e,t){u(e)})),b){var w=t('<div class="row elseFields">');let e=t('<select class="selectpicker form-control dropup" data-size="5" data-title="--'+App.translate("Choose the field")+'--">');1==App.keys(g).length?t.each(g[App.keys(g)[0]],(function(a,n){e.append(t("<option>").attr("value",n).text(f[n].title?f[n].title:n))})):t.each(g,(function(a,n){a=t('<optgroup label="'+a+'">');t.each(n,(function(e,n){a.append(t("<option>").attr("value",n).text(f[n].title?f[n].title:n))})),e.append(a)})),w.prepend(t("<label>").text(App.translate("Add field"))),e.addClass("form-control"),w.append(e),e.selectpicker("render"),e.on("change",(function(){var a=t(this).val();e.find('option[value="'+a+'"]').remove(),u(a)})),c.append(w.wrap('<div style="padding:10px">').parent())}return o={[App.translate("Save")]:function(){var e={},a=p.find(".fullJSONEditor");1==a.length?e=a.data("editor").get():p.find("input, select, textarea, .JSONEditor, .HTMLEditor").not(".JSONEditor *").not(".HTMLEditor *").each((function(){var a=t(this),n=a.closest(".field").data("name");switch(a.closest(".field").data("type")){case"array":try{if(e[n]=a.data("editor").get(),!t.isArray(e[n]))throw App.translate("Field structure error")}catch(e){throw App.notify(App.translate("Field %s structure error",n)),App.translate("Field structure error")}break;case"object":case"json":try{if(e[n]=a.data("editor").get(),"object"!=typeof e[n])throw App.translate("Field structure error")}catch(e){throw App.notify(App.translate("Field %s structure error",n)),App.translate("Field structure error")}break;case"html":e[n]=a.data("editor").getValue();break;case"checkbox":case"boolean":e[n]=!!a.is(":checked");break;case"integer":e[n]=parseInt(a.val());break;default:e[n]=a.val()}})),d.data("val",JSON.stringify(e)),i(d,event),c.remove()},[App.translate("Close")]:function(){c.dialog("close")},[App.translate("Editor")]:function(){var e=p.height(),a=t('<div class="fullJSONEditor">').height(e+100),n=new JSONEditor(a.get(0),{});n.set(h);var i=t('<a href="#">editText</a>').on("click",(function(){var a=t("<div>"),i=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(n.get(),null,2)).appendTo(a);return a.dialog({title:App.translate("The JSON field content"),width:500,height:e+100,buttons:{[App.translate("Save")]:function(){n.setText(i.val()),a.dialog("close")},[App.translate("Close")]:function(){a.dialog("close")}}}),!1}));p.empty().append(a),p.next().empty(),a.data("editor",n),a.find(".jsoneditor-menu").append(i)}},n.id?(c.dialog({title:(n&&n.id?n.id:"")+" "+this.title,width:700,modal:!0,close:function(e){l(d,e),c.remove()},buttons:o}),d.text(App.translate("Editing in the form")).addClass("edit-in-form")):(d.on("focus click","button",(function(){var e=t(this).closest("div");c.dialog({title:r.title||r.name,width:700,modal:!0,close:function(t){l(e,t),c.remove()},buttons:o})})),d.append(t('<button class="btn btn-default">').text(a||App.translate("Editing")))),d.data("val",a)},getEditVal:function(e){return e.data("val")},getCellText:function(e){return JSON.stringify(e)},focusElement:function(e){var t=e.find("button"),a=this;0===t.length?setTimeout((function(){a.focusElement(e)}),50):t.focus()}},r.fieldParams=t.extend({},r.json,{icon:"fa-code",isPanelField:!0,isDataModified:function(e,t){return!Object.equals(t,e)},getEditVal:function(e){return e.data("checkVal")&&e.data("checkVal")(),e.data("val")},getEditElement:function(a,n,i,l,s,o,r,d,c){let p,f=this,h=t("<div>"),u=t("<div>").css("min-height",200),m=t('<div class="jsonForm">').appendTo(u);a&&(h=a,m=h.find(".jsonForm")),h.data("form",m),h.data("field",this);let b,g=!1,w=function(){m.trigger("change")};try{b=c.data("firstLoad").data_src.v}catch(e){}let v=function(e){let a,n,l=f.jsonFields;f.getValue(e,i,!d).then((function(e){let s=e.value;"string"==typeof s&&(s=JSON.parse(s));let o=t.extend({},s),r=function(e,s,r){let d=l.fieldSettings[e];if(!d)return!1;if(d.categories&&-1===d.categories.indexOf(i.category.v))return!1;if(d.names&&-1===d.names.indexOf(i.name.v))return!1;let c={};switch(void 0===o[e]||void 0===o[e].isOn?(c.isOn=void 0!==o[e],c.Val=o[e],void 0===c.Val&&(c.Val=d.default),d.parent||"checkbox"!==d.type||!0!==c.Val||(c.isOn=!0),o[e]=c):c=o[e],e){case"codeSelect":let e="=: selectRowListForTree(table: ''; field: ''; order: '' asc; where:  '' = ; parent: ''; disabled:)";"tree"===m.find('div[data-name="type"] select').val()?c.Val===d.default&&(c.Val=e):c.Val===e&&(c.Val=d.default)}let p=!1,h=(l.fieldSettings[d.parent],o[d.parent]);d.parent&&-1!==s.indexOf(d.parent)&&(h&&!0===h.isOnCheck||(p=!0)),c.changed=function(){"use strict";!0===this.isOnCheck?m.find('[data-parent="'+e.toLowerCase()+'"]').show():m.find('[data-parent="'+e.toLowerCase()+'"]').hide().find('input[type="checkbox"]').prop("checked",!1).trigger("change")};let u=f.__addInput.call(f,e,d,c,i,w);if("center"!==(d.align||"center")){if(!a){let e=t('<div class="fParams-grid">');a=t("<div>").appendTo(e),n=t("<div>").appendTo(e),m.append(e)}"left"===d.align?a.append(u):n.append(u)}else m.append(u),a=n=null;d.parent&&(u.attr("data-parent",d.parent.toLowerCase()),p&&u.hide());let b=r[e]();return u.css("padding-left",19*b),u},d="string";o.type&&(d=o.type.Val||o.type);!async function e(a){let n;m.empty(),("2"!==i.table_id.v||"data_src"!==i.name.v&&"data"!==i.name.v)&&(!i.table_name||"tables_vidgets"!==i.table_name.v||"data_src"!==i.name.v&&"data"!==i.name.v)?n=l.fieldListParams[a]:(n="data"===i.name.v?["width","showInWeb"]:["width","jsonFields","showInWeb","editable","insertable","required","logging","default","copyOnDuplicate"],a="fieldParams"),"chart"===a&&(f.pcTable.chartTypes||(f.pcTable.chartTypes=(await f.pcTable.model.getChartTypes()).chartTypes),l.fieldSettings.chartType.values={},f.pcTable.chartTypes.map(e=>{l.fieldSettings.chartType.values[e.type]=e.title}));let s={type:function(){return 0}};n.forEach((function(e){let t=l.fieldSettings[e];t.parent&&-1!==n.indexOf(t.parent)?s[e]=function(){return s[t.parent]()+1}:s[e]=function(){return 0}})),o.type={isOn:!0,Val:a},r("type",n,s).find("select").on("change",(function(){e(t(this).val())})),n.forEach((function(e){r(e,n,s)})),u.find(".codeEditor, .HTMLEditor").each((function(){t(this).data("editor")&&t(this).data("editor").refresh()}))}(d)}))};const _=function(e){if(e&&e.close||!d){var a={},n=m.find(".fullJSONEditor");1===n.length?a=n.data("editor").get():m.find("input, select, textarea, .JSONEditor, .HTMLEditor, .codeEditor").not(".JSONEditor *").not(".HTMLEditor *").not(".codeEditor *").not('input[data-type="switcher"]').each((function(){var e=t(this);let n,i=e.closest(".field");var l=i.data("name");switch(e.closest(".field").data("type")){case"code":n=e.data("editor").getValue();break;case"json":try{if(n=e.data("editor").get(),"object"!=typeof n)throw App.translate("Field structure error")}catch(e){throw App.notify(App.translate("Field %s structure error",l)),App.translate("Field structure error")}break;case"html":n=e.data("editor").getValue();break;case"checkbox":n=!!e.is(":checked");break;case"integer":n=parseInt(e.val());break;default:n=e.val()}let s;isOnCheckbox=i.find('input[data-type="switcher"]'),s=0===isOnCheckbox.length?e.is(":visible"):isOnCheckbox.is(":checked"),a[l]={isOn:s,Val:n}})),h.data("val",a),g=!0,e&&e.close&&(l(h,event),e.close())}};d||h.data("checkVal",_),p=[{label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:_},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];return d?(e.top.BootstrapDialog.show({message:u,type:BootstrapDialog.TYPE_DANGER,title:App.translate("Field <b>%s</b> parameters",i.title.v),buttons:p,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){g||s(h,e),t("body").off("ctrlS.FieldParams")},onshown:function(e){v(n.v),e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),t("body").on("ctrlS.FieldParams",(function(t){return setTimeout(()=>{_(e)},10),!1}))}}),h.text(App.translate("Editing in the form")).addClass("edit-in-form")):(v(n.v),h.append(m),h.addClass("fieldparams-edit-panel")),h.data("val",n.v).data("input",m)},__addInput:function(a,n,i,l,s){let o=this;var d=(n=n||{}).type;let c,p;c=i.Val,p=i.isOn;var f,h=t('<div class="field form-group">').attr("data-name",a);let u,m=t("<span>").text(n.title?n.title:a);switch(d){case"code":(f=t('<div class="codeEditor">')).data("editor",!0),setTimeout(()=>{var e=t("<div>").appendTo(f),a=CodeMirror(e.get(0),{value:c||(n.default?n.default:""),mode:"totum",height:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,gutter:!1,indentWithTabs:!0});a.on("blur",()=>{s()}),f.data("editor",a),a.getScrollerElement().style.minHeight="150px",a.table=l.table_name&&l.table_name.v?l.table_name.v:null});break;case"string":f=t("<input>").val(void 0!==c?c:n.default?n.default:"");break;case"json":f=t('<div class="JSONEditor">').height(500).on("blur",s);var b=new JSONEditor(f.get(0),{}),g=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">'+App.translate("Manually")+"</a>").on("click",(function(){var a=t("<div>"),n=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(b.get(),null,2)).appendTo(a);return BootstrapDialog.show({message:a,type:null,title:App.translate("Manually changing the json field"),buttons:[{label:App.translate("Save"),cssClass:"btn-m btn-warning",action:function(t){try{b.setText(n.val()),t.close()}catch(t){e.top.App.modal(App.translate("JSON format error"))}}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){},onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1}));if(f.find(".jsoneditor-menu").append(g),"chartOptions"===a){let e=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">'+App.translate("Fill in by the default settings")+"</a>");e.on("click",()=>{let e=t('div[data-name="chartType"] select').val();return o.pcTable.chartTypes.some(t=>{if(t.type==e)return b.setText(JSON.stringify(t.default_options)),!0}),!1}),f.find(".jsoneditor-menu").append(e)}f.data("editor",b);let i="string"==typeof c?JSON.parse(c):c;b.set(i);break;case"html":(f=t('<div class="HTMLEditor">')).data("editor",!0),setTimeout(()=>{var e=t("<div>").appendTo(f),a=CodeMirror(e.get(0),{value:c||(n.default?n.default:""),mode:"text/html",height:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0});a.on("blur",s),a.getScrollerElement().style.minHeight="150px",f.data("editor",a)});break;case"integer":f=t("<input>").val(void 0!==c?c:n.default?n.default:"").attr("type","number"),void 0!==n.min&&f.attr("min",n.min),void 0!==n.max&&f.attr("max",n.max),void 0!==n.step&&f.attr("step",n.step);break;case"checkbox":f=t("<input>").attr("type","checkbox").data("type",d),c&&f.prop("checked",!0);break;case"select":if(f=t("<select>"),n.values){let e,i=n.valIcons||{};n.valuesOrder&&(e=n.valuesOrder.slice(0)),"type"===a&&(l.table_name&&l.name&&"tables_fields"===l.table_name.v&&"data_src"===l.name.v&&(e=["fieldParams"]),t.each(e,(function(e,t){r[t]&&(i[t]="fa "+r[t].icon)})));const s=function(e,a){let n=t("<option>").attr("value",e).text(a);i[e]&&n.data("icon",i[e]),f.append(n)};e?e.forEach((function(e){s(e,n.values[e])})):t.each(n.values,s)}n.multiple&&(f.attr("multiple","multiple"),f.attr("size","2")),f.css("visibility","hidden"),f.outerHeight(34);let p=void 0===c&&n.default?n.default:c;setTimeout((function(){f.selectpicker(),f.css("visibility","visible")}),10),f.val(p)}return i.isOnCheck=!0,"checkbox"===d?(h.prepend(t('<label class="field-param-lable">').html(m).addClass("form-check-label").prepend(f).append('<a href="'+App.translate("PATH-TO-DOCUMENTATION")+"fields#fields-settings-"+a+'" target="_blank"><i class="fa fa-question-circle-o"></i></a>')),h.addClass("checkbox"),u=f,f.is(":checked")||(i.isOnCheck=!1,h.addClass("disabled"))):(h.prepend(t('<label class="field-param-lable">').html(m).append('<a href="'+App.translate("PATH-TO-DOCUMENTATION")+"fields#fields-settings-"+a+'" target="_blank"><i class="fa fa-question-circle-o"></i></a>')),f&&(f.data("type",d),f.data("editor")||(f.addClass("form-control"),f.on("change",s)),h.append(f)),!0!==n.required&&(u=t('<input type="checkbox" data-type="switcher"/>'),p?(i.isOnCheck=!0,u.prop("checked",!0)):(i.isOnCheck=!1,h.addClass("disabled")),h.find("label").prepend(u).addClass("switcheble"),h.addClass("checkbox"))),u&&u.on("change",(function(){t(this).is(":checked")?!0!==i.isOnCheck&&(i.isOnCheck=!0,h.removeClass("disabled"),i.changed(),t(this).closest("div").find(".codeEditor, .HTMLEditor").each((function(){t(this).data("editor")&&t(this).data("editor").refresh()}))):!1!==i.isOnCheck&&(i.isOnCheck=!1,h.addClass("disabled"),i.changed()),s()})),h.data("type",d),h},getValue:function(e,a,n){"use strict";if(n){let a=t.Deferred();return a.resolve({value:e||{}}),a}let i={fieldName:this.name};return a.id&&(i.rowId=a.id),this.pcTable.model.getValue(i,this.table_id)},getPanelText:function(e){return JSON.stringify(e,null,2)},getCellText:function(e){return App.translate("Field settings")}}),r.button={icon:"fa-hand-pointer-o",required:!1,getPanelText:function(e,t,a){let n=this.getCellText(e,t,a);return n.on("click",()=>(this.pcTable.selectedCells.empty(),this.pcTable.selectedCells.selectPanelDestroy(),this.pcTable._buttonClick(t,this,a),!1)),n.wrap("<div>"),n.parent()},getCellText:function(e,a,n){let i=this,l={};"column"===this.category?n.id?l=t.extend({},i.pcTable.f||{},n.f||{},n[i.name].f||{}):this.buttonActiveOnInsert?l=t.extend({},n[i.name].f||{}):(l.block=!0,n[i.name]&&n[i.name].f&&n[i.name].f.icon&&(l.icon=n[i.name].f.icon)):l=t.extend({},i.pcTable.f||{},n[i.name].f||{}),a&&a.addClass("cell-button");const s=e=>{if(i.td_style&&"function"==typeof i.td_style){let t=i.td_style(l).Button;t&&e.css(t)}else if(n.__td_style&&"function"==typeof n.__td_style){let t=n.__td_style(l);t.Button&&e.css(t.Button),t.td&&a.css(t.td)}else if(a&&a.is(".button-wrapper")){let n,i={};l.background&&(i.backgroundColor=l.background),l.color&&(i.color=l.color),e.css(i),this.pcTable.isMobile?(n=this.width>t("#table").width()-30?t("#table").width()-30:this.width,a.width(n),e.width(n)):(this.pcTable.rowButtonsCalcWidth(),n=this.width>this.pcTable.__$rowsButtons.width()-10?this.pcTable.__$rowsButtons.width()-10:this.width,a.width(n),e.width(n),20===n&&setTimeout(()=>{this.pcTable.rowButtonsCalcWidth(),n=this.width>this.pcTable.__$rowsButtons.width()-20?this.pcTable.__$rowsButtons.width()-20:this.width,a.width(n),e.width(n-16)},40))}else if(i.pcTable.isMobile&&"column"!==i.category){let t={};l.background&&(t.backgroundColor=l.background),l.color&&(t.color=l.color),e.css(t)}};if(l.block||!this.pcTable.control.editing&&!this.pressableOnOnlyRead){let e=t('<button class="btn btn-default btn-xxs button-field" tabindex="-1" disabled>').text(this.buttonText||"");if(s(e),l.text&&e.text(l.text),l.comment&&!a.is(".cell")){let a;a=t('<i class="cell-icon fa fa-info"></i>'),e.prepend(a),a.attr("title",l.comment)}else if(l.icon){let a=t('<i class="cell-icon fa fa-'+l.icon+'"></i>');e.prepend(a),""===e.text()&&(e.css("text-align","center"),a.css("float","none"))}return e}let o=t('<button class="btn btn-default btn-xxs button-field" tabindex="-1">').text(this.buttonText||"");if(s(o),l.text&&o.text(l.text),l.comment&&!a.is(".cell")){let e;e=t('<i class="cell-icon fa fa-info"></i>'),o.prepend(e),e.attr("title",l.comment)}else if(l.icon){let e=t('<i class="cell-icon fa fa-'+l.icon+'"></i>');o.prepend(e),""===o.text()&&(o.css("text-align","center"),e.css("float","none"))}return o},getEditElement:function(e,t,a,n,i,l,s){var o=this.getCellText(void 0,void 0,a);void 0!==s&&o.attr("tabindex",s);let r=!1;const d=e=>{if(r)return;r=!0;let t=o.html();o.html('<i class="fa fa-spinner"></i>'),this.pcTable.model.doAfterProcesses(()=>{this.pcTable.model.click({item:this.pcTable._insertRowHash,fieldName:this.name}).then(()=>{o.html(t),r=!1,n(o,e,!0)})})};return o.on("click",d).removeClass("btn-xxs").addClass("btn-sm text-edit-button").on("keydown",e=>{switch(e.key){case"Tab":n(o,e);break;case"Enter":n(o,d)}}),o},btnOK:function(e,t){let a=e.find("button.button-field"),n=this;a.text(App.translate("Done")),e.data("clicked",!0),setTimeout((function(){e.length&&e.removeData("clicked"),t&&a.replaceWith(n.getCellText.call(n,t[n.name],e,t))}),2e3)}},r.link={icon:"fa-link"},r.comments={icon:"far fa-comments-o",getEditVal:function(e){return e.data("val")},getCellText:function(e){let a=this;if(0===e.n||!e.n)return"";let n=t("<span>"),i=t('<span class="comments">').text(e.c[0]+" "+e.c[1]+": "+e.c[2]).appendTo(n);return e.notViewed&&(i.addClass("notViewed"),a.decorationColor&&i.css("border-bottom-color",a.decorationColor)),n},getValue:function(e,a,n){"use strict";let i=this,l=t.Deferred();if(n)e||(e=[]),l.resolve({value:e});else if(0===e.n||1===e.n&&!e.cuted&&!e.notViewed)e||(e=[]),l.resolve({value:[e.c]});else if(e.n>1&&!e.notViewed&&e.all)l.resolve({value:e.c});else{let e={fieldName:this.name};a.id&&(e.rowId=a.id),l=this.pcTable.model.getValue(e,this.table_id)}return l.then((function(e){if(a[i.name].v.notViewed||a[i.name].notViewed){let e=t.Deferred();e.then((function(){let e;delete a[i.name].v.notViewed,delete a[i.name].notViewed,a.id?e=i.pcTable._getTdByFieldName(i.name,i.pcTable.data[a.id].$tr):(e=i.pcTable._paramsBlock.find('td[data-field="'+i.name+'"]'),e.length||(e=i.pcTable._footersBlock.find('td[data-field="'+i.name+'"]'))),e&&e.length&&(e.find(".notViewed-num").remove(),e.find(".notViewed").removeClass("notViewed"))})),a[i.name].notViewed?i.pcTable.model.setCommentsViewed(a[i.name].v.length,i.name,a.id).then((function(){e.resolve()})):e.resolve()}})),l},getPanelText:function(e,a,n){let i=this,l=t.Deferred(),s=e||n[i.name];const o=function(e){let a=t('<div class="comments">');return t.each(e,(function(e,t){a.append(i.getCommentLine(t))})),setTimeout((function(){a.closest("td").scrollTop(a.height())}),100),a};return s.all?o(s.c):(this.getValue(s,n,!1).then((function(e){l.resolve(o(e.value))})).fail((function(){l.reject()})),l.promise())},getCommentLine:function(e){let a=t('<div class="comments-line">');return a.append(t('<span class="com_dt">').text(e[0])),a.append(" "),a.append(t('<span class="com_author">').text(e[1])),a.append(" "),a.append(t('<span class="com_text">').html(App.textWithLinks(e[2]))),a},getPanelVal:(e,t)=>e,getEditElement:function(a,n,i,l,s,o,r,d){let c,p=this,f=a||t("<div>"),h=f.data("dialog")||t("<div>").css("min-height",200);f.data("dialog",h),n=n.v||"";let u=function(e){p.getValue.call(p,n,i,!d).then((function(e){let a=t('<textarea type="text" style="height:90px;resize: vertical" class="form-control"/>');"object"==typeof e.value?t.each(e.value,(function(e,t){h.append(p.getCommentLine(t))})):e.value?a.val(e.value):f.data("val")&&a.val(f.data("val")),h.append(t('<div class="comments-input">').append(a)),h.data("input",a),a.focus()}))};const m=function(e,t,a){let n=h.find("textarea").val().trim();f.data("val",n),a||(l(f,{}),e.close())};c=[];let b={label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:m},g={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){s(f,{}),e.close()}},w=App.translate("Comments of field")+" <b>"+this.title+"</b>"+this.pcTable._getRowTitleByMainField(i," (%s)"),v="ctrlS.commentdialog",_=!1;if(d)setTimeout((function(){let a=f.closest("td").find(".cdiv");if(a.length>0?(a.data("bs.popover").options.content.find(".btn").each((function(){let e=t(this),a={};a.label=e.data("name"),a.cssClass=e.attr("class").replace("btn-sm","btn-m"),a.icon=e.find("i").attr("class"),a.save=e.data("save"),a.click=e.data("click"),a.action=function(e){a.save&&m(e,0,!0),a.click({}),_=!0,e.close()},c.push(a)})),a.popover("destroy")):(c.push(b),c.push(g)),p.pcTable.isMobile)App.mobilePanel(w,h,{buttons:c,onhide:function(e){t("body").off(v),_||o(f,{})},onshown:function(e){u()},onshow:function(e){t("body").on(v,(function(t){m(e,0,!1)}))}});else{e.top.BootstrapDialog.show({message:h,type:null,title:w,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:c,onhide:function(a){t(e.top.document).find("body").off(v),_||o(f,{})},onshown:function(a){a.$modalContent.position({of:t(e.top.document).find("body"),my:"top+50px",at:"top"}),u()},onshow:function(a){a.$modalHeader.css("cursor","pointer"),a.$modalContent.css({width:900}),t(e.top.document).find("body").on(v,(function(e){m(a,0,!1)}))}})}f.data("Dialog",Dialog)}),1),f.text(App.translate("Editing in the form")).addClass("edit-in-form");else{let a=!1;if(f.off().on("click keydown",(function(n){if(a)return!1;if("Tab"===n.key)return void o(h,n,null,!0);a=!0;let i=c.slice(0);i.push(b),i.push(g);var l=t(this).closest("div");p.pcTable.isMobile?App.mobilePanel(w,h,{buttons:i,onhide:function(e){a=!1,t("body").off(v),s(l,e)},onshown:function(e){0===e.$modalBody.find("textarea").length&&u(),t("body").on(v,(function(t){m(e,0,!1)}))}}):e.top.BootstrapDialog.show({message:h,type:null,cssClass:"fieldparams-edit-panel",title:w,draggable:!0,size:BootstrapDialog.SIZE_WIDE,buttons:i,onhide:function(n){a=!1,t(e.top.document).find("body").off(v),s(l,n)},onshown:function(a){a.$modalHeader.css("cursor","pointer"),0===a.$modalBody.find("textarea").length&&u(),a.$modalContent.css({width:900}),t(e.top.document).find("body").on(v,(function(e){m(a,0,!1)}))}})})),0===f.find("button").length){let e=t('<button class="btn btn-default btn-sm text-edit-button">').text(App.translate("Add comment"));r&&e.attr("tabindex",r),f.append(e)}}return f.data("val",null)},getCellTextInPanel:function(e,t,a,n){return this.getEditPanelText({v:e},a,n)},getEditPanelText:function(e,a,n){if(e){if(e.v.forEach){let a=t("<div>");return e.v.forEach((function(e){a.append(t("<div>").append(t('<span class="date">').text(e[0])).append(t('<span class="user">').text(e[1])).append(t('<span class="text">').text(e[2])))})),a.children()}{let a=t("<div>");return n[this.name]&&n[this.name].v&&n[this.name].v.forEach&&n[this.name].v.forEach((function(e){a.append(t("<div>").append(t('<span class="date">').text(e[0])).append(t('<span class="user">').text(e[1])).append(t('<span class="text">').text(e[2])))})),a.append(t('<div class="new-comment">').text(e.v)),a.children()}}},getValPreview(e){return this.getCellText({c:e[e.length-1],n:e.length})}},r.chart={icon:"fa-bar-chart",getCellText:function(e,a,n){let i=t("<div>");return n[this.name].ch&&this.loadChart(()=>{this.chartSimple(i,n[this.name].ch)}),i},async loadChart(a){if(e.ChartLoaded)e.ChartLoaded.then(a);else{let n,i;e.ChartLoaded=new Promise((e,t)=>{n=e,i=t}),e.ChartLoaded.then(a),t.getScript("/js/lib/chart.js").then(()=>{n()})}},chartSimple:function(a,n){let i=t('<canvas class="ttm-chart"></canvas>');a.html(i);let l={},s={...this.chartOptions};"column"===this.category||this.column?(i.attr("height","23"),l.layout={padding:{left:5,right:5,top:2,bottom:2}},l.scales={yAxes:[{display:!1}],xAxes:[{display:!1}]}):this.f&&this.f.height&&i.attr("height",this.f.height),e.innerWidth<("false"!==(localStorage.getItem("TreeMinimizer")||"false")?600:800)&&(l.layout={...s.layout,padding:{left:5,right:5,top:2,bottom:2}},l.scales={},s.scales&&s.scales.yAxes?l.scales.yAxes=s.scales.yAxes.map(e=>({...e,display:!1})):l.scales.yAxes=[{display:!1}],s.scales&&s.scales.xAxes?l.scales.xAxes=s.scales.xAxes.map(e=>({...e,display:!1})):l.scales.xAxes=[{display:!1}],l.aspectRatio=s.aspectRatioMobile||(s.aspectRatio||2)/1.6);let o=i.get(0).getContext("2d"),r=s.type||"line";delete s.type;let d=n.values.map(()=>new Object);s.data&&s.data.datasets&&(d=s.data.datasets),n.datasets&&(d=n.datasets);let c=s.data||{};c.datasets=d,n.labels&&(c.labels=n.labels),delete s.data,d.forEach((e,t)=>{e.data=n.values[t]}),new Chart(o,{type:r,data:c,options:{...s,...l}}),this.pcTable._container.getNiceScroll&&this.pcTable._container.getNiceScroll().resize(),i.on("contextmenu",()=>!1),i.on("dblclick",()=>{e.top.BootstrapDialog.show({message:"<canvas></canvas>",draggable:!0,title:this.pcTable.__getCellTitle(this),cssClass:"dialog-chart-topper",onshown:e=>{new Chart(e.$modalBody.find("canvas").get(0).getContext("2d"),{type:r,data:c,options:s})}})})}},t.each(r,(function(e,a){r[e]=t.extend({},d,a)})),App.pcTableMain=function(n,i){if(this.data_params=i.params||null,i=t.extend({},{tableRow:{},nSorted:!0,isCreatorView:!1,withCsvButtons:!1,withCsvEditButtons:!1,noDataRowClass:"pcTable-noDataRow",contanerClass:"pcTable-container",tableClass:"pcTable-table",width:null,isTreeView:!1,treeReloadRows:[],tree:[],treeIndex:{},treeSort:[],checkIsUpdated:0,_containerId:"",scrollWrapper:null,tableWidth:0,control:{adding:!1,sorting:!1,deleting:!1,duplicating:!1},dataSorted:[],data:[],dataSortedVisible:[],mainFieldName:"id",insertRow:null,_container:null,_content:null,openedPanels:{},extraClastersBottom:null,extraClastersTop:null,dataSortedClasters:{t:[],m:[],b:[]},ScrollClasterized:null,_innerContainer:null,_header:null,_table:null,LogButton:null,model:null,fields:{},hidedFields:[],fieldCategories:{column:[],params:[],footer:[]},sorted:{field:"",direction:"asc"},_sorting:{},_filterable:!1,filtersClearButton:null,_indexes:{fieldByName:{}},beforeSpaceHide:!0},i),t.extend(this,i,!0),screen.width<=a&&(this.isCreatorView=!1,this.isMobile=!0),this.isCreatorView){if(0===t("#isCreator").length){let a=t('<span id="isCreator" class="btn btn-sm"><i class="fa-user-circle fa"></i></span>'),n=a;this.isMobile||localStorage.getItem("notCreator")?(n.addClass("btn-warning"),t(".plus-top-branch").hide()):n.addClass("btn-danger"),n.on("click",()=>{localStorage.getItem("notCreator")?localStorage.removeItem("notCreator"):localStorage.setItem("notCreator",!0),e.location.reload(!0)}),t("#docs-link").before(a)}(this.isMobile||localStorage.getItem("notCreator"))&&(this.isCreatorView=!1)}if(this.isCreatorView||Object.keys(this.fields).forEach(e=>{this.fields[e].webRoles&&1===this.fields[e].webRoles.length&&1===parseInt(this.fields[e].webRoles[0])&&delete this.fields[e]}),this.hidden_fields=this.hidden_fields||{},0===this.hidden_fields.length&&(this.hidden_fields={}),App.isTopWindow()&&(this.beforeSpaceHide=!1),n){this.refreshArraysFieldCategories(!0);let e=t(n);e.data("pctable",this),this._container=e,this.isCreatorView||this._container.addClass("worker-view"),this._containerId=this._container.attr("id"),this._containerId||(this._containerId="pcTable"+o++,this._container.attr("id",this._containerId)),this._init(),this.render(i.addVars),this.applyHideRows(this.f.hideRows,this.f.showRows)}else this.initForPanel(i);return this.model.addPcTable(this),this};let c=0;e.EditPanel=function(a,n,i,l,s={}){if(e.top!==e)return e.top.EditPanel.call(e.top,a,n,i,l,s);let o=t.extend(!0,{},i),r=this;r.pcTable=a,r.panelId="panel"+c++;let d=2===a||"object"==typeof a&&2===a.tableRow.id,p={},f=!1;this.closed=!1;let h=t.Deferred();this.$panel=t('<div class="InsertPanel">'),this.isNewPanel=!0,this.blockedFields={},this.bootstrapPanel=null;let u=o.id?"checkEditRow":"checkInsertRow",m=o.id?"saveEditRow":"add";this.panelType=o.id?"edit":"insert",this.editItem=o||{},t("body").trigger("pctable-opened",{type:"panel"}),r.resolved=!1,r.error={};let b,g={},w={};this.checkRow=async function(e,a,n){let i=this;const l=()=>new Promise((function(l,s){r.pcTable.model[u](i.getDataForPost(e),b,n).then((function(e){"edit"==r.panelType&&a&&(g=t.extend(!0,{},e.row)),b=b||e.hash,r.editRow.call(r,e),l(r),f=!1})).fail(s)}));return r.beforeSave&&!a&&(e=await r.beforeSave(e)),l()},this.saveRow=function(a,n){let i=this.getDataForPost();const l=()=>{r.pcTable.model[m]("insert"===this.panelType?b:i).then((function(a){if(d){let e=t("#table").data("pctable");e&&e.tableRow.id==r.editItem.table_id.v&&i.data_src&&i.data_src.v&&i.data_src.v.width&&e.setColumnWidth(r.editItem.name.v,i.data_src.v.width.Val)}h.resolve(a),r.resolved=!0,t(e.top.document.body).trigger("pctable-closed",{type:"panel",json:a,method:r.panelType,tableId:r.pcTable.tableRow.id}),r.bootstrapPanel.close()})).fail((function(){if(n.length&&n.isAttached()){a.$modal.find(".btn-save").prop("disabled",!1)}}))};d&&"insert"===this.panelType&&f?this.checkRow({}).then(l):l()},this.refresh=()=>{this.closed||("edit"===r.panelType?r.pcTable.model[u]({id:o.id}).then(e=>{Object.keys(e.row).forEach(t=>{1!==r.pcTable.tableRow.id||"panels_view"!==t||Object.equals(g[t],e.row[t])?g[t]=e.row[t]:g[t]={}}),r.pcTable.model[u](this.getDataForPost("manual")).then((function(e){r.editRow.call(r,e)}))}):r.pcTable.model[u](this.getDataForPost("manual"),b).then((function(e){Object.keys(e.row).forEach(t=>{g[t]=e.row[t]}),r.editRow.call(r,e)})))},this.editRow=function(e){"use strict";let a=!1;r.pcTable.f=e.f||{},r.editItem.f=e.row.f||{};let i=this.$panel.find(">div:first"),l=this.$panel.find(">div:eq(2)"),o=this.$panel.find(">div:eq(3)"),c=[],f=0,h=0,u=0;const m=function(e){return-1!==["text","comments","file","listRow"].indexOf(e.type)||e.multiple?1.5:1};if(i.length||(r.pcTable.fieldCategories.panel_fields.forEach((function(a,n){if("n"===a.name)return;let i=t.extend({},r.pcTable.f||{},r.editItem.f||{},e.row[a.name].f||{});i.hide&&i.hide.extpanel||(f+=m(a),u++)})),f/=2,i=t("<div>").appendTo(this.$panel),c.column1=i,d?(l=t("<div>").appendTo(this.$panel),o=t("<div>").appendTo(this.$panel),c.column2=l,c.column3=o):u>6?(l=t("<div>").appendTo(this.$panel),c.column2=l):this.$panel.css("grid-template-columns","minmax(0, 1fr)")),r.pcTable.fieldCategories.panel_fields.forEach((function(n,o){let u=r.$panel.find('div.cell[data-field-name="'+n.name+'"]'),b=r.editItem[n.name];r.editItem[n.name]=e.row[n.name],r.isEditable(n)&&(a=!0);let v=t.extend({},r.pcTable.f||{},r.editItem.f||{},r.editItem[n.name].f||{});if(v.hide&&v.hide.extpanel)return;if(u.length)u.data("input")&&!v.block?(!b||n.isDataModified(r.editItem[n.name].v,b.v)||n.codeSelectIndividual||"insert"==r.panelType&&n.code&&!n.codeOnlyInAdd||"fieldParams"===n.type||n.name in w)&&r.createCell.call(r,u,n,o,v):r.createCell.call(r,u,n,o,v);else{let e=t('<div class="cell-wrapper" style="position: relative">');n.panelColor?e.css("background-color",n.panelColor):n.webRoles&&1===n.webRoles.length&&"1"===n.webRoles[0].toString()&&e.addClass("admin-see");let a=t("<label>").text(n.title).prependTo(e);n.unitType&&a.text(a.text()+", "+n.unitType);let s=t('<div class="btns pull-right">').prependTo(e),p=m(n);if(e.attr("data-koeff",p),"fieldParams"===n.type)this.$panel.append(e),e.width("100%"),e.attr("data-name",n.name),e.css({"grid-column-start":1,"grid-column-end":4}),u=r.createCell.call(r,u,n,o,v,e);else{let t;if(d)if(0===o)this.$panel.prepend(e.css({"grid-column-start":1,"grid-column-end":4}));else{let e=Math.floor((o+1)/2);7===o&&(e=3),t=c["column"+e]}else t=h<f&&h+p>f||h+p<=f?i:l.length?l:i;t&&t.append(e),h+=p,u=r.createCell.call(r,u,n,o,v,e)}if(setTimeout(()=>{let t=e.find(".btns").width();t>0&&(t+=3),a.css("max-width","calc(100% -  "+t+"px)")},2),n.linkToSelectTable&&e.append('<div class="source-link"><a href="'+n.linkToSelectTable.link+'" style="font-size: 12px" target="_blank">'+n.linkToSelectTable.title+"</a></div>"),n.help){let e=t('<button class="btn btn-sm btn-default"><i class="fa fa-info"></i></button>').on("click",()=>{App.notify(n.help,n.title)});s.prepend(e)}}let _=u.parent().find(".btns"),y=_.find(".backgroundButton");if(v.background?(y.length||(y=t('<button class="backgroundButton btn btn-sm btn-default">').appendTo(_)),y.css("background-color",v.background)):y.length&&y.remove(),v.hide&&v.hide.panel?u.parent().css("display","none"):u.parent().css("display",""),u.attr("data-field-name",n.name),u.attr("data-field-type",n.type),"edit"===r.panelType){let e,a=r.editItem[n.name].v;if(e="fieldParams"===n.type||Object.equals(g[n.name].v,a),e&&g[n.name].h==r.editItem[n.name].h?u.parent().removeClass("edited"):"comments"===n.type?"string"==typeof r.editItem[n.name].v&&r.editItem[n.name].v.length?u.parent().addClass("edited"):u.parent().removeClass("edited"):u.parent().addClass("edited"),n.code&&!n.codeOnlyInAdd){let e=u.parent().find(".btns button.handled");e.length||(e=t('<button class="btn btn-sm btn-default handled" tabindex="'+(2*o+2)+'"></button>'),u.parent().find(".btns").prepend(e),r.isEditable(n)?(e.on("click",(function(){!0===r.editItem[n.name].h?r.editItem[n.name].h=!1:r.editItem[n.name].h=!0,p[n.name]=!0,r.checkRow()})),e.prop("disabled",!1)):(e.prop("disabled","disabled"),r.editItem[n.name].h||e.remove())),e.removeClass("btn-warning").addClass("btn-default"),e.html('<i class="fa fa-hand-grab-o"></i>'),r.editItem[n.name].h&&(e.addClass("btn-warning").removeClass("btn-default"),-1!==Object.keys(r.editItem[n.name]).indexOf("c")&&r.editItem[n.name].c!==r.editItem[n.name].v&&e.html('<i class="fa fa-hand-paper-o"></i>'))}}else if(n.code&&!n.codeOnlyInAdd){let e=u.parent().find(".btns"),a=e.find(".handled");s[n.name]&&r.editItem[n.name].h?0===a.length&&(a=t('<button class="btn btn-sm btn-warning handled" tabindex="'+(2*o+2)+'"><i class="fa fa-hand-paper-o pull-right"></button>').on("click",()=>{delete s[n.name],r.checkRow(void 0,void 0,n.name)}),e.prepend(a)):1===a.length&&a.remove()}}),r),r.isNewPanel){let t="";if("edit"===this.panelType){let n;switch(r.pcTable.tableRow.id){case 1:if(r.pcTable.tableRow.main_field&&r.pcTable.fields[r.pcTable.tableRow.main_field]){let t=r.pcTable.tableRow.main_field;n=r.editItem[t]||e.row[t],n&&(n=n.v),n=' "'+n+'"'}n=n?"id "+(r.editItem.id||e.row.id)+" "+n:"id "+(r.editItem.id||e.row.id),t=!r.pcTable.control.editing||e.row.f.block&&!a?App.translate("Viewing table settings")+": <b> "+n+"</b>":App.translate("Editing table settings")+": <b> "+n+"</b>";break;case 2:if(r.pcTable.tableRow.main_field&&r.pcTable.fields[r.pcTable.tableRow.main_field]){let t=r.pcTable.tableRow.main_field;n=r.editItem[t]||e.row[t],n&&(n=n.v),n=' "'+n+'"'}n=n?"id "+(r.editItem.id||e.row.id)+" "+n:"id "+(r.editItem.id||e.row.id),t=!r.pcTable.control.editing||e.row.f.block&&!a?App.translate("Viewing table field")+": "+r.editItem.table_name.v+"<b> "+n+"</b>":App.translate("Editing table field")+": "+r.editItem.table_name.v+" <b> "+n+"</b>";break;default:if(r.pcTable.tableRow.main_field&&r.pcTable.fields[r.pcTable.tableRow.main_field]){let t=r.pcTable.tableRow.main_field;n=r.editItem[t]||e.row[t],n&&(n=n.v),n=' "'+n+'"'}n=n?"id "+(r.editItem.id||e.row.id)+" "+n:"id "+(r.editItem.id||e.row.id),t=!r.pcTable.control.editing||e.row.f.block&&!a?App.translate("Viewing <b>%s</b> from table <b>%s</b>",[n,r.pcTable.tableRow.title]):App.translate("Editing <b>%s</b> from table <b>%s</b>",[n,r.pcTable.tableRow.title])}}else switch(r.pcTable.tableRow.id){case 1:t=App.translate("Adding table");break;case 2:t=App.translate("Adding field");break;default:t=App.translate("Adding row to table")+" <b>"+r.pcTable.tableRow.title+"</b>"}r.cleateBootstrapPanel.call(r,t,n,"insert"===r.type||a,u<7?"one-column-panel":""),r.isNewPanel=!1}},this.cleateBootstrapPanel=function(n,i,s,o){let p,f=this,u=[];s&&(p=function(e,a){"use strict";if(Object.keys(r.error).length){let e=Object.keys(r.error)[0],a=r.error[e];return App.notify(a,t("<div>"+App.translate("Error in %s field",t("<span>").text(r.pcTable.fields[e].title).html())+" </div>").append()),!1}let n=e.$modal.find(".btn-save").prop("disabled","disabled");r.beforeSave&&r.beforeSave(),setTimeout((function(){r.pcTable.model.doAfterProcesses((function(){f.saveRow.call(f,e,n)}))}),250)},u.push({action:p,cssClass:"btn-warning btn-save",label:App.translate("Save")+" Alt+S"}));const m=()=>{this.closed=!0,void 0!==this.mainPanelId&&a.editPanels&&a.editPanels.splice(this.mainPanelId,1)};l?(f.close=function(){h.resolve(void 0,!0),t(e.top.document.body).trigger("pctable-closed",{type:"panel"}),r.resolved=!0,f.bootstrapPanel.close()},u.push({action:f.close,label:null,icon:"fa fa-"+(!0===l?"arrow-right":"times"),cssClass:"btn-m btn-default btn-empty-with-icon"})):(f.close=function(){f.bootstrapPanel.close()},u.push({action:f.close,label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon"}));let b="ctrlS.EditPanel"+c;f.bootstrapPanel=BootstrapDialog.show({type:i||null,size:BootstrapDialog.SIZE_WIDE,message:f.$panel,cssClass:"edit-row-panel "+(d?"edit-field-panel":o||""),title:n,buttons:u,draggable:!0,onhidden:function(){t("body").off(b),h.resolve(),r.resolved||t(e.top.document.body).trigger("pctable-closed",{type:"panel"}),t(e.top.document.body).off("."+r.panelId),m()},onshown:function(e){"use strict";p&&t("body").on(b,(function(a){t(".bootstrap-dialog").length>0&&(t(document.activeElement).blur(),p(e))})),e.indexedButtons[Object.keys(e.indexedButtons)[0]].attr("tabindex",500),2===Object.keys(e.indexedButtons).length&&e.indexedButtons[Object.keys(e.indexedButtons)[1]].attr("tabindex",501)}}),f.bootstrapPanel.$modalFooter.find(".btn-save").length&&(f.saveButton=f.bootstrapPanel.$modalFooter.find(".btn-save"))},this.createCell=function(a,n,i,l,o){let c=r.editItem||{};c[n.name]=c[n.name]||{},a.removeClass("error"),0===a.length?(a=t("<div data-name='"+n.name+"' class='cell'>").appendTo(o),n.code&&a.addClass("with-code")):o=a.parent();let h=o.find(".btns");if(h.find(".select-btns").remove(),this.isEditable(n)&&"button"!==n.type){r.blockedFields[n.name]=!1;let o=async function(e){let t;try{t=n.getEditVal(e),a.removeClass("error"),delete r.error[n.name]}catch(t){if("name"===n.name&&d){return delete s.name,(await r.checkRow(void 0,void 0,"name")).editItem.name.v}return r.error[n.name]=t,a.addClass("error"),App.popNotify(t,e,"default"),null}return t},c=!1,u=(a.find("input,button").is(":focus"),async function(e,t,a){c=!0;let l=await o(e);if(null===l)Object.keys(r.error).length||r.FocusIt.call(r,i);else if(a||r.FocusIt.call(r,i+1),n.isDataModified(l,r.editItem[n.name].v)){let e={};if(e[n.name]={v:l},n.code&&!n.codeOnlyInAdd&&(e[n.name].h=!0),n.code&&"insert"===r.panelType&&(s[n.name]=!0),d)switch(n.name){case"table_id":delete s.version}r.checkRow(e),p[n.name]=!0}c=!1}),m=function(e,t){return setTimeout((function(){e&&e.length&&e.isAttached()&&(c?c=!1:u(e,t,!0))}),40),!1},b=function(e,t){u(e,t)};a.data("firstLoad",g);let w,v=n.getEditElement(a.data("input"),r.editItem[n.name],r.editItem,u,b,m,50+i,!1,a);if(l&&l.placeholder&&n.addPlaceholder&&n.addPlaceholder(v,l.placeholder),d&&"fieldParams"===n.type&&("insert"===this.panelType&&v.find(".jsonForm").on("change",()=>f=!0),r.beforeSave=async function(e){let t=await o(v);if(r.editItem[n.name]={v:t},e)return e[n.name]={v:t},e}),v.isAttached()||a.html(v),a.data("input",v),"select"===n.type&&n.changeSelectTable){let i=function(){let i=r.getDataForPost(),l=t(this).is(".source-add");l&&(i[n.name]=null);let s=0;t(e.top.document.body).on("pctable-opened.select-"+r.panelId,(function(){s++})).on("pctable-closed.select-"+r.panelId,(function(e,i){s--;let o=i&&"insert"===i.method&&i.json&&i.json.chdata&&i.json.chdata.rows;setTimeout((function(){if(0===s||o){let e=v;delete n.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),o&&(n.multiple?r.editItem[n.name].v.push(Object.keys(i.json.chdata.rows)[0]):r.editItem[n.name].v=Object.keys(i.json.chdata.rows)[0]),e.replaceWith(v=n.getEditElement(null,r.editItem[n.name],r.editItem,u,b,m)),a.data("input",v),r.checkRow(),!l&&r.pcTable.isMain&&r.pcTable.model.refresh((function(e){r.pcTable.table_modify.call(r.pcTable,e)})),t("body").off(".select-"+r.panelId)}}),100)})),r.pcTable.model.selectSourceTableAction(n.name,i)},l=t('<span class="select-btns">').appendTo(h),s=t('<button class="btn btn-default-primary btn-sm"><i class="fa fa-edit"></i></button>');if(l.append(s),s.on("click",i),2===n.changeSelectTable){let e=t('<button class="btn btn-default-primary btn-sm source-add"><i class="fa fa-plus"></i></button>');l.append(e),e.on("click",i)}}if(n.getEditPanelText&&(w=n.getEditPanelText(r.editItem[n.name],r.editItem,g))){let e=a.find(".ttm--panel-data");e.length||(e=t('<div class="ttm--panel-data"/>').prependTo(a)),e.html(w),"comments"===n.type&&setTimeout(()=>{e.scrollTop(2e4)})}l.text&&a.append(t('<div class="format-text">').text(l.text)),l.comment&&a.append(t('<div class="format-comment">').text(l.comment).prepend('<i class="fa fa-info"></i>'))}else{r.blockedFields[n.name]=!0;let e=t('<div class="'+("button"===n.type?"link":"")+' ttm--panel-data">');if("button"!==n.type&&l.text?e.text(l.text):(r.editItem[n.name].v||"button"===n.type)&&e.append(n.getCellTextInPanel(r.editItem[n.name].v,a,r.editItem,g)),"button"!==n.type?l.icon&&e.prepend('<i class="cell-icon fa fa-'+l.icon+'"></i>'):e.find("button").is(":disabled")||a.data("input",e.find("button")),n.unitType&&e.append(" "+n.unitType),"button"===n.type&&r.pcTable){let t=!1,i=e.find("button");a.off().on("click",()=>{if(t)return;t=!0;let e=i.html();i.html('<i class="fa fa-spinner"></i>'),"insert"===this.panelType?this.pcTable.model.doAfterProcesses(()=>{this.pcTable.model.click({item:b,fieldName:n.name}).then(()=>{i.html(e),t=!1,this.refresh()})}):r.pcTable._buttonClick(a,n,c).then(()=>{n.closeIframeAfterClick?r.close():(i.html(e),t=!1,this.refresh())})})}else n.CodeActionOnClick&&!o.find(".edit-btn").length&&o.append(t('<button class="btn btn-sm btn-default edit-btn" style="width: 100%"><i class="fa fa-hand-pointer-o"></i></button>').on("click",()=>{r.pcTable.model.dblClick(c.id,n.name).then(e=>{})}));l.comment&&e.append(t('<div class="format-comment">').text(l.comment).prepend('<i class="cell-icon fa fa-info"></i>')),a.html(e).data("input",null)}let u="select"===n.type&&n.withPreview&&r.editItem[n.name].v&&(!n.multiple||1===r.editItem[n.name].v.length);if((n.formatInPanel||u)&&r.editItem.id){a.find(".format-panel").remove();let e=t('<div class="format-panel">').appendTo(a),i=t('<a href=""></a>').html(App.translate("Open context data")).appendTo(e);const l=()=>{let a=t('<div class="panelView">').appendTo(e);if(u){let e=t('<div class="select-val">').appendTo(a);if(n.formatInPanel){let a=t("<div>").appendTo(e);n.pcTable.model.getPanelFormats(n.name,c.id||b).then(e=>{n.getPanelFormats(a,e.panelFormats)})}let i=t('<div class="previews loaded-preview">').appendTo(e);n.loadPreviewPanel(i,n.name,c,r.editItem[n.name].v).then((function(){}))}else n.pcTable.model.getPanelFormats(n.name,c.id||b).then(e=>{n.getPanelFormats(a,e.panelFormats)});i.html(App.translate("Close context data")),w[n.name]=1};n.name in w&&l(),i.on("click",()=>(0===e.find(".panelView").length?l():(i.html(App.translate("Open context data")),e.find(".panelView").remove(),delete w[n.name]),!1))}return a},this.getDataForPost=function(e={}){if(this.readOnly)return r.editItem.id;let t={};return r.editItem.id&&(t.id=r.editItem.id),r.pcTable.fieldCategories.panel_fields.forEach((function(a){let n;"insert"===r.panelType?"manual"!==e&&a.name in e&&(n=e[a.name]||r.editItem[a.name]):"manual"===e?a.name in p&&(n=r.editItem[a.name]):n=e[a.name]||r.editItem[a.name],n?("comments"==a.type&&"string"!=typeof n.v&&(n.v=null),r.isEditable(a)&&(t[a.name]={},"edit"===r.panelType?(t[a.name].v=n.v,a.code&&!a.codeOnlyInAdd&&(t[a.name].h=n.h||!1),t[a.name].v=a.getPanelVal.call(a,t[a.name].v,r.$panel.find('div.cell[data-field-name="'+a.name+'"]').data("input"))):(t[a.name]=n.v,t[a.name]=a.getPanelVal.call(a,t[a.name],r.$panel.find('div.cell[data-field-name="'+a.name+'"]').data("input"))))):"insert"===r.panelType&&!b&&i[a.name]&&(t[a.name]=i[a.name].v)})),t},this.isEditable=function(e){if(!r.pcTable.control.editing)return!1;return!0!==t.extend({},r.pcTable.f||{},r.editItem.f||{},r.editItem[e.name].f||{}).block&&("insert"===this.panelType?e.insertable:e.editable)},this.FocusIt=function(e){return!1};const v=()=>{r.refresh()},_=e=>{let a=t("#table").data("pctable");if(a&&a.tableRow.id===e.tableRow.id&&a.tableRow.cycle_id===e.tableRow.cycle_id&&(a.editPanels||(a.editPanels=[]),a.editPanels.push(this),this.mainPanelId=a.editPanels.length-1),a!==e&&(e.isPanel=!0,r.pcTable.model.refresh=()=>{r.refresh()}),!e.control.editing){if(!o.id)return App.notify(App.translate("Adding to the table is forbidden")),!1;r.readOnly=!0,u="viewRow"}return!0};return"object"!=typeof r.pcTable?App.getPcTableById(r.pcTable).then((function(e){r.pcTable=e,e._refreshContentTable=v,r.checkRow({},!0),r.editItem.id&&e.model.setLoadedTableData({[r.editItem.id]:{}}),_(e)})):r.pcTable[0]?App.getPcTableById(r.pcTable[0],{sess_hash:r.pcTable[1]}).then((function(e){r.pcTable[2]&&e.model.setLoadedTableData(r.pcTable[2]),r.pcTable=e,e._refreshContentTable=v,_(e)&&r.checkRow({},!0)})):_(a)&&r.checkRow({},!0),h.promise()},function(){let a,n=!1;t.extend(App.pcTableMain.prototype,{switchContainerNideScroll:function(e){let t=this;t.isAnonim||(a&&clearTimeout(a),a=setTimeout(()=>{e!==n&&(e?t._container.niceScroll({cursorwidth:7,mousescrollstep:90,scrollspeed:50,autohidemode:!1,enablekeyboard:!1,cursoropacitymin:1,railoffset:{left:-3},cursorcolor:"#e1e0df"}):t._container.getNiceScroll().remove(),n=e)},100))},addScrollsRules:function(){let e=this;this._innerContainer.append(this._table),e.isMobile||(this._innerContainer.on("scroll",(function(){"use strict";e._removeEditCell()})),e.withoutScrolls||t((function(){e.switchContainerNideScroll(!0)})))},Scroll:function(){let a,n=this,i={};i.table=void 0,i.topButton=void 0;let l=!1,s=0,o=function(){let e=r();l!=(l=i.getClusterNum(e))&&i.insertToDOM(l);let a=t("table.pcTable-table");a.find("thead").height()+a.offset().top-t("#table").offset().top<=0?i.table?i.table.css({top:parseInt(t("#table").offset().top)-parseInt(t(".innerContainer").offset().top)}):function(){if(!i.table){i.table=t('<table class="scroll-head-row">').appendTo(n._innerContainer),i.table.width(n.tableWidth),i.table.append(t("table.pcTable-table thead").clone(!0)).attr("class",t("table.pcTable-table").attr("class")),i.table.find("th:not(.id) div, th:not(.id) .btn").remove(),i.table.find('th.id .pcTable-filters button[data-action="checkbox"]').remove(),i.table.find("th").removeClass("with-filter");let e=t('<div class="btn btn-default btn-xxs "><i class="fa fa-arrow-up"></i></div>').on("click",(function(){n._container.scrollTop(n._container.find(".pcTable-rowsWrapper").offset().top-n.scrollWrapper.offset().top)}));if(i.table.find("th.id .pcTable-filters:first").append(e),i.table.find("th.n").length){let e=n._innerContainer.find("th.n").find("i.fa-save").parent().clone(!0);i.table.find("th.n").append(t('<div class="pcTable-filters">').append(e))}n.isMobile||i.topButton||(i.topButton=t('<button class="scroll-top-button"><i class="fa fa-arrow-up"></i></button>').appendTo(n._innerContainer).on("click",(function(){n._container.scrollTop(n._container.find(".pcTable-rowsWrapper").offset().top-n.scrollWrapper.offset().top)})))}i.table.css({position:"absolute",top:parseInt(t("#table").offset().top)-parseInt(t(".innerContainer").offset().top)})}():i.table&&(i.table.remove(),i.table=void 0,i.topButton&&(i.topButton.remove(),i.topButton=void 0),n._content.off("scroll"))},r=function(){try{if(n.isAnonim){let e=t(document).scrollTop()-n._content.offset().top;return e<0?0:-e}return n._content.offset().top}catch(e){return 0}};a=n.isAnonim?t(document):n._container,a.on("scroll",(function(){clearTimeout(s),s=setTimeout((function(){o.call(n)}),50)}));let d={top_offset:0,bottom_offset:0,rows:t()};return t.extend(i,{rows_in_block:4,item_height:35,emptyCache:function(){d={}},getClusterNum:function(e){let t;return t=e>=0?0:Math.floor(-e/this.block_height),Math.max(t,0)},reloadScrollHead:function(){i.table&&(i.table.remove(),i.table=void 0),o.call(n)},generate:function(e){let t,a,i,l,s,o=n.dataSortedVisible,r=o.length;if(r<this.rows_in_block)return{top_offset:0,bottom_offset:0,rows:o};do{t=Math.max(this.rows_in_block*e,0),a=t+this.rows_in_cluster+3*this.rows_in_block,i=Math.max(t*this.item_height,0),l=Math.max((r-a)*this.item_height,0),s=[];for(let e=t;e<a;e++)o[e]&&s.push(o[e])}while(e>0&&0===s.length&&--e>-1);return{top_offset:i,conteinerHeight:n._content.height(),i_start:t,bottom_offset:l,cluster_num:e,rows:s}},getRowsHeight:function(){0!==n.dataSortedVisible.length&&(this.block_height=this.item_height*this.rows_in_block,this.rows_in_cluster=Math.floor((e.innerHeight-n._container.offset().top)/this.item_height))},insertToDOM:function(e,t,a){if(n.isMobile)this.setHtml(n.dataSortedVisible,0,0,a);else{this.rows_in_cluster||this.getRowsHeight(),e||(e=this.getClusterNum(r()));let i=this.generate(e),l=i.rows.map(e=>"object"==typeof e?e.row?e.row.id:e.id||e.v:e).join(",");(a||this.checkChanges("data",l,d))&&this.setHtml(i.rows,i.top_offset,i.bottom_offset,a),t&&n._container.getNiceScroll&&n._container.getNiceScroll().resize(),n._content.trigger("scrolled")}},setHtml:function(e,a,i,l){n._content.find(".editing").each((function(e){n._removeEditing.call(n,e)}));let s=n._content.empty().get(0);if(a&&s.appendChild(t('<tr style="height: '+a+'px;" class="loading-row"><td colspan="'+(n.fieldCategories.column.length+1)+'"></td></tr>').get(0)),0===n.dataSorted.length)s.appendChild(n._createNoDataRow().get(0));else if(0===n.dataSortedVisible.length)s.appendChild(n._createNoDataRow(App.translate("No rows are selected by the filtering conditions")).get(0));else for(let t in e){let a=e[t];if("object"!=typeof a){let e=n.data[a];e.$tr&&!l||n._createRow.call(n,e),e.$tr.data("item",e),s.appendChild(e.$tr.get(0))}else s.appendChild(n._createTreeFolderRow.call(n,a).get(0))}i&&s.appendChild(t('<tr style="height: '+i+'px;" class="loading-row"><td colspan="'+(n.fieldCategories.column.length+1)+'"></td></tr>').get(0))},checkChanges:function(e,t,a){let n=t!=a[e];return a[e]=t,n}}),i}})}(),t.extend(App.pcTableMain.prototype,{sort:function(e,t){let a,n=this,i=e.name,l="number"===e.type,s=n.data;if((n.nSorted="n"===e.name)||this._table.addClass("no-correct-n-filtered"),a=l?function(e,a){let n,l,o=s[e][i].v,r=s[a][i].v,d=0;if(null===o)d=null===r?0:-t;else if(null===r)d=t;else{try{n=Big(o)}catch(e){n=Big(0)}try{l=Big(r)}catch(e){l=Big(0)}d=n.gt(l)?t:n.eq(l)?0:-t}return d}:"select"===e.type?function(a,n){let l,o;const r=function(t){let a;return s[t][i].v_?e.multiple?(a="",s[t][i].v_.forEach((function(e){a+=e[0]}))):a=s[t][i].v_[0]:a=s[t][i].v,null===a&&(a=""),a};return l=r(a),o=r(n),l===o?0:l>o?t:-t}:function(e,a){let n,l;return n=s[e][i].v+"",l=s[a][i].v+"",n>l?t:n==l?0:-t},n.isTreeView)if("tree"!==i&&"self"!==n.fields.tree.treeViewType){let e=[],t=[...n.dataSorted];n.dataSorted=[];const i=()=>{e.length&&(e=e.sort(a),n.dataSorted.push(...e),e=[])};t.forEach(t=>{"object"==typeof t?(i(),n.dataSorted.push(t)):e.push(t)}),i()}else{let e=(e,a)=>(a_=n.treeIndex[e].t||"",b_=n.treeIndex[a].t||"",a_===b_?0:a_>b_?t:-t);"tree"!==i&&(e=(e,t)=>a(n.treeIndex[e].row.id,n.treeIndex[t].row.id));const l=t=>{let a=n.treeIndex[t];a.trees=a.trees.sort(e),a.trees.forEach(l)};n.treeSort=n.treeSort.sort(e),n.treeSort.forEach(l),n.treeApply()}else n.dataSorted=n.dataSorted.sort(a);n.dataSortedVisible=[];for(let e=0;e<this.dataSorted.length;e++){let t=this.dataSorted[e];if("object"==typeof t)n.dataSortedVisible.push(t);else{let e=this.data[t];this.__applyFiltersToItem(e),e.$visible&&n.dataSortedVisible.push(t)}}n._refreshContentTable()}}),App.pcTableMain.prototype.isSelected=function(e,t){return!(!this.selectedCells||!this.selectedCells.ids[e]||-1===this.selectedCells.ids[e].indexOf(t))},App.pcTableMain.prototype.getSelectPanel=function(a,n,i){let l=this,s=l.selectedCells;s.selectPanelDestroy();let o=t('<div id="selectPanel" class="text">'),r=t('<div class="column-name"></div>').text(a.title);a.unitType&&r.append(", "+a.unitType),o.append(r),"text"===a.type&&r.append(", "+a.textType),o.append(r);let d="";if("column"===a.category){d='<span class="id-val">['+n.id+"]</span>"+l._getRowTitleByMainField(n," %s");let e=t('<div class="row-name"></div>').html(d);o.append(e)}let c=n[a.name],p=t('<div id="selectPanelBig">'),f=t('<div class="field-value"><div class="copytext-wrapper"><div class="copytext"></div></div></div>').css("white-space","pre-wrap");l.isMobile?f.height("auto").css("min-height",40):f.height(200),p.append(f).appendTo(o);let h=f.find(".copytext");if(!a.unitType||null===c.v||"select"===a.type&&a.multiple||h.attr("data-unit",a.unitType),c.f&&(c.f.text&&f.prepend(t('<div class="sp-element"><i class="fa fa-font"></i> </div>').append(c.f.text)),c.f.comment&&f.prepend(t('<div class="sp-element"><i class="fa fa-info"></i> </div>').append(c.f.comment))),c.h&&c.f&&!1!==c.f.showhand)if(void 0!==c.c){let e=c.c;c.c_&&(e=c.c_[0],c.c_[1]&&(e=t('<span class="deleted_value">').text(e))),f.append(t('<div><i class="fa fa-hand-paper-o"></i> '+App.translate("Calculated value")+": </div>").append(e))}else f.append('<div><i class="fa fa-hand-grab-o pull-left"></i> '+App.translate("Same as calculated")+"</div>");let u,m=t('<div><div class="center"><i class="fa fa-spinner fa-spin"></i></div></div>');if(a.formatInPanel&&(f.append(m),m.data("loadFormats",(function(){a.pcTable.model.getPanelFormats(a.name,n.id).then(e=>{a.getPanelFormats(m,e.panelFormats)})}))),a.selectTable)if(a.changeSelectTable){let e=t('<div><div class="center"></div></div>');if(a.multi){if(c.v&&c.v.length){let i=t('<button class="btn btn-default btn-xxs"></button>').text(App.translate("Edit")).on("click",()=>{a.sourceButtonClick(n)});e.append(t('<div class="panel-buttons">').append(i)).appendTo(f)}}else if(c.v&&!c.v_[1]){let i=t('<button class="btn btn-default btn-xxs"></button>').text(App.translate("Edit")).on("click",()=>{a.sourceButtonClick(n).then(e=>{e&&e.json&&e.json.updated&&l.model.refresh()})});e.append(t('<div class="panel-buttons">').append(i)).appendTo(f)}}else if(a.viewSelectTable){let e=t('<div><div class="center"></div></div>');if(a.multi){if(c.v&&c.v.length){let i=t('<button class="btn btn-default btn-xxs"></button>').text(App.translate("View")).on("click",()=>{a.sourceButtonClick(n)});e.append(t('<div class="panel-buttons">').append(i)).appendTo(f)}}else if(c.v&&!c.v_[1]){let i=t('<button class="btn btn-default btn-xxs"></button>').text(App.translate("View")).on("click",()=>{a.sourceButtonClick(n).then(e=>{e&&e.json&&e.json.updated&&l.model.refresh()})});e.append(t('<div class="panel-buttons">').append(i)).appendTo(f)}}let b=t('<div class="buttons"></div>'),g=[];if(u=t('<button class="btn btn-sm btn-default copy_me" disabled data-copied-text="'+App.translate("Copied")+'" title="'+App.translate("Copy")+' "><i class="fa fa-copy"></i></button>'),u.on("click",(function(){h.data("text")?App.copyMe(h.data("text")):App.copyMe(h.text());let e=t(this);return e.width(e.width()),e.button("copied"),setTimeout((function(){e.button("reset")}),1e3),e.blur(),!1})),b.append(u),i.is(".edt, .panel-edt")){g.push({label:'<i class="fa fa-pencil-square-o"></i>',action:function(e){e.close(),i.dblclick()}});let e=t('<button class="btn btn-sm btn-default"><i class="fa fa-pencil-square-o"></i></button>').appendTo(b);"panels"===l.viewType?e.on("click",(function(){l.editSingleFieldInPanel(a,n.id).then(e=>{e&&l.table_modify(e)}).catch(e=>{console.log(e)}),s.selectPanelDestroy()})):e.on("click",(function(){return i.dblclick(),!1}))}if("column"===a.category&&a.filterable&&(l.isValInFilters.call(l,a.name,c)?(g.push({label:'<i class="fa fa-filter" style="color: #ffe486"></i>',action:function(e){s.selectPanelDestroy(),l.removeValueFromFilters.call(l,a.name,c),e.close()}}),t('<button class="btn btn-sm btn-warning" title="'+App.translate("Remove from the filter")+'"><i class="fa fa-filter"></i></button>').on("click",(function(){return s.selectPanelDestroy(),l.removeValueFromFilters.call(l,a.name,c),!1})).appendTo(b)):(g.push({label:'<i class="fa fa-filter"></i>',action:function(e){s.selectPanelDestroy(),l.addValueToFilters.call(l,a.name,c),l._container.scrollTop(l._filtersBlock.offset().top-l.scrollWrapper.offset().top),l.ScrollClasterized.insertToDOM.call(l.ScrollClasterized,0),e.close()}}),t('<button class="btn btn-sm btn-default" title="'+App.translate("Add to the filter")+'"><i class="fa fa-filter"></i></button>').on("click",(function(){return s.selectPanelDestroy(),l.addValueToFilters.call(l,a.name,c),l._container.scrollTop(l._filtersBlock.offset().top-l.scrollWrapper.offset().top),l.ScrollClasterized.insertToDOM.call(l.ScrollClasterized,0),!1})).appendTo(b))),!l.isMobile){let i=t('<button class="btn btn-sm btn-default"><i class="fa fa-expand" style="padding-top: 3px;" aria-hidden="true"></i></button>');i.on("click",(function(){p.find(".field-value").height(""),p.find(".panel-img img").each((e,a)=>{(a=t(a)).attr("src",a.attr("src").replace("_thumb.jpg?","?"))}),e.top.BootstrapDialog.show({message:p,type:null,title:r.text()+(d?" / "+d:""),cssClass:"fieldparams-edit-panel",draggable:!0,onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"}),s.selectPanelDestroy()},onshown:function(t){t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top}),p.find(".field-value div.codeEditor").trigger("panel-resize")}})})),b.append(i),"tmp"!==l.tableRow.type&&a.logButton&&(g.push({label:App.translate("Log"),action:function(e){let t;l.mainFieldName&&n.id&&(t=n[l.mainFieldName].v),l.model.getFieldLog(a.name,n.id,t),e.close()}}),t('<button class="btn btn-sm btn-default" title="'+App.translate("Log of field manual changes")+'">'+App.translate("Log")+"</button>").on("click",(function(){let e;l.mainFieldName&&n.id&&(e=n[l.mainFieldName].v),l.model.getFieldLog(a.name,n.id,e);let i=t(this).addClass("disabled");return setTimeout((function(){i.removeClass("disabled")}),1e3),!1})).appendTo(b)),t('<button class="btn btn-sm btn-default" title="'+App.translate("Close the panel")+'"><i class="fa fa-times"></i></button>').on("click",(function(){return s.selectPanelDestroy(),!1})).appendTo(b)}let w=a.getPanelText(c.v,o,n);if("select"!==a.type||!a.withPreview||!c.v||a.multiple&&1!==c.v.length)m.data("loadFormats")&&m.data("loadFormats")();else{let e=t('<div class="previews">').appendTo(f);a.loadPreviewPanel(e,a.name,n,c.v).then((function(){m.data("loadFormats")&&m.data("loadFormats")()}))}l.isCreatorView&&-1!==["select","tree","date"].indexOf(a.type)&&f.append(t('<div class="creator-select-val">'+JSON.stringify(c.v)+"</div>"));const v=function(e){h.text(e),u.prop("disabled",!1)},_=function(e,t){h.html(e),e.data("text")?h.data("text",e.data("text")):h.data("text",t),u.prop("disabled",!1)},y=function(e){if("object"==typeof e&&null!==e)if(e instanceof jQuery){let a="";e.copyText?_(e,e.copyText):(e.each((function(){""!==a&&(a+="\n"),a+=t(this).text()})),""===a&&(a=e.text()),_(e,a))}else e.then?e.then(y):v(JSON.stringify(e));else v(e)};if(y(w),l.isCreatorView){let e;l.LOGS&&(e=l.LOGS,n&&n.id&&(e=l.LOGS[n.id]),e&&(e=e[a.name]));let i=t('<div style="padding-top: 10px">');if(e&&e.c){let a=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> c</i></button>');a.on("click",(function(){App.logOutput(e.c)})),i.append(a)}if(e&&e.s){let a=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> s</i></button>');a.on("click",(function(){App.logOutput(e.s)})),i.append(a)}if(e&&e.a){let a=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> a</i></button>');a.on("click",(function(){App.logOutput(e.a)})),i.append(a)}if(e&&e.f){let a=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> f</i></button>');a.on("click",(function(){App.logOutput(e.f)})),i.append(a)}i.children().length&&b.append(i)}if(l.isMobile||o.append(b),c.e&&f.append(t('<div style="padding-top: 5px;">').html(t("<span>").text(c.e).text().replace(/\[\[(.*?)\]\]/g,"<b>$1</b>"))),l.isMobile)App.mobilePanel(r,o,{buttons:g});else{let e="right",t=i.offset().left,a=l._container.offset().left,n=l._container.width(),s=i.width(),r=o.is(".text")?340:240;n-(t-a)-s<r&&(e="left",i.offset().left-a<r&&(e="bottom"));let d={isParams:!0,$text:o,element:i,container:l._container,placement:e,trigger:"manual"};App.popNotify(d)}return t("body").on("click.selectPanelDestroy",(function(e){0===t(e.target).closest("#selectPanel").length&&s.selectPanelDestroy()})).on("keyup.selectPanelDestroy",(function(e){27==e.which&&s.selectPanelDestroy()})),i},App.pcTableMain.prototype._addSelectable=function(){var a=this;a.selectedCells={fieldName:null,ids:{},notRowCell:null,times:null,lastSelected:null,notRowCellEmpty:function(){if(this.notRowCell){this.notRowCell.removeClass("selected");let e=this.notRowCell.closest(".DataRow");1===e.length&&e.removeClass("selected"),this.notRowCell=null}},empty:function(){this.notRowCellEmpty();let e=this;Object.keys(this.ids).forEach((function(t){e.ids[t].forEach((function(e){let t=a._getItemById(e);t&&t.$tr&&(t.$tr.find(".selected").removeClass("selected"),t.$tr.removeClass("selected"))}))})),this.ids={},this.lastSelected=null},selectColumn:function(e){a.dataSortedVisible.forEach(t=>{"object"!=typeof t?this.add(t,e,!0):t.row&&this.add(t.row.id,e,!0)}),this.summarizer.check(),this.multiCheck()},getEditedData:function(e,t){let n={},i=!1;return Object.keys(a.selectedCells.ids).length>1&&(i=!0),Object.keys(a.selectedCells.ids).forEach((function(l){a.selectedCells.ids[l].forEach((function(s){let o=a.data[s],r=o[l].f?o[l].f.block:void 0;o.f.block&&!1!==r||r||!a.fields[l].editable||!a.fields[l].editGroup||i&&!a.fields[l].editGroupMultiColumns||(n[s]||(n[s]={}),n[s][l]=t?o[l].v:e)}))})),n},remove:function(e,t){let n=this;if(!this.ids[t])return;let i={};this.ids[t].some((function(a,l){if(a==e)return n.ids[t].splice(l,1),0===n.ids[t].length&&delete n.ids[t],i[e]=!0,!0})),Object.keys(i).forEach((function(e){let t=!1;Object.keys(n.ids).some((function(a){if(-1!==n.ids[a].indexOf(parseInt(e)))return t=!0,!0})),t||a.data[e].$tr&&a.data[e].$tr.removeClass("selected")}))},add:function(e,t,n){this.ids[t]||(this.ids[t]=[]),this.ids[t].push(e),a.data[e].$tr&&(a.data[e].$tr.addClass("selected"),n&&a._getTdByFieldName(t,a.data[e].$tr).addClass("selected"))},selectPanelDestroy:function(){let e=this;e.selectPanel&&(e.selectPanel.attr("aria-describedby")&&e.selectPanel.popover("destroy"),e.selectPanel=null),t("body").off(".selectPanelDestroy")},checkIfShowPanel:function(e){"use strict";if(this.selectPanelDestroy(),e){let t,n=a._getFieldBytd(e);t="column"===n.category?a._getItemBytd(e):a.data_params,this.selectPanel=a.getSelectPanel.call(a,n,t,e)}return!1},copySepected:function(e,a){let n=this,i="",l=[],s=[],o={},r=[];Object.keys(n.selectedCells.ids).forEach((function(e){let t=n.selectedCells.ids[e];l=l.concat(t),s.push(e),t.forEach((function(t){o[t]||(o[t]={});let a=n.fields[e].getCopyText.call(n.fields[e],n.data[t][e],n.data[t]);"object"==typeof a?(r.push(a),a.done((function(a){o[t][e]=a}))):o[t][e]=a}))})),l=Array.from(new Set(l)),l=n.dataSortedVisible.filter(e=>-1!==l.findIndex(t=>t==e)),s=Array.from(new Set(s));let d=[];n.fieldCategories.visibleColumns.forEach((function(e){-1!==s.indexOf(e.name)&&d.push(e.name)})),s=d,e&&(i+="id",s.forEach((function(e){i+="\t",i+=n.fields[e].title})));let c=a;t.when(...r).done((function(){l.forEach((function(t){""!==i&&(i+="\n");let a=!0;e&&(i+=t,a=!1),s.forEach((function(e){!0===a?a=!1:i+="\t";let n=o[t][e];void 0===n&&(n=""),"string"==typeof n&&n.replace(/\t/g,"").match(/[\s"]/)&&1!==s.length&&(n='"'+n.replace(/"/g,'""')+'"'),i+=n}))})),App.copyMe(i),setTimeout(c,400)}))},click:function(e,n){let i=a._table;return!e.closest("table").is(".pcTable-filtersTable")&&(!0===i.data("moved")?(i.data("moved",!1),!1):n.originalEvent&&n.originalEvent.path&&n.originalEvent.path[0]&&t(n.originalEvent.path[0]).is(".asUrl")?(a.actionOnClick(e),!1):((()=>{if(e.is(".val")){if(this.notRowCell&&-1!==this.notRowCell.index(e))a.selectedCells.empty();else{a.selectedCells.empty(),this.notRowCell=e,this.notRowCell.addClass("selected");let t=this.notRowCell.closest(".DataRow");1===t.length&&t.addClass("selected")}return void t("table.pcTable-table").removeClass("selected-multi").removeClass("selected-column")}this.notRowCellEmpty();let i=e.closest("tr"),l=a._getItemByTr(i),s=a._fieldByTd(e,i),o=s.name;if(n.altKey)e.is(".selected")?(a.selectedCells.remove(l.id,o),e.removeClass("selected")):(a.selectedCells.add(l.id,o),e.addClass("selected"),this.lastSelected=[o,l.id]);else if(n.shiftKey&&Object.keys(a.selectedCells.ids).length){let e=this,t=[],n="before";a.dataSortedVisible.some((function(a){if(a="object"==typeof a&&a.row?a.row.id:parseInt(a),"before"===n){if((a===l.id||a===e.lastSelected[1])&&(n="doIt",t.push(a),l.id===e.lastSelected[1]))return!0}else if("doIt"===n&&(t.push(a),a===l.id||a===e.lastSelected[1]))return!0})),n="before";let i=function(n){t.forEach((function(t){let i=a.data[t];a.isSelected(n.name,t)||(e.add(t,n.name),i.$tr&&a._getTdByFieldName(n.name,i.$tr).addClass("selected"))}))};a.fieldCategories.column.some((function(t){if(t.showMeWidth>0)if("before"===n){if((t.name===o||t.name===e.lastSelected[0])&&(n="doIt",i(t),o===e.lastSelected[0]))return!0}else if("doIt"===n&&(i(t),t.name===o||t.name===e.lastSelected[0]))return!0})),this.lastSelected=[o,l.id]}else{let t=a.isSelected(s.name,l.id);a.selectedCells.empty(),t||(a.selectedCells.add(l.id,o),e.addClass("selected"),this.lastSelected=[o,l.id])}a.selectedCells.multiCheck()})(),void this.summarizer.check()))},multiCheck:()=>{let e=Object.keys(a.selectedCells.ids);e.length>1?t("table.pcTable-table").addClass("selected-multi"):1===e.length&&Object.values(a.selectedCells.ids)[0].length>1?t("table.pcTable-table").removeClass("selected-multi").addClass("selected-column"):t("table.pcTable-table").removeClass("selected-multi").removeClass("selected-column")},summarizer:{timeout:null,element:t('<div class="summarizer"><span></span> : <span></span></div>'),status:0,check:()=>{if(a.isMobile)return;let e,t=Object.keys(a.selectedCells.ids);if(t.length){let n=t.every(t=>(e?a.fields[t].dectimalPlaces&&a.fields[t].dectimalPlaces>e.dectimalPlaces&&(e=a.fields[t]):e=a.fields[t],"number"===a.fields[t].type)),i=0,l=0;t.forEach(e=>{a.selectedCells.ids[e].forEach(t=>{i++,n&&null!==a.data[t][e].v&&(l+=parseFloat(a.data[t][e].v))})});let s=a.selectedCells.summarizer.element.find("span");s[1].innerHTML=n?e.numberFormat(l,e.dectimalPlaces||0,"."):"-",s[0].innerHTML=i,a.selectedCells.summarizer.status||(a.selectedCells.summarizer.status=1,a.selectedCells.summarizer.timeout=setTimeout(()=>{a.selectedCells.summarizer.element.appendTo(a._innerContainer)},1e3))}else a.selectedCells.summarizer.empty()},empty:()=>{a.selectedCells.summarizer.status&&(a.selectedCells.summarizer.status=0,a.selectedCells.summarizer.timeout&&clearTimeout(a.selectedCells.summarizer.timeout),a.selectedCells.summarizer.element.detach())}}},this._container.on("contextmenu",".DataRow td:not(.editing,.n,.id), td.val:not(.editing)",(function(e){let n=t(this);return a.selectedCells.selectPanel&&a.selectedCells.selectPanel.closest("td")[0]==n[0]?a.selectedCells.selectPanelDestroy():(a.selectedCells.selectPanelDestroy(),a.selectedCells.empty(),a.selectedCells.checkIfShowPanel(n),a.selectedCells.click(n,{})),!1})),this._container.on("click",".DataRow td:not(.editing,.id,.n), td.val:not(.editing), .pcTable-buttons .cell-button",(function(n){if("file-image-preview"===n.target.className){let t=JSON.parse(n.target.getAttribute("data-fileviewpreview"));e.top.BootstrapDialog.show({title:t.name,message:'<div class="file-image-big"><img src="/fls/'+t.file+'" style="max-width: 100%; max-height: 100%"/></div>',type:null,draggable:!0})}else{if("file-pdf-preview"===n.target.className)return e.open(n.target.getAttribute("data-filename")),!1;{let e=t(this);if(e.is(".edt.val:not(.editing)")&&"filter"===a._getFieldBytd(e).category)return void a._createEditCell.call(a,e,!0);if(e.is(".cell-button")&&!e.find("button.button-field").is(":disabled")){let t=a._getFieldBytd(e);return a._buttonClick.call(a,e,t),!1}e.data("clicked")?e.removeData("clicked"):(e.data("clicked",1),setTimeout((function(){e.data("clicked")&&(e.removeData("clicked"),a.selectedCells.click(e,n))}),200))}}})),this._container.on("click","th.id .for-selected button",(function(){let e=t(this),n=e.html();e.text(App.translate("Copied")),a.selectedCells.copySepected.call(a,e.data("names"),(function(){e.html(n)}))}))},App.pcTableMain.prototype.filters={},App.pcTableMain.prototype.__getFilterButton=function(e){var a="btn-default";(this.filters[e]&&this.filters[e].length||this.filters[e+"/h"])&&(a="btn-warning");var n=t('<button class="btn btn-xxs btn-filter"><span class="fa fa-filter"></span></button>').addClass(a);return t('<span class="filter-in-head">').append(n)},App.pcTableMain.prototype.filtersEmpty=function(){this.filters={},this._refreshHead(),this.__applyFilters()},App.pcTableMain.prototype.sessionStorageFilters={url:location.protocol+"//"+location.host+location.pathname,setFilters:function(e){let t={};e=e||{};try{t=JSON.parse(sessionStorage.getItem("pcTableFilters"))||{}}catch(e){}t[this.url]=e,sessionStorage.setItem("pcTableFilters",JSON.stringify(t))},getFilters:function(){let e={};try{e=JSON.parse(sessionStorage.getItem("pcTableFilters")),e=e[this.url]||{}}catch(e){}return e}};let p=!0;App.pcTableMain.prototype.__applyFilters=function(e=!1){let t=this;App.fullScreenProcesses.show(),this.filtersClearButton&&("tmp"!==t.tableRow.type&&this.sessionStorageFilters.setFilters(this.filters),this.selectedCells&&this.selectedCells.empty(),Object.equals(this.filters,{})?this.filtersClearButton.addClass("btn-default").removeClass("btn-warning").attr("disabled",!0):(this.filtersClearButton.removeClass("btn-default").addClass("btn-warning").removeAttr("disabled"),p&&(App.blink(t.filtersClearButton,8,"#fff"),p=!1)));let a=[];this.isTreeView||(a=this.dataSortedVisible.slice());let n=[],i=[];if(this.isTreeView)if(this.filters&&Object.keys(this.filters).length){let e=[];this.dataSorted.forEach(t=>{"object"!=typeof t||t.opened||e.push(t)}),e.forEach(e=>{this._expandTreeFolderRow(e,!0)});for(let e=0;e<this.dataSorted.length;e++){let t=this.dataSorted[e],a=t.row;if("object"!=typeof t&&(a=this.data[t]),a&&this.__applyFiltersToItem(a)){let a,i=[],l=e-1;for(;"object"!=typeof this.dataSorted[l];)l--;for("object"==typeof t?a=t.p:(i.push(this.dataSorted[l]),a=this.dataSorted[l].p);a&&l;){for(;"object"!=typeof this.dataSorted[l];)l--;this.dataSorted[l]===this.getElementInTree(a)&&(i.push(this.dataSorted[l]),a=this.dataSorted[l].p),l--}for(;i.length;)n.push(i.pop());n.push(t)}}}else this.dataSorted.forEach(e=>{n.push(e)});else for(let e=0;e<this.dataSorted.length;e++){let t=this.dataSorted[e],a=this.data[t];this.__applyFiltersToItem(a),a.$visible&&(n.push(t),i.push(t))}(this.isTreeView||e||JSON.stringify(a)!==JSON.stringify(i))&&(this.dataSortedVisible=n,this._refreshContentTable(!1,!0),this._headCellIdButtonsState()),this.selectedCells&&this.selectedCells.summarizer.check(),App.fullScreenProcesses.hide()},App.pcTableMain.prototype.__applyFiltersToItem=function(e){let t=this,a=!0;for(let n in t.filters){if(!t.filters[n]||0===t.filters[n].length)continue;let i=t.filters[n];if("id"===n)-1===i.indexOf(e.id.toString())&&(a=!1);else{let l=n.toString().split("/");if(n=l[0],!t.fields[n])continue;switch(l[1]||"v"){case"v":let l=t._getFieldbyName(n);l.checkIsFiltered(e[n],i)?l.checkIsFiltered(e[n],i):a=!1;break;case"h":switch(i){case"h":!0!==e[n].h&&(a=!1);break;case"n":!0===e[n].h&&(a=!1);break;case"hf":(!0!==e[n].h||e[n].hasOwnProperty("c"))&&(a=!1);break;case"hc":!0===e[n].h&&e[n].hasOwnProperty("c")||(a=!1)}}}if(!a)break}return(e.$visible=a)||this.row_actions_uncheck(e),e.$visible},App.pcTableMain.prototype.addValueToFilters=function(e,t){const a=this;a.filters[e]||(a.filters[e]=[]);let n=a.fields[e];a.filters[e].push(...n.getFilterDataByValue.call(n,t)),n.$th&&n.$th.find(".btn-filter").parent().replaceWith(a.__getFilterButton.call(a,e)),a.__applyFilters.call(a)},App.pcTableMain.prototype.isValInFilters=function(e,t){if(!this.filters[e])return!1;let a=this.fields[e],n=a.getFilterDataByValue.call(a,t);return this.filters[e].some(e=>-1!==n.indexOf(e))},App.pcTableMain.prototype.removeValueFromFilters=function(e,t){const a=this;a.filters[e]||(a.filters[e]=[]);let n=a.fields[e],i=n.getFilterDataByValue.call(n,t),l=0,s=[...a.filters[e]];a.filters[e].forEach((e,t)=>{-1!==i.indexOf(e)&&(s.splice(t-l,1),l++)}),a.filters[e]=s,0===a.filters[e].length&&delete a.filters[e],n.$th&&n.$th.find(".btn-filter").parent().replaceWith(a.__getFilterButton.call(a,e)),a.__applyFilters.call(a)},App.pcTableMain.prototype.loadFilters=function(){var e={};"tmp"!=this.tableRow.type&&(e=this.sessionStorageFilters.getFilters()),this.filters=e||{}},App.pcTableMain.prototype.__addFilterable=function(){const e=this;this.loadFilters(),
/*!panelView*/
this.viewType||this._header.on("click",".pcTable-filters > span button.btn-filter:not(#checkS)",(function(a){let n=t(this);if(n.attr("aria-describedby"))return!0;let i=n.closest("th"),l=i.is(".id")?"id":i.data("field"),s=t('<div class="filter-div-button">'),o=t('<select class="selectpicker" data-size="6" multiple title="'+App.translate("Select values")+'" data-style="btn-sm btn-default" data-width="css-width" data-live-search="true" data-selected-text-format="count">').appendTo(s);const r=function(){try{n.popover("destroy")}catch(e){}};let d,c=!1;const p=function(a){if(d&&clearTimeout(d),!c){if("filterRemove"===a)return c=!0,r(),delete e.filters[l],n.removeClass("btn-warning").addClass("btn-default"),void e.__applyFilters.call(e);if("setInvertFilters"===a){let e=Object.values(o.selectpicker("val")),a=[];t.each(o.data("options"),(function(t,n){-1===e.indexOf(n)&&a.push(n)})),o.data("add-options",a)}d=setTimeout((function(){r(),o.data("add-options")?(f=o.data("add-options"),o.data("add-options",null)):f=o.selectpicker("val"),JSON.stringify(e.filters[l]||[])!==JSON.stringify(f)&&(e.filters[l]=f,0===e.filters[l].length&&delete e.filters[l],"id"!==l||n.closest(".pcTable-table").is(".pcTable-table:first")||e._header.find("th.id .btn-filter").parent().replaceWith(e.__getFilterButton.call(e,l)),n.parent().replaceWith(e.__getFilterButton.call(e,l)),e.__applyFilters.call(e))}),10)}};s=t('<div class="pcTable-filter-select" style="height: 220px;">').append(s),o.data("container",s);var f={};e.isTreeView?Object.values(e.data).forEach((function(t){"id"===l?f[t.id.toString()]=t.id.toString():e.fields[l].addDataToFilter(f,t[l])})):Object.values(e.dataSorted).forEach((function(t){"id"===l?f[t.toString()]=t.toString():e.fields[l].addDataToFilter(f,e.data[t][l])}));var h={};t.each(f,(function(e,t){h[t]=e})),h=App.ksort(h);let u={},m=e.filters[l]?[...e.filters[l]]:[],b=0;const g=function(e){u={[App.translate("Selected")]:t('<optgroup label="'+App.translate("Selected")+'">'),"":t('<optgroup label="">')};let a=function(){return!0};if(e&&""!==e){let t=e;[t]=App.lang.search_prepare_function(t),t=t.split(" "),a=function(e){let a;return null===e?a="":(a=e.toString(),[a]=App.lang.search_prepare_function(a)),!t.some((function(e){return-1===a.indexOf(e)}))}}let n=!1,i=0;t.each(h,(function(e,t){if("null"===e&&(e="null "),-1!==m.indexOf(t.toString())){let n=a(e);u[App.translate("Selected")].append('<option data-content="'+e+'" '+(n?"":'style="display: none"')+">"+t+"</option>"),b+=n?1:0}else{if(!a(e))return!0;i>=100?n=!0:(u[""].append('<option data-content="'+e+' ">'+t+"</option>"),i++)}})),o.empty(),b||u[App.translate("Selected")].attr("label",""),o.append(u[App.translate("Selected")]),o.append(u[""]),n&&o.append('<option data-content="'+App.translate("The data is incomplete. Use the search!")+'" disabled = disabled style="text-align: center; cursor: pointer">0</option>'),o.data("options",h),o.selectpicker("val",m),o.selectpicker("refresh")};o.on("change.bs.select",(function(){m=o.val()})),g();let w=n.popover({html:!0,content:s,trigger:"manual",container:e._container,placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'});o.selectpicker("render").selectpicker("toggle"),n.one("remove",()=>{setTimeout(()=>{let e;w&&w.length&&w.attr("aria-describedby")&&(e=t("#"+w.attr("aria-describedby")))&&e.remove()},10)});let v=t('<div class="buttons" style="position: absolute; bottom: -10px; width: 100%; text-align: center">');if(t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px;">'+App.translate("ApplyShort")+"</span></span>").appendTo(v).on("click",(function(){p("setSelectedFilters")})),t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px;">'+App.translate("InvertShort")+"</span></span>").appendTo(v).on("click",(function(){p("setInvertFilters")})),t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px">'+App.translate("CancelShort")+"</span>").appendTo(v).on("click",(function(){p("filterRemove")})),e.fields[l]&&e.fields[l].code&&!e.fields[l].codeOnlyInAdd){let a=t('<select data-title="'+App.translate("All")+'" data-dropup-auto="false" class="dropup" data-container=".popover" data-style="btn btn-xxs filter-by-hand '+(e.filters[l+"/h"]?"btn-warning":"btn-default")+' "><option value="">'+App.translate("All")+'</option><option value="n">'+App.translate("Without hand")+'</option><option value="h">'+App.translate("With hand all")+'</option><option value="hf">'+App.translate("With hand equals calc")+'</option><option value="hc">'+App.translate("With hand different")+"</option></select>").appendTo(v).on("change",(function(){return e.filters[l+"/h"]=a.selectpicker("val"),""===e.filters[l+"/h"]&&delete e.filters[l+"/h"],r(),n.parent().replaceWith(e.__getFilterButton.call(e,l)),e.__applyFilters.call(e),!1})).wrap('<span id="filterHand">');setTimeout((function(){a.selectpicker("render").selectpicker("val",e.filters[l+"/h"]||"");try{a.data("selectpicker").$menu.offset({bottom:15,left:-90}).css("border","1px solid grey")}catch(e){}}),100)}e.PageData&&e.PageData.onPage&&e.PageData.allCount>e.PageData.onPage?(b?s.height(260):s.height(220),v.append('<div class="text-center ttm-paging-danges">'+App.translate("Filtering by current page")+"</div>")):b?s.height(220):s.height(200),v.appendTo(s),o.on("hidden.bs.select",(function(){p("setSelectedFilters")})),e.filters[l]&&o.selectpicker("val",e.filters[l]),setTimeout((function(){if(w&&w.length){let a;w.popover("show"),s.on("mouseenter","li",(function(){let e=t(this);e.attr("title")||e.attr("title",e.text())})),"id"===l&&t("#"+n.attr("aria-describedby")).position({my:"left top",at:"left-3px bottom+10px",of:n}).find(".arrow").css("left","12px"),o.data("selectpicker")._searchStyle=function(){return"multiincludes"},o.data("selectpicker").$searchbox.off().on("click.dropdown.data-api focus.dropdown.data-api touchend.dropdown.data-api",(function(e){e.stopPropagation()})),o.data("selectpicker").$searchbox.on("keydown",(function(e){if("Escape"===e.key)return o.data("selectpicker").$button.click(),!0}));let i="";o.data("selectpicker").$searchbox.on("keyup",(function(e){let n=t(this).val();i!==n&&(i=n,a&&clearTimeout(a),a=setTimeout((function(){g(i)}),750))})),e._container.on("click.filter filterPressed.filter",(function(a){0!==t(a.target).closest("#filterHand").length||"filterPressed"!==a.type&&void 0===a.altKey||!t("#"+n.attr("aria-describedby")).is(":visible")||(e._container.off(".filter"),p("setSelectedFilters"))})),e._innerContainer.one("scroll.filter",(function(a){t("#"+n.attr("aria-describedby")).is(":visible")&&(e._container.off(".filter"),p("setSelectedFilters"))})),o.data("selectpicker").$searchbox.focus()}}),50),e._container.trigger("filterPressed")}))},t.extend(App.pcTableMain.prototype,{_addEditable:function(){var e=this;let a=this._container;e.actionOnClick=function(e,t){let a=e.clone(!0).insertAfter(e);e.hide(),t=t||this._getFieldBytd(e),a.html('<span class="cell-value blocked" style="height: '+a.height()+'">'+App.translate("Running")+"</span>");let n=e.closest(".DataRow").length?this._getItemBytd(e):{};return this.model.dblClick(n.id,t.name).always(t=>{a.remove(),e.show(),this.table_modify(t)}),!1};const n=(e,t)=>{let a=e.clone(!0).insertAfter(e);e.hide(),a.html('<span class="cell-value blocked" style="height: '+a.height()+'">'+t+"</span>"),setTimeout((function(){a.remove(),e.show()}),500)};a.on("dblclick","td.val:not(.editing), td.edt:not(.editing), .dataRows tr:not(.treeRow) td:not(.editing,.id,.n)",(function(a){let i=t(this),l=i.closest("tr");if(l.length&&l.is(".InsertRow"))return!1;if(i.is(".footer-name, .id, .footer-empty"))return!1;if(l.is(".DataRow")&&e.isRestoreView)n(i,App.translate("Deleted"));else if(i.is(".edt"))e._createEditCell.call(e,i,!0);else{let t=e._getFieldBytd.call(e,i);if(t.CodeActionOnClick)e.actionOnClick(i,t);else{if(l.is(".DataRow")&&"cycles"===e.tableRow.type)return e.model.dblClick(e._getItemBytd(i).id,e._getFieldBytd(i).name),!1;n(i,App.translate("Blocked"))}}})).on("click",".editCellsBlock .btn, td.edt .ttm-edit, td .ttm-panel",(function(e){return t(this).is(".ttm-edit")?(t(this).closest("td").trigger("dblclick"),!1):t(this).is(".ttm-panel")?(t(this).closest("td").trigger("contextmenu"),!1):void t(this).data("click")(e)}))},goToEditNextCell:function(e){return next},_buttonClick:function(a,n,i){return a.data("clicked")?Promise.resolve():new Promise((l,s)=>{const o=function(){"use strict";let s,o={};a.parent();a.data("clicked",!0),"column"===n.category?(i=i||r._getItemBytd(a),s=i.id,o.item=s,o.fieldName=n.name):(i=i||r.data_params,o.item="params",o.fieldName=n.name),o.checked_ids=r.row_actions_get_checkedIds(),a.height(a.height()),a.find(".cell-value, .ttm--panel-data").hide();let d=t('<div class="text-center"><i class="fa fa-spinner" style="color: #000"></i></div>');a.append(d),r._saving=!0,r.model.click(o).then((function(t){r.table_modify.call(r,t),a.length&&a.isAttached()?(d.remove(),a.find(".cell-value, .ttm--panel-data").show()):i="column"===n.category?r._getItemById(s):r.data_params,n.uncheckAfterClick&&r.row_actions_uncheck_all(),n.closeIframeAfterClick&&e.closeMe?e.closeMe():n.openContextPanel&&a.trigger("contextmenu"),n.btnOK.call(n,a,i),l(t)})).fail((function(){a.length&&a.isAttached()&&(d.remove(),a.find(".cell-value, .ttm--panel-data").show(),a.removeData("clicked"))})).always((function(){r._saving=!1}))};let r=this;if(n.warningEditPanel){let e={OK:function(e){e.close(),o()},[App.translate("Cancel")]:function(e){e.close()}};App.confirmation(n.warningEditText||App.translate("Surely to change?"),e,App.translate("Confirmation"))}else o()})},_saveEdited:function(e,a,n){let i=this;!0!==i._saving&&(i._saving=!0,this.model.save(a).then(t=>{i.table_modify.call(i,t,void 0,e),n&&n()}).always(()=>{i._saving=!1,e.is("tr.DataRow")&&1===e.closest("table").length&&e.find(".editing").length?e.each(()=>{i.refreshRow(t(this))}):e.is("td")&&e.find(".fa-spinner").length&&e.closest("body").length>0&&e.each((function(){let e=t(this),a=i._getItemBytd(e),n=i._getFieldBytd(e),l=i._createCell(a,n);"button"===n.type&&n.btnOK.call(n,l,a),e.replaceWith(l)}))}))},_editFocusIndex:0,_editItem:null,_editPanel:null,_row_edit:function(e){let t=this;if(0===e.length)return!1;let a=e.shift();new EditPanel(t,null,{id:a},e.length>0).then((function(a,n){(a||n)&&(a&&t.table_modify.call(t,a),t._row_edit.call(t,e))})).then((function(){0===e.length&&t.row_actions_uncheck_all()}))},_currentEditCellIndex:0,_removeEditing:function(e){e||(e=this._content.find("td.editing"));var t=this._createCell(this._getItemBytd(e),this._getFieldBytd(e));let a;return(a=e.attr("rowspan"))&&t.attr("rowspan",a),(a=e.data("field"))&&t.data("field",a),e.is(".val")&&t.addClass("val"),e.replaceWith(t),t},_saveEditCell:function(){this._editCell&&this._editCell.isAttached()&&this._editCell.is(".editCell")&&this._editCell.data("SaveMe")&&this._editCell.data("SaveMe")()},_removeEditCell:function(){this._editCell&&this._editCell.isAttached()&&this._editCell.is(".editCell")&&this._removeEditing(this._editCell),this._editCell=null},_setEditCell:function(e){this._saveEditCell(),this._editCell=e,e.addClass("editCell")},_setTdSaving:function(e){e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>')},_createEditCell:function(e,a,n){let l=this,s=this._getFieldBytd(e);this._setEditCell(e);e.parent();let o=e.closest("tr"),r=l._getColumnIndexByTd(e,o),d=function(e){if(!e)return!1;let t;switch(e){case"right":for(t=l._getTdByColumnIndex.call(l,o,++r);t.length;){if(!0===l._getFieldBytd.call(l,t).editable){t.trigger("dblclick");break}t=t.next("td")}break;case"down":for(t=o.next("tr");t.length&&t.is(".Blocked");)t=t.next("tr");l._getTdByColumnIndex.call(l,t,r).trigger("dblclick")}};if(!s.editable)return!1;let c=(n=n||this._getItemBytd(e)).id,p=t('<div class="editCellsBlock">');e.addClass("editing");let f,h,u=n[s.name],m=!1,b=function(e,t,a,n){let s=a||e.closest("td"),o=t||{};if(!s.length||!s.closest("body").length)return!1;var r=l._removeEditing.call(l,s);n||(l._colorizeElement(r,i),d(o&&o.altKey?"right":!(!o||!o.shiftKey)&&"down"))},g=function(t){l._removeEditing.call(l,e),d(t)};l.isSelected(s.name,n.id)?Object.keys(l.selectedCells.ids).length>1?(h=!0,f=!0):l.selectedCells.ids[s.name].length>1&&(f=!0):l.selectedCells.empty();let w=function(t,a,i){if(!i&&s.warningEditPanel&&s.checkEditRegExp.call(s,t))return void App.confirmation(s.warningEditText||App.translate("Surely to change?"),{OK:function(e){w(t,a,!0),e.close()},[App.translate("Cancel")]:function(e){g(),e.close()}},App.translate("Change warning"));e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>');let o={};o[s.name]=t;let r={};n.id?r[n.id]=o:r.params=o,l._saveEdited.call(l,e,r,(function(){d(a&&a.altKey?"right":!(!a||!a.shiftKey)&&"down")}))},v=function(e,t){setTimeout((function(){if(m)return m=!1,!1;_(e,t)}),150)},_=function(e,a,i){if(m&&!i)return!1;if(m=!0,!(i=i||!1)&&f)return("select"!==s.type||s.multiple)&&l._removeEditCell(),!1;let o,r=e.closest("td");try{o=s.getEditVal(y)}catch(e){return t("#"+App.popNotify(e,r,"default")).css("z-index",1e3),void(m=!1)}let d=a&&a.altKey?"right":!(!a||!a.shiftKey)&&"down";!s.name in n||!s.isDataModified(o,n[s.name].v)?g(d):w(o,a)};var y=s.getEditElement(void 0,u,n,_,b,v,null,a);u.f&&u.f.placeholder&&s.addPlaceholder&&s.addPlaceholder(y,u.f.placeholder),e.html(y),e.attr("data-fieldtype",s.type),e.data("SaveMe",(function(e){_(y,e=e||{})})),e.data("input",y);var x=t('<div class="cdiv">').css({height:0,width:"100%",position:"absolute",bottom:"0px"});e.append(x);var C=t('<button class="btn btn-sm btn-default" data-save="true" data-name="'+App.translate("Save")+'"><i class="fa fa-save"></i></button>').data("click",(function(e){m=!0,_(y,e,!0)}));p.append(C);C=t('<button class="btn btn-sm btn-default btn-empty-with-icon"><i class="fa fa-times"></i></button>').data("click",(function(e){m=!0;let t=e.altKey?"right":!!e.shiftKey&&"down";g(t)}));if(p.append(C),f&&(h?s.editGroupMultiColumns:s.editGroup)){C=t('<button class="btn btn-sm btn-warning" data-save="true" data-name="'+App.translate("Apply to selected")+'"><i class="fa fa-database" title="'+App.translate("Apply to selected")+'"></i></button>');let a=function(){let t;m=!0;try{t=s.getEditVal(y)}catch(t){return void App.popNotify(t,e,"default")}let a=l._container.find("td.selected");l._setTdSaving(a);let n=l.selectedCells.getEditedData(t);l._saveEdited.call(l,a,n,!1)};C.data("click",(function(){s.warningEditPanel?App.confirmation(s.warningEditText,{OK:function(e){a(),e.close()},[App.translate("Cancel")]:function(e){g(),e.close()}},App.translate("Change warning")):a()})),p.append(C),s.code&&!s.codeOnlyInAdd&&(Object.keys(l.selectedCells.ids).some(e=>l.selectedCells.ids[e].some(t=>!l.data[t][e].h))&&((C=t('<button class="btn btn-sm btn-warning" data-name="'+App.translate("Fix the selected")+'"><i class="fa fa-hand-rock-o" title="'+App.translate("Fix the selected")+'"></i></button>')).data("click",(function(){m=!0;let e=l._container.find("td.selected");l._setTdSaving(e);let t=l.selectedCells.getEditedData(null,!0);l._saveEdited.call(l,e.closest("tr"),t,!1)})),p.append(C)),Object.keys(l.selectedCells.ids).some(e=>l.selectedCells.ids[e].some(t=>l.data[t][e].h))&&((C=t('<button class="btn btn-sm btn-danger" data-name="'+App.translate("Reset manuals")+'"><i class="fa fa-eraser" title="'+App.translate("Reset manuals")+'"></i></button>')).data("click",(function(){m=!0;let e=l._container.find("td.selected");l._setTdSaving(e);let t=l.selectedCells.getEditedData("NULL");t.setValuesToDefaults=!0,l._saveEdited.call(l,e.closest("tr"),t,!1)})),p.append(C)))}else n[s.name]&&1==n[s.name].h?((C=t('<button class="btn btn-sm btn-danger" data-name="'+App.translate("Reset manual")+'"><i class="fa fa-eraser" title="'+App.translate("Reset manual")+'"></i></button>')).data("click",(function(){m=!0,e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>');let t={};parseInt(c)||(c="params"),t[c]={},t[c][s.name]="NULL",t.setValuesToDefaults=!0,l._saveEdited.call(l,e,t,!1)})),p.append(C)):s.code&&!s.codeOnlyInAdd&&"filter"!==s.category&&((C=t('<button class="btn btn-sm btn-default" data-name="'+App.translate("Pin")+'"><i class="fa fa-hand-rock-o" title="'+App.translate("Pin")+'"></i></button>')).data("click",(function(){m=!0,e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>');let t={};parseInt(c)||(c="params"),t[c]={},t[c][s.name]="params"===c?l.data_params[s.name].v:l.data[c][s.name].v,l._saveEdited.call(l,e,t,!1)})),p.append(C));if(s.changeSelectTable&&"select"===s.type){let e=function(){m=!0,sourcePanelOpened=!0,setTimeout(()=>{y.click()},3);let e=t(this).data("add-button");return s.sourceButtonClick(n,e).then(e=>{let a=e&&"insert"===e.method&&e.json&&e.json.chdata&&e.json.chdata.rows,i=y;if(delete s.list,i.data("input").data("LISTs")&&(i.data("input").data("LISTs").isListForLoad=!0),n=t.extend(!0,{},n),a){let t;t=s.selectTableBaseField?e.json.chdata.rows[Object.keys(e.json.chdata.rows)[0]][s.selectTableBaseField].v:Object.keys(e.json.chdata.rows)[0],s.multiple?(n[s.name].v=s.getEditVal(y),n[s.name].v.push(t)):n[s.name].v=t}else s.selectTableBaseField&&(s.multiple||(n[s.name].v=e.json.chdata.rows[Object.keys(e.json.chdata.rows)[0]][s.selectTableBaseField].v));a||"column"!==s.category||l.model.refresh((function(e){l.table_modify.call(l,e)})),n[s.name].replaceViewValue=function(e){"column"!=s.category&&(l.data_params[s.name].v_=e)},i.replaceWith(y=s.getEditElement(i,n[s.name],n,_,b,v)),m=!1}),!1};(C=t('<button class="btn btn-sm btn-primary"><i class="fa fa-edit" title="'+App.translate("Change in source table")+'"></i></button>')).on("click",e),p.append(C),2===s.changeSelectTable&&(C=t('<button class="btn btn-sm btn-primary" data-add-button="true"><i class="fa fa-plus" title="'+App.translate("Add to source table")+'"></i></button>'),p.append(C),C.on("click",e))}let k=p.find("button").length;p.width(31*k);let T=t("#"+App.popNotify({$text:p,element:x,container:this._container,isParams:!0,placement:"bottom"})),A=parseInt(T.css("top"))-4;T.css("top",-1e7),setTimeout((function(){T.length&&T.isAttached()&&T.css("top",A)}),3),s.focusElement(y)},editSingleFieldInPanel:function(a,n){return new Promise((i,l)=>{let s,o,r,d,c=n?this.data[n][a.name]:this.data_params[a.name],p=this.getElementFormat(a,n),f=t("<div>"),h=n?this.data[n]:this.data_params,u=[{action:e=>{m()},cssClass:"btn-warning btn-save",label:App.translate("Save")}];a.code&&!a.codeOnlyInAdd&&(c.h?u.push({action:e=>{s="setValuesToDefaults",o=null,m()},cssClass:"btn-warning btn-save",label:'<i class="fa fa-eraser"></i>'}):u.push({action:e=>{o=c.v,m()},cssClass:"btn-warning btn-save",label:'<i class="fa fa-hand-rock-o"></i>'})),u.push({action:e=>{e.close()},cssClass:"",label:'<i class="fa fa-times"></i>'});const m=e=>{if(void 0===o){try{o=a.getEditVal(d)}catch(e){return void t("#"+App.popNotify(e,f,"default")).css("z-index",1e3)}if(!a.isDataModified(o,c.v))return void r.close()}if(!e&&a.warningEditPanel&&a.checkEditRegExp.call(a,o))return void App.confirmation(a.warningEditText||App.translate("Surely to change?"),{OK:function(e){m(!0),e.close()},[App.translate("Cancel")]:function(e){revert(),e.close()}},App.translate("Change warning"));App.fullScreenProcesses.showCog();let n={};n[a.name]=o;let l={};h.id?l[h.id]=n:l.params=n,s&&(l[s]=!0),this.model.save(l).then(e=>{i(e),r.close()}).always(()=>{App.fullScreenProcesses.hideCog()})};switch(a.type){case"tree":case"text":case"file":case"comments":case"listRow":d=a.getEditElement(f,c,n?this.data[n]:this.data_params,()=>{m()},()=>{},()=>{},1,!0),f.append(d),setTimeout(()=>{r=d.data("Dialog");let e=r.getButtons()[0].action;u[0].action=(t,a,n)=>{e(t,a,n),m()},r.setButtons(u)},2);break;default:d=a.getEditElement(f,c,n?this.data[n]:this.data_params,()=>{m()},()=>{},()=>{}),f.append(d),r=e.top.BootstrapDialog.show({message:f,type:null,title:p.title||a.title,cssClass:"one-column-panel",draggable:!0,buttons:u,onhidden:()=>{i()}}),d.focus()}})}}),function(e,t){t.extend(App.pcTableMain.prototype,{_orderSaveBtn:void 0,row_actions_add:function(){let e=this;e._table.on("click",".DataRow .id",(function(){e.isMobile&&e.row_actions_panel_show.call(e,t(this))})),e._table.on("click",".DataRow .id button.dropdown",(function(){e.row_dropdown.call(e,t(this))})),e._table.on("click",".DataRow .id .btn.chbox",(function(a){return e._row_actions_checkbox_click.call(e,t(this).closest("tr"),a.shiftKey),!1})),e._table.on("mouseleave",(function(){return t(this).blur(),!1})),e._table.on("click",".DataRow .id button.edit",(function(){e.rows_edit(t(this).closest("tr"))})),e._container.on("click",".row_delete, .row_restore, .row_duplicate, .row_refresh, .cycle_refresh",(function(){let a=t(this);a.is(".row_delete")?e.rows_delete.call(e,t(this).data("tr")):a.is(".row_restore")?e.rows_restore.call(e,t(this).data("tr")):a.is(".row_duplicate")?e.row_duplicate.call(e,t(this).data("tr")):a.is(".row_refresh")?e.row_refresh.call(e,t(this).data("tr")):a.is(".cycle_refresh")&&e.isCreatorView&&"cycles"===e.tableRow.type&&e.cycle_refresh.call(e,t(this).data("tr"))}))},_idCheckButton:t('<button class="btn btn-xxs chbox btn-default" data-action="checkbox"><span class="fa fa-square-o"></span></button>'),_checkStatusBar:t('<div class="check-status-bar"><span class="check-mark"> </span><span data-name="count_checked_rows">0</span><span class="from-mark">'+App.translate(" from ")+'</span><span data-name="count_visible_rows">0</span></div>'),_headCellIdButtonsState:function(){"use strict";let e=this;this.row_actions_get_checkedIds().length>0?t("table.pcTable-table").addClass("with-checks"):t("table.pcTable-table").removeClass("with-checks"),this.dataSortedVisible.filter(e=>"object"!=typeof e||e.row).length!==this.__checkedRows.length?e._idCheckButton.html('<span class="fa fa-square-o"></span>'):e._idCheckButton.html('<span class="fa fa-check"></span>'),this._refreshCheckedStatus(),e.ScrollClasterized.reloadScrollHead.call(e.ScrollClasterized)},_addCellId:function(e,a){let n=t('<td class="id"><span class="nm">'+e.id+"</span></td>");return n.appendTo(a),this.row_actions_icons_add(n),!0===e.$checked&&this.row_actions_check(e,!0),n},_addCellNo:function(e,a){let n=t('<td class="No">--</td>');return n.appendTo(a),n},row_actions_uncheck_all:function(){"use strict";let e=this,t=this.row_actions_get_checkedIds();for(let a=0;a<t.length;a++){let n=e._getItemById(t[a]);e.row_actions_uncheck.call(e,n,!0)}this.__checkedRows=[],this._headCellIdButtonsState()},_refreshCheckedStatus:function(){this._checkStatusBar.find('[data-name="count_checked_rows"]:first').text(this.__checkedRows.length),this._checkStatusBar.find('[data-name="count_visible_rows"]:first').text(this.dataSortedVisible.filter(e=>"object"!=typeof e||e.row).length)},_row_actions_checkbox_click:function(e,a){let n=this,i=e.closest("tr"),l=this._getItemByTr(i),s=t.extend({},n._lastcheckAction||{});if(n._lastcheckAction={id:l.id,isCheck:!l.$checked},a){const e=e=>t=>{if("object"!=typeof t)return t.toString()===e.toString()};let t,a=[];if(s.id&&!l.$checked===s.isCheck&&-1!==(t=n.dataSortedVisible.findIndex(e(s.id)))){let i=n.dataSortedVisible.findIndex(e(l.id));a=t<i?n.dataSortedVisible.slice(t+1,i+1):n.dataSortedVisible.slice(i,t)}else n.dataSortedVisible.some((function(e){if("object"!=typeof e&&(n.data[e].$checked?a=[]:a.push(e),e==l.id))return!0}));l.$checked?a.forEach((function(e){"object"!=typeof e&&(n.__checkedRows.splice(n.__checkedRows.indexOf(e),1),n.row_actions_uncheck(n.data[e],!0))})):a.forEach((function(e){"object"!=typeof e&&(n.__checkedRows.push(e),n.row_actions_check(n.data[e],!0))})),this._headCellIdButtonsState()}else l.$checked?this.row_actions_uncheck(l):this.row_actions_check(l)},row_actions_get_checkedIds:function(){return this.__checkedRows},row_actions_check:function(e,t,a){if(e.$checked=!0,e.$tr){e.$tr.find(".id:first").addClass("checked")}t||(a?this.__checkedRows.unshift(e.id):this.__checkedRows.push(e.id),this._headCellIdButtonsState())},row_actions_uncheck:function(e,t){e.$checked&&(e.$checked=!1,e.$tr&&($tdId=e.$tr.find(".id"),$tdId.removeClass("checked"),$tdId.find(".chbox i").attr("class","fa fa-square-o")),t||(this.__checkedRows.splice(this.__checkedRows.indexOf(e.id),1),this._headCellIdButtonsState()))},row_actions_icons_add:function(e){"use strict";let a,n;a=this.tableRow.panel?t('<button class="btn btn-default edit"><i class="fa fa-th-large"></i></button>').on("mouseleave",(function(){return t(this).blur(),!1})).css("margin-left",2):t(),this.control.editing&&(n=t('<button class="btn btn-default btn-xxs dropdown"  tabindex="-1" style=" margin-left: 2px;"><i class="fa fa-caret-down" style="font-size: 10px; width: 7px;"></i></button>'));let i=t('<button class="btn btn-default btn-xxs chbox"><i class="fa fa-square-o"></i></button>'),l=t('<span class="btn-group-xxs">');e.append(l).append(" ").append(i),n&&l.append(n),a&&l.append(a)},getRemoveTitle:function(e,t){switch(e){case"question_many":return"hide"===this.tableRow.deleting?App.translate("Surely to hide %s rows?",t):App.translate("Surely to delete %s rows?",t);case"question":return"hide"===this.tableRow.deleting?App.translate("Surely to hide the row?",t):App.translate("Surely to delete the row?",t);case"forTimer_many":return"hide"===this.tableRow.deleting?App.translate("Hiding %s rows",t):App.translate("Deleting %s rows",t);case"forTimer":return"hide"===this.tableRow.deleting?App.translate("Hiding the row %s",t):App.translate("Deleting the row %s",t);case"lower":return"hide"===this.tableRow.deleting?App.translate("Hide").toLowerCase():App.translate("Delete").toLowerCase();default:return"hide"===this.tableRow.deleting?App.translate("Hide"):App.translate("Delete")}},row_actions_panel_show:function(e){let a=e.closest("tr"),n=this._getItemByTr(a),i=n.id;const l=this;let s=t('<div id="row-mobile-panel"></div>');!0!==this.tableRow.panel?s.append(t('<div class="menu-item"><i class="fa fa-th-large"></i> '+App.translate("Open the panel")+"</div>").css("color","gray")):s.append(t('<div class="menu-item row_panel"><i class="fa fa-th-large"></i> '+App.translate("Open the panel")+"</div>").attr("data-tr",i)),!0!==this.control.duplicating||this.f.blockduplicate||n.f.blockduplicate?s.append(t('<div class="menu-item"><i class="fa fa-clone"></i> '+App.translate("Duplicate")+"</div>").css("color","gray")):s.append(t('<div class="menu-item row_duplicate"><i class="fa fa-clone"></i> '+App.translate("Duplicate")+"</div>").attr("data-tr",i)),-1!==["calcs","globcalcs"].indexOf(this.tableRow.type)?s.append(t('<div class="menu-item"><i class="fa fa-refresh"></i> '+App.translate("Recalculate")+"</div>").css("color","gray")):s.append(t('<div class="menu-item row_refresh"><i class="fa fa-refresh"></i> '+App.translate("Recalculate")+"</div>").attr("data-tr",i)),!this.control.deleting||this.f.blockdelete||n.f&&(n.f.block||n.f.blockdelete)?s.append(t('<div class="menu-item"><i class="fa fa-times"></i> '+this.getRemoveTitle()+"</div>").css("color","gray")):s.append(t('<div class="menu-item row_delete"><i class="fa fa-times"></i> '+this.getRemoveTitle()+"</div>").attr("data-tr",i));let o=App.mobilePanel(n[this.mainFieldName].v||"id: "+i,s);s.on("click",".row_delete, .row_duplicate, .row_refresh, .row_panel",(function(){let e=t(this);e.is(".row_delete")?l.rows_delete.call(l,i):e.is(".row_duplicate")?l.row_duplicate.call(l,i):e.is(".row_refresh")?l.row_refresh.call(l,i):e.is(".row_panel")&&l.rows_edit.call(l,a),o.close()}))},table_modify:function(e,a,n){"use strict";let i=this,l=0,s=0,o=n?n.data("field"):void 0;if(i.isPanel&&e.chdata&&delete e.chdata.params,a&&(l=i.dataSorted.indexOf(a)+1,s=i.dataSortedVisible.indexOf(a)+1),e.chdata){let n=e.chdata.deleted||[],r=[];if(e.chdata.rows){if(e.refresh&&e.chdata.rows&&Object.keys(i.data).forEach((function(t){void 0===e.chdata.rows[t]&&n.push(parseInt(t))})),e.chdata.tree){let t={};e.chdata.tree.forEach((e,a)=>{this.getTreeBranch(e,a),t[e.v]=!0}),e.refresh&&Object.keys(this.treeIndex).forEach(e=>{e&&!t[e]&&(this.removeTreeBranch(e),this.treeRefresh=!0)})}if(t.each(e.chdata.rows,(function(e,t){let a=i._getItemById(t.id);void 0===a?r.push(t):i.refreshRow(a.$tr,a,t)})),r.length){App.isEmpty(i.data)&&i._content&&i._content.find(".pcTable-noDataRow").remove();let n=[];!0===i.tableRow.order_desc&&(r=r.reverse()),t.each(r,(function(t,o){if(o.$visible=!0,o.$checked=!1,l||!i.tableRow.with_order_field||i.tableRow.new_row_in_sort||(o.__inserted=!0),i.data[o.id]=o,i.isTreeView)i.placeInTree(o,null,!0),this.treeRefresh=!0;else{let t=l,r=s;!o.__after||a&&a.id===o.__after?"order"in e.chdata&&n.push(o.id):(t=i.dataSorted.indexOf(o.__after)+1,r=i.dataSortedVisible.indexOf(o.__after)+1),i.dataSorted.splice(t,0,o.id),i.dataSortedVisible.splice(r,0,o.id),l++,s++}})),a&&!i.isMobile&&setTimeout((function(){t.each(r,(function(e,t){i.row_actions_check(i.data[t.id])}))}),50)}i.selectedCells&&i.selectedCells.summarizer.check()}if(n.length&&(t.each(n,(function(e,t){i._deleteItemById.call(i,t)})),App.isEmpty(i.data)&&i._content&&0===i._content.find("."+this.noDataRowClass).length&&i._content.append(i._createNoDataRow())),n.length||r.length||e.chdata.nsorted_ids&&i.nSorted&&!Object.equals(e.chdata.nsorted_ids,i.dataSorted)){if(e.chdata.nsorted_ids&&i.nSorted){let t=i.dataSortedVisible;i.dataSorted=e.chdata.nsorted_ids,t.length===i.dataSorted.length?i.dataSortedVisible=i.dataSorted:(i.dataSortedVisible=[],i.dataSorted.forEach((function(e){-1!==t.indexOf(e)&&i.dataSortedVisible.push(e)})))}this._refreshContentTable(0,!1,!0),this._container.getNiceScroll().resize()}e.chdata.order&&(this.dataSorted=e.chdata.order,i.dataSortedVisible=[],i.dataSorted.forEach(e=>{this.data[e].$visible&&i.dataSortedVisible.push(e)}),this._refreshContentTable(0,!1,!0));let d={};e.chdata.params&&t.each(e.chdata.params,(function(e,t){["v","v_","f","e","h","c","ch"].forEach((function(a){i.data_params[e]&&(void 0!==t[a]||i.data_params[e][a])&&(Object.equals(i.data_params[e][a],t[a])&&e!==o||(d[e]=a,i.data_params[e][a]=t[a]))}))})),e.chdata.fields&&t.each(e.chdata.fields,(function(e,a){a.list&&!Object.equals(i.fields[e].list,a.list)&&(d[e]=!0,t.extend(i.fields[e],a))})),(e.chdata.params||e.chdata.fields)&&(i._refreshParamsBlock(d,!0),i._refreshFootersBlock(d,!0),i.f&&i.f.buttons&&i.f.buttons.some&&i.f.buttons.some(e=>(i._rowsButtons(),!0))),e.chdata.f&&this.apptyTableFormats(e.chdata.f),App.isEmpty(i.data)&&i._content&&i._content.empty().append(this._createNoDataRow()),this.treeRefresh&&this.treeApply()}e.updated&&(i.model.tableData.updated=JSON.parse(e.updated),i._refreshTitle()),i.isPanel||(e.filtersString&&i._refreshFiltersBlock.call(i,e),i._headCellIdButtonsState(),i.ScrollClasterized.insertToDOM(null,!0))},apptyTableFormats:function(e){["blockadd","buttons","blockdelete","blockorder","background","blockduplicate","block","tabletitle","rowstitle","fieldtitle","tablecomment","tabletext"].forEach(t=>{if(t in e||t in this.f)if("object"==typeof e[t]){if(!Object.equals(e[t],this.f[t])){let a=Object.assign({},this.f[t]);this.f[t]=e[t],this.__formatFunctions[t]&&this.__formatFunctions[t].call(this,e[t],a)}}else e[t]!==this.f[t]&&(this.f[t]=e[t],this.__formatFunctions[t]&&this.__formatFunctions[t].call(this,e[t]))}),this.applyOrder(e.order),this.applyHideRows(e.hideRows,e.showRows)},applyOrder:function(e){if(e&&e.length){let t={},a=[];this.dataSorted.forEach(n=>{let i=e.indexOf(n);-1!==i?t[i]=n:a.push(n)}),this.dataSorted=[...Object.values(t),...a],this.__applyFilters(!0)}},applyHideRows:function(e,t){if(e&&e.length||t&&t.length){e=e||[],t=t||[];let a=this.filters.id||[];a.length?t.forEach(e=>{-1!==a.indexOf(e)&&-1===this.dataSorted.indexOf(parseInt(e))||a.push(e.toString())}):(a=[...this.dataSorted],t=[]);let n=[];a.forEach(t=>{e.some(e=>e.toString()===t.toString())||n.push(t.toString())}),n.length===this.dataSorted.length?delete this.filters.id:this.filters.id=n,this.__applyFilters(!0)}},rows_edit:function(e){"use strict";let t=this,a=this.row_actions_get_checkedIds();if(e){let n=t._getItemByTr(e).id,i=a.indexOf(n);-1===i?(this.row_actions_check(t._getItemByTr(e),!1,!0),a=this.row_actions_get_checkedIds()):(a.splice(i,1),a.unshift(n))}return t._row_edit.call(t,a.slice()),!1},row_dropdown:function(e){"use strict";let a=t("<div>"),n=this._getItemByTr(e.closest("tr")),i=n.id;!0!==this.control.duplicating||this.f.blockduplicate||n.f.blockduplicate?a.append(t('<div class="menu-item"><i class="fa fa-clone"></i> '+App.translate("Duplicate")+"</div>").css("color","gray")):a.append(t('<div class="menu-item row_duplicate"><i class="fa fa-clone"></i> '+App.translate("Duplicate")+"</div>").attr("data-tr",i)),-1!==["calcs","globcalcs"].indexOf(this.tableRow.type)?a.append(t('<div class="menu-item"><i class="fa fa-refresh"></i> '+App.translate("Recalculate")+"</div>").css("color","gray")):a.append(t('<div class="menu-item row_refresh"><i class="fa fa-refresh"></i> '+App.translate("Recalculate")+"</div>").attr("data-tr",i)),this.isCreatorView&&"cycles"===this.tableRow.type&&a.append(t('<div class="menu-item cycle_refresh color-danger"><i class="fa fa-refresh"></i> '+App.translate("Recalculate cycle")+"</div>").attr("data-tr",i)),this.isRestoreView?a.append(t('<div class="menu-item row_restore"><i class="fa fa-recycle"></i> '+App.translate("Restore")+"</div>").attr("data-tr",i)):!this.control.deleting||this.f.blockdelete||n.f&&(n.f.block||n.f.blockdelete)?a.append(t('<div class="menu-item"><i class="fa fa-times"></i> '+this.getRemoveTitle()+"</div>").css("color","gray")):a.append(t('<div class="menu-item row_delete"><i class="fa fa-times"></i> '+this.getRemoveTitle()+"</div>").attr("data-tr",i));let l=App.popNotify({isParams:!0,$text:a,element:e,container:this._container,trigger:"manual",placement:"bottom"});return t("#"+l).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",(function(){a.remove()})).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px"),!1},__getCheckedRowsIds:function(e,a,n){"use strict";let i=this,l=this.row_actions_get_checkedIds();if(e&&-1===l.indexOf(e)){let t=i.data[e];this.row_actions_check(t),l=this.row_actions_get_checkedIds()}if(a){let e=!1;if(l.some((function(t){if(i.data[t].f&&(i.data[t].f.block||i.data[t].f[n]))return e=i.data[t],!0})),e){let a="";"id"!==i.mainFieldName&&(a=e[i.mainFieldName]._v?e[i.mainFieldName]._v:e[i.mainFieldName].v,a=' "'+a+'"');let n=t("<span>").html(App.translate("Row <b>id %s %s</b> is blocked",[e.id,a]));return App.notify(n,App.translate("Action not executed")),!1}}return l},getRowTitle(e){return"id"!==this.mainFieldName?e[this.mainFieldName]._v?e[this.mainFieldName]._v:e[this.mainFieldName].v:e.id},row_refresh:function(e){"use strict";let t=this,a=this.__getCheckedRowsIds(e,!1),n=1===a.length?a[0]:null;if(a&&a.length){let e=[{label:App.translate("Recalculate"),action:function(e){t.model.refresh_rows(a).then((function(a){t.table_modify.call(t,a),e.close(),t.row_actions_uncheck_all()}))}},{label:App.translate("Cancel"),action:function(e){e.close()}}];BootstrapDialog.show({message:App.translate("Surely to recalculate %s rows?",a.length),title:App.translate("Recalculating"),buttons:e,onhidden:function(){1===a.length&&a[0]==n&&t.row_actions_uncheck_all()},draggable:!0})}},cycle_refresh:function(e){"use strict";let t=this,a=this.__getCheckedRowsIds(e,!1);if(a&&a.length){let e=[{label:App.translate("Recalculate"),action:function(e){t.model.refresh_cycles(a).then((function(a){t.table_modify.call(t,a),e.close(),t.row_actions_uncheck_all()}))}},{label:App.translate("Cancel"),action:function(e){e.close()}}];BootstrapDialog.show({message:App.translate("Surely to recalculate %s cycles?",a.length),title:App.translate("Recalculating"),buttons:e,draggable:!0})}},row_duplicate:function(e){"use strict";let a=this,n=this.__getCheckedRowsIds(e,!1);if(n&&n.length){let i=[{label:App.translate("Duplicate"),cssClass:"btn-danger",action:function(i){let l={},s=[],o=[];a.dataSortedVisible.forEach((function(e){let t=parseInt(e);"object"==typeof e&&e.row&&(t=parseInt(e.row.id)),-1!==n.indexOf(t)&&o.push(t)}));const r=function(t){a.model.duplicate(o,l,e).then((function(n){a.table_modify.call(a,n,e),t&&t.close(),i.close(),a.row_actions_uncheck_all()}))};for(let e in a.fieldCategories.column){let t=a.fieldCategories.column[e];"unic"===t.type&&s.push(t.name)}if(s.length){let e,n=t('<table class="simpleTable"><thead><tr><td class="id">id</td></tr></thead><tbody></tbody></table>'),d=n.find("thead tr"),c=n.find("tbody");"id"!==a.mainFieldName&&(e=a.fields[a.mainFieldName],"unic"!==e.type?d.append(t("<td></td>").text(e.title)):e=null);for(let e in s){let n=a.fields[s[e]];d.append(t("<td></td>").text(n.title))}for(let n in o){let i=o[n],r=a.data[i],d=t("<tr>");l[i]={},d.append(t('<td class="id"></td>').text(i)),e&&d.append(t("<td></td>").text(r[e.name].v));for(let e in s){let n,o=a.fields[s[e]],c=t('<td class="input"></td>'),p=t("<input>").val(r[o.name].v);l[i][o.name]=r[o.name].v,p.on("keyup",(function(){let e=t(this).val();l[i][o.name]=e,n&&(clearTimeout(n),n=null),""!==e?n=setTimeout((function(){a.model.checkUnic(o.name,e).then((function(e){e.ok?c.addClass("ok"):c.removeClass("ok")}))}),300):o.required?c.removeClass("ok"):c.addClass("ok")})),c.html(p),d.append(c)}c.append(d)}let p=[{label:App.translate("Duplicate"),cssClass:"btn-m btn-warning",action:function(e){r(e)}},{label:App.translate("Cancel"),action:function(e){e.close(),i.close()}}];BootstrapDialog.show({message:n,title:App.translate("Fill in the values for unique fields"),buttons:p,draggable:!0})}else r()}},{label:App.translate("Cancel"),action:function(e){e.close()}}];BootstrapDialog.show({message:App.translate("Surely to duplicate %s rows?",n.length),title:App.translate("Duplicating"),buttons:i,draggable:!0})}},rows_delete:function(e){let t=this,a=this.__getCheckedRowsIds(e,!0,"blockdelete"),n=1===a.length?a[0]:null;if(a&&a.length){let e=this.getRemoveTitle("question_many",a.length),i=this.getRemoveTitle("forTimer_many",a.length);if(1==a.length){let n="id-"+a[0];"id"!=t.mainFieldName&&(n=t.data[a[0]][t.mainFieldName],n="id-"+a[0]+' "'+(n.v_&&n.v_[0]?n.v_[0]:n.v)+'"'),e=this.getRemoveTitle("question"),i=this.getRemoveTitle("forTimer",n)}let l=[{label:this.getRemoveTitle(),cssClass:"btn-danger",action:function(e){e.close();const n=function(){t.model.delete(a).then((function(e){t.table_modify.call(t,e)}))};t.tableRow.delete_timer>0?App.panelTimer(i,t.tableRow.delete_timer,n):n()}},{label:App.translate("Cancel"),action:function(e){e.close()}}];BootstrapDialog.show({message:e,title:i,buttons:l,onhidden:function(){1===a.length&&a[0]==n&&t.row_actions_uncheck_all()},draggable:!0})}},rows_restore:function(e){let t=this,a=this.__getCheckedRowsIds(e),n=1===a.length?a[0]:null;if(a&&a.length){let e=App.translate("Surely to restore %s rows?",a.length);if(1==a.length){let n="id-"+a[0];"id"!=t.mainFieldName&&(n=t.data[a[0]][t.mainFieldName],n="id-"+a[0]+' "'+(n.v_&&n.v_[0]?n.v_[0]:n.v)+'"'),e=App.translate("Surely to restore the row %s?",n)}let i=[{label:App.translate("Restore"),cssClass:"btn-danger",action:function(e){e.close(),t.model.restore(a).then((function(e){t.table_modify.call(t,e)}))}},{label:App.translate("Cancel"),action:function(e){e.close()}}];BootstrapDialog.show({message:e,title:App.translate("Restoring"),buttons:i,onhidden:function(){1===a.length&&a[0]==n&&t.row_actions_uncheck_all()},draggable:!0})}}})}(0,jQuery),t.extend(App.pcTableMain.prototype,{_insertItem:null,_insertRow:null,_insertRowActive:!1,_insertButtons:null,_insertRowHash:null,_addButtons:null,_insertError:{},_currentInsertCellIndex:0,_InsertFocusFalse:!1,isInsertable:function(){return this.control.adding&&!this.f.blockadd&&!this.isRestoreView},_addInsert:function(e){this.control.adding&&(this._insertRow&&this._insertRow.length||(this._insertRow=this._createInsertRow(null,0,e),this._insertRowActive=!0,this._insertButtonsChangeStatuses(),this._beforebody.prepend(this._insertRow),this._table.addClass("with-adding-row")))},_insertButtonsChangeStatuses:function(){this._insertRow?(this._insertButtons&&this._insertButtons.find('[data-action="add"]').removeClass("btn-warning").addClass("btn-default").attr("disabled","disabled"),0===this.dataSortedVisible.length&&this._table.find(".pcTable-noDataRow button").removeClass("btn-warning").addClass("btn-default").attr("disabled","disabled")):(this._insertButtons&&this._insertButtons.find('[data-action="add"]').addClass("btn-warning").removeClass("btn-default").removeAttr("disabled"),0===this.dataSortedVisible.length&&this._table.find(".pcTable-noDataRow button").addClass("btn-warning").removeClass("btn-default").removeAttr("disabled"))},_InsertAddInsertBtnsPanel:function(e){let a,n=this,i={};i['<span id="saveInsertRow">'+App.translate("Save")+"</span>"]=function(){a.is(".onSaving")||(a.addClass("onSaving"),n.__insertRowActions("saveInsertRow",(function(){n._saveInsertRow("close").always((function(){a.removeClass("onSaving")}))})))},i['<i class="fa fa-save"></i>']=function(){a.is(".onSaving")||(a.addClass("onSaving"),n.__insertRowActions("saveInsertRow",(function(){n._saveInsertRow.call(n).always((function(){a.removeClass("onSaving")}))})))},i['<i class="fa fa-paste"></i>']=function(){a.is(".onSaving")||(a.addClass("onSaving"),n.__insertRowActions("saveInsertRow",(function(){n._saveInsertRow.call(n,"notClean").always((function(){a.removeClass("onSaving")}))})))},i['<i class="fa fa-times"></i>']=function(){n._closeInsertRow.call(n,t(this).closest("#"+s))},a=this._addRowPanel(s,e,i),this._addButtons=a.find("button:not(:last)")},__insertRowActionsStack:[],__insertRowActions:function(e,t){"use strict";let a=this;-1!==["saveInsertRow","clickSourceButton"].indexOf(e)&&setTimeout((function(){a.model.getDefferedProcess().then(t)}),450)},_saveInsertRow:function(e){let a=this,n=t.Deferred();if(Object.keys(a._insertError).length){let e=Object.keys(a._insertError)[0],i=a._insertError[e];App.notify(i,t("<div>"+App.translate("Error in %s field",t("<span>").text(a.fields[e].title||a.fields[e].name)).html())+"</div>"),a._currentInsertCellIndex=a.fieldCategories.visibleColumns.findIndex((function(t){if(t.name===e)return!0})),a._insertFocusIt(),n.reject()}else{let t=function(){a._insertRowActive=!1,a.model.add(a._insertRowHash).then((function(t){switch(a.table_modify.call(a,t),a._insertRowHash=null,a._insertRowActive=!0,a._currentInsertCellIndex=0,e){case"notClean":let e={};Object.keys(a._insertItem).forEach(t=>{"object"==typeof a._insertItem[t]&&"v"in a._insertItem[t]&&(e[t]=a._insertItem[t].v)}),a._createInsertRow(a._insertRow,!0,e);break;case"close":a._closeInsertRow();break;default:a._insertItem=null,a._insertRow.html('<td class="id"></td>'),a._createInsertRow(a._insertRow,0)}})).always((function(){n.resolve()})).fail(()=>{a._insertRowActive=!0})};a.model.doAfterProcesses(t)}return n.promise()},_addInsertRow:function(){let t=this;"cycles"===this.tableRow.type?t.model.add({}).then((function(a){a.firstTableId?e.location.href=e.location.pathname+"/"+a.chdata.rows[0].id+"/"+a.firstTableId:t.table_modify(a)})):t.isMobile?t._addInsertWithPanel():t._addInsert()},_getInsertButtons:function(){let a,n,i=this;"cycles"===this.tableRow.type?n=a=function(){i.model.add({}).then((function(t){t.firstTableId?e.location.href=e.location.pathname+"/"+t.chdata.rows[0].id+"/"+t.firstTableId:i.table_modify(t)}))}:(a=function(){i.isMobile?i._addInsertWithPanel():i._addInsert()},n=function(){i._addInsertWithPanel()}),this._insertButtons=t("<span>");const l=(e,a,n)=>t("<button "+(n?'data-action="'+n+'"':"")+' class="btn btn-sm btn-warning">'+e+"</button>").appendTo(this._insertButtons).on("click",a);return this.isTreeView&&"cycles"===this.tableRow.type||("panels"===this.viewType||this.isRotatedView||this.isTreeView?l(App.translate("Add"),n,"add").width(80):(2!==this.tableRow.id&&l(App.translate("Add"),a,"add").width(80),!i.isMobile&&this.tableRow.panel&&l('<i class="fa fa-th-large"></i>',n).css("margin-left",5))),this._insertButtons},_addInsertWithPanel:function(e){let t=this;new EditPanel(t,null,e||{}).then((function(e){e&&t.table_modify.call(t,e)}))},_closeInsertRow:function(){this._insertPanel?this._insertPanel=null:this._insertRow&&(this._insertRow.find("td").each((function(){t(this).remove()})),this._insertRow.remove(),this._insertRow=null,this._insertRowHash=null,this._insertRowActive=!1),this._insertItem=null,this._insertButtonsChangeStatuses(),this._currentInsertCellIndex=0,this._table.removeClass("with-adding-row")},_createInsertRow:function(e,a,n){var i=this,s=i._insertItem||(i._insertItem={});e||(this.insertRow=e=t('<tr class="InsertRow" style="height: 35px;"><td class="id"></td></tr>').on("click focus","input,button,select",(function(e){let a=t(this),n=i._insertRow.find(".active");n.length&&("click"!==e.type||a.is('[type="checkbox"]')||n===t(this).closest("td"))||(n.removeClass("active"),i._currentInsertCellIndex=t(this).closest("td").data("index"),t(this).closest("td").addClass("active"))})),this._InsertAddInsertBtnsPanel(e),this.insertRow.editedFields={}),i._currentInsertCellIndex||(i._currentInsertCellIndex=0);let o={};n&&(o="object"==typeof n?n:{[n]:i._insertItem[n].v});let r=[];return i.fieldCategories.visibleColumns.forEach((function(e){r.push(e.name)})),i.model.checkInsertRow(o,i._insertRowHash,this.insertRow.clearField).then((function(a){i.insertRow.clearField=null,i._insertRowHash=i._insertRowHash||a.hash,s=a.row;let o=2;t.each(i.fieldCategories.column,(function(a,d){if(!d.showMeWidth)return void(i._insertItem[d.name]=s[d.name]);let c=r.indexOf(d.name);var p=e.find("td:eq("+(c+1)+")");let f=t.extend(!0,{},i._insertItem[d.name]),h=i._insertItem[d.name]&&i._insertItem[d.name].force;if(i._insertItem[d.name]=s[d.name],p.length){let t="n"===d.name||i._insertItem[d.name].f&&!0===i._insertItem[d.name].f.block;if(p.data("input")&&!t){d.name;let t=!1;t=!h&&(null===s[d.name].v&&""==f.v||Object.equals(s[d.name].v,f.v)&&!d.codeSelectIndividual),(void 0===f||!t||"data_src"==d.name||"comments"==d.type||d.code&&!d.codeOnlyInAdd)&&(i._createInsertCell.call(i,p,d,e,c,"td",i._createInsertRow),n===d.name&&i._colorizeElement(p,l))}else p.replaceWith(i._createInsertCell.call(i,null,d,e,c,"td",i._createInsertRow))}else e.append(p=i._createInsertCell.call(i,null,d,e,c,"td",i._createInsertRow));p.data("input")&&p.data("input").attr("tabindex",o++)})),i._addButtons.each((function(e,a){t(a).attr("tabindex",o++)})),i._insertFocusIt.call(i)})),e},_createInsertCell:function(a,n,l,s,o,r){var d=this;o=o||"td",(a=a||t("<"+o+">").each((e,a)=>{$_td=t(a),n.help&&$_td.on("focus","input,button,select",(function(e){let a=d._table.find("thead th #field-help-"+n.name),i=t(e.target);setTimeout((function(){a.trigger("open"),i.one("blur remove",(function(){a.trigger("close")}))}),120)})),$_td.on("focus","input,button,select",()=>{this._InsertFocusFalse=Date.now()})})).data("index",s),n.code&&a.addClass("with-code"),void 0===d._insertItem[n.name]&&(d._insertItem[n.name]=null);let c=d._insertItem[n.name]&&d._insertItem[n.name].f||{};if(!n.insertable||!0===c.block){let e=d._insertItem[n.name];if(e&&(e=e.v),a.empty().append(t('<span class="cell-value">').html(c.text?c.text:n.getCellText(e,a,d._insertItem))),c.comment){let e=t('<i class="fa fa-info pull-right" style="padding: 3px;">');e.attr("title",c.comment),a.prepend(e)}else if(c.icon&&"button"!==n.type){let e=t('<i class="fa fa-'+c.icon+' pull-right" style="padding: 3px;">');a.prepend(e)}return(c.icon||c.text||c.comment)&&a.on("click",()=>{let i=t("<div>"),l=t("<div>").text(e).appendTo(i);if(c.icon){let e=t('<i class="fa fa-'+c.icon+'" style="padding: 3px;">');l.prepend(e)}if(c.text){let e=t('<div><i class="fa fa-font" style="padding: 3px;"> </div>');e.append(c.text),i.append(e)}if(c.comment){let e=t('<div><i class="fa fa-info" style="padding: 3px;"> </div>');e.append(c.comment),i.append(e)}if(!d.isMobile){let e="right",n=i.offset().left,l=d._container.offset().left;d._container.width()-(n-l)-i.width()<(i.is(".text")?340:240)&&(e="left");let s={isParams:!0,$text:i,element:a,container:d._container,placement:e,trigger:"manual"};App.popNotify(s);let o="keyup.insertPanelDestroy",r="click.insertPanelDestroy";const c=function(){t("body").off(".selectPanelDestroy"),a.popover("destroy")};return t("body").on(r,(function(e){0===t(e.target).closest("#selectPanel").length&&c()})).on(o,(function(e){27==e.which&&c()})),!1}App.mobilePanel(n.title,i)}),a}var p=function(e){var t;try{t=n.getEditVal(e),delete d._insertError[n.name],m.removeClass("error")}catch(e){return m.addClass("error"),d._insertError[n.name]=e,null}return t},f=function(e,t,i){var c=p(e);d._currentInsertCellIndex=s+1,null===c||i?(r.call(d,l,d._currentInsertCellIndex,n.name),d._insertFocusIt.call(d)):n.isDataModified(c,d._insertItem[n.name].v)?(d.insertRow.editedFields[n.name]=!0,d._insertItem[n.name].v=c,!0===n.isPanelField&&d._createInsertCell.call(d,a,n,l,s,o,r),r.call(d,l,d._currentInsertCellIndex,n.name)):d._insertFocusIt.call(d)},h=function(e,t,a,i){i&&(d._currentInsertCellIndex=s+(-1===i?-1:1),d._insertFocusIt.call(d)),setTimeout((function(){if(!e)return;let t=e.closest("td");if(!t.length||!t.closest("tr").length)return!1;let a=p(e);n.isDataModified(a,d._insertItem[n.name].v)&&(d._currentInsertCellIndex=s+1,d.insertRow.editedFields[n.name]=!0,d._insertItem[n.name].v=a,!0===n.isPanelField&&d._createInsertCell.call(d,t,n,l,s,o,r),r.call(d,l,d._currentInsertCellIndex,n.name))}),150)},u=function(e,t){let a=e.closest("td");if(!a.length||!a.closest("tr").length)return!1;let c=p(e),f=d._insertItem[n.name].v+"";n.isDataModified(c,f)&&(d._createInsertCell(a,n,l,s,o,r),d._colorizeElement(a,i)),d._currentInsertCellIndex=s+1,d._insertFocusIt.call(d)};let m=n.getEditElement(a.data("input"),d._insertItem[n.name],d._insertItem,f,u,h);if(c&&c.placeholder&&n.addPlaceholder&&n.addPlaceholder(m,c.placeholder),m.isAttached()||a.html(m).data("input",m),n.code&&!n.codeOnlyInAdd){let e=a.find(".fa-hand-paper-o");d._insertItem&&d._insertItem[n.name].h?0===e.length&&(e=t('<i class="fa fa-hand-paper-o pull-right">').on("click",()=>{this.insertRow.clearField=n.name,r.call(d,l,d._currentInsertCellIndex+1)}),a.prepend(e).addClass("ins-handed")):(1===e.length&&e.remove(),a.removeClass("ins-handed"))}if("select"===n.type&&2===n.changeSelectTable){a.addClass("with-source-add-button");let i=t('<button class="btn btn-default btn-sm source-add" tabindex="-1"><i class="fa fa-plus"></i></button>');a.prepend(i);let s=function(){let i={},s=d._insertItem;t.each(s,(function(e,t){"$"!==e.substring(0,1)&&(i[e]=t)}));i[n.name]=null;let o=0;return t(e.top.document.body).on("pctable-opened.select-add-"+n.name,(function(){o++})).on("pctable-closed.select-add-"+n.name,(function(e,i){o--;let c=i&&"insert"===i.method&&i.json&&i.json.chdata&&i.json.chdata.rows;if(0===o||c){let e=m;delete n.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),c&&(n.multiple?s[n.name].v.push(Object.keys(i.json.chdata.rows)[0]):s[n.name].v=Object.keys(i.json.chdata.rows)[0]),e.replaceWith(m=n.getEditElement(e,s[n.name],s,f,u,h)),t("body").off(".select-add-"+n.name),a.data("input",m),r.call(d,l,d._currentInsertCellIndex,n.name)}})),d.model.selectSourceTableAction(n.name,i),!1};i.on("click",(function(){d.__insertRowActions("clickSourceButton",s)}))}return a},_insertFocusIt:function(e){let a=this;if(this._InsertFocusFalse&&Date.now()-this._InsertFocusFalse<200)return!1;if(!e)return setTimeout((function(){a._insertFocusIt.call(a,1)}),10),!1;let n=!0,i=!!this._insertPanel,l=this.insertRow;if(i){if(!a._insertPanel)return!1;l=a._insertPanel.$modalBody}if(!l||!l.length)return!1;if(t.each(a.fieldCategories.visibleColumns,(function(e,t){if(a._currentInsertCellIndex==e)return!t.insertable||a._insertItem&&a._insertItem[t.name]&&a._insertItem[t.name].f&&!0===a._insertItem[t.name].f.block?void a._currentInsertCellIndex++:(i?t.focusElement(l.find(".cell:eq("+e+")").data("input")):t.focusElement(a._getTdByColumnIndex(l,e+1).data("input")),n=!1,!1)})),n)if(this.insertRow.find("td.active").removeClass("active"),i){a._insertPanel.indexedButtons[Object.keys(a._insertPanel.indexedButtons)[0]].focus()}else t("#saveInsertRow").parent().focus()}}),t.extend(App.pcTableMain.prototype,{_rerenderColumnsFooter:function(){let e=this._createFootersTableBlock();this._footersBlock.replaceWith(e),this._footersBlock=e},_rerendParamsblock:function(){this._createParamsBlock(),this.isMobile&&this._refreshParamsBlock()},_rerendFiltersBlock:function(){this._filtersBlock.replaceWith($block=this._createFiltersBlock()),this._filtersBlock=$block,this._refreshFiltersBlock(this.data_params)},_rerendBottomFoolers:function(){this._createFootersSubtable(),this.isMobile&&this._refreshFootersBlock()},_renderTable:function(){let e=this;this._table=t("<table>").addClass(this.tableClass),this.notCorrectOrder&&this._table.addClass("no-correct-n-filtered"),this.isRotatedView?(this._innerContainer.addClass("rotatedPcTable"),this._table.append(this._createHead()).append(this._createBody())):this._table.append(this._createHead()).append(this._createFirstBody()).append(this._createBody()).append(this._createAfterBody()),this._footersBlock=this._createFootersTableBlock(),this._table.append(this._footersBlock),this._popovers=t('<div class="popovers">'),e.isTreeView?(e._connectTreeView.call(e),"other"===this.fields.tree.treeViewType&&this.addReOrderRowBind()):this.addReOrderRowBind(),1===this.fieldCategories.column.length&&e._container.addClass("no-fields");let a=this.scrollWrapper=this._container.append('<div class="pcTable-scrollwrapper">').find(".pcTable-scrollwrapper");a.append(this._createBeforeSpace()).append(this._createTableText()),this.isCreatorView&&a.append(this._refreshHiddenFieldsBlock()),this._paramsBlock=this._createParamsBlock(a);let n=t('<div class="pcTable-rowsWrapper">').appendTo(a);n.append(this._createRowsTitle(n)).append(this._createFiltersBlock()).append(()=>{if(!this.isTreeView&&this.tableRow.pagination&&"0/0"!==this.tableRow.pagination)return this._pagination()}).append(this._rowsButtons()).append(this._innerContainer),this._footersSubTable=this._createFootersSubtable(a),a.append(this._footersSubTable).append(this._popovers),this.addScrollsRules(),this._seeCalcucatedValData(),this._seeSelectPreview(),this._clickstoCopyMe(),this.isCreatorView&&this._hideHell_storage.checkIssetFields.call(this)},_refreshHiddenFieldsBlock:function(){let e=this._hiddenFieldsBlock();return this.HiddenFieldsBlock&&this.HiddenFieldsBlock.replaceWith(e),this.HiddenFieldsBlock=e,this.HiddenFieldsBlock},_hiddenFieldsBlock:function(){let e,a,n=this,i=0,l=t('<div class="pcTable-hiddenFieldsTables">'),s=0;if(this.beforeSpaceHide||!this._hideHell_storage.getOpened.call(this))return l;let o=this._container.width()-100;return t.each(n.hidden_fields||[],(function(r,d){i++;let c=d.width>0?d.width:100;(0===s||o<s+c)&&(e&&e.width(s),e=t("<table class='pcTable-hiddenFieldsTable'><thead><tr></tr></thead></table>\""),l.append(e),s=0,a=e.find("thead tr")),a.append(n._createHeadCell(r,d)),s+=d.width})),n.isCreatorView&&Object.keys(n.fields).forEach((function(r,d){let c=n.fields[r];if(c.showInWeb&&c.showMeWidth<1&&"n"!==c.name){i++;let r=c.width>0?c.width:100;(0===s||o<s+r)&&(e&&e.width(s),e=t("<table class='pcTable-hiddenFieldsTable'><thead><tr></tr></thead></table>\""),l.append(e),s=0,a=e.find("thead tr")),a.append(n._createHeadCell(d,c)),s+=c.width}})),e&&e.width(s),i?l:t('<div class="pcTable-hiddenFieldsTables">')},_clickstoCopyMe:function(){this._container.on("click",".copy_me",(function(){let e=t(this);return e.data("clicked")||(e.data("clicked",!0),e.width(e.width()),e.data("text")?App.copyMe(e.data("text")):App.copyMe(e.text()),e.button("copied"),setTimeout((function(){e.button("reset"),e.removeData("clicked")}),2e3),e.blur(),t("body").click()),!1}))},_seeCalcucatedValData:function(){var e=this;this._container.on("mouseover","td .fa-hand-paper-o",(function(){if(!e.isMobile){var a=t(this),n=a.closest("td");if(n.closest("tr").is(".InsertRow"))return!1;var i=e._getItemBytd(n),l=e._getFieldBytd(n),s=t("<div>");let o="";null===i[l.name].c||""===i[l.name].c||void 0===i[l.name].c?o="":"select"===l.type?l.multiple?t.each(i[l.name].c,(function(e,t){""!==o&&(o+=", "),o+=l.getElementString(i[l.name].c[e],i[l.name].c_[e])})):o=l.getElementString(i[l.name].c,i[l.name].c_):(o=l.getCellText(i[l.name].c,null,i,e),"object"==typeof o&&(o=o.text())),s.append(t("<div>"+App.translate("Calculated value")+": </div>").append(t("<code>").text(o))),a.one("mouseout",(function(){s.length&&(s.remove(),s=null)})),setTimeout((function(){s&&s.length&&App.popNotify(s,a)}),500)}}))},_seeSelectPreview:function(){var e=this;t("body").on("mouseover",".select-with-preview li",(function(a){let n=t(this),i=setTimeout((function(){if(n.is(":hover")){let t=n.find("span.select-with-preview");e.fields[t.data("field")]&&e.fields[t.data("field")].previewPanel.call(e.fields[t.data("field")],t,n)}}),300);n.one("mouseout",(function(){i&&clearTimeout(i)}))}))},_getFavoriteStar:function(){let e=this.tableRow.__is_in_favorites=this.tableRow.__is_in_favorites||!1,a=t("#favorite-start"),n=this;return null===e?t():(0===a.length&&(a=t('<button class="btn btn-default btn-sm" id="favorite-start"></button>').on("click",(function(){n.model.setTableFavorite(!a.is(".stared")).then((function(e){n.tableRow.__is_in_favorites=e.status,n._getFavoriteStar.call(n)}))}))),e?a.addClass("stared").text(""):a.removeClass("stared").text(""),a)},_createBeforeSpace:function(){let a,i=this;if(this._beforeSpace=t('<div class="pcTable-beforeSpace">'),!i.beforeSpaceHide){i.LogButton=t(),a=t('<div class="pcTable-topButtons">');let e=t("#TOTUM_FOOTER");if(e.length&&a.append(e),i.isCreatorView){let n=t('<div class="creator-log-buttons">'),l=t.cookie("pcTableLogs")||"[]";l=JSON.parse(l),l.length&&(n.addClass("with-logs"),setTimeout(()=>{App.blink(n.find("button"),6,"#fff")},100));let s=t('<button class="btn btn-danger btn-sm"><i class="fa" style="width: 12px"></i> '+App.translate("Show logs")+"</button>").appendTo(n).on("click",(function(){let e;const a=function(){let a=[];e.find("input:checked").each((function(e,n){a.push(t(n).attr("name"))})),a.length>0?s.find("i").attr("class","fa fa-check-square-o"):s.find("i").attr("class","fa fa-square-o"),t.cookie("pcTableLogs",JSON.stringify(a),{path:"/"}),i.FullLOGS=[],i.LOGS={},s.popover("destroy"),a.length?n.addClass("with-logs"):n.removeClass("with-logs"),l=a};if(s.is("[aria-describedby]"))e=t("#"+s.attr("aria-describedby")),a();else{e=t("<div>"),e.append('<div><input type="checkbox" name="c"/> '+App.translate("Code")+"</div>"),e.append('<div><input type="checkbox" name="a"/> '+App.translate("Action code")+"</div>"),e.append('<div><input type="checkbox" name="s"/> '+App.translate("Selects")+"</div>"),e.append('<div><input type="checkbox" name="f"/> '+App.translate("Formating")+"</div>");let n=t('<div><input type="checkbox" name="flds"/> '+App.translate("Fields calculation time")+" </div>");e.append(n),i.FieldLOGS&&i.FieldLOGS.length&&i.FieldLOGS.forEach(e=>{let a=t('<div style="cursor: pointer"><button class="btn btn-xs"><i class="fa fa-table"></i></button> '+e.name+"</div>").on("click",(function(){i.model.calcFieldsLog(JSON.stringify(e.data),e.name)}));n.append(a)}),e.append('<div style="padding-top: 10px;"><button class="btn btn-sm btn-default">'+App.translate("Apply")+"</button></div>"),e.find("input").each((function(e,a){a=t(a),-1!==l.indexOf(a.attr("name"))&&a.prop("checked","checked"),-1!==l.indexOf("flds")&&"flds"!==a.attr("name")&&a.prop("disabled",!0)})),e.on("change",'input[name="flds"]',(function(){let a=t(this).is(":checked");e.find("input").each((e,n)=>{"flds"!==(n=t(n)).attr("name")&&(a?(n.prop("disabled",!0),n.prop("checked",!1)):n.prop("disabled",!1))})})),e.on("click","button",(function(){a()})),s.popover({trigger:"manual",placement:"bottom",content:e,html:!0,animation:!1,container:i._container,onhide:function(){}}).popover("show")}})),o=s.find("i");l.length>0?o.addClass("fa-check-square-o"):o.addClass("fa-square-o");let r=t('<button class="btn btn-danger btn-sm">'+App.translate("Log")+"</button>").appendTo(n);i.LogButton=r,r.on("click",(function(){i.FullLOGS&&0!==i.FullLOGS.length?App.logOutput(i.FullLOGS):App.logOutput("Log is empty")})),e.length?e.append(n):n.appendTo(a),t('<button class="btn btn-danger btn-sm"><i class="fa fa-eraser" style="width: 13px"></i></button>').on("click",(function(){i.FullLOGS=[],i.FieldLOGS=[],i.LOGS={}})).appendTo(n)}}let l=t('<span class="common-table-title">');if(l.append(this.fieldsHiddingGetButton(!0)),!i.isMobile){if(t('<button class="btn btn-default btn-sm"><i class="fa fa-print"></i></button>').on("click",(function(){i._print.call(i)})).appendTo(l),i.withCsvButtons){let e=t('<button class="btn btn-default btn-sm">CSV-'+App.translate("export")+"</button>").on("click",(function(){let a=t('<div><div class="menu-item" data-type="full">'+App.translate("Full")+'</div><div class="menu-item"  data-type="rows">'+App.translate("Only rows")+"</div></div>");a.on("click",".menu-item",(function(){let e=t(this).is('[data-type="full"]')?"full":"rows";a.remove(),i._csvExport(e)}));let n=App.popNotify({isParams:!0,$text:a,element:e,container:this._container,trigger:"manual",placement:"bottom"});t("#"+n).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",(function(){a.remove()})).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px")}));l.append(e)}if(i.withCsvEditButtons&&this.control.editing){let e=t('<button class="btn btn-default btn-sm">CSV-'+App.translate("import")+"</button>").on("click",(function(){let a=t('<div><div class="menu-item" data-type="full">'+App.translate("Full")+'</div><div class="menu-item"  data-type="rows">'+App.translate("Only rows")+"</div></div>");a.on("click",".menu-item",(function(){let e=t(this).is('[data-type="full"]')?"full":"rows";a.remove(),i._csvImportClick(e)}));let n=App.popNotify({isParams:!0,$text:a,element:e,container:this._container,trigger:"manual",placement:"bottom"});t("#"+n).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",(function(){a.remove()})).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px")}));l.append(e)}}if(this.isAnonim||i.beforeSpaceHide||l.append(this._getFavoriteStar()),this.tableRow.panels_view&&"both"===this.tableRow.panels_view.state&&!i.isMobile&&e===e.top&&"off"!==i.panels){let a;a="panels"!==this.viewType?t('<button class="btn btn-default btn-sm"><i class="fa fa-address-card-o"></i></button>').on("click",()=>{this.model.panelsView(!0).then(()=>{e.location.reload()})}):t('<button class="btn btn-default btn-sm"><i class="fa fa-table"></i></button>').on("click",()=>{this.model.panelsView(!1).then(()=>{e.location.reload()})}),l.append(a)}if(this.isCreatorView&&this.isMain){let l=t('<div class="creator-buttons">');t('<button class="btn btn-default btn-xxs field_name copy_me" data-copied-text="'+App.translate("Copied")+'"/>').text(this.tableRow.name).appendTo(l),t('<button class="btn btn-danger btn-xxs" title="'+App.translate("Edit table settings")+'"/>').html('<i class="fa fa-pencil-square-o"></i>').on("click",(function(){new EditPanel(1,BootstrapDialog.TYPE_DANGER,{id:i.tableRow.id}).then((function(t){t&&e.location.reload(!0)}))})).appendTo(l);let s={fl_name:[this.tableRow.id]};if(t('<a href="/Table/'+this.Tables.branchId+"/"+this.Tables.id+"/?"+t.param({f:s})+'" target="_blank" class="btn btn-danger btn-xxs" title="'+App.translate("Open Tables")+'"/>').html('<i class="fa fa-external-link"></i>').appendTo(l),s={f_table_categories:this.tableRow.category,f_table:this.tableRow.id},this.tableRow.__version&&(s.fl_version=this.tableRow.__version),t('<a href="/Table/'+this.Tables.branchId+"/"+this.TableFields.id+"/?"+t.param({f:s})+'" target="_blank" class="btn btn-danger btn-xxs" title="'+App.translate("Open Tables Fields")+'"/>').html('<i class="fa fa-external-link-square"></i>').appendTo(l),"calcs"===this.tableRow.type){l.append(" ");let e=t('<a href="/Table/'+this.TablesVersions.branchId+"/"+this.TablesVersions.id+"?"+t.param({f:this.calcstable_cycle_version_filters})+'" target="_blank" class="btn btn-danger btn-xxs" title="'+App.translate("Creating tables versions")+'"><i class="fa fa-code-fork"></i></a>');l.append(e),l.append(" "),e=t('<a href="/Table/'+this.TablesCyclesVersions.branchId+"/"+this.TablesCyclesVersions.id+"?"+t.param({f:this.calcstable_versions_filters})+'" target="_blank" class="btn btn-danger btn-xxs" title="'+App.translate("Changing versions of cycle tables")+'"><i class="fa fa-random"></i></a>'),l.append(e)}let o=t('<div class="color-danger creator-table-title">'+ +this.tableRow.sort+' <i class="'+App.tableTypes[this.tableRow.type].icon+'"></i> '+App.tableTypes[this.tableRow.type].title+" ["+this.tableRow.actual+"]</div>");l.append(o),"calcs"===this.tableRow.type&&o.append(App.translate(" / Version %s / Cycle %s",[this.tableRow.__version,this.tableRow.cycle_id]));const r=(e,t)=>{null===t||""==t||"=:"===t.trim()||"f1=:"===t.trim()?e.css("background-color","transparent"):e.css("background-color","#ffedb1")};[[App.translate("Creator-tableEditButtons-default_action"),"default_action","action"],[App.translate("Creator-tableEditButtons-on_duplicate"),"on_duplicate","action"],[App.translate("Creator-tableEditButtons-row_format"),"row_format","format"],[App.translate("Creator-tableEditButtons-table_format"),"table_format","format"]].forEach(e=>{let a=t('<button class="btn btn-danger btn-xxs"></button>').text(e[0]).on("click",(function(){i.editTableCode(e[1],e[2]).then(()=>{App.blink(t(this),3,"green","color"),r(a,i.tableRow[e[1]])})})).appendTo(l);r(a,i.tableRow[e[1]])}),t('<button class="btn btn-danger btn-xxs" id="hide-hell" disabled><i class="fa fa-times"></i></span></button>').on("click",(function(){i._hideHell_storage.switchOpened.call(i)})).appendTo(l),l.appendTo(a),t('<button class="btn btn-danger btn-xxs">'+App.translate("Add field")+"</span></button>").width(113).on("click",(function(){let t={table_id:{v:i.tableRow.id},data_src:{v:n}};i.tableRow.__version&&(t.version={v:i.tableRow.__version}),new EditPanel(2,BootstrapDialog.TYPE_DANGER,t).then((function(t){t&&e.location.reload(!0)}))})).appendTo(l),l.appendTo(a)}if(i.beforeSpaceHide)this._beforeSpace_title=t('<div class="pcTable-title"><span class="bttns"/></div>').prependTo(this._beforeSpace);else if(this._beforeSpace.append(a),this._beforeSpace_title=t('<div class="pcTable-title"><span class="title"/><span class="bttns"/><div class="updated"/></div>').prependTo(this._beforeSpace),"calcs"===this.tableRow.type&&e.TREE_DATA){let a,n,i=t('<div class="pcTable-tabls"><ul class="nav nav-tabs"></div>'),l=i.find("ul");if(e.location.pathname.match(/^\/[^\/]+\/\d+\/\d+\/\d+\/\d+$/)){a=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+).*?$/,"$1"),n=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+\/[^\/]+).*?$/,"$1")+"/";let t=sessionStorage.getItem("cycles_filter");t&&(t=JSON.parse(t),t.id==this.tableRow.tree_node_id&&(n+="?",t.filter&&(n+="f="+encodeURIComponent(t.filter)),t.onPage&&(t.filter&&(n+="&"),n+="onPage="+encodeURIComponent(t.onPage),n+="&offset="+encodeURIComponent(t.offset))));let i=!1;e.TREE_DATA.forEach(e=>{e.isCycleTable&&(i||(e.isOneUserCycle||l.append('<li><a href="/Table/'+n+'"><i class="fa fa-arrow-left"></a></li>'),i=!0),e.id==="table"+this.tableRow.id?l.append('<li class="active"><a class="tab-title">'+e.text+"</a></li>"):l.append('<li><a href="/Table/'+a+"/"+e.href+'">'+e.text+"</a></li>"))})}else{n=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+).*?$/,"$1");let t=!1;e.TREE_DATA.forEach(e=>{e.isCycleTable&&(t||(l.append('<li><a href="/Table/'+n+'/"><i class="fa fa-arrow-left"></a></li>'),t=!0),e.id==="table"+this.tableRow.id?l.append('<li class="active"><a class="tab-title">'+e.text+"</a></li>"):l.append('<li><a href="'+e.link+'">'+e.text+"</a></li>"))})}this._beforeSpace.append(i)}if(this._beforeSpace_title.append(l),this.tableRow.description){let e=t('<a class="btn btn-default btn-sm"><i class="fa fa-info"></i></a>'),a=t('<div class="table-description"/>').html(this.tableRow.description),n=t('<button class="btn btn-default btn-sm close-table-description"><i class="fa fa-times"></i></button>');a.append(n),e.appendTo(l);let i="table_description_switcher"+this.tableRow.id,s=this.tableRow.description.match("<hide(/?)>")?"0":localStorage.getItem(i)||localStorage.setItem(i,"1")||localStorage.getItem(i);const o=t=>{switch(t&&(s="1"===s?"0":"1"),s){case"1":a.show(),e.removeClass("btn-warning").addClass("btn-default");break;default:a.hide(),e.addClass("btn-warning").removeClass("btn-default")}localStorage.setItem(i,s),t&&this.ScrollClasterized.insertToDOM(0,!0)};o(),e.on("click",o),n.on("click",o),this._beforeSpace.append(a)}return this._beforeSpace},__$rowsButtons:null,applyPage:function(e,t,a){let n;this.rows=e.rows,n=e.rows.length?{firstId:e.rows[0].id,lastId:e.rows[e.rows.length-1].id}:{firstId:0,lastId:0},void 0===e.offset&&void 0===a&&(a=this.PageData.offset),this.PageData={...this.PageData,offset:void 0===e.offset?a:e.offset,allCount:void 0===t?e.allCount:t,loading:!1,...n},this.initRowsData(),this._refreshContentTable(!1,!0),this.__applyFilters(!0),this.PageData.$block.empty().append(this._paginationCreateBlock()),e.f&&this.apptyTableFormats(e.f),this.selectedCells.summarizer.check()},_paginationCreateBlock:function(){let{offset:e,onPage:a,allCount:n}=this.PageData;if("0"==a)return"";let i,l,s,o,r=t("<span></span>"),d=0===e?0:Math.ceil(e/a),c=Math.ceil(n/a)+(e%a>0?1:0);i=e>0?t('<button class="btn btn-default btn-sm"><i class="fa fa-hand-o-left"></i></button>').on("click",()=>(this.model.loadPage(this,null,this.PageData.onPage,this.PageData.firstId),!1)):t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-hand-o-left"></i></button>'),e+a<n?(l=t('<button class="btn btn-default btn-sm"><i class="fa fa-hand-o-right"></i></button>').on("click",()=>(Object.keys(this.data),this.model.loadPage(this,this.PageData.lastId,this.PageData.onPage),!1)),o=t('<button class="btn btn-default btn-sm"><i class="fa fa-long-arrow-right"></i></button>').on("click",()=>(this.model.loadPage(this,null,this.PageData.onPage,-1),!1))):(l=t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-hand-o-right"></i></button>'),o=t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-long-arrow-right"></i></button>')),s=d>0?t('<button class="btn btn-default btn-sm"><i class="fa fa-long-arrow-left"></i></button>').on("click",()=>(this.model.loadPage(this,0,this.PageData.onPage),!1)):t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-long-arrow-left"></i></button>');let p=t('<span id="ttm-onpage-input"></span>'),f=t('<input class="form-control" type="number">').appendTo(p).wrap("<span>");return f.val(a),f.on("change",()=>{let e=null;this.PageData.allCount<=this.PageData.onPage||d>=Math.floor(this.PageData.allCount/this.PageData.onPage)&&(e=-1),this.PageData.onPage=parseInt(f.val()),this.model.loadPage(this,0,f.val(),e)}),r.append(s),r.append(i),r.append('<span class="ttm-pages">'+App.translate("%s from %s",[d+1,c])+"</span>"),r.append(l),r.append(o),r.append(p),p.append(App.translate("%s from %s",["",n])),c>1&&(r.addClass("ttm-pagination-warning"),p.append(' <i class="fa fa-square"></i>')),this.saveFilterAndPage(),r},_pagination(){if(void 0===this.PageData||this.PageData.loading){let e;this.PageData||(this.PageData={$block:t('<div class="ttm-pagination"></div>')});let a=this.tableRow.pagination.split("/"),n=parseInt(new URL(document.location).searchParams.get("onPage")||(this.isMobile?a[1]:a[0]));return e=a[2]||null,this.PageData.onPage=n,this.model.loadPage(this,e,n,null,new URL(document.location).searchParams.get("offset")),this.PageData.$block.empty().append('<i class="fa fa-spinner"></i>')}return this.PageData.$block.empty().append(this._paginationCreateBlock())},rowButtonsCalcWidth:function(){this.tableWidth<this._innerContainer.width()?this.isMobile?this.__$rowsButtons.width(this._table.width()):this.__$rowsButtons.width(this._table.width()-70):this.isMobile||this.__$rowsButtons.width(this._innerContainer.width()-5)},_rowsButtons:function(){let e,a=this;if(this.__$rowsButtons?e=this.__$rowsButtons.empty():(e=t('<div class="pcTable-buttons">'),this.__$rowsButtons=e),this.fieldCategories.column.length){if(this.isInsertable()){let t=a._getInsertButtons();e.append(t)}if(this.control.restoring&&t('<button data-action="restore" class="btn btn-sm btn-warning">'+App.translate(this.isRestoreView?"Normal mode":"Restore")+"</button>").width(95).css("margin-left","5px").on("click",this.switchRestoreView.bind(this)).appendTo(e),!a.isCreatorView&&a.f&&a.f.buttons&&a.f.buttons&&a.f.buttons.length&&a.f.buttons.forEach(n=>{if(a.isReplacedToRowsButtonsField(n)){let i=t('<span class="button-wrapper">').data("field",n),l=a.fields[n].getCellText(null,i,a.data_params);i.append(l).appendTo(e),l.wrap('<span class="cell-value">')}}),!this.isTreeView||this.fields.tree.treeViewLoad){let n=t('<button class="btn btn-sm" style="margin-left: 5px;">'+App.translate("Reset")+' <span class="fa fa-filter"></span></button>').width(82).on("click",(function(){setTimeout((function(){a.filtersEmpty.call(a)}),50)}));this.filters&&Object.keys(this.filters).length?n.addClass("btn-warning"):n.attr("disabled",!0).addClass("btn-default"),e.append(n),this.filtersClearButton=n}}if(this.f.tablecomment){let n=t('<div class="pcTable-tableComment">').on("click",(function(){App.panel(App.translate("Comment of the table rows part"),a.f.tablecomment)}));e.prepend(n.text(this.f.tablecomment)),setTimeout((function(){let e=0;n.parent().find(">span,>button").each((function(){e+=t(this).width()||0})),e+=90,n.css("width","calc(100% - "+e+"px)")}),1)}return e},_refreshContentTable:function(e,t){let a=this._content;t=t||!1,a.data("state","refreshing"),App.fullScreenProcesses.showCog(),this.ScrollClasterized.insertToDOM(0,t,e),App.fullScreenProcesses.hideCog(),a.data("state","ready"),a.trigger("refreshed"),this._popovers.empty()},_refreshTitle:function(){if(!this.beforeSpaceHide&&(this._beforeSpace_title.find(".title").text(this.f.tabletitle||this.tableRow.title),this.model.tableData&&this.model.tableData.updated)){let e;this.isAnonim||(e=moment(this.model.tableData.updated.dt,"YYY-MM-DD HH:mm").format("DD.MM HH:mm")+" (code: "+this.model.tableData.updated.code+")");let a=t('<div class="small">').text(e);!1===this.control.editing&&a.append('<div class="">'+App.translate("Read only")+"</div>"),this._beforeSpace_title.find(".updated").html(a)}},_createTableText:function(){return this.tableText=t('<div class="pcTable-tableText"></div>').html(this.f.tabletext),this.f.tablehtml&&this.tableText.append(this.f.tablehtml),this.tableText},_refreshTableText:function(){this.tableText.text(this.f.tabletext)},_createRowsTitle:function(e=null){let a=this;a.__sectionsCloses=a.__sectionsCloses||JSON.parse(localStorage.getItem("sectionCloses")||"{}");let n=a.tableRow.id+"/"+(a.tableRow.__version||0)+"/rows",i=t('<div class="pcTable-rowsTitle"></div>').on("click","i, span",(function(){let e=t(this).closest(".pcTable-rowsWrapper");e.is(".pcTable-rowsClose")?(e.removeClass("pcTable-rowsClose"),delete a.__sectionsCloses[n],a.ScrollClasterized.reloadScrollHead()):(e.addClass("pcTable-rowsClose"),a.__sectionsCloses[n]=1),a.ScrollClasterized.insertToDOM(0,!0),localStorage.setItem("sectionCloses",JSON.stringify(a.__sectionsCloses))}));return e&&e.is(".pcTable-rowsClose")&&!a.__sectionsCloses[n]?e.removeClass("pcTable-rowsClose"):e&&!e.is(".pcTable-rowsClose")&&a.__sectionsCloses[n]&&e.addClass("pcTable-rowsClose"),this.f.rowstitle?i.html(t("<span>").text(this.f.rowstitle)).prepend('<i class="fa">'):i.text(),i},_createFiltersBlock:function(){let a=this;if(t("<div>"),this._filtersBlock=t("<div>"),this._filtersBlock.addClass("pcTable-filtersTables pcTable-section"),a.fieldCategories.filter.length){let n,i,l;this.___createClosedSection(this._filtersBlock,t('<div class="pcTable-sectionTitle"><span>'+App.translate("Filters")+"</span></div>").appendTo(this._filtersBlock),"flt"),this._filtersBlock.addClass("pcTable-filtersTables");let s,o=0,r=this._container.width()-140;const d=function(){if(n){const s=function(){let n=t(this);const i=function(){let i;i=n.is(".eraser")?"?":"?"+t.param({f:a._filtersBlock.data("cryptoFilters")||a.filtersString}),a.isMobile&&(i+="#go-buttons"),e.location.href=i};return setTimeout((function(){a.model.doAfterProcesses(()=>{setTimeout(i,100)})}),500),!0};if(a.isMobile)n.after(t('<table class="pcTable-filtersTable" id="go-buttons"><tr><td><button class="btn btn-default btn-xs button-go">GO</button> <button class="btn btn-default btn-xs eraser button-go "><i class="fa fa-eraser"></i></button></td></tr></td></table>').on("click",".button-go",s));else{i.append('<th style="width: 69px;"></th>');let e=t('<td class="buttons-go">').html('<button class="btn btn-default btn-xs button-go">GO</button> <button class="btn btn-default btn-xs eraser button-go"><i class="fa fa-eraser"></i></button>').appendTo(l);n.width(o+69),e.on("click",".button-go",s)}}},c=(e,c)=>{c.hidden||((a.isMobile||0===o||r<o+c.width||c.tableBreakBefore)&&(a.isMobile||d(),n=t("<table class='pcTable-filtersTable'><thead><tr></tr></thead><tbody><tr></tr></tbody></table>").appendTo(this._filtersBlock),o=0,i=n.find("thead tr"),l=n.find("tbody tr")),void 0!==c.panelColor&&(s=c.panelColor),i.append(a._createHeadCell(e,c,s)),t("<td>").attr("data-field",c.name).appendTo(l),o+=c.width)};t.each(a.fieldCategories.filter,c),d()}return this._filtersBlock},_refreshFiltersBlock:function(e){let a=this;(e=e||{}).params?(t.each(a.fieldCategories.filter,(function(t,n){a.data_params[n.name]=e.params[n.name]})),a._filtersBlock.data("cryptoFilters",e.filtersString)):a.filterData||(a.filterData={},t.each(a.fieldCategories.filter,(function(e,n){a.filterData[n.name]=t.extend(!0,{},a.data_params[n.name])})),a.model.addExtraData({filters:a.filtersString}));let n=[],i=[];return t.each(a.fieldCategories.filter,(function(e,t){if(t.hidden)return;let l=a._createCell(a.data_params,t);a._filtersBlock.find('td[data-field="'+t.name+'"]').replaceWith(l),Object.equals(a.data_params[t.name].v,a.filterData[t.name].v)||n.push(l),"select"===t.type&&t.column&&a.data_params[t.name].v&&("*NONE*"===a.data_params[t.name].v||"*NONE*"===a.data_params[t.name].v[0])&&i.push(l)})),n.length>0?(n.forEach((function(e){e.addClass("warning-backg")})),a._filtersBlock.removeClass("with_danger").addClass("with_changed")):i.length>0?(i.forEach((function(e){e.addClass("danger-backg")})),a._filtersBlock.removeClass("with_changed").addClass("with_danger")):(a._filtersBlock.removeClass("with_danger, with_changed"),a._filtersBlock.find(".danger-backg, .warning-backg").removeClass("danger-backg, warning-backg")),this._filtersBlock},_createParamsBlock:function(e){let a=t("<div>");if(e)return a.appendTo(e),a;this._paramsBlock&&(this._paramsBlock.replaceWith(a),this._paramsBlock=a);let n=this;if(n.fieldCategories.param)if(a.addClass("pcTable-paramsTables"),n.isMobile){let e,i,l,s,o="",r=!1;t.each(n.fieldCategories.param,(function(d,c){if(n.isReplacedToRowsButtonsField(c.name))return;let p;void 0!==c.panelColor&&(p=c.panelColor),void 0!==c.sectionTitle&&(r=!1,o=c.sectionTitle,o.match(/\*\*(.*)/)&&(o.match(/\*\*(.*)/)[1].trim().split(/\s*;\s*/).forEach(e=>{let t=e.trim().split(/\s*:\s*/);"nolable"===t[0]&&(t[1]&&"true"!==t[1].trim()||(o=""))}),o=o.replace(/(\*\*.*)/,""))),!c.showMeWidth||n.data_params[c.name].f&&n.data_params[c.name].f.hide&&n.data_params[c.name].f.hide.mobile||(e=t("<table class='pcTable-paramsTable'>"+(r?"":"<thead><tr></tr></thead>")+"<tbody><tr style='background-color: "+p+"'></tr></tbody></table>"),n.isMobile&&"button"===c.type&&(e=t("<table class='pcTable-paramsTable'><tbody><tr></tr></tbody></table>")),s&&!o||(s=t('<div class="pcTable-section">').appendTo(a),o&&n.___createClosedSection(s,t('<div class="pcTable-sectionTitle"></div>').html(t("<span>").text(o)).appendTo(s),"p")),o="",s.append(e),r||(i=e.find("thead tr"),i.append(n._createHeadCell(d,c,p))),l=e.find("tbody tr"),l.append('<td data-field="'+c.name+'">'))}))}else this.__fillFloatBlock(a,n.fieldCategories.param);return a},_refreshParamsBlock:function(e,a){var n=this;return n.fieldCategories.param&&t.each(n.fieldCategories.param,(function(t,i){if(!i.showMeWidth||e&&!e[i.name])return!0;let s=n._createCell(n.data_params,i),o=n._paramsBlock.find('td[data-field="'+i.name+'"]');o.css("minHeight")&&s.css("minHeight",o.css("minHeight")),o.replaceWith(s),a&&"f"!==e[i.name]&&n._colorizeElement(s,l)})),this._paramsBlock},_createFootersSubtable:function(e){let a,n=this;if(a=t("<div class='pcTable-footersTables'>"),e)return a.appendTo(e),a;if(this._footersSubTable&&(this._footersSubTable.replaceWith(a),this._footersSubTable=a),n.isMobile){let e,i,l,s,o,r=0,d=this._container.width()-100,c="";t.each(n.notTableFooterFields,(function(p,f){let h;void 0!==f.panelColor&&(h=f.panelColor),void 0!==f.sectionTitle&&(o=!1,c=f.sectionTitle,c.match(/\*\*(.*)/)&&(c.match(/\*\*(.*)/)[1].trim().split(/\s*;\s*/).forEach(e=>{let t=e.trim().split(/\s*:\s*/);"nolable"===t[0]&&(t[1]&&"true"!==t[1].trim()||(c=""))}),c=c.replace(/(\*\*.*)/,""))),!f.showMeWidth||n.data_params[f.name].f&&n.data_params[f.name].f.hide&&n.data_params[f.name].f.hide.mobile||((n.isMobile||0===r||d<r+f.showMeWidth||f.tableBreakBefore)&&(e&&!n.isMobile&&e.width(r),e=t("<table class='pcTable-footersTable'><thead><tr></tr></thead><tbody><tr style='background-color: "+h+"'></tr></tbody></table>"),("button"===f.type||o)&&(e=t("<table class='pcTable-paramsTable'><tbody><tr></tr></tbody></table>")),s&&!c||(s=t('<div class="pcTable-section">').appendTo(a),c&&n.___createClosedSection(s,t('<div class="pcTable-sectionTitle"></div>').html(t("<span>").text(c)).appendTo(s),"f")),c="",s.append(e),r=0,i=e.find("thead tr"),l=e.find("tbody tr")),i.append(n._createHeadCell(p,f,h)),l.append('<td data-field="'+f.name+'">'),r+=f.showMeWidth)}))}else this.__fillFloatBlock(a,n.notTableFooterFields);return a},_createFootersTableBlock:function(){let e,a=this;if(e=t("<tbody class='pcTable-footers'></tbody>"),a.fieldCategories.footer){let n={},i=0;t.each(a.fieldCategories.footer,(function(e,t){!t.showMeWidth||a.data_params[t.name].f&&a.data_params[t.name].f.hide&&a.data_params[t.name].f.hide.mobile||(t.column||(t.column=""),n[t.column]||(n[t.column]=[]),n[t.column].push(t),t.column&&i<n[t.column].length&&(i=n[t.column].length))}));let l=t(),s=0,o=0;for(;s<i;){let e=t('<tr><td class="id"></td></tr>'),i=t('<tr><td class="id"></td></tr>').data("pctableitemid","footers").data("pctablettemtndex","footers"+o++);t.each(a.fieldCategories.column,(function(l,o){if(o.showMeWidth){let r=t("<td>");if(!n[o.name]||!n[o.name][s])return r.attr("rowspan",2),e.append(r),void r.addClass("footer-empty");if(r=a._createHeadCell(l,n[o.name][s],n[o.name][s].panelColor).addClass("footer-name"),a.isRotatedView&&r.width("auto"),e.append(r),n[o.name]&&n[o.name][s]){let e=n[o.name][s],t=a._createCell(a.data_params,e);t.attr("data-field",e.name),i.append(t)}}}));let r=this.tableRow.rotated_view+50;e.width(r/2),i.width(r/2),l=l.add(e),l=l.add(i),s++}e.html(l)}return e},___createClosedSection(e,a,n){const i=this;let l=e.parent().find(">div").index(e)+2,s=i.tableRow.id+"/"+(i.tableRow.__version||0)+"/"+n+"/"+l;i.__sectionsCloses=i.__sectionsCloses||JSON.parse(localStorage.getItem("sectionCloses")||"{}"),i.__sectionsCloses[s]&&e.addClass("closed"),t('<span class="btn-i"><i class="fa"></i></span>').prependTo(a),a.on("click","i, span",(function(){let e=t(this).closest(".pcTable-section");if(e.is(".closed"))if(e.removeClass("closed"),delete i.__sectionsCloses[s],e.data("closedrender")){let e=i.scrollWrapper.parent().scrollTop();switch(n){case"p":i._rerendParamsblock();break;case"f":i._rerendBottomFoolers()}i.scrollWrapper.parent().scrollTop(e)}else e.find("td").each((function(){let e=t(this);e.data("addProgress")&&e.data("addProgress")()}));else e.addClass("closed"),i.__sectionsCloses[s]=1;return localStorage.setItem("sectionCloses",JSON.stringify(i.__sectionsCloses)),i.ScrollClasterized.insertToDOM(null,!0),!1}))},_refreshFootersBlock:function(e,a){let n=this,i=n._footersBlock.add(n._footersSubTable);return n.fieldCategories.footer&&t.each(n.fieldCategories.footer,(function(t,s){if(!s.showMeWidth||e&&!e[s.name])return!0;let o=n._createCell(n.data_params,s);o.attr("data-field",s.name),i.find('td[data-field="'+s.name+'"]').replaceWith(o),a&&"f"!==e[s.name]&&n._colorizeElement(o,l)})),this._paramsBlock},_createHead:function(){return this._header=t("<thead>").append(this._createHeadRow()),this._header},_refreshHead:function(){return this._header.empty().append(this._createHeadRow()),this._header},_createFirstBody:function(){return this._beforebody=t("<tbody class='beforeRows'>").append('<tr class="extra-clasters">'),this.extraClastersTop=this._beforebody.find(".extra-clasters"),this._beforebody},_createAfterBody:function(){return this._afterbody=t("<tbody class='afterRows'>").append('<tr class="extra-clasters">'),this.extraClastersBottom=this._afterbody.find(".extra-clasters"),this._afterbody},_createBody:function(){return this._content=t("<tbody class='dataRows'>"),this._content},_createHeadRow:function(){let e=this,a=t("<tr>");this.fieldCategories.visibleColumns.length?e._container.removeClass("withNoColumns"):e._container.addClass("withNoColumns"),e._createHeadCellId().appendTo(a);let n=a.find(".id").width();return e._table.removeClass("n-filtered"),t.each(this.fieldCategories.visibleColumns,(function(t,i){let l,s;void 0!==i.panelColor&&(l=i.panelColor),"n"===i.name?(e._table.addClass("n-filtered"),s=e._createHeadCellNo()):s=e._createHeadCell(t,i,l),s.appendTo(a),n+=parseInt(i.showMeWidth)})),this.tableWidth=n,this.isRotatedView||this._table.width(this.tableWidth),a},_createHeadCellId:function(){let e=this,a=t('<th class="id"><span>id</span></th>');if(null===e.tableRow.order_field||"id"===e.tableRow.order_field){let t=a.find("span").css("font-weight","bold");e.isCreatorView&&(!0===e.tableRow.order_desc?t.append(' <i class="fa fa-sort-amount-desc roles"></i>'):t.append(' <i class="fa fa-sort-amount-asc roles"></i>'))}let n=t('<div class="pcTable-filters"></div>'),i=t('<button class="btn btn-default btn-xxs" id="n-expander"><i class="fa fa-sort"></i></button>');if(this.isTreeView&&"other"!==this.fields.tree.treeViewType?i.prop("disabled",!0):i.on("click",(function(){e.fieldCategories.visibleColumns.some((function(e){return"n"===e.name}))?(e.fieldsHiddingHide.call(e,"n"),i.removeClass("btn-warning")):(e.fieldsHiddingHide.call(e,"n",!0),i.addClass("btn-warning")),e.ScrollClasterized.reloadScrollHead()})),e.fieldCategories.visibleColumns.some((function(e){return"n"===e.name}))&&i.addClass("btn-warning"),e.isMobile);else{let t=this._getIdFilterButton();n.append(i).append(" ").append(t).append(" ").append(e._idCheckButton)}return a.append(this._checkStatusBar),a.append(n),e._idCheckButton.off().on("click",(function(){if(e._idCheckButton.find("span").is(".fa-check"))e.row_actions_uncheck_all.call(e),e.__checkedRows=[];else for(let t=0;t<e.dataSortedVisible.length;t++){let a=e.dataSortedVisible[t],n="object"!=typeof a?e._getItemById(a):a.row;n&&!n.$checked&&(e.row_actions_check.call(e,n,!0),e.__checkedRows.push(n.id))}e._headCellIdButtonsState()})),n=t('<div class="pcTable-filters for-selected"><button class="btn btn-default btn-xxs"><i class="fa fa-copy"></i></button> <button class="btn btn-default btn-xxs" data-names="true"><i class="fa fa-clone"></i></button></div>'),a.append(n),this._refreshCheckedStatus(),a},_getIdFilterButton:function(){let e,a=this,n=t("<span>");return e=t('<button class="btn btn-xxs btn-filter" id="checkS"><span class="fa fa-circle-o"></span></button>').on("click",(function(){e.is(".btn-warning")?(e.addClass("btn-default").removeClass("btn-warning").find("span").removeClass("fa-circle").addClass("fa-circle-o"),delete a.filters.id,n.find(".btn-filter:not(#checkS)").parent().replaceWith(a.__getFilterButton("id"))):(e.removeClass("btn-default").addClass("btn-warning").find("span").removeClass("fa-circle-o").addClass("fa-circle"),a.filters.id=a.__checkedRows.slice().map((function(e){return e.toString()}))),a.__applyFilters(),a._headCellIdButtonsState()})),a.filters.id&&a.filters.id.length?e.addClass("btn-warning").removeClass("btn-default"):e.addClass("btn-default").removeClass("btn-warning"),n.append(e),n.append(a.__getFilterButton("id")),n},_createHeadCellNo:function(){let e=this,a=e.fields.n,n=t('<span class="cell-title">').text(a.title?a.title:a.name).attr("title",a.title),i=t('<button class="btn btn-default btn-xxs" style="width: 45px"><i class="fa fa-save"></i></button>'),l=t('<th class="n">').width(a.userWidth||a.width).append(n);return e.isCreatorView&&("n"===e.tableRow.order_field&&(!0===e.tableRow.order_desc?n.before('<i class="fa fa-sort-amount-desc roles"></i>'):n.before('<i class="fa fa-sort-amount-asc roles"></i>')),n.before("<br/>")),e._orderSaveBtn=i,!e.tableRow.with_order_field||e.f.blockorder||e.tableRow.__blocked?(i.prop("disabled",!0),this._table.addClass("no-correct-n-filtered")):i.on("click",(function(){e.reOrderRowsSave.call(e)})),l.append(t('<div class="pcTable-filters">').append(i))},__getCellTitle:function(e){return Object.getPath(this.f,["fieldtitle",e.name],e.title)},isReplacedToRowsButtonsField(e){return this.fields[e]&&this.f&&this.f.buttons&&this.f.buttons&&this.f.buttons.length&&-1!==this.f.buttons.indexOf(e)},_createHeadCell:function(a,i,l){let s=this,o=t("<th>").data("field",i.name);i.$th=o;let r=i.showMeWidth||i.width||100;this.isRotatedView&&"column"===i.category||("column"!==i.category&&r&&s.isMobile&&(r=100),s.isMobile&&("column"===i.category&&i.editable&&(r+=20),r+=20),r&&o.width(r)),s.fields[i.name]&&(s.fields[i.name].$th=o),i.panelColor?o.css("background-color",i.panelColor):void 0!==l&&""!==l&&(o.css("background-color",l),i.panelColor=l),i.webRoles&&1===i.webRoles.length&&"1"===i.webRoles[0].toString()&&o.addClass("admin-see"),"footer"===i.type&&i.column&&(o=t("<td>"));let d=this.__getCellTitle(i),c=t('<span class="cell-title">').text(d).attr("title",d).appendTo(o);if(s.isCreatorView&&!this.isRotatedView){let e=t('<span class="creator-icons">').prependTo(c);const a=function(e){let t="";switch(e){case"param":t="fa-hand-o-up";break;case"column":t="fa-hand-o-right";break;case"filter":t="fa-hand-o-left";break;case"footer":t="fa-hand-o-down"}return t};!i.isHiddenField&&i.showMeWidth||e.append('<i class="fa '+a(i.category)+' roles"></i>'),!i.showInWeb||i.isHiddenField||i.showMeWidth||o.addClass("eye-hidden"),i.linkTableName&&e.append('<i class="fa fa-chain roles"></i>'),e.append('<i class="fa '+i.icon+' roles"></i>');let n=t('<i class="roles">'+(i._ord||i.ord)+"</i>");if(e.append(n),i._ord&&(n.addClass("reordered"),n.before('<i class="roles">'+i.ord+"</i>")),i._category&&n.before('<i class="fa '+a(i._category)+' roles reordered fa-bold"></i>'),"column"===i.category&&s.tableRow.order_field===i.name&&(n.css("font-weight","bold"),!0===s.tableRow.order_desc?e.append('<i class="fa fa-sort-amount-desc roles"></i>'):e.append('<i class="fa fa-sort-amount-asc roles"></i>')),i.codeAction){let a=t('<i class="fa fa-star roles"></i>');e.append(a);let n="";i.CodeActionOnAdd&&(""!==n&&(n+="\n"),n+=App.translate("On adding")),i.CodeActionOnChange&&(""!==n&&(n+="\n"),n+=App.translate("On changing")),i.CodeActionOnDelete&&(""!==n&&(n+="\n"),n+=App.translate("On deleting")),("button"===i.type||i.CodeActionOnClick)&&(""!==n&&(n+="\n"),n+=App.translate("On click")),""===n&&a.removeClass("fa-star").addClass("fa-star-o"),a.attr("title",n)}i.code&&!i.linkFieldName&&(i.codeOnlyInAdd?e.append('<i class="fa fa-cog-o roles"></i>'):e.append('<i class="fa fa-cogs roles"></i>'));const l=function(e){let t="";return e.forEach((function(e){""!==t&&(t+="\n"),t+=s.ROLESLIST[e.toString()]})),t};if(i.webRoles&&e.append(t('<i class="fa fa-eye roles"></i>').attr("title",l(i.webRoles))),"button"!==i.type){let a=!1;i.addRoles?e.append(t('<i class="fa fa-plus roles h"></i>').attr("title",l(i.addRoles))):i.insertable||("column"===i.category?i.editable?e.append(t('<i class="fa fa-plus roles h"></i>').attr("title",App.translate("Adding is disallowed"))):(e.append(t('<i class="fa fa-lock roles h"></i>').attr("title",App.translate("Adding and editing is disallowed"))),a=!0):i.editable||(e.append(t('<i class="fa fa-lock roles h"></i>').attr("title",App.translate("Editing is disallowed"))),a=!0)),i.editRoles?e.append(t('<i class="fa fa-pencil roles h"></i>').attr("title",l(i.editRoles))):i.editable||a||e.append(t('<i class="fa fa-pencil roles h"></i>').attr("title",App.translate("Editing is disallowed"))),i.logRoles&&e.append(t('<i class="fa fa-archive roles h"></i>').attr("title",l(i.logRoles)))}if(i.showInXml){let a="";i.xmlRoles&&(a=l(i.xmlRoles)),e.append(t('<i class="fa fa-exchange roles"></i>').attr("title",a))}}i.unitType&&c.append(", "+i.unitType);let p,f=t('<div class="pcTable-filters">');if(i.help&&i.help.length){s.isCreatorView||"column"===i.category||o.addClass("worker-with-i"),p=t('<span class="btn btn-xxs btn-default cell-help" tabindex="-1" id="field-help-'+i.name+'"><i class="fa fa-info"></i></span>'),o.addClass("with-help"),s.isCreatorView&&/^\s*<admin>.*?<\/admin>\s*$/s.test(i.help)&&p.addClass("danger-backg"),p.appendTo(f);let e,a=t('<div class="i-inner-div">').html(i.help).width(230);s.isMobile?p.on("click",(function(){App.mobilePanel(App.translate("Field %s",i.title),i.help)})):p.on("click open close",(function(n){let l=t(this);return l.data("bs.popover")?"open"!==n.type&&(e&&clearTimeout(e),e=setTimeout(()=>{l.attr("aria-describedby")&&t("#"+l.attr("aria-describedby").length)&&l.popover("destroy")},120)):"close"!==n.type&&(p.popover({trigger:"manual",content:a,html:!0,placement:()=>{let e="bottom",t=300,n=s._container,o=l.offset().top-n.offset().top;return"column"===i.category&&s.insertRow||o>n.height()/2?(e="top",t=o-40):t=n.height()-o-70,a.css("max-height",t),e},container:s.scrollWrapper}),l.popover("show")),t("body").trigger("click"),!1})),s.addThHelpCloser()}if("column"===i.category&&(!s.isTreeView||s.fields.tree.treeViewLoad)&&i.filterable&&i.showMeWidth>0&&(o.addClass("with-filter2"),this.__getFilterButton(i.name).appendTo(f)),s.isCreatorView||!1!==i.dropdownView&&"column"===i.category){o.addClass("with-filter");let a=s.isCreatorView&&!(!1!==i.dropdownView&&"column"===i.category);(()=>{let l=t('<div class="cell-header-dropdown">'),o=t('<button class="btn btn-default btn-xxs"  tabindex="-1"><i class="fa fa-caret-down"></i></button>');s.fixedColumn===i.name&&o.addClass("btn-warning").removeClass("btn-default"),i.pcTable?a&&o.addClass("field_name"):o.addClass("field_name");const r=function(t){t&&e.location.reload()};if(s.isCreatorView){let a=t('<div class="menu-item color-danger">');a.append('<i class="fa fa-pencil-square-o"></i> '+App.translate("Change")),l.append(a);const d=function(){return new EditPanel(2,BootstrapDialog.TYPE_DANGER,{id:i.id}).then(r),!1};a.on("click",d),o.on("contextmenu",d),a=t('<div class="menu-item color-danger">'),a.append('<i class="fa fa-clone"></i> '+App.translate("Duplicate")),l.append(a),a.on("click",(function(){App.getPcTableById(2).then((function(e){e.model.checkEditRow({id:i.id}).then((function(e){let a={},n={};t.each(e.row,(function(e,t){"object"==typeof t&&(a[e]=t,n[e]=!0)})),new EditPanel(2,BootstrapDialog.TYPE_DANGER,a,!1,n).then(r)}))}))})),a=t('<div class="menu-item color-danger">'),a.append('<i class="fa fa-plus"></i> '+App.translate("Insert after")),l.append(a),a.on("click",(function(){App.getPcTableById(2,{afterField:i.ord}).then((function(e){let t={};t.ord={v:i.ord+10},t.category={v:i.category},t.table_id={v:s.tableRow.id},s.tableRow.__version&&(t.version={v:s.tableRow.__version}),t.data_src={v:n},new EditPanel(e,BootstrapDialog.TYPE_DANGER,t,!1,t).then(r)}))})),("param"===i.category||"footer"===i.category&&""==i.column)&&(a=t('<div class="menu-item color-danger">'),a.append('<i class="fa fa-hand-scissors-o"></i> '+App.translate("Section")),l.append(a),a.on("click",()=>{this.__editSectionTitle(i)})),a=t('<div class="menu-item color-danger">'),a.append('<i class="fa fa-refresh"></i> '+App.translate("Change NAME")),l.append(a),a.on("click",(function(){s.model.renameField(i.name)})),a=t('<div class="menu-item color-danger">'),a.append('<i class="fa fa-times"></i> '+App.translate("Delete")),l.append(a),a.on("click",(function(){let t=i.title;BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:App.translate("Delete field %s from table %s?",[t,s.tableRow.title]),buttons:[{action:function(a,n){"use strict";a.close(),App.getPcTableById(2).then((function(a){App.panelTimer(App.translate("Deleting field %s from table %s?",[t,s.tableRow.title]),a.tableRow.delete_timer,(function(){a.model.delete(i.id).then((function(){e.location.reload(!0)}))}))}))},cssClass:"btn-warning",label:App.translate("Delete")},{action:function(e){e.close()},label:App.translate("Cancel")}],draggable:!0})}))}if("filter"!==i.category&&i.pcTable&&!s.isMobile){let e=t('<div class="menu-item">');i.showMeWidth?(e.append('<i class="fa fa-eye-slash"></i> '+App.translate("Hide")),e.on("click",(function(){o.popover("hide"),s.fieldsHiddingHide.call(s,i.name)}))):(e.append('<i class="fa fa-eye-slash"></i> '+App.translate("Show")),e.on("click",(function(){o.popover("hide"),s.setColumnWidth.call(s,i.name,i.width,i.id)}))),e.appendTo(l),"column"===i.category&&s.isRotatedView||(e=t('<div class="menu-item">'),e.append('<i class="fa fa-arrows-h"></i> '+App.translate("Field width")),e.on("click",(function(){o.popover("hide");let e=t('<div><input type="number" class="form-control" value="'+i.showMeWidth+'" style="padding-left: 2px;"/></div>'),a=[{label:App.translate("Apply"),action:function(t){let a=parseInt(e.find("input").val());t.close(),i.pcTable.setColumnWidth.call(i.pcTable,i.name,a)}},{label:App.translate("Cancel"),action:function(e){e.close()}}];s.isCreatorView&&a.splice(0,0,{label:App.translate("By default"),cssClass:"btn-m btn-danger",action:function(t){let a=parseInt(e.find("input").val());t.close(),i.pcTable.setColumnWidth.call(i.pcTable,i.name,a,i.id)}}),BootstrapDialog.show({message:e,title:App.translate("Field %s width",i.title),onshown:function(t){let a=e.find("input");a.focus(),a.on("keydown",(function(a){13===a.keyCode&&(i.pcTable.setColumnWidth.call(i.pcTable,i.name,parseInt(e.find("input").val())),t.close())})),t.$modalDialog.width(500)},buttons:a,draggable:!0})})),e.appendTo(l))}if(i.showMeWidth>0&&"column"===i.category){if(s.fixedColumn===i.name?t('<div class="menu-item">').append('<i class="fa fa-thumb-tack"></i> '+App.translate("Unpin")).addClass("color-warning").appendTo(l).on("click",(function(){o.popover("hide"),s.fixColumn()})):"button"===i.type||s.isRotatedView||t('<div class="menu-item">').append('<i class="fa fa-thumb-tack"></i> '+App.translate("Pin")).appendTo(l).on("click",(function(){o.popover("hide"),s.fixColumn(i.name)})),!s.isTreeView){{let e=t('<div class="menu-item">');e.append('<i class="fa fa-sort-alpha-asc"></i> '+App.translate("Sort A-Z")),l.append(e),e.on("click",(function(){s.sort(i,1)}))}{let e=t('<div class="menu-item">');e.append('<i class="fa fa-sort-alpha-desc"></i> '+App.translate("Sort Z-A")),l.append(e),e.on("click",(function(){s.sort(i,-1)}))}}{let e=t('<div class="menu-item">');e.append('<i class="fa fa-hand-pointer-o"></i> '+App.translate("Select")),l.append(e),e.on("click",(function(){s.selectedCells.empty(),s.selectedCells.selectColumn(i.name)}))}if("column"===i.category&&"number"===i.type){let e=t('<div class="menu-item">');e.append('<i class="fa fa-diamond"></i> '+App.translate("Math operations")),l.append(e),e.on("click",(function(){let e=t("<div>"),a=0,n=0,l=null,o=null,r=0;s.dataSortedVisible.some((function(e){let t;try{if("object"!=typeof e)t=Big(s.data[e][i.name].v);else{if(!e.row)return;t=Big(e.row[i.name].v)}a=Big(a).plus(t),++n,(null===l||t.gt(l))&&(l=t),(null===o||t.lt(o))&&(o=t)}catch(e){++r}}));let d=t('<table class="totum-math-operations"><thead><tr><th>'+App.translate("Operation")+"</th><th>"+App.translate("Value")+"</th></tr></thead>").appendTo(e),c=t("<tbody>").appendTo(d),p=function(e,t){let a="";if(t=t||!1,i.unitType&&!t&&(a=" "+i.unitType),i.currency){let t={};return i.dectimalPlaces&&(t.minimumFractionDigits=i.dectimalPlaces),parseFloat(e).toLocaleString(App.lang.locale,t)+a}return e+a};t("<tr><td>"+App.translate("Summ")+"</td><td>"+p(a)+"</td></tr>").appendTo(c),t("<tr><td>"+App.translate("Number of numbers")+"</td><td>"+p(n,!0)+"</td></tr>").appendTo(c),t("<tr><td>"+App.translate("Average")+"</td><td>"+(0!==n?p(Big(a).div(n).round(i.dectimalPlaces||0)):"null")+"</td></tr>").appendTo(c),t("<tr><td>"+App.translate("Max")+"</td><td>"+p(l)+"</td></tr>").appendTo(c),t("<tr><td>"+App.translate("Min")+"</td><td>"+p(o)+"</td></tr>").appendTo(c),t("<tr><td>"+App.translate("Non-numeric elements")+"</td><td>"+p(r,!0)+"</td></tr>").appendTo(c),s.isTreeView&&e.append("<div>"+App.translate("Calculated only by visible rows")+"</div>");let f=i.title+(i.unitType?", "+i.unitType:"");s.isMobile?App.mobilePanel(f,e):BootstrapDialog.show({title:f,type:"edit",message:e,draggable:!0,onshown:function(e){e.$modalDialog.width(400)},buttons:[{action:function(e){e.close()},label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon"}]})}))}}if(i.linkToSelectTable){let a=i.linkToSelectTable,n=t('<div class="menu-item color-primary">');n.append('<i class="fa fa-external-link"></i> '+a.title),l.append(n),n.on("click",(function(){return e.open(a.link,"_blank").focus(),!1}))}return o.popover({html:!0,content:l,trigger:"manual",container:s._container,placement:"auto bottom"}),o.on("click",()=>{"column"===i.category&&s.PageData&&s.PageData.onPage&&s.PageData.allCount>s.PageData.onPage?0===l.find(".column-dropdown").length&&l.append('<div class="column-dropdown">'+App.translate("By current page")+" </div>"):l.find(".column-dropdown").remove(),o.data("bs.popover").tip().hasClass("in")||(o.popover("show"),setTimeout((function(){s.closeCallbacks.push(()=>{o.popover("hide")})}),20))}),o})().appendTo(f)}f.appendTo(o);let h=20*f.find(".btn").length+5;if(this.isCreatorView&&!this.isRotatedView&&(!i.showMeWidth||i.showMeWidth>50)){let e=t('<div class="th-left-bottom-buttons">').appendTo(o);"footer"===i.category&&i.column&&this.fields[i.column]&&!s.hidden_fields[i.name]&&(r=this.fields[i.column].width),t('<div class="btn  btn-xxs field_name copy_me"  tabindex="-1" data-copied-text="'+App.translate("Copied")+'">').text(i.name).appendTo(e).css("max-width",r-h)}return!s.isRotatedView&&s.isMobile&&c.css("max-width",r-h-5),o},_createNoDataRow:function(e){let a=0;t.each(this.fields,(function(e,t){a++}));let n=t();return!e&&this.PageData&&this.PageData.loading?e=App.translate("Wait, the table is loading"):this.isInsertable()&&(n=t('<button class="btn btn-warning btn-xxs">'+App.translate("Add row")+"</button>").width(120).on("click",()=>{this.__$rowsButtons.find('[data-action="add"]:first').click()})),void 0===e&&(this.PageData&&this.PageData.allCount?this.model.loadPage(this,null,this.PageData.onPage,null,this.PageData.offset):e=App.translate("Table is empty")+" "),t("<tr>").addClass(this.noDataRowClass).append('<td class="id">').append(t("<td>").attr("colspan",a).append(e).append(n))},_createRow:function(e,a){a=a||[];let n=this;e.$tr||(e.$tr=t("<tr>"),n.isRotatedView?e.$tr.width(n.tableRow.rotated_view):e.$tr.height(35),e.$tr.data("item",e));let i=e.$tr.empty();i.attr("class","DataRow"),i.attr("data-pctableitemid",e.id),e.e_data&&1==e.e_data.b&&i.addClass("BlockedRow"),e.InsDel&&i.addClass("insDeleted"),this._addCellId(e,i);let s=0,o=this.fieldCategories.visibleColumns.length;if(this.fieldCategories.visibleColumns[s]&&"n"===this.fieldCategories.visibleColumns[s].name){let a=this.fieldCategories.visibleColumns[s],n=t("<td>");i.append(n.append('<span class="cell-value">').append(a.getCellText(null,n,e))),++s}for(;s<o;++s){let t,o=this.fieldCategories.visibleColumns[s];i.append(t=n._createCell(e,o)),a.indexOf(o.name)>-1&&n._colorizeElement(t,l)}return e.$tr},addThHelpCloser:function(){if(!this.pcTableContainerFieldHelpEvent){let e=this;this.pcTableContainerFieldHelpEvent=!0,this._container.on("click escPressed",(function(a){e._container.find('[id^="field-help"][aria-describedby^="popover"]').each((function(){t(this).attr("id")===a.target.id||t(a.target).closest("#"+t(this).attr("id")).length||t(this).trigger("close")}))}))}},refreshRow:function(e,a,n){if(e&&e.is(".DataRow")||a){a||(a=this._getItemByTr(e));let l=[];if(n){let e,s=!1;for(var i in this.isTreeView&&(e={id:a.id,tree:{v:a.tree.v},tree_category:{v:a.tree_category?a.tree_category.v:null}},this.fields.tree.treeBfield&&e[this.fields.tree.treeBfield]&&(e[this.fields.tree.treeBfield]={...a[this.fields.tree.treeBfield]})),n)null!==n[i]&&"object"==typeof n[i]?n[i].changed?(l.push(i),delete n[i].changed,s=!0):!Object.equals(n[i],a[i])&&i in this.fields&&"listRow"!==this.fields[i].type&&(l.push(i),s=!0):n[i]!=a[i]&&(l.push(i),s=!0),a[i]=n[i];s&&(t.extend(a,n),this.isTreeView&&this.placeInTree(a,e,!1))}e&&this._createRow(a,l)}else this._isParamsArea(e)?this._refreshParamsBlock():this._isFootersArea(e)&&this._refreshFootersBlock()},_createCell:function(e,a){let n=this;var i=t("<td>");let l,s="";e[a.name]||(console.log(App.translate("Field % not found",a.name)),console.log(e));try{l=t.extend({},n.f||{},e.f||{},e[a.name].f||{})}catch(t){console.log(t,e,a.name),l={}}let o=l.height>33||l.maxheight>33;!a.editable||!this.control.editing&&"filter"!==a.category||l.block||(i.addClass("edt"),a.editGroup&&(a.editGroupMultiColumns?i.addClass("e-gm").addClass("e-g"):i.addClass("e-g")),-1===["button","fieldParams"].indexOf(a.type)&&(n.isMobile||l.editbutton)&&(s='<button class="fa fa-edit pull-right ttm-edit ibtn"></button>')),n.isMobile&&"chart"!==a.type&&(s='<button class="fa fa-ellipsis-h ttm-panel pull-right ibtn"></button>'+s),l.block&&i.addClass("blocked"),"column"!==a.category&&i.attr("data-field",a.name);var r=t('<span class="cell-value">'),d=e[a.name];let c,p,f;if(a.linkFieldName||!a.code||a.codeOnlyInAdd||i.addClass("with-code"),"column"!==a.category&&"chart"!==a.type&&i.data("field",a.name).addClass("val"),d){if(c=d.e,!d.h||"showhand"in l&&!0!==l.showhand||(p=void 0!==d.c&&d.v!=d.c?t('<i class="fa fa-hand-paper-o pull-right cell-icon" aria-hidden="true"></i>'):t('<i class="fa fa-hand-rock-o pull-right cell-icon" aria-hidden="true"></i>'),n.isMobile&&p.addClass("ttm-panel")),d.d&&i.addClass("deleted_value"),d.e&&(a.errorText?r.text(a.errorText):(f=t('<i class="fa fa-exclamation-triangle pull-right" aria-hidden="true"></i>'),n.isMobile?f.addClass("ttm-panel"):f.attr("title",d.e),i.append(f))),!l.text||"button"==a.type||n.isTreeView&&"tree"===a.name&&e.__tree&&("self"===a.treeViewType||e.tree_category&&e.tree_category.v)){if(!d.e||!a.errorText){var h=o?a.getHighCelltext(d.v,i,e):a.getCellText(d.v,i,e);"object"==typeof h?r.html(h):r.text(h)}}else r.text(l.text);a.CodeActionOnClickAsUrl&&r.html(t('<span class="asUrl">').html(r.html()))}if(l.comment&&"button"!=a.type&&i.append(t('<i class="cell-icon fa fa-info pull-right"></i>').attr("title",l.comment)),p&&i.append(p),s&&i.append(s),r.appendTo(i),l.text||!a.unitType||c||null===d.v||"postfix"in a||"select"===a.type&&a.multiple||r.attr("data-unit-type"," "+a.unitType),a.css&&i.addClass(a.css),this.isSelected(a.name,e.id)&&i.addClass("selected"),"button"===a.type&&a.pcTable.isMobile&&"column"!==a.category||(l.background?i.css("background-color",l.background):a.panelColor&&i.css("background-color",a.panelColor),l.color&&i.css("color",l.color)),l.bold&&i.css("font-weight","bold"),l.align?i.css("text-align",l.align):l.tab&&i.css("padding-left",l.tab+"px"),l.decoration&&i.css("text-decoration",l.decoration),l.italic&&i.css("font-style","italic"),"tree"===a.type&&h&&"object"==typeof h&&h.is(".tree-view")?f&&f.remove():l.icon&&"button"!==a.type&&i.prepend('<i class="cell-icon fa fa-'+l.icon+'"></i>'),l.progress&&l.progresscolor){let e=function(){if(r.isAttached()){let e=Math.round(r.width()*parseInt(l.progress)/100);r.css("box-shadow","inset "+e.toString()+"px 0px 0 0 "+l.progresscolor)}else setTimeout(e,50)};n.isMobile&&i.data("addProgress",(function(){let e=i.find(".cell-value");e.css("box-shadow","inset "+Math.round(e.width()*parseInt(l.progress)/100).toString()+"px 0px 0 0 "+l.progresscolor)})),e()}return a.format=l,a.td_style&&"function"==typeof a.td_style&&i.css(a.td_style(l)),i},_getLoadingSpinner:function(){return t('<div class="text-center"><i class="fa fa-spinner"></i></div>')},_colorizeElement:function(e,t,a){let n=10,i=function(){0===n?e.css("box-shadow",""):(e.css("box-shadow","inset 0 0 100px 100px "+App.hexToRGB(t,n/10)),n--,setTimeout(i,50))};i()},_TmpColorize:function(e,t,a){var n,i=this;t=t||"#ff0000","#"!=(a=a||"#ffffff").substr(0,1)&&(a=App.rgb2hex(a)),(n=function(e,t,a){var n=parseInt(e.slice(1),16),i=(a=parseInt(a.slice(1),16),t<0?0:a>>16),l=t<0?0:a>>8&255,s=t<0?0:255&a,o=t<0?-1*t:t,r=n>>16,d=n>>8&255,c=255&n;return"#"+(16777216+65536*(Math.round((i-r)*o)+r)+256*(Math.round((l-d)*o)+d)+(Math.round((s-c)*o)+c)).toString(16).slice(1)}(t,.1,a))==t&&(n=a),e.css("background-color",n),n!=a?setTimeout((function(){i._TmpColorize(e,n,a)}),50):e.data("backgroundcolor")||e.attr("style",e.attr("style").replace(/(background\-color:[^;"]+;?)/,""))},__deleteSection(e){App.panelTimer(App.translate("Section deleting"),5,()=>{App.getPcTableById(2).then((function(t){t.model.checkEditRow({id:e.id}).then(a=>{let n=a.row.data_src.v;t.model.saveEditRow({data_src:{v:{...n,tableBreakBefore:{isOn:!1},sectionTitle:{isOn:!1,Val:n.sectionTitle.Val}}},id:e.id}).then(t=>{e.tableBreakBefore=!1,delete e.sectionTitle,"param"===e.category?e.pcTable._rerendParamsblock():e.pcTable._rerendBottomFoolers()})})}))})},__editSectionTitle(a){App.getPcTableById(2).then((function(n){n.model.checkEditRow({id:a.id}).then(i=>{let l,s=i.row.data_src.v,o="";s.sectionTitle&&"Val"in s.sectionTitle&&(o=s.sectionTitle.Val||"");let r=o.replace(/^(.*?)\*\*.*$/,"$1");/\*\*/.test(o)&&o.replace(/^.*?\*\*/,"").split(/\s*;\s*/).forEach(e=>{""!==e.trim()&&(r+="\n",r+=e.split(":").join(" : "))});let d=t('<div class="HTMLEditor">');e.top.BootstrapDialog.show({message:d,type:BootstrapDialog.TYPE_DANGER,title:App.translate("Section editing"),cssClass:"sectionTitle-edit-panel",draggable:!0,buttons:[{label:App.translate("Save"),action:e=>{(e=>{let t="";if(""!==e.trim()){let a=e.split(/\s*[\n\r]+\s*/),n=a[0];a.splice(0,1),t=n,a.length&&(t+="**"+a.join(";").replace(/\s*:\s*/g,":"))}let i=t;n.model.saveEditRow({data_src:{v:{...s,tableBreakBefore:{isOn:!0,Val:!0},sectionTitle:{isOn:!0,Val:i}}},id:a.id}).then(e=>{a.sectionTitle=i,a.tableBreakBefore=!0,"param"===a.category?a.pcTable._rerendParamsblock():a.pcTable._rerendBottomFoolers()})})(l.getValue()),e.close()}}],onhide:function(e){},onshown:function(a){a.$modalContent.position({of:t(e.top.document.body),my:"top+50px",at:"center top"}),l=CodeMirror(d.get(0),{value:r,mode:"sections",minHeight:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!1,autoCloseTags:!1}),l.on("paste",(function(e,t){setTimeout((function(){l.refresh()}),1)}))},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"100%"})}})})}))},getElementFormat:function(e,a){let n;return n=a?this.data[a]:this.data_params,t.extend({},this.f||{},n.f||{},n[e.name].f||{})}}),App.pcTableMain.prototype.fixColumn=function(e){this.fixedColumn&&(this._innerContainer.off("scroll.fixed-column"),this._container.off("scrolled.fixed-column"),this._innerContainer.find(".fixed-column").remove()),e&&setTimeout(()=>{let a,n,i=this,l=t('<tbody class="fixed-column"></tbody>');const s=()=>{let a=i.fields[e].$th,s=a.index(),o=a.outerWidth(),r=a.offset().left;l.width(o),l.css("max-height",i._innerContainer.height());let d=!1;if((d=r-i._innerContainer.offset().left+5<-1*o)||r-i._innerContainer.offset().left+5>i._innerContainer.width()){n||(n=!0,l.appendTo(this._innerContainer.find(".pcTable-table:first"))),d?l.css("left",i._innerContainer.scrollLeft()):l.css("left",i._innerContainer.scrollLeft()+i._innerContainer.width()-o+70);let e=t("<div>");i._innerContainer.find(".pcTable-table:first tbody.dataRows tr").each((function(){let a=t(this);if(a.is(".loading-row")){let t=a.clone();e.append(t)}else{let n=t(a.find("td")[s]);n.length?e.append(n.clone(!0)):e.append("<td></td>")}}));let r=t('<th class="top-head"></th>').text(a.find(".cell-title").clone().children().remove().end().text()).height(a.outerHeight());l.css({"padding-top":a.outerHeight()+1}),r.css("top",i._innerContainer.offset().top>0?0:-1*(i._innerContainer.offset().top-70)),l.empty().append(r).append(e)}else l.detach(),n=!1};i._innerContainer.on("scroll.fixed-column",()=>{a&&clearTimeout(a),a=setTimeout(s,200)}),i._container.on("scrolled.fixed-column",()=>{a&&clearTimeout(a),a=setTimeout(s,200)})},50),this.fixedColumn=e,this._refreshHead(),this._refreshContentTable()},function(){const e=function(e){e.forEach(e=>{let t=e.th.outerHeight();e.th.remove(),e.tdWrapper.data("height")&&e.tdWrapper.css("height",e.tdWrapper.data("height")+parseInt(t))})},a=(e,t,a,n)=>{e||(e={});const i=e=>{if(n){let t=e.split(/\s*\/\s*/);return t.length>1?{_big:l(t[0]),_small:l(t[1])}:{_big:l(e),_small:l(e)}}return l(e)},l=e=>{switch(e){case"false":case"FALSE":e=!1;break;case"true":case"TRUE":e=!0}return e=a(e)};return 3===t.length&&/^([a-z_0-9]+\s*,?\s*)+$/.test(t[1])?("object"!=typeof e&&(e={_ALL:e}),t[1].split(/\s*,\s*/).forEach(a=>{e[a]=i(t[2])})):"object"==typeof e&&Object.keys(e).length?e._ALL=i(t[1]):e=i(t[1]),e};App.pcTableMain.prototype.__fillFloatBlock=function(n,i){let l,s,o=this,r="",d={_ALL:!0},c=0,p=!1,f=!1,h=!1,u=!1,m=!1,b={},g=[],w={};t.each(i,(function(e,n){if(!o.isCreatorView&&o.isReplacedToRowsButtonsField(n.name))return;let i=!1;if(void 0!==n.sectionTitle){d={_ALL:!0},r=n.sectionTitle.trim(),c=0,p=!1,f=!1,h=!1,u=!1,s=n,w={},b={};let e={},l=r.match(/\*\*(.*)/);l&&(l[1].trim().split(/\s*;\s*/).forEach(t=>{let n=t.trim().split(/\s*:\s*/);if(n[0]=n[0].toLowerCase(),n.length>1)switch(n[0]){case"maxheight":case"height":case"maxwidth":case"nextline":case"blocknum":case"glue":case"fill":case"breakwidth":case"titleleft":case"titleright":let t;t=-1!==["titleleft","titleright"].indexOf(n[0])?e=>e.toString().trim().match(/^\d+$/)?e.toString().trim()+"px":e:e=>e,b[n[0]]=a(b[n[0]],n,t,!1);break;case"outline":f=a(f,n,e=>!0===e?"#e4e4e4":e,!0);break;case"blocktitle":w=a(w,n,e=>!1===e?"":e,!1);break;case"title":e.title=e.title||{_ALL:!0};let i=a({},n,e=>e);"boolean"==typeof i?e.title._ALL=i:e.title={...e.title,...i};break;case"border":h=a(h,n,e=>!1===e?"transparent":e,!0);break;case"plate":p=a(p,n,e=>!1===e?"transparent":e,!0);break;case"platemh":u=a(u,n,e=>"string"==typeof e&&/^\d+$/.test(e)?e+"px":e,!0);break;case"plateh":m=a(m,n,e=>"string"==typeof e&&/^\d+$/.test(e)?e+"px":e,!0);break;case"gap":e.gap=a(e.gap,n,e=>e);break;default:switch(n[1]){case"true":case"TRUE":e[n[0]]=!0;break;case"false":case"FALSE":e[n[0]]=!1}}}),c=e.gap||c),d="title"in e?e.title:d,o.isCreatorView?(r=r.replace(/(\*\*.*)/,""),i=!1===e.label||""===r):!1===e.label?r="":(r=r.replace(/(\*\*.*)/,""),r=t("<div>").text(r.trim()).html())}(!l||n.tableBreakBefore&&n.sectionTitle)&&(l=[],g.push({title:r,lableLowOpacity:i,formatsFromSection:b,fields:l,withTitles:d,sectionGap:c,plate:p,sectionField:s,outline:f,blocktitle:w,border:h,plateh:m,platemh:u}),r=""),n.showMeWidth&&l.push({field:n,panelColor:void 0})}));const v=(e,t)=>{let a=-1,n=e.fieldCell;t&&(n.prev().is("br")||n.is(":first-child")||n.prev().is('[data-type="blocknum"]')||("object"!=typeof t?a=t:e.format.blocknum in t?a=t[e.format.blocknum]:e.field.name in t&&(a=t[e.field.name]),a&&/^\d+$/.test(a)&&(a=parseInt(a)-1,a+="px"))),n.css("marginLeft",a)};g.forEach(a=>{if(!a.fields||!a.fields.length)return;let l=t('<div class="pcTable-section ">').appendTo(n),s=a.sectionGap;if(a.title||o.isCreatorView&&a.sectionField){let e=t("<span>").html(a.title);o.isCreatorView&&(t('<span class="danger"> <i class="fa fa-edit" style="font-size: 14px; padding-left: 10px;"></i></span>').on("click",()=>(this.__editSectionTitle(a.sectionField),!1)).appendTo(e),t('<span class="danger"> <i class="fa fa-times" style="font-size: 14px; padding-left: 5px;"></i></span>').on("click",()=>(this.__deleteSection(a.sectionField),!1)).appendTo(e)),o.___createClosedSection(l,t('<div class="pcTable-sectionTitle"></div>').html(e).appendTo(l),"param"===i[0].category?"p":"f"),a.lableLowOpacity&&l.find(".pcTable-sectionTitle").addClass("lowOpacity")}let r=t('<div class="pcTable-floatBlock">').appendTo(l);if(!r.is(":visible"))return void l.data("closedrender",!0);let d,c=0,p=[],f=[p],h=[f];a.fields.forEach((e,n)=>{e.field.tableBreakBefore&&0!==n&&(r=t('<div class="pcTable-floatBlock">').appendTo(l),p=[],f=[p],h.push(f)),o.data_params[e.field.name]=o.data_params[e.field.name]||{},e.format=o.data_params[e.field.name].f||{},Object.keys(a.formatsFromSection).forEach(t=>{let n=(i=t,l=e.field.name,s=a.formatsFromSection,o=e.format,i in o?o[i]:i in s&&s[i]?"object"==typeof s[i]?l in s[i]?s[i][l]:s[i]._ALL:s[i]:null);var i,l,s,o;null!==n&&(e.format[t]=n)});let i=e.format.blocknum||0;if(void 0!==e.format.blocknum&&l.addClass("sectionWithPannels"),0===p.length||p[p.length-1].num!=i||e.field.tableBreakBefore&&0!==n){if(d=t('<div class="pcTable-floatInner">').appendTo(r),i&&o.isCreatorView&&d.append('<div data-type="blocknum" style="position:absolute;z-index: 100; color: #ff8585; background-color: #fff; padding: 3px; font-size: 10px; right: 4px; top: 4px;">'+i+"</div>"),a.outline&&(i in a.outline?d.data("border-color",a.outline[i]):d.data("border-color",a.outline)),a.plate&&(i in a.plate?d.data("plate",a.plate[i]):d.data("plate",a.plate)),i&&a.blocktitle[i]){let e=t('<div class="blocktitle"></div>').append(t("<span>").text(a.blocktitle[i]));d.prepend(e)}a.plateh&&(i in a.plateh?d.data("plateh",a.plateh[i]):d.data("plateh",a.plateh)),a.platehm&&(i in a.platehm?d.data("platehm",a.platehm[i]):d.data("platehm",a.platehm)),p.push({div:d,num:i,isWrappable:!1,sec:a,fields:[]})}let s=p[p.length-1];s.fields.length>0&&!e.format.nextline&&(s.isWrappable=!0),s.fields.push(e),e._showMeWidth=e.field.showMeWidth,e.format.breakwidth&&(e.field.showMeWidth=parseInt(e.format.breakwidth)),e.format.nextline&&n>0&&d.append("<br/>");let u=t("<div>").appendTo(d);u.width(e.field.showMeWidth+1),u.attr("data-field-type",e.field.type),e.field.isNoTitles=!1,"withTitles"in a&&(e.field.name in a.withTitles?e.field.isNoTitles=!a.withTitles[e.field.name]:i&&i in a.withTitles?e.field.isNoTitles=!a.withTitles[i]:"_ALL"in a.withTitles&&(e.field.isNoTitles=!a.withTitles._ALL));let m=o._createHeadCell(null,e.field,e.panelColor).appendTo(u),b=t('<div class="td-wrapper">').appendTo(u);(e.format.titleleft||e.format.titleright)&&(u.css("display","inline-grid"),o.isCreatorView&&b.css("margin-top","18px"),e.format.titleleft?u.css("grid-template-columns",e.format.titleleft+" 1fr"):(b.prependTo(u),u.css("grid-template-columns","1fr "+e.format.titleright)));let g=o._createCell(o.data_params,e.field).appendTo(b);if(o.isCreatorView){let t=33;e.field.isNoTitles||(t=68),e.format.maxheight&&(e.format.maxheight=parseInt(e.format.maxheight)+t),e.format.height&&(e.format.height=parseInt(e.format.height)+t)}else if(!e.field.isNoTitles){let t=35;e.format.maxheight&&(e.format.maxheight=parseInt(e.format.maxheight)+t),e.format.height&&(e.format.height=parseInt(e.format.height)+t)}if(e.format.maxheight){let t={maxHeight:e.format.maxheight};e.format.height&&(t.minHeight=e.format.height,b.css("minHeight",e.format.height)),g.height(""),u.css(t),u.addClass("nonowrap")}else e.format.height&&(g.height(""),u.addClass("nonowrap"),u.height(e.format.height));e.field.isNoTitles?o.isCreatorView?m.addClass("no-titled"):m.empty():(m.css("display","table-cell"),e.th=m,m.height()>c&&(c=m.height())),e.td=g,e.th=m.width(""),e.tdWrapper=b,e.fieldCell=u,o.isCreatorView&&(e.format.glue&&u.addClass("f-glue"),e.format.fill&&u.addClass("f-fill"))}),a.fields.forEach(e=>{let t=0;if(e.th){e.th.css("display","");let a=21;o.isCreatorView&&(a=40),e.th.height(a),t=e.th.outerHeight()}e.format.maxheight?e.tdWrapper.css("maxHeight",e.format.maxheight-t-10):e.format.height&&!e.format.maxheight&&(e.tdWrapper.css("height",e.format.height-t),e.tdWrapper.data("height",e.format.height-t)),v(e,s)});const u=function(e){if(!e.length)return 0;let t,a,n=e[0].div.parent(),i=n.position().left+parseInt(n.css("paddingLeft"))+n.width();for(let n in e){let n=e[e.length-1].div;n.w=!1;let i=n.position().left+n.outerWidth();(!t||i>t)&&(t=i,a=e[e.length-1])}return a.w=!0,i-t},m=function(e){let t=!0;return e.some((e,a)=>{if(u(e)<0)return t=!1,!0}),t};let b=!1;h.forEach((function(a,n){let i=0;for(;++i<400&&!m(a);)a.forEach((function(e,t){if(u(e)<0){b=!0;for(let t=e.length-1;t>=0;t--){let a=e[t];if(a.isWrappable&&a.w){let e,t,n;for(let i=a.fields.length-1;i>=1;i--){let l=a.fields[i];l.i=i,(!n||l.fieldCell.position().left>n)&&(n=l.fieldCell.position().left,e=l,t=i)}if(e&&!e.format.nextline&&!e.fieldCell.prev().is("br")){if(e.format.glue)for(;;){if(!e.i){e=null;break}if(e=a.fields[e.i-1],t=e.i,e.format.nextline||e.fieldCell.is(":first-child")||e.fieldCell.prev().is("br")){e=null;break}if(!e.format.glue)break}if(e){e.fieldCell.before('<br class="wrapped"/>'),e.fieldCell.nextAll("br.wrapped").remove();for(let e=t;e<=a.fields.length-1;e++)v(a.fields[e],s);return}}}}let t=a[0].length-1;if(t>0){let e=a[0][t];e.div.before("<br/>"),a.push([e]),a[0].splice(t,1),a.forEach((function(e){e.forEach((function(e){e.div.find("br.wrapped").remove(),e.fields.forEach(e=>v(e,s))}))}))}}}));a.forEach((function(a,n){a.forEach(({div:e,fields:t})=>{t.forEach(e=>{e.format.breakwidth&&(e.fieldCell.css("width",e._showMeWidth),e.field.showMeWidth=e._showMeWidth)})}),function(e,a){if(!e.length)return;/Safari/.test(navigator.userAgent)&&e.forEach((function(e){e.div.width(100),e.div.width("")}));let n=u(e),i=0+parseInt(e[0].div.css("paddingTop")),l=[],s=[],o=0;e.forEach((function(e){let t,n=null,r={width:0,fields:[]};e.fields.forEach((function(e){(e.format.maxwidth&&e.field.width<e.format.maxwidth||e.format.fill&&(a||e.fieldCell.position().top!==i||null===i))&&(n!=e.fieldCell.position().top&&(n=e.fieldCell.position().top,r={width:0,fields:[]},n!==i?s.push(r):l.push(r)),r.fields.push(e),r.width+=e.field.width,n===i&&(o+=e.field.width)),t=e.fieldCell}))}));const r=function(e){let a,n,i=e.fields[0].fieldCell.parent(),l=e.fields[0].fieldCell.position().top;i.find(">div").each((function(e,i){let s=t(i),o=s.position();o.top===l&&(!a||o.left>a)&&(a=o.left,n=s)}));let s=i.width()+parseInt(i.css("paddingLeft"))-a-n.outerWidth(!0),o=0,r=0;for(;r++<100&&e.fields.length&&s>1;)e.fields.forEach((function(t,a){if(s>o){let n=Math.round(s/e.width*t.field.width);t.format.fill||t.format.maxwidth<=t.fieldCell.width()+n&&(n=t.format.maxwidth-t.fieldCell.width(),e.fields.splice(a,1),e.width-=t.field.width),o+=n,t.fieldCell.width(t.fieldCell.width()+n)}})),s-=o,o=0};l.forEach(r);let d=n,c=0,p=0;for(;d>1&&p++<6&&l.length;)l.forEach((function(e,t){e.fields.forEach((function(t,n){if(d>c){let i=Math.round(d/o*t.field.width);i>d-c&&(i=d-c),a&&t.format.fill||!(t.format.maxwidth<=t.fieldCell.width()+i)||(i=t.format.maxwidth-t.fieldCell.width(),e.fields.splice(n,1),o-=t.field.width),c+=i,t.fieldCell.width(t.fieldCell.width()+i)}})),0===e.fields.length&&l.splice(t,1)})),d-=c,c=0;s.forEach(r)}(a,b),a.forEach(({div:t,fields:a,sec:n,blocknum:i})=>{let l=[],s=!0;a.forEach(t=>{if(t.fieldCell.prev().is("br")&&(!o.isCreatorView&&l.length&&e(l),l=[],s=!0),t.field.isNoTitles?s&&l.push(t):(l=[],s=!1),n.border){let e;if(e=t.field.name in n.border?n.border[t.field.name]:i in n.border?n.border[i]:n.border,e){let a=a=>{let n=b?e._small:e._big,i={borderColor:n};return"transparent"===n?(a.background||t.panelColor||(i.backgroundColor="transparent"),"button"===t.field.type&&(t.fieldCell.addClass("no-border"),i.Button={},a.background&&(i.Button.backgroundColor=a.background),a.color&&(i.Button.color=a.color),t.td.find("button").css(i.Button),i.backgroundColor="transparent")):!0===n&&(i.borderColor="",i.backgroundColor="","button"===t.field.type&&(t.fieldCell.removeClass("no-border"),i.Button={},i.Button.backgroundColor="",i.Button.color=a.color,t.td.find("button").css(i.Button))),i};t.td.css(a(t.format)),t.field.td_style=a}else t.td.css(func_format(t.format)),t.field.td_style=func_format}}),!o.isCreatorView&&l.length&&e(l);let r={};if(t.data("plateh")){let e=t.data("plateh"),a=b?e._small:e._big;!1!==a&&(r.height=a,r.overflow="auto")}if(t.data("platemh")){let e=t.data("platemh"),a=b?e._small:e._big;!1!==a&&(r.maxHeight=a,r.overflow="auto")}t.data("border-color")&&(r.borderColor=b?t.data("border-color")._small:t.data("border-color")._big),t.data("plate")&&(r.backgroundColor=b?t.data("plate")._small:t.data("plate")._big),t.css(r)})}))}))})}}(),t.extend(App.pcTableMain.prototype,{_addHorizontalDraggable:function(){this._innerContainer.off("mousedown.HorizontalDraggable mouseout").on("mousedown.HorizontalDraggable",(function(e){for(var a=e;a;){if(t(e.target).is("input"))return!0;if(a==e.originalEvent)break;a=e.originalEvent}return t(this).data("x",e.clientX).data("scrollLeft",this.scrollLeft),!1})).on("mousemove",(function(e){if(0===t(e.target).closest(".InsertRow").length&&"INPUT"!==e.target.tagName&&1===e.buttons&&0===e.button&&Math.abs(t(this).data("x")-e.clientX)>20){let a;t(this).data("moved",!0),a&&clearTimeout(a),a=setTimeout((function(){t(this).data("moved",!1)}),200),this.scrollLeft=t(this).data("scrollLeft")+t(this).data("x")-e.clientX}}))}}),App.pcTableMain.prototype._addRowPanel=function(e,a,n){var i=t('<div style="width: 165px;"><div class="buttons insert-row-buttons"></div></div>');if(void 0!==n){var l=i.find(".buttons").empty();t.each(n,(function(e,a){if("function"==typeof a)var n=t('<button class="btn btn-sm btn-default">').html(e).on("click",a);else"object"==typeof a&&"checkbox"==a.type&&(n=t('<input type="checkbox">'),a.id&&n.attr("id",a.id),a.func&&n.on("change",a.func),n=n.wrap('<span style="font-size: 10px; padding-left: 8px;" >').parent().append(' <span style="padding-top: 2px;">'+e+"</span>"));l.append(" "),l.append(n)}))}a.on("remove",(function(){i.remove()}));let s=this;return setTimeout((function(){let e={isParams:!0,$text:i,element:a,container:s._container,placement:"bottom",trigger:"manual"};App.popNotify(e);let n=a.attr("aria-describedby"),l=t("#"+n).addClass("warning-bg");l.find(".arrow").css("left","80%"),s._positionPanel.call(s,l,a),i.show()}),50),i},App.pcTableMain.prototype._positionPanel=function(e,t){t.position();let a=this.tableWidth-120;this._innerContainer.width()>this.tableWidth?e.css({left:a}):e.css({left:this._innerContainer.width()-120})},t.extend(App.pcTableMain.prototype,{_csvExport:function(e){"use strict";let t=this;this.model.csvExport(t.dataSortedVisible,e,Object.keys(App.filter(t.fields,(e,t)=>!!t.showMeWidth))).then((function(e){if(e.csv){let a=new Blob([e.csv],{type:"text/csv;charset=utf-8"});saveAs(a,t.tableRow.title+"."+t.model.tableData.updated.dt+".csv")}}))},_csvImportClick:function(e){let a=this;t('<input type="file" accept="text/csv">').on("change",(function(){if(this.files&&this.files[0]){let t=new FileReader;t.onload=function(t){let n=t.target.result;a._csvImportUpload.call(a,n,e)},t.onerror=function(e){console.log(e.target.error)},t.readAsDataURL(this.files[0])}})).click()},_csvImportUpload:function(e,a){let n=this,i={},l=Object.keys(App.filter(n.fields,(e,t)=>!!t.showMeWidth&&"column"===t.category)),s=function(){n.model.csvImport(e,a,i,"full"==a?[]:l).then((function(e){e.question?App.modal(e.question[1],App.translate("Csv-loading question"),{[App.translate("Cancel")]:"close",[App.translate("Load")]:function(t){"use strict";t.modal("hide"),i[e.question[0]]=1,s()}}):e.ok&&n.table_modify.call(n,e)}))};if("rows"===a){let e=t("<div></div>");l.forEach(a=>{e.append(t("<div>").text(n.fields[a].title||n.fields[a].name))});App.confirmation(e,{[App.translate("Cancel")]:function(e){e.close()},[App.translate("Load")]:e=>{s(),e.close()}},App.translate("Check matching the structure of the loaded file to the sequence of fields"))}else s()}}),function(){t.extend(App.pcTableMain.prototype,{___fieldsHiddingShowAllButton:null,_hideHell_storage:{isset_fields:!1,opened:null,blinkIt:!1,getOpened:function(){return null===this._hideHell_storage.opened&&(this._hideHell_storage.opened=i.getSavedOpenedVal(this.tableRow),!1===this._hideHell_storage.opened&&(this._hideHell_storage.blinkIt=!0)),this._hideHell_storage.opened},checkIssetFields:function(e){if(this.isCreatorView&&this._beforeSpace){let t=this._hideHell_storage.isset_fields;if(this._hideHell_storage.isset_fields=Object.keys(this.hidden_fields).length||Object.keys(this.fields).some(e=>"n"!==e&&(!this.fields[e].showMeWidth||this.fields[e].showMeWidth<1)),e||t!==this._hideHell_storage.isset_fields){let e=this._beforeSpace.find("#hide-hell").removeClass("btn-contour");this._hideHell_storage.isset_fields?(e.removeAttr("disabled"),this._hideHell_storage.opened?(e.find("i").addClass("fa-arrow-up").removeClass("fa-arrow-down").removeClass("fa-times"),e.addClass("btn-contour")):(e.find("i").removeClass("fa-arrow-up").addClass("fa-arrow-down").removeClass("fa-times"),this._hideHell_storage.blinkIt&&(App.blink(e,8,"#fff"),this._hideHell_storage.blinkIt=!1))):(e.attr("disabled","disabled"),e.find("i").addClass("fa-times").removeClass("fa-arrow-up").removeClass("fa-arrow-down"))}}},switchOpened:function(){this._hideHell_storage.opened=!this._hideHell_storage.opened,this._hideHell_storage.checkIssetFields.call(this,!0),i.saveOpenedVal(this.tableRow,this._hideHell_storage.opened),this._refreshHiddenFieldsBlock()}},fieldsHiddingHide:function(e,t){let a=l.get(this.tableRow)||{};t?a[e]=this.fields[e].width:delete a[e],this.setVisibleFields(a)},setVisibleColumns:function(){let e=this;this.fieldCategories.visibleColumns=[],this.fieldCategories.column.forEach((function(t){t.showMeWidth&&e.fieldCategories.visibleColumns.push(t)}))},setColumnWidth:function(e,t,a){let n=l.get(this.tableRow)||{};n[e]=t;let i=this;a?App.getPcTableById(2).then((function(e){e.model.checkEditRow({id:a}).then((function(l){l.row&&(l.row.data_src.v.width.Val=parseInt(t),e.model.save({[a]:l.row}).then((function(){i.setVisibleFields(n)})))}))})):this.setVisibleFields(n)},loadVisibleFields:function(e){let t={},a=l.getDate(this.tableRow);e=e||{},!a||""!=this.tableRow.fields_actuality&&this.tableRow.fields_actuality>a?this.setVisibleFields(t,!0,moment().format(App.dateTimeFormats.db),e):(t=l.get(this.tableRow)||{},this.setVisibleFields(t,!0,void 0,e))},setVisibleFields:function(e,t,a,n){let i=this,s=!1,o=!1;n=n||{},e&&0===Object.keys(e).length?(e={},Object.values(i.fields).forEach((function(t){let a=t.hidden&&!1!==n[t.name]||!0===n[t.name]?0:t.width;a!=i.fields[t.name].showMeWidth&&("column"===t.category||"footer"===t.category&&t.column?s=!0:o=!0),i.fields[t.name].showMeWidth=a,e[t.name]=i.fields[t.name].showMeWidth}))):Object.values(i.fields).forEach((function(a){let l;l="filter"===a.category?a.width:void 0!==e[a.name]?parseInt(e[a.name]):t&&!a.hidden?a.width:0,a.name in n&&(l=!0===n[a.name]?0:a.width),l!=i.fields[a.name].showMeWidth&&("column"===a.category||"footer"===a.category&&a.column?s=!0:o=!0),i.fields[a.name].showMeWidth=l,e[a.name]=i.fields[a.name].showMeWidth})),l.set(e,this.tableRow,a),this.setVisibleColumns(),this._header&&(o&&this.setWidthes(),s&&(this._refreshHead(),this.rowButtonsCalcWidth(),this._refreshContentTable(!0),this._rowsButtons(),this._rerenderColumnsFooter(),Object.keys(this.data).forEach(e=>{delete this.data[e].$tr}),this.ScrollClasterized.insertToDOM(null,!0,!0)),this.isCreatorView&&(this._hideHell_storage.checkIssetFields.call(i),this._refreshHiddenFieldsBlock())),this.fieldsHiddingGetButton(),this._insertRow&&this._closeInsertRow()},hideAdminViewFields:function(){let e=this,t=l.get(this.tableRow)||{};Object.keys(t).forEach((function(a){if(t[a]>0){let n=e.fields[a];(!n||n.webRoles&&1===n.webRoles.length&&"1"==n.webRoles[0])&&delete t[a]}})),this.setVisibleFields(t)},setDefaultVisibleFields:function(){let e={};Object.values(this.fields).forEach((function(t){t.hidden?e[t.name]=0:e[t.name]=t.width})),this.setVisibleFields.call(this,e)},fieldsHiddingShowPanel:function(){let a,n,i=this,l=t('<div class="hidding-form">');const o=function(e){e=e||t("#defaultEyeGroups"),r=i.tableRow.fields_sets||[],e.empty().append("<b>"+App.translate("Default sets")+":</b> "),r.forEach((function(a,n){let l=t('<a href="#">').text(a.name).data("index",n);e.append(l.wrap("<span>").parent()),i.isCreatorView&&(n>0&&l.parent().append(t('<button class="btn btn-xxs field_name"><i class="fa fa-arrow-left"></i></button>').data("index",n)),l.parent().append(t('<button class="btn btn-xxs field_name"><i class="fa fa-remove"></i></button>').data("index",n)))})),e.off(),i.isCreatorView&&e.on("click",".btn",(function(){if(t(this).find("i").is(".fa-remove")){let e=t(this);i.model.removeEyeGroupSet(e.data("index")).then((function(e){i.tableRow.fields_sets=e.sets,o()}))}else{let e=t(this);i.model.leftEyeGroupSet(e.data("index")).then((function(e){i.tableRow.fields_sets=e.sets,o()}))}})),e.on("click","a",(function(){let e=t(this).data("index"),a=r[e].fields;if(Array.isArray(a)){let e={};a.forEach((function(t){i.fields[t]&&(e[t]=i.fields[t].width)})),a=e}i.setVisibleFields.call(i,a),n.close()}))};let r=s.getNames(i.tableRow);if(r&&r.length){let e=t('<div class="fieldsHiddenSets">').appendTo(l);e.append("<b>"+App.translate("Sets")+":</b> "),r.forEach((function(a){let n=t('<a href="#">').text(a).data("name",a);e.append(n.wrap("<span>").parent());let l=n.parent();l.append(t('<button class="btn btn-xxs" data-action="remove"><i class="fa fa-remove"></i></button>').data("name",a)),i.isCreatorView&&l.append(t('<button class="btn btn-xxs field_name" data-action="addDefaultSet" title="'+App.translate("Save as default set")+'"><i class="fa fa-save"></i></button>').data("name",a))})),e.on("click",".btn",(function(){let e=t(this),a=e.data("name");if(i.isCreatorView&&"addDefaultSet"===t(this).data("action")){let t=s.get(i.tableRow,a)||[];i.model.AddEyeGroupSet(a,t).then((function(t){i.tableRow.fields_sets=t.sets,o(),s.remove(i.tableRow,a),e.parent().remove()}))}else s.remove(i.tableRow,a),e.parent().remove()})),e.on("click","a",(function(){let e=t(this).data("name"),a=s.get(i.tableRow,e)||[];i.setVisibleFields.call(i,a),n.close()}))}r=i.tableRow.fields_sets||[];let d=t('<div class="fieldsHiddenSets" id="defaultEyeGroups">').appendTo(l);r&&r.length&&o(d),l.on("click",'input[type="checkbox"]',(function(e){let n=t(this),i=n.closest(".hidding-form");if(e.shiftKey){i.find("input").index(n);let e=i.find("input").index(t(this));i.find("input").each((function(i){(e<=i&&i<a||e>=i&&i>a)&&t(this).prop("checked",!!n.is(":checked")&&"checked").trigger("change")}))}else a=i.find("input").index(t(this))}));let c=[{label:App.translate("Apply"),action:function(e){let a={};l.find("input:checked").each((function(){let e=t(this);a[e.attr("name")]=parseInt(e.closest("div").find('input[type="number"]').val())||null})),i.setVisibleFields.call(i,a),e.close()}},{label:App.translate("By default"),action:function(e){e.close(),i.setDefaultVisibleFields.call(i)}},{label:App.translate("Show all"),action:function(e){e.close();let t={};Object.values(i.fields).forEach((function(e){t[e.name]=e.width})),i.setVisibleFields.call(i,t)}},{label:App.translate("Create a set"),action:function(a){let n={};l.find("input:checked").each((function(){let e=t(this);n[e.attr("name")]=parseInt(e.closest("div").find('input[type="number"]').val())||null})),i.setVisibleFields.call(i,n),a.close();let o=t("<div></div>");o.append('<div style="padding-top: 10px;"><label>'+App.translate("Set title")+'/label><input type="text" id="fieldsSetName" class="form-control"/></div>'),e.top.BootstrapDialog.show({message:o,title:App.translate("Save the fields set"),type:null,buttons:[{label:App.translate("Save"),action:function(e){let t=o.find("#fieldsSetName");""===t.val().trim()?t.addClass("error"):(s.set(i.tableRow,n,t.val().trim()),e.close())}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],draggable:!0})}},{label:App.translate("Cancel"),action:function(e){e.close()}}];i.isCreatorView&&c.splice(2,0,{label:App.translate("Hide admin. fields"),action:function(e){e.close(),i.hideAdminViewFields.call(i)}});let p={param:App.translate("Header"),column:App.translate("Columns"),footer:App.translate("Footer")};Object.keys(p).forEach((function(e){i.fieldCategories[e]&&i.fieldCategories[e].length&&(l.append('<div class="category-name">'+p[e]+"</div>"),t.each(i.fieldCategories[e],(function(e,a){let n="";a.hidden&&(n=" ("+App.translate("Hidden by default")+")");let i=t('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="'+a.name+'" class="form-check-input"> '+a.title+n+'</label> <input type="number" placeholder="'+a.width+'" value="'+(a.showMeWidth&&a.showMeWidth!==a.width?a.showMeWidth:a.width)+'"/></div>');a.showMeWidth&&(i.find("input").prop("checked",!0),i.attr("data-checked",!0)),i.appendTo(l)})))})),l.on("change",'input[type="checkbox"]',(function(){let e=t(this).closest("div");t(this).is(":checked")?e.attr("data-checked",!0):e.removeAttr("data-checked")})),n=e.top.BootstrapDialog.show({message:l,title:App.translate("Fields visibility"),buttons:c,type:null,draggable:!0,onshow:function(e){i.isCreatorView&&e.$modalContent.css({width:"800px"})}})},fieldsHiddingShowPanelMobile:function(){let a,n,i=this,l=t('<div class="hidding-form">');let s=i.tableRow.fields_sets||[],o=t('<div class="fieldsHiddenSets" id="defaultEyeGroups">').appendTo(l);s&&s.length&&function(e){e=e||t("#defaultEyeGroups"),s=i.tableRow.fields_sets||[],e.empty().append("<b>"+App.translate("Default sets")+":</b> "),s.forEach((function(a,n){let i=t('<a href="#">').text(a.name).data("index",n);e.append(i.wrap("<span>").parent())})),e.off(),e.on("click","a",(function(){let e=t(this).data("index"),a=s[e].fields;if(Array.isArray(a)){let e={};a.forEach((function(t){i.fields[t]&&(e[t]=i.fields[t].width)})),a=e}i.setVisibleFields.call(i,a),n.close()}))}(o),l.on("click",'input[type="checkbox"]',(function(e){let n=t(this),i=n.closest(".hidding-form");if(e.shiftKey){i.find("input").index(n);let e=i.find("input").index(t(this));i.find("input").each((function(i){(e<=i&&i<a||e>=i&&i>a)&&t(this).prop("checked",!!n.is(":checked")&&"checked").trigger("change")}))}else a=i.find("input").index(t(this))}));let r=[{label:App.translate("Apply"),action:function(e){let a={};l.find("input:checked").each((function(){let e=t(this);a[e.attr("name")]=i.fields[e.attr("name")].width})),i.setVisibleFields.call(i,a),e.close()}},{label:App.translate("By default"),action:function(e){e.close(),i.setDefaultVisibleFields.call(i)}},{label:App.translate("Show all"),action:function(e){e.close();let t={};Object.values(i.fields).forEach((function(e){t[e.name]=e.width})),i.setVisibleFields.call(i,t)}},{label:App.translate("Cancel"),action:function(e){e.close()}}],d={param:App.translate("Header"),column:App.translate("Columns"),footer:App.translate("Footer")};Object.keys(d).forEach((function(e){i.fieldCategories[e]&&i.fieldCategories[e].length&&(l.append('<div class="category-name">'+d[e]+"</div>"),t.each(i.fieldCategories[e],(function(e,a){let n="";a.hidden&&(n=" ("+App.translate("Hidden by default")+")");let i=t('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="'+a.name+'" class="form-check-input"> '+a.title+n+"</label></div>");a.showMeWidth&&(i.find("input").prop("checked",!0),i.attr("data-checked",!0)),i.appendTo(l)})))})),l.on("change",'input[type="checkbox"]',(function(){let e=t(this).closest("div");t(this).is(":checked")?e.attr("data-checked",!0):e.removeAttr("data-checked")})),n=e.top.BootstrapDialog.show({message:l,title:App.translate("Fields visibility"),buttons:r,type:null,draggable:!0,onshow:function(e){i.isCreatorView&&e.$modalContent.css({width:"800px"})}})},fieldsHiddingGetButton:function(e){"use strict";let a=this;if(!this.___fieldsHiddingShowAllButton)if(this.___fieldsHiddingShowAllButton=t('<button class="btn btn-sm"><span class="fa fa-eye-slash"></span></button>'),this.isMobile)this.___fieldsHiddingShowAllButton.on("click",(function(){a.fieldsHiddingShowPanelMobile.call(a)}));else{let e;this.___fieldsHiddingShowAllButton.on("click",(function(){a.fieldsHiddingShowPanel.call(a)})).on("contextmenu",(function(){return a.isCreatorView?e?(clearTimeout(e),e=null,a.hideAdminViewFields.call(a,!0)):e=setTimeout((function(){a.setDefaultVisibleFields.call(a),e=null}),500):a.setDefaultVisibleFields.call(a),!1}))}return Object.values(a.fields).some((function(e){if(e.showInWeb&&!e.hidden&&!e.showMeWidth)return!0}))?(this.___fieldsHiddingShowAllButton.addClass("btn-warning"),this.___fieldsHiddingShowAllButton.removeClass("btn-default"),e&&App.blink(this.___fieldsHiddingShowAllButton,8,"#fff")):(this.___fieldsHiddingShowAllButton.addClass("btn-default"),this.___fieldsHiddingShowAllButton.removeClass("btn-warning")),this.___fieldsHiddingShowAllButton}});let a="pcTableShowFieldsWithDates",n=function(e){let t=e.id;return"calcs"===e.type&&(t+="$"+e.__version),t},i={saveOpenedVal:function(e,t){localStorage.setItem(this.getKeyString(e),t.toString())},getKeyString:function(e){return e.id+"/"+e.__version},getSavedOpenedVal:function(e){let t=localStorage.getItem(this.getKeyString(e));return!t||JSON.parse(t)}},l={set:function(e,t,i){let l=n(t),s={},o=e||{};try{s=JSON.parse(localStorage.getItem(a))||{}}catch(e){}i||!s[l]?s[l]=[o,i]:s[l][0]=o,localStorage.setItem(a,JSON.stringify(s))},get:function(e){let t=n(e);return l.getInner(t)[0]},getDate:function(e){let t=n(e);return l.getInner(t)[1]},getInner:function(e){let t;try{t=JSON.parse(localStorage.getItem(a))||{}}catch(e){t={}}return t[e]||[]}},s={set:function(e,t,a){let i=[],l="pcTableShowFieldsSets"+n(e),s=t||[];try{i=JSON.parse(localStorage.getItem(l))||{}}catch(e){}i[a]=s,localStorage.setItem(l,JSON.stringify(i))},get:function(e,t){let a,i="pcTableShowFieldsSets"+n(e);try{a=JSON.parse(localStorage.getItem(i)),a=a[t]}catch(e){}return null==a&&(a=void 0),a},getNames:function(e){let t,a="pcTableShowFieldsSets"+n(e);try{return t=JSON.parse(localStorage.getItem(a)),Object.keys(t)}catch(e){}return null==t&&(t=void 0),t},remove:function(e,t){let a,i="pcTableShowFieldsSets"+n(e);try{a=JSON.parse(localStorage.getItem(i)),delete a[t],localStorage.setItem(i,JSON.stringify(a))}catch(e){}}}}(),App.pcTableMain.prototype._print=function(){"use strict";let a=t('<div class="hidding-form">');const n=function(e){if(e.showMeWidth)return!0};this.fieldCategories.param.length&&this.fieldCategories.param.some(n)&&a.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="params" class="form-check-input" checked="checked"> '+App.translate("Parameters")+"</label></div>"),this.fieldCategories.filter.length&&a.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="filters" class="form-check-input" checked="checked"> '+App.translate("Filters")+"</label></div>"),this.fieldCategories.column.length&&this.fieldCategories.column.some(n)&&this.dataSortedVisible.length&&(a.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="rows" class="form-check-input" checked="checked"> '+App.translate("Rows part")+"</label></div>"),a.append('<div class="form-check no-bold" style="padding-left: 20px;"><label class="form-check-label"><input type="checkbox" name="with-id" class="form-check-input"> '+App.translate("with id")+"</label></div>")),this._footersBlock.find(".val").length&&a.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="column-footers" class="form-check-input" checked="checked"> '+App.translate("Column footers")+"</label></div>"),this._footersSubTable.find(".val").length&&a.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="other-footers" class="form-check-input" checked="checked"> '+App.translate("Out of column footers")+"</label></div>");let i=this,l=[{label:App.translate("Print"),action:function(e){let n=[];a.find("input:checked").each((function(){n.push(t(this).attr("name"))})),e.close(),i._printTable.call(i,n)}},{label:App.translate("Cancel"),action:function(e){e.close()}}];e.top.BootstrapDialog.show({message:a,type:null,title:App.translate("Print"),buttons:l,draggable:!0})},App.pcTableMain.prototype._printTable=function(e){let t=this,a={fields:{}};-1!==e.indexOf("with-id")&&(a.fields.id=50);let n={params:t.fieldCategories.param,filters:t.fieldCategories.filter,rows:t.fieldCategories.column,"column-footers":t.fieldCategories.footer.filter((function(e){return""!==e.column})),"other-footers":t.fieldCategories.footer.filter((function(e){return""===e.column}))};Object.keys(n).forEach((function(t){-1!==e.indexOf(t)&&n[t].forEach((function(e){"button"===e.type||e.showMeWidth<1||!e.showMeWidth||(a.fields[e.name]=e.showMeWidth)}))})),-1!==e.indexOf("rows")&&(a.ids=t.dataSortedVisible),a.sosiskaMaxWidth=1100,t.model.printTable(a)},App.pcTableMain.prototype.reOrderRows=function(e,a){let n,i=this;if(i.tableRow.with_order_field&&!i.nSorted)return App.notify(App.translate("To operate the order field, reload the table")),!1;if(i.isRestoreView)return App.notify(App.translate("Rows restore mode. Sorting disabled")),!1;let l=[];if(0===this.row_actions_get_checkedIds().length){l.push(e);let t=this.dataSortedVisible.indexOf(e)+("after"===a?1:-1);if(t<0||!(t in this.dataSortedVisible))return;if(this.data[this.dataSortedVisible[t]].f&&this.data[this.dataSortedVisible[t]].f.blockorder)return void App.notify(App.translate("You cannot move the row %s",this.getRowTitle(this.data[this.dataSortedVisible[t]])));n=this.dataSorted.indexOf(this.dataSortedVisible[t]),l.forEach((function(e){i.dataSorted.splice(i.dataSorted.indexOf(e),1)}))}else{if(-1!==i.row_actions_get_checkedIds().indexOf(e))return App.notify(App.translate("The unchecked row should be selected as the anchor for the move")),!1;let t=this.row_actions_get_checkedIds().length;this.dataSorted.some((function(e,a){if(0===t)return!0;i.data[e].$checked&&(l.push(e),--t)})),l.forEach((function(e){i.dataSorted.splice(i.dataSorted.indexOf(e),1)})),n=this.dataSorted.indexOf(e)+("after"===a?1:0)}i.dataSorted.splice(n,0,...l),this.dataSortedVisible=[],i.dataSorted.forEach((function(e){i.data[e].$visible&&i.dataSortedVisible.push(e)})),i._refreshContentTable(),i.tableRow.with_order_field&&t("table.pcTable-table").addClass("reordered"),i.row_actions_uncheck_all()},App.pcTableMain.prototype.reOrderRowsSave=function(){let e=this;e._orderSaveBtn.prop("disabled",!0).find("i").attr("class","fa fa-cog"),this.model.saveOrder(this.dataSorted).then((function(a){e.table_modify(a),e._orderSaveBtn.prop("disabled",!1).find("i").attr("class","fa fa-save"),t("table.pcTable-table").removeClass("reordered")}))},App.pcTableMain.prototype.addReOrderRowBind=function(){let e=this;e._innerContainer.on("click","td.n button",(function(a){let n=t(this);e.tableRow.with_order_field&&!e.__getCheckedRowsIds(void 0,!0,"blockorder")||e.reOrderRows.call(e,e._getItemByTr.call(e,n.closest("tr")).id,1===n.find(".fa-angle-up").length?"before":"after")}))},App.pcTableMain.prototype.__formatFunctions={blockadd:function(){this._closeInsertRow(),this._rowsButtons()},tablecomment:function(){this._rowsButtons()},buttons:function(){this._rerendParamsblock(),this._rowsButtons()},blockorder:function(){this._refreshHead()},block:function(){this._refreshParamsBlock(),this._refreshContentTable(!0),this._refreshFootersBlock()},tabletitle:function(){this._refreshTitle()},tabletext:function(){this._refreshTableText()},text:function(){this._refreshTableText()},rowstitle:function(){this._container.find(".pcTable-rowsTitle:first").replaceWith(this._createRowsTitle())},fieldtitle:function(e,t){let a={};const n=function(e){return"footer"==e.category&&e.column?"tableFooter":e.category};for(const i in e)this.fields[i]&&e[i]!==t[i]&&(a[n(this.fields[i])]=!0);for(const i in t)this.fields[i]&&e[i]!==t[i]&&(a[n(this.fields[i])]=!0);for(const e in a)switch(e){case"param":this._rerendParamsblock();break;case"filter":this._rerendFiltersBlock();break;case"column":this._refreshHead();break;case"footer":this._rerendBottomFoolers();break;case"tableFooter":this._rerenderColumnsFooter()}}},App.pcTableMain.prototype._connectTreeView=function(){let e=this;this._content.on("click",".treeRow",(function(){let a=t(this);a.is(".dbl")?e._actionTreeFolderRow(a,!0):a.is(".ins")?e._actionAddTreeFolderRow(a):e._actionTreeFolderRow(a)})),this.model.loadTreeBranches=function(e,t,a){return this.__ajax("post",{method:"loadTreeBranches",branchIds:e,withParents:t,recurcive:a},null,null,this.filtersString||{})},setTimeout(()=>{if(this.fields.tree.treeViewLoad&&!Object.values(this.filters||{}).length){let a=!1;t("#table").data("pctable").fieldCategories.filter.forEach(t=>{t.column&&"tree"!==t.column&&this.data_params[t.name].v&&("object"!=typeof this.data_params[t.name].v?this.data_params[t.name].v.match(/\*(ALL|NONE)\*/):-1===this.data_params[t.name].v.indexOf("*ALL*")&&-1===this.data_params[t.name].v.indexOf("**NONE**")&&(this.filters[t.column]=this.data_params[t.name].v,a=!0)),a&&e.__applyFilters(!0)})}},10),this.reOrderRows=function(e,a){let n=this;if(e=e.toString(),n.tableRow.with_order_field&&!n.nSorted)return App.notify(App.translate("To operate the order field, reload the table")),!1;if(n.isRestoreView)return App.notify(App.translate("Rows restore mode. Sorting disabled")),!1;if(void 0!==this.nSortedTree&&this.data[e].tree.v!=this.nSortedTree)return App.notify(App.translate("It is possible to sort only within a category")),!1;this.nSortedTree=this.data[e].tree.v;let i,l=this.treeIndex[this.nSortedTree].sorted,s=[];if(0===this.row_actions_get_checkedIds().length){s.push(e);let t=l.indexOf(e),n=t+("after"===a?1:-1);if(!(n in l))return;let o=l[n];if(this.data[o].f&&this.data[o].f.blockorder)return void App.notify(App.translate("You cannot move the row %s",this.getRowTitle(this.data[o])));l.splice(t,1),i=l.indexOf(o)+("after"===a?1:0)}else{if(-1!==n.row_actions_get_checkedIds().indexOf(e))return App.notify(App.translate("The unchecked row should be selected as the anchor for the move")),!1;let t=this.row_actions_get_checkedIds().length;this.dataSorted.some((e,a)=>{if(0===t)return!0;if("object"==typeof e){if(e.row&&e.row.$checked)return this.nSortedTree=void 0,App.notify(App.translate("Only nested rows can be moved")),!0}else if(n.data[e].$checked){if(n.data[e].tree.v!=this.nSortedTree)return this.nSortedTree=void 0,App.notify(App.translate("You can only move within one branch")),!0;s.push(e),--t}}),s.forEach((function(e){l.splice(l.indexOf(e),1)})),i=l.indexOf(e)+("after"===a?1:0)}l.splice(i,0,...s),this.ntreeSortedArr=l,n.tableRow.with_order_field&&(this.nReorderedTree=this.nSortedTree,t("table.pcTable-table").addClass("reordered")),n.treeApply(),n.row_actions_uncheck_all()},this.reOrderRowsSave=function(){let e=this;e._orderSaveBtn.prop("disabled",!0).find("i").attr("class","fa fa-cog"),this.model.saveOrder(this.ntreeSortedArr.map(e=>parseInt(e))).then((function(a){e.nSortedTree=void 0,e.table_modify(a),e._refreshContentTable(!0),e._orderSaveBtn.prop("disabled",!1).find("i").attr("class","fa fa-save"),t("table.pcTable-table").removeClass("reordered")}))};const a=App.pcTableMain.prototype._refreshCheckedStatus;this._refreshCheckedStatus=function(){a.call(this);let e=this.nSortedTree,t=!!this.nSortedTreeBlock;this.nSortedTreeBlock=!1,this.__checkedRows.length||this.nReorderedTree||(this.nSortedTree=void 0),this.__checkedRows.some(e=>{if(this.data[e].__tree)return this.nSortedTreeBlock=!0,!0;if(void 0!==this.nSortedTree){if(this.data[e].tree.v!==this.nSortedTree)return this.nSortedTreeBlock=!0,!0}else this.nSortedTree=this.data[e].tree.v}),e==this.nSortedTree&&t==this.nSortedTreeBlock||this.ScrollClasterized.insertToDOM(null,!1,!0)}},App.pcTableMain.prototype._treeFolderRowAddDropdown=function(a,n){let i,l=t("<div>"),s=t('<button class="btn btn-default btn-xxs treeRow"><i class="fa fa-caret-down"></i></button>').popover({html:!0,content:l,trigger:"manual",container:this._container,placement:"auto bottom"}).on("click",()=>(t("body").trigger("click"),s.popover("show"),i=t("#"+s.attr("aria-describedby")),setTimeout(()=>{this.closeCallbacks.push(()=>{s&&s.length&&s.popover("hide")})},200),!1)).on("remove",()=>{i.remove()});a.append(s);let o=t('<div class="menu-item"><i class="fa fa-arrows-v"></i> '+(n.opened?App.translate("Close all"):App.translate("Open all"))+"</div>").data("treeRow",n.v).on("click",()=>{this._actionTreeFolderRow(o,!0)}).appendTo(l);this.fields.tree.selectTable&&n.v&&!this.fields.tree.treeBfield&&(t('<div class="menu-item"><i class="fa fa-edit"></i> '+App.translate("Edit")+"</div>").on("click",()=>{let e={id:n.v};new EditPanel(this.fields.tree.selectTable,null,e).then(()=>{this.model.refresh()})}).appendTo(l),t('<div class="menu-item"><i class="fa fa-plus"></i> '+App.translate("Add a branch")+"</div>").on("click",()=>{let e={[this.fields.tree.treeViewParentField||"tree"]:{v:n.v}};new EditPanel(this.fields.tree.selectTable,null,e,null,{tree:!0}).then(e=>{this.treeReloadRows.push(Object.keys(e.chdata.rows)[0]),this.treeApply()})}).appendTo(l)),this.isInsertable()&&t('<div class="menu-item"><i class="fa fa-th-large"></i> '+App.translate("Add a row")+"</div>").on("click",()=>{if("cycles"===this.tableRow.type)this.model.add(null,{tree:n.v}).then(t=>{t.firstTableId?e.location.href=e.location.pathname+"/"+t.chdata.rows[0].id+"/"+t.firstTableId:this.table_modify(t)});else{let e={tree:{v:n.v}};new EditPanel(this,null,e,null,{tree:!0}).then(()=>{this.model.refresh()})}}).appendTo(l)},App.pcTableMain.prototype._createTreeFolderRow=function(e,a){if(e.row&&this.data[e.row.id]){let t={...e};delete t.row,e.row.__tree=t;let n=a||this._createRow(e.row);return this.data[e.row.id].__tree=t,e.tr=this.data[e.row.id].$tr=n}{let n=a||t('<tr><td class="id"></td></tr>'),i=t('<i class="fa fa-folder'+(e.opened?"-open":"")+' treeRow"></i>').data("treeRow",e.v),l=t('<span class="tree-view">').append(i),s=t('<td colspan="'+(this.fieldCategories.column.length-1)+'" class="tree-view-td" style="padding-left: '+(7+22*e.level)+'px"></td>');return s.append(l),this._treeFolderRowAddDropdown(l,e),s.append(t('<span class="treeRow">').text(e.t).data("treeRow",e.v)),n.append(s),e.tr=n}},App.pcTableMain.prototype.treeApply=function(){this.treeReloadRows.length?this.model.loadTreeBranches(this.treeReloadRows,!0).then(e=>{e.tree&&(e.tree.forEach((e,t)=>{this.treeIndex[e.v]&&(this.treeIndex[e.v].trees=[])}),e.tree.forEach((e,t)=>{this.getTreeBranch(e,t)})),e.rows&&this._treeApplyRows(e.rows),this.treeReloadRows=[],this._treeRefresh(),this.__applyFilters(!0),this.ScrollClasterized.insertToDOM(null,!0,!0)}):(this._treeRefresh(),this.__applyFilters(!0),this.ScrollClasterized.insertToDOM(null,!0,!0))},App.pcTableMain.prototype._closeTreeFolderRow=function(e,t,a){e.opened=!1,a=a||0,t?(this.treeIndex[e.v].trees.forEach(e=>{this._closeTreeFolderRow(this.treeIndex[e],!0,a+1)}),a||this.treeApply()):this.treeApply()},App.pcTableMain.prototype._actionTreeFolderRow=function(e,a){let n=this.treeIndex[t(e).data("treeRow")];e&&t(e).closest("td").html(App.translate("Loading")),n.opened?this._closeTreeFolderRow(n,a):this._expandTreeFolderRow(n,a)},App.pcTableMain.prototype._actionAddTreeFolderRow=function(e,t){if("self"===this.fields.tree.treeViewType){let t={tree:{v:this._getItemBytd(e.closest("td")).id}};new EditPanel(this,null,t,null,{tree:!0}).then(e=>{this.table_modify(e),this.reloaded()})}},App.pcTableMain.prototype._expandTreeFolderRow=function(e,t,a){let n=!1;a||(n=!0,a={counter:0});const i=()=>{this.treeIndex[e.v].trees.forEach(e=>{a.counter++,this._expandTreeFolderRow(this.treeIndex[e],!0,a)})};e.l?(e.opened=!0,t?(i(),a.counter<1?this.treeApply():a.counter--):this.treeApply()):this.model.loadTreeBranches([e.v],null,!!t).then(n=>{e.opened=!0,e.l=!0,n.tree&&n.tree.forEach((e,t)=>{this.getTreeBranch(e,t)}),n.rows&&this._treeApplyRows(n.rows),(!t||a.counter--<1)&&this.treeApply()})},App.pcTableMain.prototype._treeRefresh=function(){const e=(t,a)=>{a=a||0,t.forEach(t=>{this.treeIndex[t].level=a,0!==a||"opened"in this.treeIndex[t]||(this.treeIndex[t].opened=!0),this.dataSorted.push(this.treeIndex[t]),this.treeIndex[t].opened&&(this.dataSorted.push(...this.treeIndex[t].sorted),e(this.treeIndex[t].trees,a+1))})};this.dataSorted=[];let t=[...this.treeSort];""==t[0]&&0===this.treeIndex[""].sorted.length&&delete t[0],e(t)},App.pcTableMain.prototype._treeApplyRows=function(e){e.map(e=>{this.placeInTree(e),e.id in this.data||(this.data[e.id]=e,this.data[e.id].$checked=-1!==this.__checkedRows.indexOf(e.id))},this)},App.pcTableMain.prototype.removeTreeBranch=function(e){if(e in this.treeIndex)if(this.treeIndex[e].p){let t=this.treeIndex[this.treeIndex[e].p];this.treeReloadRows.push(t.v)}else delete this.treeIndex[e],this.treeRefresh()},App.pcTableMain.prototype.getElementInTree=function(e){return this.treeIndex[e]},App.pcTableMain.prototype.placeInTree=function(e,t,a){let n="sorted";const i=e=>{let t=e.id;return this.fields.tree.treeBfield&&e[this.fields.tree.treeBfield]&&(t=e[this.fields.tree.treeBfield].v),t};if("self"===this.fields.tree.treeViewType&&(n="trees"),t){let a=t?t.tree.v:void 0;if(null===a&&(a=""),"other"===this.fields.tree.treeViewType&&t.tree_category&&t.tree_category.v&&this.treeIndex[t.tree_category.v]&&this.treeIndex[t.tree_category.v].row&&this.treeIndex[t.tree_category.v].row.id===t.id&&delete this.treeIndex[t.tree_category.v].row,a in this.treeIndex){let l=i(t);if(e&&i(e)==l){if(!e||e.tree.v!=t.tree.v){let e=this.treeIndex[t.tree.v][n].indexOf(l.toString());-1!==e&&this.treeIndex[t.tree.v][n].splice(e,1)}}else{let e=this.treeIndex[a][n].indexOf(l.toString());-1!==e&&this.treeIndex[a][n].splice(e,1)}}else if("self"===this.fields.tree.treeViewType&&(!e||this.treeIndex[i(e)].p!=this.treeIndex[i(t)].p)){let e=this.treeSort.indexOf(i(t).toString());-1!==e&&this.treeSort.splice(e,1)}this.treeRefresh=!0}if(e){if("other"===this.fields.tree.treeViewType&&e.tree_category&&e.tree_category.v&&this.treeIndex[e.tree_category.v])this.treeIndex[e.tree_category.v].row=e;else{let t=e.tree.v||"",l=i(e);"self"===this.fields.tree.treeViewType&&(l in this.treeIndex?this.treeIndex[l].row=e:n="sorted"),t in this.treeIndex&&this.treeIndex[t].l?(-1===this.treeIndex[t][n].indexOf(l.toString())&&this.treeIndex[t][n].push(l.toString()),a&&this.openTreeWithParent(this.treeIndex[t])):t&&this.treeReloadRows.push(t)}this.treeRefresh=!0}},App.pcTableMain.prototype.openTreeWithParent=function(e){e.opened=!0,e.p&&this.treeIndex[e.p]&&this.openTreeWithParent(this.treeIndex[e.p])},App.pcTableMain.prototype.treeDeletingRow=function(e){let t=this.data[e];t&&this.placeInTree(null,t)},App.pcTableMain.prototype.getTreeBranch=function(e){if(null===e.v?e.v="":e.v=e.v.toString(),this.treeIndex[e.v]||(this.treeIndex[e.v]={...e},this.treeIndex[e.v].sorted=this.treeIndex[e.v].sorted||[],this.treeIndex[e.v].trees=this.treeIndex[e.v].trees||[]),this.treeIndex[e.v].l="l"in e?e.l:"l"in this.treeIndex[e.v]?this.treeIndex[e.v].l:""===e.v,this.treeIndex[e.v].opened="opened"in e?e.opened:"opened"in this.treeIndex[e.v]?this.treeIndex[e.v].opened:""===e.v,void 0!==e.p&&this.treeIndex[e.v].p!=e.p&&void 0!==this.treeIndex[e.v].p&&this.treeIndex[e.v].p in this.treeIndex){let t=this.treeIndex[this.treeIndex[e.v].p].trees.indexOf(this.treeIndex[e.v].v);-1!==t&&this.treeIndex[this.treeIndex[e.v].p].trees.splice(t,1)}if(e.p){let t=this.getTreeBranch({v:e.p});-1===t.trees.indexOf(e.v)&&t.trees.push(e.v);let a=this.treeSort.indexOf(e.v);-1!==a&&this.treeSort.splice(a,1)}else e.t&&-1===this.treeSort.indexOf(e.v)&&this.treeSort.push(e.v);return Object.keys(e).forEach(t=>{this.treeIndex[e.v][t]=e[t]}),this.treeIndex[e.v]},function(){const e=function(e){let a=this.data[e],n=a.$tr||t('<div class="panelsView-card pcTable-floatInner">').css({"min-height":this.tableRow.panels_view.height+"px",height:this.tableRow.panels_view.height,width:this.tableRow.panels_view.width});if(a.$tr=n.empty(),n.data("id",e),this.tableRow.panels_view.fields.forEach(i=>{let l=t("<td>"),s={};s.height=i.height,l.data("name",i.field),i.border||(s["border-color"]="transparent",s["background-color"]="transparent");let o,r=this.fields[i.field];try{o=t.extend({},this.f||{},a.f||{},a[i.field].f&&a[i.field].f||{})}catch(e){console.log(e,a,i.field),o={}}if("button"!=r.type){if(o.color&&(s["font-color"]=o.color),o.background&&(s["background-color"]=o.background),o.text)l.text(o.text);else{let e=r.getHighCelltext(a[i.field].v,l,a);null!==e&&"object"==typeof e?e.then&&"function"==typeof e.then?(l.html('<div class="text-center"><i class="fa fa-spinner"></i></div>'),e.then(e=>{"object"==typeof e?l.html(e):l.text(e)})):l.html(e):l.text(e),r.unitType&&""!==e&&l.append(" "+r.unitType)}if(o.comment?l.prepend(t('<i class="fa fa-help">').attr("title",o.comment)):o.icon&&l.prepend(t('<i class="fa">').addClass("fa-"+o.icon)),l.attr("data-field-type",r.type).addClass("nonowrap"),r.editable&&r.pcTable.control.editing&&!o.block&&l.addClass("panel-edt"),!1!==o.showhand&&a[i.field].h){let e,n=a[i.field];e=void 0!==n.c&&n.v!=n.c?t('<i class="fa fa-hand-paper-o pull-right cell-icon" aria-hidden="true"></i>'):t('<i class="fa fa-hand-rock-o pull-right cell-icon" aria-hidden="true"></i>'),l.append(e)}}else{a.__td_style=function(){let e={td:{},Button:{}};return o.background&&(e.Button.backgroundColor=o.background),o.color&&(e.Button.color=o.color),e.td.backgroundColor="transparent",e},l.html(r.getCellText(a[i.field].v,l,a)),l.find("button").on("click",()=>{this._buttonClick(l,r,a)})}if(o.bold&&(s["font-weight"]="bold"),o.italic&&(s["font-style"]="italic"),o.decoration&&(s["text-decoration"]=o.decoration),o.align&&(s["text-align"]=o.align),o.color&&(s.color=o.color),o.tab&&(s["padding-left"]=o.tab),o.progress&&o.progresscolor){let e=function(){if(l.isAttached()){let e=Math.round(l.outerWidth()*parseInt(o.progress)/100);l.css("box-shadow","inset "+e.toString()+"px 0px 0 0 "+o.progresscolor)}else setTimeout(e,50)};e()}l.css(s);let d=t("<div>").append(l),c=this;if(i.title){let a=t("<th>").text(this.fields[i.field].title);r.help&&(r.helpFunc||(c.addThHelpCloser(),r.helpFunc=function(e){let a,n=t(this);return n.data("bs.popover")?"open"!==e.type&&(a&&clearTimeout(a),a=setTimeout(()=>{n.attr("aria-describedby")&&t("#"+n.attr("aria-describedby").length)&&n.popover("destroy")},120)):"close"!==e.type&&(c._container.trigger("click"),setTimeout(()=>{let e=t('<div class="i-inner-div">').html(r.help).width(230);n.popover({trigger:"manual",content:e,html:!0,placement:()=>{let t=c._container;n.offset().top,t.offset().top;return e.css("max-height",300),"bottom"},container:c.scrollWrapper}),n.popover("show")},150)),!1}),a.prepend(t('<button class="btn btn-default btn-xxs cell-help" id="field-help-'+r.name+"-"+e+'"><i class="fa fa-info"></i></button>').on("click open close",r.helpFunc))),d.prepend(a)}n.append(d)}),this.tableRow.panels_view.controls){if(!this.pcTableControllsEvents){this.pcTableControllsEvents=!0;let e=this;this._innerContainer.on("click",".panel-controls button",(function(){let a=t(this),n=a.closest(".panelsView-card").data("id");switch(a.data("action")){case"duplicate":e.row_duplicate(n);break;case"delete":e.rows_delete(n);break;case"recalculate":e.row_refresh(n);break;case"panel":e._row_edit([n])}return!1}))}let i=t('<div class="panel-controls">');i.append('<span class="panle-id">id '+e+"</span>"),this.tableRow.panel&&i.append('<button class="btn btn-default btn-xxs" data-action="panel"><i class="fa fa-th-large"></i></span>'),!this.control.duplicating||this.f.blockduplicate||a.f.blockduplicate||i.append('<button class="btn btn-default btn-xxs" data-action="duplicate"><i class="fa fa-clone"></i></span>'),!this.control.deleting||this.f.blockdelete||a.f.blockdelete||i.append('<button class="btn btn-default btn-xxs" data-action="delete"><i class="fa fa-times"></i></span>'),i.append('<button class="btn btn-default btn-xs" data-action="recalculate"><i class="fa fa-refresh"></i></span>'),n.append(i)}return n},a=function(e){if(this.kanban){const a=e=>{let a=t.Deferred(),n=[];return e.parent().find(".panelsView-card").each((e,a)=>{n.push(t(a).data("id"))}),n.length>1?(n.forEach(e=>{this.dataSorted.splice(this.dataSorted.indexOf(e),1)}),this.dataSorted.push(...n),this.model.saveOrder(n).then(e=>{this.table_modify(e)})):(a.resolve(),a.promise())};t(e).find(".kanban").sortable({items:".panelsView-card",connectWith:this.fields[this.tableRow.panels_view.kanban].editable?".kanban":"",stop:(e,n)=>{let i=t(n.item),l=i.data("id");i.prev().data("id");App.fullScreenProcesses.show("sorting");let s=this.data[l][this.tableRow.panels_view.kanban];this.data[l][this.tableRow.panels_view.kanban]!=i.parent().data("value")?(s=i.closest(".kanban").data("value"),this.model.save({[l]:{[this.tableRow.panels_view.kanban]:s}}).then(e=>{this.tableRow.with_order_field?a(i).always(()=>{this._container.getNiceScroll().resize(),App.fullScreenProcesses.hide("sorting")}):(this.table_modify(e),this._container.getNiceScroll().resize(),App.fullScreenProcesses.hide("sorting"))})):this.tableRow.with_order_field&&a(i).always(()=>{App.fullScreenProcesses.hide("sorting")})}})}else t(e).data("sortableAdded")||(t(e).data("sortableAdded",1),t(e).sortable({stop:(e,a)=>{let n=t(a.item),i=n.data("id"),l=n.prev().data("id"),s=[...this.dataSorted];this.dataSorted.splice(this.dataSorted.indexOf(i),1),l?this.dataSorted.splice(this.dataSorted.indexOf(l)+1,0,i):this.dataSorted.splice(0,0,i),this.dataSortedVisible=[],this.dataSorted.forEach(e=>{this.data[e].$visible&&this.dataSortedVisible.push(e)}),Object.equals(s,this.dataSorted)||(App.fullScreenProcesses.show("sorting"),this.model.saveOrder(this.dataSorted).then(e=>{this.table_modify(e)}).always(()=>{App.fullScreenProcesses.hide("sorting")}))}}))},n=function(){let e=this._content||t('<div class="pcTable-floatBlock">');if(e.each((e,t)=>{!this.tableRow.with_order_field&&!this.kanban||!this.control.editing||this.f.blockorder||this.f.blockedit||setTimeout(()=>{a.call(this,t)},1)}),e.empty(),this.__applyFilters(),this.dataSortedVisible.length||this.kanban)if(this.kanban){this._innerContainer.addClass("kanbanInnerContainer"),e.addClass("kanbanWrapper").empty(),e.css("grid-template-columns","1fr ".repeat(this.kanban.length));let a=0;this.kanban.forEach(n=>{let i=(this.tableRow.panels_view.panels_in_kanban||1)*(parseInt(this.tableRow.panels_view.width)+10)-10;n.$div=t('<div class="kanban"></div>').data("value",n[0]).width(i),a&&(a+=20),a+=i,n.$div.append(t('<div class="kanban-title">').text(n[1]).attr("data-value",n[0]));let l=t('<div class="kanban-cards">');n.$div.append(l);let s=n[0];e.append(n.$div),this.dataSortedVisible.length?this.dataSortedVisible.forEach(e=>{(this.data[e][this.tableRow.panels_view.kanban].v||"")==s&&l.append(this._getRowCard(e))}):l.append('<div class="empty-kanban">'+App.translate("No data")+"</div>")}),e.width(a),this.tableWidth=a}else this.dataSortedVisible.forEach(t=>{let a=this._getRowCard(t);e.append(a)});else e.append('<div class="no-panels">'+App.translate("No data")+"</div>");return setTimeout(()=>{this._container.getNiceScroll().resize()}),e},i=function(){let e=this;this._sorting={},this._table=t("<table>").addClass(this.tableClass),this.notCorrectOrder&&this._table.addClass("no-correct-n-filtered"),this._popovers=t('<div class="popovers">'),1===this.fieldCategories.column.length&&e._container.addClass("no-fields");let a=this.scrollWrapper=this._container.append('<div class="pcTable-scrollwrapper">').find(".pcTable-scrollwrapper");a.append(this._createBeforeSpace()).append(this._createTableText()),this.isCreatorView&&a.append(this._refreshHiddenFieldsBlock()),this._paramsBlock=this._createParamsBlock(a);let n,i,l=t('<div class="pcTable-rowsWrapper">').appendTo(a);l.append(this._createRowsTitle(l)).append(this._createFiltersBlock()).append(this._rowsButtons()).append(this._innerContainer),this._footersBlock=t(),this._content=this._refreshContentTable().appendTo(this._innerContainer),this.tableRow.panels_view.css&&this._container.prepend(t("<style>").text(this.tableRow.panels_view.css)),this._innerContainer.addClass("panelsView"),this._footersSubTable=this._createFootersSubtable(a),a.append(this._footersSubTable).append(this._popovers),this._seeCalcucatedValData(),this._seeSelectPreview(),this._clickstoCopyMe(),"cycles"==e.tableRow.type&&this._content.on("dblclick",".panelsView-card",(function(){let a=t(this).data("id");e.model.dblClick(a)})),this._content.on("contextmenu",".panelsView-card td",(function(){n&&n.removeClass("selected");let a=t(this),i=e.data[a.closest(".panelsView-card").data("id")],l=a.data("name");a.data("panel")&&a.data("panel").isAttached()&&e.selectedCells.selectPanel===a.data("panel")?(e.selectedCells.selectPanelDestroy(),a.data("panel",null)):(a.data("panel",e.selectedCells.selectPanel=e.getSelectPanel.call(e,e.fields[l],i,a)),n=a.addClass("selected"))})),this._content.on("click",".panelsView-card",(function(e){if(e.originalEvent&&e.originalEvent.path&&!t(e.originalEvent.path[0]).is("button, .fa")){let e=t(this);i&&i.get(0)===e.get(0)?(e.removeClass("selected"),i=null):(i&&i.removeClass("selected"),i=e.addClass("selected"))}})),this.isCreatorView&&this._hideHell_storage.checkIssetFields.call(this)},l=function(e,a,n){e.is(".panelsView-card")&&(t.extend(a,n),this._getRowCard(a.id))};App.pcTableMain.prototype._renderTablePanelView=function(){if(this.loadFilters(),this.model.addExtraData({panelsView:!0}),this._renderTable=i.bind(this),this._getRowCard=e.bind(this),this._refreshHead=()=>{},this.Scroll=()=>({reloadScrollHead:()=>{},insertToDOM:()=>{this._refreshContentTable()}}),this.kanban){let e,a,n,i,l=this._container,s=!1;const o=()=>{a=a||this._container.find(".kanbanWrapper.pcTable-floatBlock");let e=a.offset();if(e.top<0){if(!n){let l={left:e.left+this._innerContainer.scrollLeft(),"grid-template-columns":a.css("grid-template-columns"),width:a.width()};n=t('<div class="kanbanWrapper pcTable-floatBlock cln">').css(l),n.width(this._innerContainer.width()),t(".kanban").each((function(){let e=t(this),a=t("<div class='kanban'>").width(e.width()).append(e.find(".kanban-title").clone());n.append(a)}));let s=this;i=t('<button class="scroll-top-button"><i class="fa fa-arrow-up"></i></button>').on("click",(function(){s._container.scrollTop(s._container.find(".pcTable-rowsWrapper").offset().top-s.scrollWrapper.offset().top)}))}s||(s=!0,this._innerContainer.append(n),this._innerContainer.append(i),n.scrollLeft(this._innerContainer.scrollLeft()))}else s&&(s=!1,n.detach(),i.detach())};let r;l.on("scroll",()=>{clearTimeout(e),e=setTimeout(()=>{o()},50)}),this._innerContainer.on("scroll",()=>{clearTimeout(r),r=setTimeout(()=>{n&&n.scrollLeft(this._innerContainer.scrollLeft())},50)}),this.rowButtonsCalcWidth=function(){this.tableWidth<this.tableRow.panels_view.width?this.__$rowsButtons.width(this.tableRow.panels_view.width):this.tableWidth<this._innerContainer.width()?this.__$rowsButtons.width(this.tableWidth):this.isMobile||this.__$rowsButtons.width(this._innerContainer.width())}}else this.rowButtonsCalcWidth=function(){this.__$rowsButtons.css("minWidth",this.tableRow.panels_view.width),this.tableWidth=0,this._innerContainer.find(".panelsView-card").toArray().some(e=>{let a=t(e),n=a.offset().left+a.width();if(!(n>this.tableWidth))return!0;this.tableWidth=n}),this.tableWidth-=this._innerContainer.offset().left+50,this.isMobile||(this.tableWidth<this.tableRow.panels_view.width?this.__$rowsButtons.width(this.tableRow.panels_view.width):this.__$rowsButtons.width(this.tableWidth))};this.refreshRow=l.bind(this),this._refreshContentTable=n.bind(this),this._getItemBytd=function(e){return this.data[e.closest(".panelsView-card").data("id")]||this.data_params},this._getFieldBytd=function(e){return 0===e.closest(".panelsView-card").length?this.fields[e.data("field")]:this.fields[e.data("name")]}}}(),t.extend(App.pcTableMain.prototype,{_renderRotatedView:function(){let e=this;t.extend(this,{isRotatedView:!0,rowButtonsCalcWidth:function(){if(!this.isMobile){let e=this._table.offset().left+this._table.width()-80;e<this._innerContainer.width()?this.__$rowsButtons.width(e):this._innerContainer.width()}},_addCellId:function(e,a){let n=t('<td class="id"></td>'),i=t('<span class="rowName"></span>').appendTo(n);return this.mainFieldName&&"id"!==this.mainFieldName&&e[this.mainFieldName]&&e[this.mainFieldName].v?i.text(e[this.mainFieldName].v):(i.text(e.id),n.addClass("small-rotated-id")),n.appendTo(a),this.row_actions_icons_add(n),!0===e.$checked&&this.row_actions_check(e,!0),n},_createHeadCellId:function(){let e=this,a=t('<th class="id"></th>'),n=t('<div class="pcTable-filters"></div>'),i=t('<button class="btn btn-default btn-xxs" id="n-expander"><i class="fa fa-sort"></i></button>');if(i.prop("disabled",!0),!e.isMobile){let t=this._getIdFilterButton();n.append(i).append(" ").append(t).append(" ").append(e._idCheckButton)}return a.append(this._checkStatusBar),a.append(n),e._idCheckButton.off().on("click",(function(){if(e._idCheckButton.find("span").is(".fa-check"))e.row_actions_uncheck_all.call(e),e.__checkedRows=[];else for(let t=0;t<e.dataSortedVisible.length;t++){let a=e.dataSortedVisible[t],n="object"!=typeof a?e._getItemById(a):a.row;n&&!n.$checked&&(e.row_actions_check.call(e,n,!0),e.__checkedRows.push(n.id))}e._headCellIdButtonsState()})),n=t('<div class="pcTable-filters for-selected"><button class="btn btn-default btn-xxs"><i class="fa fa-copy"></i></button> <button class="btn btn-default btn-xxs" data-names="true"><i class="fa fa-clone"></i></button></div>'),a.append(n),this._refreshCheckedStatus(),a},Scroll:()=>({reloadScrollHead:()=>{},insertToDOM:function(t,a,n){this.setHtml(e.dataSortedVisible,0,0,n)},emptyCache:()=>{},setHtml:function(t,a,n,i){e._content.find(".editing").each((function(t){e._removeEditing.call(e,t)}));let l=e._content.empty().get(0);if(0===e.dataSorted.length)l.appendChild(e._createNoDataRow().get(0));else if(0===e.dataSortedVisible.length)l.appendChild(e._createNoDataRow(App.translate("No rows are selected by the filtering conditions")).get(0));else for(let a in t){let n=t[a];if("object"!=typeof n){let t=e.data[n];t.$tr&&!i||e._createRow.call(e,t),t.$tr.data("item",t),l.appendChild(t.$tr.get(0))}else l.appendChild(e._createTreeFolderRow.call(e,n).get(0))}}})})}}),App.pcTableMain.prototype.switchRestoreView=function(){this.isRestoreView=!this.isRestoreView,this._rowsButtons(),this.model.refresh(void 0,void 0,!0)},t.extend(App.pcTableMain.prototype,{setWidthes:function(){"use strict";let a;this.isMobile?(a=5,this.switchContainerNideScroll(!1)):(a=t("body>.page_content:first").is(".tree-minifyed")?5:300,this.switchContainerNideScroll(!0)),this.width=t("body").width()-a,this._container.width(this.width),this.isMobile?this._innerContainer.width("auto"):(this._innerContainer.width(this.width-80),this.addInnerContainerScroll()),this._rerendParamsblock(),this.isCreatorView&&this._refreshHiddenFieldsBlock(),this._rerendFiltersBlock(),this._refreshHead(),this._rerendBottomFoolers(),this.rowButtonsCalcWidth(),this._container.width()<this._table.width()&&this._addHorizontalDraggable(),this._container.height(e.innerHeight-this._container.offset().top-10)},addInnerContainerScroll:function(){if(this._innerContainer.width()<this._innerContainer.find(">table:first, >div:first").width()){const e=()=>{let e=this._innerContainer.offset().top-this._container.offset().top-3,a=this._innerContainer.innerHeight()+parseInt(t("#table").data("pctable")._innerContainer.css("paddingBottom")),n=this._container.innerHeight();if(this._innerContainerPS){let t=this._innerContainerPS.scrollbarXBottom;if(this._innerContainerPS.scrollbarXBottom=0,e<n&&e+a>n){let t=e+this._innerContainer.innerHeight();t>n&&(this._innerContainerPS.scrollbarXBottom=t-n)}t!=this._innerContainerPS.scrollbarXBottom&&this._innerContainerPS.update()}};if(!this._innerContainerPS){let t;this._innerContainerPS=new PerfectScrollbar(this._innerContainer.get(0),{useBothWheelAxes:!1,scrollbarYActive:!1,scrollbarXActive:!0}),this._container.on("scroll.scroller",()=>{t&&clearTimeout(t),t=setTimeout(e,30)}),new ResizeObserver(e).observe(this.scrollWrapper.get(0))}setTimeout(e,500)}else this._innerContainerPS&&(this._container.off("scroll.scroller"),this._innerContainerPS.destroy(),this._innerContainerPS=null)},initForPanel:function(e){t.extend(!0,this,e),this.refreshArraysFieldCategories(!1);let a={};this.__checkedRows=[],this.rows.map((function(e){this.dataSorted.push(e.id),this.dataSortedVisible.push(e.id),a[e.id]=e,a[e.id].$checked=-1!==this.__checkedRows.indexOf(e.id)}),this),this.data=a,this.model.setLoadedTableData(this.data)},closeCallbacks:[],_init:function(){let a=this;t(document).on({dragover:function(){return!1},drop:function(){return!1}}),this._container.addClass(this.contanerClass).addClass("pcTable-type-"+this.tableRow.type),this.isCreatorView&&this._container.addClass("pcTable-creatorView");let n=t("#nav-top-line");"tmp"===this.tableRow.type&&this.isCreatorView&&(n.text(App.translate("Attention, please - this is a temporary table")),n.addClass("pcTable-type-"+this.tableRow.type)),this._innerContainer=t('<div class="innerContainer">');let i=!1;const l=function(){if(!i){i=!0;let e=a.closeCallbacks.length;a.closeCallbacks.forEach((function(e){e()})),a.closeCallbacks.splice(0,e),i=!1}};if(t("body").on("keyup",(function(e){27===e.which&&(a._container.trigger("escPressed"),l())})),t("body").on("click",l),a._container.on("scroll",l),a._innerContainer.on("scroll",l),"panels"!==this.viewType&&(this.isCreatorView?this._container.on("click contextmenu","th",(function(e){if(e.originalEvent&&"BUTTON"===e.originalEvent.target.nodeName||"BUTTON"===e.originalEvent.target.parentElement.nodeName);else{let e=t(this);a.creatorIconsPopover(e)}})):this._container.on("click contextmenu","th",(function(e){if(e.originalEvent&&"BUTTON"===e.originalEvent.target.nodeName||"BUTTON"===e.originalEvent.target.parentElement.nodeName);else{let e=t(this);a.workerIconsPopover(e)}}))),a._container.on("contextmenu",(function(e){let a=t(e.target);if(l(),!a.closest(".popover").length&&!a.closest(".edit-row-panel").length)return!1})),this._container.append(this._innerContainer),this.saveFilterAndPage(),this.initRowsData(),this.isMobile)t(e).resize((function(){e.location.reload()}));else{let n;t(e).resize((function(){n&&clearTimeout(n),n=setTimeout((function(){a.setWidthes()}),500)}))}},saveFilterAndPage:function(){"cycles"===this.tableRow.type&&(this.filtersString||this.PageData?sessionStorage.setItem("cycles_filter",JSON.stringify({id:this.tableRow.id,filter:this.filtersString,offset:this.PageData?this.PageData.offset:null,onPage:this.PageData?this.PageData.onPage:null})):sessionStorage.removeItem("cycles_filter"))},refreshArraysFieldCategories:function(){"use strict";let a=this;a.hidden_fields=a.hidden_fields||{},t.each(a.hidden_fields,(function(e,n){a.hidden_fields[e]=t.extend({},n,r[n.type],n),a.hidden_fields[e].isHiddenField=!0})),a.mainFieldName="id",a.fieldCategories={},["param","column","filter","footer","panel_fields"].forEach((function(e){a.fieldCategories[e]=[]}));let n=[];try{n=JSON.parse(decodeURIComponent(e.location.hash.substring(1))||"[]"),n=n&&n.wc?n.wc:[]}catch(e){}let i=!1;const l=function(e,l){l.pcTable=a,"button"==(l=r[l.type]?t.extend({},d,r[l.type],l):t.extend({},d,l)).type&&l.buttonActiveOnInsert&&(l.insertable=!0),l.showInWebOtherOrd&&(l._ord=l.ord,l.ord=l.showInWebOtherOrd,i=!0),l.showInWebOtherPlacement&&(l._category=l.category,l.category=l.showInWebOtherPlacement,i=!0),a.fields[e]=l,-1===n.indexOf(l.category)&&(l.showInWeb?"column"===l.category?("n"!==l.name&&a.fieldCategories.panel_fields.push(l),"tree"===l.name&&"column"===l.category&&l.treeViewType?(a.isTreeView=!0,a.fieldCategories[l.category].unshift(l)):a.fieldCategories[l.category].push(l)):a.fieldCategories[l.category].push(l):l.name&&(a.hidden_fields[l.name]=l))};l("n",{type:"n"});let s=t.extend({},this.fields);delete s.n,t.each(s,l),i&&["param","column","filter","footer"].forEach((function(e){a.fieldCategories[e].sort((function(e,t){return e.ord-t.ord}))})),a.notTableFooterFields=[],a.fieldCategories.footer.forEach((function(e){e.column||a.notTableFooterFields.push(e)})),this.tableRow.main_field&&this.fields[this.tableRow.main_field]&&(a.mainFieldName=this.tableRow.main_field)},workerIconsPopover:async function(e){if(0===e.closest(".popover").length){let a=t('<div style="width:200px" class="creator-icons">');a.append(t('<div class="full-title">').text(this.fields[e.data("field")].title));let n="top";e.get(0).getBoundingClientRect().top<100&&(n="bottom"),App.popNotify({isParams:!0,$text:a,element:e,trigger:"manual",placement:n,container:t("body")}),setTimeout(()=>{this.closeCallbacks.push((function(){e&&e.length&&e.popover("destroy")}))},200)}},creatorIconsPopover:async function(e){if(0===e.closest(".popover").length){let a=t('<div style="width:200px" class="creator-icons">');a.append(t('<div class="full-title">').text(this.fields[e.data("field")].title)),e.find("i:not(.fa-caret-down):not(.fa-info)").each((n,i)=>{if(["fa-star","fa-star-o","fa-cogs"].some(e=>t(i).hasClass(e)))return;let l=t("<div>").append(i.outerHTML);if(0===n){l.append(" "+e.data("field")),t('<button class="btn btn-sm btn-default copy-me" title="'+App.translate("Copy")+' "><i class="fa fa-copy"></i></button>').on("click",(function(){App.copyMe(e.data("field"));let a=t(this);return a.width(a.width()),a.html('<i class="fa fa-cog"></i>'),setTimeout((function(){a.html('<i class="fa fa-copy"></i>')}),1e3),!1})).appendTo(l)}i.title&&l.append(" "+i.title),a.append(l)});let n,i=[],l=this.fields[e.closest("th").data("field")];const s=async function(){return new Promise((e,t)=>{App.getPcTableById(2).then((function(t){e(t.fields.data_src.jsonFields)}))})};let o={code:App.translate("Code"),codeAction:App.translate("ActionShort"),codeSelect:App.translate("SelectShort"),format:App.translate("FormatShort")},r=Object.keys(o);for(let e=0;e<r.length;e++){let a=r[e],d="format"===a?"formatCode":"";(d?l[d]:l[a])?i.push(t('<button class="btn btn-default btn-xxs" data-action="'+a+'">'+o[a]+"</button>")):(n||(n=await s()),-1!==n.fieldListParams[l.type].indexOf(a)&&i.push(t('<button class="btn btn-default btn-xxs offed" data-action="'+a+'">'+o[a]+"</button>")))}if(i.length){let o=t('<div class="buttons">');i.forEach(e=>{o.append(e)}),o.appendTo(a);let r=this;o.on("click","button",(async function(){let a=t(this);n||(n=await s()),r.editFieldCode(l.name,a.data("action"),n).then(t=>{if(t){switch(l.category){case"param":r._rerendParamsblock();break;case"footer":l.column?r._rerenderColumnsFooter():r._rerendBottomFoolers();break;case"filter":r._rerendFiltersBlock();break;case"column":r._refreshHead()}setTimeout(()=>{App.blink(l.$th.find(".creator-icons i"),3,"green","color")},100)}else App.blink(e.find("i"),3,"green","color")},()=>{})}))}let d="top";e.get(0).getBoundingClientRect().top<100&&(d="bottom"),App.popNotify({isParams:!0,$text:a,element:e,trigger:"manual",placement:d,container:t("body")}),setTimeout(()=>{this.closeCallbacks.push((function(){e&&e.length&&e.popover("destroy")}))},200)}},editTableCode:function(e,t){return new Promise((a,n)=>{let i=this;App.getPcTableById(1).then((function(l){l.model.checkEditRow({id:i.tableRow.id}).then((function(s){let o='<span style="">'+l.fields[e].title+"</span>";App.totumCodeEdit(s.row[e].v,o,i.tableRow.name,[],!1).then(s=>{l.model.save({[i.tableRow.id]:{[e]:s.code}}).then(()=>{i.tableRow[e]=s.code,"format"===t&&i.model.refresh(),a()}).fail(n)},(function(e){n()}))}))}))})},editFieldCode:function(t,a,n){return new Promise((i,l)=>{let s=this.fields[t],o=n.fieldListParams[s.type],r=this;App.getPcTableById(2).then((function(t){t.model.checkEditRow({id:s.id}).then((function(d){let c=[],p=[];switch(a){case"code":p=["codeOnlyInAdd"];break;case"codeAction":p=["CodeActionOnAdd","CodeActionOnChange","CodeActionOnDelete","CodeActionOnClick"];break;case"codeSelect":p=["codeSelectIndividual","multiple"]}p&&p.forEach(e=>{if(-1!==o.indexOf(e)){let t=n.fieldSettings[e];if(t.categories&&-1===t.categories.indexOf(s.category))return!1;c.push([e,t.title,!!d.row.data_src.v[e]&&d.row.data_src.v[e].Val])}});let f='<span style="">'+n.fieldSettings[a].title+"</span> "+s.name;App.totumCodeEdit(d.row.data_src.v[a].Val,f,s.pcTable.tableRow.name,c,"codeSelect"!==a&&d.row.data_src.v[a]&&d.row.data_src.v[a].isOn).then(n=>{t.model.checkEditRow({id:s.id}).then((function(o){let d=o.row.data_src.v;d[a].Val=n.code;let c=!1;d[a].isOn?n.switchoff&&(d[a].isOn=!1,c=!0):(d[a].isOn=!0,c=!0),Object.keys(n.checkboxes).forEach(e=>{d[e]&&d[e].Val===n.checkboxes[e]||(d[e]=d[e]||{},d[e].Val=n.checkboxes[e],d[e].isOn=n.checkboxes[e],c=!0)}),t.model.save({[s.id]:{data_src:d}}).then(()=>{Object.keys(n.checkboxes).forEach(e=>{r.fields[s.name][e]=n.checkboxes[e]}),"format"===a?(n.switchoff?r.fields[s.name].formatCode=!1:r.fields[s.name].formatCode=!0,r.model.refresh()):"codeSelect"===a?e.location.reload():(n.switchoff?r.fields[s.name][a]=!1:r.fields[s.name][a]=!0,r.model.refresh(null,"recalculate")),i(c)}).fail(l)})).fail(l)},(function(e){l()}))}))}))})},render:function(e){let t=this;if(this.loadVisibleFields(this.f&&this.f.fieldhide?this.f.fieldhide:void 0),"panels"!==this.viewType||this.isMobile?!this.isTreeView&&this.tableRow.rotated_view&&this._renderRotatedView():this._renderTablePanelView(),this.ScrollClasterized=this.Scroll(),this._renderTable(),this._sorting.addSortable&&this._sorting.addSortable(this),this._addSelectable(),this._addEditable(),this.row_actions_add(),this.__addFilterable(),this._refreshHead(),t.checkIsUpdated>0){let e=2e3*parseInt(t.checkIsUpdated);setTimeout((function(){t.checkTableIsChanged.call(t,e)}),e)}this.refresh(),this.setWidthes(),this.__applyFilters(),e&&(this.isMobile?t._addInsertWithPanel(e):t._addInsert(e))},reloaded:function(){let e=t("#refresh-notify");e.length&&(e.closest(".alert").remove(),this.checkTableIsChanged(2e3*parseInt(this.checkIsUpdated)))},showRefreshButton(e){if(this.checkTableIsChangedObject.abort(),this.checkTableIsChangedObject.changed)return;this.checkTableIsChangedObject.changed=!0,t.notify({message:'<div id="refresh-notify"><span>'+App.translate("The table was changed by the user <b>%s</b> at <b>%s</b>",[e.username,App.dateFormats.covert(e.dt,"YY-MM-DD HH:mm",App.lang.timeDateFormatNoYear)])+'</span> <button class="btn btn-warning btn-sm" style="margin-right: 20px;">'+App.translate("Refresh")+"</button></div>"},{type:"warning",allow_dismiss:!1,delay:0}).$ele.find("#refresh-notify button").on("click",()=>{delete this.checkTableIsChangedObject.changed;let e,t=void 0;this.PageData&&(0===this.PageData.offset?t="page":this.PageData.offset>=Math.ceil(this.PageData.allCount/this.PageData.onPage)*this.PageData.onPage&&(t=Object.keys(this.data).length===this.PageData.onPage?-1:"page")),e=t?e=>{this.applyPage(e.chdata,e.allCount,-1===t?e.allCount-this.PageData.onPage:void 0),delete e.chdata.rows,this.table_modify(e),this.reloaded()}:e=>{this.PageData={...this.PageData,offset:e.chdata.offset,allCount:e.allCount,loading:!1},this.PageData.$block.empty().append(this._paginationCreateBlock()),this.table_modify(e),this.reloaded()},this.model.refresh(e,void 0,t,!!t)})},checkTableIsChanged:function(){this.checkTableIsChangedObject||(this.checkTableIsChangedObject={abort:()=>{this.checkTableIsChangedObject.jqXHR&&this.checkTableIsChangedObject.jqXHR.abort&&this.checkTableIsChangedObject.jqXHR.abort(),this.checkTableIsChangedObject.aborted=!0}},document.addEventListener("visibilitychange",()=>{if(!this.checkTableIsChangedObject.changed)switch(document.visibilityState){case"hidden":this.checkTableIsChangedObject.abort();break;case"visible":this.checkTableIsChanged()}})),this.checkTableIsChangedObject.abort(),delete this.checkTableIsChangedObject.aborted,this.model.checkTableIsChanged(this.checkTableIsChangedObject).then(e=>{if(e.no||this.model.tableData.updated.code===e.code)this.checkTableIsChanged();else{let t=()=>{this.model.tableData.updated.code===e.code?this.checkTableIsChanged():this.showRefreshButton(e)};this.model.doAfterProcesses((function(){setTimeout(t,200)}))}})},_getRowTitleByMainField:function(e,a){let n="";if(e.id){let a=this.mainFieldName;void 0!==e[a].v_?"array"==typeof e[a].v_?e[a].v_.forEach((function(i,l){let s=t("<span>").text(this.fields[a].getElementString(e[a].v?e[a].v[l]:null,i));i[1]&&s.addClass("deleted_value"),n=s.html()})):n=t("<div>").text(this.fields[a].getElementString(e[a].v,e[a].v_)).html():n=void 0!==e[a].v?t("<div>").text(e[a].v).html():"id: "+e.id}return a&&n&&(n=a.replace("%s",n)),n},_getFieldbyName:function(e){return this.fields[e]},_getColumnIndexByTd:function(e,t){return(t=t||e.closest("tr")).find("td").index(e)},_fieldByTd:function(e,t){let a=this._getColumnIndexByTd(e,t);return this.fieldCategories.visibleColumns[a-1]},_getRowIndexById:function(e){let t=this;for(let a in t.data)if(t.data[a].id==e)return a;return null},_getFieldBytd:function(e){return e.closest("tr").is(".DataRow")?this.fieldCategories.visibleColumns[e.closest("tr").find(e.prop("tagName")).index(e)-1]:this.fields[e.data("field")]},_isParamsArea:function(e){return e.closest("table").is(".pcTable-paramsTable")},_isFootersArea:function(e){return e.closest("tbody").is(".pcTable-footers")},_getItemBytd:function(e){let t=e.closest("tr");return this._getItemByTr(t)},_getItemByTr:function(e){return e.is(".DataRow")?this.data[e.data("pctableitemid")]:this.data_params},_getItemById:function(e){return this.data[e]},_deleteItemById:function(e){let t=this._getItemById(e);t&&t.$tr&&t.$tr.remove(),this.openedPanels[e]&&this.openedPanels[e].close(),["dataSorted","dataSortedVisible","__checkedRows"].forEach((function(t){let a;this[t].forEach((t,n)=>{(t.toString()===e.toString()||"object"==typeof t&&t.row&&t.row.id.toString()===e.toString())&&(a=n)}),void 0!==a&&this[t].splice(a,1)}),this),this.isTreeView&&this.treeDeletingRow(e),delete this.data[e]},_getTdByFieldName:function(e,t){let a=0;return this.fieldCategories.visibleColumns.every((function(t,n){return e!=t.name||(a=n,!1)})),this._getTdByColumnIndex(t,a+1)},_getTdByColumnIndex:function(e,t){return e.find("td:eq("+t+")")},refresh:function(){this._refreshTitle(),this._refreshParamsBlock(),this._refreshFiltersBlock(this.data_params),this._refreshFootersBlock(),this._refreshContentTable()},initRowsData:function(){if(this.__checkedRows=[],this.dataSorted=[],this.dataSortedVisible=[],this.ScrollClasterized&&this.ScrollClasterized.emptyCache(),this.isTreeView)this.tree.forEach((e,t)=>{this.getTreeBranch(e,t)}),this.rows&&this._treeApplyRows(this.rows),setTimeout(()=>{this.treeApply()}),this.model.setLoadedTableData(this.data);else{let e={};this.rows&&this.rows.map((function(t){this.dataSorted.push(t.id),this.dataSortedVisible.push(t.id),e[t.id]=t,e[t.id].$checked=-1!==this.__checkedRows.indexOf(t.id)}),this),this.data=e,this.model.setLoadedTableData(this.data,this.PageData?this.PageData.offset:void 0,this.PageData?this.PageData.onPage:void 0)}}})}(window,jQuery),App.models||(App.models={}),App.models.table=function(e,t,a){let n,i,l,s,o={},r=0,d=null;const c=function(e){let t={};return Object.keys(e).forEach((function(a){/^\$/.test(a)||("id"===a?t[a]=e[a]:null!==e[a]&&"object"==typeof e[a]&&-1!==Object.keys(e[a]).indexOf("v")?t[a]=e[a].v:t[a]=e[a])})),t};return a=a||{},{getUri:function(){return this.url},setLoadedTableData:function(e,t,a){n=e,i=t,l=a},addExtraData:function(e){"use strict";a=$.extend(!0,{},a,e)},tableData:t,url:e,doAfterProcesses:function(e){let t=this;setTimeout((function(){t.getDefferedProcess().then(e)}),170)},getDefferedProcess:function(){return new Promise((e,t)=>{Promise.all(Object.values(o)).then(()=>{e()})})},showLinks:function(e){App.showLInks(e.links,s.model),delete e.links},shoInterfaceDatas:function(e){App.showDatas.call(s.model,e.interfaceDatas,null,window),delete e.interfaceDatas},showPanels:function(e){App.showPanels(e.panels,s),delete e.panels},addPcTable:function(e){s=e},__ajax:function(e,c,p,f,h){"use strict";let u=this.url,m=!1,b=$.Deferred();h=h||{};let g=!1,w=!1,v=$.extend(!0,{},c,{tableData:t,ajax:!0},a,h);"checkTableIsChanged"===c.method||"checkForNotifications"===c.method?"checkForNotifications"!==c.method&&(v=$.extend({},c,{code:t.updated.code,ajax:!0},a),t.sess_hash&&(v.tableData={sess_hash:t.sess_hash})):(m=!0,f||setTimeout((function(){g||(App.fullScreenProcesses.showCog(),w=!0)}),1e3)),void 0!==v.data&&"object"==typeof v.data&&(v.data=JSON.stringify(v.data)),n&&(v.ids=JSON.stringify(Object.keys(n))),"offset"in c||void 0===i||(v.offset=i,v.onPage=l),s&&s.isRestoreView&&(v.restoreView=!0);let _=this,y=function(e){let t=App.lang.modelMethods,a=$("#table").data("pctable");if(a){if(e.LOGS&&(a.LOGS||(a.LOGS={}),a.LOGS=$.extend(a.LOGS,e.LOGS)),e.FullLOGS){a.FullLOGS||(a.FullLOGS=[]);let n={text:t[v.method]||v.method};n.children=e.FullLOGS,e.FullLOGS.length&&(a.FullLOGS.push(n),App.blink(a.LogButton,8,"#fff"))}if(e.FieldLOGS&&Object.keys(e.FieldLOGS).length&&(a.FieldLOGS=a.FieldLOGS||[],a.FieldLOGS.push({data:e.FieldLOGS,name:t[v.method]||v.method})),"loadPage"!==v.method&&a.PageData&&void 0!==e.allCount){let t=!1;"offset"in e&&null!==e.offset&&a.PageData.offset!==e.offset&&(t=!0,a.PageData.offset=e.offset),"allCount"in e&&null!==e.allCount&&a.PageData.allCount!==e.allCount&&(t=!0,a.tableRow.pagination.match(/desc\s*$/)&&(a.PageData.offset+=e.allCount-a.PageData.allCount),a.PageData.allCount=e.allCount),t&&a.PageData.$block.empty().append(a._paginationCreateBlock.call(a))}}if(e.tableChanged&&s.showRefreshButton(e.tableChanged),e.error){var n=$("<div>").html(e.error.replace(/\[\[(.*?)\]\]/g,"<b>$1</b>"));if(e.log){let t=$('<button class="btn btn-xxs btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> c</i></button>');t.on("click",(function(){BootstrapDialog.show({message:$('<pre style="max-height: '+($("body").height()-200)+'px; overflow: scroll">').css("font-size","11px").text(JSON.stringify(e.log,null,1)),type:BootstrapDialog.TYPE_DANGER,title:App.translate("Calculate log"),buttons:[{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],draggable:!0,onshown:function(e){e.$modalContent.position({of:window})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:1200})}})})),n.append(" "),n.append(t)}App.notify(n),b.reject(e)}else e.reload?window.location.href=window.location.href:(e.links&&e.links.length>0&&_.showLinks(e),e.interfaceDatas&&e.interfaceDatas.length>0&&_.shoInterfaceDatas(e),e.panels&&e.panels.length>0&&_.showPanels(e)),b.resolve(e),setTimeout(()=>{e.chdata&&e.updated&&s.editPanels&&s.editPanels.forEach(e=>{e.refresh()})},10)},x=function(e){let t,a;e&&200===e.status?e.responseJSON&&e.responseJSON.error?t=e.responseJSON.error:(t=$("<div>"+App.translate("Operation execution error")+"  </div>"),s&&s.isCreatorView&&(t.append('<button class="btn danger-backg btn-xs" data-toggle="collapse" data-target="#notify-texh"><i class="fa fa-angle-down"></i><i class="fa fa-angle-up"></i></button>'),t.append($('<div id="notify-texh" class="collapse">').append($("<code>").text(e.responseText))))):!p&&e&&"abort"!=e.statusText&&"error"!=e.statusText?(t=e.statusText,a=200):p&&p.jqXHR&&"abort"!==p.jqXHR.statusText&&(t=App.translate("No server connection"),a=200),t&&-1===["checkTableIsChanged","checkForNotifications"].indexOf(c.method)&&(a?setTimeout((function(){App.notify(t)}),a):App.notify(t),e.responseText),b.reject(e)},C=function(){(new Date).getTime()-d<150?setTimeout(C,50):(d=(new Date).getTime(),/\?/.test(u)?u+="&":u+="?",u+="rn="+Math.round(1e5*Math.random())+(v.method||""),p&&!0===p.aborted?x({statusText:"abort"}):$.ajax({url:u,method:e,data:v,dataType:"json",beforeSend:function(e,t){p&&(p.jqXHR=e)}}).then(y).fail(x))};C();let k,T=++r;o[T]=new Promise(e=>{k=e});let A=function(){setTimeout(()=>{delete o[T]},1e3),g=!0,w&&App.fullScreenProcesses.hideCog()};return m||(k(),k=()=>{}),b.always((function(){setTimeout(A,100),setTimeout(k,50)})),b.promise()},delete:function(e){return 0!==e.length&&this.__ajax("post",{delete_ids:JSON.stringify(e),method:"delete"})},restore:function(e){return 0!==e.length&&this.__ajax("post",{restore_ids:JSON.stringify(e),method:"restore"})},duplicate:function(e,t,a){return 0!==e.length&&this.__ajax("post",{duplicate_ids:JSON.stringify(e),data:t,insertAfter:a,method:"duplicate"})},dblClick:function(e,t){return this.__ajax("post",{field:t,id:e,method:"dblClick"})},getFieldLog:function(e,t,a){return this.__ajax("post",{field:e,id:t,method:"getFieldLog",rowName:a})},refresh_rows:function(e){return 0!==e.length&&this.__ajax("post",{refreash_ids:JSON.stringify(e),method:"refresh_rows"})},refresh_cycles:function(e){return 0!==e.length&&this.__ajax("post",{refreash_ids:JSON.stringify(e),method:"refresh_cycles"})},checkUnic:function(e,t){"use strict";return this.__ajax("post",{fieldName:e,fieldVal:t,method:"checkUnic"})},add:function(e,t){return this.__ajax("post",{hash:e,method:"add",data:t})},getValue:function(e,t){return this.__ajax("post",{data:e,method:"getValue",table_id:t})},getNotificationsTable:function(){return this.__ajax("post",{method:"getNotificationsTable"})},get:function(e){return this.__ajax("get",{id:e})},setTableFavorite:function(e){return this.__ajax("post",{status:e,method:"setTableFavorite"})},checkInsertRow:function(e,t,a){var n={};return $.each(e,(function(e,t){null!=t&&(n[e]=t)})),this.__ajax("post",{data:n,hash:t,clearField:a,method:"checkInsertRow"})},checkEditRow:function(e){var t={};return $.each(e,(function(e,a){null!=a&&(t[e]=a)})),this.__ajax("post",{data:t,method:"checkEditRow"})},viewRow:function(e){return this.__ajax("post",{id:e,method:"viewRow"})},checkTableIsChanged:function(e){return this.__ajax("post",{method:"checkTableIsChanged",table_id:s.tableRow.id,cycle_id:s.tableRow.cycle_id},e)},checkForNotifications:function(e,t,a){return this.__ajax("post",{method:"checkForNotifications",periodicity:e,activeIds:t},a)},notificationUpdate:function(e,t,a,n){return this.__ajax("post",{method:"notificationUpdate",id:e,num:a,item:n,type:t})},seachUserTables:function(e,t){return this.__ajax("post",{method:"seachUserTables",q:e,et:t})},selectSourceTableAction:function(e,t){return this.__ajax("post",{field_name:e,data:t,method:"selectSourceTableAction"})},saveEditRow:function(e){var t={};return $.each(e,(function(e,a){void 0!==a&&(t[e]=a)})),this.__ajax("post",{data:t,method:"saveEditRow"})},getEditSelect:function(e,t,a,n,i,l){return this.__ajax("post",{data:{item:e,field:t},q:a,parentId:n,method:"getEditSelect"},l,!i)},loadPreviewHtml:function(e,t,a){return this.__ajax("post",{data:{item:c(t),field:e,val:a},method:"loadPreviewHtml"},null,!0)},save:function(e){let t={};return e.params&&Object.keys(e.params).some((function(e){if("filter"===s.fields[e].category)return s._filtersBlock.data("cryptoFilters")&&(t.filters=s._filtersBlock.data("cryptoFilters")),!0})),this.__ajax("post",{data:e,method:"edit"},null,null,t)},click:function(e){return this.__ajax("post",{data:e,method:"click"})},csvExport:function(e,t,a){return this.__ajax("post",{method:"csvExport",type:t,sorted_ids:JSON.stringify(e),visibleFields:JSON.stringify(a)})},csvImport:function(e,t,a,n){return this.__ajax("post",{csv:e,type:t,answers:a,method:"csvImport",visibleFields:JSON.stringify(n)})},getTableData:function(e){return this.__ajax("post",{method:"getTableData",tableData:{sess_hash:e}})},panelsView:function(e){return this.__ajax("post",{method:"panelsViewCookie",switcher:e?1:0})},refresh:function(e,t,a,n){let i;e=e||function(e){s.table_modify.call(s,e),s.reloaded.call(s)},s.treeIndex&&(i={},Object.keys(s.treeIndex).forEach(e=>{i[e]=s.treeIndex[e].l?1:0}),i=JSON.stringify(i)),this.__ajax("post",{method:"refresh",tree:i,recalculate:"recalculate"===t||null,withoutIds:a,getList:n}).then((function(t){try{e(t)}catch(e){window.location.reload()}}))},saveOrder:function(e){return this.__ajax("post",{method:"saveOrder",orderedIds:JSON.stringify(e)})},setCommentsViewed:function(e,t,a){return this.__ajax("post",{method:"setCommentsViewed",nums:e,field_name:t,id:a})},AddEyeGroupSet:function(e,t){return this.__ajax("post",{method:"addEyeGroupSet",name:e,fields:t})},removeEyeGroupSet:function(e){return this.__ajax("post",{method:"removeEyeGroupSet",index:e})},leftEyeGroupSet:function(e){return this.__ajax("post",{method:"leftEyeGroupSet",index:e})},reUser:function(e){return this.__ajax("post",{method:"reuser",userId:e,location:window.location.pathname})},printTable:function(e){return this.__ajax("post",{method:"printTable",settings:JSON.stringify(e)})},getAllTables:function(){return this.__ajax("post",{method:"getAllTables"})},calcFieldsLog:function(e,t){return this.__ajax("post",{method:"calcFieldsLog",calc_fields_data:e,name:t})},renameField:function(e){return this.__ajax("post",{method:"renameField",name:e})},panelButtonsClick:function(e,t){return this.__ajax("post",{method:"panelButtonsClick",hash:e,index:t})},panelButtonsClear:function(e){return this.__ajax("post",{method:"panelButtonsClear",hash:e})},linkJsonClick:function(e,t){return this.__ajax("post",{method:"linkJsonClick",hash:e,json:t})},buttonsClick:function(e,t){return this.__ajax("post",{method:"linkButtonsClick",hash:e,index:t})},inputClick:function(e,t){return this.__ajax("post",{method:"linkInputClick",hash:e,val:t})},getChartTypes:function(){return this.__ajax("post",{method:"getChartTypes"})},getPanelFormats:function(e,t){return this.__ajax("post",{method:"getPanelFormats",field:e,id:t})},loadUserButtons:function(){return this.__ajax("post",{method:"loadUserButtons"})},userButtonsClick:function(e,t){return this.__ajax("post",{method:"userButtonsClick",hash:e,index:t})},filesUpload:function(e,t){return this.__ajax("post",{method:"filesUpload",files:JSON.stringify(e),hash:t})},loadPage:function(e,t,a,n,i){let l={};return e&&e.filtersString&&(l.filters=e.filtersString),e.PageData.loading=!0,this.__ajax("post",{method:"loadPage",lastId:t,offset:i,pageCount:a,prevLastId:n},null,null,l).then((function(t){e.applyPage(t)}))}}};