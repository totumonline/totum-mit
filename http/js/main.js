App.blink=function(e,t,a,i){let n=t||8;i=i||"background-color",a=App.theme.getColor(a,"color"===i),n%2&&n++;let l=!0,s=function(){e&&(l?e.css(i,a):a&&e.css(i,""),l=!l,n--,n>0&&setTimeout(s,300))};setTimeout(s,300)},App.clickToCyclesTabButton=function(e){let[t,a,i,n]=/^(\d+)\/(\d+)\/(.+)$/.exec(e),l=App.models.table("/Table/0/"+a,{},{});l.addPcTable({model:l}),l.click({item:i,fieldName:n})},App.CodemirrorFocusBlur=function(e){let t=$(e.display.lineDiv).closest(".modal-content").find(".modal-footer .fa-times").closest("button");e.on("focus",e=>{if(!t.is(":disabled")){t.width(t.width()),t.addClass("with-lock"),t.prop("disabled",!0);let e=t.find(".fa-times").hide(),a=$('<span class="fa fa-lock"/>');e.after(a)}}),e.on("blur",(e,a)=>{if(t.is(":disabled")){let e=t.find(".fa-times");e.next().remove(),e.show(),t.prop("disabled",null)}})},App.commonFiltersExtenders=function(e){let t=()=>!0;if(e&&""!==e){let[a]=App.lang.search_prepare_function(e),i=a.match(/^([!\^~= ]+):\s*/),n=a.split(" ");const l=e=>{let t;return null===e?t="":(t=e.toString(),[t]=App.lang.search_prepare_function(t)),t};if(t=function(e){let t=l(e);return n.every((function(e){return-1!==t.indexOf(e)}))},i)if(a=a.substring(i[0].length).trim(),[a]=App.lang.search_prepare_function(a),n=a.split(" "),""===a)t=()=>!0;else switch(i[1]){case"!=":t=e=>{let t=l(e);return a!==t};break;case"=":t=e=>{let t=l(e);return a===t};break;case"~":t=e=>-1!==l(e).indexOf(a);break;case"!~":t=e=>-1===l(e).indexOf(a);break;case"!~~":case"!":t=e=>{let t=l(e);return n.every((function(e){return-1===t.indexOf(e)}))};break;case"^":t=e=>{let t=l(e);return t=t.split(" "),n.every((function(e){return t.some((function(t){return 0===t.indexOf(e)}))}))};break;case"!^":t=e=>{let t=l(e);return t=t.split(" "),n.every((function(e){return!t.some((function(t){return 0===t.indexOf(e)}))}))};break;case"^~":t=e=>0===l(e).indexOf(a);break;case"!^~":t=e=>0!==l(e).indexOf(a)}}return t},function(){let e=!1;App.isMobile=function(t){let a=screen.width<800||!(window.matchMedia("(any-pointer: fine)").matches&&window.matchMedia("(hover: hover)").matches);if(e||(e=!0,App.isMobile()?$("body").addClass("ttm-body-mobile"):$("body").addClass("ttm-body-desktop")),"isButton"===t)return screen.width>=800;if(t)return a;if(screen.width<800)return!0;if(a){if("true"===localStorage.getItem("notMobileView"))return!1}else if("false"===localStorage.getItem("notMobileView"))return!0;return a}}(),App.ManuallyJsonChanging=function(e,t,a){let i=$("<div>"),n=$('<textarea class="form-control">').val(JSON.stringify(t,null,2)).appendTo(i);window.top.innerHeight>460&&n.height(350);const l=function(e){a(n.val())&&e.close()};let s=[{label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:l},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];if(App.isMobile())App.mobilePanel(e,i,{buttons:s});else{let t="ctrlS.Manually";window.top.BootstrapDialog.show({message:i,type:null,title:e,draggable:!0,cssClass:"fieldparams-edit-panel",buttons:s,onhide:function(e){$("body").off(t)},onshown:function(e){e.$modalContent.position({of:window.top}),$("body").on(t,()=>{l(e)})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}})}},App.mobilePanel=function(e,t,a){return a=a||{},window.top.BootstrapDialog.show($.extend({type:"edit",message:t,draggable:!0,title:e,cssClass:"mobile-panel "+(a.buttons?" with-buttons":"")},a))},App.numberFormat=function(e,t,a,i,n,l){e=e.toString();let s=".",o="",r="",d="";return"string"==typeof a&&(s=a,s.match(/\*\*/)&&(s=s.split("**")[e>=0?0:1])),"string"==typeof i&&(o=i,o.match(/\*\*/)&&(o=o.split("**")[e>=0?0:1])),"string"==typeof l&&(r=l,r=r.match(/\*\*/)?r.split("**")[e>=0?0:1]:r),"string"==typeof n&&(d=n,d.match(/\*\*/)&&(d=d.split("**")[e>=0?0:1],"-"===e[0]&&(e=e.substring(1)))),d+function(t,a,i){var n=e.split(".");if(n[0]=n[0].replace(/\B(?=(\d{3})+(?!\d))/g,i),(n[1]||t)&&(n[1]=void 0===n[1]?n[1]="":n[1],t)){n[1]=n[1].substring(0,t);for(let e=n[1].length;e<t;e++)n[1]+="0"}return n.join(a)}(parseInt(t),s,o)+r},App.panelTimer=function(e,t,a){let i,n=t,l=$("<div>");l.html(n);let s=BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:e,message:l,onhide:function(){i&&clearTimeout(i)},buttons:[{action:function(e){i&&clearTimeout(i),e.close()},label:App.translate("Cancel")}]}),o=function(){--n<=0?(s.close(),a()):(l.html(n),i=setTimeout(o,1e3))};o()},App.panel=function(e,t,a){return a=a||{},window.top.BootstrapDialog.show($.extend({type:"edit",message:t,draggable:!0,title:e,cssClass:"web-panel "+(a.buttons?" with-buttons ":"")+(a.class||"")},a))},function(){let e={};App.randomIds={get:function(){let t;do{t=Math.round(1e6*Math.random())}while(t in e);return e[t]=!0,this.current=t,t},delete:function(t){delete e[t]},current:0}}(),App.setSessionStorage=function(e,t){sessionStorage.setItem(e,JSON.stringify(t))},App.theme={getColor:function(e,t){return e}},App.totumCodeEdit=function(e,t,a,i,n,l){return new Promise((s,o)=>{let r,d=$('<div class="HTMLEditor" id="bigOneCodemirror" style="height: 100%;"></div>'),c=$('<div class="totum-edit-codes"></div>').append(d),p=()=>{};i&&i.length&&a&&"codeAction"===a.codeType&&i&&(c.append('<div class="code-checkboxes-warning-panel">'+App.translate("There is no any active trigger.")+"</div>"),p=()=>{0===r.find(":checked").length?c.addClass("code-checkboxes-active-warning"):c.removeClass("code-checkboxes-active-warning")});let h,f,u=e,m=!1;i&&i.length&&(r=$('<div class="flex">').appendTo(c),i.forEach(([e,t,a])=>{let i=$('<input type="checkbox">').attr("name",e),n=$('<div class="">').append(i).append($("<label>").text(t).on("click",()=>{i.trigger("click")}));a&&i.prop("checked",!0),r.append(n)}),r.on("change","input",p),p());const b=()=>{let e=[];return i&&c.find("input").each((function(){e[this.name]=this.checked})),e},g=()=>{m=!0,s({code:h.getValue(),checkboxes:b()}),f.close()};$("body").on("ctrlS.CodeEdit",()=>{g()});let w=[{action:g,cssClass:"btn-warning btn-save",label:App.translate("Save")+" Alt+S"},{action:()=>{f.close()},cssClass:"btn-default btn-save",label:'<i class="fa fa-times"></i>'}];n&&w.unshift({action:()=>{App.confirmation(App.translate("Disable code")+" "+t,{[App.translate("Cancel")]:e=>{e.close()},[App.translate("Disable")]:e=>{m=!0,s({code:h.getValue(),checkboxes:b(),switchoff:!0}),e.close(),f.close()}},App.translate("Code disabling"))},cssClass:"btn-default btn-save",label:App.translate("Disable")}),l&&(t=$(t).append('<span class="switched-off-code"><i class="fa fa-chain-broken"></i></span>')),window.top.BootstrapDialog.show({message:c,type:null,title:t,buttons:w,cssClass:"fieldparams-edit-panel",draggable:!0,onhidden:()=>{$("body").off("ctrlS.CodeEdit"),m||o()},onshow:function(e){f=e,e.$modalHeader.css("cursor","pointer");let t=100;r&&(t+=r.height()),e.$modalContent.css({width:"90vw",minHeight:"calc(90vh - "+t+"px)"})},onshown:function(e){h=window.top.CodeMirror(d.get(0),{mode:"totum",value:u,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:g}),a&&Object.keys(a).forEach(e=>{h[e]=a[e]});let t=Math.round(e.$modalContent.height()-e.$modalHeader.outerHeight()-40);h.getScrollerElement().style.minHeight=t+"px",d.find(".CodeMirror").css("min-heught",t),App.CodemirrorFocusBlur(h),h.focus(),e.$modalContent.position({my:"center top",at:"center top+30px",of:window.top})}})})},App.translate=function(e,t){return App.lang&&App.lang.translates[e]&&(e=App.lang.translates[e]),t&&("object"!=typeof t&&(t=[t]),t.forEach(t=>{e=e.replace(/%s/,t)})),e},App.windowReloadWithHash=function(e){if(e.getSessHash()&&!new URLSearchParams(window.location.search).has("sess_hash")){let t=new URLSearchParams(window.location.search);t.append("sess_hash",e.getSessHash()),window.location.href=window.location.pathname+"?"+t.toString()}else window.location.reload()},function(){BootstrapDialog.BUTTON_SIZES[BootstrapDialog.SIZE_NORMAL]="btn-m",BootstrapDialog.defaultOptions.animate=!1,BootstrapDialog.defaultOptions.closeByBackdrop=!1,BootstrapDialog.defaultOptions.nl2br=!1,BootstrapDialog.defaultOptions.type=null,BootstrapDialog.TYPE_DANGER=null;let e=[];BootstrapDialog.getTopDialog=()=>e[0],BootstrapDialog.BootstrapDialogModal.prototype.resetScrollbar=function(){0===this.getGlobalOpenedDialogs().length&&this.$body.css("padding-right",5)},BootstrapDialog.prototype.initOptions=function(t){this.options=$.extend(!0,this.defaultOptions,t);let a=this.options.onshown,i=this.options.onhidden;return this.options.onhidden=t=>{i&&"function"==typeof i&&i.call(this,t),e.shift()},this.options.onshown=t=>{let i;e.unshift(t),a&&"function"==typeof a&&a.call(this,t);let n=t.$modalFooter.find("button");const l=()=>{i=$('<div class="float-footer-buttons" style="right: '+(t.$modal.width()-t.$modalBody.width()-t.$modalBody.offset().left-10)+'px; ">').appendTo(t.$modal).append(n)};setTimeout(()=>{t.$modalFooter.get(0).getBoundingClientRect().top>window.innerHeight-20&&l()},200),t.$modal.on("scroll",()=>{t.$modalFooter.get(0).getBoundingClientRect().top>window.innerHeight-20?i||l():i&&(t.$modalFooter.append(n),i.remove(),i=null)})},this}}(),$((function(){window.top.lastCtrl=window.top.lastCtrl||0,$("body").on("keydown",e=>{if((e.ctrlKey||e.altKey)&&(window.top.lastCtrl=Date.now()),(window.top.wasCtrl(e)||e.metaKey||e.altKey)&&!e.shiftKey&&"s"===String.fromCharCode(e.which).toLowerCase()){let e=$._data(document.body,"events").ctrlS;if(e&&e.length){return e[e.length-1].handler.bind(document.body)(),!1}}}),window.top.wasCtrl=e=>e.ctrlKey||e.altKey||window.top&&window.top.lastCtrl>0&&Date.now()-window.top.lastCtrl<500})),App.confirmation=function(e,t,a){let i=[];return Object.keys(t).forEach((function(e){i.push({label:e,action:t[e]})})),BootstrapDialog.show({type:"edit",title:a,message:e,buttons:i,draggable:!0,onshow:function(e){e.$modalContent.css({width:"70vw",maxWidth:"800px"})},onshown:function(e){e.$modalContent.position({of:window})}})},App.copyMe=function(e){let t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)},$((function(){App.dateFormats={base:App.lang?App.lang.dateFormat:"d.m.Y",db:"YYYY-MM-DD",covert:function(e,t,a){return moment(e,t).format(a)},covertToDb:function(e,t){t=t||this.base;return moment(e,t).format(this.db)},covertFromDb:function(e,t){t=t||this.base;return moment(e,this.db).format(t)},isValid:function(e,t){t=t||this.base;return moment(e,t).isValid()}},App.dateTimeFormats={base:App.lang?App.lang.dateTimeFormat:"d.m.Y H:i",db:"YYYY-MM-DD HH:mm",covert:function(e,t,a){return moment(e,t).format(a)},covertToDb:function(e,t){t=t||this.base;return moment(e,t).format(this.db)},covertFromDb:function(e,t){t=t||this.base;return moment(e,this.db).format(t)},isValid:function(e,t){t=t||this.base;return moment(e,t).isValid()}}})),function(){let e,t="fa-cog",a=$("#big_loading i"),i=0;App.fullScreenProcesses={showCog:function(){i++,1===i&&App.fullScreenProcesses.show("fa-cog",!0)},hideCog:function(){i--,i<1&&(i=0,App.fullScreenProcesses.hide())}},App.fullScreenProcesses.show=function(i,n){n=n||!1,$("body").addClass("lock"),n&&!a.is(".fa-spin")?a.addClass("fa-spin"):!n&&a.is(".fa-spin")&&a.removeClass("fa-spin"),t!=i&&(a.removeClass(t).addClass(i),t=i);let l=$("#big_loading").show();e&&clearTimeout(e),e=setTimeout(()=>{l.animate({opacity:1},250)},1e3)},App.fullScreenProcesses.hide=function(t){$("body").removeClass("lock"),e&&clearTimeout(e);$("#big_loading").stop().animate({opacity:0},250,(function(){$("#big_loading").hide()}))}}(),App.hexToRGB=function(e,t){var a=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),n=parseInt(e.slice(5,7),16);return t?"rgba("+a+", "+i+", "+n+", "+t+")":"rgb("+a+", "+i+", "+n+")"},$.fn.extend({isAttached:function(){return 1===$(this).closest("html").length}}),App.isTopWindow=function(){let e=!1;try{e=window!=window.top||document!=top.document||self.location!=top.location}catch(t){e=!0}return!e},function(){let e=0,t=-1;const a=(e,t)=>'<div id="'+e+'">'+App.translate("__clock_shelve_panel")+" <button>"+t+"</button></button></div>";let i,n;setTimeout(()=>{n=App.models.table("/Table/"),n.addPcTable({model:n})},10),App.checkNotificationManager=function(e){if(e=e||void 0,Object.keys(e).length>1){if(!i||!i.closest("body").length){let t;i=$('<div data-notify="container" class="col-xs-11 col-sm-4 alert alert-warning" role="alert" id="notifies_manager" ><button type="button" aria-hidden="true" class="close" data-notify="dismiss">&times;</button><button class="timer" id="notification_clock_panel_all_timer"><i class="fa fa-clock-o"></i></button></div>'),i.appendTo("body"),i.find("button.close").on("click",(function(){l(),i.remove(),i=null,n.notificationUpdate("ALL_ACTIVE","deactivate").then((function(){})),Object.values(e).forEach(e=>{e.forEach(e=>{e.$modal.remove()})}),Object.keys(e).forEach(t=>{delete e[t]})})).on("remove",()=>{t&&t.popover("destroy")}),i.find("button.timer").on("click",(function(){if($(this).is(".active"))return!1;$(this).addClass("active"),t=$(this),$div=$("<div>").append(a("notification_clock_panel_all",App.translate("Shelve all"))),$div.on("click","button",(function(){let t=$div.find("input").val(),a=$div.find("select").val();l(),n.notificationUpdate("ALL_ACTIVE","later",t,a).then((function(){})),i.remove(),i=null,Object.values(e).forEach(e=>{e.forEach(e=>{e.$modal.remove()})}),Object.keys(e).forEach(t=>{delete e[t]})})),t.popover({placement:"bottom",content:$div,html:!0,animation:!1,container:$("body")}).popover("show"),t.on("remove",l),setTimeout(()=>{$("body").on("click.notes",e=>{$(e.originalEvent.path[0]).closest("#notification_clock_panel_all").length||(t.popover("destroy"),l())})},20)}));const l=function(){$("body").off("click.notes"),$("#notification_clock_panel_all_timer").removeClass("active")}}}else i&&(i.remove(),i=null)};const l=function(e){if(e){if(e.hash)try{let t=JSON.parse(decodeURIComponent(e.hash.substring(1)));t&&t.wc&&-1!==t.wc.indexOf("tb")&&(t.wc.splice(t.wc.indexOf("tb"),1),t.wc.length||(delete t.wc,0===Object.keys(t).length?e.hash="":e.hash="#"+encodeURIComponent(JSON.stringify(t))))}catch(e){}return e=(e=e.toString()).replace(/iframe\=1\&?/,"")}};App.showLInks=function(a,i){a.forEach((function(a){if(-1!==["top-iframe","iframe"].indexOf(a.target)&&window.top!=window)return void window.top.App.showLInks([a],i);let n=function(s){"use strict";if(a.postData){let t,o="_self";if("iframe"===s||"top-iframe"===s){let s="iframe"+ ++e;o=s;let r,d=BootstrapDialog.show({message:r=$('<iframe style="width: 100%; '+(a.width?"":"min-width: 500px;")+' height: 70vh; border: none" name = "'+s+'"></iframe>'),size:BootstrapDialog.SIZE_WIDE,title:a.title,draggable:!0,cssClass:"target-iframe",onhidden:function(){if(a.refresh)if(i.getPcTable().isObjectOpened())i.refresh(null,a.refresh);else try{$("#table").data("pctable").model.refresh()}catch(e){}},onshown:function(e){if(a.width){let t=500;a.width>t&&(t=a.width),e.$modalDialog.width(t)}let t=r.get(0).contentWindow,i=function(){try{t.App&&t.App.setSessionStorage?t.App.setSessionStorage.call(t,"linkObject",a):setTimeout(i,200)}catch(e){}};i()},buttons:[{label:App.translate("Refresh"),cssClass:"btn-m btn-default",action:function(){r.get(0).contentWindow.location.reload(),t.detach()}},{label:App.translate("Open"),cssClass:"btn-m btn-default",action:function(e){n("self")}},{label:App.translate("Tab"),cssClass:"btn-m btn-default",action:function(e){window.open(l(r.get(0).contentWindow.location),"_blank"),e.close()}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}]});r.on("load",(function(){let e=r.get(0).contentWindow;try{e.closeMe=function(){d.close()}}catch(e){}}))}else"blank"===s?o="_blank":"parent"===s?o="_parent":"top"===s?o="_top":window.parent!==window&&(sessionStorage.linkObject=JSON.stringify(a));t=$("<form>",{method:"post",action:a.uri,target:o});const r=function(e,a){"boolean"==typeof a&&(a=!0===a?"true":"false"),"string"==typeof a||"number"==typeof a||null===a?t.append($("<input>",{type:"hidden",name:e,value:a})):$.each(a,(function(t,a){r(e+"["+t+"]",a)}))};$.each(a.postData,(function(e,t){r(e,t)})),t.appendTo("body").submit(),t.detach()}else switch(s){case"top":window.top.location.href=a.uri;break;case"parent":window.parent.location.href=a.uri;break;case"blank":let e=$('<a href="'+a.uri+'" target="_blank">link</a>');e.appendTo("body"),e.get(0).click(),e.remove();break;case"iframe":case"top-iframe":let s=a.uri;if(a.elseData){let e=[];!1===a.elseData.header&&e.push("param"),!1===a.elseData.footer&&e.push("footer"),!1===a.elseData.topbuttons&&e.push("tb"),!1===a.elseData.hidedots?e.push("hdf"):!0===a.elseData.hidedots&&e.push("hdt");let t={wc:e};a.elseData.pointing&&(t.pointing=a.elseData.pointing),s+="#"+encodeURIComponent(JSON.stringify(t))}let o,r=$('<iframe src="'+s+'" style="width: 100%; height: 70vh; border: none"></iframe>');a.elseData&&("force"===a.elseData.bottombuttons||!1===a.elseData.bottombuttons&&!i.isCreatorView())?o=[]:(o=[{label:App.translate("Refresh"),cssClass:"btn-m btn-default",action:function(){r.get(0).contentWindow.location.reload()}},{label:App.translate("Open"),cssClass:"btn-m btn-default",action:function(e){try{r.get(0).contentWindow.sessionStorage.linkObject&&(a=JSON.parse(r.get(0).contentWindow.sessionStorage.linkObject))}catch(e){}n("self")}},{label:App.translate("Tab"),cssClass:"btn-m btn-default",action:function(e){window.open(l(r.get(0).contentWindow.location),"_blank"),e.close()}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],!1===a.elseData.bottombuttons&&o.forEach(e=>{e.cssClass+=" admin-hidden"}));let d=BootstrapDialog.show({message:r,draggable:!0,size:BootstrapDialog.SIZE_WIDE,title:a.title,cssClass:"target-iframe",onhidden:function(){if(a.refresh)if(i.getPcTable().isObjectOpened())i.refresh(null,a.refresh);else try{$("#table").data("pctable").model.refresh()}catch(e){}t--},onshown:function(e){a.width&&e.$modalDialog.width(a.width),++t&&e.$modalDialog.css("margin-top",30+20*t);let i=r.get(0).contentWindow,n=function(){try{i.App&&i.App.setSessionStorage?i.App.setSessionStorage.call(i,"linkObject",a):setTimeout(n,200)}catch(e){}};n()},buttons:o});r.on("load",(function(){let e=r.get(0).contentWindow;try{e.closeMe=function(){d.close()},r.focus(),e.focus()}catch(e){}}));break;default:window.parent!=window&&(sessionStorage.linkObject=JSON.stringify(a)),window.location.href=a.uri}};n(a.target)}))},App.editField=function(e,t){let a,i,n=new Promise((e,t)=>{a=e,i=2});t[1].refresh&&n.then(()=>{switch(t[1].refresh){case"reload":App.windowReloadWithHash(e);break;default:e.refresh()}});let l,s,o=$.extend({},App.FieldTypes[t[1].field.type],t[1].field);if(o.pcTable=e.getPcTable(),-1!==["fieldParams","button","link"].indexOf(o.type))return void App.notify(App.translate("You can't put the Settings field type in linkToEdit"),App.translate("Error"));"text"===o.type||"listRow"===o.type?o.getEditVal=e=>"listRow"===o.type||"json"===o.textType?JSON.stringify(e.data("editor").get()):e.data("editor").getValue():"select"===o.type?o.getEditSelect=(a,i,n,l,r,d)=>e.saveLinkToEdit(t[1].hash,null,null,{q:n||"",checkedVals:s?o.getEditVal(s):t[1].value.v},d):"tree"===o.type?(o.getEditVal=function(e){return this.getCheckedIds(e)},o.getEditSelect=(a,i,n)=>{let l=$.Deferred();return e.saveLinkToEdit(t[1].hash,null,null,{q:i||"",parentId:n,checkedVals:s?o.getEditVal(s):t[1].value.v}).then(e=>{l.resolve([e.list,e.indexed])}).fail(()=>{l.reject()}),l}):"comments"===o.type?(o.getValueFromServer=()=>e.saveLinkToEdit(t[1].hash,null,null,{comment:"getValues"}),o.getEditVal=e=>e.find("textarea").val().trim()):"file"===o.type&&(o.getEditVal=e=>{let t=[];return e.closest(".modal-content").find(".modal-body .filePart").each((function(){let e=$(this).data("file");e&&t.push(e)})),t});let r,d,c=t[1].value,p=t[1].title,h=$("<div>"),f=[{action:e=>{u()},cssClass:"btn-warning btn-save",label:App.translate("Save")}];o.code&&!o.codeOnlyInAdd&&(c.h?f.push({action:e=>{r="setValuesToDefaults",d=null,u()},cssClass:"btn-warning btn-save",label:'<i class="fa fa-eraser"></i>'}):f.push({action:e=>{d=c.v,r="setValuesToPinned",u()},cssClass:"btn-warning btn-save",label:'<i class="fa fa-hand-rock-o"></i>'})),f.push({action:e=>{e.close()},cssClass:"",label:'<i class="fa fa-times"></i>'});const u=i=>{if(void 0===d){try{d=o.getEditVal(s)}catch(e){return void $("#"+App.popNotify(e,h,"default")).css("z-index",1e3)}if(!r&&!o.isDataModified(d,c.v))return void l.close()}!i&&o.warningEditPanel&&o.checkEditRegExp.call(o,d)?App.confirmation(o.warningEditText||App.translate("Surely to change?"),{OK:function(e){u(!0),e.close()},[App.translate("Cancel")]:function(e){revert(),e.close()}},App.translate("Change warning")):(App.fullScreenProcesses.showCog(),e.saveLinkToEdit(t[1].hash,d,r).then(e=>{a(e),l.close()}).always(()=>{App.fullScreenProcesses.hideCog()}))};s=o.getEditElement(h,c,{},()=>{},()=>{},()=>{},1,"editField"),h.append(s),l=window.top.BootstrapDialog.show({message:h,type:null,title:p,cssClass:-1!==["text","listRow"].indexOf(o.type)?"fieldparams-edit-panel":"one-column-panel",draggable:!0,buttons:f,onhidden:()=>{a()}}),setTimeout(()=>{s.focus()},20)},App.showDatas=function(e,t,i){let n,l=[],o=this;return window.top!=window?window.top.App.showDatas.call(o,e,t,i):(e.forEach((function(e){switch(e[0]){case"fileUpload":$('<input type="file" '+(e[1].limit>1?"multiple":"")+' accept="'+e[1].type+'" style="display:none">').appendTo("body").click().on("change",(function(){let t=[];if(this.files.length>e[1].limit)App.notify(App.translate("Upload limit exceeded"));else{for(var a=0;a<this.files.length;a++){let e=this.files.item(a);t.push(new Promise((t,a)=>{var i=new FileReader;i.onloadend=function(){t({name:e.name,base64:btoa(i.result)})},i.readAsBinaryString(e)}))}Promise.all(t).then(t=>{o.filesUpload(t,e[1].hash).then(()=>{e[1].refresh&&o.refresh(null,e[1].refresh)})})}}));break;case"files":e[1].files.forEach(e=>{for(var t=atob(e.string),a=[],i=0;i<t.length;i+=512){for(var n=t.slice(i,i+512),l=new Array(n.length),s=0;s<n.length;s++)l[s]=n.charCodeAt(s);var o=new Uint8Array(l);a.push(o)}let r=new Blob(a,{type:e.type});saveAs(r,e.name)});break;case"editField":App.editField(o,e);break;case"input":let r,d,c,p,h=$("<div>").html(e[1].html);if(e[1].height&&h.height(e[1].height),"select"===e[1].type){o.pcTable;p=$.extend({},App.FieldTypes.select,{name:"inputSelect",multiple:e[1].multiple}),p.pcTable=o.getPcTable(),o.inputClick=function(e,t,a){return this.__ajax("post",{method:"linkInputClick",hash:e,val:t,search:a})},o.loadPreviewHtml=function(t,a,i){return this.__ajax("post",{method:"linkInputClick",hash:e[1].hash,val:i,preview:!0})},p.getEditSelect=(t,a,i,n,l,s)=>o.inputClick(e[1].hash,null,{q:i||"",checkedVals:r?p.getEditVal(r):e[1].value},s),c=()=>p.getEditVal(r),r=p.getEditElement(h,{v:e[1].value},[],()=>{},()=>{},()=>{},1,"editField"),h.html(r).addClass("input-select"),!e[1].multiple&&e[1].selectAndSave&&r.on("change","select",(function(){u()}))}else h.find("#ttmInput").length?r=h.find("#ttmInput"):(r=$('<input type="text" class="form-control" id="ttmInput">'),e[1].type&&(r.attr("type",e[1].type),"password"===e[1].type&&r.attr("autocomplete","off")),e[1].value&&r.val(e[1].value),h.append(r),r.wrap("<div>"),r.on("keydown",e=>{13===e.keyCode&&u()})),c=()=>r.val();let f=!1,u=function(){f||(f=!0,o.inputClick(e[1].hash,c()).then((function(){e[1].close&&i&&i.closeMe?window.closeMe():e[1].refresh&&o.refresh(null,e[1].refresh),d.close()})).fail(()=>{if(f=!1,"select"===e[1].type){r.replaceWith(r=p.getEditElement(h,{v:e[1].value},[],()=>{},()=>{},()=>{},1,"editField2"))}}))};setTimeout(()=>{r.focus()},10),n={buttons:[{label:e[1].button||App.translate("Save"),action:u},{label:App.translate("Cancel"),action:function(e){e.close()}}],class:"linkButtons"},App.isMobile()?d=App.mobilePanel(e[1].title,h,n):(!n.width&&n.html||(n.onshown=function(e){n.width&&e.$modalDialog.width(n.width)}),d=App.panel(e[1].title,h,n));break;case"buttons":n={...e[1],buttons:[],class:"linkButtons"},e[1].buttons.forEach((function(t,a){n.buttons.push({id:"link-btn"+a,label:t.text,action:function(t){o.buttonsClick(e[1].hash,a).then((function(){e[1].close&&i&&i.closeMe?window.closeMe():e[1].buttons[a].refresh&&o.refresh(null,e[1].buttons[a].refresh),t.close()}))},icon:t.icon?"fa fa-"+t.icon:null,background:t.background,color:t.color})})),App.isMobile()?App.mobilePanel(e[1].title,$("<div>").html(e[1].html),n):(!n.width&&n.html||(n.onshown=function(e){n.width&&e.$modalDialog.width(n.width),n.html||e.$modalBody.remove(),n.buttons.forEach(t=>{let a=e.getButton(t.id);t.background&&a.css("background-color",App.theme.getColor(t.background)),t.color&&a.css("color",App.theme.getColor(t.color,!0))})}),App.panel(e[1].title,$("<div>").html(e[1].html),n));break;case"table":if(window.top!=window)return window.top.App.showDatas.call(o,[e]);l.push(function(e,t){let a;e.height&&(a=e.height,/^\d+$/.test(e.height)&&(a+="px"));let i="/Table/0/"+e.table_id+"?sess_hash="+e.sess_hash+"&iframe=1";"/"===window.location.pathname||/^\/Table\//.test(window.location.pathname)||(i=e.table_id+"?sess_hash="+e.sess_hash+"&iframe=1");if(e.elseData){let t=[];!1===e.elseData.header&&t.push("param"),!1===e.elseData.footer&&t.push("footer"),!1===e.elseData.topbuttons&&t.push("tb");let a={wc:t};e.elseData.pointing&&(a.pointing=e.elseData.pointing),i+="#"+encodeURIComponent(JSON.stringify(a))}let n=$('<iframe style="width: 100%; height: '+(a||"80vh")+'; border: none;" src="'+i+'">');$("body").append(n);let l=[];$("#table").data("pctable")&&$("#table").data("pctable").isCreatorView&&l.push({label:App.translate("In a new tab"),cssClass:"btn-m btn-danger",action:function(e){window.open(n.get(0).contentWindow.location,"_blank");e.close()}});let o=!1;!e.elseData||!1!==e.elseData.bottombuttons&&"force"!==e.elseData.bottombuttons||(t.isCreatorView()&&"force"!==e.elseData.bottombuttons?o=!0:l=!1);let r=s(e.title,n,e.width,e.refresh,null,t,l,o);n.on("load",(function(){let e=n.get(0).contentWindow;n.focus(),e.focus(),e.closeMe=function(){r.close()}}))}(e[1],o));break;case"text":l.push(function(e,t){let a=$("<div>").css("white-space","pre-wrap").html(e.text);e.height&&(a=a.height(e.height));s(e.title,a,e.width,e.close?"close":e.refresh,null,t)}(e[1],o));break;case"json":l.push(function(e,t){let a=$("<div>"),i=e.hash?{}:{mode:"view"},n=new JSONEditor(a.get(0),i,"");setTimeout(()=>{n.setText(JSON.stringify(e.json))});let l=[];e.hash&&l.push({action:a=>{t.linkJsonClick(e.hash,JSON.stringify(n.get())),a.close()},label:e.buttontext,cssClass:"btn-warning btn-save"});let o=$('<a href="#" style="padding-top: 8px; display: inline-block; padding-left: 20px;">'+App.translate("Manually")+"</a>").on("click",(function(){return App.ManuallyJsonChanging(App.translate("Manually changing the json"),n.get(),(function(e){try{return n.setText(e),!0}catch(e){window.top.App.modal(App.translate("JSON format error"))}})),!1}));a.find(".jsoneditor-menu").append(o),s(e.title,a,e.width,e.close?"close":e.refresh,null,t,l)}(e[1],o));break;case"print":l.push(function(e,t,a){if(App.fullScreenProcesses.showCog(),a){var i=new Blob([atob(a)],{type:"application/pdf"}),n=URL.createObjectURL(i),l=document.createElement("a");l.href=n,l.target="_blank",document.body.appendChild(l),l.click()}else{let a=$('<iframe style="width: 500px; height: 200px; position: absolute; top: -1000px; background: #fff;">').appendTo(window.top.document.body)[0],i=a.contentWindow?a.contentWindow:a.contentDocument.defaultView;setTimeout(()=>{i.document.body.innerHTML="<style>"+t+"</style>"+e,$(i.document.body).find(".nicescroll-rails").remove()},50);let n=i.document.body,l=$.Deferred(),s=0;const o=function(){n.scrollTop=n.scrollHeight+100,++s<100&&n.scrollTop>=n.scrollHeight?setTimeout(o,50):setTimeout((function(){l.resolve()}),1e3)},r=function(){++s<100&&n.scrollHeight<200?setTimeout(r,50):(s=0,o())};r(),l.then((function(){App.fullScreenProcesses.hideCog(),setTimeout((function(){i.focus(),i.print()}),250)}))}}(e[1].body,e[1].styles));break;case"notification":let m,b,g=function(e){let t={x:20,y:70};return App.isMobile()&&(t.x=.09*window.innerWidth/2),e&&(t.y+=60),t}();e[1].text?b="<div>"+e[1].text+"</div>":(b=e[1].title+'<div class="body"></div>',setTimeout(()=>{m.$ele.find(".body").append(function(e,t){let a;e.height&&(a=e.height,/^\d+$/.test(e.height)&&(a+="px"));let i="/Table/0/"+e.table_id+"?sess_hash="+e.sess_hash;/^\/Table\//.test(window.location.pathname)||window.location.pathname.match(/^\/(\?.*)?$/)||(i=e.table_id+"?sess_hash="+e.sess_hash);let n=$('<iframe style="width: 100%; height: '+(a||"80vh")+'; border: none;" src="'+i+'">');return n.on("load",(function(){let e=n.get(0).contentWindow;e.closeMe=t,e.jQuery("body").css("background-color","transparent").addClass("table-in-notification"),e.jQuery("#table").data("pctable")._refreshHead(),e.jQuery("#table").data("pctable")._refreshContentTable(!0),e.jQuery("#table").data("pctable").rowButtonsCalcWidth()})),n}(e[1],()=>{m.$ele.remove()}))})),m=$.notify({message:b},{offset:g,type:"warning",allow_dismiss:!0,delay:0,onClose:function(){m.$ele.data("deactivated")||o.notificationUpdate(t,"deactivate").then((function(){m.$ele.trigger("hide.bs.modal")}))}}),m.$ele.find("button.close").after('<button class="timer"><i class="fa fa-clock-o"></i></button>'),m.$ele.css("transition","none"),m.$ele.on("click",".timer:not(.disabled)",(function(){let e=$(this);e.addClass("disabled");let i=$("<div>").append(a("notification_clock_panel",App.translate("Shelve")));i.on("click","button",(function(){let a=i.find("input").val(),l=i.find("select").val();n(),o.notificationUpdate(t,"later",a,l).then((function(){})),e.popover("destroy"),m.$ele.data("deactivated",!0),m.$ele.find('button[data-notify="dismiss"]').click()}));const n=function(){$("body").off("click.note"+t),e.removeClass("disabled")};e.popover({placement:"bottom",content:i,html:!0,animation:!1,container:$("body")}).popover("show"),e.on("remove",n),setTimeout(()=>{$("body").on("click.note"+t,t=>{$(t.originalEvent.path[0]).closest("#notification_clock_panel").length||(e.popover("destroy"),n())})},20)})),l.push({$modal:m.$ele,simpleClose:()=>{m.$ele.data("deactivated",!0),m.$ele.find('button[data-notify="dismiss"]').click()},notification:m})}})),l)},App.getPcTableById=function(e,t,a,i){let n=$.Deferred(),l="/Table/0/"+((t=t||{}).cycle_id?"0/"+t.cycle_id+"/":"")+e.toString();return new App.models.table(l,{},{}).getTableData(t.sess_hash).then((function(e){if(i&&(!1===i.withHeader||!1===i.withFooter)){Object.values(e.fields).forEach((function(t,a){("param"===t.category&&!1===i.withHeader||"footer"===t.category&&!1===i.withFooter)&&delete e.fields[t.name]})),delete i.withHeader,delete i.withFooter}e.model=new App.models.table(l,$.extend({updated:e.updated},t)),$.extend(!0,e,i);let s=new App.pcTableMain(a,e);n.resolve(s)})),n.promise()},App.showPanels=function(e,t){if(window.top!=window)return window.top.App.showPanels.call(window.top,e,t);let a={},i=$.Deferred();const n=function(){let l=e.shift(),s={},o={};l.id?s.id=l.id:l.field&&(s=l.field,o=s);const r=function(a){l.columns&&(s.__columns=l.columns),new EditPanel(a,null,s,e.length>0,o).then((function(a,s){(a||s)&&e.length?n():(l.refresh&&t.model.refresh(null,l.refresh),i.resolve())}))};if(l.uri!==window.location.pathname){let e=JSON.stringify(l.fields),t=l.uri+"|||"+e+"|||"+JSON.stringify(l.titles);if(a[t])r(a[l.uri]);else{let i=new App.models.table(l.uri,{},{});l.fields&&(l.fields.length&&l.fields[0]?i.onlyFields=JSON.stringify(l.fields):i.onlyFields=JSON.stringify(Object.keys(l.fields)));let n=null;(n=l.uri.match(/\?sess_hash=([^&]+)/))&&(n=n[1]),i.getTableData(n,e).then((function(e){e.model=new App.models.table(l.uri,{updated:e.updated}),s.id&&(e.rows=[{id:s.id}]),a[t]=new App.pcTableMain(null,e),l.titles&&Object.keys(l.titles).forEach(e=>{a[t].fields[e]&&(a[t].fields[e].title=l.titles[e])}),r(a[t])}))}}else r($("#table").data("pctable"))};return n(),i};let s=function(e,a,i,n,l,s,o,r){return!1===o?o=[]:(o=o||[]).push({label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}),r&&o.forEach(e=>{e.cssClass+=" admin-hidden"}),window.top.BootstrapDialog.show({message:a,title:e,type:l||null,draggable:!0,onhidden:function(){n&&("close"===n&&window.closeMe?window.closeMe():"strong"===n?App.windowReloadWithHash(s):s.refresh(null,n)),t--},onshown:function(e){i&&e.$modalDialog.width(i),++t&&e.$modalDialog.css("margin-top",30+20*t)},buttons:o})}}(),App.logOutput=function(e){let t=$('<div style="overflow-x: auto">'),a=[{label:App.translate("Expand All"),cssClass:"btn-m btn-default",action:function(e){t.jstree("open_all")}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];"string"==typeof e&&a.splice(0,1),window.top.BootstrapDialog.show({message:t,type:BootstrapDialog.TYPE_DANGER,title:App.translate("Scheme of calculation"),buttons:a,draggable:!0,cssClass:"log-output",onshown:function(a){a.$modalContent.position({of:window.top}),"string"==typeof e?t.html('<div style="color: white; ">'+e+"</div>"):t.jstree({state:{key:"leftTree"},core:{check_callback:!0,open_parents:!0,data:e,themes:{name:"default-dark"}},types:{folder:{},code:{icon:"fa fa-cog"},cogs:{icon:"fa fa-cogs"},error:{icon:"fa fa-exclamation-triangle"},list:{icon:"fa fa-code"},fixed:{icon:"fa fa-hand-rock-o"},param:{icon:"fa fa-hashtag"},execcode:{icon:"fa fa-magic"},recalcs:{icon:"fa fa-recycle"},clocks:{icon:"fa fa-clock-o"},mbs:{icon:"fa fa-database"},selects:{icon:"fa fa-navicon"},"!":{icon:"fa fa-exclamation"},table_simple:App.tableTypes.simple,table_version:App.tableTypes.version,table_calcs:App.tableTypes.calcs,table_tmp:App.tableTypes.tmp,table_globcalcs:App.tableTypes.globcalcs,table_cycles:App.tableTypes.cycles},plugins:["types","themes"]}).on("click","a.jstree-anchor",(function(){let e,a,i=t.jstree(!0).get_node(this.id);try{e=JSON.parse(i.text),a=""}catch(t){try{let t=i.text.match(/^([a-zA-Z_0-1]+)\s*:\s*(.*)$/);e=JSON.parse(t[2]),a=t[1]}catch(t){e=i.text}}if(e){if("string"==typeof e){element=$('<div class="HTMLEditor" id="bigOneCodemirror">').height(500);var n=new CodeMirror(element.get(0),{value:e,mode:"text/html",height:"500px",readOnly:!0,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0});let t=setInterval(()=>{element.isAttached()&&(n.refresh(),clearInterval(t))},50)}else element=$('<div class="JSONEditor">').height(500),n=new JSONEditor(element.get(0),{mode:"view"},e);window.top.BootstrapDialog.show({message:element,title:a,onshown:function(e){e.$modalContent.position({of:window.top})},onshow:function(e){let t=.8*window.top.innerWidth;e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:t})}})}}))},onshow:function(e){let t=.8*window.top.innerWidth;e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:t}),e.$modalContent.find(".modal-body").css("background-color","#333")}})},App.modal=function(e,t,a){var i=$('<div class="modal fade" id="appNotify" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title"></h4> </div> <div class="modal-body"> </div> <div class="modal-footer"> </div> </div> </div> </div>');if((l={body:i.find(".modal-body"),header:i.find(".modal-header"),title:i.find(".modal-title"),footer:i.find(".modal-footer"),block:i}).block.on("hidden.bs.modal",(function(){$(this).remove()})),"object"==typeof e&&e instanceof jQuery?l.body.empty().append(e):l.body.html(e),t?l.title.html(t):l.header.hide(),a)if("object"==typeof a){var n=$("<div>"),l=l;$.each(a,(function(e,t){if("close"!=t){var a="default";"object"==typeof t&&(t.class&&(a=t.class),t.func&&(t=t.func));var i=$('<button type="button" class="btn btn-'+a+'">'+e+"</button>");n.append(i),t&&"function"==typeof t&&i.on("click",(function(){t(l.block)}))}else n.append('<button type="button" class="btn btn-default" data-dismiss="modal">'+e+"</button>")})),l.footer.html(n.children())}else l.footer.html(a);else l.footer.hide();return l.block.modal("show").css("z-index","10000"),l.block},App.notify=function(e,t,a){let i=$.Deferred();return window.top.BootstrapDialog.show({message:e,type:BootstrapDialog.TYPE_DEFAULT,title:t,buttons:[{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],onshow:function(e){t||e.$modalHeader.remove(),e.$modal.css("z-index",2e3),i.resolve(e)}}),i},App.topNotify=function(e,t,a){t=t||"",$("#notifies").append('<div class="alert alert-success"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>'+t+"</strong>"+e+"</div>")},App.popNotify=function(e,t,a,i,n){let l,s="bottom",o={},r={};return e.isParams&&(o=e,e.element&&(t=e.element),e.timeout&&(a=e.timeout),void 0!==e.container&&(i=e.container),e.trigger&&(n=e.trigger),e.placement&&(s=e.placement),e.class&&(l=e.class),e=e.$text),a=a||void 0,i=void 0===i&&t.closest(".pcTable-scrollwrapper, .InsertPanel").length?t.closest(".pcTable-scrollwrapper, .InsertPanel"):i,n=n||"manual",r=$.extend(r,{html:!0,content:e,trigger:n,container:i,placement:s,width:"70vw",animation:!1}),"default"==a&&(a=2e3),t.on("shown.bs.popover",(function(){let e=t.data("bs.popover"),a=parseInt(e.$tip.css("left")),n=parseInt(e.$arrow.css("left"));if(a<0&&(e.$tip.css("left",0),e.$arrow.css("left",n+a+"px")),"bottom"===s){let a=t.offset().top+t.outerHeight(),n=e.$tip.offset().top,l=i?i.scrollTop()-i.offset().top:0;n-a>10&&e.$tip.css("top",a+2+l+(i.is(".InsertPanel")?20:0))}})),t.popover(r),"manual"==n&&(t.popover("show"),l&&$("#"+t.attr("aria-describedby")).addClass(l)),t.on("remove destroy",(function(){t&&t.attr("aria-describedby")&&t.popover("destroy")})),e.on&&e.on("remove destroy",(function(){t.length&&t.attr("aria-describedby")&&$("#"+t.attr("aria-describedby")).length&&t.popover("destroy")})),a&&setTimeout((function(){t&&t.attr("aria-describedby")&&t.popover("destroy")}),a),t.attr("aria-describedby")},App.ksort=function(e){var t=Object.keys(e).sort(),a={};for(var i in t)a[t[i]]=e[t[i]];return a},App.values=function(e){let t=[];for(let a in e)t.push(e[a]);return t},App.keys=function(e){let t=[];for(let a in e)t.push(a);return t},App.isEmpty=function(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;if("object"!=typeof e)return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0},App.filter=function(e,t){let a={};return Object.keys(e).forEach((function(i){t(i,e[i])&&(a[i]=e[i])})),a},Object.equals=function(e,t){let a=[];return function e(t,i){if(t===i)return!0;if(t instanceof Date&&i instanceof Date)return+t==+i;if("object"!=typeof t||"object"!=typeof i||null===i||null===t)return!1;if(function(e,t){for(var i=a.length;i--;)if(!(a[i][0]!==e&&a[i][0]!==t||a[i][1]!==t&&a[i][1]!==e))return!0;return!1}(t,i))return!0;if(a.push([t,i]),Array.isArray(t)!==Array.isArray(i))return!1;if(Array.isArray(t)){if(t.length!==i.length)return!1;let a=t.length;for(;a--;)if(!e(t[a],i[a]))return!1}else{let a=Object.keys(t),n=a.length;if(Object.keys(i).length!==n)return!1;for(;n--;)if(!e(t[a[n]],i[a[n]]))return!1}return!0}(e,t)},Object.getPath=function(e,t,a){let i=e;for(let e=0;e<t.length;e++){let n=t[e];if("object"!=typeof i||!(n in i))return a;i=i[n]}return i},App.openInIframe=function(e,t,a){a=a||"newIframe";let i=$('<iframe style="min-width: 500px; width: 100%; height: 70vh; border: none" name = "'+a+'"></iframe>');BootstrapDialog.show({message:i.attr("src",t),size:BootstrapDialog.SIZE_WIDE,title:e,buttons:[{label:App.translate("Refresh"),cssClass:"btn-m btn-default",action:function(e){let n;n=$('<iframe style="min-width: 500px; width: 100%; height: 70vh; border: none" name = "'+a+'"></iframe>').attr("src",t),i.replaceWith(n),i=n}},{label:App.translate("Open"),cssClass:"btn-m btn-default",action:function(e){$("<a>").attr("href",t).hide().appendTo("body").get(0).click(),e.close()}},{label:App.translate("Tab"),cssClass:"btn-m btn-default",action:function(e){let a=$("<a>").attr("href",t).attr("target","_blank").hide().appendTo("body");a.get(0).click(),a.remove(),e.close()}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}]})},App.aInIframe=function(e){return e=$(e),App.openInIframe(e.text(),e.attr("href")),!1},App.reUserInterface=function(e,t,a,i){let n=$("#UserFio");n.css("cursor","pointer");let l=App.models.table("/Table/",{},{isCreatorView:i}),s=$("#table").data("pctable")||{model:l};if(l.addPcTable(s),a)App.blink(n,10,"#ffe486");else if(App.isTopWindow()&&i&&0===$("#isCreator").length){let e=$('<span id="isCreator" class="btn btn-sm"><i class="fa-user-circle fa"></i></span>');if(App.isMobile())e.addClass("btn-warning"),e.popover({html:!1,content:App.translate("You are in mobile mode - switch to desktop mode to enable the admin layer."),trigger:"manual",container:"body",placement:"bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),e.on("click",()=>{e.attr("aria-describedby")||(e.popover("show"),setTimeout(()=>{$("body").one("click.creatorButton",(function(t){void 0!==t.altKey&&e.popover("hide")}))},100))});else{localStorage.getItem("notCreator")?(e.addClass("btn-warning"),$(".plus-top-branch").hide()):e.addClass("btn-danger");let t=!1;"true"===$.cookie("ttm__commonTableView")&&(e.addClass("commonView"),t=!0);const a=e=>{e?localStorage.removeItem("notCreator"):localStorage.setItem("notCreator",!0)};e.on("click",()=>{let i=$("#table").data("pctable"),n=i&&(t||i.isTreeView||i.viewType);if(n){let t;if(!e.data("bs.popover")){let t=$('<div id="isCreatorSelector"></div>');t.append('<div><input type="checkbox" data-type="NotCreatorView"> '+App.translate("isCreatorSelector-NotCreatorView")+"</div>"),n&&t.append('<div><input type="checkbox" data-type="CommonView"> '+App.translate("isCreatorSelector-CommonView")+"</div>"),t.append("<div><button>"+App.translate("Apply")+"</button></div>"),"true"===$.cookie("ttm__commonTableView")&&t.find('[data-type="CommonView"]').prop("checked",!0),localStorage.getItem("notCreator")&&t.find('[data-type="NotCreatorView"]').prop("checked",!0),App.isMobile()?(t.find('[data-type="NotCreatorView"]').parent().addClass("disabled"),t.find('[data-type="NotCreatorView"]').prop("disabled",!0)):(t.find('[data-type="NotCreatorView"]').parent().removeClass("disabled"),t.find('[data-type="NotCreatorView"]').prop("disabled",!1)),t.on("click","button",(function(){let e=t.find('[data-type="NotCreatorView"]').is(":checked"),i=t.find('[data-type="CommonView"]').is(":checked");t.find('[data-type="MobileView"]').is(":checked"),a(!e);let n=window.location.pathname;i?$.cookie("ttm__commonTableView","true",{path:n}):$.removeCookie("ttm__commonTableView",{path:n}),window.location.reload(!0)})),t.on("click",e=>{e.stopPropagation()}),e.popover({trigger:"manual",placement:"bottom",content:t,html:!0,animation:!1,container:"#pk nav.navbar-default"})}t||(e.popover("show"),setTimeout(()=>{i&&i.closeCallbacks.push(()=>{setTimeout(()=>{e.popover("hide"),t=!1},50)})},100))}else a(localStorage.getItem("notCreator")),window.location.reload(!0)})}$("#docs-link").before(e)}n.on("click",(function(a){if(n.attr("aria-describedby"))return!0;let s,o=$('<div class="tech-table" style="width: 200px;"></div>');if(t.length){o.height(125);let e=$('<div class="panel-buttons">');o.prepend(e),t.forEach(t=>{let a=$('<button class="btn btn-default btn-xxs"></button>').text(t.title).on("click",()=>{window.location.href="/Table/0/"+t.name});e.append(a)})}else if(!i){o.height(70);let e=$("<div>");o.prepend(e),l.loadUserButtons().then(t=>{t.panelFormats&&t.panelFormats.rows.forEach(a=>{switch(a.type){case"text":e.append($('<div class="panel-text">').text(a.value));break;case"html":e.append($('<div class="panel-html">').html(a.value));break;case"img":e.append($('<div class="panel-img">').append($("<img>").attr("src","/fls/"+a.value+"_thumb.jpg?rand="+Math.random())));break;case"buttons":if(a.value&&a.value.forEach){let i=[];a.value.forEach(e=>{let a=$('<button class="btn btn-default btn-xxs">').text(e.text);i.push(a),e.color&&a.css("color",e.color),e.background&&a.css("background-color",e.background),a.on("click",(function(){l.userButtonsClick(t.panelFormats.hash,e.ind).then((function(t){e.refresh&&l.refresh(null,e.refresh)}))}))}),e.append($('<div class="panel-buttons">').append(i))}}})})}if(Object.keys(e).length){let a=$('<div class="select-btn"></div>').appendTo(o);s=$('<select data-size="'+(t.length?13-t.length-1:i?13:11)+'" class="open" title="'+App.translate("Select user")+'" data-style="btn-sm btn-default" data-live-search="true" data-width="100%">'),Object.keys(e).forEach((function(t){s.append($("<option>").text(t).data("content",e[t]))})),a.append(s)}n.popover({html:!0,content:o,trigger:"manual",container:"body",placement:"bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),s&&(o.height(360),s.selectpicker("render").selectpicker("toggle"),s.data("container",o),s.on("hide.bs.select",(function(){return s.val()&&l.reUser(s.val()),!1})),setTimeout((function(){n.popover("show"),s.selectpicker("render"),$("#"+n.attr("aria-describedby")).css("top","45px"),s.data("selectpicker").$searchbox.focus()}),300)),setTimeout(()=>{n.popover("show");let e=$('<a href="/Auth/logout/" class="btn">'+App.translate("Logout")+"</a>"),t=$('<div class="bottomButtons">').append(e);if(App.isMobile("isButton")){let e=$('<span id="mobileSwitcher" class="btn"><i class="fa-desktop fa"></i></span>');App.isMobile()||(e=$('<span id="mobileSwitcher" class="btn"><i class="fa-mobile fa"></i></span>')),e.on("click",()=>{App.isMobile()?App.isMobile(!0)?App.confirmation('<div style="white-space: pre-wrap">'+App.translate("mobileToDesctopUserWarning")+"</div>",{[App.translate("Cancel")]:e=>{e.close()},[App.translate("OK")]:e=>{localStorage.setItem("notMobileView","true"),window.location.reload(!0)}},App.translate("Attention")):(localStorage.setItem("notMobileView","true"),window.location.reload(!0)):(localStorage.setItem("notMobileView","false"),window.location.reload(!0))}),t.prepend(e),t.css({"grid-template-columns":"45px 1fr"})}o.height(o.height()+35).append(t),$("body").one("click.FioPopover",(function(e){void 0!==e.altKey&&n.popover("destroy")}))},300)}))},App.rgb2hex=function(e){return(e=e.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i))&&4===e.length?"#"+("0"+parseInt(e[1],10).toString(16)).slice(-2)+("0"+parseInt(e[2],10).toString(16)).slice(-2)+("0"+parseInt(e[3],10).toString(16)).slice(-2):""},String.prototype.hashCode=function(){var e,t=0;if(0===this.length)return t;for(e=0;e<this.length;e++)t=(t<<5)-t+this.charCodeAt(e),t|=0;return t},App.tableTypes={simple:{icon:"fa fa-table",title:App.translate("Simple")},calcs:{icon:"fa fa-calculator",title:App.translate("Calculated in the cycle")},globcalcs:{icon:"fa fa-calculator",title:App.translate("Calculated")},tmp:{icon:"fa fa-clock-o",title:App.translate("Temporary")},cycles:{icon:"fa fa-circle-o",title:App.translate("Cycles")}},App.textWithLinks=function(e){return $("<div>").text(e).html().replace(/(https?:\/\/[^\s]+)/g,(function(e){return'<a href="'+e+'" target="_blank">'+e+"</a>"}))},function(){var e=0;App.getUn=function(){return e++}}(),LOGINJS=function(){let e=$('<div><div class="form-group"><label>Email:</label><input id="elseEmail"  type="text"\n                                                                      name="login"\n                                                                      value=""\n                                                                      class="form-control"\n                /></div></div>');if($("body").on("click","#recover",(function(){let t=[{action:function(e){if(""==$("#elseEmail").val().trim())return void $("#elseEmail").addClass("error");let t=$('<form method="post"><input type="hidden" name="login" value=""><input type="hidden" name="recover" value="true"></form>');t.find('[name="login"]').val($("#elseEmail").val()),t.appendTo("body"),t.submit(),e.close()},label:App.translate("Send password to email")},{action:function(e){e.close()},label:App.translate("Cancel")}];BootstrapDialog.show({message:e,title:App.translate("New password"),buttons:t,draggable:!0})})),$("body").on("click","#register",(function(){let t=[{action:function(e){if(""==$("#elseEmail").val().trim())return void $("#elseEmail").addClass("error");let t=$('<form method="post"><input type="hidden" name="login" value=""><input type="hidden" name="register" value="true"></form>');t.find('[name="login"]').val($("#elseEmail").val()),t.appendTo("body"),t.submit(),e.close()},label:App.translate("Register and send password to email")},{action:function(e){e.close()},label:App.translate("Cancel")}];BootstrapDialog.show({message:e,title:App.translate("Registration"),buttons:t,draggable:!0})})),sessionStorage.getItem("browserConfirm")||navigator.userAgent.match(/(chrome|safari|firefox|yandex(?=\/))\/?\s*(\d+)/i)&&!navigator.userAgent.match(/BlackBerry|iPod|Opera Mini|IEMobile/i))$("#auth_form").show();else{let e=$("#auth_form");$("body").html('<div style="width: 600px; margin: auto; padding-top: 50px; font-size: 16px; text-align: center;" id="comeinBlock"><img src="/imgs/start.png" alt=""><div style="padding-bottom: 10px;">'+App.translate("Service is optimized for browsers Chrome, Safari, Yandex, FireFox latest versions")+'.</div><div><a href="#" id="comein" class="btn-default btn">'+App.translate("I still want to see it")+"</a></div></div>"),$("#comein").on("click",(function(){sessionStorage.setItem("browserConfirm",!0),$("#comeinBlock").remove(),$("body").html(e),e.show()}))}},$.fn.datetimepicker.defaults.icons.close="glyphicon glyphicon-ok",setTimeout(()=>{$.fn.datetimepicker.defaults.tooltips.close=App.translate("Apply and close")}),$((function(){if(!App.isMobile()){let e=$("#main-page");if(e.length){let t,a=$(".page_content"),i=!1;const n=function(){t=window.innerHeight;let a=$("#tables_tabls").length?200:100;e.height(window.innerHeight-a).niceScroll({cursorwidth:7,mousescrollstep:190,mousescroll:190,autohidemode:!1,enablekeyboard:!0,cursoropacitymin:1,railoffset:{left:4},cursorcolor:"#e1e0df"}),i=!0,e.getNiceScroll().resize()},l=function(){e.height("").getNiceScroll().remove(),i=!1},s=function(){a.is(".tree-minifyed")&&i||!e.is(":visible")?l():a.is(".tree-minifyed")||i&&window.innerHeight==t||n()};$("#tables_tabls").on("hidden.bs.tab",e=>{s()});const o=document.getElementsByClassName("page_content")[0],r={attributes:!0,childList:!1,subtree:!1};new MutationObserver(s).observe(o,r),s()}}})),$((function(){if(App.notifications=function(e){let t=App.models.table("/Table/");t.addPcTable({model:t}),e.data("withClick")||(e.data("withClick",!0),e.on("click",(function(e){t.getNotificationsTable()})));let a={},i={},n=e.data("periodicity")||0;const l=function(){switch(document.visibilityState){case"hidden":a.jqXHR&&a.jqXHR.abort&&a.jqXHR.abort(),a.aborted=!0;break;case"visible":delete a.aborted,t.checkForNotifications(n,Object.keys(i),a).then((function(e){e.notifications&&e.notifications.length&&(i[e.notification_id]=App.showDatas.call(t,e.notifications,e.notification_id),i[e.notification_id].forEach((function(t){t&&t.$modal&&t.$modal.length&&t.$modal.on("hide.bs.modal",(function(){delete i[e.notification_id]}))}))),e.deactivated&&e.deactivated.forEach&&e.deactivated.forEach((function(e){i[e]&&(i[e].forEach((function(e){e.simpleClose()})),delete i[e])})),App.checkNotificationManager(i),n>0&&l()})).fail((function(e){e&&e.error&&document.removeEventListener("visibilitychange",l)}))}};return n>0&&(document.addEventListener("visibilitychange",l),l()),l},App.isTopWindow()){let e=$("#bell-notifications");e.length&&App.notifications(e)}})),$((function(){let e=$("#docs-link");const t=function(){let a=$(this).data("type"),i=$('<div class="tech-table" id="DocsPopover" data-type="'+a+'" style="min-height: 250px"></div>');const n=e=>{$.get(e+"index_"+a+".json",(function(t){t&&t.length&&t.forEach((function(t){i.append('<div style="'+(t[2]||"")+'"><i class="fa fa-external-link"></i> <a href="'+e.substr(0,e.length-1)+t[1]+'" target="totum-docs">'+t[0]+"</a></div>")}))})).fail(()=>{"https://docs.totum.online/"!==e&&n("https://docs.totum.online/")})};n(App.translate("PATH-TO-DOCUMENTATION")),e.popover({html:!0,content:i,trigger:"manual",container:"body",placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),setTimeout((function(){e.popover("show"),$("#"+e.attr("aria-describedby")).css("top","45px"),$("body").one("click.DocsPopover",(function(a){void 0!==a.altKey&&(e.popover("destroy"),e.one("click",t))}))}),50)};e.one("click",t)})),function(e,t){const a=()=>({type:{isOn:!0,Val:"string"},width:{isOn:!0,Val:100},default:{isOn:!1,Val:""},regexp:{isOn:!1,Val:""},regexpErrorText:{isOn:!1,Val:""},required:{isOn:!0,Val:!1},showInWeb:{isOn:!0,Val:!0},insertable:{isOn:!0,Val:!0},dropdownView:{isOn:!0,Val:!0},addRoles:{isOn:!1,Val:["1"]},editable:{isOn:!0,Val:!0},editRoles:{isOn:!1,Val:["1"]},removeVersionsRoles:{isOn:!1,Val:["1"]},hidden:{isOn:!0,Val:!1},warningEditPanel:{isOn:!0,Val:!1},warningEditText:{isOn:!1,Val:App.translate("Surely to change?")},warningEditRegExp:{isOn:!1,Val:"/^someValue$/"},url:{isOn:!0,Val:!1},openIn:{isOn:!1,Val:"iframe"},tableBreakBefore:{isOn:!0,Val:!1},sectionTitle:{isOn:!1,Val:""},panelColor:{isOn:!1,Val:""},webRoles:{isOn:!1,Val:["1"]},logRoles:{isOn:!1,Val:["1"]},showInWebOtherPlace:{isOn:!0,Val:!1},showInWebOtherPlacement:{isOn:!1,Val:"param"},showInWebOtherOrd:{isOn:!1,Val:null},showInXml:{isOn:!0,Val:!1},apiEditable:{isOn:!1,Val:!1},xmlEditRoles:{isOn:!1,Val:["1"]},xmlRoles:{isOn:!1,Val:["1"]},logging:{isOn:!0,Val:!0},code:{isOn:!1,Val:"= : "},codeOnlyInAdd:{isOn:!1,Val:!1},errorText:{isOn:!1,Val:""},codeAction:{isOn:!1,Val:"= :"},CodeActionOnAdd:{isOn:!1,Val:!1},CodeActionOnChange:{isOn:!1,Val:!1},format:{isOn:!1,Val:"f1=:"},help:{isOn:!1,Val:""}}),i="#ee0c1f",n="#3fbf46",l="pcTableInsertRowPanel";var s=0;CodeMirror.defineMode("sections",(function(){return{startState:function(){return{}},token:function(e,t){if(0===e.lineOracle.line)return e.skipToEnd(),t.isStart=!1,"sec-title";if("//"===e.lineOracle.doc.cm.lineInfo(e.lineOracle.line).text.trim().substring(0,2))return e.skipToEnd(),t.isStart=!1,"comment";if(0===e.pos)return e.skipTo(":"),e.next(),t.isParamsPart=!0,"sec-param";{let a=e.string.substring(e.pos);if(t.isParamsPart&&a.match(":")){let i="sec-parts",n=":";return-1!==a.indexOf(",")?n=",":t.isParamsPart=!1,/^\s*\d+\s*$/.test(a.substring(0,a.indexOf(n)))&&(i="sec-num-parts"),e.skipTo(n),e.next(),i}return/^\s*(true|false)\s*$/.test(a)?(e.skipToEnd(),"boolean"):(e.skipToEnd(),"sec-value")}}}})),CodeMirror.sectionsAutoCloses=function(t){t.on("keyup",(function(t,a){t.options.bigOneDialog&&e.top.wasCtrl(a)&&"83"===(a.keyCode||a.which).toString()?(a.stopPropagation(),"function"==typeof t.options.bigOneDialog?t.options.bigOneDialog():t.options.bigOneDialog.close()):e.top.wasCtrl(a)&&"191"===(a.keyCode||a.which).toString()&&CodeMirror.commentMe(t),"27"===(a.keyCode||a.which).toString()?(t.state.completionActive&&t.state.completionActive.close(),a.stopPropagation()):{9:"tab",13:"enter",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",38:"up",40:"down",57:"("}[(a.keyCode||a.which).toString()]||CodeMirror.showHint(t,CodeMirror.hint.totumVars,{})}))},function(){let a=App.functions||[],i=[];a.forEach((function(e){e.d||i.push(e.name)}));let n={};a.forEach((function(e){n[e.name.toLowerCase()]=[e.t,0,e.p,e.n,e.m,e.name]}));let l=["where","order","field","sfield","bfield","tfield","pointing","preview","parent","section","table","filter","fieldtitle","fieldhide"];CodeMirror.defaults.scrollbarStyle="overlay",CodeMirror.defineInitHook((function(a){try{if(!a.options.bigOneDialog&&!App.isMobile()){let i,n=t('<i class="fa fa-expand codemirror-expander" style="position: absolute;\n    right: 10px;\n    bottom: 10px;\n    z-index: 10000;\n    font-family: FontAwesome; cursor: pointer"></i>');t(a.display.wrapper).append(n),n.on("click",(function(){i=t('<div class="HTMLEditor" id="bigOneCodemirror" style="height: 100%;"></div>');let n,l=a.getValue();e.top.BootstrapDialog.show({message:i,type:null,title:App.translate("Text field editing"),cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){a.setValue(n.getValue()),t("body").off("ctrlS.CodemirrorMax")},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"}),e.$modalHeader.find("button.close").css("font-size","16px").html('<i class="fa fa-compress"></i>'),t("body").on("ctrlS.CodemirrorMax",()=>{e.close()})},onshown:function(t){n=CodeMirror(i.get(0),{mode:a.options.mode,value:l,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:t}),a.table&&(n.table=a.table);let s=Math.round(t.$modalContent.height()-t.$modalHeader.outerHeight()-40);n.getScrollerElement().style.minHeight=s+"px",i.find(".CodeMirror").css("min-heught",s),n.focus(),t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top})}})}))}}catch(e){a.setValue(e.message)}}));CodeMirror.defineInitHook((function(a){try{if("totum"===a.options.mode&&t("#table").data("pctable").isCreatorView){let i;a.on("blur",e=>{setTimeout(()=>{i&&i.remove()},300)}),a.on("cursorActivity",(function(a){i&&i.remove();let n=a.getCursor(),l=a.getTokenAt(n);if("code"===l.state.functionParam&&l.type){let n,d,c,p;if(l.type.match(/db_name/)&&"@"===l.string[0]){if([n,d,p]=l.string.split("."),n=n.substr(1),c="select",d&&d.match(/\[/))return;if(p&&p.match(/\[\[/))return}else{if(!a.table)return;if(n=a.table,!l.type.match(/string/))return;c="get-code",d=l.string.substr(1,l.string.length-2)}var s=a.cursorCoords(null),o=s.left,r=s.top-40;let h=e.top.document.createElement("ul");h.className="CodeMirror-hints";let f=t('<button class="btn btn-xs btn-default code-edit"><i class="fa fa-edit"></i> '+App.translate("Edit")+"</button>");t(h).append(f),h.style.left=o+"px",h.style.top=r+"px",e.top.document.body.appendChild(h),i=h;let u=a.codeType,m=a.cycle_id,b=l.state.func[5];f.on("click",()=>{if(App.fullScreenProcesses.showCog(),setTimeout(()=>{App.fullScreenProcesses.hideCog()},500),"select"===c)App.getPcTableById(n,{cycle_id:m}).then((function(e){new Promise((t,a)=>{if(p){let i=p.match(/([a-z_0-9]{2,})\[(?:(\d+)|"([^"]+)"|([a-z_0-9\-]+))\]/);if(i){if("id"===i[1])t(i[2]);else{let n=i[2]||i[3]||i[4];e.model.getIdByFieldValue({[i[1]]:n}).then(e=>{e.value?t(e.value):(App.notify(App.translate("The value is not found")),a())})}return}}t(null)}).then(a=>{e.model.getValue({fieldName:d,rowId:a}).then(i=>{let l=App.translate("Edit totumCode in value of %s",(a?a+"/":"")+n+"/"+d);App.totumCodeEdit(i.value,l,{table:n,cycle_id:m}).then(i=>{App.fullScreenProcesses.showCog(),e.model.save({[a||"params"]:{[d]:i.code}}).then(e=>{App.fullScreenProcesses.hideCog(),-1!==["format","code"].indexOf(u)&&t("#table").data("pctable").model.refresh()})},()=>{})})},()=>{App.notify(App.translate("Code is not found."))})}),()=>{App.notify("Error")});else{switch(b){case"panelButton":case"linkToInput":case"linkToDataJson":case"linkToFileUpload":u="codeAction"}if(!u)return void App.notify("codeType is not defined");App.getPcTableById(2).then((function(e){new Promise((t,a)=>{e.model.getIdByFieldValue({table_name:n,name:d,__cycle_id:m}).then(e=>{e.value?t(e.value):(App.notify(App.translate("The value is not found")),a())})}).then(a=>{e.model.getValue({fieldName:"data_src",rowId:a}).then(i=>{let l=App.translate("Edit totumCode in %s",u+"/"+(a?a+"/":"")+n+"/"+d);App.totumCodeEdit(i.value[u]?i.value[u].Val:"=: ",l,{cycle_id:m,table:n,codeType:u},void 0,!(i.value[u]&&i.value[u].isOn)).then(n=>{App.fullScreenProcesses.showCog();let l=i.value;l[u]=l[u]||{Val:"",isOn:!1},l[u].Val=n.code,e.model.save({[a]:{data_src:l}}).then(e=>{App.fullScreenProcesses.hideCog(),-1!==["format","code"].indexOf(u)&&t("#table").data("pctable").model.refresh()})},()=>{})})},()=>{App.notify("Id isn't received")})}),()=>{App.notify("Error")})}})}})),t(a.display.wrapper).on("dblclick contextmenu",".cm-function",(function(e){let a=t(this).text();return a=a.substring(0,a.length-1),async function(e,a){let i=e.toLowerCase(),s=t('<div style="width:200px" class="function-help">');t('<div class="func-template">').text(e+n[i][0]).appendTo(s).on("click",()=>!1);let o=t('<div class="func-params">').appendTo(s).on("click",()=>!1);n[i][2].forEach(e=>{let a=t("<span>").text(e);-1!==n[i][3].indexOf(e)&&a.addClass("req"),-1!==n[i][4].indexOf(e)&&a.addClass("multi"),-1!==l.indexOf(e)&&a.addClass("db"),o.append(a),o.append(" ")});let r=t("<a>").attr("href",App.translate("PATH-TO-DOCUMENTATION")+"functions#fn-"+n[i][5]).attr("target","_blank").html('<button class="btn btn-default btn-sm">'+App.translate("Documentaion")+"</button>").on("click",()=>(setTimeout(()=>{a.popover("destroy")},10),!0));s.append(r.wrap('<div class="button">').parent()),App.popNotify({isParams:!0,$text:s,element:a,trigger:"manual",container:t("body")}),setTimeout(()=>{t("#table").data("pctable").closeCallbacks.push((function(){a&&a.length?a.popover("destroy"):s&&s.length&&s.remove()}))},200),t("body").click()}(a,t(this)),!1}))}}catch(e){console.log(e.message)}}));function s(e){if(e.getOption("disableInput")||"totum"!==e.getOption("mode"))return CodeMirror.Pass;var t=e.listSelections(),a=[];let i=!1;for(let r=0;r<t.length;r++){if(!t[r].empty())return CodeMirror.Pass;var l=t[r].head,s=e.getTokenAt(l,!0);if(s.state&&s.state.inFuncName||"function"==s.type||"error"==s.type){let d,c,p=s.string.toLowerCase(),h="";if(-1!==p.indexOf("/")?(d=p.substring(0,p.indexOf("/")),h=p.substring(p.indexOf("/")),c="/"):-1!==p.indexOf(";")?(d=p.substring(0,p.indexOf(";")),h=p.substring(p.indexOf(";")),c=";"):d=p.trimRight(),d=n[d]){let e="",t=0;if(h.length){e="(";let a=1,n=!0;h.split(/[\/;]/).forEach((function(t){if(0===t.length);else{n||(e+="; "),n=!1;let i=-1!==t.indexOf(":")&&""!==t.slice(t.indexOf(":")+1).trim();e+=t+(-1===t.indexOf(":")?": ":""),1!==a||i||(a=e.length)}})),1===a?a=e.length:i=!0,t+=a,e+=")"}else if(e=d[0],/:/.test(e)){let a=e.indexOf(":"),n=e.substring(a),l=n.substring(0,n.indexOf(";")||n.indexOf(")"));t+=a,-1!==l.indexOf("'")?t+=l.indexOf("'")+1:t+=2,i=!0}else t+=e.length;a[r]={text:e,newPos:CodeMirror.Pos(l.line,l.ch-h.length+t),replace:CodeMirror.Pos(l.line,l.ch-h.length)}}else a[r]={text:"()",newPos:CodeMirror.Pos(l.line,l.ch+1),replace:CodeMirror.Pos(l.line,l.ch)};let f=a[r];if(f){e.replaceRange(f.text,f.replace,t[r].anchor,"+insert");var o=e.listSelections().slice(0);o[r]={head:f.newPos,anchor:f.newPos},e.setSelections(o),i&&CodeMirror.showHint(e,CodeMirror.hint.totumVars,{})}}else e.replaceRange("()",CodeMirror.Pos(l.line,l.ch),t[r].anchor),e.setSelections([{head:CodeMirror.Pos(l.line,l.ch+1),anchor:CodeMirror.Pos(l.line,l.ch+1)}])}}CodeMirror.defineMode("totum",(function(){return{startState:function(){return{inString:!1,isStart:!0,inFunction:!1,lineName:"",inTotumBlock:!1}},token:function(e,a){function i(){return e.string.substring(e.start,e.pos)}function s(){"use strict";return a.inFunction=!1,e.skipToEnd(),"error"}function o(){let t=e.pos,a=!0;for(;"["===e.peek()&&e.skipTo("]")&&e.next();)a=!1,"]"===e.peek()&&e.next();let i=e.string.substring(t,e.pos);if(a||i.match(/^(\[\[[^\[\]]+\]\]|\[[^\[\]]+\])+$/))return!0}a.lineNames=[],a.lineCodeNames=[];let r=[];if(0===e.lineStart&&0===e.start)try{e.lineOracle.doc.cm.lineNames=[],e.lineOracle.doc.cm.lineCodeNames=[];let t=null,a=null,i=null,n=[],l=[],s=[];e.lineOracle.doc.cm.codeBlocks=r,e.lineOracle.doc.cm.getValue().split("\n").forEach((function(o,d){let c;return t?("```"===o.trim()?(e.lineOracle.doc.cm.lineNames.push(t),r.push([i,d,a,t,n,l]),t=null,a=null,i=null,n=[]):(c=o.match(/^\s*~?\s*([a-zA-Z_0-9]+)\s*(=\s*[a-zA-Z0-9_]*)?:/))&&(n.push(c[1]),c[2]||l.push(c[1])),void s.push(d)):(c=o.match(/^\s*```~?([a-zA-Z_0-9]+):([a-z]+)/))?(t=c[1],a=c[2],i=d,void s.push(d)):0===o.trim().length||0===o.indexOf("//")?"":(c=o.match(/^\s*~?\s*([a-zA-Z_0-9]+)\s*(=\s*[a-zA-Z0-9_]*)?:/))?(e.lineOracle.doc.cm.lineNames.push(c[1]),void(c[2]||e.lineOracle.doc.cm.lineCodeNames.push(c[1]))):""})),r.length&&(e.lineOracle.doc.cm.lineColorizeTimer&&clearTimeout(e.lineOracle.doc.cm.lineColorizeTimer),e.lineOracle.doc.cm.lineColorizeTimer=setTimeout(()=>{e.lineOracle.doc.eachLine(t=>{let a=e.lineOracle.doc.getLineNumber(t);"code-block"!==t.bgClass?-1!==s.indexOf(a)&&(e.lineOracle.doc.cm.addLineClass(t,"background","code-block"),e.lineOracle.doc.cm.addLineClass(t,"text","code-block-text")):-1===s.indexOf(a)&&(e.lineOracle.doc.cm.removeLineClass(t,"background","code-block"),e.lineOracle.doc.cm.removeLineClass(t,"text","code-block-text"))})},10))}catch(e){console.log(e)}r=e.lineOracle.doc.cm.codeBlocks,a.lineNames=e.lineOracle.doc.cm.lineNames,a.lineCodeNames=e.lineOracle.doc.cm.lineCodeNames,a.inTotumBlock=!1;for(var d=0;d<r.length;d++){let t=r[d];if(t[0]===e.lineOracle.line&&0===e.start)return e.skipTo(":"),a.lineName=t[3],"start spec-code";if(t[0]<=e.lineOracle.line&&e.lineOracle.line<=t[1]){if(t[0]==e.lineOracle.line||e.lineOracle.line==t[1]||"totum"!==t[2])return e.skipToEnd(),"spec-code";a.inTotumBlock=!0,a.codeBlock=t,a.lineNames=t[4],a.lineCodeNames=t[5]||[]}}if(0===e.pos||!0===a.isStart){if(e.string.match("^[\ts]*//"))return e.skipToEnd(),a.isStart=!1,"comment";let n="start";if(a.isStart=!0,/[\t\n]/.test(e.peek())&&e.next()){for(;/[\t\n]/.test(e.peek())&&e.next(););return"start-tabs"}if(!e.skipTo(":"))return s();if(a.lineName=i().trim(),"~"===a.lineName.substring(0,1)&&(n+=" fixed",a.lineName=a.lineName.substring(1)),a.lineName=a.lineName.replace(/=\s*[a-zA-Z0-9_]*\s*$/,"="),/^\s*=\s*$|^\s*dn=\s*$|^\s*[a-z]{1,2}\d+=$/i.test(a.lineName))n+=" exec";else if(!/^[a-z0-9_]+$/i.test(a.lineName))return s();return e.next(),t(e.lineOracle.doc.cm.getWrapperElement()).find(".cm-var-not-in").each((function(){let e=t(this).text();e=e.replace(/\[.*/,""),e!=="$"+a.lineName&&e!=="#$"+a.lineName&&e!=="$$"+a.lineName||t(this).removeClass("cm-var-not-in")})),a.lineNames.filter((function(e){return e===a.lineName})).length>1&&(n+=" dubbled"),a.inTotumBlock&&(n+=" totum-block"),a.isStart=!1,n}if(a.isStart=!1,e.match(/(math|json|str|cond|qrow)`[^`]*`/))return"spec";switch(e.peek()){case" ":return e.next(),null;case"{":return e.next(),e.skipTo("}")?(e.next(),"inVars"):s();case'"':let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string"):s();case"#":e.next();let i,n="db_name";if("$"===e.peek())return n;for(e.next();(i=e.string.substring(e.start+1,e.pos+1))&&/^[a-z0.-9_--]*$/.test(i)&&e.next(););if(!o())return s();let l=e.string.substring(e.start+1,e.pos).replace(/^([shcl]\.)?([a-z0-9_]+)$/,"$2");return"n"===l||/^[0-9a-z_]{2,}/.test(l.replace(/\[.*/g,""))||(n+=" tmp-error"),""===l?s():n;case"@":if(e.next(),"$"===e.peek()){for(e.next();/[a-zA-Z0-9_]/.test(e.peek())&&e.next(););return o()?"global-var":s()}{let t;for(;/[a-z0-9_.]/.test(t=e.peek())&&e.next(););if(!o())return s();let a=e.string.substring(e.start+1,e.pos);if(/^[a-z0-9_]{3,}(\.[a-z0-9_]{2,}){1,2}(\[\[?([a-zA-Z0-9_\$\#]+|"[^"]+"|'[^']+')\]?\])*$/i.test(a))return"db_name"}return s();case"$":if(e.next(),"@"===e.peek()){for(e.next();/[a-zA-Z0-9_]/.test(e.peek())&&e.next(););return o()?"process-var":s()}if("$"===e.peek()&&e.next(),"#"===e.peek()){for(e.next();/[a-zA-Z0-9_]/.test(e.peek())&&e.next(););return o()?"code-var":s()}{for(;/[a-zA-Z0-9_"]/i.test(e.peek())&&e.next(););if(!o())return s();let t=e.string.substring(e.start,e.pos);t=t.replace(/\[.*/g,"");let i="variable",n=t.substring(1);return a.inTotumBlock&&(i+=" totum-block"),"$"===n[0]&&(i+=" dollar-dollar",n=n.substring(1)),a.inTotumBlock||-1!==a.lineNames.indexOf(n)||(i+=" var-not-in"),i}case"t":if("true"===e.string.substring(e.start,e.start+4))return e.skipTo("e"),e.next(),"boolean";break;case"f":if("false"===e.string.substring(e.start,e.start+5))return e.skipTo("e"),e.next(),"boolean"}if(a.inFuncName=!1,!a.inFunction&&/[a-zA-Z]/.test(e.peek())){if(a.inFuncName=!0,e.skipTo("(")?a.inFunction=!0:e.skipToEnd(),!/^[a-zA-Z]+[0-9]*\s*$/.test(i()))return s();let t=n[i().trim().toLowerCase()];return t?(a.func=t,e.next(),"function"+(()=>{let t,a,i=" notclosed",n=e.string.substring(e.pos),l=['"',"'","`"];for(let e=0;e<n.length;e++)if(a=n[e],")"==a){if(!t){i="";break}}else t===a?t=null:t||-1===l.indexOf(a)||(t=a);return i})()):s()}if(a.inFunction){if(")"===e.peek())return e.next(),a.inFunction=!1,a.functionParam="",delete a.func,"function";if(!a.functionParam&&/[a-z_]/.test(e.peek())){if(e.skipTo(":")){let t=e.string.substring(e.start,e.pos);if(/^[a-z_]+\s*$/.test(t)){if(a.functionParam=t,e.next(),-1===a.func[2].indexOf(t))return s();let i="functionParam";return-1!==l.indexOf(t)&&(i+=" fieldParam"),-1!==a.func[3].indexOf(t)&&(i+=" reqParam"),a.func[4]&&-1!==a.func[4].indexOf(t)&&(i+=" multiParam"),i}return s()}return e.skipTo(")")?"error fieldParam":s()}if(!a.functionParam)return s();if(";"===e.peek())return e.next(),a.functionParam="","";if(("order"===a.functionParam||"key"===a.functionParam&&"listSort"===a.func[5])&&/[ad]/.test(e.peek())){if("asc"===e.string.substring(e.start,e.start+3))return e.next(),e.next(),e.next(),"";if("desc"===e.string.substring(e.start,e.start+4))return e.next(),e.next(),e.next(),e.next(),""}if("key"===a.functionParam&&-1!==["listSort","listFilter","listSearch"].indexOf(a.func[5])&&/[ns]/.test(e.peek())&&("num"===e.string.substring(e.start,e.start+3)||"str"===e.string.substring(e.start,e.start+3)))return e.next(),e.next(),e.next(),"";if("'"===e.peek()){let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string-name "+("code"===a.functionParam?"code-name":"")):s()}}if("'"===e.peek()){let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string"):s()}if(/\d|%/.test(e.peek())){for(e.next();/[0-9.%]/.test(e.peek())&&e.next(););return/^\d+(\.\d+)?%?$/.test(e.string.substring(e.start,e.pos))?"number":s()}return/[\^+-\/*!<>=]/.test(e.peek())?(e.next(),"operator"):s()}}})),CodeMirror.registerHelper("hint","totumVars",(function(e,a){return function(e,a,s,r){var d,h=e.getCursor(),u=s(e,h),m=e.getLine(h.line);if(u.type&&!u.type.match("string-name")&&/\b(?:string|comment)\b/.test(u.type))return;var b=CodeMirror.innerMode(e.getMode(),u.state);if("json"===b.mode.helperType)return;u.state=b.state,u.inString=u.string,u.state.isDb_name=!1,u.state.showAll=!0,r.inStart=!0;let g,w=function(e,t,a){null!=a&&(e.replaceRange(a.text||a,t.from,t.to),a.curPos&&e.setCursor({line:t.from.line,ch:a.curPos}),a.showHint&&CodeMirror.showHint(e,CodeMirror.hint.totumVars,{}))},v={text:"math``",textVis:"math``",title:"",render:p,type:"",curPos:u.start+5,hint:w,tab:!0},_={text:"json``",textVis:"json``",title:"",render:p,type:"",curPos:u.start+5,hint:w,tab:!0},y={text:"cond``",textVis:"cond``",title:"",render:p,type:"",curPos:u.start+5,hint:w,tab:!0},x={text:"qrow``",textVis:"qrow``",title:"",render:p,type:"",curPos:u.start+4,hint:w,tab:!0},k={text:"str``",textVis:"str``",title:"",render:p,type:"",curPos:u.start+4,hint:w,tab:!0};if(a=a.slice(),u.state.isStart||0===h.ch){if(!u.state.inTotumBlock){a=[],u.string=u.string.replace(/^[\t]+/,"");let i="";/^~/.test(u.string)&&(u.string.replace(/^~/,""),i="~"),t(e.getWrapperElement()).find(".cm-var-not-in:not(.cm-totum-block)").each((function(){let e=t(this).text().replace(/^(\#|\$)?\$/,"").replace(/\[.*/,"");a.push({text:i+e+": ",displayText:e})})),t(e.getWrapperElement()).find(".cm-exec:not(.cm-totum-block)").each((function(){let n;if(n=t(this).text().match(/^\s*=\s*([a-zA-Z0-9]+)\s*:/)){let l=!1,s=n[1];t(e.getWrapperElement()).find(".cm-start:not(.cm-totum-block)").each((function(){t(this).text().trim().replace("~","").replace(":","").replace("```","")===s&&(l=!0)})),l||a.push({text:i+s+": ",displayText:s})}}))}}else if("error"===u.type&&u.state.func&&u.state.func[2].length&&-1!==[";","/"].indexOf(m[u.start])){a=[],d=u.string.substr(0,h.ch-u.start).replace(/^[;\/]+([a-z_]*).*/,"$1");let e=u.string.substr(h.ch-u.start).replace(/^[;\/]+[a-z_]*(.*)/,"$1");u.state.func[2].forEach((function(t){let i="",n="";-1!==[";",")"].indexOf(e.trim()[0])?n=e:e.match(/[)]/)&&(n=";"+e),-1!==u.state.func[3].indexOf(t)&&(i+=" item-reqParam"),-1!==u.state.func[4].indexOf(t)&&(i+=" item-multiParam"),-1!==l.indexOf(t)&&(i+=" item-fieldParam");let s="";-1===["("," "].indexOf(m[u.start-1])&&(s=" "),a.push({text:s+t+": "+n,textVis:t,title:"",render:p,type:i,hint:w,curPos:u.start+s.length+(t+": "+n).length-n.length})}))}else if(/^'.*?'?$/.test(u.string)&&-1!==l.indexOf(u.state.functionParam))if(u.state.showAll=!0,"''"===u.string?(u.end=u.end,u.start+=1,u.string=""):/'[a-z_0-9]+'/.test(u.string)?(u.start+=1,u.string=u.string.slice(1,h.ch-u.start)):(u.string=u.string.slice(1,h.ch-u.start),u.start+=1,u.end=h.ch,"'"===e.getLine(h.line)[h.ch]&&u.end++),"table"===u.state.functionParam){let e=c();a=[],Object.keys(e).forEach((function(t){a.push({text:t+"'",textVis:t,title:e[t].t,render:p,type:"item-string-name",hint:w,tab:!0})}))}else{let t,i=e.getLine(h.line),n=i.substring(0,h.ch),l=i.substring(h.ch),s=l.substring(0,l.indexOf(")"));if(n=n.substring(n.lastIndexOf("("))+s,t=n.match(/table:\s*((\$#ntn)|'([a-z_0-9]*)')/)){let i=t[2]?e.table:t[3];o[i]&&o[i].f&&(a=[],Object.keys(o[i].f).forEach((function(e){a.push({text:e+"'",textVis:e,title:o[i].f[e][0],render:p,type:"item-string-name",curPos:h.ch+e.length+1,tab:!0})})),a.push({text:"id'",textVis:"id",title:"",render:p,type:"item-string-name",curPos:h.ch+3,tab:!0}))}}else{if(u.end>h.ch&&(u.end=h.ch,u.string=u.string.slice(0,h.ch-u.start)),"spec"===u.type){let e=u.string.match(/([a-z]+)`([^`]*)`?/),t=h.ch-u.start;u.string=u.string.substr(0,t),u.string=u.string.replace(/[a-z]+`([^`]*)`?/,"$1"),u.start=u.start+e[1].length+1,(e=u.string.match(/([a-z$#.-0-9@_"'\[\]]+)$/i))?(u.start+=u.string.length-e[1].length,u.string=e[1]):(u.string="",u.start=h.ch,u.end=h.ch)}if(0===u.string.indexOf("@")){r.inStart=!1,a=[];let e,t=c();if(u.string=u.string.slice(1,h.ch-u.start),u.start=u.start+1,u.end=h.ch,e=u.string.match(/^([a-z_0-9]+)\.(([a-z_0-9]+)\.)?/)){let i=e[1];e[2]?(u.start+=e[0].length,u.string=u.string.slice(e[0].length)):(u.start+=(i+".").length,u.string=u.string.slice((i+".").length)),t[i]&&Object.keys(t[i].f).forEach((function(n){if(-1===["but","cha"].indexOf(t[i].f[n][1])){if(e[2]&&"c"!==t[i].f[n][2])return;if("fl"===t[i].f[n][2])return;a.push({text:n,title:t[i].f[n][0]+("c"===t[i].f[n][2]?"[]":""),render:p,type:"item-db_name"})}}))}else Object.keys(t).forEach((function(e){a.push({text:e+".",textVis:e,title:t[e].t,render:p,type:"item-db_name",showHint:!0,hint:w})}))}else if("$#"===u.string.slice(0,2)){a=[{text:"$#lc",title:App.translate("empty list"),render:p,type:"item-code-var"},{text:"$#nd",title:App.translate("date")+" - Y-m-d",render:p,type:"item-code-var"},{text:"$#ndt",title:App.translate("date-time")+" - Y-m-d H:i",render:p,type:"item-code-var"},{text:"$#ndts",title:App.translate("date-time with secongs")+" - Y-m-d H:i:s",render:p,type:"item-code-var"},{text:"$#nu",title:App.translate("user id"),render:p,type:"item-code-var"},{text:"$#nr",title:App.translate("user roles ids"),render:p,type:"item-code-var"},{text:"$#nti",title:App.translate("table id"),render:p,type:"item-code-var"},{text:"$#ntn",title:App.translate("table NAME"),render:p,type:"item-code-var"},{text:"$#nth",title:App.translate("temporary table HASH"),render:p,type:"item-code-var"},{text:"$#ih",title:App.translate("adding row HASH"),render:p,type:"item-code-var"},{text:"$#nci",title:App.translate("calcuated table cycle id"),render:p,type:"item-code-var"},{text:"$#nf",title:App.translate("field NAME"),render:p,type:"item-code-var"},{text:"$#nl",title:App.translate("new line"),render:p,type:"item-code-var"},{text:"$#tb",title:App.translate("tab"),render:p,type:"item-code-var"},{text:"$#tpa",title:App.translate("action code action type"),render:p,type:"item-code-var"},{text:"$#ids",title:App.translate("the ids of the checked fields"),render:p,type:"item-code-var"},{text:"$#nfv",title:App.translate("current field value (for selections/actions/formats)"),render:p,type:"item-code-var"},{text:"$#onfv",title:App.translate("past value of the current field"),render:p,type:"item-code-var"},{text:"$#nh",title:App.translate("current host-name"),render:p,type:"item-code-var"},{text:"$#duplicatedId",title:App.translate("duplicated row id"),render:p,type:"item-code-var"}],e.codeType&&"format"!==e.codeType||a.push({text:"$#rows",title:App.translate("RowList of page rows/table"),render:p,type:"item-code-var"});const t=function(e){let t=a.slice(),i=[];return t=t.filter((function(t){if(-1===e.indexOf(t.text))return!0;i.push(t)})),i.concat(t)};switch(u.state.functionParam){case"table":a=t(["$#ntn"]);break;case"cycle":a=t(["$#nci"]);break;case"field":a=t(["$#nf","$#nfv"])}}else if("$@"===u.string.slice(0,2));else if(g=u.string.match(/(.*)(#?\$)([a-z_0-9]*)/i))a=[],u.string=g[3],u.start=u.start+g[1].length+g[2].length,u.end=h.ch,u.state.inTotumBlock?a.push(...u.state.codeBlock[5]||[]):a.push(...u.state.lineCodeNames||[]);else if(g=u.string.match(/(.*)\#(?:(old|s|h|c|l)\.)?[-a-z0-9_]*$/i))a=[],u.string=u.string.slice(g[1].length+1,h.ch-u.start),u.start=u.start+g[1].length+1,u.end=h.ch,(g=u.string.match(/^([a-z]{1,3}\.)/))&&(u.string=u.string.slice(g[1].length),u.start+=g[1].length),e.table&&o[e.table]&&(Object.keys(o[e.table].f).forEach((function(t){a.push({text:t,title:o[e.table].f[t][0],render:p,type:"item-db-name"})})),a.push({text:"id",title:"",render:p,type:"item-db-name"}));else if(u.state.inFuncName){if(!u.state.inFunction)if(g=u.string.match(/^([a-zA-Z]+)([\/;])/)){let e;if(u.state.showAll=!0,e=n[g[1].toLowerCase()]){let t=u.start,i=u.string.lastIndexOf(";")>u.string.lastIndexOf("/")?u.string.lastIndexOf(";"):u.string.lastIndexOf("/");u.start=u.start+i+1,u.string=u.string.slice(i+1,h.ch-t),u.end=h.ch,a=[],e[2].forEach((function(t){let i="";-1!==e[3].indexOf(t)&&(i+=" item-reqParam"),-1!==e[4].indexOf(t)&&(i+=" item-multiParam"),-1!==l.indexOf(t)&&(i+=" item-fieldParam"),a.push({text:t+": ",textVis:t,title:"",render:p,type:i})}))}}else(a=i.slice()).push("true"),a.push("false"),a.unshift(v),a.unshift(_),a.unshift(y),a.unshift(x),a.unshift(k)}else u.state.func&&("error fieldParam"===u.type||/(\(|;\s*)$/.test(e.getLine(h.line).slice(0,u.start)))?(a=[],u.state.func[2].forEach((function(t){let i="",n="";")"!==e.getLine(h.line).slice(h.ch).trim()&&(n="; "),-1!==u.state.func[3].indexOf(t)&&(i+=" item-reqParam"),-1!==u.state.func[4].indexOf(t)&&(i+=" item-multiParam"),-1!==l.indexOf(t)&&(i+=" item-fieldParam"),a.push({text:t+": "+n,textVis:t,title:"",render:p,type:i,hint:w,curPos:u.start+(t+": "+n).length-n.length})}))):"spec"!=u.type&&(a=["true","false",v,_,y,k,x],"order"===u.state.functionParam&&(a=a.concat(["asc","desc"])))}return{list:f(u,a,r,d),from:CodeMirror.Pos(h.line,u.start),to:CodeMirror.Pos(h.line,u.end)}}(e,h,(function(e,t){return e.getTokenAt(t)}),a)}));let o=[],r=!1,d=null;const c=function(){if((!d||d<Math.floor(Date.now()/1e3)-40)&&(d=Math.floor(Date.now()/1e3),o=[]),!o||0===o.length&&!r){r=!0;let e=t("#table").data("pctable");e&&e.isCreatorView&&e.model.getAllTables().then(e=>{o=e.tables,r=!1})}return o},p=function(e,a,i){t(e).append('<span class="'+i.type+'">'+(i.textVis||i.text)+(""===i.title?"":' <span class="descr">'+i.title+"</span>")+"</span>")};let h=[];function f(e,t,a,i){var n=[],l=[];i=void 0===i?e.string.toLowerCase():i,a&&a.globalScope;if(!e.state.showAll&&""===i)return found;return t.forEach((function(e){let t,s="";if("string"==typeof e?t=e.toLowerCase():(t=e.text.toLowerCase(),e.title&&(s=e.title.toLowerCase())),!u(n,t)&&!u(l,t)){0===t.lastIndexOf(i,0)||0===s.lastIndexOf(i,0)?n.push(e):-1!==s.indexOf(i,0)?l.push(e):a.inStart||-1===t.indexOf(i)||l.push(e)}})),1===n.length&&n[0]===i||1===n.length&&n[0].text===i||1===l.length&&l[0]===i||1===l.length&&l[0].text===i?[]:n.concat(l)}function u(e,t){return-1!==e.indexOf(t)}CodeMirror.defineOption("autoCloseFunctions",!1,(function(a){"totum"===a.getOption("mode")&&function(a){c();var i={name:"autoCloseFunctions"};i["'('"]=s,i["')'"]=s,a.addKeyMap(i),a.on("keydown",(function(e,t){if("9"===(t.keyCode||t.which).toString())(function(e,t,a){var i=e.getCursor();if(e.getTokenAt(i).state.inFunction){let n,l,s=e.getLine(i.line);if(a||t){n=i.ch;let e=n;for(;" "===s[e];)e++;if(";"===s[e])for(n=e,l=n+1;";"!==s[l]&&")"!==s[l];)l++;else{for(l=n;";"!==s[l]&&")"!==s[l];)l++;for(";"===s[l]&&l++;"("!==s[n]&&";"!==s[n];)n--;n++}}else{for(n=i.ch;s[n]&&-1===[":",")"].indexOf(s[n]);)n++;for(":"===s[n]&&(n++," "===s[n]&&n++)," "===s[n]&&n++,l=n;s[l]&&-1===[";",")"].indexOf(s[l]);)l++}return e.setSelection({line:i.line,ch:n},{line:i.line,ch:l}),!0}})(e,t.altKey,t.shiftKey)&&t.preventDefault();else if("13"===(t.keyCode||t.which).toString()){let t=e.getCursor(),a=t.line;if(e.getLine(a).match(/```[a-zA-Z0-9_]+:[a-z]/)){let i=!1,n=e.getLine(++a);for(;void 0!==n;){if("```"===n){i=!0;break}if("```"===n.substr(0,3))break;n=e.getLine(++a)}i||(e.replaceRange("\n```\n",t),e.setCursor(t))}}})),a.on("keyup",(function(t,a){t.options.bigOneDialog&&e.top.wasCtrl(a)&&"83"===(a.keyCode||a.which).toString()?(a.stopPropagation(),"function"==typeof t.options.bigOneDialog?t.options.bigOneDialog():t.options.bigOneDialog.close()):e.top.wasCtrl(a)&&"191"===(a.keyCode||a.which).toString()&&CodeMirror.commentMe(t),"27"===(a.keyCode||a.which).toString()?(t.state.completionActive&&t.state.completionActive.close(),a.stopPropagation()):{9:"tab",13:"enter",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",38:"up",40:"down",57:"("}[(a.keyCode||a.which).toString()]||CodeMirror.showHint(t,CodeMirror.hint.totumVars,{})})),a.on("dblclick",(function(e){var i=a.getCursor(),n=a.getTokenAt(i).state;let l,s=t(a.getWrapperElement()),o=a.getLine(i.line),r=o.substring(0,i.ch);if(n.inTotumBlock)return!1;if(/^\s*~?(```)?\s*?[a-zA-Z0-9_]+$/.test(r))l=n.lineName;else{let e=i.ch-1;if(/[a-zA-Z0-9_]/.test(o[e])){for(;--e&&e>=0&&/[a-zA-Z0-9_]/.test(o[e]););if("$"===o[e]){let t=e+1;for(e=i.ch-1;++e&&o.length>e&&/[a-zA-Z0-9_]/.test(o[e]););l=o.substring(t,e)}}}if(l){if(new RegExp("^s*~?(```)?s*"+l+"s*:").test(s.find(".cm-start.light").text()))s.find(".light").removeClass("light");else{s.find(".light").removeClass("light");let e=new RegExp("\\$"+l+"\\b");s.find(".cm-variable,.cm-inVars,.cm-spec,.cm-db_name").filter(":not(.cm-totum-block)").each((function(){let a=t(this);a.text().match(e)&&a.addClass("light")})),s.find(".cm-start:not(.cm-totum-block)").each((function(){let e=t(this);e.text().trim().replace("~","").replace(":","").replace("```","")===l&&e.addClass("light")}))}}}))}(a),"sections"===a.getOption("mode")&&CodeMirror.sectionsAutoCloses(a)})),function(){"use strict";function t(e,t,a){this.cm=e,this.getHints=t,this.options=a,this.widget=this.onClose=null}function a(e){return"string"==typeof e?e:e.text}function i(t,i){this.completion=t,this.data=i;var n=this,l=t.cm,s=t.options,o=this.hints=e.top.document.createElement("ul");o.className="CodeMirror-hints",this.selectedHint=0;for(var r=i.list,d=0;d<r.length;++d){var c=o.appendChild(e.top.document.createElement("li")),p=r[d],h="CodeMirror-hint"+(d?"":" CodeMirror-hint-active");null!=p.className&&(h=p.className+" "+h),c.className=h,p.render?p.render(c,i,p):c.appendChild(e.top.document.createTextNode(p.displayText||a(p))),c.hintId=d}var f=l.cursorCoords(!1!==s.alignWithWord?i.from:null),u=f.left,m=f.bottom+3,b=!0;o.style.left=u+"px",o.style.top=m+"px";var g,w=e.innerWidth||Math.max(e.top.document.body.offsetWidth,e.top.document.documentElement.offsetWidth),v=e.innerHeight||Math.max(e.top.document.body.offsetHeight,e.top.document.documentElement.offsetHeight),_=o.getBoundingClientRect(),y=_.right-w,x=_.bottom-v;if(y>0&&(_.right-_.left>w&&(o.style.width=w-5+"px",y-=_.right-_.left-w),o.style.left=(u=f.left-y)+"px"),x>0){var k=_.bottom-_.top;_.top-(f.bottom-f.top)-k>0?(x=k+(f.bottom-f.top),b=!1):k>v&&(o.style.height=v-5+"px",x-=k-v),o.style.top=(m=f.bottom-x)+"px"}((s.container||e.top.document.body).appendChild(o),l.addKeyMap(this.keyMap=function(e,t){var a={Up:function(){t.moveFocus(-1)},Down:function(){t.moveFocus(1)},PageUp:function(){t.moveFocus(-t.menuSize())},PageDown:function(){t.moveFocus(t.menuSize())},Home:function(){t.setFocus(0)},End:function(){t.setFocus(t.length)},Enter:t.pick,Esc:t.close},i=e.customKeys?{}:a;function n(e,n){var l;l="string"!=typeof n?function(e){return n(e,t)}:a.hasOwnProperty(n)?a[n]:n,i[e]=l}if(e.customKeys)for(var l in e.customKeys)e.customKeys.hasOwnProperty(l)&&n(l,e.customKeys[l]);if(e.extraKeys)for(var l in e.extraKeys)e.extraKeys.hasOwnProperty(l)&&n(l,e.extraKeys[l]);return i}(s,{moveFocus:function(e){n.changeActive(n.selectedHint+e)},setFocus:function(e){n.changeActive(e)},menuSize:function(){return n.screenAmount()},length:r.length,close:function(){t.close()},pick:function(){n.pick()}})),!1!==s.closeOnUnfocus)&&(l.on("blur",this.onBlur=function(){g=setTimeout((function(){t.close()}),100)}),l.on("focus",this.onFocus=function(){clearTimeout(g)}));var C=l.getScrollInfo();return l.on("scroll",this.onScroll=function(){var a=l.getScrollInfo(),i=l.getWrapperElement().getBoundingClientRect(),n=m+C.top-a.top,s=n-(e.pageYOffset||(e.top.document.documentElement||e.top.document.body).scrollTop);if(b||(s+=o.offsetHeight),s<=i.top||s>=i.bottom)return t.close();o.style.top=n+"px",o.style.left=u+C.left-a.left+"px"}),CodeMirror.on(o,"click",(function(e){for(var t=e.target||e.srcElement;"SPAN"===t.nodeName;)t=t.parentNode;null!=t.hintId&&(n.changeActive(t.hintId),n.pick())})),CodeMirror.on(o,"mousedown",(function(){setTimeout((function(){l.focus()}),20)})),CodeMirror.signal(i,"select",r[0],o.firstChild),!0}CodeMirror.showHint=function(e,a,i){if(!e.somethingSelected()&&(null==a&&(a=e.getHelper(e.getCursor(),"hint")),null!=a)){e.state.completionActive&&e.state.completionActive.close();var n=e.state.completionActive=new t(e,a,i||{});if(CodeMirror.signal(e,"startCompletion",e),!n.options.async)return n.showHints(a(e,n.options));a(e,(function(e){n.showHints(e)}),n.options)}},CodeMirror.commentMe=function(e){var t=e.getCursor(),a=(e.getTokenAt(t).state,e.lineInfo(t.line));let i;(i=a.text.match(/^([\t\s]*)\/\//))?e.replaceRange("",{line:t.line,ch:i[1].length},{line:t.line,ch:i[0].length}):(i=a.text.match(/^[\t\s]*/),e.replaceRange("//",{line:t.line,ch:i[0].length},{line:t.line,ch:i[0].length}))},t.prototype={close:function(){this.active()&&(this.widget&&this.widget.close(),this.onClose&&this.onClose(),this.cm.state.completionActive=null,CodeMirror.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(e,t){var i=e.list[t];i.hint?i.hint(this.cm,e,i):this.cm.replaceRange(a(i),e.from,e.to),this.close();this.cm},showHints:function(e){if(!e||!e.list.length||!this.active())return this.close();this.showWidget(e)},showWidget:function(e){this.widget=new i(this,e),CodeMirror.signal(e,"shown");var t,a=null,n=this,l=this.options.closeCharacters||/[\s()\[\]{};:>,]/,s=this.cm.getCursor(),o=this.cm.getLine(s.line).length;function r(){t||(t=!0,n.close(),n.cm.off("cursorActivity",h),CodeMirror.signal(e,"close"))}function d(){return!!t||(n.widget?void 0:(r(),!0))}function c(){d()||(n.options.async?n.getHints(n.cm,p,n.options):p(n.getHints(n.cm,n.options)))}function p(e){if(!d()){if(!e||!e.list.length)return r();n.widget.close(),n.widget=new i(n,e)}}function h(){clearTimeout(a);var e=n.cm.getCursor(),t=n.cm.getLine(e.line);e.line!=s.line||t.length-e.ch!=o-s.ch||e.ch<s.ch||n.cm.somethingSelected()||e.ch&&l.test(t.charAt(e.ch-1))?n.close():a=setTimeout(c,170)}this.cm.on("cursorActivity",h),this.onClose=r}},i.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null,this.hints.parentNode.removeChild(this.hints),this.completion.cm.removeKeyMap(this.keyMap);var e=this.completion.cm;!1!==this.completion.options.closeOnUnfocus&&(e.off("blur",this.onBlur),e.off("focus",this.onFocus)),e.off("scroll",this.onScroll)}},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(e){if(e=Math.max(0,Math.min(e,this.data.list.length-1)),this.selectedHint!=e){var t=this.hints.childNodes[this.selectedHint];t.className=t.className.replace(" CodeMirror-hint-active",""),(t=this.hints.childNodes[this.selectedHint=e]).className+=" CodeMirror-hint-active",t.offsetTop<this.hints.scrollTop?this.hints.scrollTop=t.offsetTop-3:t.offsetTop+t.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=t.offsetTop+t.offsetHeight-this.hints.clientHeight+3),CodeMirror.signal(this.data,"select",this.data.list[this.selectedHint],t)}},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}}}()}(),function(){const e=function(e){return{doc:e.doc}};CodeMirror.extendMode("css",{commentStart:"/*",commentEnd:"*/",newlineAfterToken:function(e,t){return/^[;{}]$/.test(t)}}),CodeMirror.extendMode("javascript",{commentStart:"/*",commentEnd:"*/",newlineAfterToken:function(e,t,a,i){return this.jsonMode?/^[\[,{]$/.test(t)||/^}/.test(a):(";"!=t||!i.lexical||")"!=i.lexical.type)&&(/^[;{}]$/.test(t)&&!/^;/.test(a))}}),CodeMirror.extendMode("xml",{commentStart:"\x3c!--",commentEnd:"--\x3e",newlineAfterToken:function(e,t,a){return"tag"==e&&/>$/.test(t)||/^</.test(a)}}),CodeMirror.defineExtension("commentRange",(function(e,t,a){var i=this,n=CodeMirror.innerMode(i.getMode(),i.getTokenAt(t).state).mode;i.operation((function(){if(e)i.replaceRange(n.commentEnd,a),i.replaceRange(n.commentStart,t),t.line==a.line&&t.ch==a.ch&&i.setCursor(t.line,t.ch+n.commentStart.length);else{var l=i.getRange(t,a),s=l.indexOf(n.commentStart),o=l.lastIndexOf(n.commentEnd);s>-1&&o>-1&&o>s&&(l=l.substr(0,s)+l.substring(s+n.commentStart.length,o)+l.substr(o+n.commentEnd.length)),i.replaceRange(l,t,a)}}))})),CodeMirror.defineExtension("autoIndentRange",(function(e,t){var a=this;this.operation((function(){for(var i=e.line;i<=t.line;i++)a.indentLine(i,"smart")}))})),CodeMirror.defineExtension("autoFormatRange",(function(t,a){var i=this,n=i.getMode(),l=i.getRange(t,a).split("\n"),s=CodeMirror.copyState(n,i.getTokenAt(t).state),o=i.getOption("tabSize"),r="",d=0,c=0==t.ch;function p(){r+="\n",c=!0,++d}for(var h=0;h<l.length;++h){for(var f=new CodeMirror.StringStream(l[h],o,e(i));!f.eol();){var u=CodeMirror.innerMode(n,s),m=n.token(f,s),b=f.current();f.start=f.pos,c&&!/\S/.test(b)||(r+=b,c=!1),!c&&u.mode.newlineAfterToken&&u.mode.newlineAfterToken(m,b,f.string.slice(f.pos)||l[h+1]||"",u.state)&&p()}!f.pos&&n.blankLine&&n.blankLine(s),c||p()}i.operation((function(){i.replaceRange(r,t,a);for(var e=t.line+1,n=t.line+d;e<=n;++e)i.indentLine(e,"smart");i.setSelection(t,i.getCursor(!1))}))}))}();let o={};setTimeout(()=>{App.FieldTypes=o});var r={sortable:!1,width:50,icon:"fa-font",editable:!1,required:!0,insertable:!1,type:"string",getPanelVal:e=>e,isCyclesTabButton:()=>!1,getPanelFormats(e,a){let i=this;if(e.empty(),a){let n;a.rows.forEach(n=>{switch(n.type){case"text":e.append(t('<div class="panel-text">').text(n.value));break;case"html":e.append(t('<div class="panel-html">').html(n.value));break;case"img":e.append(t('<div class="panel-img">').append(t("<img>").attr("src","/fls/"+n.value+"_thumb.jpg?rand="+Math.random())));break;case"buttons":if(n.value&&n.value.forEach){let l=[];n.value.forEach(e=>{let n=t('<button class="btn btn-default btn-xxs">').text(e.text);e.icon&&n.prepend(t('<i class="fa"></i>').addClass("fa-"+e.icon)),l.push(n),e.color&&n.css("color",App.theme.getColor(e.color,!0)),e.background&&n.css("background-color",App.theme.getColor(e.background)),n.on("click",(function(){i.pcTable.selectedCells&&(i.pcTable.selectedCells.empty(),i.pcTable.selectedCells.selectPanelDestroy()),i.pcTable.model.panelButtonsClick(a.hash,e.ind).then((function(t){e.refresh&&i.pcTable.model.refresh(null,e.refresh)}))}))}),e.append(t('<div class="panel-buttons">').append(l))}}}),a.hash&&(n=setInterval(()=>{t("body .popover").length||(clearInterval(n),i.pcTable.model.panelButtonsClear(a.hash))},1e4))}},getEditVal:function(e){var t,a=e.val().trim(),i=!1;(!this.required||void 0!==a&&""!==a&&null!==a||(t=App.translate("The field %s must be entered",this.title),i=!0),this.regexp&&""!==a)&&(new RegExp(this.regexp).test(a)||(t=this.regexpErrorText||App.translate('Value fails regexp validation: "%s"',this.regexp),t=App.translate('Filled "%s" field  error: %s',[this.title,t]),i=!0));if(i)throw t;return a},getEditElement:function(e,a,i,n,l,s,o){var r=e;e&&e.is("input")||(r=t('<input type="text" class="form-control" name="cell_edit" autocomplete="off" autocorrect="off" />'),this.checkWaiting(r),r.on("blur",(function(e){s(r,e)})),r.on("keydown",(function(e){switch(e.keyCode){case 13:case 9:try{r.data("enterClicked",!0),n(t(this),e,13===e.keyCode&&"enter")}catch(e){r.data("enterClicked",!1),App.popNotify(e,r,"default"),d.focusElement(r)}break;case 27:e.stopPropagation(),l(t(this),e)}})),setTimeout(()=>{0===r.closest(".InsertRow").length&&r.on("focus",()=>{r.select()})},10)),void 0!==o&&r.attr("tabindex",o);var d=this;return a=a.v,r.val(a),r},checkEditRegExp:function(e){if(!this.warningEditRegExp)return!0;try{let t=this.warningEditRegExp.match(/^\/(.*?)\/([a-z]*)$/);return new RegExp(t[1],t[2]).test(e)}catch(e){return!0}},getCellText:function(e){if(!0===this.url&&e){let a=this.openIn||"window";switch(a){case"window":a="_self";break;case"newWindow":a="_blank"}let i=t('<a class="uri" target="'+a+'">').attr("href",e).text(e);return"iframe"===a&&i.attr("onclick","return App.aInIframe(this);"),i}return e},getPanelText:function(e,t,a){return this.getCellText(e,t,a)},getCopyText:function(e,a){let i=this.getPanelText(e.v,null,a);if("string"==typeof i)return i;const n=function(e){if(e&&e.each&&"[object Function]"==={}.toString.call(e.each)){let a="";return e.each((function(){""!==a&&(a+="; "),a+=t(this).text().replace(/\n/g,"; ")})),a}return e};if(null===i)return"";if("object"==typeof i&&!(i instanceof jQuery)){let e=t.Deferred();return i.done((function(t){e.resolve(n(t))})).fail((function(){e.resolve(App.translate("Failed to load data"))})),e}return n(i)},focusElement:function(e){e.is("div")?e.find("button").focus():e.focus(),e.closest("tr").is(".InsertRow")&&(this.pcTable._insertRow.find(".active").removeClass("active"),e.closest("td").addClass("active"))},isDataModified:function(e,t){return"null"===(e+="")&&(e=""),"null"===(t+="")&&(t=""),"undefined"===t&&(t=""),e!==t},getFilterDataByValue:function(e){let t=[];return this.addDataToFilter(t,e),Object.keys(t)},addDataToFilter:function(e,t){let a,i=App.translate("Empty");null===t.v||""===t.v?a="".hashCode():(a=t.v.toString().hashCode(),i="string"==typeof t.v?t.v.replace(/"/g,"&quot;"):t.v+" "),e[a]=i},checkIsFiltered:function(e,t){let a={};return this.addDataToFilter(a,e),t.some((function(e){return e in a}))},getCellTextInPanel:function(e,t,a){return this.getCellText(e,t,a)},getPanelColumnIndex:function(e){return e.f&&e.f.hide&&e.f.hide.panel?0:-1!==["text","comments","file","listRow"].indexOf(this.type)||this.multiple?1.5:1},getHighCelltext:function(e,t,a){return this.getPanelText?this.getPanelText(e,t,a):this.getCellText(e,t,a)},checkWaiting:function(e){if(this.waiting){let t=this;t.target=e;let a=e.is("button")?"click keydown":"focus";"select"!==t.type&&"checkbox"!==t.type||(a="mousedown keydown focus"),e.on(a,(function(a,i){let n=!1;const l=()=>{if(t.waiting[0]){if(e.is("input")&&e.prop("readonly",!0),"checkbox"===t.type&&-1!==["mousedown","click","keydown"].indexOf(a.type))return;n||(n=!0,App.fullScreenProcesses.show()),setTimeout(l,200)}else e.is("input")&&e.prop("readonly",!1),n&&App.fullScreenProcesses.hide(),a.originalEvent?(a.originalEvent.done=!0,t.target.get(0).dispatchEvent(a.originalEvent)):t.target.trigger(a.type,{done:!0})};return!!(a.originalEvent&&a.originalEvent.done||i&&i.done)||(setTimeout(l,20),a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),!1)}))}}};o.text={width:50,icon:"fa-align-left",type:"Text",isPanelField:!0,getEditVal:function(e){return e.data("val").trim()},getCellText:function(e){if(null===e)return"";let a=(e=e.toString()).length;return t("<div>").text(e.substring(0,this.viewTextMaxLength)+(a>this.viewTextMaxLength?"...":"")).text()},getValue:function(e,a,i){"use strict";if(i||"string"==typeof e&&e.length<this.viewTextMaxLength&&!this.notLoaded){let a=t.Deferred();return setTimeout((function(){e||(e=""),a.resolve({value:e})}),20),a}let n={fieldName:this.name};return a.id&&(n.rowId=a.id),this.pcTable.model.getValue(n,this.table_id)},getPanelTextWithLinks:function(e,a=!0){let i;if("text"===this.textType)i=t("<div>"),i.html(App.textWithLinks(e));else if(i=t('<div class="codeEditor CodeMirror-readonly">'),e&&e.trim()){let t={value:e,mode:this.getMode(),readOnly:!0,theme:"eclipse",lineNumbers:!0,lineWrapping:!0,bigOneDialog:!0,height:200};a?setTimeout((function(){CodeMirror(i.get(0),t)}),10):i.html(App.textWithLinks(e)),i.on("panel-resize",(function(){i.empty(),CodeMirror(i.get(0),t)}))}return i},getHighCelltext:function(e,a,i){return"string"!=typeof e?"":t("<div>").text(e.trim())},getPanelText:function(e,a,i){if(null===e)return"";e=e.toString();let n=this;if(e.length<=this.viewTextMaxLength&&!this.notLoaded)return n.getPanelTextWithLinks(e,!1).data("text",e);let l=t.Deferred();return this.getValue(e,i,!1).then((function(e){l.resolve(t("<div>").append(n.getPanelTextWithLinks(e.value,!1)).data("text",e.value))})).fail((function(){l.reject()})),l.promise()},getMode(){let e="text";switch(this.textType){case"html":e="text/html";break;case"totum":e="totum";break;case"markdown":e="text/x-markdown";break;case"xml":e="application/xml";break;case"css":e="text/css";break;case"javascript":e="text/javascript"}return e},getEditElement:function(a,i,n,l,s,o,r,d){let c,p=this,h=t("<div>"),f=t("<div>"),u=t('<div class="HTMLEditor">');i=i.v||"";let m=function(){p.getValue(i,n,!d||"editField"===d).then((function(a){let i;if(h.append(u),u.empty().appendTo("editField"===d?h:f),"json"===p.textType){i=new JSONEditor(u.get(0),{});try{""!==a.value&&i.setText(a.value)}catch(t){e.top.App.modal(App.translate("JSON format error"))}let n=t('<a href="#" style="padding-top: 8px; display: inline-block; padding-left: 20px;">'+App.translate("Manually")+"</a>").on("click",(function(){let a=t("<div>"),n=t('<textarea class="form-control">').val(JSON.stringify(i.get(),null,2)).appendTo(a);e.innerHeight>460&&(n.css("height",350),u.css("min-height",200));let l=[{label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:function(t){try{i.setText(n.val()),t.close()}catch(t){e.top.App.modal(App.translate("JSON format error"))}}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];return p.pcTable.isMobile?App.mobilePanel(App.translate("Manually changing the json field"),a,{buttons:l}):BootstrapDialog.show({message:a,type:null,title:App.translate("Manually changing the json field"),buttons:l,cssClass:"fieldparams-edit-panel",draggable:!0,onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1}));u.find(".jsoneditor-menu").append(n)}else{let l=p.getMode(),s=t("<div>").height("100%").appendTo(u),o={value:(a.value||"").toString(),mode:l,minHeight:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:"editField"===d};"text"===l&&(o.lineNumbers=!1,o.lineWrapping=!0),i=e.top.CodeMirror(s.get(0),o),i.on("paste",(function(e,t){setTimeout((function(){i.refresh()}),1)})),"totum"===l&&App.CodemirrorFocusBlur(i),p.pcTable&&"tables"===p.pcTable.tableRow.name&&(i.table=n.name.v||n.name,i.cycle_id=p.pcTable.tableRow.cycle_id,i.codeType={default_action:"codeAction",on_duplicate:"codeAction",row_format:"format",table_format:"format"}[p.name]),e.innerHeight>585&&(i.getScrollerElement().style.minHeight="350px",f.css("min-height",200)),i.focus()}u.data("editor",i),h.data("editor",i)}))};const b=function(e,t,a){"json"===p.textType?h.data("val",JSON.stringify(u.data("editor").get())):h.data("val",u.data("editor").getValue()),a||(l(h,{}),e.close())};c=[];let g={label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:b},w={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){s(h,{}),e.close()}};-1!==["xml","html"].indexOf(p.textType)&&c.unshift({label:App.translate("Format"),action:function(){let e=u.data("editor"),t=e.lineCount(),a=e.getValue().length;e.autoFormatRange({line:0,ch:0},{line:t,ch:a})}});let v="ctrlS.textedit",_=()=>App.translate("Field <b>%s</b> text",this.title)+", <b>"+p.textType+"</b>"+this.pcTable._getRowTitleByMainField(n," (%s)");if(d)if("editField"===d)setTimeout(m,1);else{let a=!1;setTimeout((function(){let i=h.closest("td").find(".cdiv");if(i.length>0?(i.data("bs.popover").options.content.find(".btn").each((function(){let e=t(this),i={};i.label=e.data("name"),i.cssClass=e.attr("class").replace("btn-sm","btn-m"),i.icon=e.find("i").attr("class"),i.save=e.data("save"),i.click=e.data("click"),i.action=function(e){i.save&&b(e,0,!0),i.click({}),a=!0,e.close()},c.push(i)})),i.popover("destroy")):(c.push(g),c.push(w)),p.pcTable.isMobile)App.mobilePanel(_(),f,{buttons:c,onhide:function(e){t("body").off(v),a||o(h,{})},onshown:function(e){m()},onshow:function(e){t("body").on(v,(function(t){return b(e),!1}))}});else{let i=e.top.BootstrapDialog.show({message:f,type:null,title:_(),cssClass:"fieldparams-edit-panel",draggable:!0,buttons:c,onhide:function(i){t(e.top.document).find("body").off(v),a||s(h,{})},onshown:function(a){a.$modalContent.position({of:t(e.top.document).find("body"),my:"top+50px",at:"top"}),m()},onshow:function(a){a.$modalHeader.css("cursor","pointer"),a.$modalContent.css({width:"100%"}),t(e.top.document).find("body").on(v,(function(e){return b(a),!1}))}});h.data("Dialog",i)}}),1),h.text(App.translate("Editing in the form")).addClass("edit-in-form"),setTimeout(()=>{h.closest("td").addClass("editing-in-modal")})}else{h.on("keydown click",(function(a){if("Tab"===a.key)return void o(f,a,null,!0);let i=c.splice();i.push(g),i.push(w);var n=t(this).closest("div");p.pcTable.isMobile?App.mobilePanel(_(),f,{buttons:i,onhide:function(e){t("body").off(v),s(n,e)},onshown:function(e){m(),t("body").on(v,(function(t){return b(e),!1}))}}):e.top.BootstrapDialog.show({message:f,type:null,cssClass:"fieldparams-edit-panel",title:_(),buttons:i,draggable:!0,onhide:function(a){t(e.top.document).find("body").off(v),s(n,a)},onshown:function(a){a.$modalHeader.css("cursor","pointer"),m(),a.$modalContent.css({width:900}),t(e.top.document).find("body").on(v,(function(e){return b(a),!1}))}})}));let a=t('<button class="btn btn-default btn-sm text-edit-button">').text(App.translate("Edit text"));r&&a.attr("tabindex",r),h.append(a)}return h.data("val",i)},getEditPanelText(e){return this.getPanelTextWithLinks(e.v)},getCellTextInPanel:function(e,t,a){return this.getPanelTextWithLinks(e)},addPlaceholder(e,t){setTimeout((function(){e.data("editor").setOption("placeholder",t),e.data("editor").refresh()}),100)}},o.checkbox={icon:"fa-check-square",getEditVal:function(e){return!!e.is(":checked")},getCellText:function(e){return!0===e?"":!1===e?"-":""},getEditElement:function(e,a,i,n,l,s,o){var r=t('<input type="checkbox" name="cell_edit"/>');this.checkWaiting(r),o&&r.attr("tabindex",o);let d=!1;r.on("keydown",(function(e){switch(e.keyCode){case 13:case 9:d=!0,setTimeout((function(){n(r,e)}),20)}})),r.on("blur",(function(e){d||setTimeout((function(){r.length&&r.closest("body").length&&l(r,e)}),220)}));return!0===a.v&&r.prop("checked",!0),r.on("click",(function(e){d=!0,n(r,e,"enter")})),r}},o.string={addPlaceholder:function(e,t){e.attr("placeholder",t)}},o.number={icon:"fa-hashtag",getEditVal:function(e){let t=e.val().trim();if("string"==typeof t&&(t=t.replace(/\s+/g,"")),void 0===t||""===t||null===t){if(this.required)throw App.translate("The field %s must be entered",this.title);return""}if((t.match(/,/)&&(t=","===this.dectimalSeparator?t.replace(/,/,"."):t.replace(/,/g,"")),this.regexp)&&!new RegExp(this.regexp).test(t)){let e=this.regexpErrorText||App.translate('Value fails regexp validation: "%s"',this.regexp);throw e=App.translate('Filled "%s" field  error: %s',[this.title||this.name,e]),e}let a=t.replace(/[^\-()\d/*+.,%:\/]/g,"");if(!/^(\+|\*|\%|\/|\:)?(\-?[\d]+((\.|\,)[\d]+)?)%?$/.test(a))throw App.translate("There must be a number");return t},getCopyText:function(e,t,a){return null==e||""===e||null===e.v?"":e.v.toString().replace(/\./g,this.dectimalSeparator)},getCellText:function(e,t,a){return null==e||""===e?"":this.currency?App.numberFormat(e,this.dectimalPlaces,this.dectimalSeparator,this.thousandthSeparator,this.prefix,this.postfix):e},addPlaceholder:function(e,t){e.attr("placeholder",t)}},o.date={icon:"fa-calendar-o",getEditVal:function(e){if(this.required&&""==e.val().trim())throw App.translate("The field must be entered");if(!e.val().trim())return"";let t=e.data("calendar").data("DateTimePicker").date();return this.getDbString(t)},getEditElement:function(a,i,n,l,s,o,r,d,c){var p=(c&&c.get(0).ownerDocument.defaultView||e).$('<input type="text" name="cell_edit" class="form-control" autocomplete="off" autocorrect="off" />');this.checkWaiting(p),r&&p.attr("tabindex",r);var h=this;let f=this.getFormat();p.data("AppUin",App.getUn()),i=i.v,p.val(this.getViewString(i));let u,m=t("<div>");this.dateTime&&/d/i.test(f)&&(u="date-popover");var b=t("<div></div>").appendTo(m);let g,w,v;b.on("dp.change",(function(e){if(null!==e.oldDate||!h.dateTime||p.val()&&""!==p.val())p.val(e.date.format(f));else{let t=e.date,a=moment();t.format("HH:mm")===a.format("HH:mm")&&(t=t.hours(0).minutes(0)),p.val(t.format(f)),_()}})),p.on("keydown",(function(e){g&&clearTimeout(g),13===e.keyCode||9===e.keyCode?(_(),v&&v.is(":visible")&&v.hide(),l(t(this),e,13===e.keyCode&&"enter")):27===e.keyCode&&s(t(this),e)})),p.on("keyup",(function(e){e.keyCode>=48&&(g=setTimeout((function(){_()}),5e3))}));const _=function(){"use strict";let e=p.val(),t=f;e?(!f.match(/Y{4}/)&&f.match(/Y{2}/)&&e.length-moment().format(f).length==2&&(t=t.replace("YY","YYYY")),e=moment(e,t)):e="";try{b.data("DateTimePicker").date(e)}catch(e){}};if(setTimeout((function(){let e=p.closest("td").find(".cdiv");if(e.length>0){let a=e.data("bs.popover");a&&(a.options.content.find(".btn").each((e,a)=>{if((a=t(a)).data("click")){let e=a.data("click");a.data("click",()=>{_(),e(...arguments)})}}),m.append(a.options.content),e.popover("destroy")),v=t("#"+App.popNotify({$text:m,element:e,container:h.pcTable._container,isParams:!0,placement:"bottom",class:u})),p.on("focus click",(function(){v.show()}))}else{const e=function(e){v&&p.popover("destroy"),w=App.popNotify(m,p,null),v=t(p.get(0).ownerDocument.getElementById(w)),b.data("DateTimePicker").show(),v.show(),_()};p.on("focus",e)}}),20),p.on("blur",(function(e){setTimeout((function(){v&&v.is(":visible")&&(v.hide(),_(),o(p,e,void 0,!0))}),200)})),b.datetimepicker({inline:!0,format:f,useCurrent:!1,showClose:!1,locale:App.lang.localeDatetimepicker,sideBySide:!0,collapse:!1}),i)try{b.data("DateTimePicker").date(h.getMoment(i))}catch(e){}else p.val("");return p.data("calendar",b),p},getCellText:function(e){return e&&null!==e?this.getViewString(e):""},getViewString:function(e){return e?this.dateTime?App.dateTimeFormats.covertFromDb(e,this.getFormat()):App.dateFormats.covertFromDb(e,this.getFormat()):""},getDbString:function(e){return e?this.dateTime?App.dateTimeFormats.covertToDb(e,this.getFormat()):App.dateFormats.covertToDb(e,this.getFormat()):""},getMoment:function(e){return this.dateTime?moment(e,App.dateTimeFormats.db):moment(e,App.dateFormats.db)},addDataToFilter:function(e,t){let a,i=App.translate("Empty");null===t.v||""===t.v?a="".hashCode():(a=t.v.toString().hashCode(),i="string"==typeof t.v?this.getCellText(t.v):t.v),e[a]=i},getFormat:function(){let e=this.dateFormat;e||(e=this.dateTime?"d.m.y H:i":"d.m.y");let t={d:"DD",D:"ddd",j:"M",z:"DDD",W:"W",F:"MMMM",m:"MM",M:"MMM",n:"M",y:"YY",Y:"YYYY",H:"HH",i:"mm",s:"ss"},a="";for(let i=0;i<e.length;i++){let n=e[i];a+=t[n]||n}return a}},o.unic={icon:"fa-fire"},function(){const a=function(e,t){e.attr("data-fileviewpreview",JSON.stringify({name:t.name,file:t.file}))};o.file={icon:"fa-file-image-o",getFilePath:function(e,t,a){return"docPreview"===t?"?field="+this.name+"&docpreview="+e+"&title="+encodeURIComponent(a)+"&rand="+Math.random():"/fls/"+e+(t?"_thumb.jpg":"")+(a?"?rand="+Math.random():"")},getSize:function(e){return e>102400?" "+(Math.round(e/1048576*10)/10).toLocaleString()+"Mb":" "+Math.round(e/1024).toLocaleString()+"Kb"},getCellText:function(e){if(!e||null===e||0==e.length)return"";let i=t("<span></span>");const n=e=>{let n;if(-1!==["png","jpg"].indexOf(e.ext))n=t('<img src="'+this.getFilePath(e.file,!0)+'" style="z-index: 200;" class="file-image-preview" data-filename="'+this.getFilePath(e.file)+'"/>'),a(n,e);else if("pdf"===e.ext)n='<i class="fa fa-file-pdf-o file-pdf-preview" data-filename="'+this.getFilePath(e.file)+'"/>';else{switch(e.ext){case"xls":case"xlsx":n='<i class="fa fa-file-excel-o"/>';break;case"doc":case"docx":n='<i class="fa fa-file-word-o"/>';break;case"zip":case"gz":case"tar":n='<i class="fa fa-file-zip-o"/>';break;case"mov":case"avi":n='<i class="fa fa-file-video-o"/>';break;case"md":n='<i class="fa fa-file-code-o"/>';break;case"mp3":n='<i class="fa fa-file-audio-o"/>';break;default:n='<i class="fa fa-file-text-o"/>'}this.pcTable.tableRow.__withDocPreviews&&this.isDocPreviewExt(e.ext)&&(n=t(n).addClass("file-pdf-preview").attr("data-filename",this.getFilePath(e.file,"docPreview",e.name)))}let l=t('<a href="'+this.getFilePath(e.file)+'"  class="file-sell-text" download="'+t("<div>").text(e.name).html()+'" style="padding-right: 5px"></a>');i.append(n),l.append(e.name),i.append(l),i.find("img, i").css({"max-height":24,"margin-right":4})};return e.length&&e.forEach&&e.forEach(n),i.children()},isDocPreviewExt:function(e){switch(e){case"xlsx":case"docx":return!0}return!1},getCopyText:function(t,a){if(!(t=t.v)||null===t||0==t.length)return"";let i=this,n="";return t.forEach(t=>{""!==n&&(n+="\n"),n+=t.name+" "+e.location.protocol+"//"+e.location.host+this.getFilePath(t.file)+" "+i.getSize(t.size)}),n},getPanelText:function(i){if(!i||null===i||0==i.length)return"";let n=t('<div class="file-mini-panel">'),l=this,s="";return i.forEach(i=>{let o="",r="";-1!==["jpg","png"].indexOf(i.ext)&&(o=t('<img src="'+this.getFilePath(i.file,!0,!0)+'"/>'),r="with-img",a(o,i));let d=t("<div>").addClass(r).appendTo(n).append(o).append(t('<div class="file-label">').html(t('<a href="'+this.getFilePath(i.file)+'" download="'+t("<div>").text(i.name).html()+'">').text(i.name)).append(l.getSize(i.size)));if("pdf"===i.ext||this.pcTable.tableRow.__withDocPreviews&&this.isDocPreviewExt(i.ext)){let e;e="pdf"===i.ext?l.getFilePath(i.file):l.getFilePath(i.file,"docPreview",i.name);let a=t('<a target="_blank" class="eye-preview btn btn-default btn-xs">').attr("href",e).append('<i class="fa fa-eye">');d.find(".file-label").append(a)}""!==s&&(s+="\n"),s+=e.location.protocol+"//"+e.location.host+"/fls/"+i.file}),n.data("text",s)},getEditVal:function(e){if(this.required&&""==e.data("val"))throw App.translate("The field must be entered");return e.data("val")},getEditElement:function(a,i,n,l,s,o,r,d){let c,p,h=this,f=this.pcTable,u=t("<div>"),m=t("<div>").css("min-height",200),b=i.v||[],g=!1;const w=function(e){m.closest(".modal-content").find(".modal-footer button:first").prop("disabled",e)},v=function(){const e=e=>{let a=t('<div class="filePart"><div><span class="name"></span><span class="size"></span><button class="btn btn-danger btn-xs remove"><i class="fa fa-remove"></i></button></div></div>'),i={name:e.name,type:e.type,tmpfile:e.tmpfile,size:e.size,file:e.file,ext:e.ext};new RegExp("^"+h.pcTable.tableRow.id+"_"+(n.id?n.id:""));if(a.data("file",i),a.find(".name").text(e.name),a.find(".size").text(h.getSize(e.size)),e.file){let i=t("<a>").attr("href",h.getFilePath(e.file)).attr("download",e.name);a.find(".name").wrap(i),-1!==["jpg","png"].indexOf(e.ext)&&(t("<img>").attr("src",h.getFilePath(e.file,!0,!0)).insertBefore(a.find(".name")),a.addClass("with-img"))}else a.append('<div class="progressbar">&nbsp;</div>');if(e.tmpfile){a.addClass("addFile"),a.find(".progressbar").text(App.translate("Required to save the item for file binding"))}return a};m.empty(),"editField"===d&&(m=u);const a=((a,i,n)=>{let l=t("<div>").appendTo(i),s=t('<button class="btn btn-default btn-sm">'+n+"</button>").appendTo(l);s.on("click",(function(){t('<input type="file" name = "file" '+(a?"multiple":"")+' accept="'+h.accept+'" style="display: block; position: absolute; top: -3000px"/>').appendTo(i).on("change",(function(){d(this.files),t(this).remove()})).click()})),s.wrap('<div class="addFilesButton">'),s.wrap("<div>");let o=t('<div class="ttm-dropzone" id="ttmDropzone">'+App.translate("Drag and drop the file here")+"</div>").insertAfter(s.parent());o.on("dragenter",()=>o.addClass("highlight")),o.on("dragleave",()=>o.removeClass("highlight")),o.on("drop",e=>{if(e.preventDefault(),o.removeClass("highlight"),!o.is(".disabled")){if(!a&&e.originalEvent.dataTransfer.files.length>1)return App.notify(App.translate("The field accepts only one file"),App.translate("Error")),!1;d(e.originalEvent.dataTransfer.files)}return!1});let r=()=>{a||(i.find(".filePart").length>0?(s.prop("disabled",!0),o.addClass("disabled")):(s.prop("disabled",!1),o.removeClass("disabled")))};const d=function(a,i){if(a){let n=[];w(!0);for(let l=0,s=a.length;l<s;l++){let s=a[l];if(h.accept){let e;if((e=s.name.match(/(\.[a-zA-Z0-9]+)$/))&&(e=e[1].toLowerCase()),!h.accept.split(",").some(t=>{if(t=t.trim(),e&&e===t.toLowerCase())return!0;if(t===s.type)return!0;let a=t.split("/");return"*"===a[1]&&a[0]===s.type.split("/")[0]||void 0}))return w(!1),void App.notify(App.translate("The field accept only following types: %s",[h.accept]))}let o=i||e(s).appendTo(m);o.addClass("addFile"),r();let d=o.find(".progressbar"),c=new XMLHttpRequest,p=t.Deferred();o.on("click",".remove",(function(){o.remove(),c.abort(),p.resolve(),r()})),c.upload.onprogress=function(e){d.css("box-shadow","inset "+Math.round(parseInt(d.width())*e.loaded/e.total).toString()+"px 0px 0 0 "+App.theme.getColor("#85FF82")),e.loaded===e.total&&d.text(App.translate("Checking the file with the server"))},c.onload=c.onerror=function(e){if(p.resolve(),200===this.status)try{let e=JSON.parse(this.responseText);if(e.fname)return d.text(App.translate("Done")),void(o.data("file").tmpfile=e.fname)}catch(e){}o.data("file",null);let t="";413===this.status&&"Request Entity Too Large"===this.statusText?t=": "+App.translate("The file is too large"):this.statusText&&(t=": "+this.statusText),d.text(App.translate("Error")+t).css({"box-shadow":"none"}).addClass("load-fail")},c.open("POST",f.model.getUri(),!0);let u=new FormData;u.append("file",s),u.append("method","tmpFileUpload"),u.append("ajax",!0),c.send(u),n.push(p.promise())}t.when(...n).then((function(){w(!1)}))}};return r})(h.multiple,m,App.translate(h.multiple?"Adding files":"Adding file"));b&&b.forEach&&b.forEach((function(t){let i=e(t).appendTo(m);i.on("click",".remove",(function(){i.remove(),a()}))})),a()},_=function(e,a,i){let n=[];e.$modalContent.find(".filePart").each((function(){let e=t(this).data("file");e&&n.push(e)})),u.data("val",n),b=n,g=!0,i||(l(u,{}),e.close())};c=[{label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:_},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){l(u,{}),e.close()}}];let y=App.translate("Files form <b>%s</b>",this.title)+this.pcTable._getRowTitleByMainField(n," (%s)"),x="ctrlS.textdialog",k=function(a){if(h.pcTable.isMobile)p=App.mobilePanel(y,m,{buttons:c,onhide:function(e){t("body").off(x),g||s(a,e)},onshown:function(e){v(),t("body").on(x,(function(t){_(e)}))}});else{let i=!1;setTimeout(()=>{let n=a.closest("td").find(".cdiv");n.length>0&&(c=[],n.data("bs.popover").options.content.find(".btn").each((function(){let e=t(this),a={};a.label=e.data("name"),a.cssClass=e.attr("class").replace("btn-sm","btn-m"),a.icon=e.find("i").attr("class"),a.save=e.data("save"),a.click=e.data("click"),a.action=function(e){a.save&&_(e,0,!0),a.click({}),i=!0,e.close()},c.push(a)})),n.popover("destroy")),p=e.top.BootstrapDialog.show({message:m,type:null,cssClass:"fieldparams-edit-panel",title:y,draggable:!0,buttons:c,onhide:function(e){t("body").off(x),g||s(a,e)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:600}),v(),e.$modalContent.find(".addFilesButton").focus(),t("body").on(x,(function(t){_(e)}))}}),a.data("Dialog",p)})}};if(d)"editField"===d?v():(k(u),u.text(App.translate("Editing in the form")).addClass("edit-in-form"),setTimeout(()=>{u.closest("td").addClass("editing-in-modal")}));else{u.on("click keydown","button",(function(e){-1===["Tab","Esc"].indexOf(e.key)?k(t(this).closest("div")):"Tab"===e.key&&o(u,e,null,!0)}));let e=t('<button class="btn btn-default btn-sm text-edit-button">').text(App.translate("Edit field"));r&&e.attr("tabindex",r),this.checkWaiting(e),u.append(e)}return u.data("val",b)},getEditPanelText:function(e){return this.getCellTextInPanel(e.v).children()},getCellTextInPanel:function(e){let i=t('<div class="panel-preview"></div>');return e&&e.length&&e.forEach&&e.forEach((function(e){let n;-1!==["png","jpg"].indexOf(e.ext)?(n=t('<img src="/fls/'+e.file+'_thumb.jpg" />'),a(n,e)):n='<img src="/imgs/file_ico.png" />';let l=t('<div><a href="/fls/'+e.file+'" download="'+t("<div>").text(e.name).html()+'"></a></div>');l.prepend(n),l.find("a").append(e.name),i.append(l)})),i},isDataModified:function(e,t){return(-1===[null,""].indexOf(e)||-1===[null,""].indexOf(t))&&(-1!==[null,""].indexOf(e)||-1!==[null,""].indexOf(t)||!Object.equals(t,e))}}}(),o.n=t.extend({},o.default,{name:"n",width:52,title:App.translate("Order"),category:"column",hidden:!0,showInWeb:!0,getCellText:function(e,a,i){let n=i.f||{};if(a.addClass("n"),!i.id||n.block||n.blockorder||this.pcTable.nSortedTreeBlock)return"";let l='<button class="btn btn-xxs btn-default"><i class="fa fa-angle-up"></i></button>',s='<button class="btn btn-xxs btn-default"><i class="fa fa-angle-down"></i></button>',o='<button class="btn btn-xxs btn-default arrow-disabled"><i class="fa fa-angle-up"></i></button>',r='<button class="btn btn-xxs btn-default arrow-disabled"><i class="fa fa-angle-down"></i></button>',d=l+s;if(this.pcTable.isTreeView){if(d="",i.__tree){if("self"===this.pcTable.fields.tree.treeViewType&&(void 0===this.pcTable.nSortedTree||this.pcTable.nSortedTree===i.tree.v)){let e;if(this.pcTable.dataSorted.some((t,a)=>t.toString()===i.id.toString()||"object"==typeof t&&"v"in t&&t.v.toString()===i.id.toString()?(e=a,!0):void 0),d="",null!==typeof e){let t,a;e>0&&(t="object"==typeof this.pcTable.dataSorted[e-1]?this.pcTable.dataSorted[e-1].row:this.pcTable.data[this.pcTable.dataSorted[e-1]]),t&&t.tree.v===i.tree.v?d+=l:d+=o,e<=this.pcTable.dataSorted.length&&(a="object"==typeof this.pcTable.dataSorted[e+1]?this.pcTable.dataSorted[e+1].row:this.pcTable.data[this.pcTable.dataSorted[e+1]]),a&&a.tree.v===i.tree.v?d+=s:d+=r}}}else if(void 0===this.pcTable.nSortedTree||this.pcTable.nSortedTree===i.tree.v){let e=this.pcTable.dataSorted.indexOf(i.id+"");d="",e>=1&&"object"!=typeof this.pcTable.dataSorted[e-1]?d+=l:d+=o,e<this.pcTable.dataSorted.length-1&&"object"!=typeof this.pcTable.dataSorted[e+1]?d+=s:d+=r}else d="";d===o+r&&(d="")}return t('<span class="btns"></span>').html(d)}}),o.listRow=t.extend({},o.default,{icon:"fa-code",isPanelField:!0,isPanelTextAsTable:function(e){return"object"==typeof e&&null!==e&&e.settings&&e.data&&e.settings.columns&&e.settings.columns.length},getPanelTextAsTable:function(e){if(this.isPanelTextAsTable(e)){const a=t('<table class="json-table">');let i=e.settings,n=i.columns;try{if(i.headRow){const e=t("<tr>").appendTo(a);"boolean"==typeof i.headRow?n.forEach((function(a){t("<td>").text(a).appendTo(e).addClass("head")})):n.forEach((function(a){t("<td>").text(i.headRow[a]).appendTo(e).addClass("head")}))}return e.data.forEach((function(e){const l=t("<tr>").appendTo(a);n.forEach((function(a){let i=e[a];if("string"!=typeof i||""===i)switch(i=JSON.stringify(i),i){case"true":i="";break;case"false":i="-"}t("<td>").text(i).appendTo(l)})),i.headColumn&&l.find("td:first").addClass("head")})),a}catch(e){console.log(e)}}},getPanelText:function(e,a,i,n){let l=t.Deferred(),s=this,o=t.extend({},i.f||{},i[s.name].f);const r=function(e){let a=s.getPanelTextAsTable.call(s,e);if(a){let t=JSON.stringify(e);return o.textasvalue&&(t=o.text),setTimeout(()=>{n.find(".creator-select-val").text(t)}),a.copyText=t,void l.resolve(a)}l.resolve(t("<div>").text(JSON.stringify(e,null,2)))};return"string"!=typeof e?r(e):this.getValue(e,i,!0).then((function(e){r(e.value)})).fail((function(){l.reject()})),l.promise()},getValue:function(e,a,i){"use strict";let n=t.Deferred();if(!i||"editField"===i||"filter"===this.category||"object"==typeof e||!e)return n.resolve({value:e}),n;{let e={fieldName:this.name};a.id&&(e.rowId=a.id),this.pcTable.model.getValue(e,this.table_id).then((function(e){n.resolve(e)}))}return n},getEditElement:function(a,i,n,l,s,o,r,d){let c,p,h=this,f=t("<div>"),u=t("<div>"),m=t('<div class="HTMLEditor">');i=i.v||"";let b=function(){h.getValue(i,n,d).then((function(a){let i;f.append(m),m.empty().appendTo("editField"===d?f:u),i=new JSONEditor(m.get(0),{}),f.data("editor",i);try{""!==a.value&&i.setText(JSON.stringify(a.value))}catch(t){e.top.App.modal(App.translate("JSON format error"))}e.top.innerHeight>460&&(u.css("min-height",200),m.css("min-height",200));let n=t('<a href="#" style="padding-top: 8px; display: inline-block; padding-left: 20px;">'+App.translate("Manually")+"</a>").on("click",(function(){return App.ManuallyJsonChanging(App.translate("Manually changing the json field"),i.get(),(function(t){try{return i.setText(t),!0}catch(t){e.top.App.modal(App.translate("JSON format error"))}})),!1}));m.find(".jsoneditor-menu").append(n),m.data("editor",i)}))};const g=function(e,t,a){f.data("val",m.data("editor").get()),a||(l(f,{}),e.close())};p=[];let w={label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:g},v={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){s(f,{}),e.close()}},_=()=>App.translate("Field <b>%s</b> text",this.title)+this.pcTable._getRowTitleByMainField(n," (%s)"),y="ctrlS.textedit";if(d)if("editField"===d)setTimeout(b,1);else{let a=!1;setTimeout((function(){let i=f.closest("td").find(".cdiv");i.length>0?(i.data("bs.popover").options.content.find(".btn").each((function(){let e=t(this),i={};i.label=e.data("name"),i.cssClass=e.attr("class").replace("btn-sm","btn-m"),i.icon=e.find("i").attr("class"),i.save=e.data("save"),i.click=e.data("click"),i.action=function(e){i.save&&g(e,0,!0),i.click({}),a=!0,e.close()},p.push(i)})),i.popover("destroy")):(p.push(w),p.push(v)),h.pcTable.isMobile?App.mobilePanel(_(),u,{buttons:p,onhide:function(e){t("body").off(y),a||o(f,{})},onshown:function(e){b()},onshow:function(e){t("body").on(y,(function(t){g(e)}))}}):c=e.top.BootstrapDialog.show({message:u,type:null,title:_(),cssClass:"fieldparams-edit-panel",draggable:!0,buttons:p,onhide:function(e){t("body").off(y),a||o(f,{})},onshown:function(a){a.$modalContent.position({of:t(e.top.document.body),my:"top+50px",at:"top"}),b()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:900,maxWidth:"99vw"}),t("body").on(y,(function(t){g(e)}))}}),f.data("Dialog",c)}),1),f.text(App.translate("Editing in the form")).addClass("edit-in-form"),setTimeout(()=>{f.closest("td").addClass("editing-in-modal")})}else{let a=!1;f.on("click keydown",(function(i){if(a)return!1;if("Tab"===i.key)return void o(u,i,null,!0);a=!0;let n=p.splice();n.push(w),n.push(v);var l=t(this).closest("div");h.pcTable.isMobile?App.mobilePanel(_(),u,{buttons:n,onhide:function(e){a=!1,t("body").off(y),s(l,e)},onshown:function(e){b(),t("body").on(y,(function(t){g(e)}))}}):e.top.BootstrapDialog.show({message:u,type:null,cssClass:"fieldparams-edit-panel",title:_(),draggable:!0,buttons:n,onhide:function(i){a=!1,t(e.top.document.body).off(y),s(l,i)},onshown:function(a){a.$modalHeader.css("cursor","pointer"),b(),a.$modalContent.css({width:900,maxWidth:"99vw"}),t(e.top.document.body).on(y,(function(e){g(a)}))}})}));let i=t('<button class="btn btn-default btn-sm text-edit-button">').text(App.translate("Edit list/json"));r&&i.attr("tabindex",r),f.append(i),this.checkWaiting(i)}return f.data("val",i)},isDataModified:function(e,t){return""===e&&(e=null),""===t&&(t=null),t!==e&&!Object.equals(e,t)},getEditVal:function(e){return e.data("val")},getCellText:function(e){return"string"!=typeof e?JSON.stringify(e):e},getHighCelltext(e,t,a){return this.getCellText(e)},getEditPanelText(e){return this.getCellText(e.v)}}),o.password={icon:"fa-lock",getEditVal:function(e){return e.val().trim()},getCellText:function(e){return"**PASSWORD**"},getEditElement:function(e,a,i,n,l,s,o){var r=t('<input type="password" name="cell_edit" class="form-control"  autocomplete="new-password" autocorrect="off" placeholder="'+App.translate(a&&a.v?"Change the password":"New password")+'"/>');this.checkWaiting(r),r.on("save-me",(function(e){n(t(this),e)})),o&&r.attr("tabindex",o);var d=this;a=a.v,r.on("keydown",(function(e){switch(e.keyCode){case 13:case 9:try{return r.data("enterClicked",!0),n(t(this),e),!1}catch(e){r.data("enterClicked",!1),App.popNotify(e,r,"default"),d.focusElement(r)}break;case 27:return l(t(this),e),!1}}));return r.on("blur",(function(e){!function(e){s(r,e)}(e)})),r.select()}},o.select={icon:"fa-th-list",getEditVal:function(e){if(e.data("input")){var t=e.data("input").selectpicker("val");return null===t&&this.multiple&&(t=[]),t}},loadPreviewPanel(a,i,n,l){let s=t.Deferred();return a.html('<div class="center"><i class="fa fa-spinner fa-spin"></i></div>'),this.pcTable.model.loadPreviewHtml(i,n,l).then((function(i){if(a){let n=t("<div>");i.previews.forEach((function(a){let i=t('<div class="preview">');switch(a[2]){case"file":e.imgRand=e.imgRand||Math.random(),Array.isArray(a[1])&&a[1].forEach((function(a){-1!==["jpg","png"].indexOf(a.ext)&&i.append(t('<a href="/fls/'+a.file+'" target="_blank">').html('<img src="/fls/'+a.file+"_thumb.jpg?rand="+e.imgRand+'"/><br/>')),i.append(t('<div class="file-label">').html(t('<a href="/fls/'+a.file+'" target="_blank">').text(a.name+" "+Math.round(a.size/1024).toLocaleString(App.langLocale)+" Kb")))}));break;case"html":i.text(a[0]);break;case"text":i.text(App.textWithLinks(a[1]));break;case"currency":case"number":if("currency"===a[2]||a[3].currency)try{i.text(App.numberFormat(a[1],a[3].dectimalPlaces,a[3].dectimalSeparator,a[3].thousandthSeparator,a[3].prefix,a[3].postfix))}catch(e){i.text(a[1])}else i.text(a[1]);a[3].unitType&&(a[3].before?i.prepend(a[3].unitType+" "):i.append(" "+a[3].unitType));break;case"url":i=t("<div>").append(t('<a target="_blank">').text(a[1]).attr("href",a[1]));break;default:i=t("<div>").text(a[1])}n.append(t('<div class="title">').text(a[0])),n.append(i)})),0===i.previews.length&&n.text(App.translate("Element preview is empty")),a.empty().append(n)}s.resolve()})).fail((function(){s.reject()})),s},previewPanel:function(e,a){let i=t('<div id="selectPanel" class="text preview" style="white-space: pre-wrap; height: 200px;">'),n={};n="column"===this.category?e.data("id")?this.pcTable._getItemById(e.data("id")):this.pcTable._insertItem:this.pcTable.data_params,a.popover({html:!0,content:i,trigger:"manual",container:"body",placement:"auto right",animation:!1}).popover("show");let l=t("#"+a.attr("aria-describedby")).css("z-index",1e4);const s=function(){a.attr("aria-describedby")&&l.length&&(a.off(".preview"),l.off(".preview"),l.remove())};a.on("mouseout.preview",(function(){setTimeout((function(){l&&!l.is(":hover")&&s()}),300)})),l.on("mouseout.preview",(function(){l.is(":hover")||!a||a.is(":hover")||s()})),a.one("remove destroy",(function(){a.attr("aria-describedby")&&a.popover("destroy")})),this.loadPreviewPanel(i,e.data("field"),n,e.data("val")).then((function(){const e=function(){a&&!a.height()?s():setTimeout(e,500)};e()}))},getEditElement:function(a,i,n,l,s,o,r,d,c){"use strict";i||(i={}),i=t.extend(!0,{},i);let p,h,f,u=this,m=i.v||null;if(u.multiple&&"string"==typeof m)try{m=JSON.parse(m)}catch(e){m=[]}a&&a.data("input")?(h=a,p=h.data("input"),p.data("is-rendered",!0),f=p.data("LISTs")):(h=t("<div>"),f={isListForLoad:!0,innerList:[],innerIndexed:[],isSliced:!0,isPreview:!1},u.list&&(f=u.list));let b=[];h.on("remove",()=>{b.forEach(e=>{e.jqXHR&&e.jqXHR.abort?e.jqXHR.abort():e.aborted=!0})});let g=function(e){let a=t.Deferred(),i={};Object.keys(n).forEach((function(e){"column"===u.category||"filter"===u.category?Object.keys(n).forEach(e=>{("filter"!==u.category||u.pcTable.fields[e]&&"filter"===u.pcTable.fields[e].category)&&(/^\$/.test(e)||("id"===e?i[e]=n[e]:u.hash||(e===u.name?i[e]=m:null!==n[e]&&"object"==typeof n[e]&&-1!==Object.keys(n[e]).indexOf("v")?i[e]=n[e].v:i[e]=n[e])))}):i[u.name]=m})),h.isAttached()&&h.append('<i class="fa fa-cog fa-spin fa-3x loading" style="position: absolute; z-index: 1    right: 1px;    top: 1px;    font-size: 8px;"/>');let l,s={};return b.push(s),u.getEditSelect?l=u.getEditSelect(i,u.name,e,null,null,s):u.loadedSelect?(l=t.Deferred(),l.resolve({...u.loadedSelect}),delete u.loadedSelect):l=u.pcTable.model.getEditSelect(i,u.name,e,null,null,s,u.hash),l.then((function(t){h.find(".loading").remove(),f.innerList=t.list?t.list:[],f.innerIndexed=t.indexed?t.indexed:{},f.isSliced=t.sliced,f.isPreview=t.previewdata,u.codeSelectIndividual||null!==e&&""!==e&&void 0!==e||f.isSliced||(u.list=f,f.isListForLoad=!1),a.resolve()})).fail((function(){a.reject()})),a.promise()};setTimeout((function(){h.length&&h.isAttached()&&h.find(".mark-loading").length&&h.find(".mark-loading").html('<i class="fa fa-spinner"></i>')}),200);let w=0;const v=function(){n[u.name]&&n[u.name].replaceViewValue&&f.innerIndexed[n[u.name].v]&&(n[u.name].replaceViewValue(f.innerIndexed[n[u.name].v]),delete n[u.name].replaceViewValue);let t=h.closest("body");if(t&&t.length){let i=t.get(0).ownerDocument==document?e.$:e.top.$;const b=function(e,t){let a={[App.translate("Selected")]:i('<optgroup label="'+App.translate("Selected")+'">'),"":i('<optgroup label="">')},l=a[App.translate("Selected")];const s=function(e,t,a,l){l=l?i('<small class="text-muted">').text(l):"";let s=i("<option>").attr("value",e),o=i("<div>").text(null===t||""===t?"["+e+"]":t);if(l&&o.append(l),o=o.html(),a)s.attr("data-content",'<span class="text" style="text-decoration: line-through">'+o+"</span>");else{let t=i('<span class="text" >'+o+"</span>");f.isPreview&&(t.addClass("select-with-preview"),t.attr("data-id",n.id),App.selectFieldPreview=u,t.attr("data-field",u.name),t.attr("data-val",e)),s.data("content",t.get(0).outerHTML)}return s};let o,r=App.lang.filtersExtenders(t),d={};if(e||"filter"===u.category){const t=function(e){null===e&&(e="");let t,a=f.innerIndexed[e];return t=a?a[3]?s(e,a[0],!0,null):s(e,a[0],!1,a[1]):s(e,e,!0,null),l.append(t),d[e]=1,!!a&&(r(a[0])||t.addClass("hidden"),!0)};u.multiple?Array.isArray(e)?(e.forEach(t),o=Object.keys(d)):void 0!==e&&(t(e),o=[e]):(t(e),o=e)}if("onlyVals"!==t){u.multiple||u.withEmptyVal&&""!==u.withEmptyVal.trim()&&"filter"!==u.category&&a[""].append(i("<option>").data("content",u.withEmptyVal).text(""));for(let e in f.innerList){let t=f.innerList[e],n=f.innerIndexed[t];if(1===d[t]||n[3])continue;if(!f.isSliced&&!r(n[0]))continue;let l=s(t,n[0]),o=n[1]?n[1]:"";a[o]||(a[o]=i('<optgroup label="'+o+'">')),a[o].append(l)}}if(p.empty(),Object.keys(a).forEach((function(e){p.append(a[e])})),!0===f.isSliced){let e=s(0,App.translate("The data is incomplete. Use the search!"));e.prop("disabled",!0),e.css("text-align","center"),p.append(e)}return u.checkWaiting(p),p.selectpicker("refresh"),p.selectpicker("val",o),o};if(!a||!a.data("input")){let e=!1;const t=function(){let t="";return"filter"===u.category?(t=App.translate("Empty"),u.selectFilterWithEmptyText&&(t=u.selectFilterWithEmptyText)):u.withEmptyVal&&""!==u.withEmptyVal.trim()?t=u.withEmptyVal:u.multiple&&c&&c.closest(".InsertPanel").length&&(t=App.translate("Select"),e=!0),t};p=i('<select class="form-control" '+(1==u.multiple?"multiple ":"")+' data-size="auto" style="display: none;" name="cell_insert" data-style="btn-sm btn-default" data-width="css-width" data-live-search="true" data-title="'+t()+'">').width(u.width),e&&p.attr("data-selected-text-format","static"),h.append(p),h.append('<div class="text-center mark-loading"></div>'),r&&p.attr("tabindex",r),p.data("AppUin",App.getUn()),h.data("input",p),p.data("LISTs",f)}h.find(".mark-loading").remove();let w=0===p.closest(".modal-body").length?u.pcTable._container:p.closest(".modal-body");if(p.data("container",w),b(m),!p.data("is-rendered")){let t;p.data("selectpicker").$searchbox.off().on("click.dropdown.data-api focus.dropdown.data-api touchend.dropdown.data-api",(function(e){e.stopPropagation()}));let a="";p.data("selectpicker").$searchbox.on("keyup",(function(e){if("Escape"===e.key)return p.data("selectpicker").$button.click(),!0;let n=i(this).val();a!==n&&(a=n,t&&clearTimeout(t),t=setTimeout((function(){f.isListForLoad||f.isSliced?g.call(u,n).then((function(){b.call(u,m,n)})):b.call(u,m,n)}),750))}));let n=i(u).closest("td, .cell");if(0===p.closest(".InsertRow, .InsertPanel").length){let e=p.data("container");p.on("remove",(function(){e.off("click.selectContainer."+p.data("AppUin")),e.off("keydown.selectContainer."+p.data("AppUin"))})),e.on("click.selectContainer."+p.data("AppUin"),(function(e){let t=i(e.target);t.closest("td").is(".editing")||t.closest(".bootstrap-select").length||o(h,e)})),e.on("keydown.selectContainer."+p.data("AppUin"),(function(e){if("Tab"===e.key)return l(h,e),!1;if(27===e.keyCode)return p.data("keyPressed","Esc"),s(h,e),!1;if(13===e.keyCode&&p.data("enterPressed",!0),9!==e.keyCode&&16!==e.keyCode&&n.data("edited"),e.altKey||e.shiftKey){let t=e.altKey?"altKey":!!e.shiftKey&&"shiftKey";p.data("keyPressed",t)}})).on("keyup",(function(e){p.removeData("keyPressed"),p.removeData("enterPressed")})),setTimeout((function(){if(p.data("selectpicker").$bsContainer.offset().top>h.find("button").offset().top){let e=p.closest("td").find(".cdiv").css("top",0).css("bottom","").data("bs.popover");e&&(e.applyPlacement(e.getCalculatedOffset("top",e.getPosition(),e.$tip.width()+8,e.$tip.height()),"top"),e.$tip.removeClass("bottom").addClass("top"))}}),10)}else if(1===p.closest(".InsertRow").length){p.data("container").on("keydown.selectContainer."+p.data("AppUin"),(function(e){if("Tab"===e.key)return(p.data("selectpicker").$searchbox.get(0).contains(e.originalEvent.target)||p.data("selectpicker").$newElement.get(0).contains(e.originalEvent.target)||p.data("selectpicker").$menu.get(0).contains(e.originalEvent.target))&&(p.data("selectpicker").$menu.is(".open")&&p.data("selectpicker").$button.trigger("click",{doIt:!0}),l(h,e)),!1})),p.data("selectpicker").$newElement.on("keydown",e=>{"Tab"===e.code&&(l(h,event),e.stopPropagation())})}p.on("hidden.bs.select",(function(e){let t=p.data("changed"),a=p.data("keyPressed");a&&(e[a]=!0),t&&(e={type:"changed"}),u.multiple?t&&0===p.closest("td.edt").length&&l(h,e):setTimeout((function(){l(h,e)}),200),p.data("changed",!1)})),p.on("shown.bs.select",(function(){let t=p.data("selectpicker");t.$bsContainer.addClass("pcTable-selectpicker"),f.isPreview&&t.$bsContainer.addClass("select-with-preview");let a=t.$menu.get(0).getBoundingClientRect();if(a.right>e.innerWidth-20){let i=a.right-e.innerWidth+20,n=t.$menuInner.width()-i;t.$menuInner.width(n).css("overflow-x","auto"),setTimeout(()=>{t.$bsContainer.width(n)})}else t.$menuInner.width("auto");(p.closest(".InsertPanel").length||p.closest(".InsertRow").length)&&setTimeout(()=>{p.data("selectpicker").$searchbox.focus()},50)})),p.on("changed.bs.select",(function(){p.data("changed",!0);let e=[];if(m&&m.forEach&&m.forEach((function(t){e.push(t)})),m=p.val(),"filter"===u.category&&u.multiple){let t=m.length;if(e.length>m.length)0===m.length&&m.push("*ALL*");else{let t;m.some((function(a){if(-1===e.indexOf(a))return t=a,!0})),-1!==["*NONE*","*ALL*"].indexOf(t)?m=[t]:["*NONE*","*ALL*"].some((function(e){let t;if(-1!==(t=m.indexOf(e)))return m.splice(t,1),!0}))}m.length!==t&&p.selectpicker("val",m)}})),p.on("remove",(function(){p.data("selectpicker").$bsContainer.remove(),p.data("container").off(".selectContainer."+p.data("AppUin"))})),0!==p.closest(".InsertRow, .InsertPanel").length||p.closest(".linkButtons").length&&m||"editField2"===d||h.find("button").click()}}else w<50&&(setTimeout((function(){v(p,m)}),10*w+1),w++)};return!f||f.isListForLoad?g().then((function(){v.call(u)})):v(),h},getEditPanelText:function(e,t){if(this.multiple)return this.getPanelText(e.v,null,t)},getPanelText:function(e,a,i){let n=this,l=t("<div>"),s=i[n.name].v_;if(!n.multiple&&i[n.name].v_&&(s=[i[n.name].v_]),s)t.each(s,(function(e,a){"use strict";let o=t('<div class="select-val">').text((n.multiple&&n.unitType&&n.before?n.unitType+" ":"")+a[0]+(n.multiple&&n.unitType&&!n.before?" "+n.unitType:""));if(a[1]?o.addClass("deleted_value"):1!==s.length&&o.add("select-item"),n.withPreview&&1!==s.length){let a=t('<button class="btn btn-xxs btn-default "><i class="fa fa-eye"></i></button>').on("click",()=>{if(a.data("opened"))a.data("pr").hide(),a.data("opened",!1);else{if(a.data("pr"))a.data("pr").show();else{let l=t('<div class="loaded-preview">').appendTo(o);n.loadPreviewPanel(l,n.name,i,[i[n.name].v[e]]).then((function(){})),a.data("pr",l)}a.data("opened",!0)}});o.prepend(a)}l.append(o)}));else{if(null===e||""===e)return n.withEmptyVal?n.withEmptyVal:"";let a=e;if(n.multiple||(a=[a]),a||(a=[]),n.list){let e=[];for(let t=0;t<a.length;t++)e[t]=a[t].toString();for(let a=0;a<n.list.length;a++){let i=n.list[a];if(-1!==e.indexOf(i[2].toString())){let a=t("<span>").text(i[0]);i[1]?a.addClass("deleted_value"):1!==e.length&&a.add("select-item"),l.append(a)}}}}return l.children()},getCellTextInPanel:function(e,t,a){let i=this.multySelectView;delete this.multySelectView;let n=this.getCellText(e,t,a);return void 0!==i&&(this.multySelectView=i),n},getCellText:function(e,a,i){let n=this,l=t("<div>"),s=i[n.name].v_;if(!n.multiple&&i[n.name].v_&&(s=[i[n.name].v_]),s)n.multiple&&s.length>1&&0==n.multySelectView?l.append('<span class="select-item">'+App.translate("%s elements",s.length)+"<span>"):0===s.length?l.append('<span class="select-item">'+this.getElementString(null)+"</span>"):t.each(s,(function(i,o){"use strict";let r=t("<span>"),d=null;e&&(d="object"==typeof e?e[i]:e),r.text(n.getElementString(d,o)),o[1]?r.addClass("deleted_value"):1!==s.length&&r.add("select-item"),a&&a.is("td")&&n.multiSeparator&&i>0&&l.append(t('<span class="separator">').text(n.multiSeparator)),l.append(r)}));else{if(null===e||""===e)return n.withEmptyVal?n.withEmptyVal:"";let a=e;if(n.multiple||(a=[a]),a||(a=[]),n.list){let e=[];for(let t=0;t<a.length;t++)e[t]=a[t].toString();for(let a=0;a<n.list.length;a++){let i=n.list[a];if(-1!==e.indexOf(i[2].toString())){let a=t("<span>").text(n.getElementString(i[2],i));i[1]?a.addClass("deleted_value"):1!==e.length&&a.add("select-item"),l.append(a)}}}}return l.children()},focusElement:function(e){let t=e.find("button"),a=this;0==t.length?setTimeout((function(){a.focusElement(e)}),50):e.closest("tr").is(".InsertRow")&&"true"!==t.attr("aria-expanded")&&t.trigger("click",{doIt:!0})},isDataModified:function(e,t){return(-1===[null,""].indexOf(e)||-1===[null,""].indexOf(t))&&(-1!==[null,""].indexOf(e)||-1!==[null,""].indexOf(t)||!Object.equals(t,e))},checkEditRegExp:function(e){if(!this.warningEditRegExp)return!0;try{return this.multiple&&Array.isArray(e)?e.some(t=>new RegExp(this.warningEditRegExp).test(e)):new RegExp(this.warningEditRegExp).test(e)}catch(e){return!0}},addDataToFilter:function(e,t){const a=function(t){let a,i=t[0],n=App.translate("Empty");null===i||""===i?a="".hashCode():(a=i.toString().hashCode(),n=i.replace(/"/g,"&quot;")),e[a]=n};this.multiple?t&&t.v_.length?t.v_.forEach((function(e){a(e)})):a({0:""}):a(t.v_)},getElementString:function(e,t){"use strict";let a,i;return null==e?t&&t[0]||(a=this.withEmptyVal||""):i=!0,void 0!==a||null!==t[0]&&""!==t[0]||(a="["+(this.withEmptyVal||"")+"]"),void 0===a&&(a=t[0]),i&&this.multiple&&this.unitType&&(this.before?a=this.unitType+" "+a:a+=" "+this.unitType),a},sourceButtonClick:function(a,i){let n=t.Deferred(),l={},s=this,o=this.pcTable;t.each(a,(function(e,t){"$"!==e.substring(0,1)&&(l[e]=t)})),i&&(l[s.name]=null);let r,d=0,c=e.top.App.randomIds.get();return e.top.jQuery("body").on("pctable-closed.select-"+s.name,(function(e,a){if(!a.panel||a.panel.srcRandomId!==c)return;d--,a&&a.json&&(r=a);let i=a&&"insert"===a.method&&a.json&&a.json.chdata&&a.json.chdata.rows;setTimeout((function(){(0===d||i)&&(t("body").off(".select-"+s.name),n.resolve(r))}),100)})),o.model.selectSourceTableAction(s.name,l,i).then(()=>{let t;e.top.jQuery("body").on("pctable-opened.select-add-"+c,(function(a,i){i.panel.srcRandomId=c,d++,t&&clearTimeout(t),t=setTimeout(()=>{e.top.jQuery("body").off("pctable-opened.select-add-"+c),e.top.App.randomIds.delete(c)},200)}))}),n},checkWaiting:function(e){if(this.waiting){if(e.data("selectpicker")||e.selectpicker(),e.data("selectpicker").waiter)return;let a=this;e.data("selectpicker").waiter=!0;const i=function(t,i){if(i&&i.doIt)return!0;let n=!1;t._id||(t._id=Math.random());const l=()=>{a.waiting[0]?(n||(n=!0,App.fullScreenProcesses.show()),setTimeout(l,200)):(n&&App.fullScreenProcesses.hide(),t.originalEvent?(t.originalEvent.done=!0,e.data("selectpicker").$button.get(0).dispatchEvent(t.originalEvent)):e.data("selectpicker").$button.trigger(t.type,{done:!0}))};return!!(t.originalEvent&&t.originalEvent.done||i&&i.done)||(setTimeout(l,20),t.stopImmediatePropagation(),!1)};["click","keyup","focus"].forEach(a=>{e.data("selectpicker").$button.on(a,i);let n,l=t._data(e.data("selectpicker").$button.get(0),"events");l&&(n=l[a])&&n.unshift(n.pop())})}}},function(){t.jstree;o.tree={icon:"fa-tree",FullView:!1,getEditVal:function(e){return e.data("val")},getCheckedIds:function(e){let t=[];return e.data("jstree").jstree("get_selected",!0).forEach((function(e){t.push(e.id)})),this.multiple||(t=t[0]||""),t},getEditElement:function(a,i,n,l,s,o,r,d){let c,p,h,f=this,u=a||t("<div>"),m=u.data("dialog")||t("<div>").css("min-height",200);u.data("dialog",m),i=i.v||"";const b=function(e,t,a){u.data("val",f.getCheckedIds(m)),a||(l(u,{}),e.close())};let g=function(e){f.treePanel.call(f,"editField"===d?u:m,n,i)};c=[];let w={label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:b},v={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){s(u,{}),e.close()}},_="<b>"+(this.title||"")+"</b>"+this.pcTable._getRowTitleByMainField(n," (%s)"),y="ctrlS.commentdialog";const x=function(e){f.pcTable.isMobile||(e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:.8*t("body").width()>800?800:.8*t("body").width()})),0===e.$modalBody.find("textarea").length&&g(),e.$modalContent.closest("body").on(y,(function(t){b(e,0,!1)}))};if(d)if("editField"===d)g();else{let a=!1;setTimeout((function(){let i=u.closest("td").find(".cdiv");i.length>0?(i.data("bs.popover").options.content.find(".btn").each((function(){p=t(this);let e={};e.label=p.data("name"),e.cssClass=p.attr("class").replace("btn-sm","btn-m"),e.icon=p.find("i").attr("class"),e.save=p.data("save"),e.click=p.data("click"),e.action=function(t){e.save&&b(t,0,!0),e.click({}),a=!0,t.close()},c.push(e)})),i.popover("destroy")):(c.push(w),c.push(v)),f.pcTable.isMobile?App.mobilePanel(_,m,{buttons:c,onhide:function(e){t("body").off(y),a||o(u,{})},onshow:x}):(h=e.top.BootstrapDialog.show({message:m,type:null,title:_,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:c,onhide:function(i){t(e.top.document).find("body").off(y),a||o(u,{})},onshown:function(a){a.$modalContent.position({of:t(e.top.document).find("body"),my:"top+50px",at:"top"})},onshow:x}),u.data("Dialog",h))}),1),u.text(App.translate("Editing in the form")).addClass("edit-in-form"),setTimeout(()=>{u.closest("td").addClass("editing-in-modal")})}else{let a=!1;u.off().on("click keydown",(function(i){if(a)return!1;if("Tab"===i.key)return void o(m,i,null,!0);a=!0;let n=c.slice(0);n.push(w),n.push(v);var l=t(this).closest("div");f.pcTable.isMobile?App.mobilePanel(_,m,{buttons:n,onhide:function(e){a=!1,t("body").off(y),s(l,e)},onshow:x}):e.top.BootstrapDialog.show({message:m,type:null,cssClass:"fieldparams-edit-panel",title:_,draggable:!0,size:BootstrapDialog.SIZE_WIDE,buttons:n,onhide:function(i){a=!1,t(e.top.document).find("body").off(y),s(l,i)},onshow:x})})),0===u.find("button").length&&(p=t('<button class="btn btn-default btn-sm text-edit-button">').text(App.translate("Editing in the form")),r&&p.attr("tabindex",r),u.append(p),this.checkWaiting(p))}return u.data("val",i)},treePanel:function(e,a){let i=this,n=t.extend(!0,{},a),l=["themes","json_data","search"];i.multiple&&l.push("checkbox");let s=t('<div class="tree-search"><input class="form-control" type="text"></div>'),o=s.find("input");setTimeout(()=>{o.focus()},200);let r=t("<div></div>"),d=0,c=!1,p="";if(o.keyup((function(){c&&clearTimeout(c),c=setTimeout((function(){if(r.closest("body").length){let e=o.val();p!==e&&(p=e,r.jstree(!0).search(e,0===d))}}),750)})),e.html(s).append(r),e.data("jstree",r),!this.multiple&&this.withEmptyVal){let e=n[i.name].v;r.on("select_node.jstree",(function(t,a){e===a.node.id?a.instance.deselect_node(a.instance.get_node(a.node.id)):e=a.node.id}))}let h=null;r.on("init.jstree",(function(e,a){a.instance.settings.checkbox.cascade="";let l=r.jstree(!0).redraw_node;if(i.changeSelectTable||i.multiple){let e=r.jstree(!0);const a=(t,i)=>{let n=e.get_node(t);i>0?(e.select_node(n),2===i&&(!1===n.state.loaded?e.load_node(n,e=>{e.children.forEach(e=>{a(e,i)})}):n.children.forEach(e=>{a(e,i)}))):(e.deselect_node(n),!1===n.state.loaded?e.load_node(n,e=>{e.children.forEach(e=>{a(e,i)})}):n.children.forEach(e=>{a(e,i)}))};r.jstree(!0).redraw_node=function(e,s,o,d){let c,p=l.apply(this,arguments),f=this.get_node(e),u=i.changeSelectTable,m=2===i.changeSelectTable&&i.parentName;i.treeAutoTree||(f.original.id.toString().match(/^\d+$/)?m=!1:u=!1);const b=function(){r.jstree(!0).refresh(!1,!0)};let g=t(p).find(">a i:first");if(i.multiple&&(!1===f.state.loaded||f.children&&f.children.length)&&(c=t('<i class="fa fa-hand-lizard-o jstree-children-manage-lizard"></i>'),g.after(c),g=c.on("click",()=>(f.state.cascadeStep=f.state.cascadeStep>1?0:(f.state.cascadeStep||0)+1,!1===f.state.loaded?this.load_node(f,e=>{e.children.forEach(t=>{a(t,e.state.cascadeStep)})}):f.children.forEach(e=>{a(e,f.state.cascadeStep)}),!1))),u&&(c=t('<i class="fa fa-edit edit-tree-icon"></i>'),g.after(c),c.on("click",()=>(new EditPanel(i.selectTable,null,{id:f.id}).then(()=>{h={},Object.values(r.jstree(!0)._model.data).forEach(e=>{h[e.id]=!!e.state.opened}),b()}),!1)),g=c),m){let e=t('<i class="fa fa-plus edit-tree-icon"></i>');g.after(e),e.on("click",()=>(new EditPanel(i.selectTable,null,{[i.parentName]:{v:f.id.replace("PP/","")}}).then(e=>{if(h={},Object.values(r.jstree(!0)._model.data).forEach(e=>{h[e.id]=!!e.state.opened}),h[f.id]=!0,e.chdata.rows&&Object.keys(e.chdata.rows).length){let t=Object.keys(e.chdata.rows)[0];i.multiply?n[i.name].v.push(t):n[i.name].v=t}b()}),!1))}return p}}else r.jstree(!0).redraw_node=function(e,a,i,n){let s=l.apply(this,arguments),o=this.get_node(e);return o.state&&o.state.deleted&&t(s).addClass("deleted-node"),s}})).jstree({search:{show_only_matches:!0,case_insensitive:!0,show_only_matches_children:!0,search_callback:function(e,t){if(!t)return!1;return App.lang.filtersExtenders(e)(t.text)},ajax:function(e,t){var a=this;i.getEditSelect(n,e,null).then((function(e){t.call(a,e[0])}))}},massload:function(e,t){var a=this;d-=1,i.getEditSelect(n,"",e).then((function(e){Object.values(e[0]).forEach((function(e){e.forEach((function(e){!0===e.children&&(d+=1)}))})),t.call(a,e[0])}))},core:{check_callback:!0,open_parents:!0,data:function(e,t){var a=this;d-=1,i.getEditSelect(n,"","#"==e.id?null:e.id).then((function(e){e[0].forEach((function(e){h&&h[e.id]&&(e.state={opened:!0,...e.state||{}},!0===e.children&&(d+=1))})),t.call(a,e[0])}))},themes:{icons:!1,name:"default"}},plugins:l}),i.multiple&&"filter"===i.category&&r.on("select_node.jstree",(function(e,t){-1!==["*ALL*","*NONE*"].indexOf(t.node.id)?t.selected.length>1&&t.selected.forEach((function(e){e!==t.node.id&&t.instance.deselect_node(r.jstree(!0).get_node(e))})):["*ALL*","*NONE*"].forEach((function(e){-1!==t.selected.indexOf(e)&&t.instance.deselect_node(r.jstree(!0).get_node(e))}))}))},getEditPanelText(e,t){return this.getCellText(e.v,null,t)},getEditSelect:function(e,a,i){let n=this,l=t.Deferred(),s={};return"column"!==n.category&&"filter"!==n.category||Object.keys(e).forEach(t=>{("filter"!==n.category||n.pcTable.fields[t]&&"filter"===n.pcTable.fields[t].category)&&(/^\$/.test(t)||("id"===t?s[t]=e[t]:this.hash||(null!==e[t]&&"object"==typeof e[t]&&-1!==Object.keys(e[t]).indexOf("v")?s[t]=e[t].v:s[t]=e[t])))}),this.pcTable.model.getEditSelect(s,this.name,a,i,!0,null,this.hash).then((function(e){let t=[e.list,e.indexed];n.codeSelectIndividual||(n.list=t),n.parentName=e.parent,l.resolve(t)})),l},getPanelText:function(e,t,a){this.FullView=!0;let i=this.getCellText(e,t,a);return delete this.FullView,i},getCellText:function(e,a,i){let n=this;if("tree"===n.name&&i.__tree&&("self"===n.treeViewType||i.tree_category&&i.tree_category.v)){let e=i.__tree,a=i.tree.f||{},l=a.icon||(e.opened?"folder-open":"folder"),s=t('<i class="fa fa-'+l+'"></i>').data("treeRow",e.v),o=t('<span class="tree-view">').css("padding-left",22*e.level).append(s);return!1!==a.expand?(s.addClass("treeRow"),n.pcTable._treeFolderRowAddDropdown(o,i.__tree)):s.css("margin-right",8),"self"===this.treeViewType&&this.pcTable.isInsertable()&&n.insertable&&o.append(t('<button class="btn btn-default btn-xxs treeRow ins"><i class="fa fa-plus"></i></button>')),o.append(t('<span class="tree-span-text">').text(a.text||e.t)),o}{let l=i[n.name].v_;if(e){if(n.multiple){if(Array.isArray(e)){if(0===e.length)return n.getElementSpan(null);if(1===e.length)return n.getElementSpan(e[0],l[0]);if("0"!==n.multySelectView||n.FullView){let i=t('<span class="select-item">');return e.forEach((e,s)=>{a&&a.is("td")&&n.multiSeparator&&s>0&&i.append(t('<span class="separator">').text(n.multiSeparator)),i.append(n.getElementSpan(e,l[s]))}),i}return t('<span class="select-item">'+App.translate("%s el.",e.length)+"<span>")}return n.getElementSpan(e,[e,0])}return n.getElementSpan(e,l)}return n.getElementString(null)}},checkIsFiltered:function(e,t){let a,i;return this.multiple?(a=[],e&&e.v_&&e.v_.length&&e.v_.forEach((function(e){a.push(e[0].hashCode().toString())})),i=function(e){if(-1!==a.indexOf(e))return!0}):(a=null===e.v_[0]?"null":e.v_[0].toString(),a=a.hashCode().toString(),i=function(e){if(e===a)return!0}),t.some(i)},addDataToFilter:function(e,t){const a=function(t){let a;null===t[0]?(a="null".hashCode(),e[a]=null):(a=t[0].toString().hashCode(),e[a]=t[0].replace(/"/g,"&quot;"))};this.multiple?t&&t.v_.length&&t.v_.forEach((function(e){a(e)})):a(t.v_)},getElementSpan:function(e,a){let i=t("<span>");return null!==e&&(i.text(this.getElementString(e,a)),1===a[1]&&i.addClass("deleted_value")),i},getElementString:function(e,t){"use strict";let a,i;if(null==e){if(!t||!t[0])return this.withEmptyVal||""}else a=!0;return i=null===t[0]||""===t[0]?"["+(this.withEmptyVal||"")+"]":this.FullView&&t[2]||t[0],a&&this.multiple&&this.unitType&&(this.before?i=this.unitType+" "+i:i+=" "+this.unitType),i},sourceButtonClick:function(a,i){let n=t.Deferred(),l={},s=this,o=this.pcTable;t.each(a,(function(e,t){"$"!==e.substring(0,1)&&(l[e]=t)})),i&&(l[s.name]=null);let r,d=0,c=e.top.App.randomIds.get();return t(e.top.document.body).on("pctable-closed.select-"+s.name,(function(e,a){if(!a.panel||a.panel.srcRandomId!==c)return;d--,a&&a.json&&(r=a);let i=a&&"insert"===a.method&&a.json&&a.json.chdata&&a.json.chdata.rows;setTimeout((function(){(0===d||i)&&(t("body").off(".select-"+s.name),n.resolve(r))}),100)})),o.model.selectSourceTableAction(s.name,l,i).then(()=>{let a;t(e.top.document.body).on("pctable-opened.select-add-"+c,(function(i,n){n.panel.srcRandomId=c,d++,a&&clearTimeout(a),a=setTimeout(()=>{t(e.top.document.body).off("pctable-opened.select-add-"+c),e.top.App.randomIds.delete(c)},200)}))}),n}}}(),o.json={__addInput:function(e,a,i){var n=(a=a||{}).type||typeof i[e],l=12;"checkbox"==n&&(l=3),a.width&&(l=a.width);var s,o=t('<div class="field form-group">').attr("data-name",e).addClass("col-sm-"+l);switch(n){case"string":s=t("<input>").val(i[e]?i[e]:a.default?a.default:"");break;case"json":s=t('<div class="JSONEditor">').height(300);var r=new JSONEditor(s.get(0),{}),d=t('<a href="#">editText</a>').on("click",(function(){var e=t("<div>"),a=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(r.get(),null,2)).appendTo(e);return e.dialog({title:App.translate("The JSON field content"),width:500,height:600,buttons:{[App.translate("Save")]:function(){r.setText(a.val()),e.dialog("close")},[App.translate("Close")]:function(){e.dialog("close")}}}),!1}));s.find(".jsoneditor-menu").append(d),s.data("editor",r),r.set(i[e]?i[e]:a.default?JSON.parse(a.default):{});break;case"html":s=t('<div class="HTMLEditor">').height(300);var c=t("<div>").appendTo(s);r=CodeMirror(c.get(0),{value:i[e]?i[e]:a.default?a.default:"",mode:"text/html",height:"250px",readOnly:!1,theme:"eclipse",lineNumbers:!0,gutter:!0,indentWithTabs:!0,autoCloseTags:!0});setTimeout((function(){r.refresh()}),20),s.data("editor",r);break;case"integer":s=t("<input>").val(i[e]?i[e]:a.default?a.default:"").attr("type","number"),void 0!==a.min&&s.attr("min",a.min),void 0!==a.max&&s.attr("max",a.max),void 0!==a.step&&s.attr("step",a.step);break;case"checkbox":s=t("<input>").attr("type","checkbox"),(i[e]||void 0===i[e])&&s.prop("checked",!0);break;case"select":s=t("<select>"),a.values&&t.each(a.values,(function(e,a){s.append(t("<option>").attr("value",e).text(a))})),i[e]?s.val(i[e]):void 0===i[e]&&a.default&&s.val(a.default)}"checkbox"==n?(o.prepend(t("<label>").text(a.title?a.title:e).addClass("form-check-label")),s&&(s.data("type",n),o.find("label").prepend(s))):(o.prepend(t("<label>").text(a.title?a.title:e)),s&&s.data("type",n).addClass("form-control"),o.append(s)),o.data("type",n);var p=t(" <span>*</span>");return a.required?p.addClass("text-danger"):(p.text(""),p.addClass("glyphicon glyphicon-remove remove"),p.on("click",(function(){var e=t(this).closest(".field");e.data("name");e.remove()}))),o.find("label").after(p),o},getEditElement:function(e,a,i,n,l,s){var o,r=this,d=t("<div>"),c=t("<div>").css("min-height",200),p=t('<div class="jsonForm row">').appendTo(c);d.data("form",p),d.data("field",this);var h=this.jsonFields,f=a||{};"string"==typeof f&&(f=JSON.parse(f));var u=function(e){var t=r.__addInput(e,h[e],f);p.append(t)},m=t.extend({},f),b=0,g={"":[]};if(t.each(h,(function(e,t){if(1==t.required||1==t.showInForm)u(e),void 0!==m[e]&&delete m[e];else if(void 0===m[e]){var a="";t.fGroup&&(a=t.fGroup,g[t.fGroup]||(g[t.fGroup]=[])),g[a].push(e),b++}})),t.each(m,(function(e,t){u(e)})),b){var w=t('<div class="row elseFields">');let e=t('<select class="selectpicker form-control dropup" data-size="5" data-title="--'+App.translate("Choose the field")+'--">');1==App.keys(g).length?t.each(g[App.keys(g)[0]],(function(a,i){e.append(t("<option>").attr("value",i).text(h[i].title?h[i].title:i))})):t.each(g,(function(a,i){a=t('<optgroup label="'+a+'">');t.each(i,(function(e,i){a.append(t("<option>").attr("value",i).text(h[i].title?h[i].title:i))})),e.append(a)})),w.prepend(t("<label>").text(App.translate("Add field"))),e.addClass("form-control"),w.append(e),e.selectpicker("render"),e.on("change",(function(){var a=t(this).val();e.find('option[value="'+a+'"]').remove(),u(a)})),c.append(w.wrap('<div style="padding:10px">').parent())}return o={[App.translate("Save")]:function(){var e={},a=p.find(".fullJSONEditor");1==a.length?e=a.data("editor").get():p.find("input, select, textarea, .JSONEditor, .HTMLEditor").not(".JSONEditor *").not(".HTMLEditor *").each((function(){var a=t(this),i=a.closest(".field").data("name");switch(a.closest(".field").data("type")){case"array":try{if(e[i]=a.data("editor").get(),!t.isArray(e[i]))throw App.translate("Field structure error")}catch(e){throw App.notify(App.translate("Field %s structure error",i)),App.translate("Field structure error")}break;case"object":case"json":try{if(e[i]=a.data("editor").get(),"object"!=typeof e[i])throw App.translate("Field structure error")}catch(e){throw App.notify(App.translate("Field %s structure error",i)),App.translate("Field structure error")}break;case"html":e[i]=a.data("editor").getValue();break;case"checkbox":case"boolean":e[i]=!!a.is(":checked");break;case"integer":e[i]=parseInt(a.val());break;default:e[i]=a.val()}})),d.data("val",JSON.stringify(e)),n(d,event),c.remove()},[App.translate("Close")]:function(){c.dialog("close")},[App.translate("Editor")]:function(){var e=p.height(),a=t('<div class="fullJSONEditor">').height(e+100),i=new JSONEditor(a.get(0),{});i.set(f);var n=t('<a href="#">editText</a>').on("click",(function(){var a=t("<div>"),n=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(i.get(),null,2)).appendTo(a);return a.dialog({title:App.translate("The JSON field content"),width:500,height:e+100,buttons:{[App.translate("Save")]:function(){i.setText(n.val()),a.dialog("close")},[App.translate("Close")]:function(){a.dialog("close")}}}),!1}));p.empty().append(a),p.next().empty(),a.data("editor",i),a.find(".jsoneditor-menu").append(n)}},i.id?(c.dialog({title:(i&&i.id?i.id:"")+" "+this.title,width:700,modal:!0,close:function(e){l(d,e),c.remove()},buttons:o}),d.text(App.translate("Editing in the form")).addClass("edit-in-form"),setTimeout(()=>{d.closest("td").addClass("editing-in-modal")})):(d.on("focus click","button",(function(){var e=t(this).closest("div");c.dialog({title:r.title||r.name,width:700,modal:!0,close:function(t){l(e,t),c.remove()},buttons:o})})),d.append(t('<button class="btn btn-default">').text(a||App.translate("Editing")))),d.data("val",a)},getEditVal:function(e){return e.data("val")},getCellText:function(e){return JSON.stringify(e)},focusElement:function(e){var t=e.find("button"),a=this;0===t.length?setTimeout((function(){a.focusElement(e)}),50):t.focus()}},o.fieldParams=t.extend({},o.json,{icon:"fa-code",isPanelField:!0,isDataModified:function(e,t){return!Object.equals(t,e)},getEditVal:function(e){return e.data("checkVal")&&e.data("checkVal")(),e.data("val")},getEditElement:function(a,i,n,l,s,o,r,d,c){let p,h=this,f=t("<div>"),u=t("<div>").css("min-height",200),m=t('<div class="jsonForm">').appendTo(u);a&&(f=a,m=f.find(".jsonForm")),f.data("form",m),f.data("field",this);let b=!1,g=function(){m.trigger("change")};App.tableTypes=App.tableTypes||{};let w=async function(e){if(!App.tableTypes[n.table_id.v]){let e;if(n.table_id.v){if(n.table_id.v!=t("#table").data("pctable").tableRow.id){h.pcTable.model.getTableParam||(h.pcTable.model.getTableParam=function(e,t){return this.__ajax("post",{method:"getTableParam",tableId:e,param:t})}),e=(await h.pcTable.model.getTableParam(n.table_id.v,"type")).type}else e=t("#table").data("pctable").tableRow.type;App.tableTypes[n.table_id.v]=e}}let a,i,l=h.jsonFields;h.getValue(e,n,!d).then((function(e){let s=e.value;"string"==typeof s&&(s=JSON.parse(s));let o=t.extend({},s),r=function(e,r,d){let c=l.fieldSettings[e];if(!c)return!1;if(c.categories&&("codeAction"!==e||"button"!==m.find('div[data-name="type"] select').val())&&-1===c.categories.indexOf(n.category.v))return!1;if(c.names&&-1===c.names.indexOf(n.name.v))return!1;if(c.tables&&-1===c.tables.indexOf(App.tableTypes[n.table_id.v]))return!1;let p={};switch(void 0===o[e]||void 0===o[e].isOn?(p.isOn=void 0!==o[e],p.Val=o[e],void 0===p.Val&&(p.Val=c.default),c.parent||"checkbox"!==c.type||!0!==p.Val||(p.isOn=!0),o[e]=p):p=o[e],e){case"codeSelect":let e="=: selectRowListForTree(table: ''; field: ''; order: '' asc; where:  '' = ; parent: ''; disabled:)";"tree"===m.find('div[data-name="type"] select').val()?p.Val===c.default&&(p.Val=e):p.Val===e&&(p.Val=c.default)}let f=!1,u=(l.fieldSettings[c.parent],o[c.parent]);c.parent&&-1!==r.indexOf(c.parent)&&(u&&!0===u.isOnCheck||(f=!0)),p.changed=function(){"use strict";!0===this.isOnCheck?m.find('[data-parent="'+e.toLowerCase()+'"]').show():m.find('[data-parent="'+e.toLowerCase()+'"]').hide().find('input[type="checkbox"]').prop("checked",!1).trigger("change")};let b=h.__addInput.call(h,e,c,p,n,g,m);if("center"!==(c.align||"center")){if(!a){let e=t('<div class="fParams-grid">');a=t("<div>").appendTo(e),i=t("<div>").appendTo(e),m.append(e)}"left"===c.align?a.append(b):i.append(b)}else m.append(b),a=i=null;c.parent&&(b.attr("data-parent",c.parent.toLowerCase()),f&&b.hide());let w=d[e]();b.css("padding-left",19*w),n.id&&"column"===n.category.v&&-1!==["simple","cycles"].indexOf(App.tableTypes[n.table_id.v])&&("type"===e&&s.type.Val!==m.find('div[data-name="type"] select').val()?b.append('<div class="code-checkboxes-active-warning"><div class="code-checkboxes-warning-panel">'+App.translate("Recalculate all table rows after changing the field type")+"</div></div>"):"multiple"===e?b.find('input[type="checkbox"]').on("change",()=>{s.multiple.Val!==m.find('div[data-name="multiple"] input').is(":checked")?b.append('<div class="code-checkboxes-active-warning"><div class="code-checkboxes-warning-panel">'+App.translate("Recalculate all table rows after changing the field type")+"</div></div>"):b.find(".code-checkboxes-active-warning").remove()}):"dateTime"===e&&b.find('input[type="checkbox"]').on("change",()=>{s.dateTime.Val!==m.find('div[data-name="dateTime"] input').is(":checked")?b.append('<div class="code-checkboxes-active-warning"><div class="code-checkboxes-warning-panel">'+App.translate("Recalculate all table rows after changing the field type")+"</div></div>"):b.find(".code-checkboxes-active-warning").remove()}));let v=["secureFile","versioned","fileIdDivider"];return-1!==v.indexOf(e)&&(s[e]&&s[e].Val?b.find("input").on("click",()=>!1).addClass("disabled"):b.append('<div class="code-checkboxes-warning-panel only-when-active">'+App.translate("This option works only in PRO.")+("secureFile"===v?" "+App.translate("If you enable it and you have files in this field, they stay on the server, but you cannot access them from totum.")+" ":"")+App.translate("This option can be enabled only. You will not be able to turn it off.")+"</div>")),b},d="string";o.type&&(d=o.type.Val||o.type);!async function e(a){let i;m.empty(),("2"!==n.table_id.v||"data_src"!==n.name.v&&"data"!==n.name.v)&&(!n.table_name||"tables_vidgets"!==n.table_name.v||"data_src"!==n.name.v&&"data"!==n.name.v)?i=l.fieldListParams[a]:(i="data"===n.name.v?["width","showInWeb"]:["width","jsonFields","showInWeb","editable","insertable","required","logging","default","copyOnDuplicate"],a="fieldParams"),"chart"===a&&(h.pcTable.chartTypes||(h.pcTable.chartTypes=(await h.pcTable.model.getChartTypes()).chartTypes),l.fieldSettings.chartType.values={},h.pcTable.chartTypes.map(e=>{l.fieldSettings.chartType.values[e.type]=e.title}));let s={type:function(){return 0}};i.forEach((function(e){let t=l.fieldSettings[e];t.parent&&-1!==i.indexOf(t.parent)?s[e]=function(){return s[t.parent]()+1}:s[e]=function(){return 0}})),o.type={isOn:!0,Val:a};let d=r("type",i,s).find("select");d.val(),d.on("change",(function(){e(t(this).val())})),i.forEach((function(e){r(e,i,s)})),u.find(".codeEditor, .HTMLEditor").each((function(){t(this).data("editor")&&t(this).data("editor").refresh&&t(this).data("editor").refresh()}))}(d)}))};const v=function(e){if(e&&e.close||!d){var a={},i=m.find(".fullJSONEditor");1===i.length?a=i.data("editor").get():m.find("input, select, textarea, .JSONEditor, .HTMLEditor, .codeEditor").not(".JSONEditor *").not(".HTMLEditor *").not(".codeEditor *").not('input[data-type="switcher"]').each((function(){var e=t(this);let i,n=e.closest(".field");var l=n.data("name");switch(e.closest(".field").data("type")){case"code":i=e.data("editor").getValue();break;case"json":try{if(i=e.data("editor").get(),"object"!=typeof i)throw App.translate("Field structure error")}catch(e){throw App.notify(App.translate("Field %s structure error",l)),App.translate("Field structure error")}break;case"html":i=e.data("editor").getValue();break;case"checkbox":i=!!e.is(":checked");break;case"integer":i=parseInt(e.val());break;case"number":i=parseFloat(e.val());break;default:i=e.val()}let s;isOnCheckbox=n.find('input[data-type="switcher"]'),s=0===isOnCheckbox.length?e.is(":visible"):isOnCheckbox.is(":checked"),a[l]={isOn:s,Val:i}})),f.data("val",a),b=!0,e&&e.close&&(l(f,event),e.close())}};d||f.data("checkVal",v),p=[{label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:v},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];return d?(e.top.BootstrapDialog.show({message:u,type:BootstrapDialog.TYPE_DANGER,title:App.translate("Field <b>%s</b> parameters",n.title.v),buttons:p,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){b||s(f,e),t("body").off("ctrlS.FieldParams")},onshown:function(e){w(i.v),e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),t("body").on("ctrlS.FieldParams",(function(t){return setTimeout(()=>{v(e)},10),!1}))}}),f.text(App.translate("Editing in the form")).addClass("edit-in-form"),setTimeout(()=>{f.closest("td").addClass("editing-in-modal")})):(w(i.v),f.append(m),f.addClass("fieldparams-edit-panel"),setTimeout(()=>{let e=!1,a=f.closest(".InsertPanel"),i=a.find('div[data-name="version"] select').val();a.on("keyup.jsonFormEvent change.jsonFormEvent",'.cell:not([data-name="data_src"]) input, .cell:not([data-name="data_src"]) select',(function(a){if(!e){if(t(this).closest('[data-name="version"]').length&&i===t(this).val())return;e=!0,f.find(".jsonForm").prepend('<div id="fieldParamsLocker"><i class="fa fa-lock"></i><div class="unlock-click">'+App.translate("Click hear to unlock")+"</div></div>"),t(".jsonForm #fieldParamsLocker").one("click",()=>{t(".jsonForm #fieldParamsLocker").remove(),e=!1})}})),f.find(".jsonForm").on("remove",()=>{a.off("jsonFormEvent")})})),f.data("val",i.v).data("input",m)},__addInput:function(a,i,n,l,s,r){let d=this;var c=(i=i||{}).type;let p,h;p=n.Val,h=n.isOn;var f,u=t('<div class="field form-group">').attr("data-name",a);let m,b=t("<span>").text(i.title?i.title:a);switch(c){case"code":(f=t('<div class="codeEditor">')).data("editor",!0),setTimeout(()=>{var e=t("<div>").appendTo(f),n=CodeMirror(e.get(0),{value:p||(i.default?i.default:""),mode:"totum",height:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,gutter:!1,indentWithTabs:!0});if(n.on("blur",()=>{s()}),f.data("editor",n),n.getScrollerElement().style.minHeight="150px",n.table=l.table_name&&l.table_name.v?l.table_name.v:null,n.codeType=a,n.cycle_id=d.pcTable.tableRow.cycle_id,App.CodemirrorFocusBlur(n),"codeAction"==a&&"button"!==r.find('div[data-name="type"] select').val()&&!u.data("checking")){u.append('<div class="code-checkboxes-warning-panel">'+App.translate("There is no any active trigger.")+"</div>");const e=()=>{u.is(".disabled")||0!==u.next().find(":checked").length?u.removeClass("code-checkboxes-active-warning"):u.addClass("code-checkboxes-active-warning")};e(),u.data("checking",!0),u.parent().on("change",'[data-name="codeAction"] input,[data-name="CodeActionOnAdd"] input,[data-name="CodeActionOnChange"] input,[data-name="CodeActionOnDelete"] input,[data-name="CodeActionOnClick"] input',e)}});break;case"string":(f=t("<input>").val(void 0!==p?p:i.default?i.default:"")).on("focus",()=>{f.select()});break;case"json":f=t('<div class="JSONEditor">').height(500).on("blur",s);var g=new JSONEditor(f.get(0),{}),w=t('<a href="#" style="padding-top: 8px; display: inline-block; padding-left: 20px;">'+App.translate("Manually")+"</a>").on("click",(function(){var a=t("<div>"),i=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(g.get(),null,2)).appendTo(a);return BootstrapDialog.show({message:a,type:null,title:App.translate("Manually changing the json field"),buttons:[{label:App.translate("Save"),cssClass:"btn-m btn-warning",action:function(t){try{g.setText(i.val()),t.close()}catch(t){e.top.App.modal(App.translate("JSON format error"))}}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){},onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1}));if(f.find(".jsoneditor-menu").append(w),"chartOptions"===a){let e=t('<a href="#" style="padding-top: 8px; display: inline-block; padding-left: 20px;">'+App.translate("Fill in by the default settings")+"</a>");e.on("click",()=>{let e=t('div[data-name="chartType"] select').val();return d.pcTable.chartTypes.some(t=>{if(t.type==e)return g.setText(JSON.stringify(t.default_options)),!0}),!1}),f.find(".jsoneditor-menu").append(e)}f.data("editor",g);let n="string"==typeof p?JSON.parse(p):p;g.set(n);break;case"html":(f=t('<div class="HTMLEditor">')).data("editor",!0),setTimeout(()=>{var e=t("<div>").appendTo(f),a=CodeMirror(e.get(0),{value:p||(i.default?i.default:""),mode:"text/html",height:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0});a.on("blur",s),a.getScrollerElement().style.minHeight="150px",f.data("editor",a)});break;case"integer":case"number":f=t("<input>").val(void 0!==p?p:i.default?i.default:"").attr("type","number"),void 0!==i.min&&f.attr("min",i.min),void 0!==i.max&&f.attr("max",i.max),void 0!==i.step&&f.attr("step",i.step),f.on("focus",()=>{f.select()});break;case"checkbox":f=t("<input>").attr("type","checkbox").data("type",c),p&&f.prop("checked",!0);break;case"select":if(f=t("<select>"),i.values){let e,n=i.valIcons||{};i.valuesOrder&&(e=i.valuesOrder.slice(0)),"type"===a&&(l.table_name&&l.name&&"tables_fields"===l.table_name.v&&"data_src"===l.name.v&&(e=["fieldParams"]),t.each(e,(function(e,t){o[t]&&(n[t]="fa "+o[t].icon)})));const s=function(e,a){let i=t("<option>").attr("value",e).text(a);n[e]&&i.data("icon",n[e]),f.append(i)};e?e.forEach((function(e){s(e,i.values[e])})):t.each(i.values,s)}i.multiple&&(f.attr("multiple","multiple"),f.attr("size","2")),f.css("visibility","hidden"),f.outerHeight(34);let h=void 0===p&&i.default?i.default:p;setTimeout((function(){f.selectpicker(),f.css("visibility","visible")}),10),f.val(h)}return n.isOnCheck=!0,"checkbox"===c?(u.prepend(t('<label class="field-param-lable">').html(b).addClass("form-check-label").prepend(f).append('<a href="'+App.translate("PATH-TO-DOCUMENTATION")+"fields#fields-settings-"+a+'" target="_blank"><i class="fa fa-question-circle-o"></i></a>')),u.addClass("checkbox"),m=f,f.is(":checked")||(n.isOnCheck=!1,u.addClass("disabled"))):(u.prepend(t('<label class="field-param-lable">').html(b).append('<a href="'+App.translate("PATH-TO-DOCUMENTATION")+"fields#fields-settings-"+a+'" target="_blank"><i class="fa fa-question-circle-o"></i></a>')),f&&(f.data("type",c),f.data("editor")||(f.addClass("form-control"),f.on("change",s)),u.append(f)),!0!==i.required&&(m=t('<input type="checkbox" data-type="switcher"/>'),h?(n.isOnCheck=!0,m.prop("checked",!0)):(n.isOnCheck=!1,u.addClass("disabled")),u.find("label").prepend(m).addClass("switcheble"),u.addClass("checkbox"))),m&&m.on("change",(function(){t(this).is(":checked")?!0!==n.isOnCheck&&(n.isOnCheck=!0,u.removeClass("disabled"),n.changed(),t(this).closest("div").find(".codeEditor, .HTMLEditor").each((function(){t(this).data("editor")&&t(this).data("editor").refresh()}))):!1!==n.isOnCheck&&(n.isOnCheck=!1,u.addClass("disabled"),n.changed()),s()})),u.data("type",c),u},getValue:function(e,a,i){"use strict";if(i){let a=t.Deferred();return a.resolve({value:e||{}}),a}let n={fieldName:this.name};return a.id&&(n.rowId=a.id),this.pcTable.model.getValue(n,this.table_id)},getPanelText:function(e){return JSON.stringify(e,null,2)},getCellText:function(e){return App.translate("Field settings")}}),o.button={icon:"fa-hand-pointer-o",required:!1,getPanelText:function(e,t,a){let i=this.getCellText(e,t,a);return i.on("click",()=>(this.pcTable.selectedCells&&(this.pcTable.selectedCells.empty(),this.pcTable.selectedCells.selectPanelDestroy()),this.pcTable._buttonClick(t,this,a),!1)),i.wrap("<div>"),i.parent()},isCyclesTabButton(){return"cycles"===this.pcTable.tableRow.type&&"column"===this.category&&this.name.match(/^tab_/)},getCellText:function(e,a,i){let n=this,l={};"column"===this.category?i.id?l=t.extend({},n.pcTable.f||{},i.f||{},i[n.name].f||{}):this.buttonActiveOnInsert?l=t.extend({},i[n.name].f||{}):(l.block=!0,i[n.name]&&i[n.name].f&&i[n.name].f.icon&&(l.icon=i[n.name].f.icon)):l=t.extend({},n.pcTable.f||{},i[n.name].f||{}),a&&a.addClass("cell-button");const s=e=>{if(n.td_style&&"function"==typeof n.td_style){let t=n.td_style(l).Button;t&&e.css(t)}else if(i.__td_style&&"function"==typeof i.__td_style){let t=i.__td_style(l);t.Button&&e.css(t.Button),t.td&&a.css(t.td)}else if(a&&a.is(".button-wrapper")){let i,n={};l.background&&(n.backgroundColor=App.theme.getColor(l.background)),l.color&&(n.color=App.theme.getColor(l.color,!0)),e.css(n),this.pcTable.isMobile?(i=this.width>t("#table").width()-30?t("#table").width()-30:this.width,a.width(i),e.width(i)):a.is(".no-width")||(this.pcTable.rowButtonsCalcWidth(),i=this.width>this.pcTable.__$rowsButtons.width()-10?this.pcTable.__$rowsButtons.width()-10:this.width,a.width(i),e.width(i),i<=20&&setTimeout(()=>{this.pcTable.rowButtonsCalcWidth(),i=this.width>this.pcTable.__$rowsButtons.width()-20?this.pcTable.__$rowsButtons.width()-20:this.width,a.width(i),e.width(i-16)},40))}else if(n.pcTable.isMobile&&"column"!==n.category){let t={};l.background&&(t.backgroundColor=App.theme.getColor(l.background)),l.color&&(t.color=App.theme.getColor(l.color,!0)),e.css(t)}};if(l.block||!this.pcTable.control.editing&&!this.pressableOnOnlyRead){let e=t('<button class="btn btn-default btn-xxs button-field" tabindex="-1" disabled>').text(this.buttonText||"");if(a&&a.is(".button-wrapper")&&(e.removeClass("btn-xxs button-field"),e.addClass("btn-sm")),s(e),l.text&&e.text(l.text),l.comment&&!a.is(".cell")){let a;a=t('<i class="cell-icon fa fa-info"></i>'),e.prepend(a),a.attr("title",l.comment)}else if(l.icon){let a=t('<i class="cell-icon fa fa-'+l.icon+'"></i>');e.prepend(a),""===e.text()&&(e.css("text-align","center"),a.css("float","none"))}return e}let o=t('<button class="btn btn-default btn-xxs button-field" tabindex="-1">').text(this.buttonText||"");if(s(o),l.text&&o.text(l.text),l.comment&&!a.is(".cell")){let e;e=t('<i class="cell-icon fa fa-info"></i>'),o.prepend(e),e.attr("title",l.comment)}else if(l.icon){let e=t('<i class="cell-icon fa fa-'+l.icon+'"></i>');o.prepend(e),""===o.text()&&(o.css("text-align","center"),e.css("float","none"))}return o},getEditElement:function(e,t,a,i,n,l,s){var o=this.getCellText(void 0,void 0,a);void 0!==s&&o.attr("tabindex",s);let r=!1;const d=e=>{if(r)return;r=!0;let t=o.html();o.html('<i class="fa fa-spinner"></i>'),this.pcTable.model.doAfterProcesses(()=>{this.pcTable.model.click({item:this.pcTable._insertRowHash,fieldName:this.name}).then(()=>{o.html(t),r=!1,i(o,e,!0)})})};return o.on("click",d).removeClass("btn-xxs").addClass("btn-sm text-edit-button").on("keydown",e=>{switch(e.key){case"Tab":i(o,e);break;case"Enter":i(o,d)}}),this.checkWaiting(o),o},btnOK:function(e,t){let a=e.find("button.button-field"),i=this;a.text(App.translate("Done")),e.data("clicked",!0),setTimeout((function(){e.length&&e.removeData("clicked"),t&&a.replaceWith(i.getCellText.call(i,t[i.name],e,t))}),2e3)}},o.link={icon:"fa-link"},o.comments={icon:"far fa-comments-o",getEditVal:function(e){return e.data("val")},isDataModified:function(e,t){return null!==e},getCellText:function(e){let a=this;if(0===e.n||!e.n)return"";let i=t("<span>"),n=t('<span class="comments">').text(e.c[0]+" "+e.c[1]+": "+e.c[2]).appendTo(i);return e.notViewed&&(n.addClass("notViewed"),a.decorationColor&&n.css("border-bottom-color",App.theme.getColor(a.decorationColor,!0))),i},getValue:function(e,a,i,n){"use strict";let l=this,s=t.Deferred(),o={fieldName:this.name};if(a.id&&(o.rowId=a.id),i)if(e)if("string"!=typeof e||"column"===l.category&&!a.id)s.resolve({value:e});else{(this.getValueFromServer?this.getValueFromServer():this.pcTable.model.getValue(o,this.table_id)).then(t=>{s.resolve({value:e,list:t.value})})}else e=[];else n||0!==e.n&&(1!==e.n||e.cuted||e.notViewed)?!n&&e.n>1&&!e.notViewed&&e.all?s.resolve({value:e.c}):s=this.getValueFromServer?this.getValueFromServer():this.pcTable.model.getValue(o,this.table_id):(e||(e=[]),s.resolve({value:[e.c]}));return s.then((function(i){let n;if(e.notViewed?n=e:a&&a[l.name]&&(n=a[l.name].v.notViewed?a[l.name].v:a[l.name]),n&&n.notViewed){let e=t.Deferred();e.then((function(){let e;delete n.notViewed,a.id?e=l.pcTable._getTdByFieldName(l.name,l.pcTable.data[a.id].$tr):(e=l.pcTable._paramsBlock.find('td[data-field="'+l.name+'"]'),e.length||(e=l.pcTable._footersBlock.find('td[data-field="'+l.name+'"]'))),e&&e.length&&(e.find(".notViewed-num").remove(),e.find(".notViewed").removeClass("notViewed"))})),a[l.name].notViewed?l.pcTable.model.setCommentsViewed(a[l.name].v.length,l.name,a.id).then((function(){e.resolve()})):e.resolve()}})),s},getPanelText:function(e,a,i){let n=this,l=t.Deferred(),s=e||i[n.name];const o=function(e){let a=t('<div class="comments">');return t.each(e,(function(e,t){a.append(n.getCommentLine(t))})),setTimeout((function(){let e;e=a.closest("td").length?a.closest("td"):a.closest(".field-value"),e.scrollTop(a.height())}),100),a};return s.all?o(s.c):(this.getValue(s,i,!1).then((function(e){l.resolve(o(e.value))})).fail((function(){l.reject()})),l.promise())},getCommentLine:function(e,a){let i,n=t('<div class="comments-line">');return n.append(t('<span class="com_author">').text(e[1])),n.append(t('<span class="com_dt">').text(e[0])),n.append(t('<div class="com_text">').html(App.textWithLinks(e[2]))),e[3]&&n.append(i=t('<div class="com_edit">').html(App.translate("Edited"))),"editable"===e[4]&&a&&(i=i||t('<div class="com_edit">').appendTo(n),i.html('<button class="btn btn-m btn-default comment-edit">'+(e[3]?"<span>"+App.translate("Edited")+"</span>":"")+'<i class="fa fa-edit"></i></button>')),n},getPanelVal:(e,t)=>e,getEditElement:function(a,i,n,l,s,o,r,d){let c,p,h=this,f=a||t("<div>"),u=t("<div>").css("min-height",200);f.data("dialog",u);let m=!1,b="editField"===d?f:u;i=i.v||"";let g=function(e){h.getValue(i,n,!d,!0).then((function(e){let a=t('<textarea type="text" style="height:90px;resize: vertical" class="form-control"/>');if("object"==typeof e.value||"object"==typeof e.list){let a=e.value;"object"!=typeof a&&(a=e.list),t.each(a,(function(e,t){b.append(h.getCommentLine(t,!0))})),b.on("click",".comment-edit",e=>{h.editLastComment(a[a.length-1],n),p.close()})}e.value&&"object"!=typeof e.value?a.val(e.value):f.data("val")&&a.val(f.data("val")),b.append(t('<div class="comments-input">').append(a)),b.data("input",a),a.focus()}))};const w=function(e,t,a){let i=b.find("textarea").val().trim();f.data("val",i),a||(l(f,{}),e.close())};c=[];let v={label:App.translate("Save")+" Alt+S",cssClass:"btn-m btn-warning",action:w},_={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){s(f,{}),e.close()}},y=App.translate("Comments of field")+" <b>"+this.title+"</b>"+this.pcTable._getRowTitleByMainField(n," (%s)"),x="ctrlS.commentdialog";if(d)"editField"===d?g():(setTimeout((function(){let a=f.closest("td").find(".cdiv");a.length>0?(a.data("bs.popover").options.content.find(".btn").each((function(){let e=t(this),a={};a.label=e.data("name"),a.cssClass=e.attr("class").replace("btn-sm","btn-m"),a.icon=e.find("i").attr("class"),a.save=e.data("save"),a.click=e.data("click"),a.action=function(e){a.save&&w(e,0,!0),a.click({}),m=!0,e.close()},c.push(a)})),a.popover("destroy")):(c.push(v),c.push(_)),p=h.pcTable.isMobile?App.mobilePanel(y,u,{buttons:c,onhide:function(e){t("body").off(x),m||o(f,{})},onshown:function(e){g()},onshow:function(e){t("body").on(x,(function(t){w(e,0,!1)}))}}):e.top.BootstrapDialog.show({message:u,type:null,title:y,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:c,onhide:function(a){t(e.top.document).find("body").off(x),m||o(f,{})},onshown:function(a){a.$modalContent.position({of:t(e.top.document).find("body"),my:"top+50px",at:"top"}),g()},onshow:function(a){a.$modalHeader.css("cursor","pointer"),a.$modalContent.css({width:900}),t(e.top.document).find("body").on(x,(function(e){w(a,0,!1)}))}}),f.data("Dialog",p)}),1),f.text(App.translate("Editing in the form")).addClass("edit-in-form"),setTimeout(()=>{f.closest("td").addClass("editing-in-modal")}));else{let a=!1;if(f.off().on("click keydown",(function(i){if(a)return!1;if("Tab"===i.key)return void o(u,i,null,!0);a=!0;let n=c.slice(0);n.push(v),n.push(_);var l=t(this).closest("div");p=h.pcTable.isMobile?App.mobilePanel(y,u,{buttons:n,onhide:function(e){a=!1,t("body").off(x),s(l,e)},onshown:function(e){0===e.$modalBody.find("textarea").length&&g(),t("body").on(x,(function(t){w(e,0,!1)}))}}):e.top.BootstrapDialog.show({message:u,type:null,cssClass:"fieldparams-edit-panel",title:y,draggable:!0,size:BootstrapDialog.SIZE_WIDE,buttons:n,onhide:function(i){a=!1,t(e.top.document).find("body").off(x),s(l,i)},onshown:function(a){a.$modalHeader.css("cursor","pointer"),0===a.$modalBody.find("textarea").length&&g(),a.$modalContent.css({width:900}),t(e.top.document).find("body").on(x,(function(e){w(a,0,!1)}))}})})),0===f.find("button").length){let e=t('<button class="btn btn-default btn-sm text-edit-button">').text(App.translate("Add comment"));r&&e.attr("tabindex",r),f.append(e),this.checkWaiting(e)}}return f.data("val",null)},getCellTextInPanel:function(e,t,a,i){return this.getEditPanelText({v:e},a,i)},getEditPanelText:function(e,a,i){if(e){if(e.v.forEach){let a=t("<div>");return e.v.forEach((function(e){a.append(t('<div class="">').append(t('<span class="user">').text(e[1])).append(t('<span class="date">').text(e[0])).append(t('<div class="text">').text(e[2])).append(e[3]?t('<div class="edited">').text(App.translate("Edited")):""))})),a.children()}{let a=t("<div>");return i[this.name]&&i[this.name].v&&i[this.name].v.forEach&&i[this.name].v.forEach((function(e){a.append(t("<div>").append(t('<span class="user">').text(e[1])).append(t('<span class="date">').text(e[0])).append(t('<div class="text">').text(e[2])))})),a.append(t('<div class="new-comment">').text(e.v)),a.children()}}},getValPreview(e){return this.getCellText({c:e[e.length-1],n:e.length})},editLastComment:function(e,a){let i,n,l=this,s=t("<div>");i=t('<input type="text" class="form-control" id="ttmInput">').appendTo(s).val(e[2]).on("keydown",e=>{13===e.keyCode&&o()});let o=function(){e[2]!==i.val()?l.pcTable.model.save({[a.id?a.id:"params"]:{[l.name]:{value:i.val(),editLastComment:e[2]}}}).then(e=>{l.pcTable.table_modify(e),n.close()}):n.close()};setTimeout(()=>{i.focus()},1);let r={buttons:[{label:App.translate("Save"),action:o},{label:App.translate("Cancel"),action:function(e){e.close()}}],class:"linkButtons"},d=App.translate("Your last comment editing");App.isMobile()?n=App.mobilePanel(d,s,r):(!r.width&&r.html||(r.onshown=function(e){r.width&&e.$modalDialog.width(r.width)}),n=App.panel(d,s,r))}},o.chart={icon:"fa-bar-chart",getCellText:function(e,a,i){let n=t("<div>");return i[this.name].ch&&this.loadChart(()=>{this.chartSimple(n,i[this.name].ch)}),n},async loadChart(a){if(e.ChartLoaded)e.ChartLoaded.then(a);else{let i,n;e.ChartLoaded=new Promise((e,t)=>{i=e,n=t}),e.ChartLoaded.then(a),t.getScript("/js/lib/chart.js").then(()=>{i()})}},chartSimple:function(a,i){let n=t('<canvas class="ttm-chart"></canvas>');a.html(n);let l={},s={...this.chartOptions};"column"===this.category||this.column?(n.attr("height","23"),l.layout={padding:{left:5,right:5,top:2,bottom:2}},l.scales={yAxes:[{display:!1}],xAxes:[{display:!1}]}):this.f&&this.f.height&&n.attr("height",this.f.height),e.innerWidth<("false"!==(localStorage.getItem("TreeMinimizer")||"false")?600:800)&&(l.layout={...s.layout,padding:{left:5,right:5,top:2,bottom:2}},l.scales={},s.scales&&s.scales.yAxes?l.scales.yAxes=s.scales.yAxes.map(e=>({...e,display:!1})):l.scales.yAxes=[{display:!1}],s.scales&&s.scales.xAxes?l.scales.xAxes=s.scales.xAxes.map(e=>({...e,display:!1})):l.scales.xAxes=[{display:!1}],l.aspectRatio=s.aspectRatioMobile||(s.aspectRatio||2)/1.6);let o=n.get(0).getContext("2d"),r=s.type||"line";delete s.type;let d=i.values.map(()=>new Object);s.data&&s.data.datasets&&(d=s.data.datasets),i.datasets&&(d=i.datasets);let c,p=s.data||{};p.datasets=t.extend(!0,{},d),Object.keys(i).forEach(e=>{i[e]&&"object"==typeof i[e]&&"function"==typeof i[e].forEach&&(c=e.match(/^datasets_(.*)$/))&&i[e].forEach((e,t)=>{p.datasets[t]&&(p.datasets[t][c[1]]=e)})}),i.labels&&(p.labels=i.labels),delete s.data,p.datasets=Object.values(p.datasets),i.values.forEach((e,t)=>{p.datasets[t]&&(p.datasets[t].data=e)}),i.values.length<p.datasets.length&&p.datasets.splice(i.values.length,p.datasets.length-i.values.length),new Chart(o,{type:r,data:p,options:{...s,...l}}),this.pcTable._container.getNiceScroll&&this.pcTable._container.getNiceScroll().resize(),n.on("contextmenu",()=>!1),n.on("dblclick",()=>{e.top.BootstrapDialog.show({message:"<canvas></canvas>",draggable:!0,title:this.pcTable.__getCellTitle(this),cssClass:"dialog-chart-topper",onshown:e=>{new Chart(e.$modalBody.find("canvas").get(0).getContext("2d"),{type:r,data:p,options:s})}})})}},t.each(o,(function(e,a){o[e]=t.extend({},r,a)})),App.pcTableMain=function(a,i){if(this.data_params=i.params||null,i=t.extend({},{tableRow:{},nSorted:!0,isCreatorView:!1,withCsvButtons:!1,withCsvEditButtons:!1,noDataRowClass:"pcTable-noDataRow",contanerClass:"pcTable-container",tableClass:"pcTable-table",width:null,isTreeView:!1,treeReloadRows:[],tree:[],treeIndex:{},treeSort:[],checkIsUpdated:0,_containerId:"",scrollWrapper:null,tableWidth:0,control:{adding:!1,sorting:!1,deleting:!1,duplicating:!1},dataSorted:[],data:[],dataSortedVisible:[],mainFieldName:"id",insertRow:null,_container:null,_content:null,openedPanels:{},extraClastersBottom:null,extraClastersTop:null,dataSortedClasters:{t:[],m:[],b:[]},ScrollClasterized:null,_innerContainer:null,_header:null,_table:null,LogButton:null,model:null,fields:{},hidedFields:[],fieldCategories:{column:[],params:[],footer:[]},sorted:{field:"",direction:"asc"},_sorting:{},_filterable:!1,filtersClearButton:null,_indexes:{fieldByName:{}},beforeSpaceHide:!0},i),t.extend(this,i,!0),App.isMobile()&&(this.isCreatorView=!1,this.isMobile=!0),this.isCreatorView&&(localStorage.getItem("notCreator")||"#no-creator-view"===e.location.hash)&&(this.isCreatorView=!1),this.isCreatorView||Object.keys(this.fields).forEach(e=>{this.fields[e].webRoles&&1===this.fields[e].webRoles.length&&1===parseInt(this.fields[e].webRoles[0])&&delete this.fields[e]}),this.hidden_fields=this.hidden_fields||{},0===this.hidden_fields.length&&(this.hidden_fields={}),App.isTopWindow()&&(this.beforeSpaceHide=!1),this.model.addPcTable(this),a){i.links&&i.links.length>0&&this.model.showLinks(i),i.interfaceDatas&&i.interfaceDatas.length>0&&this.model.shoInterfaceDatas(i),this.model.showPanels(i),this.refreshArraysFieldCategories(!0);let e=t(a);e.data("pctable",this),this._container=e,this.isCreatorView||this._container.addClass("worker-view"),this._containerId=this._container.attr("id"),this._containerId||(this._containerId="pcTable"+s++,this._container.attr("id",this._containerId)),this._init(),this.render(i.addVars),this.applyHideRows(this.f.hideRows,this.f.showRows)}else this.initForPanel(i);return this};let d=0;e.EditPanel=function(a,i,n,l,s={}){if(e.top!==e)return new e.top.EditPanel(a,i,n,l,s);let o,r=t.extend(!0,{},n),c=this;c.pcTable=a,c.panelId="panel"+d++;let p={};p.count=n.__columns,delete n.__columns;let h=2===a||"object"==typeof a&&2===a.tableRow.id;(h||1===a||"object"==typeof a&&2===a.tableRow.id)&&(o=n.cycle_id,delete n.cycle_id);let f={},u=!1;this.closed=!1;let m=t.Deferred();this.$panel=t('<div class="InsertPanel">'),this.isNewPanel=!0,this.blockedFields={},this.bootstrapPanel=null;let b=r.id?"checkEditRow":"checkInsertRow",g=r.id?"saveEditRow":"add";this.panelType=r.id?"edit":"insert",this.editItem=r||{},t("body").trigger("pctable-opened",{type:"panel",panel:c}),c.resolved=!1,c.error={};let w,v={},_={};c.waiting=[!1],this.checkRow=async function(e,a,i){c.waiting[0]=!0,c.fields||(c.fields=[],c.pcTable.fieldCategories.panel_fields.forEach(e=>{e=t.extend({},e),c.fields.push(e),e.waiting=c.waiting})),o&&(c.pcTable.tableRow.cycle_id=o,o=null);let n=this;this.reCreateInputsForce=!1;const l=()=>new Promise((function(l,s){const o=function(e){"edit"==c.panelType&&a&&(v=t.extend(!0,{},e.row)),w=w||e.hash,c.fields[0].hash||c.fields.forEach(e=>{e.hash=w}),e.selects&&Object.keys(e.selects).forEach(t=>{c.fields.forEach(a=>{a.name===t&&(a.loadedSelect=e.selects[t])})}),c.editRow.call(c,e),l(c),u=!1,c.waiting[0]=!1},d=e=>{c.reCreateInputsForce=!0,c.editRow.call(c,{f:c.f,row:c.editItem}),s(e),c.waiting[0]=!1};switch(b){case"checkEditRow":c.pcTable.model[b](n.getDataForPost(e),a?"all":"true",w).then(o).fail(d);break;case"checkInsertRow":c.pcTable.model[b](n.getDataForPost(e),w,i,a?"all":"true").then(o).fail(d);break;case"viewRow":c.pcTable.model[b](r.id,w).then(o).fail(d)}}));return c.beforeSave&&!a&&(e=await c.beforeSave(e)),l()},this.saveRow=function(a,i){let n=this.getDataForPost(c.editItem);const l=()=>{c.pcTable.model[g]("saveEditRow"===g?n:w,null).then((function(a){if(h){let e=t("#table").data("pctable");e&&e.tableRow.id==c.editItem.table_id.v&&n.data_src&&n.data_src.v&&n.data_src.v.width&&e.setColumnWidth(c.editItem.name.v,n.data_src.v.width.Val)}m.resolve(a),c.resolved=!0,t(e.top.document.body).trigger("pctable-closed",{type:"panel",json:a,method:c.panelType,tableId:c.pcTable.tableRow.id,panel:c}),c.bootstrapPanel.close()})).fail((function(){if(i.length&&i.isAttached()){a.$modal.find(".btn-save").prop("disabled",!1)}}))};h&&"insert"===this.panelType&&u?this.checkRow({}).then(l):l()},this.refresh=()=>{this.closed||("edit"===c.panelType?c.pcTable.model[b]({id:r.id}).then(e=>{Object.keys(e.row).forEach(t=>{1!==c.pcTable.tableRow.id||"panels_view"!==t||Object.equals(v[t],e.row[t])?v[t]=e.row[t]:v[t]={}}),c.pcTable.model[b](this.getDataForPost("manual")).then((function(e){c.editRow.call(c,e)}))}):c.pcTable.model[b](this.getDataForPost("manual"),w).then((function(e){Object.keys(e.row).forEach(t=>{v[t]=e.row[t]}),c.editRow.call(c,e)})))},this.editRow=function(e){"use strict";let a=!1;c.pcTable.f=e.f||{},c.editItem.f=e.row.f||{};let n=this.$panel.find(">div:first"),l=this.$panel.find(">div:eq(2)"),o=this.$panel.find(">div:eq(3)"),r=[],d=0,u=0,m=0;const b=function(e){return-1!==["text","comments","file","listRow"].indexOf(e.type)||e.multiple?1.5:1};let g=!1;n.length||(c.fields.forEach((function(a,i){if("n"===a.name)return;let n=t.extend({},c.pcTable.f||{},c.editItem.f||{},e.row[a.name].f||{});n.hide&&n.hide.extpanel||(d+=b(a),m++)})),d/=2,n=t("<div>").appendTo(this.$panel),r.column1=n,h?(l=t("<div>").appendTo(this.$panel),o=t("<div>").appendTo(this.$panel),r.column2=l,r.column3=o):1!==p.count&&(2===p.count||m>6)?(l=t("<div>").appendTo(this.$panel),r.column2=l):(g=!0,this.$panel.css("grid-template-columns","minmax(0, 1fr)")));let w={};if(c.fields.forEach((function(t,a){w[t.name]=c.editItem[t.name],c.editItem[t.name]=e.row[t.name]})),c.fields.forEach((function(e,i){let o=c.$panel.find('div.cell[data-field-name="'+e.name+'"]'),p=w[e.name];c.isEditable(e)&&(a=!0);let m=t.extend({},c.pcTable.f||{},c.editItem.f||{},c.editItem[e.name].f||{});if(m.hide&&m.hide.extpanel)return;if(o.length)o.data("input")&&!m.block?(this.reCreateInputsForce||e._reloadCellInPanel||!p||e.isDataModified(c.editItem[e.name].v,p.v)||e.codeSelectIndividual||"insert"==c.panelType&&e.code&&!e.codeOnlyInAdd||["fieldParams"].indexOf(e.type)>-1||e.name in _)&&(delete e._reloadCellInPanel,c.createCell.call(c,o,e,i,m)):c.createCell.call(c,o,e,i,m);else{let a=t('<div class="cell-wrapper" style="position: relative"><div class="progressBorder"></div></div>');e.panelColor?a.css("background-color",App.theme.getColor(e.panelColor)):e.webRoles&&1===e.webRoles.length&&"1"===e.webRoles[0].toString()&&a.addClass("admin-see");let s=t("<label>").text(e.title).prependTo(a);1===c.pcTable.tableRow.id&&s.append('<span class="field-param-lable"><a href="'+App.translate("PATH-TO-DOCUMENTATION")+"tables#table-settings-"+e.name+'" target="_blank"><i class="fa fa-question-circle-o"></i></a></span>'),e.unitType&&s.text(s.text()+", "+e.unitType);let p=t('<div class="btns pull-right">').prependTo(a),f=b(e);if(a.attr("data-koeff",f),"fieldParams"===e.type)this.$panel.append(a),a.width("100%"),a.attr("data-name",e.name),a.css({"grid-column-start":1,"grid-column-end":4}),o=c.createCell.call(c,o,e,i,m,a);else{let t;if(h)if(0===i)this.$panel.prepend(a.css({"grid-column-start":1,"grid-column-end":4}));else{let e=Math.floor((i+1)/2);7===i&&(e=3),t=r["column"+e]}else t=u<d&&u+f>d||u+f<=d?n:l.length?l:n;t&&t.append(a),u+=f,o=c.createCell.call(c,o,e,i,m,a)}if(setTimeout(()=>{let e=a.find(".btns").width();e>0&&(e+=3),s.css("max-width","calc(100% -  "+e+"px)")},2),e.linkToSelectTable&&a.append('<div class="source-link"><a href="'+e.linkToSelectTable.link+'" style="font-size: 12px" target="_blank">'+e.linkToSelectTable.title+"</a></div>"),e.help){let a=t('<button class="btn btn-sm btn-default"><i class="fa fa-info"></i></button>').on("click",()=>{App.notify(e.help,e.title)});p.prepend(a)}}let g=o.parent().find(".btns"),y=g.find(".backgroundButton");if(m.background||m.color?(y.length||(y=t('<span class="backgroundButton btn btn-sm btn-default">').appendTo(g).html("<span/>")),y.css("background-color",App.theme.getColor(m.background||"transparent")),y.find("span").css("background-color",App.theme.getColor(m.color||m.background))):y.length&&y.remove(),o.parent().find(".progressBorder").css({borderTopColor:App.theme.getColor(m.progresscolor||"transparent"),width:(m.progress||100)>=100?100:m.progress+"%"}),m.hide&&m.hide.panel?o.parent().css("display","none"):o.parent().css("display",""),o.attr("data-field-name",e.name),o.attr("data-field-type",e.type),"edit"===c.panelType){let a,n=c.editItem[e.name].v;if(a="fieldParams"===e.type||Object.equals(v[e.name].v,n),a&&v[e.name].h==c.editItem[e.name].h?o.parent().removeClass("edited"):"comments"===e.type?"string"==typeof c.editItem[e.name].v&&c.editItem[e.name].v.length?o.parent().addClass("edited"):o.parent().removeClass("edited"):o.parent().addClass("edited"),e.code&&!e.codeOnlyInAdd){let a=o.parent().find(".btns button.handled");a.length||(a=t('<button class="btn btn-sm btn-default handled" tabindex="'+(2*i+2)+'"></button>'),o.parent().find(".btns").prepend(a),c.isEditable(e)?(a.on("click",(function(){!0===c.editItem[e.name].h?c.editItem[e.name].h=!1:c.editItem[e.name].h=!0,f[e.name]=!0,c.checkRow({[e.name]:c.editItem[e.name]})})),a.prop("disabled",!1)):(a.prop("disabled","disabled"),c.editItem[e.name].h||a.remove())),a.removeClass("btn-warning").addClass("btn-default"),a.html('<i class="fa fa-hand-grab-o"></i>'),c.editItem[e.name].h&&(a.addClass("btn-warning").removeClass("btn-default"),-1!==Object.keys(c.editItem[e.name]).indexOf("c")&&c.editItem[e.name].c!==c.editItem[e.name].v&&a.html('<i class="fa fa-hand-paper-o"></i>'))}}else if(e.code&&!e.codeOnlyInAdd){let a=o.parent().find(".btns"),n=a.find(".handled");s[e.name]&&c.editItem[e.name].h?0===n.length&&(n=t('<button class="btn btn-sm btn-warning handled" tabindex="'+(2*i+2)+'"><i class="fa fa-hand-paper-o pull-right"></button>').on("click",()=>{delete s[e.name],c.checkRow(void 0,void 0,e.name)}),a.prepend(n)):1===n.length&&n.remove()}}),c),c.isNewPanel){let t="";if("edit"===this.panelType){let i;switch(c.pcTable.tableRow.id){case 1:if(c.pcTable.tableRow.main_field&&c.pcTable.fields[c.pcTable.tableRow.main_field]){let t=c.pcTable.tableRow.main_field;i=c.editItem[t]||e.row[t],i&&(i=i.v),i=' "'+i+'"'}i=i?"id "+(c.editItem.id||e.row.id)+" "+i:"id "+(c.editItem.id||e.row.id),t=!c.pcTable.control.editing||e.row.f.block&&!a?App.translate("Viewing table settings")+": <b> "+i+"</b>":App.translate("Editing table settings")+": <b> "+i+"</b>";break;case 2:if(c.pcTable.tableRow.main_field&&c.pcTable.fields[c.pcTable.tableRow.main_field]){let t=c.pcTable.tableRow.main_field;i=c.editItem[t]||e.row[t],i&&(i=i.v),i=' "'+i+'"'}i=i?"id "+(c.editItem.id||e.row.id)+" "+i:"id "+(c.editItem.id||e.row.id),t=!c.pcTable.control.editing||e.row.f.block&&!a?App.translate("Viewing table field")+": "+c.editItem.table_name.v+"<b> "+i+"</b>":App.translate("Editing table field")+": "+c.editItem.table_name.v+" <b> "+i+"</b>";break;default:if(c.pcTable.tableRow.main_field&&c.pcTable.fields[c.pcTable.tableRow.main_field]){let t=c.pcTable.tableRow.main_field;i=c.editItem[t]||e.row[t],i&&(i=i.v),i=' "'+i+'"'}i?c.pcTable._isDisplayngIdEnabled()&&(i="id "+(c.editItem.id||e.row.id)+" "+i):i="id "+(c.editItem.id||e.row.id),t=!c.pcTable.control.editing||e.row.f.block&&!a?App.translate("Viewing <b>%s</b> from table <b>%s</b>",[i,c.pcTable.tableRow.title]):App.translate("Editing <b>%s</b> from table <b>%s</b>",[i,c.pcTable.tableRow.title])}}else switch(c.pcTable.tableRow.id){case 1:t=App.translate("Adding table");break;case 2:t=App.translate("Adding field");break;default:t=App.translate("Adding row to table")+" <b>"+c.pcTable.tableRow.title+"</b>"}c.cleateBootstrapPanel.call(c,t,i,"insert"===c.type||a,g?"one-column-panel":""),c.isNewPanel=!1}},this.cleateBootstrapPanel=function(i,n,s,o){let r,p=this,f=[];s&&(r=function(e,a){"use strict";if(Object.keys(c.error).length){let e=Object.keys(c.error)[0],a=c.error[e];return App.notify(a,t("<div>"+App.translate("Error in %s field",t("<span>").text(c.pcTable.fields[e].title).html())+" </div>").append()),!1}let i=e.$modal.find(".btn-save").prop("disabled","disabled");c.beforeSave&&c.beforeSave();let n=setInterval(()=>{c.waiting[0]||(clearInterval(n),c.pcTable.model.doAfterProcesses((function(){p.saveRow.call(p,e,i)})))},250)},f.push({action:r,cssClass:"btn-warning btn-save",label:App.translate("Save")+" Alt+S"}));const u=()=>{this.closed=!0,void 0!==this.mainPanelId&&a.editPanels&&a.editPanels.splice(this.mainPanelId,1)};l?(p.close=function(){m.resolve(void 0,!0),t(e.top.document.body).trigger("pctable-closed",{type:"panel"}),c.resolved=!0,p.bootstrapPanel.close()},f.push({action:p.close,label:null,icon:"fa fa-"+(!0===l?"arrow-right":"times"),cssClass:"btn-m btn-default btn-empty-with-icon"})):(p.close=function(){p.bootstrapPanel.close()},f.push({action:p.close,label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon"}));let b="ctrlS.EditPanel"+d;p.bootstrapPanel=BootstrapDialog.show({type:n||null,size:BootstrapDialog.SIZE_WIDE,message:p.$panel,cssClass:"edit-row-panel "+(h?"edit-field-panel":o||""),title:i,buttons:f,draggable:!0,onhidden:function(){t("body").off(b),m.resolve(),c.resolved||t(e.top.document.body).trigger("pctable-closed",{type:"panel"}),t(e.top.document.body).off("."+c.panelId),u()},onshown:function(e){"use strict";r&&t("body").on(b,(function(a){t(".bootstrap-dialog").length>0&&(t(document.activeElement).blur(),r(e))})),e.indexedButtons[Object.keys(e.indexedButtons)[0]].attr("tabindex",500),2===Object.keys(e.indexedButtons).length&&e.indexedButtons[Object.keys(e.indexedButtons)[1]].attr("tabindex",501)}}),p.bootstrapPanel.$modalFooter.find(".btn-save").length&&(p.saveButton=p.bootstrapPanel.$modalFooter.find(".btn-save"))},this.createCell=function(a,i,n,l,o){let r=c.editItem||{};r[i.name]=r[i.name]||{},a.removeClass("error"),0===a.length?(a=t("<div data-name='"+i.name+"' class='cell'>").appendTo(o),i.code&&a.addClass("with-code")):o=a.parent();let d=o.find(".btns");if(d.find(".select-btns").remove(),this.isEditable(i)&&"button"!==i.type){c.blockedFields[i.name]=!1;let o=async function(e){let t;try{t=i.getEditVal(e),a.removeClass("error"),delete c.error[i.name]}catch(t){if("name"===i.name&&h){return delete s.name,(await c.checkRow(void 0,void 0,"name")).editItem.name.v}return c.error[i.name]=t,a.addClass("error"),App.popNotify(t,e,"default"),null}return t},r=!1,p=(a.find("input,button").is(":focus"),async function(e,t,a){let n=await o(e);if(null===n);else if(i.isDataModified(n,c.editItem[i.name].v)){r=!0;let e={};if(e[i.name]={v:n},i.code&&!i.codeOnlyInAdd&&(e[i.name].h=!0),i.code&&"insert"===c.panelType&&(s[i.name]=!0),h)switch(i.name){case"table_id":delete s.version}c.checkRow(e).finally(()=>{r=!1}),f[i.name]=!0}}),m=function(e,t){return setTimeout((function(){e&&e.length&&e.isAttached()&&(r?r=!1:p(e,t,!0))}),40),!1},b=function(e,t){p(e,t)};a.data("firstLoad",v);let g,_=i.getEditElement(a.data("input"),c.editItem[i.name],c.editItem,p,b,m,50+n,!1,a);if(l&&l.placeholder&&i.addPlaceholder&&i.addPlaceholder(_,l.placeholder),h&&"fieldParams"===i.type&&("insert"===this.panelType&&_.find(".jsonForm").on("change",()=>u=!0),c.beforeSave=async function(e){let t=await o(_);if(c.editItem[i.name]={v:t},e)return e[i.name]={v:t},e}),_.isAttached()||a.html(_),a.data("input",_),"select"===i.type&&i.changeSelectTable){let a=function(){let a=c.getDataForPost(),n=t(this).is(".source-add");n&&(a[i.name]=null);let l=0,s=e.top.App.randomIds.get();t(e.top.document.body).on("pctable-closed.select-"+c.panelId,(function(e,a){if(!a.panel||a.panel.srcRandomId!==s)return;l--;let o=a&&"insert"===a.method&&a.json&&a.json.chdata&&a.json.chdata.rows;setTimeout((function(){if(0===l||o){let e=_;delete i.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),o&&(i.multiple?c.editItem[i.name].v.push(Object.keys(a.json.chdata.rows)[0]):c.editItem[i.name].v=Object.keys(a.json.chdata.rows)[0]),i._reloadCellInPanel=!0,c.checkRow({[i.name]:c.editItem[i.name]}),!n&&c.pcTable.isMain&&c.pcTable.model.refresh((function(e){c.pcTable.table_modify.call(c.pcTable,e)})),t("body").off(".select-"+c.panelId)}}),100)})),c.pcTable.model.selectSourceTableAction(i.name,w,n).then(()=>{let a;t(e.top.document.body).on("pctable-opened.select-add-"+s,(function(i,n){n.panel.srcRandomId=s,l++,a&&clearTimeout(a),a=setTimeout(()=>{t(e.top.document.body).off("pctable-opened.select-add-"+s),e.top.App.randomIds.delete(s)},200)}))})},n=t('<span class="select-btns">').appendTo(d);if(c.editItem[i.name].v&&(!i.multiple||c.editItem[i.name].v.length)){let e=t('<button class="btn btn-default-primary btn-sm"><i class="fa fa-edit"></i></button>');n.append(e),e.on("click",a)}if(2===i.changeSelectTable){let e=t('<button class="btn btn-default-primary btn-sm source-add"><i class="fa fa-plus"></i></button>');n.append(e),e.on("click",a)}}if(i.getEditPanelText&&(g=i.getEditPanelText(c.editItem[i.name],c.editItem,v))){let e=a.find(".ttm--panel-data");e.length||(e=t('<div class="ttm--panel-data"/>').prependTo(a)),e.html(g),"comments"===i.type&&setTimeout(()=>{e.scrollTop(2e4)})}if(a.find(".format-text,.format-comment").remove(),l.text){let e=t('<div class="format-text">').text(l.text);a.append(e),l.icon&&e.prepend('<i class="fa fa-'+l.icon+'"></i>')}else l.icon&&a.append(t('<div class="format-text">').html('<i class="fa fa-'+l.icon+'"></i>'));l.comment&&a.append(t('<div class="format-comment">').text(l.comment).prepend('<i class="fa fa-info"></i>'))}else{c.blockedFields[i.name]=!0;let e=t('<div class="'+("button"===i.type?"link":"")+' ttm--panel-data">');if("button"!==i.type&&l.text?e.text(l.text):(c.editItem[i.name].v||"button"===i.type)&&e.append(i.getCellTextInPanel(c.editItem[i.name].v,a,c.editItem,v)),"button"!==i.type?l.icon&&e.prepend('<i class="cell-icon fa fa-'+l.icon+'"></i>'):e.find("button").is(":disabled")||a.data("input",e.find("button")),!i.unitType||-1!==["tree","select"].indexOf(i.type)&&i.multiple||""===e.text()||(i.before?e.prepend(i.unitType+" "):e.append(" "+i.unitType)),"button"===i.type&&c.pcTable){let t=!1,n=e.find("button");a.off().on("click",()=>{if(t)return;t=!0;let e=n.html();n.html('<i class="fa fa-spinner"></i>'),"insert"===this.panelType?this.pcTable.model.doAfterProcesses(()=>{this.pcTable.model.click({item:w,fieldName:i.name}).then(()=>{n.html(e),t=!1,this.refresh()})}):c.pcTable._buttonClick(a,i,r).then(()=>{i.closeIframeAfterClick?c.close():(n.html(e),t=!1,this.refresh())})})}else i.CodeActionOnClick&&!o.find(".edit-btn").length&&"add"!==g&&o.append(t('<button class="btn btn-sm btn-default edit-btn" style="width: 100%"><i class="fa fa-hand-pointer-o"></i></button>').on("click",()=>{c.pcTable.model.dblClick(r.id,i.name,w).then(e=>{})}));l.comment&&e.append(t('<div class="format-comment">').text(l.comment).prepend('<i class="cell-icon fa fa-info"></i>')),a.html(e).data("input",null)}let p="select"===i.type&&i.withPreview&&(!i.multiple||1===c.editItem[i.name].v.length);if(i.formatInPanel||p){a.find(".format-panel").remove();let e=t('<div class="format-panel">').appendTo(a),n=t('<a href=""></a>').html(App.translate("Open context data")).appendTo(e);const l=()=>{let a=t('<div class="panelView">').appendTo(e);if(p){let e=t('<div class="select-val">').appendTo(a);if(i.formatInPanel){let a=t("<div>").appendTo(e);i.pcTable.model.getPanelFormats(i.name,r.id||w).then(e=>{i.getPanelFormats(a,e.panelFormats)})}let n=t('<div class="previews loaded-preview">').appendTo(e);i.loadPreviewPanel(n,i.name,r,c.editItem[i.name].v)}else i.pcTable.model.getPanelFormats(i.name,r.id||w).then(e=>{i.getPanelFormats(a,e.panelFormats)});n.html(App.translate("Close context data")),_[i.name]=1};i.name in _&&l(),n.on("click",()=>(0===e.find(".panelView").length?l():(n.html(App.translate("Open context data")),e.find(".panelView").remove(),delete _[i.name]),!1))}return a},this.getDataForPost=function(e={}){if(this.readOnly)return c.editItem.id;let t={};return c.editItem.id&&(t.id=c.editItem.id),c.fields.forEach((function(a){let i;"insert"===c.panelType?"manual"!==e&&a.name in e&&(i=e[a.name]||c.editItem[a.name]):"manual"===e?a.name in f&&(i=c.editItem[a.name]):a.name in e&&(i=e[a.name]||c.editItem[a.name]),i?("comments"==a.type&&"string"!=typeof i.v&&(i.v=null),c.isEditable(a)&&(t[a.name]={},"edit"===c.panelType?(t[a.name].v=i.v,a.code&&!a.codeOnlyInAdd&&(t[a.name].h=i.h||!1),t[a.name].v=a.getPanelVal.call(a,t[a.name].v,c.$panel.find('div.cell[data-field-name="'+a.name+'"]').data("input"))):(t[a.name]=i.v,t[a.name]=a.getPanelVal.call(a,t[a.name],c.$panel.find('div.cell[data-field-name="'+a.name+'"]').data("input"))))):"insert"===c.panelType&&!w&&n[a.name]&&(t[a.name]=n[a.name].v)})),t},this.isEditable=function(e){if(!c.pcTable.control.editing)return!1;return!0!==t.extend({},c.pcTable.f||{},c.editItem.f||{},c.editItem[e.name].f||{}).block&&("insert"===this.panelType?e.insertable:e.editable)};const y=()=>{c.refresh()},x=e=>{let a=t("#table").data("pctable");if(a&&a.tableRow.id===e.tableRow.id&&a.tableRow.cycle_id===e.tableRow.cycle_id&&(a.editPanels||(a.editPanels=[]),a.editPanels.push(this),this.mainPanelId=a.editPanels.length-1),a!==e&&(e.isPanel=!0,c.pcTable.model.refresh=()=>{c.refresh()},e.domObject=c.bootstrapPanel),!e.control.editing){if(!r.id)return App.notify(App.translate("Adding to the table is forbidden")),!1;c.readOnly=!0,b="viewRow"}return c.pcTable.fields={...c.pcTable.fields},"checkInsertRow"===b&&(c.pcTable._insertItem=c.editItem),!0};return"object"!=typeof c.pcTable?App.getPcTableById(c.pcTable).then((function(e){c.pcTable=e,e._refreshContentTable=y,c.checkRow({},!0),c.editItem.id&&e.model.setLoadedTableData({[c.editItem.id]:{}}),x(e)})):c.pcTable[0]?App.getPcTableById(c.pcTable[0],{sess_hash:c.pcTable[1]}).then((function(e){c.pcTable[2]&&e.model.setLoadedTableData(c.pcTable[2]),c.pcTable=e,e._refreshContentTable=y,x(e)&&c.checkRow({},!0)})):x(a)&&c.checkRow({},!0),m.promise()},function(){let a,i=!1;t.extend(App.pcTableMain.prototype,{switchContainerNideScroll:function(e){let t=this;a&&clearTimeout(a),a=setTimeout(()=>{e!==i&&(e?t._container.niceScroll({cursorwidth:7,mousescrollstep:90,scrollspeed:50,autohidemode:!1,enablekeyboard:!1,cursoropacitymin:1,railoffset:{left:-3},cursorcolor:"#e1e0df"}):t._container.getNiceScroll().remove(),i=e)},100)},addScrollsRules:function(){let e=this;this._innerContainer.append(this._table),e.isMobile||(this._innerContainer.on("scroll",(function(){"use strict";e._removeEditCell()})),e.withoutScrolls||t((function(){e.switchContainerNideScroll(!0)})))},Scroll:function(){let a,i=this,n={};n.table=void 0,n.topButton=void 0;let l=!1,s=0,o=function(){let e=r();l!=(l=n.getClusterNum(e))&&n.insertToDOM(l);let a=t("table.pcTable-table");a.find("thead").height()+a.offset().top-t("#table").offset().top<=0?n.table?n.table.css({top:parseInt(t("#table").offset().top)-parseInt(t(".innerContainer").offset().top)}):function(){if(!n.table){n.table=t('<table class="scroll-head-row">').appendTo(i._innerContainer),n.table.width(i.tableWidth),n.table.append(t("table.pcTable-table thead").clone(!0)).attr("class",t("table.pcTable-table").attr("class")).addClass("scroll-table-head"),n.table.find("th.id button").remove();let e=t('<div class="btn btn-default btn-xxs "><i class="fa fa-arrow-up"></i></div>').on("click",(function(){i._container.scrollTop(i._container.find(".pcTable-rowsWrapper").offset().top-i.scrollWrapper.offset().top)}));n.table.find("th.id .pcTable-filters:first").append(e),i.isMobile||n.topButton||(n.topButton=t('<button class="scroll-top-button"><i class="fa fa-arrow-up"></i></button>').appendTo(i.RightBottomPanel).on("click",(function(){i._container.scrollTop(i._container.find(".pcTable-rowsWrapper").offset().top-i.scrollWrapper.offset().top)})))}n.table.css({position:"absolute",top:parseInt(t("#table").offset().top)-parseInt(t(".innerContainer").offset().top)})}():n.table&&(n.table.remove(),n.table=void 0,n.topButton&&(n.topButton.remove(),n.topButton=void 0),i._content.off("scroll"))},r=function(){try{if(i.isAnonim){let e=t(document).scrollTop()-i._content.offset().top;return e<0?0:-e}return i._content.offset().top}catch(e){return 0}};a=i.isAnonim?t(document):i._container,a.on("scroll",(function(e){clearTimeout(s),s=setTimeout((function(){o.call(i)}),50)}));let d={};return t.extend(n,{rows_in_block:4,item_height:35,emptyCache:function(){d={}},getClusterNum:function(e){let t;return t=e>=0?0:Math.floor(-e/this.block_height),Math.max(t,0)},reloadScrollHead:function(){n.table&&(n.table.remove(),n.table=void 0),o.call(i)},generate:function(e){let t,a,n,l,s,o=i.dataSortedVisible,r=o.length;if(r<this.rows_in_block)return{top_offset:0,bottom_offset:0,rows:o};do{t=Math.max(this.rows_in_block*e,0),a=t+this.rows_in_cluster+3*this.rows_in_block,n=Math.max(t*this.item_height,0),l=Math.max((r-a)*this.item_height,0),s=[];for(let e=t;e<a;e++)o[e]&&s.push(o[e])}while(e>0&&0===s.length&&--e>-1);return{top_offset:n,conteinerHeight:i._content.height(),i_start:t,bottom_offset:l,cluster_num:e,rows:s}},getRowsHeight:function(){0!==i.dataSortedVisible.length&&(this.block_height=this.item_height*this.rows_in_block,this.rows_in_cluster=Math.floor((e.innerHeight-i._container.offset().top)/this.item_height))},insertToDOM:function(e,t,a){if(a&&Object.keys(i.data).forEach(e=>{delete i.data[e].$tr}),i.isMobile)this.setHtml(i.dataSortedVisible,0,0,a);else{this.rows_in_cluster||this.getRowsHeight(),e||(e=this.getClusterNum(r()));let n=this.generate(e),l=n.rows.map(e=>"object"==typeof e?e.row?e.row.id:e.id||e.v:e).join(","),s=this.checkChanges("data",l,d),o=this.checkChanges("count",i.dataSortedVisible.length,d);(a||s||o)&&this.setHtml(n.rows,n.top_offset,n.bottom_offset,a),t&&i._container.getNiceScroll&&i._container.getNiceScroll().resize(),i._content.trigger("scrolled")}},setHtml:function(e,a,n,l){i._content.find(".editing").each((function(e){i._removeEditing.call(i,e)}));let s=i._content.empty().get(0);if(a?s.appendChild(t('<tr style="height: '+a+'px;" class="loading-row"><td colspan="'+(i.fieldCategories.column.length+1)+'"></td></tr>').get(0)):s.appendChild(t('<tr style="height: 0px;" class="loading-row"></tr>').get(0)),0===i.dataSorted.length)s.appendChild(i._createNoDataRow().get(0));else if(0===i.dataSortedVisible.length)s.appendChild(i._createNoDataRow(App.translate("No rows are selected by the filtering conditions")).get(0));else for(let t in e){let a=e[t];if("object"!=typeof a){let e=i.data[a];e.$tr&&!l||i._createRow.call(i,e),e.$tr.data("item",e),s.appendChild(e.$tr.get(0))}else s.appendChild(i._createTreeFolderRow.call(i,a).get(0))}n&&s.appendChild(t('<tr style="height: '+n+'px;" class="loading-row"><td colspan="'+(i.fieldCategories.column.length+1)+'"></td></tr>').get(0))},checkChanges:function(e,t,a){let i=t!=a[e];return a[e]=t,i}}),n}})}(),t.extend(App.pcTableMain.prototype,{sort:function(e,t){let a,i=this,n=e.name,l="number"===e.type,s=i.data;(i.nSorted="n"===e.name)||this._table.addClass("no-correct-n-filtered");const o=function(a,i,l,o){let r=s[a][n].f||{},d=s[i][n].f||{};if(r.textasvalue&&"text"in r||d.textasvalue&&"text"in d){if("true"===r.textasvalue?r.textasvalue=!0:"false"!==r.textasvalue&&r.textasvalue||(r.textasvalue=!1),"true"===d.textasvalue?d.textasvalue=!0:"false"!==d.textasvalue&&d.textasvalue||(d.textasvalue=!1),r.textasvalue!=d.textasvalue){if(!1===r.textasvalue)return-t;if(!1===d.textasvalue)return t;if(!0===r.textasvalue)return-t;if(!0===d.textasvalue)return t;if("str"===r.textasvalue)return t;if("str"===d.textasvalue)return-t}if(r.textasvalue&&"text"in r&&(l=r.text),d.textasvalue&&"text"in d&&(o=d.text),!0===r.textasvalue)try{let e=Big(l),a=Big(o);return e.gt(a)?t:e.eq(a)?0:-t}catch(e){}else"str"===r.textasvalue&&(l="!"+l,o="!"+o);if("string"==typeof r.textasvalue&&"num"===r.textasvalue.substr(0,3)&&"string"==typeof d.textasvalue&&"num"===d.textasvalue.substr(0,3)){let a=r.textasvalue.split("|")[1]||e.dectimalSeparator,i=d.textasvalue.split("|")[1]||e.dectimalSeparator,n=new RegExp("[^0-9\\"+a+"]","g");l=(l=l.toString().replace(n,"")).toString().replace(a,".");let s=new RegExp("[^0-9\\"+i+"]","g");o=(o=o.toString().replace(s,"")).toString().replace(i,".");try{let e=Big(l),a=Big(o);return e.gt(a)?t:e.eq(a)?0:-t}catch(e){}}return l>o?t:l==o?0:-t}return!1};if(a=l?function(e,a){let i,l,r=s[e][n].v,d=s[a][n].v,c=o(e,a,r,d);if(!1!==c)return c;let p=0;if(null===r)p=null===d?0:-t;else if(null===d)p=t;else{try{i=Big(r)}catch(e){i=Big(0)}try{l=Big(d)}catch(e){l=Big(0)}p=i.gt(l)?t:i.eq(l)?0:-t}return p}:"select"===e.type?function(a,i){let l,r;const d=function(t){let a;return s[t][n].v_?e.multiple?(a="",s[t][n].v_.forEach((function(e){a+=e[0]}))):a=s[t][n].v_[0]:a=s[t][n].v,null===a&&(a=""),a};l=d(a),r=d(i);let c=o(a,i,l,r);return!1!==c?c:l===r?0:l>r?t:-t}:function(e,a){let i,l;i=s[e][n].v+"",l=s[a][n].v+"";let r=o(e,a,i,l);return!1!==r?r:i>l?t:i==l?0:-t},i.isTreeView)if("tree"!==n&&"self"!==i.fields.tree.treeViewType){let e=[],t=[...i.dataSorted];i.dataSorted=[];const n=()=>{e.length&&(e=e.sort(a),i.dataSorted.push(...e),e=[])};t.forEach(t=>{"object"==typeof t?(n(),i.dataSorted.push(t)):e.push(t)}),n()}else{let e=(e,a)=>{let n=i.treeIndex[e].t||"",l=i.treeIndex[a].t||"";return n===l?0:n>l?t:-t};"tree"!==n&&(e=(e,t)=>a(i.treeIndex[e].row.id,i.treeIndex[t].row.id));const l=t=>{let a=i.treeIndex[t];a.trees=a.trees.sort(e),a.trees.forEach(l)};i.treeSort=i.treeSort.sort(e),i.treeSort.forEach(l),i.treeApply()}else i.dataSorted=i.dataSorted.sort(a);i.dataSortedVisible=[];for(let e=0;e<this.dataSorted.length;e++){let t=this.dataSorted[e];if("object"==typeof t)i.dataSortedVisible.push(t);else{let e=this.data[t];this.__applyFiltersToItem(e),e.$visible&&i.dataSortedVisible.push(t)}}i._refreshContentTable()}}),App.pcTableMain.prototype.isSelected=function(e,t){return!(!this.selectedCells||!this.selectedCells.ids[e]||-1===this.selectedCells.ids[e].indexOf(t))},App.pcTableMain.prototype.getSelectPanel=function(a,i,n){let l=this,s=l.selectedCells;s.selectPanelDestroy();let o=t('<div id="selectPanel" class="text">').on("click contextmenu",e=>{e.stopPropagation()});switch(a.contextPanelWidth){case"wide":case"extrawide":o.addClass("panel-"+a.contextPanelWidth)}let r=i[a.name],d=t.extend({},l.f||{},i.f||{},r.f||{}),c=t('<div class="column-name"></div>').text(d.fieldtitle&&a.name in d.fieldtitle?d.fieldtitle[a.name]:a.title);a.unitType&&c.append(", "+a.unitType),o.append(c),"text"===a.type&&c.append(", "+a.textType),o.append(c);let p="";if("column"===a.category){p='<span class="id-val">['+i.id+"]</span>"+l._getRowTitleByMainField(i," %s");let e=t('<div class="row-name"></div>').html(p);o.append(e)}let h=t('<div id="selectPanelBig">'),f=t('<div class="field-value"><div class="copytext-wrapper"><div class="copytext"></div></div></div>').css("white-space","pre-wrap");l.isMobile?f.height("auto").css("min-height",40):f.height(200),h.append(f).appendTo(o);let u=f.find(".copytext");!a.unitType||null===r.v||-1!==["select","tree"].indexOf(a.type)&&a.multiple||(a.before?u.attr("data-unit-before",a.unitType):u.attr("data-unit",a.unitType));let m,b=d.textasvalue&&"text"in d;if(d.text&&(m=t('<div class="sp-element"><i class="fa fa-font"></i> </div>').append(d.text),b&&m.hide(),f.prepend(m)),d.comment&&f.prepend(t('<div class="sp-element"><i class="fa fa-info"></i> </div>').append(d.comment)),r.h&&!1!==d.showhand)if(void 0!==r.c){let e="";if(r.c_)if(a.multiple&&r.c_.forEach){r.c_.forEach(a=>{e&&(e+=", "),a[1]?e+=t('<span class="deleted_value">').text(a[0]).get(0).outerHTML:e+=t('<span class="value">').text(a[0]).get(0).outerHTML});let a=20,i=0,n=!1,l=!1,s=!1,o=e,d=0;for(;d<a||n;){switch(o[i]){case"<":l=!0,n=!0;break;case"/":l&&(s=!0);break;case">":n&&l&&s&&(s=!1,n=!1),l=!1;break;default:l||d++}i++}if(i<o.length){e=o.substr(0,i)+"...",e+=" ";let a=t('<button class="btn btn-default btn-xxs"><i class="fa fa-eye"></i></button>').on("click",()=>{App.notify(o,App.translate("Calculated value"))});e=t("<div>").html(e),e.append(a)}}else e=r.c_[0],e=r.c_[1]?t('<span class="deleted_value">').text(e):t('<span class="value">').text(e);else e=r.c;f.append(t('<div class="calc-value"><i class="fa fa-hand-paper-o"></i> '+App.translate("Calculated value")+": </div>").append(e))}else f.append('<div class="calc-value"><i class="fa fa-hand-grab-o pull-left"></i> '+App.translate("Same as calculated")+"</div>");let g,w=t('<div><div class="center"><i class="fa fa-spinner fa-spin"></i></div></div>');if(a.formatInPanel&&(f.append(w),w.data("loadFormats",(function(){a.pcTable.model.getPanelFormats(a.name,i.id).then(e=>{a.getPanelFormats(w,e.panelFormats)})}))),a.selectTable)if(a.changeSelectTable){let e=t('<div><div class="center"></div></div>');if(a.multi){if(r.v&&r.v.length){let n=t('<button class="btn btn-default btn-xxs"></button>').text(App.translate("Edit")).on("click",()=>{a.sourceButtonClick(i)});e.append(t('<div class="panel-buttons">').append(n)).appendTo(f)}}else if(r.v&&!r.v_[1]){let n=t('<button class="btn btn-default btn-xxs"></button>').text(App.translate("Edit")).on("click",()=>{a.sourceButtonClick(i).then(e=>{e&&e.json&&e.json.updated&&l.model.refresh()})});e.append(t('<div class="panel-buttons">').append(n)).appendTo(f)}}else if(a.viewSelectTable){let e=t('<div><div class="center"></div></div>');if(a.multi){if(r.v&&r.v.length){let n=t('<button class="btn btn-default btn-xxs"></button>').text(App.translate("View")).on("click",()=>{a.sourceButtonClick(i)});e.append(t('<div class="panel-buttons">').append(n)).appendTo(f)}}else if(r.v&&!r.v_[1]){let n=t('<button class="btn btn-default btn-xxs"></button>').text(App.translate("View")).on("click",()=>{a.sourceButtonClick(i).then(e=>{e&&e.json&&e.json.updated&&l.model.refresh()})});e.append(t('<div class="panel-buttons">').append(n)).appendTo(f)}}let v,_=t('<div class="buttons"></div>'),y=[];if(g=t('<button class="btn btn-sm btn-default copy_me" disabled data-copied-text="'+App.translate("Copied")+'" title="'+App.translate("Copy")+' "><i class="fa fa-copy"></i></button>'),g.on("click",(function(){u.data("text")?App.copyMe(u.data("text")):App.copyMe(u.text());let e=t(this);return e.width(e.width()),e.button("copied"),setTimeout((function(){e.button("reset")}),1e3),e.blur(),!1})),_.append(g),n.is(".edt, .panel-edt")){y.push({label:'<i class="fa fa-pencil-square-o"></i>',action:function(e){e.close(),n.dblclick()}});let e=t('<button class="btn btn-sm btn-default"><i class="fa fa-pencil-square-o"></i></button>').appendTo(_);"panels"===l.viewType?e.on("click",(function(){l.editSingleFieldInPanel(a,i.id).then(e=>{e&&l.table_modify(e)}).catch(e=>{console.log(e)}),s.selectPanelDestroy()})):e.on("click",(function(){return n.dblclick(),s.selectPanelDestroy(),!1}))}if("column"===a.category&&a.filterable&&(l.isValInFilters.call(l,a.name,i)?(y.push({label:'<i class="fa fa-filter" style="color: #ffe486"></i>',action:function(e){s.selectPanelDestroy(),l.removeValueFromFilters.call(l,a.name,i),e.close()}}),t('<button class="btn btn-sm btn-warning" title="'+App.translate("Remove from the filter")+'"><i class="fa fa-filter"></i></button>').on("click",(function(){return s.selectPanelDestroy(),l.removeValueFromFilters.call(l,a.name,i),!1})).appendTo(_)):(y.push({label:'<i class="fa fa-filter"></i>',action:function(e){s.selectPanelDestroy(),l.addValueToFilters.call(l,a.name,i),l._container.scrollTop(l._filtersBlock.offset().top-l.scrollWrapper.offset().top),l.ScrollClasterized.insertToDOM.call(l.ScrollClasterized,0),e.close()}}),t('<button class="btn btn-sm btn-default" title="'+App.translate("Add to the filter")+'"><i class="fa fa-filter"></i></button>').on("click",(function(){return s.selectPanelDestroy(),l.addValueToFilters.call(l,a.name,i),l._container.scrollTop(l._filtersBlock.offset().top-l.scrollWrapper.offset().top),l.ScrollClasterized.insertToDOM.call(l.ScrollClasterized,0),!1})).appendTo(_))),!l.isMobile){let n=t('<button class="btn btn-sm btn-default"><i class="fa fa-expand" style="padding-top: 3px;" aria-hidden="true"></i></button>');n.on("click",(function(){h.addClass("select-panel-expanded"),h.find(".field-value").height(""),h.find(".panel-img img").each((e,a)=>{(a=t(a)).attr("src",a.attr("src").replace("_thumb.jpg?","?"))}),e.top.BootstrapDialog.show({message:h,type:null,title:c.text()+(p?" / "+p:""),cssClass:"fieldparams-edit-panel",draggable:!0,onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"}),s.selectPanelDestroy()},onshown:function(t){t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top}),h.find(".field-value div.codeEditor").trigger("panel-resize")}})})),_.append(n),"tmp"!==l.tableRow.type&&a.logButton&&(y.push({label:App.translate("Log"),action:function(e){let t;l.mainFieldName&&i.id&&(t=i[l.mainFieldName].v),l.model.getFieldLog(a.name,i.id,t),e.close()}}),t('<button class="btn btn-sm btn-default" title="'+App.translate("Log of field manual changes")+'">'+App.translate("Log")+"</button>").on("click",(function(){let e;l.mainFieldName&&i.id&&(e=i[l.mainFieldName].v),l.model.getFieldLog(a.name,i.id,e);let n=t(this).addClass("disabled");return setTimeout((function(){n.removeClass("disabled")}),1e3),!1})).appendTo(_)),t('<button class="btn btn-sm btn-default" title="'+App.translate("Close the panel")+'"><i class="fa fa-times"></i></button>').on("click",(function(){return s.selectPanelDestroy(),!1})).appendTo(_)}let x=null;if(b?"listRow"===a.type?(v=t.Deferred(),a.getValue(r.v,i,!0).then(e=>{a.isPanelTextAsTable(e.value)?(x=e.value,v.resolve(a.getPanelText(r.v,o,i,f)),m.show().find("i").remove()):v.resolve(d.text)})):v=d.text:v=a.getPanelText(r.v,o,i,f),"select"!==a.type||!a.withPreview||!r.v||a.multiple&&1!==r.v.length)w.data("loadFormats")&&w.data("loadFormats")();else{let e=t('<div class="previews">').appendTo(f);a.loadPreviewPanel(e,a.name,i,r.v).then((function(){w.data("loadFormats")&&w.data("loadFormats")()}))}if(l.isCreatorView&&(f.append(t('<div class="creator-select-val">')),(-1!==["select","tree","date"].indexOf(a.type)||b)&&f.find(".creator-select-val").text(JSON.stringify(r.v)),r.h&&"showhand"in d&&!0!==d.showhand))if(void 0!==r.c){let e="";if(r.c_)if(a.multiple&&r.c_.forEach){r.c_.forEach(a=>{e&&(e+=", "),a[1]?e+=t('<span class="deleted_value">').text(a[0]).get(0).outerHTML:e+=t('<span class="value">').text(a[0]).get(0).outerHTML});let a=20,i=0,n=!1,l=!1,s=!1,o=e,d=0;for(;d<a||n;){switch(o[i]){case"<":l=!0,n=!0;break;case"/":l&&(s=!0);break;case">":n&&l&&s&&(s=!1,n=!1),l=!1;break;default:l||d++}i++}if(i<o.length){e=o.substr(0,i)+"...",e+=" ";let a=t('<button class="btn btn-default btn-xxs"><i class="fa fa-eye"></i></button>').on("click",()=>{App.notify(o,App.translate("Calculated value"))});e=t("<div>").html(e),e.append(a)}}else e=r.c_[0],e=r.c_[1]?t('<span class="deleted_value">').text(e):t('<span class="value">').text(e);else e=r.c;f.find(".creator-select-val").append(t('<div class="calc-value"><i class="fa fa-hand-paper-o"></i> '+App.translate("Calculated value")+": </div>").append(e))}else f.find(".creator-select-val").append('<div class="calc-value"><i class="fa fa-hand-grab-o pull-left"></i> '+App.translate("Same as calculated")+"</div>");const k=function(e){u.text(e),g.prop("disabled",!1)},C=function(e,t){u.html(e),e.data("text")?u.data("text",e.data("text")):u.data("text",t),g.prop("disabled",!1)},T=function(e){if("object"==typeof e&&null!==e)if(e instanceof jQuery){let a="";e.copyText?C(e,e.copyText):(e.each((function(){""!==a&&(a+="\n"),a+=t(this).text()})),""===a&&(a=e.text()),C(e,a))}else e.then?e.then(T):k(JSON.stringify(e));else k(e)};if(T(v),l.isCreatorView){let e;l.LOGS&&(e=l.LOGS,i&&i.id&&(e=l.LOGS[i.id]),e&&(e=e[a.name]));let n=t('<div style="padding-top: 10px">');if(e&&e.c){let a=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> c</i></button>');a.on("click",(function(){App.logOutput(e.c)})),n.append(a)}if(e&&e.s){let a=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> s</i></button>');a.on("click",(function(){App.logOutput(e.s)})),n.append(a)}if(e&&e.a){let a=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> a</i></button>');a.on("click",(function(){App.logOutput(e.a)})),n.append(a)}if(e&&e.f){let a=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> f</i></button>');a.on("click",(function(){App.logOutput(e.f)})),n.append(a)}n.children().length&&_.append(n)}if(l.isMobile||o.append(_),r.e&&f.append(t('<div style="padding-top: 5px;">').html(t("<span>").text(r.e).text().replace(/\[\[(.*?)\]\]/g,"<b>$1</b>"))),l.isMobile)s.mobilePanelDialog=App.mobilePanel(c,o,{buttons:y});else{let e="right",t=n.offset().left,a=l._container.offset().left,i=240,s=l._container.width()-(t-a)-n.outerWidth();o.is(".text")&&(i=340),o.is(".panel-wide")&&(i=440),o.is(".panel-extrawide")&&(i=540),s<i&&(e="left",n.offset().left-a<i&&(e="bottom"));let r={isParams:!0,$text:o,element:n,container:l._container,placement:e,trigger:"manual"};App.popNotify(r)}return l.closeCallbackAdd(()=>{s.selectPanelDestroy()},"selectPanelDestroy",20),n},App.pcTableMain.prototype._addSelectable=function(){var a=this;a.selectedCells={movingSelection:!1,fieldName:null,ids:{},notRowCell:null,times:null,lastSelected:null,applyPointing:function(e){let t=a.startPointing;if(!t)return;let i=a.fields[t];if(i){if("footer"===i.category&&i.column)return!1;if("column"===i.category){if(!a.isTreeView&&a.tableRow.pagination&&"0/0"!==a.tableRow.pagination){if("pageLoaded"==e){let e=a._getTdByFieldName(t,a.data[a.dataSorted[0]].$tr);a.selectedCells.click(e,"force")}}else if(a.dataSorted.length){let e=a._getTdByFieldName(t,a.data[a.dataSorted[0]].$tr);a.selectedCells.click(e,"force")}}else{let e=a._container.find('[data-field="'+t+'"]');a.selectedCells.click(e,"force"),a.startPointing=null}}},isAnySelectedCells:function(){return!(!this.notRowCell&&!Object.keys(this.ids).length)},isMultySelectedCells:function(){return!this.notRowCell&&!!Object.keys(this.ids).length&&(Object.keys(this.ids).length>1||this.ids[Object.keys(this.ids)[0]].length>1)},getOneSelectedCell:function(){let e=Object.keys(this.ids);return 1===e.length&&1===this.ids[e[0]].length&&a.data[this.ids[e[0]][0]].$tr?a._getTdByFieldName(e[0],a.data[this.ids[e[0]][0]].$tr):!!this.notRowCell&&this.notRowCell},notRowCellEmpty:function(){if(this.notRowCell){this.notRowCell.removeClass("selected");let e=this.notRowCell.closest(".DataRow");1===e.length&&e.removeClass("selected"),this.notRowCell=null}},empty:function(e){if("column"!==e&&this.notRowCellEmpty(),!e||"column"===e){let e=this;Object.keys(this.ids).forEach((function(t){e.ids[t].forEach((function(e){let t=a._getItemById(e);t&&t.$tr&&(t.$tr.find(".selected").removeClass("selected"),t.$tr.removeClass("selected"))}))})),this.ids={},this.lastSelected=null}this.summarizer.check()},selectColumn:function(e){a.dataSortedVisible.forEach(t=>{"object"!=typeof t?this.add(t,e,!0):t.row&&this.add(t.row.id,e,!0)}),this.summarizer.check(),this.multiCheck()},getEditedData:function(e,i){let n=t.Deferred(),l={},s=!1;Object.keys(a.selectedCells.ids).length>1&&(s=!0);let o=[];return Object.keys(a.selectedCells.ids).forEach((function(t){a.selectedCells.ids[t].forEach((function(n){let r=a.data[n],d=r[t].f?r[t].f.block:void 0;if(!(r.f.block&&!1!==d||d)&&a.fields[t].editable&&a.fields[t].editGroup&&(!s||a.fields[t].editGroupMultiColumns))if(l[n]||(l[n]={}),i)if(a.fields[t].getValue){let e=a.fields[t].getValue(r[t].v,r,!0);o.push(e),e.done((function(e){l[n][t]=e.value}))}else l[n][t]=r[t].v;else l[n][t]=e}))})),t.when(...o).then(()=>{n.resolve(l)}),i?n:l},removeId:function(e){Object.keys(this.ids).forEach(t=>{let i=[];this.ids[t].forEach(t=>{e!=t?i.push(t):a.data[e].$tr&&a.data[e].$tr.find(".selected").removeClass("selected")}),this.ids[t]=i})},remove:function(e,t){let i=this;if(!this.ids[t])return;let n={};this.ids[t].some((function(a,l){if(a==e)return i.ids[t].splice(l,1),0===i.ids[t].length&&delete i.ids[t],n[e]=!0,!0})),Object.keys(n).forEach((function(e){let t=!1;Object.keys(i.ids).some((function(a){if(-1!==i.ids[a].indexOf(parseInt(e)))return t=!0,!0})),t||a.data[e].$tr&&a.data[e].$tr.removeClass("selected")}))},add:function(e,t,i){this.ids[t]||(this.ids[t]=[]),this.ids[t].push(e),a.data[e]&&a.data[e].$tr&&(a.data[e].$tr.addClass("selected"),i&&a._getTdByFieldName(t,a.data[e].$tr).addClass("selected"))},selectPanelDestroy:function(){let e=this;a.closeCallbackRemove("selectPanelDestroy"),e.selectPanel&&(e.selectPanel.attr("aria-describedby")?e.selectPanel.popover("destroy"):this.mobilePanelDialog&&(e.mobilePanelDialog.close(),e.mobilePanelDialog=null),e.selectPanel=null),t("body").off(".selectPanelDestroy")},checkIfShowPanel:function(e){"use strict";if(this.selectPanelDestroy(),e){let t,i=a._getFieldBytd(e);t="column"===i.category?a._getItemBytd(e):a.data_params,this.selectPanel=a.getSelectPanel.call(a,i,t,e)}return!1},copySepected:function(e,a,i){let n,l=this,s=[],o=[],r={},d=[],c={},p={};i&&i.forEach((e,t)=>{"object"==typeof e&&("dates-format"===e[0]?p.date=e[1]:"number-format"===e[0]&&(p.dectimal=e[1]))});let h=[],f={...l.model,getValue:e=>{let a=[t.Deferred(),e];return h.push(a),a[0]}};const u=(e,a)=>{let i;i=a?l.data[a]||{}:l.data_params||{};let n=t.extend({},l.f||{},i.f||{},i[e].f||{}),s=n.textasvalue&&"text"in n?n.text:(e=>{let t={...e,pcTable:{...e.pcTable,model:f}};return p.date&&"date"===t.type?t.dateTime?t.dateFormat=p.date+"H:i":t.dateFormat=p.date:p.dectimal&&"number"===t.type&&(t.dectimalSeparator=p.dectimal,t.currency=!0),t})(l.fields[e]).getCopyText(i[e],i);"object"==typeof s&&null!==s&&s.done?(d.push(s),s.done((function(t){a?r[a][e]=t:r[e]=t}))):a?r[a][e]=s:r[e]=s};let m={params:"param",filters:"filter","column-footers":"footer","other-footers":"footer"};if(i&&-1===i.indexOf("from-selection")?["params","filters","rows","column-footers","other-footers"].forEach(e=>{i.some(t=>t===e)&&("rows"===e?(n=-1!==i.indexOf("with-id"),l.fieldCategories.visibleColumns.forEach(e=>{c[e.name]=[],l.dataSortedVisible.forEach(t=>{c[e.name].push(t)})})):l.fieldCategories[m[e]].forEach(t=>{if(!t.hidden&&t.showMeWidth)switch(e){case"column-footers":t.column&&u(t.name);break;case"other-footers":t.column||u(t.name);break;default:u(t.name)}}))}):(c=l.selectedCells.ids,n=e,i=["rows"]),c){Object.keys(c).forEach((function(e){let t=c[e];s=s.concat(t),o.push(e),t.forEach((function(t){r[t]||(r[t]={}),u(e,t)}))})),s=Array.from(new Set(s)),s=l.dataSortedVisible.filter(e=>-1!==s.findIndex(t=>t==e)),o=Array.from(new Set(o));let e=[];l.fieldCategories.visibleColumns.forEach((function(t){-1!==o.indexOf(t.name)&&e.push(t.name)})),o=e}const b=function(e){return null==e&&(e=""),"object"==typeof e&&(e=JSON.stringify(e)),e};if(h.length){let e=[];h.forEach(t=>{e.push(t[1])}),function(e){return this.__ajax("post",{data:e,method:"getValuePack"})}.call(l.model,e).then(e=>{e.values&&e.values.forEach&&e.values.forEach((e,t)=>{h[t][0].resolve(e)})})}let g=t.Deferred();return t.when(...d).done((function(){let t=[];if(["params","filters","rows","column-footers","other-footers"].forEach(a=>{if(i.some(e=>e===a))switch(a){case"rows":if(e){t.push([]);let e=t.length-1;n&&(t[e]=["id"]),o.forEach((function(a){let i=l.__getCellTitle(l.fields[a]);t[e].push(i)}))}s.forEach((function(e){t.push([]);let a=t.length-1;n&&t[a].push(e),o.forEach((function(i){t[a].push(b(r[e][i]))}))}));break;case"column-footers":let i={};l.fieldCategories.footer.forEach(e=>{!e.hidden&&e.showMeWidth&&e.column&&-1!==o.indexOf(e.column)&&(i[e.column]=i[e.column]||[],i[e.column].push(e.name))});let d=!1;for(;Object.keys(i).length;){e&&(d=!d),t.push([]);let a=t.length-1;n&&t[a].push(""),o.forEach((function(e){i[e]?d?t[a].push(l.__getCellTitle(l.fields[e])):(t[a].push(b(r[i[e][0]])),1===i[e].length?delete i[e]:i[e].splice(0,1)):t[a].push("")}))}break;default:l.fieldCategories[m[a]].forEach(i=>{if(!i.hidden&&i.showMeWidth&&("footer"!==m[a]||!i.column)){t.push([]);let a=t.length-1;e&&t[a].push(l.__getCellTitle(i)),t[a].push(b(r[i.name]))}})}}),a)a(t);else{let e="";t.forEach(t=>{""!==e&&(e+="\n"),t.forEach((a,i)=>{0!==i&&(e+="\t"),"string"==typeof a&&a.replace(/\t/g,"").match(/[\s"]/)&&1!==t.length&&(a='"'+a.replace(/"/g,'""')+'"'),e+=a})}),App.copyMe(e),g.resolve()}})),g},click:function(e,i){let n,l=a._table;return!e.closest("table").is(".pcTable-filtersTable")&&(!0===l.data("moved")?(l.data("moved",!1),!1):"force"===i?(a.selectedCells.empty(),void a.selectedCells.click(e,{})):i.originalEvent&&(n=i.originalEvent.path?i.originalEvent.path[0]:i.originalEvent.target,n&&t(n).is(".asUrl"))?(a.actionOnClick(e),!1):((()=>{if(e.is(".val"))return this.notRowCell&&-1!==this.notRowCell.index(e)?a.selectedCells.empty():(a.selectedCells.empty(),this.notRowCell=e,this.notRowCell.addClass("selected")),void t("table.pcTable-table").removeClass("selected-multi").removeClass("selected-column");this.notRowCellEmpty();let n=e.closest("tr"),l=a._getItemByTr(n),s=a._fieldByTd(e,n),o=s.name;if(i.altKey)e.is(".selected")?(a.selectedCells.remove(l.id,o),e.removeClass("selected")):(a.selectedCells.add(l.id,o),e.addClass("selected"),this.lastSelected=[o,l.id]);else if(i.shiftKey&&Object.keys(a.selectedCells.ids).length){let e=this,t=[],i="before";a.dataSortedVisible.some((function(a){if(a="object"==typeof a&&a.row?a.row.id:parseInt(a),"before"===i){if((a===l.id||a===e.lastSelected[1])&&(i="doIt",t.push(a),l.id===e.lastSelected[1]))return!0}else if("doIt"===i&&(t.push(a),a===l.id||a===e.lastSelected[1]))return!0})),i="before";let n=function(i){t.forEach((function(t){let n=a.data[t];a.isSelected(i.name,t)||(e.add(t,i.name),n.$tr&&a._getTdByFieldName(i.name,n.$tr).addClass("selected"))}))};a.fieldCategories.column.some((function(t){if(t.showMeWidth>0)if("before"===i){if((t.name===o||t.name===e.lastSelected[0])&&(i="doIt",n(t),o===e.lastSelected[0]))return!0}else if("doIt"===i&&(n(t),t.name===o||t.name===e.lastSelected[0]))return!0})),this.lastSelected=[o,l.id]}else{let t=a.isSelected(s.name,l.id);a.selectedCells.empty(),t||(a.selectedCells.add(l.id,o),e.addClass("selected"),this.lastSelected=[o,l.id])}a.selectedCells.multiCheck()})(),void this.summarizer.check()))},multiCheck:()=>{let e=Object.keys(a.selectedCells.ids);e.length>1?t("table.pcTable-table").addClass("selected-multi"):1===e.length&&Object.values(a.selectedCells.ids)[0].length>1?t("table.pcTable-table").removeClass("selected-multi").addClass("selected-column"):t("table.pcTable-table").removeClass("selected-multi").removeClass("selected-column"),a.RightBottomServicesButtonRefresh()},summarizer:{timeout:null,element:t('<div class="summarizer"><span></span> : <span></span></div>'),status:0,check:()=>{if(!a.isMobile)try{let e,t=Object.keys(a.selectedCells.ids);if(t.length){let i=t.every(t=>(e?a.fields[t].dectimalPlaces&&a.fields[t].dectimalPlaces>e.dectimalPlaces&&(e=a.fields[t]):e=a.fields[t],"number"===a.fields[t].type||a.selectedCells.ids[t].every(e=>{if(a.data[e][t].f&&a.data[e][t].f.textasvalue&&"string"==typeof a.data[e][t].f.textasvalue&&a.data[e][t].f.textasvalue.match(/^num/))return!0}))),n=0,l=Big(0);const s=function(e){return(e.toString().match(/^\s*-/)?"-":"")+e.toString().replace(/[^\d.]/g,"")};t.forEach(e=>{a.selectedCells.ids[e].forEach(t=>{if(n++,i)if(a.data[t][e].f&&a.data[t][e].f.textasvalue&&"string"==typeof a.data[t][e].f.textasvalue&&a.data[t][e].f.textasvalue.match(/^num/)){if(null!==a.data[t][e].f.text&&""!==a.data[t][e].f.text){let i=a.data[t][e].f.textasvalue.split("|")[1]||e.dectimalSeparator||".";l=l.plus(s(a.data[t][e].f.text.replace(i,".")))}}else null!==a.data[t][e].v&&(l=l.plus(s(a.data[t][e].v)))})});let o=a.selectedCells.summarizer.element.find("span");o[1].innerHTML=i?App.numberFormat(l.toString(),e.dectimalPlaces||0,"."):"-",o[0].innerHTML=n,a.selectedCells.summarizer.status||(a.selectedCells.summarizer.status=1,a.selectedCells.summarizer.timeout=setTimeout(()=>{this.RightBottomServicesButton.isAttached()?a.selectedCells.summarizer.element.insertBefore(this.RightBottomServicesButton):a.selectedCells.summarizer.element.prependTo(this.RightBottomPanel)},1e3))}else a.selectedCells.summarizer.empty()}catch(e){return console.log(e),void a.selectedCells.summarizer.empty()}},empty:()=>{a.selectedCells.summarizer.status&&(a.selectedCells.summarizer.status=0,a.selectedCells.summarizer.timeout&&clearTimeout(a.selectedCells.summarizer.timeout),a.selectedCells.summarizer.element.detach())}}},this._container.on("contextmenu",".DataRow td:not(.editing,.n,.id), td.val:not(.editing)",(function(e){let i=t(this);return a.selectedCells.selectPanel&&a.selectedCells.selectPanel.closest("td")[0]==i[0]?a.selectedCells.selectPanelDestroy():(a.selectedCells.selectPanelDestroy(),a.selectedCells.empty(),a.selectedCells.checkIfShowPanel(i),a.selectedCells.click(i,{})),!1})),this._container.on("click",".DataRow td:not(.editing,.id,.n), td.val:not(.editing), .pcTable-buttons .cell-button",(function(i){if("file-image-preview"===i.target.className){let t=JSON.parse(i.target.getAttribute("data-fileviewpreview"));e.top.BootstrapDialog.show({title:t.name,message:'<div class="file-image-big"><img src="/fls/'+t.file+'" style="max-width: 100%; max-height: 100%"/></div>',type:null,draggable:!0})}else{if(i.target.className.match(/file-pdf-preview/))return Math.random(),e.open(i.target.getAttribute("data-filename")),!1;{let e=t(this);if(e.is(".edt.val:not(.editing)")&&"filter"===a._getFieldBytd(e).category)return void a._createEditCell.call(a,e,!0);if(e.is(".cell-button")&&!e.find("button.button-field").is(":disabled")){let t=a._getFieldBytd(e);return a._buttonClick.call(a,e,t),!1}e.data("clicked")?e.removeData("clicked"):(e.data("clicked",1),setTimeout((function(){e.data("clicked")&&(e.removeData("clicked"),a.selectedCells.click(e,i))}),200))}}})),this._container.on("click","th.id .for-selected button",(function(){let e=t(this),i=e.html();e.html('<i class="fa fa-spinner fa-spin"></i>'),a.selectedCells.copySepected.call(a,e.data("names")).then((function(){e.html('<i class="fa fa-check"></i>'),setTimeout(()=>{e.html(i)},300)}))})),t("body").on("keyup",i=>{if(top.window===e&&BootstrapDialog.getTopDialog())return void(BootstrapDialog.getTopDialog().$modalBody.find("iframe").length&&BootstrapDialog.getTopDialog().$modalBody.find("iframe")[0].contentWindow.$("body").trigger(i));if(t(i.target).closest(".dropdown-menu").length)return;if(this._container.find("iframe:visible").length||this._container.find(".editing:first").length||this._container.find(".InsertRow:first").length||t(".modal-backdrop:first").length)return;let n=this._container.find(".pcTable-scrollwrapper"),l=a.selectedCells.getOneSelectedCell();if(!l&&i.shiftKey&&-1!==["ArrowLeft","ArrowRight","ArrowDown","ArrowUp"].indexOf(i.key)){let e,n=a.dataSorted.length?a._innerContainer:t();switch(n=n.add(a._paramsBlock).add(a._footersSubTable),i.key){case"ArrowRight":case"ArrowDown":e=n.find("td:not(.id,.n):first").first();break;case"ArrowLeft":case"ArrowUp":e=n.find("td:not(.id,.n):last").last()}e&&e.length&&a.selectedCells.click(e,"force")}if(n.height()>this._container.height()){let e=null;switch(i.code){case"Home":e=0;break;case"End":e=n.height();break;case"PageDown":e=this._container.scrollTop()+this._container.height()-120;break;case"PageUp":e=this._container.scrollTop()-this._container.height()+120;break;case"ArrowUp":l.length||(e=this._container.scrollTop()-100);break;case"ArrowDown":l.length||(e=this._container.scrollTop()+100)}if(null!==e)return e=e<0?0:e,e=e>n.height()?n.height():e,void this._container.scrollTop(e)}if(l){let e;if(i.shiftKey&&-1!==["ArrowLeft","ArrowRight","ArrowDown","ArrowUp"].indexOf(i.key)){const t=function(e,i){let n,l=["param","column","footer"],s=l.indexOf(e)+i;if(l[s]){switch(l[s]){case"column":a.dataSorted.length&&(n=a._innerContainer);break;case"param":n=a._paramsBlock;break;case"footer":n=a._footersSubTable}return n?n.find("td:not(.id,.n,.footer-empty)"+(1===i?":first":":last")+":visible"):t(l[s],i)}};let n;if(l.closest(".DataRow").length?n="column":l.closest(a._paramsBlock).length?n="param":l.closest(a._footersSubTable).length&&(n="footer"),n){switch(i.key){case"ArrowLeft":case"ArrowUp":e=t(n,-1);break;case"ArrowRight":case"ArrowDown":e=t(n,1)}e&&e.length&&a.selectedCells.click(e,"force")}}else switch(i.key){case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":if(l.closest(".DataRow").length)switch(i.key){case"ArrowUp":e=l.closest("tr").prev().find("td").get(l.closest("tr").find("td").index(l));break;case"ArrowDown":e=l.closest("tr").next().find("td").get(l.closest("tr").find("td").index(l));break;case"ArrowRight":e=l.next();break;case"ArrowLeft":e=l.prev()}else{let t=a._getFieldBytd(l);switch(i.key){case"ArrowUp":case"ArrowLeft":if("param"===t.category){let i=[];a.fieldCategories.param.some((n,l)=>{if(n.name==t.name)return i.length&&(i.reverse(),i.some(t=>{if(e=a._paramsBlock.find('[data-field="'+t+'"]'),e.is(":visible"))return!0;e=null})),!0;i.push(n.name)})}else if("footer"===t.category){if(t.column)return;let i=[];a.fieldCategories.footer.some((n,l)=>{if(!n.column)return n.name==t.name?(i.length&&(i.reverse(),i.some(t=>{if(e=a._footersSubTable.find('[data-field="'+t+'"]'),e.is(":visible"))return!0;e=null})),!0):void i.push(n.name)})}break;case"ArrowDown":case"ArrowRight":let i=!1;if("param"===t.category)a.fieldCategories.param.some((n,l)=>{if(i){if(e=a._paramsBlock.find('[data-field="'+n.name+'"]'),e.is(":visible"))return!0;e=null}n.name==t.name&&(i=!0)});else if("footer"===t.category){if(t.column)return;a.fieldCategories.footer.some((n,l)=>{if(!n.column){if(i){if(e=a._footersSubTable.find('[data-field="'+n.name+'"]'),e.is(":visible"))return!0;e=null}n.name==t.name&&(i=!0)}})}}}e&&(e=t(e))&&e.length&&(e.is(".id,.n")||a.selectedCells.click(e,i));break;case"Enter":i.shiftKey&&!a.selectedCells.movingSelection?l.is(".edt")?(l.trigger("dblclick"),setTimeout(()=>{let e=l.find('input[type="text"]');e.length&&e.get(0).select()})):l.is(".cell-button")&&l.find(".button-field").click():i.ctrlKey&&(l.is(".edt")?l.trigger("dblclick"):l.is(".cell-button")&&l.find(".button-field").click());break;case" ":l.is(".edt")&&l.trigger("dblclick")}}})},App.pcTableMain.prototype.filters={},App.pcTableMain.prototype.__getFilterButton=function(e){var a="btn-default";(this.filters[e]&&this.filters[e].length||this.filters[e+"/h"])&&(a="btn-warning");var i=t('<button class="btn btn-xxs btn-filter"><span class="fa fa-filter"></span></button>').addClass(a);return t('<span class="filter-in-head">').append(i)},App.pcTableMain.prototype.filtersEmpty=function(){this.filters={},this._refreshHead(),this.__applyFilters()},App.pcTableMain.prototype.sessionStorageFilters={url:location.protocol+"//"+location.host+location.pathname,setFilters:function(e){let t={};e=e||{};try{t=JSON.parse(sessionStorage.getItem("pcTableFilters"))||{}}catch(e){}t[this.url]=e,sessionStorage.setItem("pcTableFilters",JSON.stringify(t))},getFilters:function(){let e={};try{e=JSON.parse(sessionStorage.getItem("pcTableFilters")),e=e[this.url]||{}}catch(e){}return e}};let c=!0;App.pcTableMain.prototype.__applyFilters=function(e=!1,t=!1){let a=this;App.fullScreenProcesses.show(),this.filtersClearButton&&("tmp"!==a.tableRow.type&&this.sessionStorageFilters.setFilters(this.filters),Object.equals(this.filters,{})?this.filtersClearButton.addClass("btn-default").removeClass("btn-warning").attr("disabled",!0):(this.filtersClearButton.removeClass("btn-default").addClass("btn-warning").removeAttr("disabled"),c&&App.blink(a.filtersClearButton,8,"#fff")),c=!1);let i=[];this.isTreeView||(i=this.dataSortedVisible.slice());let n=[],l=[];if(this.isTreeView&&!this.isTreeViewRestore)if(this.filters&&Object.keys(this.filters).length){this.selectedCells&&this.selectedCells.empty("column");let e=[];this.dataSorted.forEach(t=>{"object"!=typeof t||t.opened||e.push(t)}),e.forEach(e=>{this._expandTreeFolderRow(e,!0)});for(let e=0;e<this.dataSorted.length;e++){let t=this.dataSorted[e],a=t.row;if("object"!=typeof t&&(a=this.data[t]),a&&this.__applyFiltersToItem(a)){let a,i=[],l=e-1;for(;"object"!=typeof this.dataSorted[l]&&this.dataSorted[l-1];)l--;for("object"==typeof t?a=t.p:-1===n.indexOf(this.dataSorted[l])?(i.push(this.dataSorted[l]),a=this.dataSorted[l].p):a=null;a&&l>=0;){for(;"object"!=typeof this.dataSorted[l]&&this.dataSorted[l-1];)l--;this.dataSorted[l]===this.getElementInTree(a)&&(-1===n.indexOf(this.dataSorted[l])?(i.push(this.dataSorted[l]),a=this.dataSorted[l].p):a=null),l--}for(;i.length;)n.push(i.pop());n.push(t)}}}else n=[...this.dataSorted];else for(let e=0;e<this.dataSorted.length;e++){let t=this.dataSorted[e],a=this.data[t];this.__applyFiltersToItem(a),a.$visible?(n.push(t),l.push(t)):this.selectedCells&&this.selectedCells.removeId(a.id)}(this.isTreeView||e||JSON.stringify(i)!==JSON.stringify(l))&&(this.dataSortedVisible=n,this._refreshContentTable(t,!0),this._headCellIdButtonsState()),this.selectedCells&&this.selectedCells.summarizer.check(),App.fullScreenProcesses.hide()},App.pcTableMain.prototype.__applyFiltersToItem=function(e){let a=this,i=!0;for(let n in a.filters){if(!a.filters[n]||0===a.filters[n].length)continue;let l=a.filters[n];if("id"===n)-1===l.indexOf(e.id.toString())&&(i=!1);else{let s=n.toString().split("/");if(n=s[0],!a.fields[n])continue;switch(s[1]||"v"){case"v":let s=a._getFieldbyName(n),o=t.extend({},a.f||{},e.f||{},e[n].f||{});i=o.textasvalue&&"text"in o?r.checkIsFiltered({v:o.text},l):s.checkIsFiltered(e[n],l);break;case"h":switch(l){case"h":!0!==e[n].h&&(i=!1);break;case"n":!0===e[n].h&&(i=!1);break;case"hf":(!0!==e[n].h||e[n].hasOwnProperty("c"))&&(i=!1);break;case"hc":!0===e[n].h&&e[n].hasOwnProperty("c")||(i=!1)}}}if(!i)break}return(e.$visible=i)||this.row_actions_uncheck(e),e.$visible},App.pcTableMain.prototype.addValueToFilters=function(e,a){const i=this;i.filters[e]||(i.filters[e]=[]);let n=i.fields[e],l=a[e],s=t.extend({},i.f||{},a.f||{},l.f||{});s.textasvalue&&"text"in s?i.filters[e].push(...r.getFilterDataByValue({v:s.text})):i.filters[e].push(...n.getFilterDataByValue.call(n,l)),n.$th&&n.$th.find(".btn-filter").parent().replaceWith(i.__getFilterButton.call(i,e)),i.__applyFilters.call(i)},App.pcTableMain.prototype.isValInFilters=function(e,a){if(!this.filters[e])return!1;let i,n=this.fields[e],l=a[e],s=t.extend({},this.f||{},a.f||{},l.f||{});return i=s.textasvalue&&"text"in s?r.getFilterDataByValue({v:s.text}):n.getFilterDataByValue(l),this.filters[e].some(e=>-1!==i.indexOf(e))},App.pcTableMain.prototype.removeValueFromFilters=function(e,a){const i=this;i.filters[e]||(i.filters[e]=[]);let n,l=i.fields[e],s=a[e],o=t.extend({},i.f||{},a.f||{},s.f||{});n=o.textasvalue&&"text"in o?r.getFilterDataByValue({v:o.text}):l.getFilterDataByValue(s);let d=0,c=[...i.filters[e]];i.filters[e].forEach((e,t)=>{-1!==n.indexOf(e)&&(c.splice(t-d,1),d++)}),i.filters[e]=c,0===i.filters[e].length&&delete i.filters[e],l.$th&&l.$th.find(".btn-filter").parent().replaceWith(i.__getFilterButton.call(i,e)),i.__applyFilters.call(i)},App.pcTableMain.prototype.loadFilters=function(){var e={};"tmp"!=this.tableRow.type&&(e=this.sessionStorageFilters.getFilters()),this.filters=e||{}},App.pcTableMain.prototype.__addFilterable=function(){const e=this;this.loadFilters(),
/*!panelView*/
"panels"!==this.viewType&&this._header.on("click",".pcTable-filters > span button.btn-filter:not(#checkS)",(function(a){let i=t(this);if(i.attr("aria-describedby")&&t("#"+i.attr("aria-describedby")).is(":visible"))return!0;let n=i.closest("th"),l=n.is(".id")?"id":n.data("field"),s=t('<div class="filter-div-button">'),o=t('<select class="selectpicker" data-size="6" multiple title="'+App.translate("Select values")+'" style="display: none" data-style="btn-sm btn-default" data-width="css-width" data-live-search="true" data-selected-text-format="count">').appendTo(s);const d=function(){setTimeout(()=>{i&&i.length&&i.attr("aria-describedby")&&(i.data("popover-destroed")||(i.popover("destroy"),i.data("popover-destroed",!0),setTimeout(()=>{i.data("popover-destroed",!1)},20)))},10)};let c,p=!1;const h=function(a){if(c&&clearTimeout(c),!p){if("filterRemove"===a)return p=!0,d(),delete e.filters[l],i.removeClass("btn-warning").addClass("btn-default"),void e.__applyFilters.call(e);if("setInvertFilters"===a){let e=Object.values(o.selectpicker("val")),a=[];t.each(o.data("options"),(function(t,i){-1===e.indexOf(i)&&a.push(i)})),o.data("add-options",a)}c=setTimeout((function(){d(),o.data("add-options")?(f=o.data("add-options"),o.data("add-options",null)):f=o.selectpicker("val"),JSON.stringify(e.filters[l]||[])!==JSON.stringify(f)&&(e.filters[l]=f,0===e.filters[l].length&&delete e.filters[l],"id"!==l||i.closest(".pcTable-table").is(".pcTable-table:first")||e._header.find("th.id .btn-filter").parent().replaceWith(e.__getFilterButton.call(e,l)),i.closest(".scroll-table-head")?(e._innerContainer.scrollTop(0),e._refreshHead()):i.parent().replaceWith(e.__getFilterButton.call(e,l)),e.__applyFilters.call(e))}),10)}};s=t('<div class="pcTable-filter-select" style="height: 220px;">').append(s),o.data("container",s);var f={};const u=a=>{let i=e.data[a],n=t.extend({},e.f||{},i.f||{},i[l].f||{});n.textasvalue&&"text"in n?r.addDataToFilter(f,{v:n.text}):e.fields[l].addDataToFilter(f,i[l])};e.isTreeView?Object.values(e.data).forEach((function(e){"id"===l?f[e.id.toString()]=e.id.toString():u(e.id)})):Object.values(e.dataSorted).forEach((function(e){"id"===l?f[e.toString()]=e.toString():u(e)}));var m={};t.each(f,(function(e,t){m[t]=e})),m=App.ksort(m);let b={},g=e.filters[l]?[...e.filters[l]]:[],w=0;const v=function(e){b={[App.translate("Selected")]:t('<optgroup label="'+App.translate("Selected")+'">'),"":t('<optgroup label="">')};let a=App.lang.filtersExtenders(e),i=!1,n=0;t.each(m,(function(e,t){if("null"===e&&(e="null "),-1!==g.indexOf(t.toString())){let i=a(e);b[App.translate("Selected")].append('<option data-content="'+e+'" '+(i?"":'style="display: none"')+">"+t+"</option>"),w+=i?1:0}else{if(!a(e))return!0;n>=100?i=!0:(b[""].append('<option data-content="'+e+' ">'+t+"</option>"),n++)}})),o.empty(),w||b[App.translate("Selected")].attr("label",""),o.append(b[App.translate("Selected")]),o.append(b[""]),i&&o.append('<option data-content="'+App.translate("The data is incomplete. Use the search!")+'" disabled = disabled style="text-align: center; cursor: pointer">0</option>'),o.data("options",m),o.selectpicker("val",g),o.selectpicker("refresh")};o.on("change.bs.select",(function(){g=o.val()})),v();let _=i.popover({html:!0,content:s,trigger:"manual",container:e._container,placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'});o.selectpicker("render").selectpicker("toggle"),o.data("selectpicker").$newElement.addClass("open"),i.one("remove",()=>{setTimeout(()=>{let e;_&&_.length&&_.attr("aria-describedby")&&(e=t("#"+_.attr("aria-describedby")))&&e.remove()},10)});let y=t('<div class="buttons" style="position: absolute; bottom: -10px; width: 100%; text-align: center">');if(t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px;">'+App.translate("ApplyShort")+"</span></span>").appendTo(y).on("click",(function(){h("setSelectedFilters")})),t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px;">'+App.translate("InvertShort")+"</span></span>").appendTo(y).on("click",(function(){h("setInvertFilters")})),t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px">'+App.translate("CancelShort")+"</span>").appendTo(y).on("click",(function(){h("filterRemove")})),e.fields[l]&&e.fields[l].code&&!e.fields[l].codeOnlyInAdd){let a=t('<select data-title="'+App.translate("All")+'" data-dropup-auto="false" class="dropup" data-container=".popover" data-style="btn btn-xxs filter-by-hand '+(e.filters[l+"/h"]?"btn-warning":"btn-default")+' "><option value="">'+App.translate("All")+'</option><option value="n">'+App.translate("Without hand")+'</option><option value="h">'+App.translate("With hand all")+'</option><option value="hf">'+App.translate("With hand equals calc")+'</option><option value="hc">'+App.translate("With hand different")+"</option></select>").appendTo(y).on("change",(function(){return e.filters[l+"/h"]=a.selectpicker("val"),""===e.filters[l+"/h"]&&delete e.filters[l+"/h"],d(),i.parent().replaceWith(e.__getFilterButton.call(e,l)),e.__applyFilters.call(e),!1})).wrap('<span id="filterHand">');setTimeout((function(){a.selectpicker("render").selectpicker("val",e.filters[l+"/h"]||""),a.data("selectpicker").$button.on("click",()=>{o.data("selectpicker").$newElement.removeClass("open")});try{a.data("selectpicker").$menu.offset({bottom:15,left:-90}).addClass("filter-with-hands-menu")}catch(e){}}),100)}e.PageData&&e.PageData.onPage&&e.PageData.allCount>e.PageData.onPage?(w?s.height(260):s.height(220),y.append('<div class="text-center ttm-paging-danges">'+App.translate("Filtering by current page")+"</div>")):w?s.height(220):s.height(200),y.appendTo(s),o.on("hidden.bs.select",(function(){h("setSelectedFilters")})),e.filters[l]&&o.selectpicker("val",e.filters[l]),setTimeout((function(){if(_&&_.length){let a;_.popover("show"),s.on("mouseenter","li",(function(){let e=t(this);e.attr("title")||e.attr("title",e.text())})),"id"===l&&t("#"+i.attr("aria-describedby")).position({my:"left top",at:"left-3px bottom+10px",of:i}).find(".arrow").css("left","12px"),o.data("selectpicker").$searchbox.off().on("click.dropdown.data-api focus.dropdown.data-api touchend.dropdown.data-api",(function(e){e.stopPropagation()})),o.data("selectpicker").$searchbox.on("keydown",(function(e){if("Escape"===e.key)return o.data("selectpicker").$button.click(),!0}));let n="";o.data("selectpicker").$searchbox.on("keyup",(function(e){let i=t(this).val();n!==i&&(n=i,a&&clearTimeout(a),a=setTimeout((function(){v(n)}),750))})),e._container.on("click.filter filterPressed.filter",(function(a){a&&0===t(a.target).closest("#filterHand").length&&("filterPressed"===a.type||void 0!==a.altKey)&&t("#"+i.attr("aria-describedby")).is(":visible")&&(e._container.off(".filter"),h("setSelectedFilters"))})),e._innerContainer.one("scroll.filter",(function(a){t("#"+i.attr("aria-describedby")).is(":visible")&&(e._container.off(".filter"),h("setSelectedFilters"))})),o.data("selectpicker").$searchbox.focus(),e.closeCallbacks.push(()=>{d()})}}),50),e._container.trigger("filterPressed")}))},t.extend(App.pcTableMain.prototype,{_addEditable:function(){var e=this;let a=this._container;e.actionOnClick=function(e,t){let a=e.clone(!0).insertAfter(e);e.hide(),t=t||this._getFieldBytd(e),a.html('<span class="cell-value blocked" style="height: '+a.height()+'">'+App.translate("Running")+"</span>");let i=e.closest(".DataRow").length?this._getItemBytd(e):{};return this.model.dblClick(i.id,t.name).always(t=>{a.remove(),e.show(),this.table_modify(t)}),!1};const i=(e,t)=>{if(e.is(".cell-button"))return;let a=e.clone(!0).insertAfter(e);e.hide(),a.html('<span class="cell-value blocked" style="height: '+a.height()+'">'+t+"</span>"),setTimeout((function(){a.remove(),e.show()}),500)};a.on("click",".pcTable-filtersTable td.val:not(.edt)",(function(e){i(t(this),App.translate("Blocked"))})),a.on("dblclick","td.val:not(.editing), td.edt:not(.editing), .dataRows tr:not(.treeRow) td:not(.editing,.id,.n)",(function(a){let n=t(this),l=n.closest("tr");if(l.length&&l.is(".InsertRow"))return!1;if(n.is(".footer-name, .id, .footer-empty"))return!1;if(l.is(".DataRow")&&e.isRestoreView)i(n,App.translate("Deleted"));else if(n.is(".edt"))e._createEditCell.call(e,n,!0),a.shiftKey&&setTimeout(()=>{let e=n.find('input[type="text"]');e.length&&e.get(0).select()});else{let t=e._getFieldBytd.call(e,n);if(t.CodeActionOnClick)e.actionOnClick(n,t);else{if(l.is(".DataRow")&&"cycles"===e.tableRow.type)return e.model.dblClick(e._getItemBytd(n).id,e._getFieldBytd(n).name),!1;i(n,App.translate("Blocked"))}}})).on("click",".editCellsBlock .btn, td.edt .ttm-edit, td .ttm-panel",(function(e){return t(this).is(".ttm-edit")?(t(this).closest("td").trigger("dblclick"),!1):t(this).is(".ttm-panel")?(t(this).closest("td").trigger("contextmenu"),!1):void t(this).data("click")(e)}))},_buttonClick:function(a,i,n){return a.data("clicked")?Promise.resolve():new Promise((l,s)=>{const o=function(){"use strict";let s,o={};a.parent();a.data("clicked",!0),"column"===i.category?(n=n||r._getItemBytd(a),s=n.id,o.item=s,o.hash=i.hash,o.fieldName=i.name):(n=n||r.data_params,o.item="params",o.fieldName=i.name),o.checked_ids=r.row_actions_get_checkedIds(),a.height(a.height()),a.find(".cell-value, .ttm--panel-data").hide();let d=t('<div class="text-center"><i class="fa fa-spinner"></i></div>');a.append(d),r._saving=!0,r.model.click(o).then((function(t){r.table_modify.call(r,t),a.length&&a.isAttached()?(d.remove(),a.find(".cell-value, .ttm--panel-data").show()):n="column"===i.category?r._getItemById(s):r.data_params,i.uncheckAfterClick&&r.row_actions_uncheck_all(),i.closeIframeAfterClick&&e.closeMe?e.closeMe():i.openContextPanel&&a.trigger("contextmenu"),i.btnOK(a,n),l(t)})).fail((function(){a.length&&a.isAttached()&&(d.remove(),a.find(".cell-value, .ttm--panel-data").show(),a.removeData("clicked"))})).always((function(){r._saving=!1}))};let r=this;if(i.warningEditPanel){let e={OK:function(e){e.close(),o()},[App.translate("Cancel")]:function(e){e.close()}};App.confirmation(i.warningEditText||App.translate("Surely to change?"),e,App.translate("Confirmation"))}else o()})},_saveEdited:function(e,a,i){let n=this;!0!==n._saving&&(n._saving=!0,this.model.save(a).then(t=>{n.table_modify.call(n,t,void 0,e),i&&i()}).always(()=>{n._saving=!1,e.is("tr.DataRow")&&1===e.closest("table").length&&e.find(".editing").length?e.each(()=>{n.refreshRow(t(this))}):e.is("td")&&e.find(".fa-spinner").length&&e.closest("body").length>0&&e.each((function(){let e=t(this),a=n._getItemBytd(e),i=n._getFieldBytd(e),l=n._createCell(a,i);"button"===i.type&&i.btnOK(l,a),e.replaceWith(l)}))}))},_editFocusIndex:0,_editItem:null,_editPanel:null,_row_edit:function(e){let t=this;if(0===e.length)return!1;let a=e.shift();new EditPanel(t,null,{id:a},e.length>0).then((function(a,i){(a||i)&&(a&&t.table_modify.call(t,a),t._row_edit.call(t,e))})).then((function(){0===e.length&&t.row_actions_uncheck_all()}))},_currentEditCellIndex:0,_removeEditing:function(e){e||(e=this._content.find("td.editing"));var t=this._createCell(this._getItemBytd(e),this._getFieldBytd(e));let a;return(a=e.attr("rowspan"))&&t.attr("rowspan",a),(a=e.data("field"))&&t.data("field",a),e.is(".val")&&t.addClass("val"),e.replaceWith(t),t},_saveEditCell:function(){this._editCell&&this._editCell.isAttached()&&this._editCell.is(".editCell")&&this._editCell.data("SaveMe")&&this._editCell.data("SaveMe")()},_removeEditCell:function(){this._editCell&&this._editCell.isAttached()&&this._editCell.is(".editCell")&&this._removeEditing(this._editCell),this._editCell=null},_setEditCell:function(e){this._saveEditCell(),this._editCell=e,e.addClass("editCell")},_setTdSaving:function(e){e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>')},_createEditCell:function(e,a,n){let l=this,s=this._getFieldBytd(e);this._setEditCell(e);e.parent();let o=e.closest("tr"),r=l._getColumnIndexByTd(e,o),d=function(t){if(!t)return!1;let a=t.altKey?"right":!(!t.shiftKey&&!t.ctrlKey)&&"down";if(!a)return;t.shiftKey&&t.originalEvent&&(l.selectedCells.movingSelection=!0,setTimeout(()=>{l.selectedCells.movingSelection=!1},100));t.shiftKey;const i=function(e){e.is(".edt")&&(e.trigger("dblclick"),t.shiftKey&&setTimeout(()=>{let t=e.find('input[type="text"]');t.length&&t.get(0).select()})),setTimeout(()=>{l.selectedCells.click(e,"force")},100)};let n,s=e.data("field");if(s&&"column"!==(n=l.fields[s].category)){if("footer"===n){if(l.fields[s].column)return}else if("param"!==n)return;let e=l.fieldCategories[n],t=!1;e.some(e=>{if(e.name===s)t=!0;else if(t){let t;switch(n){case"param":t=l._paramsBlock.find('td[data-field="'+e.name+'"]');break;case"footer":t=l._footersSubTable.find('td[data-field="'+e.name+'"]')}if(t.length)return i(t),!0}})}else{let e;switch(a){case"right":e=l._getTdByColumnIndex(o,++r),i(e);break;case"down":if(o=o.next("tr"),!o.length)break;e=l._getTdByColumnIndex(o,r),i(e)}}};if(!s.editable)return!1;let c=(n=n||this._getItemBytd(e)).id,p=t('<div class="editCellsBlock">');e.addClass("editing");let h,f,u=n[s.name],m=!1,b=function(e,t,a,n){let o=a||e.closest("td"),r=t||{};if(!o.length||!o.closest("body").length)return!1;var p=l._removeEditing.call(l,o);n||(l._colorizeElement(p,i,void 0,s.name,c),d(r))},g=function(t){l._removeEditing.call(l,e),d(t)};l.isSelected(s.name,n.id)?Object.keys(l.selectedCells.ids).length>1?(f=!0,h=!0):l.selectedCells.ids[s.name].length>1&&(h=!0):n.id&&l.selectedCells.empty();let w=h&&(f?s.editGroupMultiColumns:s.editGroup),v=function(t,a,i){if(!i&&s.warningEditPanel&&s.checkEditRegExp.call(s,t))return void App.confirmation(s.warningEditText||App.translate("Surely to change?"),{OK:function(e){v(t,a,!0),e.close()},[App.translate("Cancel")]:function(e){g(),e.close()}},App.translate("Change warning"));e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>');let o={};o[s.name]=t;let r={};n.id?r[n.id]=o:r.params=o,l._saveEdited.call(l,e,r,(function(){d(a)}))},_=function(e,t){setTimeout((function(){if(m)return m=!1,!1;y(e,t)}),150)},y=function(e,a,i){if(m&&!i)return!1;m=!0;let o="enter"===i;if(o&&(i=!1),!(i=i||!1)&&w)return o||"select"===s.type&&!s.multiple||l._removeEditCell(),!1;let r,d=e.closest("td");try{r=s.getEditVal(x)}catch(e){return t("#"+App.popNotify(e,d,"default")).css("z-index",1e3),void(m=!1)}!s.name in n||!s.isDataModified(r,n[s.name].v)?g(a):v(r,a)};var x=s.getEditElement(void 0,u,n,y,b,_,null,a);u.f&&u.f.placeholder&&s.addPlaceholder&&s.addPlaceholder(x,u.f.placeholder),e.html(x),e.attr("data-fieldtype",s.type),e.data("SaveMe",(function(e){y(x,e=e||{})})),e.data("input",x);var k=t('<div class="cdiv">').css({height:0,left:0,right:0,position:"absolute",bottom:"0px"});e.append(k);var C=t('<button class="btn btn-sm btn-default" data-save="true" data-name="'+App.translate("Save")+'"><i class="fa fa-save"></i></button>').data("click",(function(e){m=!0,y(x,e,!0)}));p.append(C);C=t('<button class="btn btn-sm btn-default btn-empty-with-icon"><i class="fa fa-times"></i></button>').data("click",(function(e){m=!0,g(e)}));let T;p.append(C);try{T=t.extend({},l.f||{},n.f||{},n[s.name].f||{})}catch(e){console.log(e,n,s.name),T={}}let A=!("showhand"in T)||!0===T.showhand;if(w){C=t('<button class="btn btn-sm btn-warning" data-save="true" data-name="'+App.translate("Apply to selected")+'"><i class="fa fa-database" title="'+App.translate("Apply to selected")+'"></i></button>');let a=function(){let t;m=!0;try{t=s.getEditVal(x)}catch(t){return void App.popNotify(t,e,"default")}let a=l._container.find("td.selected");l._setTdSaving(a);let i=l.selectedCells.getEditedData(t);l._saveEdited.call(l,a,i,!1)};C.data("click",(function(){s.warningEditPanel?App.confirmation(s.warningEditText,{OK:function(e){a(),e.close()},[App.translate("Cancel")]:function(e){g(),e.close()}},App.translate("Change warning")):a()})),p.append(C),s.code&&!s.codeOnlyInAdd&&(A&&Object.keys(l.selectedCells.ids).some(e=>l.selectedCells.ids[e].some(t=>!l.data[t][e].h))&&((C=t('<button class="btn btn-sm btn-warning" data-name="'+App.translate("Fix the selected")+'"><i class="fa fa-hand-rock-o" title="'+App.translate("Fix the selected")+'"></i></button>')).data("click",(function(){m=!0;let e=l._container.find("td.selected");l._setTdSaving(e),l.selectedCells.getEditedData(null,!0).then(t=>{l._saveEdited.call(l,e.closest("tr"),t,!1)})})),p.append(C)),(l.isCreatorView||A)&&Object.keys(l.selectedCells.ids).some(e=>l.selectedCells.ids[e].some(t=>l.data[t][e].h))&&((C=t('<button class="btn btn-sm btn-danger" data-name="'+App.translate("Reset manuals")+'"><i class="fa fa-eraser" title="'+App.translate("Reset manuals")+'"></i></button>')).data("click",(function(){m=!0;let e=l._container.find("td.selected");l._setTdSaving(e);let t=l.selectedCells.getEditedData("NULL");t.setValuesToDefaults=!0,l._saveEdited.call(l,e.closest("tr"),t,!1)})),p.append(C)))}else(l.isCreatorView||A)&&n[s.name]&&1==n[s.name].h?((C=t('<button class="btn btn-sm btn-danger" data-name="'+App.translate("Reset manual")+'"><i class="fa fa-eraser" title="'+App.translate("Reset manual")+'"></i></button>')).data("click",(function(){m=!0,e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>');let t={};parseInt(c)||(c="params"),t[c]={},t[c][s.name]="NULL",t.setValuesToDefaults=!0,l._saveEdited.call(l,e,t,!1)})),p.append(C)):A&&s.code&&!s.codeOnlyInAdd&&"filter"!==s.category&&((C=t('<button class="btn btn-sm btn-default" data-name="'+App.translate("Pin")+'"><i class="fa fa-hand-rock-o" title="'+App.translate("Pin")+'"></i></button>')).data("click",(function(){m=!0,e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>');let t,a={};parseInt(c)||(c="params"),a[c]={},t="params"===c?l.data_params:l.data[c],a[c][s.name]=t[s.name].v,l.fields[s.name].getValue?l.fields[s.name].getValue(a[c][s.name],t,!0).then(t=>{a[c][s.name]=t.value,l._saveEdited.call(l,e,a,!1)}):l._saveEdited.call(l,e,a,!1)})),p.append(C));s.changeSelectTable&&"select"===s.type&&(()=>{let e=t.extend(!0,{},n),a=function(){m=!0,sourcePanelOpened=!0,setTimeout(()=>{x.click()},3);let a=t(this).data("add-button");return s.sourceButtonClick(e,a).then(t=>{if(!t)return;let a=t&&"insert"===t.method&&t.json&&t.json.chdata&&t.json.chdata.rows,i=x;if(delete s.list,i.data("input").data("LISTs")&&(i.data("input").data("LISTs").isListForLoad=!0),a){let a;a=s.selectTableBaseField?t.json.chdata.rows[Object.keys(t.json.chdata.rows)[0]][s.selectTableBaseField].v:Object.keys(t.json.chdata.rows)[0],s.multiple?(e[s.name].v=s.getEditVal(x),e[s.name].v.push(a)):e[s.name].v=a}else s.selectTableBaseField&&!s.multiple&&t.json.chdata.rows[Object.keys(t.json.chdata.rows)[0]]&&t.json.chdata.rows[Object.keys(t.json.chdata.rows)[0]][s.selectTableBaseField]&&(e[s.name].v=t.json.chdata.rows[Object.keys(t.json.chdata.rows)[0]][s.selectTableBaseField].v);a||"column"!==s.category||l.model.refresh((function(e){l.table_modify.call(l,e)})),e[s.name].replaceViewValue=function(e){"column"!=s.category&&(l.data_params[s.name].v_=e)},i.replaceWith(x=s.getEditElement(i,e[s.name],e,y,b,_)),m=!1}),!1};!e[s.name].v||s.multiple&&!e[s.name].v.length||((C=t('<button class="btn btn-sm btn-primary"><i class="fa fa-edit" title="'+App.translate("Change in source table")+'"></i></button>')).on("click",a),p.append(C)),2===s.changeSelectTable&&(C=t('<button class="btn btn-sm btn-primary" data-add-button="true"><i class="fa fa-plus" title="'+App.translate("Add to source table")+'"></i></button>'),p.append(C),C.on("click",a))})();let S=p.find("button").length;p.width(31*S);let R=t("#"+App.popNotify({$text:p,element:k,container:this._container,isParams:!0,placement:"bottom"})),I=parseInt(R.css("top"))-4;R.css("top",-1e7),setTimeout((function(){R.length&&R.isAttached()&&R.css("top",I)}),3),s.focusElement(x)},editSingleFieldInPanel:function(a,i){return new Promise((n,l)=>{let s,o,r,d,c=i?this.data[i][a.name]:this.data_params[a.name],p=this.getElementFormat(a,i),h=t("<div>"),f=i?this.data[i]:this.data_params,u=[{action:e=>{m()},cssClass:"btn-warning btn-save",label:App.translate("Save")}];a.code&&!a.codeOnlyInAdd&&(c.h?u.push({action:e=>{s="setValuesToDefaults",o=null,m()},cssClass:"btn-warning btn-save",label:'<i class="fa fa-eraser"></i>'}):u.push({action:e=>{o=c.v,m()},cssClass:"btn-warning btn-save",label:'<i class="fa fa-hand-rock-o"></i>'})),u.push({action:e=>{e.close()},cssClass:"",label:'<i class="fa fa-times"></i>'});const m=e=>{if(void 0===o){try{o=a.getEditVal(d)}catch(e){return void t("#"+App.popNotify(e,h,"default")).css("z-index",1e3)}if(!a.isDataModified(o,c.v))return void r.close()}if(!e&&a.warningEditPanel&&a.checkEditRegExp.call(a,o))return void App.confirmation(a.warningEditText||App.translate("Surely to change?"),{OK:function(e){m(!0),e.close()},[App.translate("Cancel")]:function(e){revert(),e.close()}},App.translate("Change warning"));App.fullScreenProcesses.showCog();let i={};i[a.name]=o;let l={};f.id?l[f.id]=i:l.params=i,s&&(l[s]=!0),this.model.save(l).then(e=>{n(e),r.close()}).always(()=>{App.fullScreenProcesses.hideCog()})};switch(a.type){case"tree":case"text":case"file":case"comments":case"listRow":d=a.getEditElement(h,c,i?this.data[i]:this.data_params,()=>{m()},()=>{},()=>{},1,!0),h.append(d),setTimeout(()=>{r=d.data("Dialog");let e=r.getButtons()[0].action;u[0].action=(t,a,i)=>{e(t,a,i),m()},r.setButtons(u)},2);break;default:d=a.getEditElement(h,c,i?this.data[i]:this.data_params,()=>{},()=>{},()=>{}),h.append(d),r=e.top.BootstrapDialog.show({message:h,type:null,title:p.title||a.title,cssClass:"one-column-panel",draggable:!0,buttons:u,onhidden:()=>{n()}}),setTimeout(()=>d.focus(),21)}})}}),function(e,t){t.extend(App.pcTableMain.prototype,{_orderSaveBtn:void 0,row_actions_add:function(){let e=this;e._table.on("click",".DataRow .id",(function(){e.isMobile&&e.row_actions_panel_show.call(e,t(this))})),e._table.on("click",".DataRow .id button.dropdown",(function(){e.row_dropdown.call(e,t(this))})),e._table.on("click",".DataRow .id .btn.chbox",(function(a){return e._row_actions_checkbox_click.call(e,t(this).closest("tr"),a.shiftKey),!1})),e._table.on("mouseleave",(function(){return t(this).blur(),!1})),e._table.on("click",".DataRow .id button.edit",(function(){e.rows_edit(t(this).closest("tr"))})),e._container.on("click",".row_delete, .row_restore, .row_duplicate, .row_refresh, .cycle_refresh",(function(){let a=t(this);a.is(".row_delete")?e.rows_delete.call(e,t(this).data("tr")):a.is(".row_restore")?e.rows_restore.call(e,t(this).data("tr")):a.is(".row_duplicate")?e.row_duplicate.call(e,t(this).data("tr")):a.is(".row_refresh")?e.row_refresh.call(e,t(this).data("tr")):a.is(".cycle_refresh")&&e.isCreatorView&&"cycles"===e.tableRow.type&&e.cycle_refresh.call(e,t(this).data("tr"))}))},_idCheckButton:t('<button class="btn btn-xxs chbox btn-default" data-action="checkbox"><span class="fa fa-square-o"></span></button>'),_checkStatusBar:t('<div class="check-status-bar"><span class="check-mark"> </span><span data-name="count_checked_rows">0</span><span class="from-mark">'+App.translate(" from ")+'</span><span data-name="count_visible_rows">0</span></div>'),_headCellIdButtonsState:function(){"use strict";let e=this;this.row_actions_get_checkedIds().length>0?t("table.pcTable-table").addClass("with-checks"):t("table.pcTable-table").removeClass("with-checks"),this.dataSortedVisible.filter(e=>"object"!=typeof e||e.row).length!==this.__checkedRows.length?e._idCheckButton.html('<span class="fa fa-square-o"></span>'):e._idCheckButton.html('<span class="fa fa-check"></span>'),this._refreshCheckedStatus(),e.ScrollClasterized.reloadScrollHead.call(e.ScrollClasterized)},_addCellId:function(e,a){let i=t('<td class="id"><span class="nm"></span></td>');return this._isDisplayngIdEnabled()&&(i.find("span").text(e.id),this._isDisplayngIdEnabled(!0)||i.find("span").addClass("id-hidden")),i.appendTo(a),this.row_actions_icons_add(i),!0===e.$checked&&this.row_actions_check(e,!0),i},_addCellNo:function(e,a){let i=t('<td class="No">--</td>');return i.appendTo(a),i},row_actions_uncheck_all:function(){"use strict";let e=this,t=this.row_actions_get_checkedIds();for(let a=0;a<t.length;a++){let i=e._getItemById(t[a]);e.row_actions_uncheck.call(e,i,!0)}this.__checkedRows=[],this._headCellIdButtonsState()},_refreshCheckedStatus:function(){this._checkStatusBar.find('[data-name="count_checked_rows"]:first').text(this.__checkedRows.length),this._checkStatusBar.find('[data-name="count_visible_rows"]:first').text(this.dataSortedVisible.filter(e=>"object"!=typeof e||e.row).length)},_row_actions_checkbox_click:function(e,a){let i=this,n=e.closest("tr"),l=this._getItemByTr(n),s=t.extend({},i._lastcheckAction||{});if(i._lastcheckAction={id:l.id,isCheck:!l.$checked},a){const e=e=>t=>{if("object"!=typeof t)return t.toString()===e.toString()};let t,a=[];if(s.id&&!l.$checked===s.isCheck&&-1!==(t=i.dataSortedVisible.findIndex(e(s.id)))){let n=i.dataSortedVisible.findIndex(e(l.id));a=t<n?i.dataSortedVisible.slice(t+1,n+1):i.dataSortedVisible.slice(n,t)}else i.dataSortedVisible.some((function(e){if("object"!=typeof e&&(i.data[e].$checked?a=[]:a.push(e),e==l.id))return!0}));l.$checked?a.forEach((function(e){"object"!=typeof e&&(i.__checkedRows.splice(i.__checkedRows.indexOf(e),1),i.row_actions_uncheck(i.data[e],!0))})):a.forEach((function(e){"object"!=typeof e&&(i.__checkedRows.push(e),i.row_actions_check(i.data[e],!0))})),this._headCellIdButtonsState()}else l.$checked?this.row_actions_uncheck(l):this.row_actions_check(l)},row_actions_get_checkedIds:function(){return this.__checkedRows},row_actions_check:function(e,t,a){if(e.$checked=!0,e.$tr){e.$tr.find(".id:first").addClass("checked"),e.$tr.addClass("id-checked")}t||(a?this.__checkedRows.unshift(e.id):this.__checkedRows.push(e.id),this._headCellIdButtonsState())},row_actions_uncheck:function(e,t){e.$checked&&(e.$checked=!1,e.$tr&&($tdId=e.$tr.find(".id"),$tdId.removeClass("checked"),e.$tr.removeClass("id-checked"),$tdId.find(".chbox i").attr("class","fa fa-square-o")),t||(this.__checkedRows.splice(this.__checkedRows.indexOf(e.id),1),this._headCellIdButtonsState()))},row_actions_icons_add:function(e){"use strict";let a,i;a=this.tableRow.panel?t('<button class="btn btn-default edit"><i class="fa fa-th-large"></i></button>').on("mouseleave",(function(){return t(this).blur(),!1})).css("margin-left",2):t(),this.control.editing&&(i=t('<button class="btn btn-default btn-xxs dropdown"  tabindex="-1" style=" margin-left: 2px;"><i class="fa fa-caret-down" style="font-size: 10px; width: 7px;"></i></button>'));let n=t('<button class="btn btn-default btn-xxs chbox"><i class="fa fa-square-o"></i></button>'),l=t('<span class="btn-group-xxs">');e.append(l).append(" ").append(n),i&&l.append(i),a&&l.append(a)},getRemoveTitle:function(e,t){switch(e){case"question_many":return"hide"===this.tableRow.deleting?App.translate("Surely to hide %s rows?",t):App.translate("Surely to delete %s rows?",t);case"question":return"hide"===this.tableRow.deleting?App.translate("Surely to hide the row?",t):App.translate("Surely to delete the row?",t);case"forTimer_many":return"hide"===this.tableRow.deleting?App.translate("Hiding %s rows",t):App.translate("Deleting %s rows",t);case"forTimer":return"hide"===this.tableRow.deleting?App.translate("Hiding the row %s",t):App.translate("Deleting the row %s",t);case"lower":return"hide"===this.tableRow.deleting?App.translate("Hide").toLowerCase():App.translate("Delete").toLowerCase();default:return"hide"===this.tableRow.deleting?App.translate("Hide"):App.translate("Delete")}},row_actions_panel_show:function(e){let a=e.closest("tr"),i=this._getItemByTr(a),n=i.id;const l=this;let s=t('<div id="row-mobile-panel"></div>');!0!==this.tableRow.panel?s.append(t('<div class="menu-item"><i class="fa fa-th-large"></i> '+App.translate("Open the panel")+"</div>").css("color","gray")):s.append(t('<div class="menu-item row_panel"><i class="fa fa-th-large"></i> '+App.translate("Open the panel")+"</div>").attr("data-tr",n)),!0!==this.control.duplicating||this.f.blockduplicate||i.f.blockduplicate?s.append(t('<div class="menu-item"><i class="fa fa-clone"></i> '+App.translate("Duplicate")+"</div>").css("color","gray")):s.append(t('<div class="menu-item row_duplicate"><i class="fa fa-clone"></i> '+App.translate("Duplicate")+"</div>").attr("data-tr",n)),-1!==["calcs","globcalcs"].indexOf(this.tableRow.type)?s.append(t('<div class="menu-item"><i class="fa fa-refresh"></i> '+App.translate("Recalculate")+"</div>").css("color","gray")):s.append(t('<div class="menu-item row_refresh"><i class="fa fa-refresh"></i> '+App.translate("Recalculate")+"</div>").attr("data-tr",n)),!this.control.deleting||this.f.blockdelete||i.f&&(i.f.block||i.f.blockdelete)?s.append(t('<div class="menu-item"><i class="fa fa-times"></i> '+this.getRemoveTitle()+"</div>").css("color","gray")):s.append(t('<div class="menu-item row_delete"><i class="fa fa-times"></i> '+this.getRemoveTitle()+"</div>").attr("data-tr",n));let o=App.mobilePanel(i[this.mainFieldName].v||"id: "+n,s);s.on("click",".row_delete, .row_duplicate, .row_refresh, .row_panel",(function(){let e=t(this);e.is(".row_delete")?l.rows_delete.call(l,n):e.is(".row_duplicate")?l.row_duplicate.call(l,n):e.is(".row_refresh")?l.row_refresh.call(l,n):e.is(".row_panel")&&l.rows_edit.call(l,a),o.close()}))},table_modify:function(e,a,i,n){"use strict";let l=this,s=0,o=0,r=i?i.data("field"):void 0,d=!1;if(e.updated&&(l.model.tableData.updated=JSON.parse(e.updated),l._refreshTitle()),l.isPanel&&e.chdata&&delete e.chdata.params,a&&(s=l.dataSorted.indexOf(a)+1,o=l.dataSortedVisible.indexOf(a)+1),e.chdata){let i=e.chdata.deleted||[],c=[];if(e.refresh&&e.chdata.rows&&Object.keys(l.data).forEach((function(t){void 0===e.chdata.rows[t]&&i.push(parseInt(t))})),i.length&&t.each(i,(function(e,t){l._deleteItemById.call(l,t)})),e.chdata.rows){if(e.chdata.tree){let t={};e.chdata.tree.forEach((e,a)=>{this.getTreeBranch(e,a),t[e.v]=!0}),e.refresh&&Object.keys(this.treeIndex).forEach(e=>{e&&!t[e]&&(this.removeTreeBranch(e),this.treeRefresh=!0)})}t.each(e.chdata.rows,(function(e,t){let a=l._getItemById(t.id);void 0===a?c.push(t):l.refreshRow(a.$tr,a,t,n)})),c.length&&(App.isEmpty(l.data)&&l._content&&l._content.find(".pcTable-noDataRow").remove(),!0===l.tableRow.order_desc&&(c=c.reverse()),t.each(c,(function(e,t){if(t.$visible=!0,t.$checked=!1,s||!l.tableRow.with_order_field||l.tableRow.new_row_in_sort||(t.__inserted=!0),l.data[t.id]=t,l.isTreeView)l.placeInTree(t,null,!0),this.treeRefresh=!0;else{let e=s,i=o;!t.__after||a&&a.id===t.__after||(e=l.dataSorted.indexOf(t.__after)+1,i=l.dataSortedVisible.indexOf(t.__after)+1),l.dataSorted.splice(e,0,t.id),l.dataSortedVisible.splice(i,0,t.id),s++,o++}})),a&&!l.isMobile&&setTimeout((function(){t.each(c,(function(e,t){l.row_actions_check(l.data[t.id])}))}),50)),l.selectedCells&&l.selectedCells.summarizer.check()}if(App.isEmpty(l.data)&&l._content&&0===l._content.find("."+this.noDataRowClass).length&&l._content.append(l._createNoDataRow()),i.length||c.length||e.chdata.nsorted_ids&&l.nSorted&&!Object.equals(e.chdata.nsorted_ids,l.dataSorted)){if(e.chdata.nsorted_ids&&l.nSorted){let t=l.dataSortedVisible;l.dataSorted=e.chdata.nsorted_ids,t.length===l.dataSorted.length?l.dataSortedVisible=l.dataSorted:(l.dataSortedVisible=[],l.dataSorted.forEach((function(e){-1!==t.indexOf(e)&&l.dataSortedVisible.push(e)})))}d=!0}e.chdata.order&&(this.setOrdersForRows?this.setOrdersForRows(e.chdata.order):(this.dataSorted=e.chdata.order,l.dataSortedVisible=[],l.dataSorted.forEach(e=>{this.data[e].$visible&&l.dataSortedVisible.push(e)})),d=!0);let p={};e.chdata.params&&t.each(e.chdata.params,(function(e,t){["v","v_","f","e","h","c","ch"].forEach((function(a){l.data_params[e]&&(void 0!==t[a]||l.data_params[e][a])&&(Object.equals(l.data_params[e][a],t[a])&&e!==r||(p[e]=p[e]||a,l.data_params[e][a]=t[a]))}))})),e.chdata.treeCounts&&Object.keys(e.chdata.treeCounts).forEach(t=>{this.treeIndex[t].count=e.chdata.treeCounts[t]}),e.chdata.fields&&t.each(e.chdata.fields,(function(e,a){a.list&&!Object.equals(l.fields[e].list,a.list)&&(p[e]=!0,t.extend(l.fields[e],a))})),(e.chdata.params||e.chdata.fields)&&(n||(l._refreshParamsBlock(p,!0),l._refreshFootersBlock(p,!0)),l.f&&l.f.buttons&&l.f.buttons.some&&l.f.buttons.some(e=>(l._rowsButtons(),!0))),e.chdata.f&&this.apptyTableFormats(e.chdata.f),App.isEmpty(l.data)&&l._content&&l._content.empty().append(this._createNoDataRow()),this.treeRefresh&&this.treeApply()}l.isPanel||("filtersString"in e&&l._refreshFiltersBlock.call(l,e),l._headCellIdButtonsState(),d=!0),!n&&d&&(this._refreshContentTable(0,!1,!0),this._container.getNiceScroll().resize())},apptyTableFormats:function(e){["hidedots","blockadd","topbuttons","hideadd","buttons","printbuttons","dotbuttons","extbuttons","blockdelete","blockorder","background","blockduplicate","block","tabletitle","rowstitle","fieldtitle","tablecomment","tabletext","tablehtml","browsertitle","fieldhide","kanban_html","interlace"].forEach(t=>{if(t in e||t in this.f)if("object"==typeof e[t]){if(!Object.equals(e[t],this.f[t])){let a=Object.assign({},this.f[t]);this.f[t]=e[t],this.__formatFunctions[t]&&this.__formatFunctions[t].call(this,e[t],a)}}else e[t]!==this.f[t]&&(this.f[t]=e[t],this.__formatFunctions[t]&&this.__formatFunctions[t].call(this,e[t]))}),this.applyOrder(e.order),this.applyHideRows(e.hideRows,e.showRows)},applyOrder:function(e){if(e&&e.length){let t={},a=[];this.dataSorted.forEach(i=>{let n=e.indexOf(i);-1!==n?t[n]=i:a.push(i)}),this.dataSorted=[...Object.values(t),...a],this.__applyFilters(!0)}},applyHideRows:function(e,t){if(e&&e.length||t&&t.length){e=e||[],t=t||[];let a=this.filters.id||[];a.length?t.forEach(e=>{-1!==a.indexOf(e)&&-1===this.dataSorted.indexOf(parseInt(e))||a.push(e.toString())}):(a=[...this.dataSorted],t=[]);let i=[];a.forEach(t=>{e.some(e=>e.toString()===t.toString())||i.push(t.toString())}),i.length===this.dataSorted.length?delete this.filters.id:this.filters.id=i,this.__applyFilters(!0)}},rows_edit:function(e){"use strict";let t=this,a=this.row_actions_get_checkedIds();if(e){let i=t._getItemByTr(e).id,n=a.indexOf(i);-1===n?(this.row_actions_check(t._getItemByTr(e),!1,!0),a=this.row_actions_get_checkedIds()):(a.splice(n,1),a.unshift(i))}return t._row_edit.call(t,a.slice()),!1},row_dropdown:function(e){"use strict";let a=this,i=t("<div>"),n=a._getItemByTr(e.closest("tr")),l=n.id;!0!==this.control.duplicating||a.f.blockduplicate||n.f.blockduplicate?i.append(t('<div class="menu-item"><i class="fa fa-clone"></i> '+App.translate("Duplicate")+"</div>").css("color","gray")):i.append(t('<div class="menu-item row_duplicate"><i class="fa fa-clone"></i> '+App.translate("Duplicate")+"</div>").attr("data-tr",l)),-1!==["calcs","globcalcs","tmp"].indexOf(a.tableRow.type)?i.append(t('<div class="menu-item"><i class="fa fa-refresh"></i> '+App.translate("Recalculate")+"</div>").css("color","gray")):i.append(t('<div class="menu-item row_refresh"><i class="fa fa-refresh"></i> '+App.translate("Recalculate")+"</div>").attr("data-tr",l)),a.isCreatorView&&"cycles"===a.tableRow.type&&i.append(t('<div class="menu-item cycle_refresh color-danger"><i class="fa fa-refresh"></i> '+App.translate("Recalculate cycle")+"</div>").attr("data-tr",l)),this.isRestoreView?i.append(t('<div class="menu-item row_restore"><i class="fa fa-recycle"></i> '+App.translate("Restore")+"</div>").attr("data-tr",l)):!this.control.deleting||this.f.blockdelete||n.f&&(n.f.block||n.f.blockdelete)?i.append(t('<div class="menu-item"><i class="fa fa-times"></i> '+this.getRemoveTitle()+"</div>").css("color","gray")):i.append(t('<div class="menu-item row_delete"><i class="fa fa-times"></i> '+this.getRemoveTitle()+"</div>").attr("data-tr",l)),n.f&&n.f.rowcomment&&i.append(t('<div class="menu-item comment"><i class="fa fa-info"></i></div>').on("click",()=>{App.notify(n.f.rowcomment)}));let s=App.popNotify({isParams:!0,$text:i,element:e,container:this._container,trigger:"manual",placement:"bottom"});return t("#"+s).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",(function(){i.remove()})).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px"),!1},__getCheckedRowsIds:function(e,a,i){"use strict";let n=this,l=this.row_actions_get_checkedIds();if(e&&-1===l.indexOf(e)){let t=n.data[e];this.row_actions_check(t),l=this.row_actions_get_checkedIds()}if(a){let e=!1;if(l.some((function(t){if(n.data[t].f&&(n.data[t].f.block||n.data[t].f[i]))return e=n.data[t],!0})),e){let a="";"id"!==n.mainFieldName&&(a=e[n.mainFieldName]._v?e[n.mainFieldName]._v:e[n.mainFieldName].v,a=' "'+a+'"');let i=t("<span>").html(App.translate("Row <b>id %s %s</b> is blocked",[e.id,a]));return App.notify(i,App.translate("Action not executed")),!1}}return l},getRowTitle(e){return"id"!==this.mainFieldName?e[this.mainFieldName]._v?e[this.mainFieldName]._v:e[this.mainFieldName].v:e.id},row_refresh:function(e){"use strict";let t=this,a=this.__getCheckedRowsIds(e,!1),i=1===a.length?a[0]:null;if(a&&a.length){let e=[{label:App.translate("Recalculate"),action:function(e){t.model.refresh_rows(a).then((function(a){t.table_modify.call(t,a),e.close(),t.row_actions_uncheck_all()}))}},{label:App.translate("Cancel"),action:function(e){e.close()}}];BootstrapDialog.show({message:App.translate("Surely to recalculate %s rows?",a.length),title:App.translate("Recalculating"),buttons:e,onhidden:function(){1===a.length&&a[0]==i&&t.row_actions_uncheck_all()},draggable:!0})}},cycle_refresh:function(e){"use strict";let t=this,a=this.__getCheckedRowsIds(e,!1);if(a&&a.length){let e=[{label:App.translate("Recalculate"),action:function(e){t.model.refresh_cycles(a).then((function(a){t.table_modify.call(t,a),e.close(),t.row_actions_uncheck_all()}))}},{label:App.translate("Cancel"),action:function(e){e.close()}}];BootstrapDialog.show({message:App.translate("Surely to recalculate %s cycles?",a.length),title:App.translate("Recalculating"),buttons:e,draggable:!0})}},row_duplicate:function(e){"use strict";let a=this,i=this.__getCheckedRowsIds(e,!1);if(i&&i.length){let n=[{label:App.translate("Duplicate"),cssClass:"btn-danger",action:function(n){let l={},s=[],o=[];a.dataSortedVisible.forEach((function(e){let t=parseInt(e);"object"==typeof e&&e.row&&(t=parseInt(e.row.id)),-1!==i.indexOf(t)&&o.push(t)}));const r=function(t){a.model.duplicate(o,l,e).then((function(i){a.table_modify.call(a,i,e),t&&t.close(),n.close(),a.row_actions_uncheck_all()}))};for(let e in a.fieldCategories.column){let t=a.fieldCategories.column[e];"unic"===t.type&&s.push(t.name)}if(s.length&&!a.tableRow.on_duplicate){let e,i=t('<table class="simpleTable"><thead><tr><td class="id">id</td></tr></thead><tbody></tbody></table>'),d=i.find("thead tr"),c=i.find("tbody");"id"!==a.mainFieldName&&(e=a.fields[a.mainFieldName],"unic"!==e.type?d.append(t("<td></td>").text(e.title)):e=null);for(let e in s){let i=a.fields[s[e]];d.append(t("<td></td>").text(i.title))}for(let i in o){let n=o[i],r=a.data[n],d=t("<tr>");l[n]={},d.append(t('<td class="id"></td>').text(n)),e&&d.append(t("<td></td>").text(r[e.name].v));for(let e in s){let i,o=a.fields[s[e]],c=t('<td class="input"></td>'),p=t("<input>").val(r[o.name].v);l[n][o.name]=r[o.name].v,p.on("keyup",(function(){let e=t(this).val();l[n][o.name]=e,i&&(clearTimeout(i),i=null),""!==e?i=setTimeout((function(){a.model.checkUnic(o.name,e).then((function(e){e.ok?c.addClass("ok"):c.removeClass("ok")}))}),300):o.required?c.removeClass("ok"):c.addClass("ok")})),c.html(p),d.append(c)}c.append(d)}let p=[{label:App.translate("Duplicate"),cssClass:"btn-m btn-warning",action:function(e){r(e)}},{label:App.translate("Cancel"),action:function(e){e.close(),n.close()}}];BootstrapDialog.show({message:i,title:App.translate("Fill in the values for unique fields"),buttons:p,draggable:!0})}else r()}},{label:App.translate("Cancel"),action:function(e){e.close()}}];BootstrapDialog.show({message:App.translate("Surely to duplicate %s rows?",i.length),title:App.translate("Duplicating"),buttons:n,draggable:!0})}},rows_delete:function(e){let t=this,a=this.__getCheckedRowsIds(e,!0,"blockdelete"),i=1===a.length?a[0]:null;if(a&&a.length){let e=this.getRemoveTitle("question_many",a.length),n=this.getRemoveTitle("forTimer_many",a.length);if(1==a.length){let i="id-"+a[0];"id"!=t.mainFieldName&&(i=t.data[a[0]][t.mainFieldName],i="id-"+a[0]+' "'+(i.v_&&i.v_[0]?i.v_[0]:i.v)+'"'),e=this.getRemoveTitle("question"),n=this.getRemoveTitle("forTimer",i)}let l=[{label:this.getRemoveTitle(),cssClass:"btn-danger",action:function(e){e.close();const i=function(){t.model.delete(a).then((function(e){t.table_modify.call(t,e)}))};t.tableRow.delete_timer>0?App.panelTimer(n,t.tableRow.delete_timer,i):i()}},{label:App.translate("Cancel"),action:function(e){e.close()}}];BootstrapDialog.show({message:e,title:n,buttons:l,onhidden:function(){1===a.length&&a[0]==i&&t.row_actions_uncheck_all()},draggable:!0})}},rows_restore:function(e){let t=this,a=this.__getCheckedRowsIds(e),i=1===a.length?a[0]:null;if(a&&a.length){let e=App.translate("Surely to restore %s rows?",a.length);if(1==a.length){let i="id-"+a[0];"id"!=t.mainFieldName&&(i=t.data[a[0]][t.mainFieldName],i="id-"+a[0]+' "'+(i.v_&&i.v_[0]?i.v_[0]:i.v)+'"'),e=App.translate("Surely to restore the row %s?",i)}let n=[{label:App.translate("Restore"),cssClass:"btn-danger",action:function(e){e.close(),t.model.restore(a).then((function(e){t.table_modify.call(t,e)}))}},{label:App.translate("Cancel"),action:function(e){e.close()}}];BootstrapDialog.show({message:e,title:App.translate("Restoring"),buttons:n,onhidden:function(){1===a.length&&a[0]==i&&t.row_actions_uncheck_all()},draggable:!0})}}})}(0,jQuery),t.extend(App.pcTableMain.prototype,{_insertItem:null,_insertRow:null,_insertRowFields:null,_insertRowActive:!1,_insertButtons:null,_insertRowWait:[0],_insertRowHash:null,_addButtons:null,_insertError:{},_currentInsertCellIndex:0,_insertFocusTimeout:null,isInsertable:function(){return this.control.adding&&!this.f.blockadd&&!this.isRestoreView},_addInsert:function(e){this.control.adding&&(this._insertRow&&this._insertRow.length||(this._insertRow=this._createInsertRow(null,0,e),this._insertRowActive=!0,this._insertButtonsChangeStatuses(),this._beforebody.prepend(this._insertRow),this._table.addClass("with-adding-row")))},_insertButtonsChangeStatuses:function(){this._insertRow?(this._insertButtons&&this._insertButtons.find('[data-action="add"]').removeClass("btn-warning").addClass("btn-default").attr("disabled","disabled"),0===this.dataSortedVisible.length&&this._table.find(".pcTable-noDataRow button").removeClass("btn-warning").addClass("btn-default").attr("disabled","disabled")):(this._insertButtons&&this._insertButtons.find('[data-action="add"]').addClass("btn-warning").removeClass("btn-default").removeAttr("disabled"),0===this.dataSortedVisible.length&&this._table.find(".pcTable-noDataRow button").addClass("btn-warning").removeClass("btn-default").removeAttr("disabled"))},_InsertAddInsertBtnsPanel:function(e){let a,i=this,n={};n['<span id="saveInsertRow">'+App.translate("Save")+"</span>"]=function(){a.is(".onSaving")||(a.addClass("onSaving"),i.__insertRowActions("saveInsertRow",(function(){i._saveInsertRow("close").always((function(){a.removeClass("onSaving")})).then(()=>{i.__$rowsButtons.find('[data-action="add"]:first').focus()})})))},n['<i class="fa fa-save"></i>']=function(){a.is(".onSaving")||(a.addClass("onSaving"),i.__insertRowActions("saveInsertRow",(function(){i._saveInsertRow().always((function(){a.removeClass("onSaving")}))})))},n['<i class="fa fa-paste"></i>']=function(){a.is(".onSaving")||(a.addClass("onSaving"),i.__insertRowActions("saveInsertRow",(function(){i._saveInsertRow.call(i,"notClean").always((function(){a.removeClass("onSaving")}))})))},n['<i class="fa fa-times"></i>']=function(){i._closeInsertRow.call(i,t(this).closest("#"+l))},a=this._addRowPanel(l,e,n),this._addButtons=a.find("button")},__insertRowActionsStack:[],__insertRowActions:function(e,t){"use strict";let a=this;-1!==["saveInsertRow","clickSourceButton"].indexOf(e)&&setTimeout((function(){a.model.getDefferedProcess().then(t)}),450)},_saveInsertRow:function(e){let a=this,i=t.Deferred();if(Object.keys(a._insertError).length){let e=Object.keys(a._insertError)[0],n=a._insertError[e].toString();App.notify(n,App.translate("Error in %s field",t("<span>").text(a.fields[e].title||a.fields[e].name).text())),a._currentInsertCellIndex=a.fieldCategories.visibleColumns.findIndex((function(t){if(t.name===e)return!0})),a._insertFocusIt(),i.reject()}else{let t=function(){a._insertRowActive=!1,a.model.add(a._insertRowHash).then((function(t){switch(a.table_modify.call(a,t),a._insertRowHash=null,a._insertRowFields=null,a._insertRowActive=!0,a._currentInsertCellIndex=0,e){case"notClean":let e={};Object.keys(a._insertItem).forEach(t=>{a._insertItem[t]&&"object"==typeof a._insertItem[t]&&"v"in a._insertItem[t]&&(!a.fields[t].code||a._insertItem[t].h||a.fields[t].copyOnDuplicate)&&(e[t]=a._insertItem[t].v)}),a._insertRow.html('<td class="id"></td>'),a._createInsertRow(a._insertRow,!0,e);break;case"close":a._closeInsertRow();break;default:a._insertItem=null,a._insertRow.html('<td class="id"></td>'),a._createInsertRow(a._insertRow,0)}})).always((function(){i.resolve()})).fail(()=>{a._insertRowActive=!0})};a.model.doAfterProcesses(t)}return i.promise()},_addInsertRow:function(){let t=this;"cycles"===this.tableRow.type?t.model.add({}).then((function(a){a.firstTableId?e.location.href=e.location.pathname+"/"+a.chdata.rows[0].id+"/"+a.firstTableId:t.table_modify(a)})):t.isMobile?t._addInsertWithPanel():t._addInsert()},_getInsertButtons:function(){let a,i,n=this;"cycles"===this.tableRow.type?i=a=function(){n.model.add({}).then((function(t){t.firstTableId?e.location.href=e.location.pathname+"/"+t.chdata.rows[0].id+"/"+t.firstTableId:n.table_modify(t)}))}:(a=function(){n.isMobile?n._addInsertWithPanel():n._addInsert()},i=function(){n._addInsertWithPanel()}),this._insertButtons=t("<span>");const l=(e,a,i)=>t("<button "+(i?'data-action="'+i+'"':"")+' class="btn btn-sm btn-warning">'+e+"</button>").appendTo(this._insertButtons).on("click",a);return this.isTreeView&&"cycles"===this.tableRow.type||("panels"===this.viewType||this.isRotatedView||this.isTreeView?this.isTreeView&&this.fields.tree.treeHideAddButton||this.f.hideadd||l(App.translate("Add"),i,"add").width(80):(2===this.tableRow.id||this.f.hideadd||l(App.translate("Add"),a,"add").width(80),!n.isMobile&&this.tableRow.panel&&l('<i class="fa fa-th-large"></i>',i,"panel-adding").css("margin-left",5))),this._insertButtons},_addInsertWithPanel:function(e){let t=this;new EditPanel(t,null,e||{}).then((function(e){e&&t.table_modify.call(t,e)}))},_closeInsertRow:function(){this._insertPanel?this._insertPanel=null:this._insertRow&&(this._insertRow.find("td").each((function(){t(this).remove()})),this._insertRow.remove(),this._insertRow=null,this._insertRowHash=null,this._insertRowFields=null,this._insertRowActive=!1),this._insertItem=null,this._insertButtonsChangeStatuses(),this._currentInsertCellIndex=0,this._table.removeClass("with-adding-row")},_createInsertRow:function(e,a,i){var l=this,s=l._insertItem||(l._insertItem={});e||(this.insertRow=e=t('<tr class="InsertRow" style="height: 35px;"><td class="id"></td></tr>').on("click focus keydown","input,button,select",(function(e){let a=t(this);if(a.is("input")&&-1!==["focus","focusin"].indexOf(e.type)&&a.select(),"keydown"===e.type)return"Tab"!==e.key||(e.preventDefault(),!1);"focus"!==e.type&&"click"!==e.type&&"focusin"!==e.type||(l._insertFocusTimeout&&clearTimeout(l._insertFocusTimeout),l._insertBlurDelay=Date.now()+100);let i=l._insertRow.find(".active");i.length&&(a.is('[type="checkbox"]')||i===t(this).closest("td"))||(i.removeClass("active"),l._currentInsertCellIndex=t(this).closest("td").data("index"),t(this).closest("td").addClass("active"))})),this._InsertAddInsertBtnsPanel(e),this.insertRow.editedFields={}),l._currentInsertCellIndex||(l._currentInsertCellIndex=0);let o={};i&&(o="object"==typeof i?i:{[i]:l._insertItem[i].v});let r=[];return l.fieldCategories.visibleColumns.forEach((function(e){r.push(e.name)})),l._insertRowWait[0]=!0,l.model.checkInsertRow(o,l._insertRowHash,this.insertRow.clearField,l._insertRowHash?"true":"all").then((function(a){l.insertRow.clearField=null,l._insertRowHash=l._insertRowHash||a.hash,l._insertRowFields=l._insertRowFields||(e=>{let a=[];return l.fieldCategories.visibleColumns.forEach(i=>{i=t.extend({},i),a.push(i),i.hash=e,i.waiting=l._insertRowWait}),a})(a.hash),s=a.row;let o=2;a.selects&&Object.keys(a.selects).forEach(e=>{l._insertRowFields.forEach(t=>{t.name===e&&(t.loadedSelect=a.selects[e])})}),t.each(l._insertRowFields,(function(a,d){if(!d.showMeWidth)return void(l._insertItem[d.name]=s[d.name]);let c=r.indexOf(d.name);var p=e.find("td:eq("+(c+1)+")");let h=t.extend(!0,{},l._insertItem[d.name]),f=l._insertItem[d.name]&&l._insertItem[d.name].force;if(l._insertItem[d.name]=s[d.name],p.length){let t="n"===d.name||l._insertItem[d.name].f&&!0===l._insertItem[d.name].f.block;if(p.data("input")&&!t){d.name;let t=!1;t=!f&&(null===s[d.name].v&&""==h.v||Object.equals(s[d.name].v,h.v)&&!d.codeSelectIndividual&&(-1===["select","tree"].indexOf(d.type)||d.list)),(void 0===h||!t||"data_src"==d.name||"comments"==d.type||d.code&&!d.codeOnlyInAdd)&&(l._createInsertCell.call(l,p,d,e,c,"td",l._createInsertRow),i===d.name&&l._colorizeElement(p,n))}else p.replaceWith(l._createInsertCell.call(l,null,d,e,c,"td",l._createInsertRow))}else e.append(p=l._createInsertCell.call(l,null,d,e,c,"td",l._createInsertRow));if(p.data("input")){p.data("input").find("button:first");p.data("input").attr("tabindex",o++)}})),l._addButtons.each((function(e,a){t(a).attr("tabindex",o++)})),l._insertFocusIt.call(l),l._insertRowWait[0]=!1})),e},_createInsertCell:function(a,n,l,s,o,r){var d=this;o=o||"td",(a=a||t("<"+o+">").each((e,a)=>{$_td=t(a),n.help&&$_td.on("focus","input,button,select",(function(e){let a=d._table.find("thead th #field-help-"+n.name),i=t(e.target);n.help.match("<hide(/?)>")||setTimeout((function(){a.trigger("open"),i.one("blur remove",(function(){a.trigger("close")}))}),120)}))})).data("index",s),n.code&&a.addClass("with-code"),void 0===d._insertItem[n.name]&&(d._insertItem[n.name]=null);let c=d._insertItem[n.name]&&d._insertItem[n.name].f||{};if(!n.insertable||!0===c.block){let e=d._insertItem[n.name];if(e&&(e=e.v),a.empty().append(t('<span class="cell-value">').html(c.text?c.text:n.getCellText(e,a,d._insertItem))),c.comment){let e=t('<i class="fa fa-info pull-right" style="padding: 3px;">');e.attr("title",c.comment),a.prepend(e)}else if(c.icon&&"button"!==n.type){let e=t('<i class="fa fa-'+c.icon+' pull-right" style="padding: 3px;">');a.prepend(e)}return(c.icon||c.text||c.comment)&&a.on("click",()=>{if(a.attr("aria-describedby"))return!0;let i=t("<div>"),l=t("<div>").text(e).appendTo(i);if(c.icon){let e=t('<i class="fa fa-'+c.icon+'" style="padding: 3px;">');l.prepend(e)}if(c.text){let e=t('<div><i class="fa fa-font" style="padding: 3px;"> </div>');e.append(c.text),i.append(e)}if(c.comment){let e=t('<div><i class="fa fa-info" style="padding: 3px;"> </div>');e.append(c.comment),i.append(e)}if(!d.isMobile){let e="right",t=i.offset().left,n=d._container.offset().left;d._container.width()-(t-n)-i.width()<(i.is(".text")?340:240)&&(e="left");let l={isParams:!0,$text:i,element:a,container:d._container,placement:e,trigger:"manual"};return App.popNotify(l),d.closeCallbackAdd(()=>{a.popover("destroy")},"insertPanelDestroy",120),!0}App.mobilePanel(n.title,i)}),a}var p=function(e){var t;try{t=n.getEditVal(e),delete d._insertError[n.name],f.removeClass("error")}catch(e){return f.addClass("error"),d._insertError[n.name]=e,null}return t},h=function(e,t,i,c){var h=c?c.v:p(e);"hidden"!==t.type&&(d._currentInsertCellIndex=s+1),null===h||!0===i?(r.call(d,l,d._currentInsertCellIndex,n.name),"hidden"!==t.type&&d._insertFocusIt.call(d)):n.isDataModified(h,d._insertItem[n.name].v)?(d.insertRow.editedFields[n.name]=!0,d._insertItem[n.name].v=h,!0===n.isPanelField&&d._createInsertCell.call(d,a,n,l,s,o,r),r.call(d,l,d._currentInsertCellIndex,n.name)):"hidden"!==t.type&&d._insertFocusIt.call(d)};let f=n.getEditElement(a.data("input"),d._insertItem[n.name],d._insertItem,h,(function(e,t){let a=e.closest("td");if(!a.length||!a.closest("tr").length)return!1;let c=p(e),h=d._insertItem[n.name].v+"";n.isDataModified(c,h)&&(d._createInsertCell(a,n,l,s,o,r),d._colorizeElement(a,i)),d._currentInsertCellIndex=s+1,d._insertFocusIt.call(d)}),(function(e,t,a,i){i&&d._insertBlurDelay<Date.now()&&(d._currentInsertCellIndex=s+(-1===i?-1:1),d._insertFocusIt.call(d)),setTimeout((function(){if(!e)return;let t=e.closest("td");if(!t.length||!t.closest("tr").length)return!1;let a=p(e);n.isDataModified(a,d._insertItem[n.name].v)&&(d.insertRow.editedFields[n.name]=!0,d._insertItem[n.name].v=a,!0===n.isPanelField&&d._createInsertCell.call(d,t,n,l,s,o,r),r.call(d,l,d._currentInsertCellIndex,n.name))}),10)}));if(c&&c.placeholder&&n.addPlaceholder&&n.addPlaceholder(f,c.placeholder),f.isAttached()||a.html(f).data("input",f),n.code&&!n.codeOnlyInAdd){let e=a.find(".fa-hand-paper-o");d._insertItem&&d._insertItem[n.name].h?0===e.length&&(e=t('<i class="fa fa-hand-paper-o pull-right">').on("click",()=>{this.insertRow.clearField=n.name,r.call(d,l,d._currentInsertCellIndex+1)}),a.prepend(e).addClass("ins-handed")):(1===e.length&&e.remove(),a.removeClass("ins-handed"))}if("select"===n.type&&2===n.changeSelectTable){a.addClass("with-source-add-button");let i=t('<button class="btn btn-default btn-sm source-add" tabindex="-1"><i class="fa fa-plus"></i></button>');a.prepend(i);let l=function(){let a={},i=d._insertItem;t.each(i,(function(e,t){"$"!==e.substring(0,1)&&(a[e]=t)}));a[n.name]=null;let l=0,s=e.top.App.randomIds.get();return t(e.top.document.body).on("pctable-closed.select-add-"+s,(function(e,a){if(!a.panel||a.panel.srcRandomId!==s)return;l--;let o=a&&"insert"===a.method&&a.json&&a.json.chdata&&a.json.chdata.rows;if(0===l||o){let e=f;if(delete n.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),o){let l=t.extend(!0,{},i[n.name]);n.multiple?l.v.push(Object.keys(a.json.chdata.rows)[0]):l.v=Object.keys(a.json.chdata.rows)[0],h(e,{type:"hidden"},!1,l)}t("body").off(".select-add-"+s)}})),d.model.selectSourceTableAction(n.name,a,!0).then(()=>{let a;t(e.top.document.body).on("pctable-opened.select-add-"+s,(function(i,n){n.panel.srcRandomId=s,l++,a&&clearTimeout(a),a=setTimeout(()=>{t(e.top.document.body).off("pctable-opened.select-add-"+s),e.top.App.randomIds.delete(s)},200)}))}),!1};i.on("click",(function(){d.__insertRowActions("clickSourceButton",l)}))}return a},_insertFocusIt:function(e){let a=this;if(!e)return this._insertFocusTimeout=setTimeout((function(){a._insertFocusIt.call(a,1)}),10),!1;let i=!0,n=!!this._insertPanel,l=this.insertRow;if(n){if(!a._insertPanel)return!1;l=a._insertPanel.$modalBody}if(!l||!l.length)return!1;if(t.each(a._insertRowFields,(function(e,t){if(a._currentInsertCellIndex==e){if(!t.insertable||a._insertItem&&a._insertItem[t.name]&&a._insertItem[t.name].f&&!0===a._insertItem[t.name].f.block)return void a._currentInsertCellIndex++;{let i;n?t.focusElement(l.find(".cell:eq("+(i=e)+")").data("input")):t.focusElement(a._getTdByColumnIndex(l,i=e+1).data("input"))}return i=!1,!1}})),i)if(this.insertRow.find("td.active").removeClass("active"),n){a._insertPanel.indexedButtons[Object.keys(a._insertPanel.indexedButtons)[0]].focus()}else t("#saveInsertRow").parent().focus()}}),t.extend(App.pcTableMain.prototype,{_rerenderColumnsFooter:function(){let e=this._createFootersTableBlock();this._footersBlock.replaceWith(e),this._footersBlock=e},_rerendParamsblock:function(){this._createParamsBlock(),this.isMobile&&this._paramsBlock&&this._refreshParamsBlock()},_rerendFiltersBlock:function(){this._filtersBlock.replaceWith($block=this._createFiltersBlock()),this._filtersBlock=$block,this._refreshFiltersBlock(this.data_params)},_rerendBottomFoolers:function(){this._createFootersSubtable(),this.isMobile&&this._footersBlock&&this._refreshFootersBlock()},_renderTable:function(){let e=this;this._table=t("<table>").addClass(this.tableClass),this.notCorrectOrder&&this._table.addClass("no-correct-n-filtered"),this.isRotatedView?(this._innerContainer.addClass("rotatedPcTable"),this._table.append(this._createHead()).append(this._createBody())):this._table.append(this._createHead()).append(this._createFirstBody()).append(this._createBody()).append(this._createAfterBody()),this._footersBlock=this._createFootersTableBlock(),this._table.append(this._footersBlock),this._popovers=t('<div class="popovers">'),e.isTreeView?(e._connectTreeView.call(e),this.addReOrderRowBind()):this.addReOrderRowBind(),1===this.fieldCategories.column.length&&e._container.addClass("no-fields");let a=this.scrollWrapper=this._container.append('<div class="pcTable-scrollwrapper">').find(".pcTable-scrollwrapper");a.append(this._createBeforeSpace()).append(this._createTableText()),this.isCreatorView&&a.append(this._refreshHiddenFieldsBlock()),this._paramsBlock=this._createParamsBlock(a);let i=t('<div class="pcTable-rowsWrapper">').appendTo(a);i.append(this._createRowsTitle(i)).append(this._createFiltersBlock()).append(()=>{if(!this.isTreeView&&this.tableRow.pagination&&"0/0"!==this.tableRow.pagination&&this.tableRow.pagination.match(/^[\d]+\/[\d]/))return this._pagination()}).append(this._rowsButtons()).append(this._innerContainer),this.RightBottomPanel=t('<div id="right-bottom-panel">').appendTo(this._innerContainer),this.RightBottomServicesButton=t('<button id="servicesButton" disabled><i class="fa fa-ellipsis-h"/></button>'),this.RightBottomServicesButtonCheckAttached()&&setTimeout(()=>{e.RightBottomServicesButtonRefresh()},10),this._footersSubTable=this._createFootersSubtable(a),a.append(this._footersSubTable).append(this._popovers),this.addScrollsRules(),this._seeCalcucatedValData(),this._seeSelectPreview(),this._clickstoCopyMe(),this.isCreatorView&&this._hideHell_storage.checkIssetFields.call(this)},RightBottomServicesButtonCheckAttached:function(){let t,a=this.RightBottomServicesButton.isAttached();return this.isMobile||!e.location.pathname.match(/^\/Table\//)?t=!1:e.top!=e?(t=!1,"boolean"==typeof this.hideWindowDots?t=!this.hideWindowDots:this.f&&this.f.hidedots&&(t=!this.f.hidedots.w)):(t=!0,this.f&&this.f.hidedots&&(t=!this.f.hidedots.t)),a?t||this.RightBottomServicesButton.detach():t&&(this.RightBottomPanel.is(":empty")||0===this.RightBottomPanel.find("#summarizer").length?this.RightBottomServicesButton.prependTo(this.RightBottomPanel):this.RightBottomServicesButton.insertAfter(this.selectedCells.summarizer.element)),t},RightBottomServicesButtonDone:function(){this.RightBottomServicesButton.find("i").removeClass("fa-ellipsis-h").addClass("fa-check"),setTimeout(()=>{this.RightBottomServicesButton.find("i").removeClass("fa-check").addClass("fa-ellipsis-h")},200)},RightBottomServicesButtonTrobber:function(){return this.RightBottomServicesButton.find("i").removeClass("fa-ellipsis-h").addClass("fa-spinner fa-spin"),()=>{this.RightBottomServicesButton.find("i").removeClass("fa-spinner fa-spin").addClass("fa-ellipsis-h")}},RightBottomServicesButtonRefresh:function(){this.tableRow.__xlsx||this.tableRow.__xlsx_import||this.selectedCells.isMultySelectedCells()||this.f.dotbuttons&&this.f.dotbuttons.length?(this.RightBottomServicesButton.prop("disabled",""),this.RightBottomServicesButton.on("click",()=>{if(this.RightBottomServicesButton.attr("aria-describedby"))return;let e=this,a=t('<div style="width: 150px"></div>').on("click","button",(function(){let a=t(this);switch(a.data("name")){case"copy":e.selectedCells.copySepected.call(e),e.RightBottomServicesButtonDone();break;case"copy-with-names":e.selectedCells.copySepected.call(e,!0),e.RightBottomServicesButtonDone();break;case"xlsx-export-with-names":case"xlsx-export":let t="xlsx-export-with-names"===a.data("name");if(e.selectedCells.isMultySelectedCells()){let a=e.RightBottomServicesButtonTrobber();e._excelCopyExportForm(i=>{e.selectedCells.copySepected.call(e,t,t=>{e.model.excelExport(t,e.f.title||e.tableRow.title).always(a).then(()=>{e.RightBottomServicesButtonDone()})},i)})}else e._print(a=>{let i=e.RightBottomServicesButtonTrobber();e.selectedCells.copySepected.call(e,t,t=>{e.model.excelExport(t,e.f.title||e.tableRow.title).always(i).then(()=>{e.RightBottomServicesButtonDone()})},a)});break;case"xlsx-import":let i=e.RightBottomServicesButtonTrobber();e.model.excelImport(e.f.title||e.tableRow.title).always(i).then(()=>{e.RightBottomServicesButtonDone()});break;default:e._buttonClick(a.parent(),e.fields[a.data("field")])}}));if(this.selectedCells.isMultySelectedCells()){let e=App.translate("Copy selected");a.append('<div><button class="btn-default btn btn-sm" data-name="copy" title="'+e+'"><i class="fa fa-copy"></i>'+e+"</button></div>"),e=App.translate("Copy with names"),a.append('<div><button class="btn-default btn btn-sm" data-name="copy-with-names" title="'+e+'"><i class="fa fa-clone"></i>'+e+"</button></div>")}if(this.tableRow.__xlsx){let e=App.translate("Excel export with names");a.append('<div><button class="btn-default btn btn-sm" title="'+e+'" data-name="xlsx-export-with-names"><i class="fa fa-file-excel-o"></i>'+e+"</button></div>"),e=App.translate("Excel export"),a.append('<div><button class="btn-default btn btn-sm" title="'+e+'" data-name="xlsx-export"><i class="fa fa-file-excel-o"></i>'+e+"</button></div>")}if(this.tableRow.__xlsx_import){let e=App.translate("Excel import");a.append('<div><button class="btn-default btn btn-sm" title="'+e+'" data-name="xlsx-import"><i class="fa fa-file-excel-o"></i>'+e+"</button></div>")}this.f.dotbuttons&&this.f.dotbuttons.forEach&&this.f.dotbuttons.forEach(e=>{let t=this.fields[e].f&&"text"in this.fields[e].f?this.fields[e].f.text:this.fields[e].buttonText,i=this.data_params[e].f&&"icon"in this.data_params[e].f?this.data_params[e].f.icon:"hand-pointer-o";a.append('<div><button class="btn-default btn btn-sm" title="'+t+'" data-field="'+e+'"><i class="fa fa-'+i+'"></i>'+t+"</button></div>")}),App.popNotify({isParams:!0,$text:a,element:this.RightBottomServicesButton,trigger:"manual",container:t("body"),placement:"top",class:"bottomRightPopover"}),this.RightBottomServicesButton.popover("show"),setTimeout(()=>{this.closeCallbacks.push(()=>{this.RightBottomServicesButton.popover("destroy")})},200)})):(this.RightBottomServicesButton.prop("disabled","disabled"),this.RightBottomServicesButton.off("click"))},_refreshHiddenFieldsBlock:function(){let e=this._hiddenFieldsBlock();return this.HiddenFieldsBlock&&this.HiddenFieldsBlock.replaceWith(e),this.HiddenFieldsBlock=e,this.HiddenFieldsBlock},_hiddenFieldsBlock:function(){let e,a,i=this,n=0,l=t('<div class="pcTable-hiddenFieldsTables">'),s=0;if(this.beforeSpaceHide||!this._hideHell_storage.getOpened.call(this))return l;let o=this._container.width()-100;return t.each(i.hidden_fields||[],(function(r,d){n++;let c=d.width>0?d.width:100;(0===s||o<s+c)&&(e&&e.width(s),e=t("<table class='pcTable-hiddenFieldsTable'><thead><tr></tr></thead></table>\""),l.append(e),s=0,a=e.find("thead tr")),a.append(i._createHeadCell(r,d)),s+=d.width})),i.isCreatorView&&Object.keys(i.fields).forEach((function(r,d){let c=i.fields[r];if(c.showInWeb&&c.showMeWidth<1&&"n"!==c.name){n++;let r=c.width>0?c.width:100;(0===s||o<s+r)&&(e&&e.width(s),e=t("<table class='pcTable-hiddenFieldsTable'><thead><tr></tr></thead></table>\""),l.append(e),s=0,a=e.find("thead tr")),a.append(i._createHeadCell(d,c)),s+=c.width}})),e&&e.width(s),n?l:t('<div class="pcTable-hiddenFieldsTables">')},_clickstoCopyMe:function(){this._container.on("click",".copy_me",(function(){let e=t(this);return e.data("clicked")||(e.data("clicked",!0),e.width(e.width()),e.data("text")?App.copyMe(e.data("text")):App.copyMe(e.text()),e.button("copied"),setTimeout((function(){e.button("reset"),e.removeData("clicked")}),2e3),e.blur(),t("body").click()),!1}))},_seeCalcucatedValData:function(){var e=this;this._container.on("mouseover","td .fa-hand-paper-o",(function(){if(!e.isMobile){var a=t(this),i=a.closest("td");if(i.closest("tr").is(".InsertRow"))return!1;var n=e._getItemBytd(i),l=e._getFieldBytd(i),s=t("<div>");let o="";null===n[l.name].c||""===n[l.name].c||void 0===n[l.name].c?o="":"select"===l.type?l.multiple?t.each(n[l.name].c,(function(e,t){""!==o&&(o+=", "),o+=l.getElementString(n[l.name].c[e],n[l.name].c_[e])})):o=l.getElementString(n[l.name].c,n[l.name].c_):o=n[l.name].c,s.append(t("<div>"+App.translate("Calculated value")+": </div>").append(t("<code>").text(o.length<=50?o:o.toString().substr(0,47)+"..."))),a.one("mouseout",(function(){s.length&&(s.remove(),s=null)})),setTimeout((function(){s&&s.length&&App.popNotify(s,a)}),500)}}))},_seeSelectPreview:function(){t("body").on("mouseover",".select-with-preview li",(function(e){let a=t(this),i=setTimeout((function(){if(a.is(":hover")){let e=a.find("span.select-with-preview");App.selectFieldPreview&&e.data("field")===App.selectFieldPreview.name&&App.selectFieldPreview.previewPanel(e,a)}}),300);a.one("mouseout",(function(){i&&clearTimeout(i)}))}))},_getFavoriteStar:function(){let e=this.tableRow.__is_in_favorites=this.tableRow.__is_in_favorites||!1,a=t("#favorite-start"),i=this;return null===e?t():(0===a.length&&"calcs"!==this.tableRow.type&&(a=t('<button class="btn btn-default btn-sm" id="favorite-start"></button>').on("click",(function(){i.model.setTableFavorite(!a.is(".stared")).then((function(e){i.tableRow.__is_in_favorites=e.status,i._getFavoriteStar.call(i)}))}))),e?a.addClass("stared").text(""):a.removeClass("stared").text(""),a)},_createBeforeSpace:function(){let i,n=this;if(this._beforeSpace=t('<div class="pcTable-beforeSpace">'),!n.beforeSpaceHide){n.LogButton=t(),i=t('<div class="pcTable-topButtons">');let e=t("#TOTUM_FOOTER");if(!e.length||!n.isCreatorView&&n.hide_teh_plate||i.append(e),n.isCreatorView||n.shadowedCreator){let a=t('<div class="creator-log-buttons">'),l=t.cookie("pcTableLogs")||"[]";l=JSON.parse(l),(l.length||n.FullLOGS)&&(a.addClass("with-logs"),setTimeout(()=>{App.blink(a.find("button"),6,"#fff")},100));let s=t('<button class="btn btn-danger btn-sm"><i class="fa" style="width: 12px"></i> '+App.translate("Show logs")+"</button>").appendTo(a).on("click",(function(){let e;const i=function(){let i=[];e.find("input:checked").each((function(e,a){i.push(t(a).attr("name"))})),i.length>0?s.find("i").attr("class","fa fa-check-square-o"):s.find("i").attr("class","fa fa-square-o"),t.cookie("pcTableLogs",JSON.stringify(i),{path:"/"}),n.FullLOGS=[],n.LOGS={},s.popover("destroy"),i.length?a.addClass("with-logs"):a.removeClass("with-logs"),l=i};if(s.is("[aria-describedby]"))e=t("#"+s.attr("aria-describedby")),i();else{e=t('<div class="creator-log-checkboxes">'),e.append('<div><input type="checkbox" name="c"/> '+App.translate("Code")+"</div>"),e.append('<div><input type="checkbox" name="a"/> '+App.translate("Action code")+"</div>"),e.append('<div style="padding-left: 5px;"><input type="checkbox" name="C"/> '+App.translate("Changes")+"</div>"),e.append('<div><input type="checkbox" name="s"/> '+App.translate("Selects")+"</div>"),e.append('<div><input type="checkbox" name="f"/> '+App.translate("Formating")+"</div>");let a=t('<div><input type="checkbox" name="flds"/> '+App.translate("Fields calculation time")+" </div>");e.append(a),n.FieldLOGS&&n.FieldLOGS.length&&n.FieldLOGS.forEach(e=>{let i=t('<div style="cursor: pointer"><button class="btn btn-xs"><i class="fa fa-table"></i></button> '+e.name+"</div>").on("click",(function(){n.model.calcFieldsLog(JSON.stringify(e.data),e.name)}));a.append(i)}),e.append('<div style="padding-top: 10px;"><button class="btn btn-sm btn-default">'+App.translate("Apply")+"</button></div>"),e.find("input").each((function(e,a){a=t(a),-1!==l.indexOf(a.attr("name"))&&a.prop("checked","checked"),-1!==l.indexOf("flds")?"flds"!==a.attr("name")&&a.prop("disabled",!0):-1===l.indexOf("a")&&"C"===a.attr("name")&&a.prop("disabled",!0)})),e.on("change","input",(function(){switch(t(this).attr("name")){case"flds":let a=t(this).is(":checked");e.find("input").each((e,i)=>{"flds"!==(i=t(i)).attr("name")&&(a?(i.prop("disabled",!0),i.prop("checked",!1)):i.prop("disabled",!1))});break;case"a":t(this).is(":checked")?e.find('input[name="C"]').prop("disabled",!1):e.find('input[name="C"]').prop("disabled",!0).prop("checked",!1)}})),e.on("click","button",(function(){i()})),s.popover({trigger:"manual",placement:"bottom",content:e,html:!0,animation:!1,container:n._container,onhide:function(){}}).popover("show")}})),o=s.find("i");l.length>0?o.addClass("fa-check-square-o"):o.addClass("fa-square-o");let r=t('<button class="btn btn-danger btn-sm">'+App.translate("Log")+"</button>").appendTo(a);n.LogButton=r,r.on("click",(function(){n.FullLOGS&&0!==n.FullLOGS.length?App.logOutput(n.FullLOGS):App.logOutput("Log is empty")})),e.length?e.append(a):a.appendTo(i),t('<button class="btn btn-danger btn-sm"><i class="fa fa-eraser" style="width: 13px"></i></button>').on("click",(function(){n.FullLOGS=[],n.FieldLOGS=[],n.LOGS={}})).appendTo(a)}}let l=t('<span class="common-table-title">');if(l.append(this.fieldsHiddingGetButton(!0)),!n.isMobile){if(t('<button class="btn btn-default btn-sm"><i class="fa fa-print"></i></button>').on("click",(function(){n._printSelect.call(n)})).appendTo(l),n.isCreatorView||t('<button class="btn btn-default btn-sm" id="ttm-extButtonsBar"><i class="fa fa-bars"></i></button>').on("click",(function(){n._tableExtButtons()})).appendTo(l).css("display",n.f.extbuttons&&n.f.extbuttons.length?"inline":"none"),n.withCsvButtons){let e=t('<button class="btn btn-default btn-sm">'+App.translate("CSV-export")+"</button>").on("click",(function(){let a=t('<div><div class="menu-item" data-type="full">'+App.translate("Full")+'</div><div class="menu-item"  data-type="rows">'+App.translate("Only rows")+"</div></div>");a.on("click",".menu-item",(function(){let e=t(this).is('[data-type="full"]')?"full":"rows";a.remove(),n._csvExport(e)}));let i=App.popNotify({isParams:!0,$text:a,element:e,container:this._container,trigger:"manual",placement:"bottom"});t("#"+i).off().on("mouseleave",(function(){t("#"+i).remove()}))}));l.append(e)}if(n.withCsvEditButtons&&this.control.editing){let e=t('<button class="btn btn-default btn-sm">'+App.translate("CSV-import")+"</button>").on("click",(function(){let a=t('<div><div class="menu-item" data-type="full">'+App.translate("Full")+'</div><div class="menu-item"  data-type="rows">'+App.translate("Only rows")+"</div></div>");a.on("click",".menu-item",(function(){let e=t(this).is('[data-type="full"]')?"full":"rows";a.remove(),n._csvImportClick(e)}));let i=App.popNotify({isParams:!0,$text:a,element:e,container:this._container,trigger:"manual",placement:"bottom"});t("#"+i).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",(function(){a.remove()})).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px")}));l.append(e)}}if(this.isAnonim||n.beforeSpaceHide||e.location.pathname.match(/^\/[^\/]+\/\d+\/\d+\/\d+\/\d+$/)||l.append(this._getFavoriteStar()),this.tableRow.panels_view&&"both"===this.tableRow.panels_view.state&&!n.isMobile&&e===e.top){let e;if("off"===n.panels){e=t('<button class="btn btn-sm warning-bg" disabled><i class="fa fa-address-card-o"></i></button>'),App.blink(e,5,"#fff");let a=t("#nav-top-line");a.text(App.translate("The panel view is disabled due to exceeding the number of rows in the displayed table")),a.addClass("pcTable-type-tmp")}else e="panels"!==this.viewType?t('<button class="btn btn-default btn-sm"><i class="fa fa-address-card-o"></i></button>').on("click",()=>{this.model.panelsView(!0).then(()=>{App.windowReloadWithHash(this.model)})}):t('<button class="btn btn-default btn-sm"><i class="fa fa-table"></i></button>').on("click",()=>{this.model.panelsView(!1).then(()=>{App.windowReloadWithHash(this.model)})});l.append(e)}if(this.isCreatorView&&this.isMain){let e=t('<div class="creator-buttons">');t('<button class="btn btn-default btn-xxs field_name copy_me" data-copied-text="'+App.translate("Copied")+'"/>').text(this.tableRow.name).appendTo(e),t('<a class="btn btn-danger btn-xxs" title="'+App.translate("Edit table settings")+'"/>').html('<i class="fa fa-pencil-square-o"></i>').on("click",()=>(new EditPanel(1,BootstrapDialog.TYPE_DANGER,{id:n.tableRow.id,cycle_id:n.tableRow.cycle_id}).then(e=>{e&&App.windowReloadWithHash(n.model)}),!1)).appendTo(e);let l={fl_name:[this.tableRow.id]};if(t('<a href="/Table/'+this.Tables.branchId+"/"+this.Tables.id+"/?"+t.param({f:l})+'" target="_blank" class="btn btn-danger btn-xxs" title="'+App.translate("Open Tables")+'"/>').html('<i class="fa fa-external-link"></i>').appendTo(e),l={f_table_categories:this.tableRow.category,f_table:this.tableRow.id},this.tableRow.__version&&(l.fl_version=this.tableRow.__version),t('<a href="/Table/'+this.Tables.branchId+"/"+this.TableFields.id+"/?"+t.param({f:l})+'" target="_blank" class="btn btn-danger btn-xxs" title="'+App.translate("Open Tables Fields")+'"/>').html('<i class="fa fa-external-link-square"></i>').appendTo(e),"calcs"===this.tableRow.type){e.append(" ");let a=t('<a href="/Table/'+this.TablesVersions.branchId+"/"+this.TablesVersions.id+"?"+t.param({f:this.calcstable_cycle_version_filters})+'" target="_blank" class="btn btn-danger btn-xxs" title="'+App.translate("Creating tables versions")+'"><i class="fa fa-code-fork"></i></a>');e.append(a),e.append(" "),a=t('<a href="/Table/'+this.TablesCyclesVersions.branchId+"/"+this.TablesCyclesVersions.id+"?"+t.param({f:this.calcstable_versions_filters})+'" target="_blank" class="btn btn-danger btn-xxs" title="'+App.translate("Changing versions of cycle tables")+'"><i class="fa fa-random"></i></a>'),e.append(a)}let s=t('<div class="color-danger creator-table-title">'+ +this.tableRow.sort+' <i class="'+App.tableTypes[this.tableRow.type].icon+'"></i> '+App.tableTypes[this.tableRow.type].title+" ["+this.tableRow.actual+"]</div>");e.append(s),"calcs"===this.tableRow.type&&s.append(App.translate(" / Version %s / Cycle %s",[this.tableRow.__version,this.tableRow.cycle_id]));const o=(e,t)=>{e.toggleClass("warning-bg",!0===t)};if([[App.translate("Creator-tableEditButtons-default_action"),"default_action","codeAction"],[App.translate("Creator-tableEditButtons-on_duplicate"),"on_duplicate","codeAction"],[App.translate("Creator-tableEditButtons-row_format"),"row_format","format"],[App.translate("Creator-tableEditButtons-table_format"),"table_format","format"]].forEach(a=>{let i=t('<button class="btn btn-danger btn-xxs"></button>').text(a[0]).on("click",(function(){n.editTableCode(a[1],a[2]).then(()=>{App.blink(t(this),3,"green","color");let e=n.tableRow[a[1]].split("\n").some(e=>!!e.match(/^\s*[a-z0-9]*\=\:\s*[^\s]+/,"mu"));o(i,e)})})).appendTo(e);o(i,n.tableRow[a[1]])}),t('<button class="btn btn-danger btn-xxs" id="hide-hell" disabled><i class="fa fa-times"></i></span></button>').on("click",(function(){n._hideHell_storage.switchOpened.call(n)})).appendTo(e),e.appendTo(i),-1!==["simple","tmp"].indexOf(this.tableRow.type)){let a=t('<button class="btn btn-danger btn-xxs" id="quickForms"><i class="fa fa-cubes"></i></button>').on("click",(function(){let e=t('<div><div class="menu-item" data-type="quick">'+App.translate("Add form")+'</div><div class="menu-item"  data-type="forms">'+App.translate("Forms")+"</div></div>");e.on("click",".menu-item",(function(){n.model.formsLinks=n.model.formsLinks||function(e){return this.__ajax("post",{type:e,method:"formsLinks"})};let a=t(this).is('[data-type="quick"]')?"quick":"forms";e.remove(),n.model.formsLinks(a)}));let i=App.popNotify({isParams:!0,$text:e,element:a,container:this._container,trigger:"manual",placement:"bottom"});t("#"+i).on("mouseleave",(function(){t("#"+i).remove()}))})).appendTo(e);a.toggleClass("warning-bg",!!n.tableRow.__is_in_forms)}t('<button class="btn btn-danger btn-xxs" id="addField">'+App.translate("Add field")+"</button>").width(113).on("click",(function(){let e={table_id:{v:n.tableRow.id},data_src:{v:a()}};n.tableRow.__version&&(e.version={v:n.tableRow.__version}),e.cycle_id=n.tableRow.cycle_id,new EditPanel(2,BootstrapDialog.TYPE_DANGER,e).then((function(e){e&&App.windowReloadWithHash(n.model)}))})).appendTo(e),e.appendTo(i)}if(n.beforeSpaceHide)this._beforeSpace_title=t('<div class="pcTable-title"><span class="bttns"/></div>').prependTo(this._beforeSpace);else if(this._beforeSpace.append(i),this._beforeSpace_title=t('<div class="pcTable-title"><span class="title"/><span class="bttns"/><div class="updated"/></div>').prependTo(this._beforeSpace),("calcs"===this.tableRow.type||new URLSearchParams(e.location.search).has("b"))&&e.TREE_DATA){let a,i,n=t('<div class="pcTable-tabls"><ul class="nav nav-tabs"></div>'),l=n.find("ul");if(e.location.pathname.match(/^\/[^\/]+\/\d+\/\d+\/\d+\/\d+$/)){a=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+).*?$/,"$1"),i=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+\/[^\/]+).*?$/,"$1")+"/",sessionStorage.getItem("cycles_table_anchor")&&(i=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+\/[^\/]+).*?$/,sessionStorage.getItem("cycles_table_anchor"))+"/");let n=sessionStorage.getItem("cycles_filter");n&&(n=JSON.parse(n),n.id==this.tableRow.tree_node_id&&(i+="?",n.filter&&(i+="f="+encodeURIComponent(n.filter)),n.onPage&&(n.filter&&(i+="&"),i+="onPage="+encodeURIComponent(n.onPage),i+="&offset="+encodeURIComponent(n.offset))));let s=!1;e.TREE_DATA.forEach(e=>{if(e.isCycleTable)if(s||(e.isOneUserCycle?l.css("padding-left",45):l.append('<li><a href="/Table/'+i+'" class="calcs-arrow-back"><i class="fa fa-arrow-left"></a></li>'),s=!0),e.state.selected)l.append('<li class="active"><a class="tab-title">'+e.text+"</a></li>");else if("tab_button"===e.type){let a=t("<li><a>"+e.text+"</a></li>").on("click",()=>(App.clickToCyclesTabButton(e.id),!1));l.append(a)}else l.append('<li><a href="/Table/'+a+"/"+e.href+'">'+e.text+"</a></li>")})}else{i=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+).*?$/,"$1");let t=!1;e.TREE_DATA.forEach(e=>{e.isCycleTable&&(t||(l.append('<li><a href="/Table/'+i+'/"><i class="fa fa-arrow-left"></a></li>'),t=!0),e.id==="table"+this.tableRow.id?l.append('<li class="active"><a class="tab-title">'+e.text+"</a></li>"):l.append('<li><a href="'+e.link+'">'+e.text+"</a></li>"))})}this._beforeSpace.append(n)}if(this.withTopButtons?(this._beforeSpace_title.append(l),!1===this.f.topbuttons&&(this.isCreatorView&&e===e.top?l.addClass("admin-hidden"):l.hide())):this.isCreatorView&&e===e.top&&(this._beforeSpace_title.append(l),l.addClass("admin-hidden")),this.tableRow.description){let e=t('<a class="btn btn-default btn-sm"><i class="fa fa-info"></i></a>'),a=t('<div class="table-description"/>').html(this.tableRow.description),i=t('<button class="btn btn-default btn-sm close-table-description"><i class="fa fa-times"></i></button>');a.append(i),e.appendTo(l);let n="table_description_switcher"+this.tableRow.id,s=this.tableRow.description.match("<hide(/?)>")?"0":localStorage.getItem(n)||localStorage.setItem(n,"1")||localStorage.getItem(n);const o=t=>{switch(t&&(s="1"===s?"0":"1"),s){case"1":a.show(),e.removeClass("btn-warning").addClass("btn-default");break;default:a.hide(),e.addClass("btn-warning").removeClass("btn-default")}localStorage.setItem(n,s),t&&this.ScrollClasterized.insertToDOM(0,!0)};o(),e.on("click",o),i.on("click",o),this._beforeSpace.append(a)}return this._beforeSpace},__$rowsButtons:null,applyPage:function(e,t,a){let i;this.rows=e.rows,i=e.rows.length?{firstId:e.rows[0].id,lastId:e.rows[e.rows.length-1].id,ids:e.rows.map(e=>e.id)}:{firstId:0,lastId:0,ids:[]},void 0===e.offset&&void 0===a&&(a=this.PageData.offset),this.PageData={...this.PageData,offset:void 0===e.offset?a:e.offset,allCount:void 0===t?e.allCount:t,loading:!1,...i},this.initRowsData(),this._refreshContentTable(!1,!0),this.__applyFilters(!0),this.PageData.$block.empty().append(this._paginationCreateBlock()),e.f&&this.apptyTableFormats(e.f),this.selectedCells.summarizer.check()},_paginationCreateBlock:function(){let{offset:e,onPage:a,allCount:i}=this.PageData;if("0"==a)return"";a>3e4&&(a=3e4);let l,s,o,r,d=t("<span></span>"),c=0===e?0:Math.ceil(e/a),p=Math.ceil(i/a);p<c&&(p+=e>a&&e%a>0?1:0),l=e>0?t('<button class="btn btn-default btn-sm"><i class="fa fa-hand-o-left"></i></button>').on("click",()=>{if(!this.PageData.firstId||this.data[this.PageData.firstId])return this.model.loadPage(this,null,this.PageData.onPage,this.PageData.firstId),!1;this.PageData.offset>=this.PageData.allCount?this.model.loadPage(this,null,this.PageData.onPage,-1):0!==Object.keys(this.data).length&&this.PageData.ids.some(e=>{if(this.data[e])return this.PageData.firstId=e,!0})}):t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-hand-o-left"></i></button>'),e+a<i?(s=t('<button class="btn btn-default btn-sm"><i class="fa fa-hand-o-right"></i></button>').on("click",()=>{if(!this.data[this.PageData.lastId]&&0!==Object.keys(this.data).length){let e;for(let t=this.PageData.ids.length-1;t>=0;t--)if(e=this.PageData.ids[t],this.data[e]){this.PageData.lastId=e;break}}return this.model.loadPage(this,this.PageData.lastId,this.PageData.onPage),!1}),r=t('<button class="btn btn-default btn-sm"><i class="fa fa-long-arrow-right"></i></button>').on("click",()=>(this.model.loadPage(this,null,this.PageData.onPage,-1),!1))):(s=t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-hand-o-right"></i></button>'),r=t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-long-arrow-right"></i></button>')),o=c>0?t('<button class="btn btn-default btn-sm"><i class="fa fa-long-arrow-left"></i></button>').on("click",()=>(this.model.loadPage(this,0,this.PageData.onPage),!1)):t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-long-arrow-left"></i></button>');let h=t('<span id="ttm-onpage-input"></span>'),f=t('<input class="form-control" type="number">').appendTo(h).wrap("<span>");if(f.val(a),f.on("change",()=>{let e=null,t=f.val();this.PageData.countLimit&&parseInt(t)>parseInt(this.PageData.countLimit)&&(t=this.PageData.countLimit),this.PageData.onPage!==t&&(this.PageData.allCount<=this.PageData.onPage||c>=Math.floor(this.PageData.allCount/this.PageData.onPage)&&(e=-1),this.PageData.onPage=parseInt(t),this.model.loadPage(this,0,t,e))}),d.append(o),d.append(l),d.append('<span class="ttm-pages">'+App.translate("%s from %s",[c+1,p])+"</span>"),d.append(s),d.append(r),d.append(h),h.append(App.translate("%s from %s",["",i])),p>1&&(d.addClass("ttm-pagination-warning"),h.append(' <i class="fa fa-square"></i>')),this.PageData.allCountChanged&&p>1){let e=h.find(".fa-square"),t=3;const a=()=>{e.css("color",App.theme.getColor(n)),setTimeout(()=>{e.css("color",""),--t>0&&setTimeout(a,200)},200)};setTimeout(a),delete this.PageData.allCountChanged}return this.saveFilterAndPage(),d},_pagination(){if(void 0===this.PageData||this.PageData.loading){let e;this.PageData||(this.PageData={$block:t('<div class="ttm-pagination"></div>')});let a=this.tableRow.pagination.split("**");if(a[1]){let e=a[1].split("/");this.PageData.countLimit=this.isMobile?e[1]:e[0]}let i=a[0].split("/"),n=parseInt(new URL(document.location).searchParams.get("onPage")||(this.isMobile?i[1]:i[0]));return e=i[2]||null,this.PageData.onPage=n,this.model.loadPage(this,e,n,null,new URL(document.location).searchParams.get("offset")).then(()=>{this.selectedCells.applyPointing("pageLoaded")}),this.PageData.$block.empty().append('<i class="fa fa-spinner"></i>')}return this.PageData.$block.empty().append(this._paginationCreateBlock())},rowButtonsCalcWidth:function(){this.tableWidth<this.width-80?this.isMobile||t("body").is(".table-in-notification")?this.__$rowsButtons.width(parseInt(this._table.width())-10):this.__$rowsButtons.width(this._table.width()-70):this.isMobile||this.__$rowsButtons.width(this.width-80)},_rowsButtons:function(){let e,a=this;if(this.__$rowsButtons?e=this.__$rowsButtons.empty():(e=t('<div class="pcTable-buttons">'),this.__$rowsButtons=e),this.fieldCategories.column.length){if(this.isInsertable()){let t=a._getInsertButtons();e.append(t)}if(this.control.restoring&&t('<button data-action="restore" class="btn btn-sm btn-warning">'+App.translate(this.isRestoreView?"Normal mode":"Restore")+"</button>").width(95).css("margin-left","5px").on("click",this.switchRestoreView.bind(this)).appendTo(e),!a.isCreatorView&&a.f&&a.f.buttons&&a.f.buttons.length){const i=e=>{let i=0;return a.f.buttons.forEach(n=>{if(a.fields[n]){let l=t('<span class="button-wrapper">').data("field",n),s=a.fields[n].getCellText(null,l,a.data_params);l.append(s).appendTo(e),s.wrap('<span class="cell-value">'),i<a.fields[n].width&&(i=a.fields[n].width)}}),i};if(a.isMobile){let n=t('<div class="ttm__burger-buttons">');if(i(n),n.length){let i=t('<span class="button-wrapper ttm__burger-wrapper"><button class="btn btn-default btn-xxs button-field"><i class="fa fa-bars"></i></button></span>').appendTo(e);n.find(".cell-button,button").width("100%"),i.popover({content:n,html:!0,animation:!1,trigger:"manual",placement:"bottom"}),i.on("click",()=>{if(!i.attr("aria-describedby")){i.popover("show");const e=n=>{n.originalEvent&&t(n.originalEvent.target).closest(".modal").length?a.closeCallbackAdd(e,null,30):i.popover("hide")};a.closeCallbackAdd(e,null,30)}})}}else i(e)}if(!this.isTreeView||this.fields.tree.treeViewLoad){let i=t('<button class="btn btn-sm reset" style="margin-left: 5px;">'+App.translate("Reset")+' <span class="fa fa-filter"></span></button>').width(82).on("click",(function(){setTimeout((function(){a.filtersEmpty.call(a)}),50)}));this.filters&&Object.keys(this.filters).length?i.addClass("btn-warning"):i.attr("disabled",!0).addClass("btn-default"),e.append(i),this.filtersClearButton=i}}if(this.f.tablecomment){let i=t('<div class="pcTable-tableComment">').on("click",(function(){App.panel(App.translate("Comment of the table rows part"),a.f.tablecomment.replace("<script","<s cript"))}));e.prepend(i.html(this.f.tablecomment.replace("<script","<s cript"))),setTimeout((function(){let e=0;i.parent().find(">span,>button").each((function(){e+=t(this).width()||0})),e+=90,i.css("width","calc(100% - "+e+"px)")}),100)}return e},_refreshContentTable:function(e,t){let a=this._content;t=t||!1,a.data("state","refreshing"),App.fullScreenProcesses.showCog(),this.ScrollClasterized.insertToDOM(0,t,e),App.fullScreenProcesses.hideCog(),a.data("state","ready"),a.trigger("refreshed"),this._popovers.empty()},_refreshTitle:function(){if(!this.beforeSpaceHide&&(this._beforeSpace_title.find(".title").text(this.f.tabletitle||this.tableRow.title),this.model.tableData&&this.model.tableData.updated)){let e;this.isAnonim||(e=moment(this.model.tableData.updated.dt,"YYY-MM-DD HH:mm").format("DD.MM HH:mm")+" (code: "+this.model.tableData.updated.code+")");let a=t('<div class="small">').text(e);!1===this.control.editing&&a.append('<div class="">'+App.translate("Read only")+"</div>"),this._beforeSpace_title.find(".updated").html(a)}},_setBrowserTitle(){this.f.browsertitle&&(e.document.title="true"===this.f.browsertitle.toString()?this.f.tabletitle||this.tableRow.title:this.f.browsertitle)},_createTableText:function(){if(this.tableText=t('<div class="pcTable-tableText"></div>').text(this.f.tabletext),this.f.tablehtml){let e=t("<div>").html(this.f.tablehtml);e.find("script").remove(),this.tableText.append(e)}return this.tableText},_refreshTableText:function(){this.tableText.replaceWith(this._createTableText())},_createRowsTitle:function(e=null){let a=this;a.__sectionsCloses=a.__sectionsCloses||JSON.parse(localStorage.getItem("sectionCloses")||"{}");let i=a.tableRow.id+"/"+(a.tableRow.__version||0)+"/rows",n=t('<div class="pcTable-rowsTitle"></div>').on("click","i, span",(function(){let e=t(this).closest(".pcTable-rowsWrapper");e.is(".pcTable-rowsClose")?(e.removeClass("pcTable-rowsClose"),delete a.__sectionsCloses[i],a.ScrollClasterized.reloadScrollHead()):(e.addClass("pcTable-rowsClose"),a.__sectionsCloses[i]=1),a.ScrollClasterized.insertToDOM(0,!0),localStorage.setItem("sectionCloses",JSON.stringify(a.__sectionsCloses))}));return e&&e.is(".pcTable-rowsClose")&&!a.__sectionsCloses[i]?e.removeClass("pcTable-rowsClose"):e&&!e.is(".pcTable-rowsClose")&&a.__sectionsCloses[i]&&e.addClass("pcTable-rowsClose"),this.f.rowstitle?n.html(t("<span>").text(this.f.rowstitle)).prepend('<i class="fa">'):n.text(),n},_createFiltersBlock:function(){let a=this;if(t("<div>"),this._filtersBlock=t("<div>"),this._filtersBlock.addClass("pcTable-filtersTables pcTable-section"),a.fieldCategories.filter.length&&a.fieldCategories.filter.some(e=>!e.hidden&&e.showMeWidth)){let i,n,l;this.___createClosedSection(this._filtersBlock,t('<div class="pcTable-sectionTitle"><span>'+App.translate("Filters")+"</span></div>").appendTo(this._filtersBlock),"flt"),this._filtersBlock.addClass("pcTable-filtersTables");let s,o=0,r=this._container.width()-140;const d=function(){if(i){const s=function(){let i=t(this);const n=function(){let n,l={},s=new URL(document.location).searchParams;s.get("b")&&(l.b=s.get("b")),i.is(".eraser")||(l.f=a._filtersBlock.data("cryptoFilters")||a.filtersString),n="?"+t.param(l),a.isMobile&&(n+="#go-buttons"),e.location.href=n};return setTimeout((function(){a.model.doAfterProcesses(()=>{setTimeout(n,100)})}),500),!0};if(a.isMobile)i.after(t('<table class="pcTable-filtersTable" id="go-buttons"><tr><td><button class="btn btn-default btn-xs button-go realy-go">GO</button> <button class="btn btn-default btn-xs eraser button-go "><i class="fa fa-eraser"></i></button></td></tr></td></table>').on("click",".button-go",s));else{n.append('<th style="width: 69px;"></th>');let e=t('<td class="buttons-go">').html('<button class="btn btn-default btn-xs button-go realy-go">GO</button> <button class="btn btn-default btn-xs eraser button-go"><i class="fa fa-eraser"></i></button>').appendTo(l);i.width(o+69),e.on("click",".button-go",s)}}},c=(e,c)=>{!c.hidden&&c.showMeWidth&&((a.isMobile||0===o||r<o+c.width||c.tableBreakBefore)&&(a.isMobile||d(),i=t("<table class='pcTable-filtersTable'><thead><tr></tr></thead><tbody><tr></tr></tbody></table>").appendTo(this._filtersBlock),o=0,n=i.find("thead tr"),l=i.find("tbody tr")),void 0!==c.panelColor&&(s=c.panelColor),n.append(a._createHeadCell(e,c,s)),t("<td>").attr("data-field",c.name).appendTo(l),o+=c.width)};t.each(a.fieldCategories.filter,c),d()}return this._filtersBlock},_refreshFiltersBlock:function(e){let a=this;(e=e||{}).params?(t.each(a.fieldCategories.filter,(function(t,i){a.data_params[i.name]=e.params[i.name]})),a._filtersBlock.data("cryptoFilters",e.filtersString)):a.filterData||(a.filterData={},t.each(a.fieldCategories.filter,(function(e,i){a.filterData[i.name]=t.extend(!0,{},a.data_params[i.name])})),a.model.addExtraData({filters:a.filtersString}));let i=[],n=[];return t.each(a.fieldCategories.filter,(function(e,t){if(t.hidden||!t.showMeWidth)return;let l=a._createCell(a.data_params,t);a._filtersBlock.find('td[data-field="'+t.name+'"]').replaceWith(l),Object.equals(a.data_params[t.name].v,a.filterData[t.name].v)||i.push(l),"select"===t.type&&t.column&&a.data_params[t.name].v&&("*NONE*"===a.data_params[t.name].v||"*NONE*"===a.data_params[t.name].v[0])&&n.push(l)})),i.length>0?(i.forEach((function(e){e.addClass("warning-backg")})),a._filtersBlock.removeClass("with_danger").addClass("with_changed")):n.length>0?(n.forEach((function(e){e.addClass("danger-backg")})),a._filtersBlock.removeClass("with_changed").addClass("with_danger")):(a._filtersBlock.removeClass("with_danger, with_changed"),a._filtersBlock.find(".danger-backg, .warning-backg").removeClass("danger-backg, warning-backg")),this._filtersBlock},_createParamsBlock:function(e){let a=t("<div>");if(e)return a.appendTo(e),a;this._paramsBlock&&(this._paramsBlock.replaceWith(a),this._paramsBlock=a);let i=this;if(i.fieldCategories.param)if(a.addClass("pcTable-paramsTables"),i.isMobile){let e,n,l,s,o="",r=!1;t.each(i.fieldCategories.param,(function(d,c){if(i.isReplacedButton(c.name))return;let p;void 0!==c.panelColor&&(p=c.panelColor),void 0!==c.sectionTitle&&(r=!1,o=c.sectionTitle,o.match(/\*\*(.*)/)&&(o.match(/\*\*(.*)/)[1].trim().split(/\s*;\s*/).forEach(e=>{let t=e.trim().split(/\s*:\s*/);"nolable"===t[0]&&(t[1]&&"true"!==t[1].trim()||(o=""))}),o=o.replace(/(\*\*.*)/,""))),!c.showMeWidth||i.data_params[c.name].f&&i.data_params[c.name].f.hide&&i.data_params[c.name].f.hide.mobile||(e=t("<table class='pcTable-paramsTable'>"+(r?"":"<thead><tr></tr></thead>")+"<tbody><tr style='background-color: "+App.theme.getColor(p)+"'></tr></tbody></table>"),i.isMobile&&"button"===c.type&&(e=t("<table class='pcTable-paramsTable'><tbody><tr></tr></tbody></table>")),s&&!o||(s=t('<div class="pcTable-section">').appendTo(a),o&&i.___createClosedSection(s,t('<div class="pcTable-sectionTitle"></div>').html(t("<span>").text(o)).appendTo(s),"p")),o="",s.append(e),r||(n=e.find("thead tr"),n.append(i._createHeadCell(d,c,p))),l=e.find("tbody tr"),l.append('<td data-field="'+c.name+'">'))}))}else this.__fillFloatBlock(a,i.fieldCategories.param);return a},_refreshParamsBlock:function(e,a){var i=this;return i.fieldCategories.param&&t.each(i.fieldCategories.param,(function(t,l){if(!l.showMeWidth||e&&!e[l.name])return!0;let s=i._createCell(i.data_params,l),o=i._paramsBlock.find('td[data-field="'+l.name+'"]');o.css("minHeight")&&s.css("minHeight",o.css("minHeight")),o.replaceWith(s),a&&"f"!==e[l.name]&&i._colorizeElement(s,n,void 0,l.name)})),this._paramsBlock},_createFootersSubtable:function(e){let a,i=this;if(a=t("<div class='pcTable-footersTables'>"),e)return a.appendTo(e),a;if(this._footersSubTable&&(this._footersSubTable.replaceWith(a),this._footersSubTable=a),i.isMobile){let e,n,l,s,o,r=0,d=this._container.width()-100,c="";t.each(i.notTableFooterFields,(function(p,h){if(!i.isCreatorView&&i.isReplacedButton(h.name))return;let f;void 0!==h.panelColor&&(f=h.panelColor),void 0!==h.sectionTitle&&(o=!1,c=h.sectionTitle,c.match(/\*\*(.*)/)&&(c.match(/\*\*(.*)/)[1].trim().split(/\s*;\s*/).forEach(e=>{let t=e.trim().split(/\s*:\s*/);"nolable"===t[0]&&(t[1]&&"true"!==t[1].trim()||(c=""))}),c=c.replace(/(\*\*.*)/,""))),!h.showMeWidth||i.data_params[h.name].f&&i.data_params[h.name].f.hide&&i.data_params[h.name].f.hide.mobile||((i.isMobile||0===r||d<r+h.showMeWidth||h.tableBreakBefore)&&(e&&!i.isMobile&&e.width(r),e=t("<table class='pcTable-footersTable'><thead><tr></tr></thead><tbody><tr style='background-color: "+App.theme.getColor(f)+"'></tr></tbody></table>"),("button"===h.type||o)&&(e=t("<table class='pcTable-paramsTable'><tbody><tr></tr></tbody></table>")),s&&!c||(s=t('<div class="pcTable-section">').appendTo(a),c&&i.___createClosedSection(s,t('<div class="pcTable-sectionTitle"></div>').html(t("<span>").text(c)).appendTo(s),"f")),c="",s.append(e),r=0,n=e.find("thead tr"),l=e.find("tbody tr")),n.append(i._createHeadCell(p,h,f)),l.append('<td data-field="'+h.name+'">'),r+=h.showMeWidth)}))}else this.__fillFloatBlock(a,i.notTableFooterFields);return a},_createFootersTableBlock:function(){let e,a=this;if(e=t("<tbody class='pcTable-footers'></tbody>"),a.fieldCategories.footer){let i={},n=0;t.each(a.fieldCategories.footer,(function(e,t){!a.isCreatorView&&a.isReplacedButton(t.name)||!t.showMeWidth||a.data_params[t.name].f&&a.data_params[t.name].f.hide&&a.data_params[t.name].f.hide.mobile||(t.column||(t.column=""),i[t.column]||(i[t.column]=[]),i[t.column].push(t),t.column&&n<i[t.column].length&&(n=i[t.column].length))}));let l=t(),s=0,o=0;for(;s<n;){let e=t('<tr><td class="id"></td></tr>'),n=t('<tr><td class="id"></td></tr>').data("pctableitemid","footers").data("pctablettemtndex","footers"+o++);t.each(a.fieldCategories.column,(function(l,o){if(o.showMeWidth){let r=t("<td>");if(!i[o.name]||!i[o.name][s])return r.attr("rowspan",2),e.append(r),void r.addClass("footer-empty");if(r=a._createHeadCell(l,i[o.name][s],i[o.name][s].panelColor).addClass("footer-name"),a.isRotatedView&&r.width("auto"),e.append(r),i[o.name]&&i[o.name][s]){let e=i[o.name][s],t=a._createCell(a.data_params,e);t.attr("data-field",e.name),n.append(t)}}}));let r=this.tableRow.rotated_view+50;e.width(r/2),n.width(r/2),l=l.add(e),l=l.add(n),s++}e.html(l)}return e},___createClosedSection(e,a,i){const n=this;let l=e.parent().find(">div").index(e)+2,s=n.tableRow.id+"/"+(n.tableRow.__version||0)+"/"+i+"/"+l;n.__sectionsCloses=n.__sectionsCloses||JSON.parse(localStorage.getItem("sectionCloses")||"{}"),n.__sectionsCloses[s]&&e.addClass("closed"),t('<span class="btn-i"><i class="fa"></i></span>').prependTo(a),a.on("click","i, span",(function(){let e=t(this).closest(".pcTable-section");if(e.is(".closed"))if(e.removeClass("closed"),delete n.__sectionsCloses[s],e.data("closedrender")){let e=n.scrollWrapper.parent().scrollTop();switch(i){case"p":n._rerendParamsblock();break;case"f":n._rerendBottomFoolers()}n.scrollWrapper.parent().scrollTop(e)}else e.find("td").each((function(){let e=t(this);e.data("addProgress")&&e.data("addProgress")()}));else e.addClass("closed"),n.__sectionsCloses[s]=1;return localStorage.setItem("sectionCloses",JSON.stringify(n.__sectionsCloses)),n.ScrollClasterized.insertToDOM(null,!0),!1}))},_refreshFootersBlock:function(e,a){let i=this,l=i._footersBlock.add(i._footersSubTable);return i.fieldCategories.footer&&t.each(i.fieldCategories.footer,(function(t,s){if(!s.showMeWidth||e&&!e[s.name])return!0;let o=i._createCell(i.data_params,s);o.attr("data-field",s.name),l.find('td[data-field="'+s.name+'"]').replaceWith(o),a&&"f"!==e[s.name]&&i._colorizeElement(o,n,void 0,s.name)})),this._paramsBlock},_createHead:function(){return this._header=t("<thead>").append(this._createHeadRow()),this._header},_refreshHead:function(){return this._header.empty().append(this._createHeadRow()),this._header},_createFirstBody:function(){return this._beforebody=t("<tbody class='beforeRows'>").append('<tr class="extra-clasters">'),this.extraClastersTop=this._beforebody.find(".extra-clasters"),this._beforebody},_createAfterBody:function(){return this._afterbody=t("<tbody class='afterRows'>").append('<tr class="extra-clasters">'),this.extraClastersBottom=this._afterbody.find(".extra-clasters"),this._afterbody},_createBody:function(){return this._content=t("<tbody class='dataRows'>"),this._content},_createHeadRow:function(){let e=this,a=t("<tr>");this.fieldCategories.visibleColumns.length?e._container.removeClass("withNoColumns"):e._container.addClass("withNoColumns");let i=0;return t("body").is(".table-in-notification")||(e._createHeadCellId().appendTo(a),a.find(".id").width()),e._table.removeClass("n-filtered"),t.each(this.fieldCategories.visibleColumns,(function(t,n){let l,s;void 0!==n.panelColor&&(l=n.panelColor),"n"===n.name?(e._table.addClass("n-filtered"),s=e._createHeadCellNo()):s=e._createHeadCell(t,n,l),s.appendTo(a),i+=parseInt(n.showMeWidth)})),this.tableWidth=i,this.isRotatedView||this._table.width(this.tableWidth),a},_isDisplayngIdEnabled:function(e){return this.isCreatorView&&!e||!this.f.fieldhide||!this.f.fieldhide.id},_createHeadCellId:function(){let e=this,a=t('<th class="id"><span class="id-name"></span></th>'),i=this._isDisplayngIdEnabled();if(i&&(a.find("span").text("id"),this._isDisplayngIdEnabled(!0)||a.find("span").addClass("id-hidden")),null===e.tableRow.order_field||"id"===e.tableRow.order_field){let t=a.find("span").css("font-weight","bold");e.isCreatorView&&(!0===e.tableRow.order_desc?t.append(' <i class="fa fa-sort-amount-desc roles"></i>'):t.append(' <i class="fa fa-sort-amount-asc roles"></i>'))}let n=t('<div class="pcTable-filters"></div>'),l=t('<button class="btn btn-default btn-xxs" id="n-expander"><i class="fa fa-sort"></i></button>');if(l.on("click",(function(){e.fieldCategories.visibleColumns.some((function(e){return"n"===e.name}))?(e.fieldsHiddingHide.call(e,"n"),l.removeClass("btn-warning")):(e.fieldsHiddingHide.call(e,"n",!0),l.addClass("btn-warning")),e.ScrollClasterized.reloadScrollHead()})),e.fieldCategories.visibleColumns.some((function(e){return"n"===e.name}))&&l.addClass("btn-warning"),e.isMobile);else{let t=i?this._getIdFilterButton():"";n.append(l).append(" ").append(t).append(" ").append(e._idCheckButton)}return a.append(this._checkStatusBar),a.append(n),e._idCheckButton.off().on("click",(function(){if(e._idCheckButton.find("span").is(".fa-check"))e.row_actions_uncheck_all.call(e),e.__checkedRows=[];else for(let t=0;t<e.dataSortedVisible.length;t++){let a=e.dataSortedVisible[t],i="object"!=typeof a?e._getItemById(a):a.row;i&&!i.$checked&&(e.row_actions_check.call(e,i,!0),e.__checkedRows.push(i.id))}e._headCellIdButtonsState()})),n=t('<div class="pcTable-filters for-selected"><button class="btn btn-default btn-xxs"><i class="fa fa-copy"></i></button> <button class="btn btn-default btn-xxs" data-names="true"><i class="fa fa-clone"></i></button></div>'),a.append(n),this._refreshCheckedStatus(),a},_getIdFilterButton:function(){let e,a=this,i=t("<span>");return e=t('<button class="btn btn-xxs btn-filter" id="checkS"><span class="fa fa-circle-o"></span></button>').on("click",(function(){e.is(".btn-warning")?(e.addClass("btn-default").removeClass("btn-warning").find("span").removeClass("fa-circle").addClass("fa-circle-o"),delete a.filters.id,i.find(".btn-filter:not(#checkS)").parent().replaceWith(a.__getFilterButton("id"))):(e.removeClass("btn-default").addClass("btn-warning").find("span").removeClass("fa-circle-o").addClass("fa-circle"),a.filters.id=a.__checkedRows.slice().map((function(e){return e.toString()}))),a.__applyFilters(),a._headCellIdButtonsState()})),a.filters.id&&a.filters.id.length?e.addClass("btn-warning").removeClass("btn-default"):e.addClass("btn-default").removeClass("btn-warning"),i.append(e),i.append(a.__getFilterButton("id")),i},_createHeadCellNo:function(){let e=this,a=e.fields.n,i=t('<span class="cell-title">').text(a.title?a.title:a.name).attr("title",a.title),n=t('<button class="btn btn-default btn-xxs" style="width: 45px"><i class="fa fa-save"></i></button>'),l=t('<th class="n">').width(a.userWidth||a.width).append(i);return e.isCreatorView&&("n"===e.tableRow.order_field&&(!0===e.tableRow.order_desc?i.before('<i class="fa fa-sort-amount-desc roles"></i>'):i.before('<i class="fa fa-sort-amount-asc roles"></i>')),i.before("<br/>")),e._orderSaveBtn=n,!e.tableRow.with_order_field||e.f.blockorder||e.tableRow.__blocked?(n.prop("disabled",!0),this._table.addClass("no-correct-n-filtered")):n.on("click",(function(){e.reOrderRowsSave.call(e)})),l.append(t('<div class="pcTable-filters">').append(n))},__getCellTitle:function(e){return Object.getPath(this.f,["fieldtitle",e.name],e.title)},isReplacedButton(e){return this.fields[e]&&this.f&&(this.f.buttons&&this.f.buttons.length&&-1!==this.f.buttons.indexOf(e)||this.f.printbuttons&&this.f.printbuttons.length&&-1!==this.f.printbuttons.indexOf(e)||this.f.extbuttons&&this.f.extbuttons.length&&-1!==this.f.extbuttons.indexOf(e)||this.f.dotbuttons&&this.f.dotbuttons.length&&-1!==this.f.dotbuttons.indexOf(e))},_createHeadCell:function(i,n,l){let s=this,o=t("<th>").data("field",n.name);n.$th=o;let r=n.showMeWidth||n.width||100;this.isRotatedView&&"column"===n.category||("column"!==n.category&&r&&s.isMobile&&(r=100),s.isMobile&&("column"===n.category&&n.editable&&(r+=20),r+=20),r&&o.width(r)),s.fields[n.name]&&(s.fields[n.name].$th=o),n.panelColor?o.css("background-color",App.theme.getColor(n.panelColor)):void 0!==l&&""!==l&&(o.css("background-color",App.theme.getColor(l)),n.panelColor=l),(n.webRoles&&1===n.webRoles.length&&"1"===n.webRoles[0].toString()||n.isCyclesTabButton())&&o.addClass("admin-see"),"footer"===n.type&&n.column&&(o=t("<td>"));let d=this.__getCellTitle(n),c=t('<span class="cell-title">').text(d).attr("title",d).appendTo(o);if(s.isCreatorView&&!this.isRotatedView){let e=t('<span class="creator-icons">').prependTo(c);const a=function(e){let t="";switch(e){case"param":t="fa-hand-o-up";break;case"column":t="fa-hand-o-right";break;case"filter":t="fa-hand-o-left";break;case"footer":t="fa-hand-o-down"}return t};!n.isHiddenField&&n.showMeWidth||e.append('<i class="fa '+a(n.category)+' roles"></i>'),!n.showInWeb||n.isHiddenField||n.showMeWidth||o.addClass("eye-hidden"),n.linkTableName&&e.append('<i class="fa fa-chain roles"></i>'),e.append('<i class="fa '+n.icon+' roles"></i>');let i=t('<i class="roles">'+(n._ord||n.ord)+"</i>");if(e.append(i),s.isTreeView&&"tree"===n.name?i.addClass("reordered"):n._ord&&(i.addClass("reordered"),i.before('<i class="roles">'+n.ord+"</i>")),n._category&&i.before('<i class="fa '+a(n._category)+' roles reordered fa-bold"></i>'),"column"===n.category&&s.tableRow.order_field===n.name&&(i.css("font-weight","bold"),!0===s.tableRow.order_desc?e.append('<i class="fa fa-sort-amount-desc roles"></i>'):e.append('<i class="fa fa-sort-amount-asc roles"></i>')),n.codeAction){let a=t('<i class="fa fa-star roles"></i>');e.append(a);let i="";n.CodeActionOnAdd&&(""!==i&&(i+="\n"),i+=App.translate("On adding")),n.CodeActionOnChange&&(""!==i&&(i+="\n"),i+=App.translate("On changing")),n.CodeActionOnDelete&&(""!==i&&(i+="\n"),i+=App.translate("On deleting")),("button"===n.type||n.CodeActionOnClick)&&(""!==i&&(i+="\n"),i+=App.translate("On click")),""===i&&a.removeClass("fa-star").addClass("fa-star-o"),a.attr("title",i)}n.code&&!n.linkFieldName&&(n.codeOnlyInAdd?e.append('<i class="fa fa-cogs fa-lower roles"></i>'):e.append('<i class="fa fa-cogs roles"></i>'));const l=function(e){let t="";return e.forEach((function(e){""!==t&&(t+="\n"),t+=s.ROLESLIST[e.toString()]})),t};if(n.webRoles&&e.append(t('<i class="fa fa-eye roles"></i>').attr("title",l(n.webRoles))),"button"!==n.type){let a=!1;n.addRoles?e.append(t('<i class="fa fa-plus roles h"></i>').attr("title",l(n.addRoles))):n.insertable||("column"===n.category?n.editable?e.append(t('<i class="fa fa-plus roles h"></i>').attr("title",App.translate("Adding is disallowed"))):(e.append(t('<i class="fa fa-lock roles h"></i>').attr("title",App.translate("Adding and editing is disallowed"))),a=!0):n.editable||(e.append(t('<i class="fa fa-lock roles h"></i>').attr("title",App.translate("Editing is disallowed"))),a=!0)),n.editRoles?e.append(t('<i class="fa fa-pencil roles h"></i>').attr("title",l(n.editRoles))):n.editable||a||e.append(t('<i class="fa fa-pencil roles h"></i>').attr("title",App.translate("Editing is disallowed"))),n.logRoles&&e.append(t('<i class="fa fa-archive roles h"></i>').attr("title",l(n.logRoles)))}if(n.showInXml){let a="";n.xmlRoles&&(a=l(n.xmlRoles)),e.append(t('<i class="fa fa-exchange roles"></i>').attr("title",a))}s.f&&(s.f.printbuttons&&s.f.printbuttons.indexOf&&-1!==s.f.printbuttons.indexOf(n.name)&&e.append('<i class="roles reordered">P</i>'),s.f.buttons&&s.f.buttons.indexOf&&-1!==s.f.buttons.indexOf(n.name)&&e.append('<i class="roles reordered">B</i>'),s.f.extbuttons&&s.f.extbuttons.indexOf&&-1!==s.f.extbuttons.indexOf(n.name)&&e.append('<i class="roles reordered">E</i>'),s.f.dotbuttons&&s.f.dotbuttons.indexOf&&-1!==s.f.dotbuttons.indexOf(n.name)&&e.append('<i class="roles reordered">D</i>'))}n.unitType&&c.append(", "+n.unitType);let p,h=t('<div class="pcTable-filters">');if(n.help&&n.help.length){s.isCreatorView||"column"===n.category||o.addClass("worker-with-i"),p=t('<span class="btn btn-xxs btn-default cell-help" tabindex="-1" id="field-help-'+n.name+'"><i class="fa fa-info"></i></span>'),o.addClass("with-help"),s.isCreatorView&&/^\s*<admin>.*?<\/admin>\s*$/s.test(n.help)&&p.addClass("danger-backg"),p.appendTo(h);let e,a=t('<div class="i-inner-div">').html(n.help).width(230);s.isMobile?p.on("click",(function(){return App.mobilePanel(App.translate("Field %s",n.title),n.help),!1})):p.on("click open close",(function(i){let l=t(this);return l.data("bs.popover")?"open"!==i.type&&(e&&clearTimeout(e),e=setTimeout(()=>{l.attr("aria-describedby")&&t("#"+l.attr("aria-describedby").length)&&l.popover("destroy")},120)):"close"!==i.type&&(p.popover({trigger:"manual",content:a,html:!0,placement:()=>{let e="bottom",t=300,i=s._container,o=l.offset().top-i.offset().top;return"column"===n.category&&s.insertRow||o>i.height()/2?(e="top",t=o-40):t=i.height()-o-70,a.css("max-height",t),e},container:s.scrollWrapper}),setTimeout(()=>{l.popover("show")},10)),t("body").trigger("_click"),!1})),s.addThHelpCloser()}if("column"===n.category&&(!s.isTreeView||s.fields.tree.treeViewLoad)&&n.filterable&&n.showMeWidth>0&&(o.addClass("with-filter2"),this.__getFilterButton(n.name).appendTo(h)),s.isCreatorView||!1!==n.dropdownView&&"column"===n.category){o.addClass("with-filter");let i=s.isCreatorView&&!(!1!==n.dropdownView&&"column"===n.category);(()=>{let l=t('<div class="cell-header-dropdown">'),o=t('<button class="btn btn-default btn-xxs"  tabindex="-1"><i class="fa fa-caret-down"></i></button>');s.fixedColumn===n.name&&o.addClass("btn-warning").removeClass("btn-default"),n.pcTable?i&&o.addClass("field_name"):o.addClass("field_name");const r=function(e){e&&App.windowReloadWithHash(s.model)};if(s.isCreatorView){let e=t('<div class="menu-item color-danger">');e.append('<i class="fa fa-pencil-square-o"></i> '+App.translate("Edit")),l.append(e);const i=function(){return new EditPanel(2,BootstrapDialog.TYPE_DANGER,{id:n.id,cycle_id:s.tableRow.cycle_id}).then(r),!1};e.on("click",i),o.on("contextmenu",i),e=t('<div class="menu-item color-danger">'),e.append('<i class="fa fa-clone"></i> '+App.translate("Duplicate")),l.append(e),e.on("click",(function(){App.getPcTableById(2).then((function(e){e.model.checkEditRow({id:n.id}).then((function(e){let a={},i={};t.each(e.row,(function(e,t){"object"==typeof t&&(a[e]=t,i[e]=!0)})),a.cycle_id=s.tableRow.cycle_id,new EditPanel(2,BootstrapDialog.TYPE_DANGER,a,!1,i).then(r)}))}))})),e=t('<div class="menu-item color-danger">'),e.append('<i class="fa fa-plus"></i> '+App.translate("Insert after")),l.append(e),e.on("click",(function(){App.getPcTableById(2,{afterField:n.ord}).then((function(e){let t={};t.ord={v:n.ord+10},t.category={v:n.category},t.table_id={v:s.tableRow.id},t.cycle_id=s.tableRow.cycle_id,s.tableRow.__version&&(t.version={v:s.tableRow.__version}),t.data_src={v:a()},new EditPanel(e,BootstrapDialog.TYPE_DANGER,t,!1,t).then(r)}))})),("param"===n.category||"footer"===n.category&&""==n.column)&&(e=t('<div class="menu-item color-danger">'),e.append('<i class="fa fa-hand-scissors-o"></i> '+App.translate("Section")),l.append(e),e.on("click",()=>{this.__editSectionTitle(n)})),e=t('<div class="menu-item color-danger">'),e.append('<i class="fa fa-refresh"></i> '+App.translate("Change NAME")),l.append(e),e.on("click",(function(){s.model.renameField(n.name)})),e=t('<div class="menu-item color-danger">'),e.append('<i class="fa fa-times"></i> '+App.translate("Delete")),l.append(e),e.on("click",(function(){let e=n.title;BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:App.translate("Delete field %s from table %s?",[e,s.tableRow.title]),buttons:[{action:function(t,a){"use strict";t.close(),App.getPcTableById(2).then((function(t){App.panelTimer(App.translate("Deleting field %s from table %s?",[e,s.tableRow.title]),t.tableRow.delete_timer,(function(){t.model.delete(n.id).then((function(){App.windowReloadWithHash(s.model)}))}))}))},cssClass:"btn-warning",label:App.translate("Delete")},{action:function(e){e.close()},label:App.translate("Cancel")}],draggable:!0})}))}if("filter"!==n.category&&n.pcTable&&!s.isMobile){let e=t('<div class="menu-item">');n.showMeWidth?(e.append('<i class="fa fa-eye-slash"></i> '+App.translate("Hide")),e.on("click",(function(){o.popover("hide"),s.fieldsHiddingHide.call(s,n.name)}))):(e.append('<i class="fa fa-eye-slash"></i> '+App.translate("Show")),e.on("click",(function(){o.popover("hide"),s.setColumnWidth.call(s,n.name,n.width,n.id)}))),e.appendTo(l),"column"===n.category&&s.isRotatedView||(e=t('<div class="menu-item">'),e.append('<i class="fa fa-arrows-h"></i> '+App.translate("Field width")),e.on("click",(function(){o.popover("hide");let e=t('<div><input type="number" class="form-control" value="'+n.showMeWidth+'" style="padding-left: 2px;"/></div>'),a=[{label:App.translate("Apply"),action:function(t){let a=parseInt(e.find("input").val());t.close(),n.pcTable.setColumnWidth.call(n.pcTable,n.name,a)}},{label:App.translate("Cancel"),action:function(e){e.close()}}];setTimeout(()=>{e.find("input").select()}),s.isCreatorView&&a.splice(0,0,{label:App.translate("By default"),cssClass:"btn-m btn-danger",action:function(t){let a=parseInt(e.find("input").val());t.close(),n.pcTable.setColumnWidth.call(n.pcTable,n.name,a,n.id)}}),BootstrapDialog.show({message:e,title:App.translate("Field %s width",n.title),onshown:function(t){let a=e.find("input");a.focus(),a.on("keydown",(function(a){13===a.keyCode&&(n.pcTable.setColumnWidth.call(n.pcTable,n.name,parseInt(e.find("input").val())),t.close())})),t.$modalDialog.width(500)},buttons:a,draggable:!0})})),e.appendTo(l))}if(n.showMeWidth>0&&"column"===n.category){if(s.fixedColumn===n.name?t('<div class="menu-item">').append('<i class="fa fa-thumb-tack"></i> '+App.translate("Unpin")).addClass("color-warning").appendTo(l).on("click",(function(){o.popover("hide"),s.fixColumn()})):"button"===n.type||s.isRotatedView||t('<div class="menu-item">').append('<i class="fa fa-thumb-tack"></i> '+App.translate("Pin")).appendTo(l).on("click",(function(){o.popover("hide"),s.fixColumn(n.name)})),!s.isTreeView){{let e=t('<div class="menu-item">');e.append('<i class="fa fa-sort-alpha-asc"></i> '+App.translate("Sort A-Z")),l.append(e),e.on("click",(function(){s.sort(n,1)}))}{let e=t('<div class="menu-item">');e.append('<i class="fa fa-sort-alpha-desc"></i> '+App.translate("Sort Z-A")),l.append(e),e.on("click",(function(){s.sort(n,-1)}))}}{let e=t('<div class="menu-item">');e.append('<i class="fa fa-hand-pointer-o"></i> '+App.translate("Select")),l.append(e),e.on("click",(function(){s.selectedCells.empty(),s.selectedCells.selectColumn(n.name)}))}if("column"===n.category&&"number"===n.type){let e=t('<div class="menu-item">');e.append('<i class="fa fa-diamond"></i> '+App.translate("Math operations")),l.append(e),e.on("click",(function(){let e=t("<div>"),a=0,i=0,l=null,o=null,r=0;s.dataSortedVisible.some((function(e){let t;try{let r;if("object"!=typeof e)r=s.data[e][n.name];else{if(!e.row)return;r=e.row[n.name]}let d=r.f;if(d&&d.textasvalue&&"text"in d&&"string"==typeof d.textasvalue&&"num"===d.textasvalue.substr(0,3)){let e=d.textasvalue.split("|")[1]||n.dectimalSeparator,a=new RegExp("[^0-9\\"+e+"]","g"),i=d.text.toString().replace(a,"");i=i.toString().replace(e,"."),t=Big(i)}else t=Big(r.v);a=Big(a).plus(t),++i,(null===l||t.gt(l))&&(l=t),(null===o||t.lt(o))&&(o=t)}catch(e){++r}}));let d=t('<table class="totum-math-operations"><thead><tr><th>'+App.translate("Operation")+"</th><th>"+App.translate("Value")+"</th></tr></thead>").appendTo(e),c=t("<tbody>").appendTo(d),p=function(e,t,a){if("simple"===t)return App.numberFormat(e,0,void 0,n.thousandthSeparator);let i="";if(n.unitType&&(i=" "+n.unitType),n.currency){let t={};return n.dectimalPlaces&&(t.minimumFractionDigits=n.dectimalPlaces),App.numberFormat(e,n.dectimalPlaces,n.dectimalSeparator,n.thousandthSeparator)+i}return e+i};t("<tr><td>"+App.translate("Summ")+"</td><td>"+p(a)+"</td></tr>").appendTo(c),t("<tr><td>"+App.translate("Number of numbers")+"</td><td>"+p(i,"simple")+"</td></tr>").appendTo(c),t("<tr><td>"+App.translate("Average")+"</td><td>"+(0!==i?p(Big(a).div(i).round(n.dectimalPlaces||0)):"null")+"</td></tr>").appendTo(c),t("<tr><td>"+App.translate("Max")+"</td><td>"+p(l)+"</td></tr>").appendTo(c),t("<tr><td>"+App.translate("Min")+"</td><td>"+p(o)+"</td></tr>").appendTo(c),t("<tr><td>"+App.translate("Non-numeric elements")+"</td><td>"+p(r,"simple")+"</td></tr>").appendTo(c),s.isTreeView&&e.append("<div>"+App.translate("Calculated only by visible rows")+"</div>");let h=n.title+(n.unitType?", "+n.unitType:"");s.isMobile?App.mobilePanel(h,e):BootstrapDialog.show({title:h,type:"edit",message:e,draggable:!0,onshown:function(e){e.$modalDialog.width(400)},buttons:[{action:function(e){e.close()},label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon"}]})}))}}if(n.linkToSelectTable){let a=n.linkToSelectTable,i=t('<div class="menu-item color-primary">');i.append('<i class="fa fa-external-link"></i> '+a.title),l.append(i),i.on("click",(function(){return e.open(a.link,"_blank").focus(),!1}))}return o.on("click",(function(){o=t(this),"column"===n.category&&s.PageData&&s.PageData.onPage&&s.PageData.allCount>s.PageData.onPage?0===l.find(".column-dropdown").length&&l.append('<div class="column-dropdown">'+App.translate("By current page")+" </div>"):l.find(".column-dropdown").remove(),o.data("bs.popover")&&o.data("bs.popover").tip().hasClass("in")||(o.popover({html:!0,content:l,trigger:"manual",container:s._container,placement:"auto bottom"}),o.popover("show"),setTimeout((function(){s.closeCallbacks.push(()=>{o.popover("destroy")})}),20))})),o})().appendTo(h)}h.appendTo(o);let f=20*h.find(".btn").length+5;if(this.isCreatorView&&!this.isRotatedView&&(!n.showMeWidth||n.showMeWidth>50)){let e=t('<div class="th-left-bottom-buttons">').appendTo(o);"footer"===n.category&&n.column&&this.fields[n.column]&&!s.hidden_fields[n.name]&&(r=this.fields[n.column].width),t('<div class="btn  btn-xxs field_name copy_me"  tabindex="-1" data-copied-text="'+App.translate("Copied")+'">').text(n.name).appendTo(e).css("max-width",r-f)}return!s.isRotatedView&&s.isMobile&&c.css("max-width",r-5),o},_createNoDataRow:function(e){let a=0;t.each(this.fields,(function(e,t){a++}));let i=t();return!e&&this.PageData&&this.PageData.loading?e=App.translate("Wait, the table is loading"):this.isInsertable()&&!this.f.hideadd&&(i=t('<button class="btn btn-warning btn-xxs">'+App.translate("Add row")+"</button>").width(120).on("click",()=>{this.__$rowsButtons.find('[data-action="add"],[data-action="panel-adding"]').first().click()})),void 0===e&&(this.PageData&&this.PageData.allCount?this.PageData.offset>=this.PageData.allCount?e=App.translate("Page is empty")+" ":this.model.loadPage(this,null,this.PageData.onPage,null,this.PageData.offset):e=App.translate("Table is empty")+" "),t("<tr>").addClass(this.noDataRowClass).append('<td class="id">').append(t("<td>").attr("colspan",a).append(e).append(i))},_createRow:function(e,a){a=a||[];let i=this;e.$tr||(e.$tr=t("<tr>"),i.isRotatedView?e.$tr.width(i.tableRow.rotated_view):e.$tr.height(35),e.$tr.data("item",e));let l=e.$tr.empty();l.attr("class","DataRow"),l.attr("data-pctableitemid",e.id),e.e_data&&1==e.e_data.b&&l.addClass("BlockedRow"),e.InsDel&&l.addClass("insDeleted"),t("body").is(".table-in-notification")||this._addCellId(e,l);for(let s=0;s<this.fieldCategories.visibleColumns.length;++s){let o=this.fieldCategories.visibleColumns[s];if(o&&"n"===o.name){let a=t("<td>");l.append(a.append('<span class="cell-value">').append(o.getCellText(null,a,e))),e.__inserted&&a.addClass("just-inserted")}else{let t;l.append(t=i._createCell(e,o)),a.indexOf(o.name)>-1&&i._colorizeElement(t,n,void 0,o.name,e.id)}}return e.$tr},addThHelpCloser:function(){if(!this.pcTableContainerFieldHelpEvent){let e=this;this.pcTableContainerFieldHelpEvent=!0,this._container.on("click escPressed",(function(a){e._container.find('[id^="field-help"][aria-describedby^="popover"]').each((function(){t(this).attr("id")===a.target.id||t(a.target).closest("#"+t(this).attr("id")).length||t(this).trigger("close")}))}))}},refreshRow:function(e,a,i,n){if(e&&e.is(".DataRow")||a){a||(a=this._getItemByTr(e));let s,o=!1,r=[];if(i){for(var l in this.isTreeView&&(s={id:a.id,tree:{v:a.tree.v},tree_category:{v:a.tree_category?a.tree_category.v:null}},this.fields.tree.treeBfield&&s[this.fields.tree.treeBfield]&&(s[this.fields.tree.treeBfield]={...a[this.fields.tree.treeBfield]})),i)null!==i[l]&&"object"==typeof i[l]?i[l].changed?(r.push(l),delete i[l].changed,o=!0):!Object.equals(i[l],a[l])&&l in this.fields&&(r.push(l),o=!0):i[l]!=a[l]&&(r.push(l),o=!0),a[l]=i[l];o&&(t.extend(a,i),this.isTreeView&&this.placeInTree(a,s,!1))}!e||n&&!o||this._createRow(a,r)}else this._isParamsArea(e)?this._refreshParamsBlock():this._isFootersArea(e)&&this._refreshFootersBlock()},_createCell:function(e,a){let i=this;var n=t("<td>");let l,s="";e[a.name]||(console.log(App.translate("Field % not found",a.name)),console.log(e));try{l=t.extend({},i.f||{},e.f||{},e[a.name].f||{})}catch(t){console.log(t,e,a.name),l={}}let o=l.height>33||l.maxheight>33||a.heightFromSection>33;!a.editable||!this.control.editing&&"filter"!==a.category||l.block||(n.addClass("edt"),a.editGroup&&(a.editGroupMultiColumns?n.addClass("e-gm").addClass("e-g"):n.addClass("e-g")),-1===["button","fieldParams"].indexOf(a.type)&&(i.isMobile||l.editbutton)&&(s='<button class="fa fa-edit pull-right ttm-edit ibtn"></button>')),i.isMobile&&"chart"!==a.type?s='<button class="fa fa-ellipsis-h ttm-panel pull-right ibtn"></button>'+s:(!a.editable||l.block)&&a.CodeActionOnClick&&l.editbutton&&(s='<button class="fa fa-ellipsis-h asUrl pull-right ibtn"></button>'+s),l.block&&n.addClass("blocked"),"column"!==a.category&&n.attr("data-field",a.name);var r=t('<span class="cell-value" data-type="'+a.type+'">'),d=e[a.name];let c,p,h;if(a.linkFieldName||!a.code||a.codeOnlyInAdd||n.addClass("with-code"),"column"!==a.category&&"chart"!==a.type&&n.data("field",a.name).addClass("val"),d){c=d.e,!d.h||"showhand"in l&&!0!==l.showhand||(p=void 0!==d.c&&d.v!=d.c?t('<i class="fa fa-hand-paper-o pull-right cell-icon" aria-hidden="true"></i>'):t('<i class="fa fa-hand-rock-o pull-right cell-icon" aria-hidden="true"></i>'),i.isMobile&&p.addClass("ttm-panel")),d.d&&n.addClass("deleted_value"),d.e&&(a.errorText?r.text(a.errorText):(h=t('<i class="fa fa-exclamation-triangle pull-right" aria-hidden="true"></i>'),i.isMobile?h.addClass("ttm-panel"):h.attr("title",d.e),n.append(h)));let s="string"===a.type&&a.url;if(!l.text||s&&null!==d.v||"button"==a.type||i.isTreeView&&"tree"===a.name&&e.__tree&&("self"===a.treeViewType||e.tree_category&&e.tree_category.v)){if(!d.e||!a.errorText){var f=o?a.getHighCelltext(d.v,n,e):a.getCellText(d.v,n,e);"object"==typeof f?f&&f.then?(r.html('<div class="center"><i class="fa fa-spinner fa-spin"></i></div>'),f.then(e=>{r.html(e)})):r.html(f):r.text(f),s&&l.text&&r.find("a").text(l.text)}}else r.text(l.text).addClass("format-text");a.CodeActionOnClickAsUrl&&r.addClass("asUrl")}if(l.comment&&"button"!=a.type&&n.append(t('<i class="cell-icon fa fa-info pull-right"></i>').attr("title",l.comment)),p&&n.append(p),s&&n.append(s),r.appendTo(n),l.text||!a.unitType||c||null===d.v||["select","tree"].indexOf(a.type)>-1&&a.multiple||(a.before?"prefix"in a||r.attr("data-unit-type-before",a.unitType+" "):"postfix"in a||r.attr("data-unit-type"," "+a.unitType)),a.css&&n.addClass(a.css),this.isSelected(a.name,e.id)&&n.addClass("selected"),("button"!==a.type||!a.pcTable.isMobile||"column"===a.category)&&(l.background?n.css("background-color",App.theme.getColor(l.background)):a.panelColor&&n.css("background-color",App.theme.getColor(a.panelColor)),l.color)){let e=App.theme.getColor(l.color,!0);n.css("color",e),n.find("a").css("color",e)}if(l.bold&&n.css("font-weight","bold"),l.align?n.css("text-align",l.align):l.tab&&n.css("padding-left",l.tab+"px"),l.decoration&&n.css("text-decoration",l.decoration),l.italic&&n.css("font-style","italic"),"tree"===a.type&&f&&"object"==typeof f&&f.is(".tree-view")?h&&h.remove():l.icon&&"button"!==a.type&&n.prepend('<i class="cell-icon fa fa-'+l.icon+'"></i>'),l.progress&&l.progresscolor){let e=function(){if(r.isAttached()){let e=Math.round(r.width()*parseInt(l.progress)/100);r.css("box-shadow","inset "+e.toString()+"px 0px 0 0 "+App.theme.getColor(l.progresscolor))}else setTimeout(e,50)};i.isMobile&&n.data("addProgress",(function(){let e=n.find(".cell-value");e.css("box-shadow","inset "+Math.round(e.width()*parseInt(l.progress)/100).toString()+"px 0px 0 0 "+App.theme.getColor(l.progresscolor))})),e()}return a.format=l,a.td_style&&"function"==typeof a.td_style&&n.css(a.td_style(l)),"column"!==a.category?i.selectedCells&&i.selectedCells.notRowCell&&i.selectedCells.notRowCell.data("field")===a.name&&(n.addClass("selected"),i.selectedCells.notRowCell=n):e.id&&i.isSelected(a.name,e.id)&&n.addClass("selected"),n},_getLoadingSpinner:function(){return t('<div class="text-center"><i class="fa fa-spinner"></i></div>')},_colorizeElement:function(e,t,a,i,n){let l=10,s=this,o=function(){if(!e.is(":visible"))if(n){let t=s.data[n].$tr;t&&(e=s._getTdByFieldName(i,t))}else i&&(e=s._content.find('[data-field="'+i+'"]'));e&&e.length&&(0===l?e.css("box-shadow",""):(e.css("box-shadow","inset 0 0 100px 100px "+App.hexToRGB(t,l/10)),l--,setTimeout(o,50)))};o()},_TmpColorize:function(e,t,a){var i,n=this;t=t||App.theme.getColor("#ff0000"),"#"!=(a=a||App.theme.getColor("#ffffff")).substr(0,1)&&(a=App.rgb2hex(a)),(i=function(e,t,a){var i=parseInt(e.slice(1),16),n=(a=parseInt(a.slice(1),16),t<0?0:a>>16),l=t<0?0:a>>8&255,s=t<0?0:255&a,o=t<0?-1*t:t,r=i>>16,d=i>>8&255,c=255&i;return"#"+(16777216+65536*(Math.round((n-r)*o)+r)+256*(Math.round((l-d)*o)+d)+(Math.round((s-c)*o)+c)).toString(16).slice(1)}(t,.1,a))==t&&(i=a),e.css("background-color",i),i!=a?setTimeout((function(){n._TmpColorize(e,i,a)}),50):e.data("backgroundcolor")||e.attr("style",e.attr("style").replace(/(background\-color:[^;"]+;?)/,""))},__deleteSection(e){App.panelTimer(App.translate("Section deleting"),5,()=>{App.getPcTableById(2).then((function(t){t.model.checkEditRow({id:e.id}).then(a=>{let i=a.row.data_src.v;t.model.saveEditRow({data_src:{v:{...i,tableBreakBefore:{isOn:!1},sectionTitle:{isOn:!1,Val:i.sectionTitle.Val}}},id:e.id}).then(t=>{e.tableBreakBefore=!1,delete e.sectionTitle,"param"===e.category?e.pcTable._rerendParamsblock():e.pcTable._rerendBottomFoolers()})})}))})},__editSectionTitle(a){App.getPcTableById(2).then((function(i){i.model.checkEditRow({id:a.id}).then(n=>{let l,s=n.row.data_src.v,o="";s.sectionTitle&&"Val"in s.sectionTitle&&(o=s.sectionTitle.Val||"");let r=o.replace(/^(.*?)\*\*.*$/,"$1");/\*\*/.test(o)&&o.replace(/^.*?\*\*/,"").split(/\s*;\s*/).forEach(e=>{""!==e.trim()&&(r+="\n",r+=e.split(":").join(" : "))});let d=t('<div class="HTMLEditor">');e.top.BootstrapDialog.show({message:d,type:BootstrapDialog.TYPE_DANGER,title:App.translate("Section editing"),cssClass:"sectionTitle-edit-panel",draggable:!0,buttons:[{label:App.translate("Save"),action:e=>{(e=>{let t="";if(""!==e.trim()){let a=e.split(/\s*[\n\r]+\s*/),i=a[0];a.splice(0,1),t=i,a.length&&(t+="**"+a.join(";").replace(/\s*:\s*/g,":"))}let n=t;i.model.saveEditRow({data_src:{v:{...s,tableBreakBefore:{isOn:!0,Val:!0},sectionTitle:{isOn:!0,Val:n}}},id:a.id}).then(e=>{a.sectionTitle=n,a.tableBreakBefore=!0,"param"===a.category?a.pcTable._rerendParamsblock():a.pcTable._rerendBottomFoolers()})})(l.getValue()),e.close()}}],onhide:function(e){},onshown:function(a){a.$modalContent.position({of:t(e.top.document.body),my:"top+50px",at:"center top"}),l=CodeMirror(d.get(0),{value:r,mode:"sections",minHeight:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!1,autoCloseTags:!1}),l.on("paste",(function(e,t){setTimeout((function(){l.refresh()}),1)}))},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"100%"})}})})}))},getElementFormat:function(e,a){let i;return i=a?this.data[a]:this.data_params,t.extend({},this.f||{},i.f||{},i[e.name].f||{})}}),App.pcTableMain.prototype.fixColumn=function(e){this.fixedColumn&&(this._innerContainer.off("scroll.fixed-column"),this._container.off("scrolled.fixed-column"),this._innerContainer.find(".fixed-column").remove()),e&&setTimeout(()=>{let a,i,n=this,l=t('<tbody class="fixed-column"></tbody>');const s=()=>{let a=n.fields[e].$th,s=a.index(),o=a.outerWidth(),r=a.offset().left;l.width(o),l.css("max-height",n._innerContainer.height());let d=!1;if((d=r-n._innerContainer.offset().left+5<-1*o)||r-n._innerContainer.offset().left+5>n._innerContainer.width()){i||(i=!0,l.appendTo(this._innerContainer.find(".pcTable-table:first"))),d?l.css("left",n._innerContainer.scrollLeft()):l.css("left",n._innerContainer.scrollLeft()+n._innerContainer.width()-o+70);let e=t("<div>");n._innerContainer.find(".pcTable-table:first tbody.dataRows tr").each((function(){let a=t(this);if(a.is(".loading-row")){let t=a.clone();e.append(t)}else{let i=t(a.find("td")[s]);i.length?e.append(i.clone(!0)):e.append("<td></td>")}}));let r=t('<th class="top-head"></th>').text(a.find(".cell-title").clone().children().remove().end().text()).height(a.outerHeight());l.css({"padding-top":a.outerHeight()+1}),r.css("top",n._innerContainer.offset().top>0?0:-1*(n._innerContainer.offset().top-70)),l.empty().append(r).append(e)}else l.detach(),i=!1};n._innerContainer.on("scroll.fixed-column",()=>{a&&clearTimeout(a),a=setTimeout(s,200)}),n._container.on("scrolled.fixed-column",()=>{a&&clearTimeout(a),a=setTimeout(s,200)})},50),this.fixedColumn=e,this._refreshHead(),this._refreshContentTable()},function(){const e=function(e){e.forEach(e=>{let t=e.th.outerHeight();e.th.remove(),e.tdWrapper.data("height")&&e.tdWrapper.css("height",e.tdWrapper.data("height")+parseInt(t))})},a=(e,t,a,i)=>{e||(e={});const n=e=>{if(i){let t=e.split(/\s*\/\s*/);return t.length>1?{_big:l(t[0]),_small:l(t[1])}:{_big:l(e),_small:l(e)}}return l(e)},l=e=>{switch(e){case"false":case"FALSE":e=!1;break;case"true":case"TRUE":e=!0}return e=a(e)};return 3===t.length&&/^([a-z_0-9]+\s*,\s*)*([a-z_0-9]+\s*)?$/.test(t[1])?("object"!=typeof e&&(e={_ALL:e}),t[1].split(/\s*,\s*/).forEach(a=>{e[a]=n(t[2])})):"object"==typeof e&&Object.keys(e).length?e._ALL=n(t[1]):e=n(t[1]),e},i=function(e,t,a,i,n){return e in i?i[e]:e in a&&a[e]?"object"==typeof a[e]?t in a[e]?a[e][t]:n in a[e]?a[e][n]:a[e]._ALL:a[e]:null};App.pcTableMain.prototype.__fillFloatBlock=function(n,l){let s,o,r=this,d="",c={_ALL:!0},p=0,h=!1,f=!1,u=!1,m=!1,b=!1,g={},w=[],v={},_=!1;t.each(l,(function(e,i){if(!r.isCreatorView&&r.isReplacedButton(i.name))return;let n=!1;if(void 0!==i.sectionTitle){c={_ALL:!0},d=i.sectionTitle.trim(),p=0,h=!1,f=!1,u=!1,m=!1,o=i,v={},g={},_=!1;let e={},l=d.match(/\*\*(.*)/);l&&(l[1].trim().split(/\s*;\s*/).forEach(t=>{if("//"===t.trim().substring(0,2))return;let i=t.trim().split(/\s*:\s*/);if(i[0]=i[0].toLowerCase(),i.length>1)switch(i[0]){case"maxheight":case"height":case"maxwidth":case"nextline":case"blocknum":case"glue":case"fill":case"breakwidth":case"titleleft":case"titleright":let t;t=-1!==["titleleft","titleright"].indexOf(i[0])?e=>e.toString().trim().match(/^\d+$/)?e.toString().trim()+"px":e:e=>e,g[i[0]]=a(g[i[0]],i,t,!1);break;case"platemaxdiff":_=a(_,i,e=>!0===e||e,!0);break;case"outline":f=a(f,i,e=>!0===e||e,!0);break;case"blocktitle":v=a(v,i,e=>!1===e?"":e,!1);break;case"title":e.title=e.title||{_ALL:!0};let n=a({},i,e=>e);"boolean"==typeof n?e.title._ALL=n:e.title={...e.title,...n};break;case"border":u=a(u,i,e=>!1===e?"transparent":e,!0);break;case"plate":h=a(h,i,e=>!1===e?"transparent":e,!0);break;case"platemh":m=a(m,i,e=>"string"==typeof e&&/^\d+$/.test(e)?e+"px":e,!0);break;case"plateh":b=a(b,i,e=>"string"==typeof e&&/^\d+$/.test(e)?e+"px":e,!0);break;case"gap":e.gap=a(e.gap,i,e=>e);break;default:switch(i[1]){case"true":case"TRUE":e[i[0]]=!0;break;case"false":case"FALSE":e[i[0]]=!1}}}),p=e.gap||p),c="title"in e?e.title:c,r.isCreatorView?(d=d.replace(/(\*\*.*)/,""),n=!1===e.label||""===d):!1===e.label?d="":(d=d.replace(/(\*\*.*)/,""),d=t("<div>").text(d.trim()).html())}(!s||i.tableBreakBefore&&i.sectionTitle)&&(s=[],w.push({title:d,lableLowOpacity:n,formatsFromSection:g,fields:s,withTitles:c,sectionGap:p,plate:h,sectionField:o,outline:f,blocktitle:v,platemaxdiff:_,border:u,plateh:b,platemh:m}),d=""),i.showMeWidth&&s.push({field:i,panelColor:void 0})}));const y=(e,t)=>{let a=-1,i=e.fieldCell;t&&(i.prev().is("br")||i.is(":first-child")||i.prev().is('[data-type="blocknum"]')||i.prev().is(".blocktitle")||("object"!=typeof t?a=t:e.format.blocknum in t?a=t[e.format.blocknum]:e.field.name in t&&(a=t[e.field.name]),a&&/^\d+$/.test(a)&&(a=parseInt(a)-1,a+="px"))),i.css("marginLeft",a)};w.forEach(a=>{if(!a.fields||!a.fields.length)return;let s=t('<div class="pcTable-section ">').appendTo(n),o=a.sectionGap;if(a.title||r.isCreatorView&&a.sectionField){let e=t("<span>").html(a.title);r.isCreatorView&&(t('<span class="danger"> <i class="fa fa-edit" style="font-size: 14px; padding-left: 10px;"></i></span>').on("click",()=>(this.__editSectionTitle(a.sectionField),!1)).appendTo(e),t('<span class="danger"> <i class="fa fa-times" style="font-size: 14px; padding-left: 5px;"></i></span>').on("click",()=>(this.__deleteSection(a.sectionField),!1)).appendTo(e)),r.___createClosedSection(s,t('<div class="pcTable-sectionTitle"></div>').html(e).appendTo(s),"param"===l[0].category?"p":"f"),a.lableLowOpacity&&s.find(".pcTable-sectionTitle").addClass("lowOpacity")}let d=t('<div class="pcTable-floatBlock">').appendTo(s);if(!d.is(":visible"))return void s.data("closedrender",!0);let c,p=0,h=[],f=[h],u=[f],m=floatStarted=!1;a.fields.forEach((e,n)=>{e.field.tableBreakBefore&&0!==n&&(d=t('<div class="pcTable-floatBlock">').appendTo(s),h=[],f=[h],u.push(f)),r.data_params[e.field.name]=r.data_params[e.field.name]||{},e.format={...r.data_params[e.field.name].f||{}};let l=e.format.blocknum||0;if(!l&&"blocknum"in a.formatsFromSection&&(l=i("blocknum",e.field.name,a.formatsFromSection,e.format,-1)||0),Object.keys(a.formatsFromSection).forEach(t=>{let n=i(t,e.field.name,a.formatsFromSection,e.format,l);null!==n&&(e.format[t]=n)}),l&&!m&&s.addClass("sectionWithPannels"),0===h.length||h[h.length-1].blockNum!=l||e.field.tableBreakBefore&&0!==n){c=t('<div class="pcTable-floatInner">').appendTo(d),l&&r.isCreatorView&&c.append('<div data-type="blocknum" class="ttm-floatBlock-num">'+l+"</div>");let e="object"==typeof a.outline&&l in a.outline?a.outline[l]:a.outline;if(e&&c.data("border-color",e),a.plate&&("object"==typeof a.plate&&l in a.plate?c.data("plate",a.plate[l]):c.data("plate",a.plate)),l&&a.blocktitle[l]){let e=t('<div class="blocktitle"></div>').append(t("<span>").text(a.blocktitle[l]));c.prepend(e)}a.plateh&&(l in a.plateh?c.data("plateh",a.plateh[l]):c.data("plateh",a.plateh)),a.platehm&&(l in a.platehm?c.data("platehm",a.platehm[l]):c.data("platehm",a.platehm)),h.push({div:c,blockNum:l,isWrappable:!1,sec:a,fields:[]}),floatStarted=!0}let o=h[h.length-1];o.fields.length>0&&!e.format.nextline&&(o.isWrappable=!0),o.fields.push(e),e._showMeWidth=e.field.showMeWidth,e.format.breakwidth&&e._showMeWidth<e.format.breakwidth&&(e.field.showMeWidth=parseInt(e.format.breakwidth)),e.format.nextline&&!floatStarted&&c.append("<br/>"),floatStarted=!1;let b=t("<div>").appendTo(c);b.width(e.field.showMeWidth+1),b.attr("data-field-type",e.field.type),e.field.isNoTitles=!1,"withTitles"in a&&(e.field.name in a.withTitles?e.field.isNoTitles=!a.withTitles[e.field.name]:l&&l in a.withTitles?e.field.isNoTitles=!a.withTitles[l]:"_ALL"in a.withTitles&&(e.field.isNoTitles=!a.withTitles._ALL));let g=r._createHeadCell(null,e.field,e.panelColor).appendTo(b),w=t('<div class="td-wrapper">').appendTo(b);(e.format.titleleft||e.format.titleright)&&(b.css("display","inline-grid"),r.isCreatorView&&w.css("margin-top","18px"),e.format.titleleft?b.css("grid-template-columns",e.format.titleleft+" minmax(0, 1fr)"):(w.prependTo(b),b.css("grid-template-columns","minmax(0, 1fr) "+e.format.titleright))),e.field.heightFromSection=(a.formatsFromSection||{}).height,e.field.heightFromSection&&"object"==typeof e.field.heightFromSection&&(e.field.heightFromSection=e.field.heightFromSection[e.field.name]);let v,_=r._createCell(r.data_params,e.field).appendTo(w);if(r.isCreatorView?(v=33,e.field.isNoTitles||(v=68),e.format.maxheight&&(e.format.maxheight=parseInt(e.format.maxheight)+v),e.format.height&&(e.format.height=parseInt(e.format.height)+v)):e.field.isNoTitles||(v=35,e.format.maxheight&&(e.format.maxheight=parseInt(e.format.maxheight)+v),e.format.height&&(e.format.height=parseInt(e.format.height)+v)),e.format.maxheight){let t={maxHeight:e.format.maxheight};e.format.height&&(t.minHeight=e.format.height,w.css("minHeight",e.format.height-v)),_.height(""),b.css(t),b.addClass("nonowrap")}else e.format.height&&(_.height(""),b.addClass("nonowrap"),b.height(e.format.height));e.field.isNoTitles?r.isCreatorView?g.addClass("no-titled"):g.empty():(g.css("display","table-cell"),e.th=g,g.height()>p&&(p=g.height())),e.td=_,e.th=g.width(""),e.tdWrapper=w,e.fieldCell=b,r.isCreatorView&&(e.format.glue&&b.addClass("f-glue"),e.format.fill&&b.addClass("f-fill"))}),a.fields.forEach(e=>{let t=0;if(e.th){e.th.css("display","");let a=21;r.isCreatorView&&(a=40),e.th.height(a),t=e.th.outerHeight()}e.format.maxheight?e.tdWrapper.css("maxHeight",e.format.maxheight-t-10):e.format.height&&!e.format.maxheight&&(e.tdWrapper.css("height",e.format.height-t),e.tdWrapper.data("height",e.format.height-t)),y(e,o)});const b=(e,t=!1)=>e.offset().left+parseInt(e.css("paddingLeft"))+parseInt(e.css("borderLeftWidth"))+e.width()+(t?parseInt(e.css("paddingRight"))+parseInt(e.css("borderRightWidth")):0),g=function(e){if(!e.length)return 0;let t,a,i,n=e[0].div.parent(),l=b(n);for(let n in e){let l=e[n].div;l.w=!1,l.left=!1,a=b(l,!0),(!t||a>t)&&(t=a,i=e[n])}let s=l-t;return s++,s<0&&(i.w=!0),i.left=!0,s},w=function(e,t){return b(t)-b(e,!0)},v=function(e){let t=!0;return e.some((e,a)=>{if(g(e)<-10)return t=!1,!0}),t};let _=!1;u.forEach((function(i,n){let l=0,s=[],d={};for(;s.length!=i.length&&++l<500&&!v(i);)i.forEach((function(e,t){if(-1!==s.indexOf(t))return;let n=t;if(g(e)<-10){_=!0;const l=function(){let e=i[0].length-1;if(e>0){let t=i[0][e];return!!t.w&&(t.div.before("<br/>"),i.push([t]),i[0].splice(e,1),i.forEach((function(e){e.forEach((function(e){e.div.find("br.wrapped").remove(),e.fields.forEach(e=>y(e,o))}))})),!0)}return!1};for(let t=e.length-1;t>=0;t--){let i=e[t];if(i.isWrappable&&i.w){let s,r,c,p=!1;for(let e=0;e<i.fields.length;e++){let t=i.fields[e];t.i=e,e>0&&!c&&!t.format.nextline&&!t.fieldCell.prev().is("br")&&w(t.fieldCell,t.fieldCell.closest(".pcTable-floatBlock"))<0&&(d[n]&&-1!==d[n].indexOf(e)?p=!0:(c=Math.round(t.fieldCell.position().left),s=t,r=e))}if(s&&!s.format.nextline&&!s.fieldCell.prev().is("br")){for(;!p&&0!=s.i;){let e=i.fields[s.i-1];if(!e.format.nextline&&!e.fieldCell.prev().is("br")){if(w(e.fieldCell,e.fieldCell.closest(".pcTable-floatBlock"))<0){s=e;continue}}break}if(s.format.glue){let e=s.i;for(;;){if(!s.i){s=null;break}if(s=i.fields[s.i-1],r=s.i,s.format.nextline||s.fieldCell.is(":first-child")||s.fieldCell.prev().is("br"))return l()?void 0:(d[n]=d[n]||[],void d[n].push(e));if(!s.format.glue)break}}if(s){if(s.fieldCell.before('<br class="wrapped"/>'),t>0&&i.left&&a.platemaxdiff){let n;if(void 0!==i.blockNum&&a.platemaxdiff[i.blockNum]&&(n=_?a.platemaxdiff[i.blockNum]._small:a.platemaxdiff[i.blockNum]._big),a.platemaxdiff._small&&(n=_?a.platemaxdiff._small:a.platemaxdiff._big),n){let a=i.div.offset().top+i.div.outerHeight(),s=e[t-1];if(a-(s.div.offset().top+s.div.outerHeight())>parseInt(n))return i.w=!0,void l()}}s.fieldCell.nextAll("br.wrapped").remove();for(let e=r;e<=i.fields.length-1;e++)y(i.fields[e],o);return}}}}(g(e)>-10||!l())&&s.push(t)}else s.push(t)}));i.forEach((function(a,i){a.forEach(({div:e,fields:t})=>{t.forEach(e=>{e.format.breakwidth&&e._showMeWidth<e.format.breakwidth&&(e.fieldCell.css("width",e._showMeWidth),e.field.showMeWidth=e._showMeWidth)})}),function(e,a){if(!e.length)return;/Safari/.test(navigator.userAgent)&&e.forEach((function(e){e.div.width(100),e.div.width("")}));let i=g(e),n=0+parseInt(e[0].div.css("paddingTop")),l=[],s=[],o=0;e.forEach((function(e){let t,i=null,r={width:0,fields:[]};e.fields.forEach((function(e){if(e.format.maxwidth&&e.field.width<e.format.maxwidth||e.format.fill&&(a||Math.round(e.fieldCell.position().top)!==n||null===n)){let t=Math.round(e.fieldCell.position().top);i!=t&&(i=t,r={width:0,fields:[]},i!==n?s.push(r):l.push(r)),r.fields.push(e),r.width+=e.field.width,i===n&&(o+=e.field.width)}t=e.fieldCell}))}));const r=function(e){let a,i,n=e.fields[0].fieldCell.parent(),l=Math.round(e.fields[0].fieldCell.position().top);n.find(">div").each((function(e,n){let s=t(n),o=s.position();Math.round(o.top)===l&&(!a||Math.round(o.left)>a)&&(a=Math.round(o.left),i=s)}));let s=n.width()+parseInt(n.css("paddingLeft"))-a-i.outerWidth(!0),o=0,r=0;for(;r++<100&&e.fields.length&&s>1;)e.fields.forEach((function(t,a){if(s>o){let i=Math.round(s/e.width*t.field.width);t.format.fill||t.format.maxwidth<=t.fieldCell.width()+i&&(i=t.format.maxwidth-t.fieldCell.width(),e.fields.splice(a,1),e.width-=t.field.width),o+=i,t.fieldCell.width(t.fieldCell.width()+i)}})),s-=o,o=0};l.forEach(r);let d=i,c=0,p=0;for(;d>1&&p++<6&&l.length;)l.forEach((function(e,t){e.fields.forEach((function(t,i){if(d>c){let n=Math.round(d/o*t.field.width);n>d-c&&(n=d-c),a&&t.format.fill||!(t.format.maxwidth<=t.fieldCell.width()+n)||(n=t.format.maxwidth-t.fieldCell.width(),e.fields.splice(i,1),o-=t.field.width),c+=n,t.fieldCell.width(t.fieldCell.width()+n)}})),0===e.fields.length&&l.splice(t,1)})),d-=c,c=0;s.forEach(r)}(a,_),a.forEach(({div:t,fields:a,sec:i,blockNum:n})=>{let l=[],s=!0;a.forEach(t=>{if(t.fieldCell.prev().is("br")&&(!r.isCreatorView&&l.length&&e(l),l=[],s=!0),t.field.isNoTitles?s&&l.push(t):(l=[],s=!1),i.border){let e;if(e=t.field.name in i.border?i.border[t.field.name]:n in i.border?i.border[n]:i.border,e){let a=a=>{let i=_?e._small:e._big,n={borderColor:i};return"transparent"===i?(a.background||t.panelColor||(n.backgroundColor="transparent"),"button"===t.field.type&&(t.fieldCell.addClass("no-border"),n.Button={},a.background&&(n.Button.backgroundColor=App.theme.getColor(a.background)),a.color&&(n.Button.color=App.theme.getColor(a.color,!0)),t.td.find("button").css(n.Button),n.backgroundColor="transparent")):!0!==i&&void 0!==i||(n.borderColor="",a.background||t.panelColor?n.backgroundColor=App.theme.getColor(a.background||t.panelColor):n.backgroundColor="","button"===t.field.type&&(t.fieldCell.removeClass("no-border"),n.Button={},n.Button.backgroundColor="",n.Button.color=App.theme.getColor(a.color,!0),t.td.find("button").css(n.Button))),n};t.td.css(a(t.format)),t.field.td_style=a}else t.td.css(func_format(t.format)),t.field.td_style=func_format}}),!r.isCreatorView&&l.length&&e(l);let o={};if(t.data("plateh")){let e=t.data("plateh"),a=_?e._small:e._big;!1!==a&&(o.height=a,o.overflow="auto")}if(t.data("platemh")){let e=t.data("platemh"),a=_?e._small:e._big;!1!==a&&(o.maxHeight=a,o.overflow="auto")}if(t.data("border-color")){let e=_?t.data("border-color")._small:t.data("border-color")._big;e&&(!0===e?t.addClass("outlined"):o.borderColor=App.theme.getColor(e))}t.data("plate")&&(o.backgroundColor=App.theme.getColor(_?t.data("plate")._small:t.data("plate")._big)),t.css(o)})}))}))})}}(),t.extend(App.pcTableMain.prototype,{_addHorizontalDraggable:function(){this._innerContainer.off("mousedown.HorizontalDraggable mouseout").on("mousedown.HorizontalDraggable",(function(e){for(var a=e;a;){if(t(e.target).is("input"))return!0;if(a==e.originalEvent)break;a=e.originalEvent}return t(this).data("x",e.clientX).data("scrollLeft",this.scrollLeft),!1})).on("mousemove",(function(e){if(0===t(e.target).closest(".InsertRow").length&&"INPUT"!==e.target.tagName&&1===e.buttons&&0===e.button&&Math.abs(t(this).data("x")-e.clientX)>20){let a;t(this).data("moved",!0),a&&clearTimeout(a),a=setTimeout((function(){t(this).data("moved",!1)}),200),this.scrollLeft=t(this).data("scrollLeft")+t(this).data("x")-e.clientX}}))}}),App.pcTableMain.prototype._addRowPanel=function(e,a,i){var n=t('<div style=""><div class="buttons insert-row-buttons"></div></div>');if(void 0!==i){var l=n.find(".buttons").empty();t.each(i,(function(e,a){if("function"==typeof a)var i=t('<button class="btn btn-sm btn-default">').html(e).on("click",a);else"object"==typeof a&&"checkbox"==a.type&&(i=t('<input type="checkbox">'),a.id&&i.attr("id",a.id),a.func&&i.on("change",a.func),i=i.wrap('<span style="font-size: 10px; padding-left: 8px;" >').parent().append(' <span style="padding-top: 2px;">'+e+"</span>"));l.append(" "),l.append(i)}))}a.on("remove",(function(){n.remove()}));let s=this;return setTimeout((function(){let e={isParams:!0,$text:n,element:a,container:s._container,placement:"bottom",trigger:"manual"};App.popNotify(e);let i=a.attr("aria-describedby"),l=t("#"+i).addClass("warning-bg");l.find(".arrow").css("left","80%"),s._positionPanel.call(s,l,a),n.show()}),50),n},App.pcTableMain.prototype._positionPanel=function(e,t){t.position();let a,i=e.outerWidth();a=this._innerContainer.width()>this.tableWidth?this.tableWidth+70-i:this._innerContainer.width()-i-10,a<0&&(a=10),e.css({left:a})},t.extend(App.pcTableMain.prototype,{_csvExport:function(e){"use strict";let t=this;this.model.csvExport(t.dataSortedVisible,e,Object.keys(App.filter(t.fields,(e,t)=>!!t.showMeWidth))).then((function(e){if(e.csv){let a=new Blob([e.csv],{type:"text/csv;charset=utf-8"});saveAs(a,t.tableRow.title+"."+t.model.tableData.updated.dt+".csv")}}))},_csvImportClick:function(e){let a=this;t('<input type="file" accept="text/csv">').on("change",(function(){if(this.files&&this.files[0]){let t=new FileReader;t.onload=function(t){let i=t.target.result;a._csvImportUpload.call(a,i,e)},t.onerror=function(e){console.log(e.target.error)},t.readAsDataURL(this.files[0])}})).click()},_csvImportUpload:function(e,a){let i=this,n={},l=Object.keys(App.filter(i.fields,(e,t)=>!!t.showMeWidth&&"column"===t.category&&-1===["file","button","chart"].indexOf(t.type))),s=function(){i.model.csvImport(e,a,n,"full"==a?[]:l).then((function(e){e.question?App.modal(e.question[1],App.translate("Csv-loading question"),{[App.translate("Cancel")]:"close",[App.translate("Load")]:function(t){"use strict";t.modal("hide"),n[e.question[0]]=1,s()}}):e.ok&&App.windowReloadWithHash(i.model)}))};if("rows"===a){let e=t("<div></div>");l.forEach(a=>{e.append(t("<div>").text(i.fields[a].title||i.fields[a].name))});App.confirmation(e,{[App.translate("Cancel")]:function(e){e.close()},[App.translate("Load")]:e=>{s(),e.close()}},App.translate("Check matching the structure of the loaded file to the sequence of fields"))}else s()}}),function(){t.extend(App.pcTableMain.prototype,{___fieldsHiddingShowAllButton:null,_hideHell_storage:{isset_fields:!1,opened:null,blinkIt:!1,getOpened:function(){return null===this._hideHell_storage.opened&&(this._hideHell_storage.opened=n.getSavedOpenedVal(this.tableRow),!1===this._hideHell_storage.opened&&(this._hideHell_storage.blinkIt=!0)),this._hideHell_storage.opened},checkIssetFields:function(e){if(this.isCreatorView&&this._beforeSpace){let t=this._hideHell_storage.isset_fields;if(this._hideHell_storage.isset_fields=Object.keys(this.hidden_fields).length||Object.keys(this.fields).some(e=>"n"!==e&&(!this.fields[e].showMeWidth||this.fields[e].showMeWidth<1)),e||t!==this._hideHell_storage.isset_fields){let e=this._beforeSpace.find("#hide-hell").removeClass("btn-contour");this._hideHell_storage.isset_fields?(e.removeAttr("disabled"),this._hideHell_storage.opened?(e.find("i").addClass("fa-arrow-up").removeClass("fa-arrow-down").removeClass("fa-times"),e.addClass("btn-contour")):(e.find("i").removeClass("fa-arrow-up").addClass("fa-arrow-down").removeClass("fa-times"),this._hideHell_storage.blinkIt&&(App.blink(e,8,"#fff"),this._hideHell_storage.blinkIt=!1))):(e.attr("disabled","disabled"),e.find("i").addClass("fa-times").removeClass("fa-arrow-up").removeClass("fa-arrow-down"))}}},switchOpened:function(){this._hideHell_storage.opened=!this._hideHell_storage.opened,this._hideHell_storage.checkIssetFields.call(this,!0),n.saveOpenedVal(this.tableRow,this._hideHell_storage.opened),this._refreshHiddenFieldsBlock()}},fieldsHiddingHide:function(e,t){let a=l.get(this.tableRow)||{};t?a[e]=this.fields[e].width:delete a[e],this.setVisibleFields(a)},setVisibleColumns:function(){let e=this;this.fieldCategories.visibleColumns=[],this.fieldCategories.column.forEach((function(t){t.showMeWidth?e.fieldCategories.visibleColumns.push(t):e.selectedCells&&delete e.selectedCells.ids[t.name]}))},setColumnWidth:function(e,t,a){let i=l.get(this.tableRow)||{};i[e]=t;let n=this;a?App.getPcTableById(2).then((function(e){e.model.checkEditRow({id:a}).then((function(l){l.row&&(l.row.data_src.v.width.Val=parseInt(t),e.model.save({[a]:l.row}).then((function(){n.setVisibleFields(i)})))}))})):this.setVisibleFields(i)},loadVisibleFields:function(e){let t={},a=this.withTopButtons?l.getDate(this.tableRow):null;e=e||{},!a||""!=this.tableRow.fields_actuality&&this.tableRow.fields_actuality>a?this.setVisibleFields(t,!0,moment().format(App.dateTimeFormats.db),e):(t=l.get(this.tableRow)||{},this.setVisibleFields(t,!0,void 0,e))},setVisibleFields:function(e,t,a,i){let n=this,s=!1,o=!1;i=i||{},e&&0===Object.keys(e).length?(e={},Object.values(n.fields).forEach((function(t){"force"===i[t.name]?(i[t.name]=!0,n.fields[t.name].__hidden=!0):delete n.fields[t.name].__hidden;let a=t.hidden&&!1!==i[t.name]||!0===i[t.name]?0:t.width;a!=n.fields[t.name].showMeWidth&&("column"===t.category||"footer"===t.category&&t.column?s=!0:o=!0),n.fields[t.name].showMeWidth=a,e[t.name]=n.fields[t.name].showMeWidth}))):Object.values(n.fields).forEach((function(a){let l;l="filter"===a.category?a.width:void 0!==e[a.name]?parseInt(e[a.name]):t&&!a.hidden?a.width:0,a.name in i&&("force"===i[a.name]?n.fields[a.name].__hidden=!0:delete n.fields[a.name].__hidden,l=!0===i[a.name]||"force"==i[a.name]?0:a.width),l!=n.fields[a.name].showMeWidth&&("column"===a.category||"footer"===a.category&&a.column?s=!0:o=!0),n.fields[a.name].showMeWidth=l,e[a.name]=n.fields[a.name].showMeWidth})),n.withTopButtons&&l.set(e,this.tableRow,a),this.setVisibleColumns(),this._header?(o&&this.setWidthes(),s&&(this._refreshHead(),this.rowButtonsCalcWidth(),this._refreshContentTable(!0),this._rowsButtons(),this._rerenderColumnsFooter(),this.setInnerContainerWidth(),Object.keys(this.data).forEach(e=>{delete this.data[e].$tr}),this.ScrollClasterized.insertToDOM(null,!0,!0)),this.isCreatorView&&(this._hideHell_storage.checkIssetFields.call(n),this._refreshHiddenFieldsBlock())):(this._rerendParamsblock(),this.isCreatorView&&this._refreshHiddenFieldsBlock(),this._rerendBottomFoolers()),this.fieldsHiddingGetButton(),this._insertRow&&this._closeInsertRow()},hideAdminViewFields:function(){let e=this,t=l.get(this.tableRow)||{};Object.keys(t).forEach((function(a){if(t[a]>0){let i=e.fields[a];(!i||i.webRoles&&1===i.webRoles.length&&"1"==i.webRoles[0])&&delete t[a]}})),this.setVisibleFields(t)},setDefaultVisibleFields:function(){let e={},t=this;Object.values(t.fields).forEach((function(a){a.hidden||t.fields[a.name].__hidden?e[a.name]=0:e[a.name]=a.width})),t.setVisibleFields.call(t,e)},fieldsHiddingShowPanel:function(){let a,i,n=this,l=t('<div class="hidding-form">');const o=function(e){e=e||t("#defaultEyeGroups"),r=n.tableRow.fields_sets||[],e.empty().append("<b>"+App.translate("Default sets")+":</b> "),r.forEach((function(a,i){let l=t('<a href="#">').text(a.name).data("index",i);e.append(l.wrap("<span>").parent()),n.isCreatorView&&(i>0&&l.parent().append(t('<button class="btn sm-btn field_name"><i class="fa fa-arrow-left"></i></button>').data("index",i)),l.parent().append(t('<button class="btn sm-btn field_name"><i class="fa fa-remove"></i></button>').data("index",i)))})),e.off(),n.isCreatorView&&e.on("click",".btn",(function(){if(t(this).find("i").is(".fa-remove")){let e=t(this);n.model.removeEyeGroupSet(e.data("index")).then((function(e){n.tableRow.fields_sets=e.sets,o()}))}else{let e=t(this);n.model.leftEyeGroupSet(e.data("index")).then((function(e){n.tableRow.fields_sets=e.sets,o()}))}})),e.on("click","a",(function(){let e=t(this).data("index"),a=r[e].fields;if(Array.isArray(a)){let e={};a.forEach((function(t){n.fields[t]&&(e[t]=n.fields[t].width)})),a=e}n.setVisibleFields.call(n,a),i.close()}))};let r=s.getNames(n.tableRow);if(r&&r.length){let e=t('<div class="fieldsHiddenSets">').appendTo(l);e.append("<b>"+App.translate("Sets")+":</b> "),r.forEach((function(a){let i=t('<a href="#">').text(a).data("name",a);e.append(i.wrap("<span>").parent());let l=i.parent();l.append(t('<button class="btn sm-btn" data-action="remove"><i class="fa fa-remove"></i></button>').data("name",a)),n.isCreatorView&&l.append(t('<button class="btn sm-btn field_name" data-action="addDefaultSet" title="'+App.translate("Save as default set")+'"><i class="fa fa-save"></i></button>').data("name",a))})),e.on("click",".btn",(function(){let e=t(this),a=e.data("name");if(n.isCreatorView&&"addDefaultSet"===t(this).data("action")){let t=s.get(n.tableRow,a)||[];n.model.AddEyeGroupSet(a,t).then((function(t){n.tableRow.fields_sets=t.sets,o(),s.remove(n.tableRow,a),e.parent().remove()}))}else s.remove(n.tableRow,a),e.parent().remove()})),e.on("click","a",(function(){let e=t(this).data("name"),a=s.get(n.tableRow,e)||[];n.setVisibleFields.call(n,a),i.close()}))}r=n.tableRow.fields_sets||[];let d=t('<div class="fieldsHiddenSets" id="defaultEyeGroups">').appendTo(l);r&&r.length&&o(d),l.on("click",'input[type="checkbox"]',(function(e){let i=t(this),n=i.closest(".hidding-form");if(e.shiftKey){n.find("input").index(i);let e=n.find("input").index(t(this));n.find("input").each((function(n){(e<=n&&n<a||e>=n&&n>a)&&t(this).prop("checked",!!i.is(":checked")&&"checked").trigger("change")}))}else a=n.find("input").index(t(this))}));let c=[{label:App.translate("Apply"),action:function(e){let a={};l.find("input:checked").each((function(){let e=t(this);a[e.attr("name")]=parseInt(e.closest("div").find('input[type="number"]').val())||null})),n.setVisibleFields.call(n,a),e.close()}},{label:App.translate("By default"),action:function(e){e.close(),n.setDefaultVisibleFields.call(n)}},{label:App.translate("All"),action:function(e){e.close();let t={};Object.values(n.fields).forEach((function(e){t[e.name]=e.width})),n.setVisibleFields.call(n,t)}},{label:App.translate("Create a set"),action:function(a){let i={};l.find("input:checked").each((function(){let e=t(this);i[e.attr("name")]=parseInt(e.closest("div").find('input[type="number"]').val())||null})),n.setVisibleFields.call(n,i),a.close();let o=t("<div></div>");o.append('<div style="padding-top: 10px;"><label>'+App.translate("Set title")+'</label><input type="text" id="fieldsSetName" class="form-control"/></div>'),e.top.BootstrapDialog.show({message:o,title:App.translate("Save the fields set"),type:null,buttons:[{label:App.translate("Save"),action:function(e){let t=o.find("#fieldsSetName");""===t.val().trim()?t.addClass("error"):(s.set(n.tableRow,i,t.val().trim()),e.close())}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],draggable:!0})}},{label:App.translate("Cancel"),action:function(e){e.close()}}];n.isCreatorView&&c.splice(2,0,{label:App.translate("Hide admin. fields"),action:function(e){e.close(),n.hideAdminViewFields.call(n)}});let p={param:App.translate("Header"),column:App.translate("Columns"),footer:App.translate("Footer")};Object.keys(p).forEach((function(e){n.fieldCategories[e]&&n.fieldCategories[e].length&&(l.append('<div class="category-name">'+p[e]+"</div>"),t.each(n.fieldCategories[e],(function(e,a){if(a.__hidden)return;if(!n.isCreatorView&&n.isReplacedButton(a.name))return;let i="";a.hidden&&(i=" ("+App.translate("Hidden by default")+")");let s=t('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="'+a.name+'" class="form-check-input"> '+(n.__getCellTitle(a)||"-")+i+'</label> <input type="number" placeholder="'+a.width+'" value="'+(a.showMeWidth&&a.showMeWidth!==a.width?a.showMeWidth:a.width)+'"/></div>');a.showMeWidth&&(s.find("input").prop("checked",!0),s.attr("data-checked",!0)),s.appendTo(l)})))})),l.on("change",'input[type="checkbox"]',(function(){let e=t(this).closest("div");t(this).is(":checked")?e.attr("data-checked",!0):e.removeAttr("data-checked")})),i=e.top.BootstrapDialog.show({message:l,title:App.translate("Fields visibility"),buttons:c,type:null,draggable:!0,onshow:function(e){n.isCreatorView&&e.$modalContent.css({width:"800px"})}})},fieldsHiddingShowPanelMobile:function(){let a,i,n=this,l=t('<div class="hidding-form">');let s=n.tableRow.fields_sets||[],o=t('<div class="fieldsHiddenSets" id="defaultEyeGroups">').appendTo(l);s&&s.length&&function(e){e=e||t("#defaultEyeGroups"),s=n.tableRow.fields_sets||[],e.empty().append("<b>"+App.translate("Default sets")+":</b> "),s.forEach((function(a,i){let n=t('<a href="#">').text(a.name).data("index",i);e.append(n.wrap("<span>").parent())})),e.off(),e.on("click","a",(function(){let e=t(this).data("index"),a=s[e].fields;if(Array.isArray(a)){let e={};a.forEach((function(t){n.fields[t]&&(e[t]=n.fields[t].width)})),a=e}n.setVisibleFields.call(n,a),i.close()}))}(o),l.on("click",'input[type="checkbox"]',(function(e){let i=t(this),n=i.closest(".hidding-form");if(e.shiftKey){n.find("input").index(i);let e=n.find("input").index(t(this));n.find("input").each((function(n){(e<=n&&n<a||e>=n&&n>a)&&t(this).prop("checked",!!i.is(":checked")&&"checked").trigger("change")}))}else a=n.find("input").index(t(this))}));let r=[{label:App.translate("Apply"),action:function(e){let a={};l.find("input:checked").each((function(){let e=t(this);a[e.attr("name")]=n.fields[e.attr("name")].width})),n.setVisibleFields.call(n,a),e.close()}},{label:App.translate("By default"),action:function(e){e.close(),n.setDefaultVisibleFields.call(n)}},{label:App.translate("All"),action:function(e){e.close();let t={};Object.values(n.fields).forEach((function(e){t[e.name]=e.width})),n.setVisibleFields.call(n,t)}},{label:App.translate("Cancel"),action:function(e){e.close()}}],d={param:App.translate("Header"),column:App.translate("Columns"),footer:App.translate("Footer")};Object.keys(d).forEach((function(e){n.fieldCategories[e]&&n.fieldCategories[e].length&&(l.append('<div class="category-name">'+d[e]+"</div>"),t.each(n.fieldCategories[e],(function(e,a){if(a.__hidden)return;if(!n.isCreatorView&&n.isReplacedButton(a.name))return;let i="";(a.hidden||n.f&&n.f.fieldhide&&"force"===n.f.fieldhide[a.name])&&(i=" ("+App.translate("Hidden by default")+")");let s=t('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="'+a.name+'" class="form-check-input"> '+n.__getCellTitle(a)+i+"</label></div>");a.showMeWidth&&(s.find("input").prop("checked",!0),s.attr("data-checked",!0)),s.appendTo(l)})))})),l.on("change",'input[type="checkbox"]',(function(){let e=t(this).closest("div");t(this).is(":checked")?e.attr("data-checked",!0):e.removeAttr("data-checked")})),i=e.top.BootstrapDialog.show({message:l,title:App.translate("Fields visibility"),buttons:r,type:null,draggable:!0,onshow:function(e){n.isCreatorView&&e.$modalContent.css({width:"800px"})}})},fieldsHiddingGetButton:function(e){"use strict";let a=this;if(!this.___fieldsHiddingShowAllButton)if(this.___fieldsHiddingShowAllButton=t('<button class="btn btn-sm"><span class="fa fa-eye-slash"></span></button>'),this.isMobile)this.___fieldsHiddingShowAllButton.on("click",(function(){a.fieldsHiddingShowPanelMobile.call(a)}));else{let e;this.___fieldsHiddingShowAllButton.on("click",(function(){a.fieldsHiddingShowPanel.call(a)})).on("contextmenu",(function(){return a.isCreatorView?e?(clearTimeout(e),e=null,a.hideAdminViewFields.call(a,!0)):e=setTimeout((function(){a.setDefaultVisibleFields.call(a),e=null}),500):a.setDefaultVisibleFields.call(a),!1}))}return Object.values(a.fields).some((function(e){if(e.showInWeb&&!e.hidden&&!e.__hidden&&!e.showMeWidth&&!a.isCreatorView&&!a.isReplacedButton(e.name))return!0}))?(this.___fieldsHiddingShowAllButton.addClass("btn-warning"),this.___fieldsHiddingShowAllButton.removeClass("btn-default"),e&&App.blink(this.___fieldsHiddingShowAllButton,8,"#fff")):(this.___fieldsHiddingShowAllButton.addClass("btn-default"),this.___fieldsHiddingShowAllButton.removeClass("btn-warning")),this.___fieldsHiddingShowAllButton}});let a="pcTableShowFieldsWithDates",i=function(e){let t=e.id;return"calcs"===e.type&&(t+="$"+e.__version),t},n={saveOpenedVal:function(e,t){localStorage.setItem(this.getKeyString(e),t.toString())},getKeyString:function(e){return e.id+"/"+e.__version},getSavedOpenedVal:function(e){let t=localStorage.getItem(this.getKeyString(e));return!t||JSON.parse(t)}},l={set:function(e,t,n){let l=i(t),s={},o=e||{};try{s=JSON.parse(localStorage.getItem(a))||{}}catch(e){}n||!s[l]?s[l]=[o,n]:s[l][0]=o,localStorage.setItem(a,JSON.stringify(s))},get:function(e){let t=i(e);return l.getInner(t)[0]},getDate:function(e){let t=i(e);return l.getInner(t)[1]},getInner:function(e){let t;try{t=JSON.parse(localStorage.getItem(a))||{}}catch(e){t={}}return t[e]||[]}},s={set:function(e,t,a){let n=[],l="pcTableShowFieldsSets"+i(e),s=t||[];try{n=JSON.parse(localStorage.getItem(l))||{}}catch(e){}n[a]=s,localStorage.setItem(l,JSON.stringify(n))},get:function(e,t){let a,n="pcTableShowFieldsSets"+i(e);try{a=JSON.parse(localStorage.getItem(n)),a=a[t]}catch(e){}return null==a&&(a=void 0),a},getNames:function(e){let t,a="pcTableShowFieldsSets"+i(e);try{return t=JSON.parse(localStorage.getItem(a)),Object.keys(t)}catch(e){}return null==t&&(t=void 0),t},remove:function(e,t){let a,n="pcTableShowFieldsSets"+i(e);try{a=JSON.parse(localStorage.getItem(n)),delete a[t],localStorage.setItem(n,JSON.stringify(a))}catch(e){}}}}(),App.pcTableMain.prototype._printSelect=function(){if(this.isCreatorView||!this.f||!this.f.printbuttons||!this.f.printbuttons.length)return void this._print();let a,i=t('<div class="print-choosing"></div>'),n=this;this.f.printbuttons.forEach(e=>{let l=this.fields[e];if(l&&"button"===l.type){let s=t('<div class="button-wrapper no-width">').data("field",e).appendTo(i);l.getCellText(null,s,this.data_params).appendTo(s).wrap('<span class="cell-value">').on("click",(function(){n._buttonClick(s,l),a.close()}))}});let l=t('<div class="button-wrapper no-width">').appendTo(i);t('<span class="cell-value"><button class="btn btn-default btn-xxs button-field">'+App.translate("Default printing")+"</button></span>").appendTo(l).wrap('<span class="cell-value">').on("click",(function(){n._print(),a.close()}));let s=[{label:App.translate("Cancel"),action:function(e){e.close()}}];a=e.top.BootstrapDialog.show({message:i,type:null,title:App.translate("Print"),buttons:s,draggable:!0})},App.pcTableMain.prototype._excelExportSettingForm=function(e,a){let i,n,l=e,s=JSON.parse(localStorage.getItem("Excel-formats")||"{}")[this.tableRow.id]||{};e=e=>{let t=JSON.parse(localStorage.getItem("Excel-formats")||"{}");t[this.tableRow.id]=t[this.tableRow.id]||{},e.forEach(e=>{"object"==typeof e&&("dates-format"===e[0]?t[this.tableRow.id].d=e[1]:"number-format"===e[0]&&(t[this.tableRow.id].n=e[1]))}),localStorage.setItem("Excel-formats",JSON.stringify(t)),l(e)},s.d||this.model.__ajax("post",{method:"getSchemaFormats"}).then(e=>{e.formats&&(e.formats.dectimalSeparator&&!n.data("changed")&&n.val("."),e.formats.date&&!i.data("changed")&&i.val(e.formats.date))});let o=t('<div class="label-grid no-bold">');return a.append(o),o.append('<label class="form-check-label">'+App.translate("Date formats")+'</label> <input type="text" name="dates-format" class="form-control"/>'),i=a.find('input[name="dates-format"]').val(s.d||App.lang.dateFormat).on("change",(function(){t(this).data("changed",!0)})),o.append('<label class="form-check-label">'+App.translate("Number dectimal delimiter")+'</label> <input type="text" name="number-format" class="form-control"/>'),n=a.find('input[name="number-format"]').val(s.n||1.1.toLocaleString().substring(1,2)).on("change",(function(){t(this).data("changed",!0)})),e},App.pcTableMain.prototype._excelCopyExportForm=function(a){let i=t('<div class="hidding-form">');a=this._excelExportSettingForm(a,i);let n=App.translate("Xlsx export"),l=[{label:App.translate("Export"),action:function(e){let n=["from-selection"];i.find('input[type="text"]').each((function(){n.push([t(this).attr("name"),t(this).val()])})),e.close(),a(n)}},{label:App.translate("Cancel"),action:function(e){e.close()}}];e.top.BootstrapDialog.show({message:i,type:null,title:n,buttons:l,draggable:!0})},App.pcTableMain.prototype._print=function(a){"use strict";let i=t('<div class="hidding-form">');const n=e=>!!e.showMeWidth;this.fieldCategories.param.length&&this.fieldCategories.param.some(n)&&i.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="params" class="form-check-input" checked="checked"> '+App.translate("Parameters")+"</label></div>"),this.fieldCategories.filter.length&&this._content.find(".pcTable-filtersTable td:visible").length&&i.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="filters" class="form-check-input" checked="checked"> '+App.translate("Filters")+"</label></div>"),this.fieldCategories.column.length&&this.fieldCategories.column.some(n)&&this.dataSortedVisible.length&&(i.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="rows" class="form-check-input" checked="checked"> '+App.translate("Rows part")+"</label></div>"),i.append('<div class="form-check no-bold" style="padding-left: 20px;"><label class="form-check-label"><input type="checkbox" name="with-id" class="form-check-input"> '+App.translate("with id")+"</label></div>")),this._footersBlock.find(".val").length&&i.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="column-footers" class="form-check-input" checked="checked"> '+App.translate("Column footers")+"</label></div>"),this._footersSubTable.find(".val").length&&i.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="other-footers" class="form-check-input" checked="checked"> '+App.translate("Out of column footers")+"</label></div>"),a&&(a=this._excelExportSettingForm(a,i));let l=this,s=App.translate(a?"Xlsx export":"Print"),o=[{label:App.translate(a?"Export":"Print"),action:function(e){let n=[];i.find('input:checked, input[type="text"]').each((function(){t(this).is("input:checked")?n.push(t(this).attr("name")):n.push([t(this).attr("name"),t(this).val()])})),e.close(),a?a(n):l._printTable.call(l,n)}},{label:App.translate("Cancel"),action:function(e){e.close()}}];!a&&this.tableRow.__withPDF&&o.splice(0,0,{label:App.translate("Create PDF"),action:function(a){let n=[];i.find("input:checked").each((function(){n.push(t(this).attr("name"))})),a.close(),i=t('<div id="pdfPrintForm"><div class="pdfFormLabel">'+App.translate("Page")+':</div><div><select id="PdfPageType" class="form-control"><option>A4</option><option>A5</option></select></div><div class="pdfFormLabel">'+App.translate("Orientation")+':</div><div><select id="PdfPageOrientaion" class="form-control"><option value="Portrate">'+App.translate("Portrate")+'</option><option value="Landscape">'+App.translate("Landscape")+"</option></select></div></div>");let s=JSON.parse(localStorage.getItem("printPdfSettings")||"{}");i.on("change","select",(function(){s[l.tableRow.id]=s[l.tableRow.id]||{},s[l.tableRow.id]={page:t("#PdfPageType").val(),orientation:t("#PdfPageOrientaion").val()},localStorage.setItem("printPdfSettings",JSON.stringify(s))})),s[l.tableRow.id]&&setTimeout(()=>{t("#PdfPageType").val(s[l.tableRow.id].page),t("#PdfPageOrientaion").val(s[l.tableRow.id].orientation)}),o=[{label:App.translate("Download"),action:function(e){l._printTable.call(l,n,{page:t("#PdfPageType").val(),orientation:t("#PdfPageOrientaion").val().substring(0,1)}),e.close()}},{label:App.translate("Cancel"),action:function(e){e.close()}}],e.top.BootstrapDialog.show({message:i,type:null,title:App.translate("Create PDF"),buttons:o,draggable:!0})}}),e.top.BootstrapDialog.show({message:i,type:null,title:s,buttons:o,draggable:!0})},App.pcTableMain.prototype._printTable=function(e,t){let a=this,i={fields:{},pdf:t};-1!==e.indexOf("with-id")&&(i.fields.id=50);let n={params:a.fieldCategories.param,filters:a.fieldCategories.filter,rows:a.fieldCategories.column,"column-footers":a.fieldCategories.footer.filter((function(e){return""!==e.column})),"other-footers":a.fieldCategories.footer.filter((function(e){return""===e.column}))};if(Object.keys(n).forEach((function(t){-1!==e.indexOf(t)&&n[t].forEach((function(e){"button"===e.type||e.showMeWidth<1||!e.showMeWidth||(i.fields[e.name]=e.showMeWidth)}))})),-1!==e.indexOf("rows")){let e=[];a.dataSortedVisible.forEach(t=>{"object"==typeof t?"other"===a.fields.tree.treeViewType||e.push(t.row.id):e.push(t)}),i.ids=e}i.sosiskaMaxWidth=1100,"rotated"===a.viewType&&(i.rotated=a.tableRow.rotated_view),a.model.printTable(i)},App.pcTableMain.prototype._tableExtButtons=function(){let a,i=t('<div class="print-choosing"></div>'),n=this;this.f.extbuttons.forEach(e=>{let l=this.fields[e];if(l&&"button"===l.type){let s=t('<div class="button-wrapper no-width">').data("field",e).appendTo(i);l.getCellText(null,s,this.data_params).appendTo(s).wrap('<span class="cell-value">').on("click",(function(){n._buttonClick(s,l),a.close()}))}});let l=[{label:App.translate("Cancel"),action:function(e){e.close()}}];a=e.top.BootstrapDialog.show({message:i,type:null,buttons:l,draggable:!0})},App.pcTableMain.prototype.reOrderRows=function(e,a){let i,n=this;if(n.tableRow.with_order_field&&!n.nSorted)return App.notify(App.translate("To operate the order field, reload the table")),!1;if(n.isRestoreView)return App.notify(App.translate("Rows restore mode. Sorting disabled")),!1;let l=[];if(0===this.row_actions_get_checkedIds().length){l.push(e);let t=this.dataSortedVisible.indexOf(e)+("after"===a?1:-1);if(t<0||!(t in this.dataSortedVisible))return;if(this.data[this.dataSortedVisible[t]].f&&this.data[this.dataSortedVisible[t]].f.blockorder)return void App.notify(App.translate("You cannot move the row %s",this.getRowTitle(this.data[this.dataSortedVisible[t]])));i=this.dataSorted.indexOf(this.dataSortedVisible[t]),l.forEach((function(e){n.dataSorted.splice(n.dataSorted.indexOf(e),1)}))}else{if(-1!==n.row_actions_get_checkedIds().indexOf(e))return App.notify(App.translate("The unchecked row should be selected as the anchor for the move")),!1;let t=this.row_actions_get_checkedIds().length;this.dataSorted.some((function(e,a){if(0===t)return!0;n.data[e].$checked&&(l.push(e),--t)})),l.forEach((function(e){n.dataSorted.splice(n.dataSorted.indexOf(e),1)})),i=this.dataSorted.indexOf(e)+("after"===a?1:0)}n.dataSorted.splice(i,0,...l),this.dataSortedVisible=[],n.dataSorted.forEach((function(e){n.data[e].$visible&&n.dataSortedVisible.push(e)})),n._refreshContentTable(),n.tableRow.with_order_field&&t("table.pcTable-table").addClass("reordered"),n.row_actions_uncheck_all()},App.pcTableMain.prototype.reOrderRowsSave=function(){let e=this;e._orderSaveBtn.prop("disabled",!0).find("i").attr("class","fa fa-cog"),this.model.saveOrder(this.dataSorted).then((function(a){e.dataSorted.forEach(t=>{e.data[t]&&e.data[t].__inserted&&delete e.data[t].__inserted}),e.table_modify(a),e._orderSaveBtn.prop("disabled",!1).find("i").attr("class","fa fa-save"),t("table.pcTable-table").removeClass("reordered")}))},App.pcTableMain.prototype.addReOrderRowBind=function(){let e=this;e._innerContainer.on("click","td.n button",(function(a){let i=t(this);e.tableRow.with_order_field&&!e.__getCheckedRowsIds(void 0,!0,"blockorder")||e.reOrderRows.call(e,e._getItemByTr.call(e,i.closest("tr")).id,1===i.find(".fa-angle-up").length?"before":"after")}))},App.pcTableMain.prototype.__formatFunctions={interlace:function(e){if(e&&!this.f.interlace)return;let a=t("#ttmTableStyles").length?t("#ttmTableStyles"):t("<style>").attr("id","ttmTableStyles").appendTo(this._container),i="";if(this.f.interlace.toString().match(/^[0-9]{1,3}$/)&&parseInt(this.f.interlace)<=100)i+=" tr.DataRow:nth-of-type(odd) td {box-shadow: inset 0 0 100px 100px rgba(0,0,0,"+parseInt(this.f.interlace)/100+")}";else{this.f.interlace.split("/").forEach((e,t)=>{e.match(/\#?[0-9A-F]+/i)&&(i+=1==t?" tr.DataRow:nth-of-type(odd) td {background-color: "+App.theme.getColor(e)+";}":" tr.DataRow:nth-of-type(even) td {background-color: "+App.theme.getColor(e)+";}")})}a.text(i)},hidedots:function(){this.RightBottomServicesButtonCheckAttached()},fieldhide:function(){this.f&&this.f.fieldhide&&Object.keys(this.f.fieldhide).length&&(this.loadVisibleFields(this.f.fieldhide),this._refreshHead(),this._refreshContentTable(!0))},kanban_html:function(){this._refreshContentTable()},blockadd:function(){this._closeInsertRow(),this._rowsButtons()},hideadd:function(){this._closeInsertRow(),this._rowsButtons()},tablecomment:function(){this._rowsButtons()},browsertitle:function(){this._setBrowserTitle()},buttons:function(){this._rerendParamsblock(),this._rerendBottomFoolers(),this._rerenderColumnsFooter(),this._rowsButtons()},printbuttons:function(){this._rerendParamsblock(),this._rerendBottomFoolers(),this._rerenderColumnsFooter()},dotbuttons:function(){this._rerendParamsblock(),this._rerendBottomFoolers(),this._rerenderColumnsFooter(),this.RightBottomServicesButtonRefresh()},topbuttons:function(){let e=this._beforeSpace_title.find(".common-table-title");!1===this.f.topbuttons?this.isCreatorView?e.addClass("admin-hidden"):e.hide():this.isCreatorView?e.removeClass("admin-hidden"):e.show()},extbuttons:function(){this._rerendParamsblock(),this._rerendBottomFoolers(),this._rerenderColumnsFooter(),this._beforeSpace_title.find("#ttm-extButtonsBar").css("display",pcTable.f.extbuttons&&pcTable.f.extbuttons.length?"inline":"none")},blockorder:function(){this._refreshHead()},block:function(){this._refreshParamsBlock(),this._refreshContentTable(!0),this._refreshFootersBlock()},tabletitle:function(){this._refreshTitle()},tabletext:function(){this._refreshTableText()},tablehtml:function(){this._refreshTableText()},text:function(){this._refreshTableText()},rowstitle:function(){this._container.find(".pcTable-rowsTitle:first").replaceWith(this._createRowsTitle())},fieldtitle:function(e,t){let a={};const i=function(e){return"footer"==e.category&&e.column?"tableFooter":e.category};for(const n in e)this.fields[n]&&e[n]!==t[n]&&(a[i(this.fields[n])]=!0);for(const n in t)this.fields[n]&&e[n]!==t[n]&&(a[i(this.fields[n])]=!0);for(const e in a)switch(e){case"param":this._rerendParamsblock();break;case"filter":this._rerendFiltersBlock();break;case"column":this._refreshHead();break;case"footer":this._rerendBottomFoolers();break;case"tableFooter":this._rerenderColumnsFooter()}}},App.pcTableMain.prototype._connectTreeView=function(){let e=this;this._content.on("click",".treeRow",(function(a){let i=t(this);i.is(".dbl")?e._actionTreeFolderRow(i,!0):i.is(".ins")?e._actionAddTreeFolderRow(i):e._actionTreeFolderRow(i)})),this.model.loadTreeBranches=function(e,t,a){return this.__ajax("post",{method:"loadTreeBranches",branchIds:e,withParents:t,recurcive:a},null,null,this.filtersString||{})},this.reOrderRows=function(e,a){let i,n,l=this;if(e=e.toString(),l.tableRow.with_order_field&&!l.nSorted)return App.notify(App.translate("To operate the order field, reload the table")),!1;if(l.isRestoreView)return App.notify(App.translate("Rows restore mode. Sorting disabled")),!1;if(void 0!==this.nSortedTree&&this.data[e].tree.v!=this.nSortedTree)return App.notify(App.translate("It is possible to sort only within a category")),!1;void 0===this.nSortedTree&&(this.nSortedTree=this.data[e].tree.v),i="self"===this.fields.tree.treeViewType?null===this.nSortedTree?this.treeSort:this.treeIndex[this.nSortedTree].trees:this.treeIndex[this.nSortedTree].sorted;let s=[];if(0===this.row_actions_get_checkedIds().length){s.push(e);let t=i.indexOf(e),l=t+("after"===a?1:-1);if(!(l in i))return;let o=i[l];if(this.data[o].f&&this.data[o].f.blockorder)return void App.notify(App.translate("You cannot move the row %s",this.getRowTitle(this.data[o])));i.splice(t,1),n=i.indexOf(o)+("after"===a?1:0)}else{if(-1!==l.row_actions_get_checkedIds().indexOf(e))return App.notify(App.translate("The unchecked row should be selected as the anchor for the move")),!1;let t=this.row_actions_get_checkedIds().length;this.dataSorted.some((e,a)=>{if(0===t)return!0;if("object"==typeof e)if("self"===this.fields.tree.treeViewType)e=e.row.id;else{if(!e.row)return;if(e.row.$checked)return this.nSortedTree=void 0,App.notify(App.translate("Only nested rows can be moved")),!0;e=e.row.id}if(l.data[e].$checked){if(l.data[e].tree.v!=this.nSortedTree)return this.nSortedTree=void 0,App.notify(App.translate("You can only move within one branch")),!0;s.push(e.toString()),--t}}),s.forEach((function(e){i.splice(i.indexOf(e),1)})),n=i.indexOf(e)+("after"===a?1:0)}i.splice(n,0,...s),this.ntreeSortedArr=i,l.tableRow.with_order_field&&(this.nReorderedTree=this.nSortedTree,t("table.pcTable-table").addClass("reordered")),l.treeApply(!0),l.row_actions_uncheck_all()},this.setOrdersForRows=function(e){if("self"!==this.fields.tree.treeViewType)return;const t=t=>{let a=[];return e.forEach(e=>{e=e.toString(),t.indexOf(e)>-1&&a.push(e)}),t.forEach(e=>{-1==a.indexOf(e.toString())&&a.push(e)}),a};this.treeSort=t(this.treeSort);const a=e=>{this.treeIndex[e].trees=t(this.treeIndex[e].trees),this.treeIndex[e].trees.forEach(a)};this.treeSort.forEach(a)},this.reOrderRowsSave=function(){let e=this;e._orderSaveBtn.prop("disabled",!0).find("i").attr("class","fa fa-cog"),this.model.saveOrder(this.ntreeSortedArr.map(e=>parseInt(e))).then((function(a){e.nSortedTree=void 0,e.nReorderedTree=!1,e.table_modify(a),e._refreshContentTable(!0),e._orderSaveBtn.prop("disabled",!1).find("i").attr("class","fa fa-save"),t("table.pcTable-table").removeClass("reordered")}))};const a=App.pcTableMain.prototype._refreshCheckedStatus;this._refreshCheckedStatus=function(){a.call(this);let e=this.nSortedTree,t=!!this.nSortedTreeBlock;this.nSortedTreeBlock=!1,this.__checkedRows.length||this.nReorderedTree||(this.nSortedTree=void 0),this.__checkedRows.some(e=>{if(this.data[e].__tree&&"other"===this.fields.tree.treeViewType)return this.nSortedTreeBlock=!0,!0;if(void 0!==this.nSortedTree){if(this.data[e].tree.v!==this.nSortedTree)return this.nSortedTreeBlock=!0,!0}else this.nSortedTree=this.data[e].tree.v}),e===this.nSortedTree&&t===this.nSortedTreeBlock||this.ScrollClasterized.insertToDOM(null,!1,!0)},this._csvExport=function(e){"use strict";let t=this,a=[];t.dataSortedVisible.forEach(e=>{e.row&&e.row.id?a.push(e.row.id):"string"==typeof e&&a.push(e)}),this.model.csvExport(a,e,Object.keys(App.filter(t.fields,(e,t)=>!!t.showMeWidth))).then((function(e){if(e.csv){let a=new Blob([e.csv],{type:"text/csv;charset=utf-8"});saveAs(a,t.tableRow.title+"."+t.model.tableData.updated.dt+".csv")}}))}},App.pcTableMain.prototype._treeFolderRowAddDropdown=function(a,i){let n,l=t("<div>"),s=t('<button class="btn btn-default btn-xxs treeRow"><i class="fa fa-caret-down"></i></button>').popover({html:!0,content:l,trigger:"manual",container:this._container,placement:"auto bottom"}).on("click",()=>(t("body").trigger("click"),s.popover("show"),n=t("#"+s.attr("aria-describedby")),setTimeout(()=>{this.closeCallbacks.push(()=>{s&&s.length&&s.popover("hide")})},200),!1)).on("remove",()=>{n.remove()});a.append(s);let o=t('<div class="menu-item"><i class="fa fa-arrows-v"></i> '+(i.opened?App.translate("Close all"):App.translate("Open all"))+"</div>").data("treeRow",i.v).on("click",()=>{this._actionTreeFolderRow(o,!0)}).appendTo(l);this.fields.tree.selectTable&&i.v&&!this.fields.tree.treeBfield&&(t('<div class="menu-item"><i class="fa fa-edit"></i> '+App.translate("Edit")+"</div>").on("click",()=>{let e={id:i.v};new EditPanel(this.fields.tree.selectTable,null,e).then(()=>{this.model.refresh()})}).appendTo(l),t('<div class="menu-item"><i class="fa fa-th-large"></i> '+App.translate("Add a branch")+"</div>").on("click",()=>{let e={[this.fields.tree.treeViewParentField||"tree"]:{v:i.v}};new EditPanel(this.fields.tree.selectTable,null,e,null,{tree:!0}).then(e=>{this.treeReloadRows.push(Object.keys(e.chdata.rows)[0]),this.treeApply()})}).appendTo(l)),this.isInsertable()&&"self"!==this.fields.tree.treeViewType&&this.fields.tree.insertable&&t('<div class="menu-item"><i class="fa fa-plus"></i> '+App.translate("Add a row")+"</div>").on("click",()=>{if("cycles"===this.tableRow.type)this.model.add(null,{tree:i.v}).then(t=>{t.firstTableId?e.location.href=e.location.pathname+"/"+t.chdata.rows[0].id+"/"+t.firstTableId:this.table_modify(t)});else{let e={tree:{v:i.v}};new EditPanel(this,null,e,null,{tree:!0}).then(e=>{this.table_modify(e)})}}).appendTo(l)},App.pcTableMain.prototype._createTreeFolderRow=function(e,a){if(e.row&&this.data[e.row.id]){let t={...e};delete t.row,e.row.__tree=t;let i=a||this._createRow(e.row);return this.data[e.row.id].__tree=t,e.tr=this.data[e.row.id].$tr=i}{let i=a||t('<tr><td class="id"></td></tr>'),n=t('<i class="fa fa-folder'+(e.opened?"-open":"")+' treeRow"></i>').data("treeRow",e.v),l=t('<td colspan="'+this.fieldCategories.visibleColumns.length+'" class="tree-view-td" style="padding-left: '+(7+22*e.level)+'px"></td>'),s=t('<span class="tree-view">').append(n);l.append(s),this._treeFolderRowAddDropdown(s,e);let o=t('<span class="treeRow">').html(t("<span>").text(e.t)).data("treeRow",e.v);return e.opened&&e.count&&this._treePagination(o,e),l.append(o),i.append(l),e.tr=i}},App.pcTableMain.prototype.treePaginationLoadPageStack=function(e){this.treePaginationLoadPageTimer&&clearTimeout(this.treePaginationLoadPageTimer),this._treePaginationLoadPageStack=this._treePaginationLoadPageStack||[],this._treePaginationLoadPageStack.push(e),this.treePaginationLoadPageTimer=setTimeout(()=>{let e=this._treePaginationLoadPageStack;this._treePaginationLoadPageStack=null,this.treePaginationLoadPage(e)},20)},App.pcTableMain.prototype.treePaginationLoadPage=function(e){if(!this.treePaginationCountLimit){let e=this.tableRow.pagination.split("/");this.treePaginationCountLimit=this.isMobile?e[1]:e[0]}if(e&&e.length){let t=[];e.forEach(e=>{t.push({v:e.v,p:e.PageData.page})}),this.model.loadTreeRows=this.model.loadTreeRows||function(e,t){return e=JSON.stringify(e),this.__ajax("post",{method:"loadTreeRows",branches:e,onPage:t},null,null,this.filtersString||{})},this.model.loadTreeRows(t,this.treePaginationCountLimit).then(t=>{t.deleted=[],e.forEach(e=>{this.treeIndex[e.v]&&t.deleted.push(...this.treeIndex[e.v].sorted)}),this.table_modify({chdata:t}),this.treeApply(!0),e.forEach(e=>{this._treePagination(null,e)})})}},App.pcTableMain.prototype._treePagination=function(e,a){let i;if(a.PageData=a.PageData||{},a.PageData.$block=a.PageData.$block||t('<span class="ttm-pagination"></span>'),e&&!a.PageData.$block.parent().is(e)&&a.PageData.$block.appendTo(e),void 0===a.PageData.page)a.PageData.$block.empty().append('<i class="fa fa-spinner"></i>'),a.PageData.page=0,this.treePaginationLoadPageStack(a);else if(1===(i=Math.ceil(a.count/this.treePaginationCountLimit)))a.PageData.$block.empty().append("");else{let e=t('<button class="btn btn-default btn-sm"><i class="fa fa-hand-o-left"></i></button>');0===a.PageData.page?e.prop("disabled",!0).on("click",()=>!1):e.on("click",()=>(a.PageData.$block.empty().append('<i class="fa fa-spinner"></i>'),a.PageData.page--,this.treePaginationLoadPageStack(a),!1));let n=t('<button class="btn btn-default btn-sm"><i class="fa fa-hand-o-right"></i></button>');a.PageData.page>=i-1?n.prop("disabled",!0).on("click",()=>!1):n.on("click",()=>(a.PageData.$block.empty().append('<i class="fa fa-spinner"></i>'),a.PageData.page++,this.treePaginationLoadPageStack(a),!1));let l=t('<span class="ttm-pages-arrows"><i class="fa fa-ellipsis-h"></i></span>');a.PageData.$block.empty().append(l).append(t('<span class="ttm-pages-active">').append(e).append('<span class="ttm-pages">'+App.translate("%s from %s",[a.PageData.page+1,i])+"</span>").append(n))}},App.pcTableMain.prototype.treeApply=function(e=!1){this.treeReloadRows.length?this.model.loadTreeBranches(this.treeReloadRows,!0).then(e=>{e.tree&&(e.tree.forEach((e,t)=>{this.treeIndex[e.v]&&(this.treeIndex[e.v].trees=[])}),e.tree.forEach((e,t)=>{this.getTreeBranch(e,t)})),e.rows&&this._treeApplyRows(e.rows),this.treeReloadRows=[],this._treeRefresh(),this.__applyFilters(!0),this.ScrollClasterized.insertToDOM(null,!0,!0)}):(this._treeRefresh(),this.__applyFilters(!0,e),this.treeLoading&&(this.treeLoading=!1,this.ScrollClasterized.insertToDOM(null,!0,!0)))},App.pcTableMain.prototype._closeTreeFolderRow=function(e,t,a){e.opened=!1,a=a||0,t?(this.treeIndex[e.v].trees.forEach(e=>{this._closeTreeFolderRow(this.treeIndex[e],!0,a+1)}),a||this.treeApply()):this.treeApply()},App.pcTableMain.prototype._actionTreeFolderRow=function(e,a){let i=this.treeIndex[t(e).data("treeRow")];e&&(t(e).closest("td").html(App.translate("Loading")),this.treeLoading=!0),i.opened?this._closeTreeFolderRow(i,a):this._expandTreeFolderRow(i,a)},App.pcTableMain.prototype._actionAddTreeFolderRow=function(e,t){if("self"===this.fields.tree.treeViewType){let t={tree:{v:this._getItemBytd(e.closest("td")).id}};new EditPanel(this,null,t,null,{tree:!0}).then(e=>{this.table_modify(e),this.reloaded()})}},App.pcTableMain.prototype._expandTreeFolderRow=function(e,t,a){let i=!1;a||(i=!0,a={counter:0});const n=()=>{this.treeIndex[e.v].trees.forEach(e=>{a.counter++,this._expandTreeFolderRow(this.treeIndex[e],!0,a)})};e.l?(e.opened=!0,t?(n(),a.counter<1?this.treeApply():a.counter--):this.treeApply()):this.model.loadTreeBranches([e.v],null,!!t).then(i=>{e.opened=!0,e.l=!0,i.tree&&i.tree.forEach((e,t)=>{this.getTreeBranch(e,t)}),i.rows&&i.rows.length&&this._treeApplyRows(i.rows),(!t||a.counter--<1)&&this.treeApply()})},App.pcTableMain.prototype._treeRefresh=function(){let e=[];const t=(a,i)=>{i=i||0,a.forEach(a=>{this.treeIndex[a]&&this.treeIndex[a].row&&this.treeIndex[a].row.__tree&&this.treeIndex[a].level!=i&&(this.treeIndex[a].row.__tree.level=i,e.push(a)),this.treeIndex[a].level=i,0!==i||"opened"in this.treeIndex[a]||(this.treeIndex[a].opened=!0),this.dataSorted.push(this.treeIndex[a]),this.treeIndex[a].opened&&(this.dataSorted.push(...this.treeIndex[a].sorted),t(this.treeIndex[a].trees,i+1))})};this.dataSorted=[];let a=[...this.treeSort];""==a[0]&&0===this.treeIndex[""].sorted.length&&delete a[0],t(a),e.forEach(e=>{this.treeIndex[e].tr&&this.treeIndex[e].row&&this.treeIndex[e].tr.find(".id").next().length&&this._removeEditing(this.treeIndex[e].tr.find(".id").next())})},App.pcTableMain.prototype._treeApplyRows=function(e){e.map(e=>{this.placeInTree(e),e.id in this.data||(this.data[e.id]=e,this.data[e.id].$checked=-1!==this.__checkedRows.indexOf(e.id))},this)},App.pcTableMain.prototype.removeTreeBranch=function(e){if(e in this.treeIndex)if(this.treeIndex[e].p){let t=this.treeIndex[this.treeIndex[e].p];this.treeReloadRows.push(t.v)}else delete this.treeIndex[e],this.treeRefresh()},App.pcTableMain.prototype.getElementInTree=function(e){return this.treeIndex[e]},App.pcTableMain.prototype.placeInTree=function(e,t,a){let i="sorted";const n=e=>{let t=e.id;return this.fields.tree.treeBfield&&e[this.fields.tree.treeBfield]&&(t=e[this.fields.tree.treeBfield].v),t};if("self"===this.fields.tree.treeViewType&&(i="trees"),t){let a=t?t.tree.v:void 0;if(null===a&&(a=""),"other"===this.fields.tree.treeViewType&&t.tree_category&&t.tree_category.v&&this.treeIndex[t.tree_category.v]&&this.treeIndex[t.tree_category.v].row&&this.treeIndex[t.tree_category.v].row.id===t.id&&delete this.treeIndex[t.tree_category.v].row,a in this.treeIndex){let l=n(t);if(e&&n(e)==l){if(!e||e.tree.v!=t.tree.v){let e=this.treeIndex[t.tree.v][i].indexOf(l.toString());-1!==e&&this.treeIndex[t.tree.v][i].splice(e,1)}}else{let e=this.treeIndex[a][i].indexOf(l.toString());-1!==e&&this.treeIndex[a][i].splice(e,1)}}else if("self"===this.fields.tree.treeViewType&&(!e||this.treeIndex[n(e)].p!=this.treeIndex[n(t)].p)){let e=this.treeSort.indexOf(n(t).toString());-1!==e&&this.treeSort.splice(e,1)}this.treeRefresh=!0}if(e){if("other"===this.fields.tree.treeViewType&&e.tree_category&&e.tree_category.v&&this.treeIndex[e.tree_category.v])this.treeIndex[e.tree_category.v].row=e;else{let t=e.tree.v||"",l=n(e);if("self"===this.fields.tree.treeViewType&&(l in this.treeIndex?this.treeIndex[l].row=e:i="sorted"),t in this.treeIndex&&this.treeIndex[t].l){if(-1===this.treeIndex[t][i].indexOf(l.toString())){let e=!1;this.tableRow.with_order_field&&this.data[l]&&this.data[l].n&&(this.treeIndex[t][i].length&&this.data[this.treeIndex[t][i][0]]&&this.data[this.treeIndex[t][i][0]].n>this.data[l].n?(e=!0,this.treeIndex[t][i].unshift(l)):this.treeIndex[t][i].some((a,n)=>{this.data[l].n>this.data[a].n&&this.treeIndex[t][i][n+1]&&this.treeIndex[t][i][n+1]&&this.data[this.treeIndex[t][i][n+1]]&&this.data[this.treeIndex[t][i][n+1]].n>this.data[l].n&&(e=!0,this.treeIndex[t][i].splice(n+1,0,l))})),e||this.treeIndex[t][i].push(l.toString())}a&&this.openTreeWithParent(this.treeIndex[t])}else t&&this.treeReloadRows.push(t)}this.treeRefresh=!0}},App.pcTableMain.prototype.openTreeWithParent=function(e){e.opened=!0,e.p&&this.treeIndex[e.p]&&this.openTreeWithParent(this.treeIndex[e.p])},App.pcTableMain.prototype.treeDeletingRow=function(e){let t=this.data[e];t&&this.placeInTree(null,t)},App.pcTableMain.prototype.getTreeBranch=function(e){if(null===e.v?e.v="":e.v=e.v.toString(),this.treeIndex[e.v]||(this.treeIndex[e.v]={...e},this.treeIndex[e.v].sorted=this.treeIndex[e.v].sorted||[],this.treeIndex[e.v].trees=this.treeIndex[e.v].trees||[]),this.treeIndex[e.v].l="l"in e?e.l:"l"in this.treeIndex[e.v]?this.treeIndex[e.v].l:""===e.v,this.treeIndex[e.v].opened="opened"in e?e.opened:"opened"in this.treeIndex[e.v]?this.treeIndex[e.v].opened:""===e.v,void 0!==e.p&&this.treeIndex[e.v].p!=e.p&&void 0!==this.treeIndex[e.v].p&&this.treeIndex[e.v].p in this.treeIndex){let t=this.treeIndex[this.treeIndex[e.v].p].trees.indexOf(this.treeIndex[e.v].v);-1!==t&&this.treeIndex[this.treeIndex[e.v].p].trees.splice(t,1)}if(e.p){let t=this.getTreeBranch({v:e.p});-1===t.trees.indexOf(e.v)&&t.trees.push(e.v);let a=this.treeSort.indexOf(e.v);-1!==a&&this.treeSort.splice(a,1)}else e.t&&-1===this.treeSort.indexOf(e.v)&&this.treeSort.push(e.v);return Object.keys(e).forEach(t=>{this.treeIndex[e.v][t]=e[t]}),this.treeIndex[e.v]},function(){const e=function(e){let a=this.data[e],i=a.$tr||t('<div class="panelsView-card pcTable-floatInner">').css({"min-height":(this.tableRow.panels_view.height||50)+"px",height:this.tableRow.panels_view.height||"auto",width:this.tableRow.panels_view.width});if(a.$tr=i.empty(),i.data("id",e),this.tableRow.panels_view.fields.forEach(n=>{let l=t("<td>"),s={};s.height=n.height||"auto",l.data("name",n.field),n.border||(s["border-color"]="transparent",s["background-color"]="transparent");let o,r=this.fields[n.field];try{o=t.extend({},this.f||{},a.f||{},a[n.field].f&&a[n.field].f||{})}catch(e){console.log(e,a,n.field),o={}}if("button"!=r.type){if(o.color&&(s["font-color"]=App.theme.getColor(o.color,!0)),o.background&&(s["background-color"]=App.theme.getColor(o.background)),o.text)l.text(o.text);else{let e=r.getHighCelltext(a[n.field].v,l,a);null!==e&&"object"==typeof e?e.then&&"function"==typeof e.then?(l.html('<div class="text-center"><i class="fa fa-spinner"></i></div>'),e.then(e=>{"object"==typeof e?l.html(e):l.text(e)})):l.html(e):l.text(e),r.unitType&&""!==e&&(r.before?l.prepend(r.unitType+" "):l.append(" "+r.unitType))}if(o.comment?l.prepend(t('<i class="fa fa-info">').attr("title",o.comment)).addClass("with-icon"):o.icon&&l.prepend(t('<i class="fa">').addClass("fa-"+o.icon)).addClass("with-icon"),l.attr("data-field-type",r.type).addClass("nonowrap"),r.editable&&r.pcTable.control.editing&&!o.block?l.addClass("panel-edt"):r.CodeActionOnClickAsUrl&&l.addClass("asUrl"),!1!==o.showhand&&a[n.field].h){let e,i=a[n.field];e=void 0!==i.c&&i.v!=i.c?t('<i class="fa fa-hand-paper-o pull-right cell-icon" aria-hidden="true"></i>'):t('<i class="fa fa-hand-rock-o pull-right cell-icon" aria-hidden="true"></i>'),l.append(e)}if(r.editable&&this.control.editing&&!o.block)l.on("dblclick",(function(){let e=l.css("backgroundColor"),t=l.html();l.html("  ").addClass("editing-in-modal"),c.editSingleFieldInPanel(r,a.id).then(a=>{a?c.table_modify(a):(l.css("background-color",e),l.html(t))}).catch(e=>{console.log(e)})}));else if(r.CodeActionOnClick){const t=()=>{l.data("blocked")||(l.data("blocked",!0),l.html('<div class="text-center"><i class="fa fa-spinner"></i></div>'),r.pcTable.model.dblClick(e,r.name).always(e=>{l.data("blocked",!1),r.pcTable.table_modify(e)}))};r.CodeActionOnClickAsUrl?l.addClass("asUrl").on("click",t):l.on("dblclick",t)}}else{a.__td_style=function(){let e={td:{},Button:{}};return o.background&&(e.Button.backgroundColor=App.theme.getColor(o.background)),o.color&&(e.Button.color=App.theme.getColor(o.color,!0)),e.td.backgroundColor="transparent",e},l.html(r.getCellText(a[n.field].v,l,a)),l.find("button").on("click",()=>{this._buttonClick(l,r,a)})}if(o.bold&&(s["font-weight"]="bold"),o.italic&&(s["font-style"]="italic"),o.decoration&&(s["text-decoration"]=o.decoration),o.align&&(s["text-align"]=o.align),o.color&&(s.color=App.theme.getColor(o.color,!0)),o.tab&&(s["padding-left"]=o.tab),o.progress&&o.progresscolor){let e=function(){if(l.isAttached()){let e=Math.round(l.outerWidth()*parseInt(o.progress)/100);l.css("box-shadow","inset "+e.toString()+"px 0px 0 0 "+App.theme.getColor(o.progresscolor))}else setTimeout(e,1)};e()}l.css(s);let d=t("<div>").append(l),c=this;if(n.title){let a=t('<th class="panelsView-card-item">').text(this.fields[n.field].title);r.help&&(r.helpFunc||(c.addThHelpCloser(),r.helpFunc=function(e){let a,i=t(this);return i.data("bs.popover")?"open"!==e.type&&(a&&clearTimeout(a),a=setTimeout(()=>{i.attr("aria-describedby")&&t("#"+i.attr("aria-describedby").length)&&i.popover("destroy")},120)):"close"!==e.type&&(c._container.trigger("click"),setTimeout(()=>{let e=t('<div class="i-inner-div">').html(r.help).width(230);i.popover({trigger:"manual",content:e,html:!0,placement:()=>{let t=c._container;i.offset().top,t.offset().top;return e.css("max-height",300),"bottom"},container:c.scrollWrapper}),i.popover("show")},150)),!1}),a.prepend(t('<button class="btn btn-default btn-xxs cell-help" id="field-help-'+r.name+"-"+e+'"><i class="fa fa-info"></i></button>').on("click open close",r.helpFunc))),d.prepend(a)}i.append(d)}),this.tableRow.panels_view.controls){if(!this.pcTableControllsEvents){this.pcTableControllsEvents=!0;let e=this;this._innerContainer.on("click",".panel-controls button",(function(){let a=t(this),i=a.closest(".panelsView-card").data("id");switch(a.data("action")){case"duplicate":e.row_duplicate(i);break;case"delete":e.rows_delete(i);break;case"recalculate":e.row_refresh(i);break;case"panel":e._row_edit([i])}return!1}))}let n=t('<div class="panel-controls">');this._isDisplayngIdEnabled()&&n.append('<span class="panle-id">id '+e+"</span>"),this.tableRow.panel&&n.append('<button class="btn btn-default btn-xxs" data-action="panel"><i class="fa fa-th-large"></i></span>'),!this.control.duplicating||this.f.blockduplicate||a.f.blockduplicate||n.append('<button class="btn btn-default btn-xxs" data-action="duplicate"><i class="fa fa-clone"></i></span>'),!this.control.deleting||this.f.blockdelete||a.f.blockdelete||n.append('<button class="btn btn-default btn-xxs" data-action="delete"><i class="fa fa-times"></i></span>'),n.append('<button class="btn btn-default btn-xs" data-action="recalculate"><i class="fa fa-refresh"></i></span>'),i.append(n)}return i},a=function(e){if(this.kanban&&this.fields[this.tableRow.panels_view.kanban].editable||this.tableRow.with_order_field){const a=(e,a)=>{let i=t.Deferred(),n=[];return e.parent().find(".panelsView-card").each((e,a)=>{n.push(t(a).data("id"))}),n.length>1?(n.forEach(e=>{this.dataSorted.splice(this.dataSorted.indexOf(e),1)}),this.dataSorted.push(...n),this.model.saveOrder(n).then(e=>{this.table_modify(e,null,null,a)})):(i.resolve(),i.promise())};t(e).find(".kanban").sortable({items:".panelsView-card",connectWith:this.kanban&&this.fields[this.tableRow.panels_view.kanban].editable?".kanban":"",over:(e,a)=>{let i=t(a.item).data("id"),n=(this.data[i][this.tableRow.panels_view.kanban].v,a.placeholder.closest(".kanban").data("value"));this.data[i][this.tableRow.panels_view.kanban].v!=n||this.tableRow.with_order_field?(a.item.removeClass("kanban-disabled"),a.placeholder.closest(".kanban").addClass("kanban-enabled")):a.item.addClass("kanban-disabled")},out:(e,t)=>{this.kanban&&this.fields[this.tableRow.panels_view.kanban].editable||t.item.addClass("kanban-disabled"),t.placeholder.closest(".kanban").removeClass("kanban-enabled")},start:(a,i)=>{this.kanban&&this.fields[this.tableRow.panels_view.kanban].editable||t(e).find(".kanban").not(t(i.item).closest(".kanban")).addClass("kanban-disabled"),i.item.data("prev",t(i.item).prev().data("id"))},stop:(i,n)=>{t(e).find(".kanban").removeClass("kanban-enabled"),t(n.item).removeClass("kanban-disabled");let l=t(n.item),s=l.data("id"),o=this.data[s][this.tableRow.panels_view.kanban].v||"",r=l.closest(".kanban").data("value");if(l.data("prev")===t(n.item).prev().data("id")&&o==r)return;let d=l.prev().data("id");l.closest(".kanban").removeClass("kanban-disabled"),o!=r?(App.fullScreenProcesses.show("sorting"),this.tableRow.with_order_field?a(l,!0).always(()=>{this.model.save({[s]:{[this.tableRow.panels_view.kanban]:r}}).then(e=>{this.table_modify(e),this._container.getNiceScroll().resize(),App.fullScreenProcesses.hide("sorting")})}):this.model.save({[s]:{[this.tableRow.panels_view.kanban]:r}}).then(e=>{this.dataSorted.splice(this.dataSorted.indexOf(s),1),this.dataSorted.splice(this.dataSorted.indexOf(d)+1,0,s),this.table_modify(e),this._container.getNiceScroll().resize(),App.fullScreenProcesses.hide("sorting")})):this.tableRow.with_order_field&&(App.fullScreenProcesses.show("sorting"),a(l).always(()=>{App.fullScreenProcesses.hide("sorting")}))}})}},i=function(){let e=this._content||t('<div class="pcTable-floatBlock">');if(e.each((e,t)=>{!this.tableRow.with_order_field&&!this.kanban||!this.control.editing||this.f.blockorder||this.f.blockedit||setTimeout(()=>{a.call(this,t)},1)}),e.empty(),this.__applyFilters(),this.dataSortedVisible.length||this.kanban)if(this.kanban){this._innerContainer.addClass("kanbanInnerContainer"),e.addClass("kanbanWrapper").empty(),e.css("grid-template-columns","1fr ".repeat(this.kanban.length));let a=0,i=this.kanban_html||this.f.kanban_html||null;if(this.kanban.forEach(n=>{let l=(this.tableRow.panels_view.panels_in_kanban||1)*(parseInt(this.tableRow.panels_view.width)+10)-10;n.$div=t('<div class="kanban"></div>').data("value",n[0]).width(l),a&&(a+=20),a+=l;let s=t('<div class="kanban-title">').text(n[1]).attr("data-value",n[0]);if(n.$div.append(s),this.tableRow.panels_view.kanban_colors&&this.tableRow.panels_view.kanban_colors[n[0]]&&s.css({"background-color":App.theme.getColor(this.tableRow.panels_view.kanban_colors[n[0]])}),this.tableRow.panels_view.kanban_html_type&&i){let e=t('<div class="kanban-html">');e.height(this.tableRow.panels_view.kanban_html_height),s.after(e),i[n[0]]&&e.html(i[n[0]])}let o=t('<div class="kanban-cards">');n.$div.append(o);let r=n[0];e.append(n.$div),this.dataSortedVisible.length?this.dataSortedVisible.forEach(e=>{(this.data[e][this.tableRow.panels_view.kanban].v||"")==r&&o.append(this._getRowCard(e))}):o.append('<div class="empty-kanban">'+App.translate("No data")+"</div>")}),"hide"===this.tableRow.panels_view.kanban_html_type){e.css("grid-template-columns","40px "+"1fr ".repeat(this.kanban.length)),e.css("margin-left","-60px");let a=t('<div class="kanban_left_buttons">').prependTo(e),i=t('<button class="btn btn-default btn-sm kanban_html_arrow"></button>');a.prepend(i),this.kanban_html?i.html('<i class="fa fa-arrow-up"></i>').attr("title",App.translate("Hide columns extra info")).on("click",()=>{this.kanban_html=null,this._refreshContentTable()}):i.html('<i class="fa fa-arrow-down"></i>').attr("title",App.translate("Show columns extra info")).on("click",()=>{this.model.getKanbanHtml||(this.model.getKanbanHtml=function(){return this.__ajax("post",{method:"getKanbanHtml"})}),this.model.getKanbanHtml().then(e=>{this.kanban_html=e.kanban_html,this._refreshContentTable()})})}e.width(a),this.tableWidth=a}else this.dataSortedVisible.forEach(t=>{let a=this._getRowCard(t);e.append(a)}),this.rowButtonsCalcWidth();else e.append('<div class="no-panels">'+App.translate("No data")+"</div>");return setTimeout(()=>{this._container.getNiceScroll().resize()}),e},n=function(){let e=this;this._sorting={},this._table=t("<table>").addClass(this.tableClass),this.notCorrectOrder&&this._table.addClass("no-correct-n-filtered"),this._popovers=t('<div class="popovers">'),1===this.fieldCategories.column.length&&e._container.addClass("no-fields");let a=this.scrollWrapper=this._container.append('<div class="pcTable-scrollwrapper">').find(".pcTable-scrollwrapper");a.append(this._createBeforeSpace()).append(this._createTableText()),this.isCreatorView&&a.append(this._refreshHiddenFieldsBlock()),this._paramsBlock=this._createParamsBlock(a);let i,n,l=t('<div class="pcTable-rowsWrapper">').appendTo(a);l.append(this._createRowsTitle(l)).append(this._createFiltersBlock()).append(()=>{if(this.tableRow.pagination&&"0/0"!==this.tableRow.pagination)return this._pagination()}).append(this._rowsButtons()).append(this._innerContainer),this._footersBlock=t(),this._content=this._refreshContentTable().appendTo(this._innerContainer),this.tableRow.panels_view.css&&this._container.prepend(t("<style>").text(this.tableRow.panels_view.css)),this._innerContainer.addClass("panelsView"),this.RightBottomPanel=t('<div id="right-bottom-panel">').appendTo(this._innerContainer),this._footersSubTable=this._createFootersSubtable(a),a.append(this._footersSubTable).append(this._popovers),this._seeCalcucatedValData(),this._seeSelectPreview(),this._clickstoCopyMe(),"cycles"==e.tableRow.type&&this._content.on("dblclick",".panelsView-card",(function(){let a=t(this).data("id");e.model.dblClick(a)})),this._content.on("contextmenu",".panelsView-card",(function(e){return!1})),this._content.on("contextmenu",".panelsView-card td",(function(a){if(i&&i.removeClass("selected"),"click"===a.type&&a.originalEvent&&a.originalEvent.path&&t(a.originalEvent.path[0]).is("button"))return;let n=t(this);if(i&&i.get(0)===n.get(0)&&e.selectedCells.selectPanel)i=null;else{let t=e.data[n.closest(".panelsView-card").data("id")],a=n.data("name");n.data("panel")&&n.data("panel").isAttached()&&e.selectedCells.selectPanel===n.data("panel")?n.data("panel",null):(n.data("panel",e.selectedCells.selectPanel=e.getSelectPanel.call(e,e.fields[a],t,n)),i=n.addClass("selected"))}return t("body").trigger("_click"),!1})),this._content.on("click",".panelsView-card td",(function(e){if(i&&i.removeClass("selected"),e.originalEvent&&e.originalEvent.path&&t(e.originalEvent.path[0]).is("button"))return;let a=t(this);i=i&&i.get(0)===a.get(0)?null:a.addClass("selected")})),this._content.on("click",".panelsView-card",(function(e){if(e.originalEvent&&e.originalEvent.path&&!t(e.originalEvent.path[0]).is("button, .fa")){let e=t(this);if(e.is(".cell-button"))return;n&&n.get(0)===e.get(0)?(e.removeClass("selected"),n=null):(n&&n.removeClass("selected"),n=e.addClass("selected"))}})),this.isCreatorView&&this._hideHell_storage.checkIssetFields.call(this)},l=function(e,a,i,n){if(e&&e.is(".panelsView-card")){let e=!1;i&&n&&Object.keys(i).some(t=>{if(null!==i[t]&&"object"==typeof i[t]){if(i[t].changed)return e=!0,!0;if(!Object.equals(i[t],a[t])&&t in this.fields&&"listRow"!==this.fields[t].type)return e=!0,!0}else if(i[t]!=a[t])return e=!0,!0;a[t]=i[t]}),t.extend(a,i),n&&!e||this._getRowCard(a.id)}};App.pcTableMain.prototype._renderTablePanelView=function(){if(this.loadFilters(),this.model.addExtraData({panelsView:!0}),this._renderTable=n.bind(this),this._getRowCard=e.bind(this),this._refreshHead=()=>{},this.Scroll=()=>({reloadScrollHead:()=>{},insertToDOM:()=>{this._refreshContentTable()},emptyCache:()=>{}}),this.kanban){let e,a,i,n,l=this._container,s=!1;const o=()=>{a=a||this._container.find(".kanbanWrapper.pcTable-floatBlock");let e=a.offset();if(e.top<0){if(!i){let l={left:e.left+this._innerContainer.scrollLeft(),"grid-template-columns":a.css("grid-template-columns"),width:parseInt(this._innerContainer.width())+parseInt(this._innerContainer.css("padding-left"))};i=t('<div class="kanbanWrapper pcTable-floatBlock cln">').css(l),a.find(".kanban_left_buttons").length&&i.append("<div>"),t(".kanban").each((function(){let e=t(this),a=t("<div class='kanban'>").width(e.width()).append(e.find(".kanban-title").clone());i.append(a)}));let s=this;n=t('<button class="scroll-top-button"><i class="fa fa-arrow-up"></i></button>').on("click",(function(){s._container.scrollTop(s._container.find(".pcTable-rowsWrapper").offset().top-s.scrollWrapper.offset().top)}))}s||(s=!0,this._innerContainer.append(i),this.RightBottomPanel.append(n),i.scrollLeft(this._innerContainer.scrollLeft()))}else s&&(s=!1,i.detach(),n.detach())};let r;l.on("scroll",()=>{clearTimeout(e),e=setTimeout(()=>{o()},50)}),this._innerContainer.on("scroll",()=>{clearTimeout(r),r=setTimeout(()=>{i&&i.scrollLeft(this._innerContainer.scrollLeft())},50)}),this.rowButtonsCalcWidth=function(){this.__$rowsButtons&&(this.tableWidth<this.tableRow.panels_view.width?this.__$rowsButtons.width(this.tableRow.panels_view.width):this.tableWidth<this._innerContainer.width()?this.__$rowsButtons.width(this.tableWidth):this.isMobile||this.__$rowsButtons.width(this._innerContainer.width()))}}else this.rowButtonsCalcWidth=function(){this.__$rowsButtons.css("minWidth",this.tableRow.panels_view.width),this.tableWidth=0,this._innerContainer.find(".panelsView-card").toArray().some(e=>{let a=t(e),i=a.offset().left+a.width();if(!(i>this.tableWidth))return!0;this.tableWidth=i}),this.tableWidth-=this._innerContainer.offset().left+50,this.isMobile||(this.tableWidth<this.tableRow.panels_view.width?this.__$rowsButtons.width(this.tableRow.panels_view.width):this.__$rowsButtons.width(this.tableWidth))};this.refreshRow=l.bind(this),this._refreshContentTable=i.bind(this),this._getItemBytd=function(e){return this.data[e.closest(".panelsView-card").data("id")]||this.data_params},this._getFieldBytd=function(e){return 0===e.closest(".panelsView-card").length?this.fields[e.data("field")]:this.fields[e.data("name")]}}}(),t.extend(App.pcTableMain.prototype,{_renderRotatedView:function(){let e=this;e.viewType="rotated",this._innerContainer.on("click","td.id",(function(){let a=t(this);a.attr("aria-describedby")||setTimeout(()=>{e.workerIconsPopover(a,a.find(".rowName").text())})})),t.extend(this,{isRotatedView:!0,rowButtonsCalcWidth:function(){this.isMobile||(this.width-80>this._table.width()?this.__$rowsButtons.width(this._table.width()-80):this.__$rowsButtons.width(this.width-80))},setInnerContainerWidth:function(){this._innerContainer.width("auto")},_addCellId:function(e,a){let i=t('<td class="id"></td>'),n=t('<span class="rowName"></span>').appendTo(i);return this.mainFieldName&&"id"!==this.mainFieldName&&e[this.mainFieldName]&&e[this.mainFieldName].v?n.html(this.fields[this.mainFieldName].getCellText(e[this.mainFieldName].v,n,e)):this._isDisplayngIdEnabled()&&(n.text(e.id),i.addClass("small-rotated-id"),this._isDisplayngIdEnabled(!0)||n.addClass("id-hidden")),i.appendTo(a),this.row_actions_icons_add(i),!0===e.$checked&&this.row_actions_check(e,!0),i},_createHeadCellId:function(){let e=this,a=t('<th class="id"></th>'),i=t('<div class="pcTable-filters"></div>');if(!e.isMobile){let t=this._getIdFilterButton();i.append(t).append(" ").append(e._idCheckButton)}return a.append(this._checkStatusBar),a.append(i),e._idCheckButton.off().on("click",(function(){if(e._idCheckButton.find("span").is(".fa-check"))e.row_actions_uncheck_all.call(e),e.__checkedRows=[];else for(let t=0;t<e.dataSortedVisible.length;t++){let a=e.dataSortedVisible[t],i="object"!=typeof a?e._getItemById(a):a.row;i&&!i.$checked&&(e.row_actions_check.call(e,i,!0),e.__checkedRows.push(i.id))}e._headCellIdButtonsState()})),this._refreshCheckedStatus(),a},Scroll:()=>({reloadScrollHead:()=>{},insertToDOM:function(t,a,i){this.setHtml(e.dataSortedVisible,0,0,i)},emptyCache:()=>{},setHtml:function(t,a,i,n){e._content.find(".editing").each((function(t){e._removeEditing.call(e,t)}));let l=e._content.empty().get(0);if(0===e.dataSorted.length)l.appendChild(e._createNoDataRow().get(0));else if(0===e.dataSortedVisible.length)l.appendChild(e._createNoDataRow(App.translate("No rows are selected by the filtering conditions")).get(0));else for(let a in t){let i=t[a];if("object"!=typeof i){let t=e.data[i];t.$tr&&!n||e._createRow.call(e,t),t.$tr.data("item",t),l.appendChild(t.$tr.get(0))}else l.appendChild(e._createTreeFolderRow.call(e,i).get(0))}}})});const a=e.model.loadPage;e.model.loadPage=function(){let t=a.call(this,...arguments);return t.then(()=>{e.rowButtonsCalcWidth()}),t},setTimeout(()=>{e._content.on("refreshed",()=>{e.setInnerContainerWidth(),e.rowButtonsCalcWidth()})})}}),App.pcTableMain.prototype.switchRestoreView=function(){this.isRestoreView?App.windowReloadWithHash(this.model):(this.isTreeView&&(this.isTreeViewRestore=!0,this.dataSorted=[],this.dataSortedVisible=[],this.data={},this.isTreeView=!1,this.treeApply=()=>{}),this.isRestoreView=!this.isRestoreView,this._rowsButtons(),this.model.refresh(void 0,void 0,!0),this.model.setLoadedTableData(this.data))},t.extend(App.pcTableMain.prototype,{setWidthes:function(){"use strict";let a;this.isMobile?(a=5,this.switchContainerNideScroll(!1)):(a=t("body>.page_content:first").is(".tree-minifyed")?5:300,this.switchContainerNideScroll(!0)),this.width=t("body").width()-a,this._container.width(this.width),this._rerendParamsblock(),this.isCreatorView&&this._refreshHiddenFieldsBlock(),this._rerendFiltersBlock(),this._refreshHead(),this._rerendBottomFoolers(),this.rowButtonsCalcWidth(),this._container.width()<this._table.width()&&this._addHorizontalDraggable(),this.setInnerContainerWidth(),this._container.height(e.innerHeight-this._container.offset().top-10)},setInnerContainerWidth:function(){this.isMobile||t("body").is(".table-in-notification"),this._innerContainer.width("auto")},addInnerContainerScroll:function(){if(this._innerContainer.width()<this._innerContainer.find(">table.pcTable-table, >div:not(#right-bottom-panel)").width()){const e=()=>{let e=this._innerContainer.offset().top-this._container.offset().top-3,a=this._innerContainer.innerHeight()+parseInt(t("#table").data("pctable")._innerContainer.css("paddingBottom")),i=this._container.innerHeight();if(this._innerContainerPS){t(".ps__rail-x").appendTo(this._container),t(".ps__rail-y").appendTo(this._container);let n=this._innerContainerPS.scrollbarXBottom;if(this._innerContainerPS.scrollbarXBottom=0,e<i&&e+a>i){let t=e+this._innerContainer.innerHeight();t>i&&(this._innerContainerPS.scrollbarXBottom=t-i)}n!=this._innerContainerPS.scrollbarXBottom&&this._innerContainerPS.update()}};if(!this._innerContainerPS){let t;this._innerContainerPS=new PerfectScrollbar(this._innerContainer.get(0),{useBothWheelAxes:!1,scrollbarYActive:!1,scrollbarXActive:!0}),this._container.on("scroll.scroller",()=>{t&&clearTimeout(t),t=setTimeout(e,30)}),new ResizeObserver(e).observe(this.scrollWrapper.get(0))}setTimeout(e,500)}else this._innerContainerPS&&(this._container.off("scroll.scroller"),this._innerContainerPS.destroy(),this._innerContainerPS=null)},initForPanel:function(e){t.extend(!0,this,e),this.refreshArraysFieldCategories(!1);let a={};this.__checkedRows=[],this.rows.map((function(e){this.dataSorted.push(e.id),this.dataSortedVisible.push(e.id),a[e.id]=e,a[e.id].$checked=-1!==this.__checkedRows.indexOf(e.id)}),this),this.data=a,this.model.setLoadedTableData(this.data)},closeCallbacks:[],closeCallbackAdd:function(e,t,a){const i=()=>{this.closeCallbacks.push({type:t,func:e})};a?setTimeout(()=>{i()},a):i()},closeCallbackRemove:function(e){this.closeCallbacks.forEach((t,a)=>{t.type===e&&this.closeCallbacks.splice(a,1)})},isObjectOpened:function(){return this.domObject.is(":visible")},_init:function(){let a=this;this._setBrowserTitle(),t(document).on({dragover:function(){return!1},drop:function(){return!1}}),this.domObject=this._container.addClass(this.contanerClass).addClass("pcTable-type-"+this.tableRow.type),t("#totumTableStyle").length||t("head").append(t('<style id="totumTableStyle">').text(App.lang.css.table)),this.isCreatorView&&this._container.addClass("pcTable-creatorView");let i=t("#nav-top-line");"tmp"===this.tableRow.type&&this.isCreatorView&&(i.text(App.translate("Attention, please - this is a temporary table")),i.addClass("pcTable-type-"+this.tableRow.type)),this._innerContainer=t('<div class="innerContainer">'),this.__formatFunctions.interlace.call(this,!0);let n=!1;const l=function(e){if(!t(e.target).closest("#filterHand").length&&!n){n=!0;let t=a.closeCallbacks.length;a.closeCallbacks.forEach((function(t){"function"==typeof t?t(e):t.func(e)})),a.closeCallbacks.splice(0,t),n=!1}};t("body").on("keyup",(function(e){27===e.which&&(a._container.trigger("escPressed"),l(e))})),t("body").on("keydown",(function(e){27===e.which&&(a.closeCallbacks.length||a.selectedCells.isAnySelectedCells()&&(t("body .modal").length||t("body .editing").length||a.selectedCells.empty()))})),t("body").on("click _click",l),a._container.on("scroll",l),a._innerContainer.on("scroll",l),this.isCreatorView?this._container.on("click contextmenu","th:not(.panelsView-card-item,.id)",(function(e){if(e.originalEvent&&("BUTTON"===e.originalEvent.target.nodeName||e.originalEvent.target.parentElement&&"BUTTON"===e.originalEvent.target.parentElement.nodeName));else{let e=t(this);e.attr("aria-describedby")||setTimeout(()=>{a.creatorIconsPopover(e)})}})):this._container.on("click contextmenu","th:not(.panelsView-card-item)",(function(e){if(e.originalEvent&&"BUTTON"===e.originalEvent.target.nodeName||"BUTTON"===e.originalEvent.target.parentElement.nodeName);else{let e=t(this);e.attr("aria-describedby")||setTimeout(()=>{a.workerIconsPopover(e)})}})),a._container.on("contextmenu",(function(e){let a=t(e.target);if(l(e),!a.closest(".popover").length&&!a.closest(".edit-row-panel").length)return!1})),this._container.append(this._innerContainer),this.saveFilterAndPage(),this.initRowsData();let s=e.innerWidth,o=e.innerHeight;if(this.isMobile)t(e).on("resize",(function(){if(!1!==s)if(Math.abs(s-e.innerWidth)>20){s=!1;let e=t('<button class="btn btn-lg">').text(App.translate("Reload")).on("click",()=>{App.windowReloadWithHash(a.model)}).wrap('<div id="ttm--mobile-resize-reload">').parent();t("body").html(e)}else s=e.innerWidth}));else{let i;t(e).resize((function(){i&&clearTimeout(i),i=setTimeout((function(){(Math.abs(s-e.innerWidth)>20||Math.abs(o-e.innerHeight)>20)&&a.setWidthes(),s=e.innerWidth,o=e.innerHeight}),500)}))}},saveFilterAndPage:function(){if("cycles"===this.tableRow.type)if(this.filtersString||this.PageData){let t;sessionStorage.setItem("cycles_filter",JSON.stringify({id:this.tableRow.id,filter:this.filtersString,offset:this.PageData?this.PageData.offset:null,onPage:this.PageData?this.PageData.onPage:null})),(t=e.location.pathname.match(/^\/Table\/(\d+)\/$/))?sessionStorage.setItem("cycles_table_anchor",t[1]):sessionStorage.removeItem("cycles_table_anchor")}else sessionStorage.removeItem("cycles_filter"),sessionStorage.removeItem("cycles_table_anchor")},refreshArraysFieldCategories:function(){"use strict";let a=this;a.hidden_fields=a.hidden_fields||{},t.each(a.hidden_fields,(function(e,i){a.hidden_fields[e]=t.extend({},r,o[i.type],i),a.hidden_fields[e].pcTable=a,a.hidden_fields[e].isHiddenField=!0})),a.mainFieldName="id",a.fieldCategories={},["param","column","filter","footer","panel_fields"].forEach((function(e){a.fieldCategories[e]=[]}));let i=[];try{i=JSON.parse(decodeURIComponent(e.location.hash.substring(1))||"[]"),i=i&&i.wc?i.wc:[]}catch(e){}this.withTopButtons=!0,-1!==i.indexOf("tb")&&(this.withTopButtons=!1),e.top!==e&&(-1!==i.indexOf("hdf")?this.hideWindowDots=!1:-1!==i.indexOf("hdt")&&(this.hideWindowDots=!0));let n=!1;const l=function(e,l){if(l.pcTable=a,"button"==(l=o[l.type]?t.extend({},r,o[l.type],l):t.extend({},r,l)).type&&l.buttonActiveOnInsert&&(l.insertable=!0),l.showInWebOtherOrd&&(l._ord=l.ord,l.ord=l.showInWebOtherOrd,n=!0),l.showInWebOtherPlacement&&(l._category=l.category,l.category=l.showInWebOtherPlacement,n=!0),a.fields[e]=l,-1===i.indexOf(l.category))if(l.showInWeb)if("column"===l.category)if("n"!==l.name&&a.fieldCategories.panel_fields.push(l),"tree"===l.name&&"column"===l.category&&l.treeViewType&&!t.cookie("ttm__commonTableView"))a.isTreeView=!0,a.fieldCategories[l.category].unshift(l);else{if(!a.isCreatorView&&l.isCyclesTabButton())return;a.fieldCategories[l.category].push(l)}else a.fieldCategories[l.category].push(l);else l.name&&(a.hidden_fields[l.name]=l)};l("n",{type:"n"});let s=t.extend({},this.fields);delete s.n,t.each(s,l),n&&["param","column","filter","footer","panel_fields"].forEach((function(e){a.fieldCategories[e].sort((function(e,t){return e.ord-t.ord}))})),a.notTableFooterFields=[],a.fieldCategories.footer.forEach((function(e){e.column||a.notTableFooterFields.push(e)})),this.tableRow.main_field&&this.fields[this.tableRow.main_field]&&(a.mainFieldName=this.tableRow.main_field)},workerIconsPopover:async function(e,a){if(a=a||this.__getCellTitle(this.fields[e.data("field")]),!e.attr("aria-describedby")&&a){let i=t('<div style="width:200px" class="creator-icons">'),n=this.fields[e.data("field")].unitType?", "+this.fields[e.data("field")].unitType:"";i.append(t('<div class="full-title">').text((a||this.fields[e.data("field")].title)+n));let l="top";e.get(0).getBoundingClientRect().top<100&&(l="bottom"),App.popNotify({isParams:!0,$text:i,element:e,trigger:"manual",placement:l,container:t("body")}),this.closeCallbacks.push((function(){e&&e.length&&e.popover("destroy")}))}},creatorIconsPopover:async function(e){if(!e.attr("aria-describedby")){let a=t('<div style="width:200px" class="creator-icons">'),i=this.fields[e.data("field")].unitType?", "+this.fields[e.data("field")].unitType:"";a.append(t('<div class="full-title">').text(this.__getCellTitle(this.fields[e.data("field")])+i)),e.find("i:not(.fa-caret-down):not(.fa-info)").each((i,n)=>{if(["fa-star","fa-star-o","fa-cogs"].some(e=>t(n).hasClass(e)))return;let l=t("<div>").append(n.outerHTML);if(0===i){l.append(" ").append(t('<span class="name"></span>').text(e.data("field"))),t('<button class="btn btn-sm btn-default copy-me" title="'+App.translate("Copy")+' "><i class="fa fa-copy"></i></button>').on("click",(function(){App.copyMe(e.data("field"));let a=t(this);return a.width(a.width()),a.html('<i class="fa fa-cog"></i>'),setTimeout((function(){a.html('<i class="fa fa-copy"></i>')}),1e3),!1})).appendTo(l)}n.title&&l.append(" "+n.title),a.append(l)});let n,l=[],s=this.fields[e.closest("th").data("field")];const o=async function(){return new Promise((e,t)=>{App.getPcTableById(2).then((function(t){e(t.fields.data_src.jsonFields)}))})};let r={code:App.translate("Code"),codeAction:App.translate("ActionShort"),codeSelect:App.translate("SelectShort"),format:App.translate("FormatShort")};"filter"===s.category&&delete r.codeAction;let d=Object.keys(r);for(let e=0;e<d.length;e++){let a=d[e],i="format"===a?"formatCode":"";(i?s[i]:s[a])?l.push(t('<button class="btn btn-default btn-xxs" data-action="'+a+'">'+r[a]+"</button>")):(n||(n=await o()),-1!==n.fieldListParams[s.type].indexOf(a)&&l.push(t('<button class="btn btn-default btn-xxs offed" data-action="'+a+'">'+r[a]+"</button>")))}if(l.length){let i=t('<div class="buttons">');l.forEach(e=>{i.append(e)}),i.appendTo(a);let r=this;i.on("click","button",(async function(){let a=t(this);n||(n=await o()),r.editFieldCode(s.name,a.data("action"),n).then(t=>{if(t){switch(s.category){case"param":r._rerendParamsblock();break;case"footer":s.column?r._rerenderColumnsFooter():r._rerendBottomFoolers();break;case"filter":r._rerendFiltersBlock();break;case"column":r._refreshHead()}setTimeout(()=>{App.blink(s.$th.find(".creator-icons i"),3,"green","color")},100)}else App.blink(e.find("i"),3,"green","color")},()=>{})}))}let c="top";e.get(0).getBoundingClientRect().top<100&&(c="bottom"),App.popNotify({isParams:!0,$text:a,element:e,trigger:"manual",placement:c,container:t("body")}),this.closeCallbacks.push((function(){e&&e.length&&e.popover("destroy")}))}},editTableCode:function(e,t){return new Promise((a,i)=>{let n=this;App.getPcTableById(1).then((function(l){l.model.checkEditRow({id:n.tableRow.id}).then((function(s){let o='<span style="">'+l.fields[e].title+"</span>";App.totumCodeEdit(s.row[e].v,o,{cycle_id:n.tableRow.cycle_id,table:n.tableRow.name,codeType:t},[],!1).then(s=>{l.model.save({[n.tableRow.id]:{[e]:s.code}}).then(()=>{n.tableRow[e]=s.code,"format"===t&&n.model.refresh(),a()}).fail(i)},(function(e){i()}))}))}))})},editFieldCode:function(e,t,a){return new Promise((i,n)=>{let l=this.fields[e],s=a.fieldListParams[l.type],o=this;App.getPcTableById(2).then((function(e){e.model.checkEditRow({id:l.id}).then((function(r){let d=[],c=[];switch(t){case"code":c=["codeOnlyInAdd"];break;case"codeAction":c=["CodeActionOnAdd","CodeActionOnChange","CodeActionOnDelete","CodeActionOnClick"];break;case"codeSelect":c=["codeSelectIndividual","multiple"]}c&&c.forEach(e=>{if(-1!==s.indexOf(e)){let t=a.fieldSettings[e];if(t.categories&&-1===t.categories.indexOf(l.category))return!1;d.push([e,t.title,!!r.row.data_src.v[e]&&r.row.data_src.v[e].Val])}});let p='<span style="">'+a.fieldSettings[t].title+"</span> "+l.name;App.totumCodeEdit(r.row.data_src.v[t].Val,p,{cycle_id:l.pcTable.tableRow.cycle_id,table:l.pcTable.tableRow.name,codeType:t},d,"codeSelect"!==t&&r.row.data_src.v[t]&&r.row.data_src.v[t].isOn,!(r.row.data_src.v[t]&&r.row.data_src.v[t].isOn)).then(a=>{e.model.checkEditRow({id:l.id}).then((function(s){let r=s.row.data_src.v;r[t].Val=a.code;let d=!1;r[t].isOn?a.switchoff&&(r[t].isOn=!1,d=!0):(r[t].isOn=!0,d=!0),Object.keys(a.checkboxes).forEach(e=>{r[e]&&r[e].Val===a.checkboxes[e]||(r[e]=r[e]||{},r[e].Val=a.checkboxes[e],r[e].isOn=a.checkboxes[e],d=!0)}),e.model.save({[l.id]:{data_src:r}}).then(()=>{Object.keys(a.checkboxes).forEach(e=>{o.fields[l.name][e]=a.checkboxes[e]}),"format"===t?(a.switchoff?o.fields[l.name].formatCode=!1:o.fields[l.name].formatCode=!0,o.model.refresh()):"codeSelect"===t?App.windowReloadWithHash(o.model):(a.switchoff?o.fields[l.name][t]=!1:o.fields[l.name][t]=!0,o.model.refresh(null,"recalculate")),i(d)}).fail(n)})).fail(n)},(function(e){n()}))}))}))})},render:function(a){let i=this;if(this.loadVisibleFields(this.f&&this.f.fieldhide?this.f.fieldhide:void 0),"panels"===this.viewType)if(this.isMobile){let a,i="panelSwitcher";"0"!==t.cookie(i)&&("calcs"===this.tableRow.type?(i+=this.tableRow.id,a=e.location.pathname.replace(/\d+\/\d+\/?$/,"")):a=e.location.pathname,t.cookie(i,"0",{path:a}),App.windowReloadWithHash(this.model))}else this._renderTablePanelView();else this.isTreeView||!this.tableRow.rotated_view||t.cookie("ttm__commonTableView")||this._renderRotatedView();if(this.ScrollClasterized=this.Scroll(),this._renderTable(),this._sorting.addSortable&&this._sorting.addSortable(this),this._addSelectable(),this._addEditable(),this.row_actions_add(),this.__addFilterable(),this._refreshHead(),i.checkIsUpdated>0){let e=2e3*parseInt(i.checkIsUpdated);setTimeout((function(){i.checkTableIsChanged.call(i,e)}),e)}this.refresh(),this.setWidthes(),this.__applyFilters();let n=JSON.parse(decodeURIComponent(e.location.hash.substring(1))||"[]");n&&n.pointing&&(this.startPointing=n.pointing),this.selectedCells.applyPointing(),a&&(this.isMobile?i._addInsertWithPanel(a):i._addInsert(a))},reloaded:function(){let e=t("#refresh-notify");e.length&&(e.closest(".alert").remove(),this.checkTableIsChanged(2e3*parseInt(this.checkIsUpdated))),this._insertRow&&this._createInsertRow(this._insertRow)},showRefreshButton(e){if(!this.checkTableIsChangedObject)return;if(this.checkTableIsChangedObject.abort(),this.checkTableIsChangedObject.changed)return;this.checkTableIsChangedObject.changed=!0,t.notify({message:'<div id="refresh-notify"><span>'+App.translate("The table was changed by the user <b>%s</b> at <b>%s</b>",[e.username,App.dateFormats.covert(e.dt,"YY-MM-DD HH:mm",App.lang.timeDateFormatNoYear)])+'</span> <button class="btn btn-warning btn-sm" style="margin-right: 20px;">'+App.translate("Refresh")+"</button></div>"},{type:"warning",allow_dismiss:!1,delay:0}).$ele.find("#refresh-notify button").on("click",()=>{delete this.checkTableIsChangedObject.changed;let e,t=void 0;this.PageData&&(0===this.PageData.offset?t="page":this.PageData.offset>=Math.ceil(this.PageData.allCount/this.PageData.onPage)*this.PageData.onPage&&(t=Object.keys(this.data).length===this.PageData.onPage?-1:"page")),e=t?e=>{this.applyPage(e.chdata,e.allCount,-1===t?e.allCount-this.PageData.onPage:void 0),delete e.chdata.rows,this.table_modify(e),this.reloaded()}:e=>{this.table_modify(e),this.reloaded()},this.model.refresh(e,void 0,t,!!t)})},checkTableIsChanged:function(){this.checkTableIsChangedObject||(this.checkTableIsChangedObject={abort:()=>{this.checkTableIsChangedObject.jqXHR&&this.checkTableIsChangedObject.jqXHR.abort&&this.checkTableIsChangedObject.jqXHR.abort(),this.checkTableIsChangedObject.aborted=!0}},document.addEventListener("visibilitychange",()=>{if(!this.checkTableIsChangedObject.changed)switch(document.visibilityState){case"hidden":this.checkTableIsChangedObject.abort();break;case"visible":this.checkTableIsChanged()}})),this.checkTableIsChangedObject.abort(),delete this.checkTableIsChangedObject.aborted,this.model.checkTableIsChanged(this.checkTableIsChangedObject).then(e=>{if(e.no||this.model.tableData.updated.code===e.code)this.checkTableIsChanged();else{let t=()=>{this.model.tableData.updated.code===e.code?this.checkTableIsChanged():this.showRefreshButton(e)};this.model.doAfterProcesses((function(){setTimeout(t,200)}))}})},_getRowTitleByMainField:function(e,a){let i="";if(e.id){let a=this.mainFieldName;e[a]?void 0!==e[a].v_?"array"==typeof e[a].v_?e[a].v_.forEach((function(n,l){let s=t("<span>").text(this.fields[a].getElementString(e[a].v?e[a].v[l]:null,n));n[1]&&s.addClass("deleted_value"),i=s.html()})):i=t("<div>").text(this.fields[a].getElementString(e[a].v,e[a].v_)).html():void 0!==e[a].v&&(i=t("<div>").text(e[a].v).html()):i="id: "+e.id}return a&&i&&(i=a.replace("%s",i)),i},_getFieldbyName:function(e){return this.fields[e]},_getColumnIndexByTd:function(e,t){return(t=t||e.closest("tr")).find("td").index(e)},_fieldByTd:function(e,t){let a=this._getColumnIndexByTd(e,t);return this.fieldCategories.visibleColumns[a-1]},_getRowIndexById:function(e){let t=this;for(let a in t.data)if(t.data[a].id==e)return a;return null},_getFieldBytd:function(e){return e.closest("tr").is(".DataRow")?this.fieldCategories.visibleColumns[e.closest("tr").find(e.prop("tagName")).index(e)-1]:this.fields[e.data("field")]},_isParamsArea:function(e){return e.closest("table").is(".pcTable-paramsTable")},_isFootersArea:function(e){return e.closest("tbody").is(".pcTable-footers")},_getItemBytd:function(e){let t=e.closest("tr");return this._getItemByTr(t)},_getItemByTr:function(e){return e.is(".DataRow")?this.data[e.data("pctableitemid")]:this.data_params},_getItemById:function(e){return this.data[e]},_deleteItemById:function(e){let t=this._getItemById(e);t&&t.$tr&&t.$tr.remove(),this.openedPanels[e]&&this.openedPanels[e].close(),["dataSorted","dataSortedVisible","__checkedRows"].forEach((function(t){let a;this[t].forEach((t,i)=>{(t.toString()===e.toString()||"object"==typeof t&&t.row&&t.row.id.toString()===e.toString())&&(a=i)}),void 0!==a&&this[t].splice(a,1)}),this),this.isTreeView&&this.treeDeletingRow(e),delete this.data[e]},_getTdByFieldName:function(e,t){let a=0;return this.fieldCategories.visibleColumns.every((function(t,i){return e!=t.name||(a=i,!1)})),this._getTdByColumnIndex(t,a+1)},_getTdByColumnIndex:function(e,t){return e.find("td:eq("+t+")")},refresh:function(){this._refreshTitle(),this._refreshParamsBlock(),this._refreshFiltersBlock(this.data_params),this._refreshFootersBlock(),this._refreshContentTable()},initRowsData:function(){if(this.__checkedRows=[],this.dataSorted=[],this.dataSortedVisible=[],this.ScrollClasterized&&this.ScrollClasterized.emptyCache(),this.isTreeView)this.tree.forEach((e,t)=>{this.getTreeBranch(e,t)}),this.rows&&this._treeApplyRows(this.rows),setTimeout(()=>{this.treeApply()}),this.model.setLoadedTableData(this.data);else{let e={};this.rows&&this.rows.map((function(t){this.dataSorted.push(t.id),this.dataSortedVisible.push(t.id),e[t.id]=t,e[t.id].$checked=-1!==this.__checkedRows.indexOf(t.id)}),this),this.data=e,this.model.setLoadedTableData(this.data,this.PageData?this.PageData.offset:void 0,this.PageData?this.PageData.onPage:void 0)}}})}(window,jQuery),App.models||(App.models={}),App.models.table=function(e,t,a){let i,n,l,s,o={},r=0,d=null;const c=function(e){let t={};return Object.keys(e).forEach((function(a){/^\$/.test(a)||("id"===a?t[a]=e[a]:null!==e[a]&&"object"==typeof e[a]&&-1!==Object.keys(e[a]).indexOf("v")?t[a]=e[a].v:t[a]=e[a])})),t};return a=a||{},{getUri:function(){return this.url},isCreatorView:function(){return"isCreatorView"in s?s.isCreatorView:!(!$("#isCreator").length||!localStorage.getItem("notCreator"))},setLoadedTableData:function(e,t,a){i=e,n=t,l=a},addExtraData:function(e){"use strict";a=$.extend(!0,{},a,e)},tableData:t,url:e,doAfterProcesses:function(e){let t=this;setTimeout((function(){t.getDefferedProcess().then(e)}),170)},getDefferedProcess:function(){return new Promise((e,t)=>{Promise.all(Object.values(o)).then(()=>{e()})})},showLinks:function(e){App.showLInks(e.links,s.model),delete e.links},shoInterfaceDatas:function(e){App.showDatas.call(s.model,e.interfaceDatas,null,window),delete e.interfaceDatas},showPanels:function(e){e.showPanels&&(App.showPanels(e.showPanels,s),delete e.showPanels)},addPcTable:function(e){s=e},getPcTable:function(){return s},getSessHash:function(){return t.sess_hash},__ajax:function(e,c,p,h,f){"use strict";let u=this.url,m=!1,b=!0;!1===c.async&&(b=!1,delete c.async);let g=$.Deferred();f=f||{};let w=!1,v=!1,_=$.extend(!0,{},c,{tableData:t,ajax:!0},a,f);"checkTableIsChanged"===c.method||"checkForNotifications"===c.method?"checkForNotifications"!==c.method&&(_=$.extend({},c,{code:t.updated.code,ajax:!0},a),t.sess_hash&&(_.tableData={sess_hash:t.sess_hash})):(m=!0,h||setTimeout((function(){w||(App.fullScreenProcesses.showCog(),v=!0)}),1e3)),void 0!==_.data&&"object"==typeof _.data&&(_.data=JSON.stringify(_.data)),i&&!_.ids&&(_.ids=JSON.stringify(Object.keys(i))),"offset"in c||void 0===n||(_.offset=n,_.onPage=l),s&&s.isRestoreView&&(_.restoreView=!0);let y=this,x=function(e){let t=App.lang.modelMethods,a=$("#table").data("pctable");if(a){if(e.LOGS&&(a.LOGS||(a.LOGS={}),a.LOGS=$.extend(a.LOGS,e.LOGS)),e.FullLOGS){a.FullLOGS||(a.FullLOGS=[]);let i={text:t[_.method]||_.method};if(i.children=e.FullLOGS,e.FullLOGS.length){a.FullLOGS.push(i);let e=$.cookie("pcTableLogs")||"[]";e=JSON.parse(e),App.blink(a.LogButton,8,e.length?"#fff":"red")}}if(e.FieldLOGS&&Object.keys(e.FieldLOGS).length&&(a.FieldLOGS=a.FieldLOGS||[],a.FieldLOGS.push({data:e.FieldLOGS,name:t[_.method]||_.method})),"loadPage"!==_.method&&a.PageData&&void 0!==e.allCount){let t=!1;"offset"in e&&null!==e.offset&&a.PageData.offset!==e.offset&&(t=!0,a.PageData.offset=e.offset),"allCount"in e&&null!==e.allCount&&a.PageData.allCount!==e.allCount&&(t=!0,a.tableRow.pagination.match(/desc\s*$/)&&(a.PageData.offset+=e.allCount-a.PageData.allCount),a.PageData.allCount=e.allCount,a.PageData.allCountChanged=!0),t&&a.PageData.$block.empty().append(a._paginationCreateBlock.call(a))}}if(e.tableChanged&&s.showRefreshButton(e.tableChanged),e.error){var i=$("<div>").html(e.error.replace(/\[\[(.*?)\]\]/g,"<b>$1</b>"));if(e.log){let t=$('<button class="btn btn-xxs btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> c</i></button>');t.on("click",(function(){BootstrapDialog.show({message:$('<pre style="max-height: '+($("body").height()-200)+'px; overflow: scroll">').css("font-size","11px").text(JSON.stringify(e.log,null,1)),type:BootstrapDialog.TYPE_DANGER,title:App.translate("Calculate log"),buttons:[{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],draggable:!0,onshown:function(e){e.$modalContent.position({of:window})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:1200})}})})),i.append(" "),i.append(t)}App.notify(i),g.reject(e)}else e.reload?window.location.href=window.location.href:(e.links&&e.links.length>0&&y.showLinks(e),e.interfaceDatas&&e.interfaceDatas.length>0&&y.shoInterfaceDatas(e),y.showPanels(e)),g.resolve(e),setTimeout(()=>{e.chdata&&e.updated&&s.editPanels&&s.editPanels.forEach(e=>{e.refresh()})},10)},k=function(e){let t,a;e&&200===e.status?e.responseJSON&&e.responseJSON.error?t=e.responseJSON.error:(t=$("<div>"+App.translate("Operation execution error")+"  </div>"),s&&s.isCreatorView&&(t.append('<button class="btn danger-backg btn-xs" data-toggle="collapse" data-target="#notify-texh"><i class="fa fa-angle-down"></i><i class="fa fa-angle-up"></i></button>'),t.append($('<div id="notify-texh" class="collapse">').append($("<code>").text(e.responseText))))):!p&&e&&"abort"!=e.statusText&&"error"!=e.statusText?(t=e.statusText,a=200):p&&p.jqXHR&&"abort"!==p.jqXHR.statusText&&(t=App.translate("No server connection"),a=200),t&&-1===["checkTableIsChanged","checkForNotifications"].indexOf(c.method)&&(a?setTimeout((function(){App.notify(t)}),a):App.notify(t),e.responseText),g.reject(e)},C=function(){{if((new Date).getTime()-d<150)return void setTimeout(C,50);d=(new Date).getTime(),u.match(/:\/\//)||(u=window.location.protocol+"//"+window.location.host+u);let e=new URL(u);e.searchParams.delete("rn"),e.searchParams.append("rn",Math.round(1e5*Math.random())+(_.method||"")),u=e.toString()}p&&!0===p.aborted?k({statusText:"abort"}):$.ajax({url:u,async:b,method:e,data:_,dataType:"json",beforeSend:function(e,t){p&&(p.jqXHR=e)}}).then(x).fail(k)};C();let T,A=++r;o[A]=new Promise(e=>{T=e});let S=function(){setTimeout(()=>{delete o[A]},1e3),w=!0,v&&App.fullScreenProcesses.hideCog()};return m||(T(),T=()=>{}),g.always((function(){setTimeout(S,100),setTimeout(T,50)})),g.promise()},delete:function(e){return 0!==e.length&&this.__ajax("post",{delete_ids:JSON.stringify(e),method:"delete"})},restore:function(e){return 0!==e.length&&this.__ajax("post",{restore_ids:JSON.stringify(e),method:"restore"})},duplicate:function(e,t,a){return 0!==e.length&&this.__ajax("post",{duplicate_ids:JSON.stringify(e),data:t,insertAfter:a,method:"duplicate"})},dblClick:function(e,t,a){return this.__ajax("post",{field:t,id:e,method:"dblClick",hash:a})},getFieldLog:function(e,t,a){return this.__ajax("post",{field:e,id:t,method:"getFieldLog",rowName:a})},refresh_rows:function(e){return 0!==e.length&&this.__ajax("post",{refreash_ids:JSON.stringify(e),method:"refresh_rows"})},refresh_cycles:function(e){return 0!==e.length&&this.__ajax("post",{refreash_ids:JSON.stringify(e),method:"refresh_cycles"})},checkUnic:function(e,t){"use strict";return this.__ajax("post",{fieldName:e,fieldVal:t,method:"checkUnic"})},add:function(e,t,a){return this.__ajax("post",{hash:e,method:"add",fields:this.onlyFields,data:t,ids:a})},getValue:function(e,t){return this.__ajax("post",{data:e,method:"getValue",table_id:t})},getIdByFieldValue:function(e){return this.__ajax("post",{data:e,method:"getIdByFieldValue"})},getNotificationsTable:function(){return this.__ajax("post",{method:"getNotificationsTable"})},get:function(e){return this.__ajax("get",{id:e})},setTableFavorite:function(e){return this.__ajax("post",{status:e,method:"setTableFavorite"})},checkInsertRow:function(e,t,a,i){let n={};return $.each(e,(function(e,t){null!=t&&(n[e]=t)})),this.__ajax("post",{data:n,hash:t,fields:this.onlyFields,clearField:a,loadSelects:i,method:"checkInsertRow"})},checkEditRow:function(e,t,a){var i={};return $.each(e,(function(e,t){null!=t&&(i[e]=t)})),this.__ajax("post",{data:i,fields:this.onlyFields,method:"checkEditRow",loadSelects:t,hash:a})},viewRow:function(e){return this.__ajax("post",{id:e,method:"viewRow"})},checkTableIsChanged:function(e){return this.__ajax("post",{method:"checkTableIsChanged",table_id:s.tableRow.id,cycle_id:s.tableRow.cycle_id},e)},checkForNotifications:function(e,t,a){return this.__ajax("post",{method:"checkForNotifications",periodicity:e,activeIds:t},a)},notificationUpdate:function(e,t,a,i){return this.__ajax("post",{method:"notificationUpdate",id:e,num:a,item:i,type:t})},seachUserTables:function(e,t){return this.__ajax("post",{method:"seachUserTables",q:e,et:t})},selectSourceTableAction:function(e,t,a){return this.__ajax("post",{field_name:e,data:t,isPlus:a,method:"selectSourceTableAction"})},saveEditRow:function(e){var t={};return $.each(e,(function(e,a){void 0!==a&&(t[e]=a)})),this.__ajax("post",{data:t,fields:this.onlyFields,method:"saveEditRow"})},excelExport:function(e,t){return this.__ajax("post",{data:JSON.stringify(e),title:t,method:"excelExport"})},excelImport:function(e){return this.__ajax("post",{method:"excelImport",title:e,bwidth:window.top.document.body.clientWidth})},getEditSelect:function(e,t,a,i,n,l,s){return this.__ajax("post",{data:{item:e,field:t,hash:s},q:a,parentId:i,method:"getEditSelect"},l,!n)},loadPreviewHtml:function(e,t,a){return this.__ajax("post",{data:{item:c(t),field:e,val:a},method:"loadPreviewHtml"},null,!0)},save:function(e){let t={};return e.params&&Object.keys(e.params).some((function(e){if("filter"===s.fields[e].category)return s._filtersBlock.data("cryptoFilters")&&(t.filters=s._filtersBlock.data("cryptoFilters")),!0})),this.__ajax("post",{data:e,method:"edit"},null,null,t)},saveLinkToEdit:function(e,t,a,i,n){return this.__ajax("post",{special:a,data:t,shash:e,search:i,method:"saveLinkToEdit"},n)},click:function(e){return this.__ajax("post",{data:e,method:"click"})},csvExport:function(e,t,a){return this.__ajax("post",{method:"csvExport",type:t,sorted_ids:JSON.stringify(e),visibleFields:JSON.stringify(a)})},csvImport:function(e,t,a,i){return this.__ajax("post",{csv:e,type:t,answers:a,method:"csvImport",visibleFields:JSON.stringify(i)})},getTableData:function(e,t){return this.__ajax("post",{method:"getTableData",fields:t,tableData:{sess_hash:e}})},panelsView:function(e){return this.__ajax("post",{method:"panelsViewCookie",switcher:e?1:0})},refresh:function(e,t,a,i){if("reload"===t)return void App.windowReloadWithHash(this);let n;e=e||function(e){s.table_modify(e),s.reloaded()},s.treeIndex&&(n={},Object.keys(s.treeIndex).forEach(e=>{n[e]=s.treeIndex[e].l?1:0}),n=JSON.stringify(n)),this.__ajax("post",{method:"refresh",tree:n,recalculate:"recalculate"===t||null,withoutIds:a,getList:i}).then((function(t){try{e(t)}catch(e){App.windowReloadWithHash(s.model)}}))},saveOrder:function(e){return this.__ajax("post",{method:"saveOrder",orderedIds:JSON.stringify(e)})},setCommentsViewed:function(e,t,a){return this.__ajax("post",{method:"setCommentsViewed",nums:e,field_name:t,id:a})},AddEyeGroupSet:function(e,t){return this.__ajax("post",{method:"addEyeGroupSet",name:e,fields:t})},removeEyeGroupSet:function(e){return this.__ajax("post",{method:"removeEyeGroupSet",index:e})},leftEyeGroupSet:function(e){return this.__ajax("post",{method:"leftEyeGroupSet",index:e})},reUser:function(e){return this.__ajax("post",{method:"reuser",userId:e,location:window.location.pathname})},printTable:function(e){return this.__ajax("post",{method:"printTable",settings:JSON.stringify(e)})},getAllTables:async function(){return this.__ajax("post",{method:"getAllTables"})},calcFieldsLog:function(e,t){return this.__ajax("post",{method:"calcFieldsLog",calc_fields_data:e,name:t})},renameField:function(e){return this.__ajax("post",{method:"renameField",name:e})},panelButtonsClick:function(e,t){return this.__ajax("post",{method:"panelButtonsClick",hash:e,index:t})},panelButtonsClear:function(e){return this.__ajax("post",{method:"panelButtonsClear",hash:e})},linkJsonClick:function(e,t){return this.__ajax("post",{method:"linkJsonClick",hash:e,json:t})},buttonsClick:function(e,t){return this.__ajax("post",{method:"linkButtonsClick",hash:e,index:t})},inputClick:function(e,t){return this.__ajax("post",{method:"linkInputClick",hash:e,val:t})},getChartTypes:function(){return this.__ajax("post",{method:"getChartTypes"})},getPanelFormats:function(e,t){return this.__ajax("post",{method:"getPanelFormats",field:e,id:t})},loadUserButtons:function(){return this.__ajax("post",{method:"loadUserButtons"})},userButtonsClick:function(e,t){return this.__ajax("post",{method:"userButtonsClick",hash:e,index:t})},filesUpload:function(e,t){return this.__ajax("post",{method:"filesUpload",files:JSON.stringify(e),hash:t})},loadPage:function(e,t,a,i,n){let l={};return e&&e.filtersString&&(l.filters=e.filtersString),e.PageData.loading=!0,this.__ajax("post",{method:"loadPage",lastId:t,offset:n,pageCount:a,prevLastId:i,recFormats:e.formatUseRows?1:null},null,null,l).then((function(t){e.applyPage(t),e.formatUseRows&&e.table_modify({chdata:{params:t.params}})}))}}},function(){$((function(){let e=localStorage.getItem("topNavScroll"),t=$(".totbar-default.navbar-default");e>0&&t.scrollLeft(e),t.on("scroll",()=>{localStorage.setItem("topNavScroll",t.scrollLeft())})}));const e=function(e){if(e){let t=e.chdata.rows[Object.keys(e.chdata.rows)[0]];const a=function(e,t){App.getPcTableById("tree").then((function(a){a.model.checkEditRow({id:e}).then((function(e){window.location.href="/Table/"+e.row.top.v+"/"+t}))}))};"calcs"===t.type.v?App.getPcTableById(1).then((function(e){e.model.checkEditRow({id:t.tree_node_id.v}).then((function(e){a(e.row.tree_node_id.v,t.tree_node_id.v)}))})):a(t.tree_node_id.v,t.id)}};addTree=function(t,a,i){let n=$("div.page_content");if(!App.isTopWindow())return n.addClass("tree-minifyed iframed"),!1;window.TREE_DATA=a;let l=App.isMobile();l?i=!1:($(window).on("resize",(function(){window.innerWidth<=660&&!n.is(".tree-minifyed")&&u(!0)})),localStorage.getItem("notCreator")&&(i=!1)),$.jstree.defaults.core.dblclick_toggle=!1,$.jstree.defaults.core.expand_selected_onload=!0,$.jstree.defaults.core.force_text=!0;let s,o=localStorage.getItem("tree")||"{}";o=JSON.parse(o),$.each(a,(function(e,n){if(a[e].data={type:n.type},n.id.match(/^table/)&&n.icon&&(a[e].icon="fa fa-"+n.icon),n.state&&n.state.selected&&(a[e].li_attr={class:"jstree-selected"}),o[n.id]&&(a[e].state||(a[e].state={}),a[e].state.opened=!0),n.href?a[e].a_attr={href:(n.href.toString().match(/\/Table\//)?"":t)+n.href}:n.link&&(a[e].a_attr={href:n.link}),i)switch(-1!==["link","anchor","folder"].indexOf(n.type)&&(n.a_attr=n.a_attr||{},n.a_attr={...n.a_attr,class:"edit-folder","data-id":n.id.substr(4)}),n.type){case"folder":a.push({type:"plus",id:"plus-table"+n.id.substring(4),text:App.translate("treeAddTable"),parent:n.id,li_attr:{class:"jstree-creatorView"}}),a.push({type:"plus",id:"plus-folder"+n.id.substring(4),text:App.translate("treeAddFolder"),parent:n.id,li_attr:{class:"jstree-creatorView"}});break;case"cycle_name":sessionStorage.getItem("cycles_table_anchor")&&(a[e].parent="tree"+sessionStorage.getItem("cycles_table_anchor")),a.push({type:"plus",id:"plus-calcs"+n.parent.substring(4),text:App.translate("treeAddTable"),parent:n.id,li_attr:{class:"jstree-creatorView"}});break;case"table_cycles":n.a_attr={...n.a_attr,class:"add_calcs_table","data-id":n.id.substr(5)}}else"folder"===n.type&&(n.li_attr={...n.li_attr,class:"folder-with-padding"})})),i&&(s=t.match(/^.*?(\d+)/))&&(a.push({type:"plus",id:"plus-table"+s[1],text:App.translate("treeAddTable"),parent:"#",li_attr:{class:"jstree-creatorView"}}),a.push({type:"plus",id:"plus-folder"+s[1],text:App.translate("treeAddFolder"),parent:"#",li_attr:{class:"jstree-creatorView"}}));let r=$("#leftTree");if(i?r.on("init.jstree",(function(t,a){let i=$.jstree.core.prototype.redraw_node;r.jstree(!0).redraw_node=function(t,a,n,l){let s=i.bind(this)(t,a,n,l);if(t.match(/^tree/)){"folder"==r.jstree(!0).get_node(t).data.type&&$(s).addClass("tree-folder")}let o=$(s).find(">a.edit-folder");if(o.length){let t=$('<i class="fa fa-edit edit-folder-icon"></i>');t.on("click",()=>(new EditPanel("tree",BootstrapDialog.TYPE_DANGER,{id:o.data("id")}).then(e),!1)),o.find(">i").after(t)}else{let t=$(s).find(">a.add_calcs_table");if(t.length){let a=$('<i class="fa fa-plus edit-folder-icon"></i>');a.on("click",()=>(new EditPanel(1,BootstrapDialog.TYPE_DANGER,{type:{v:"calcs"},tree_node_id:{v:t.data("id")}},{},{type:!0,tree_node_id:!0}).then(e),!1)),t.find(">i").after(a)}}return s}})):r.on("init.jstree",(function(e,t){let a=$.jstree.core.prototype.redraw_node;r.jstree(!0).redraw_node=function(e,t,i,n){let l=a.bind(this)(e,t,i,n);if(e.match(/^tree/)){"folder"==r.jstree(!0).get_node(e).data.type&&$(l).addClass("tree-folder")}return l}})),!l){let e,t=$('<input placeholder="'+App.translate("Tree search")+'" class="form-control">'),a=$('<div id="serverSearch"></div>');r.before(t),r.after(a),t.wrap('<div id="searchArea">');const i=(t,a)=>(e||(e=App.models.table("/Table/"),e.addPcTable({model:e})),new Promise(i=>{e.seachUserTables(t,a).then(e=>{let t=$("<div>");e.trees.forEach(e=>{let a=$("<div>").append($("<a>").attr("href",e.href||"/Table/"+e.id).text(e.title));e.icon&&a.prepend('<i class="icon fa fa-'+e.icon+'"></i>'),t.append(a)}),e.tables.forEach(e=>{let a=$("<div>").append($("<a>").attr("href","/Table/"+e.top+"/"+e.id).text(e.title));if(e.icon)a.prepend('<i class="icon fa fa-'+e.icon+'"></i>');else{let t={globcalcs:"calculator",calcs:"calculator",tmp:"clock-o",simple:"table",cycles:"circle-o"}[e.type];a.prepend('<i class="icon fa fa-'+t+'"></i>')}t.append(a)}),i(t.children())})}));let n;t.on("keyup",()=>{n&&clearTimeout(n),n=setTimeout(async()=>{let e=t.val().trim();r.jstree(!0).show_all(),r.jstree("search",e),""!=e?a.html(await i(e,window.top_branch||(window.location.pathname.match(/\/Table\/(\d+)/)||{1:0})[1])):a.html(""),h()},50)}),r.on("search.jstree",(function(e,t,a){0===t.nodes.length&&r.jstree(!0).hide_all()}))}let d=$("#LeftTree"),c=()=>"tree_scroll_part_"+(window.top_branch||(window.location.pathname.match(/\/Table\/(\d+)/)||{1:0})[1]);const p=function(){r.jstree({state:{key:"leftTree"},core:{check_callback:!0,expand_selected_onload:!0,open_parents:!0,data:a,themes:{name:"default"}},types:{folder:{},plus:{icon:"fa fa-plus"},cycle_name:{icon:"fa fa-dot-circle-o",select_node:!1},text:{icon:"jstree-file"},table:{icon:"jstree-file"},table_simple:App.tableTypes.simple,table_version:App.tableTypes.version,table_calcs:App.tableTypes.calcs,table_tmp:App.tableTypes.tmp,table_globcalcs:App.tableTypes.globcalcs,table_cycles:App.tableTypes.cycles,table_data:{icon:"jstree-file"}},plugins:["types","themes","search"],search:{case_sensitive:!1,show_only_matches:!0,search_callback:function(e,t){if("folder"===t.original.type)return!1;var a,n=[],l=e.toLowerCase().replace(/^\s+/g,"").replace(/\s+$/g,"");n=l.indexOf(" ")>=0?l.split(" "):[l];const s=e=>{for(var t=0;t<n.length;t++)if(a=n[t],-1===e.toString().toLowerCase().indexOf(a))return!1;return!0};return s(t.text||"")||i&&s(t.original.name||"")}}}),h()};r.on("loaded.jstree after_open.jstree",(function(e){let t=r.width();if(r.find("a.jstree-anchor").each((function(){let e=$(this),a=e.offset().left;e.width(t-a)})),"loaded"===e.type){let e=localStorage.getItem(c());e&&d.scrollTop(e),h()}})),r.on("select_node.jstree",(function(a,i){switch(localStorage.setItem(c(),d.scrollTop()),(i.node.data?i.node.data.type:null)||i.node.type){case"plus":let a=i.node.id.substring(5,10);if("calcs"===a){let e=i.node.id.substring(11);i.node.parent.substring(5);new EditPanel(1,BootstrapDialog.TYPE_DANGER,{tree_node_id:{v:e},type:{v:"calcs"}}).then((function(e){e&&window.location.reload(!0)}))}else if("table"===a){let t=i.node.id.length>10?i.node.id.substring(10):window.location.pathname.match(/^\/.*\/(\d+)\//)[1];new EditPanel(1,BootstrapDialog.TYPE_DANGER,{tree_node_id:{v:t}}).then(e)}else{let e=i.node.id.length>11?i.node.id.substring(11):window.location.pathname.match(/^\/.*\/(\d+)\//)[1];new EditPanel("tree",BootstrapDialog.TYPE_DANGER,{parent_id:{v:e}}).then((function(e){e&&window.location.reload(!0)}))}return!1;case"link":window.location.href=i.node.a_attr.href;break;case"tab_button":App.clickToCyclesTabButton(i.node.id);break;case"cycle_name":return!1;case"folder":case"project":return i.node.state.opened?($("#leftTree").jstree("close_node",i.node),o[i.node.id]&&(delete o[i.node.id],localStorage.setItem("tree",JSON.stringify(o)))):($("#leftTree").jstree("open_node",i.node),o[i.node.id]=!0,localStorage.setItem("tree",JSON.stringify(o))),!1;default:window.location.pathname.match(/^\/Table\//)?window.location.href=i.node.original.link?i.node.original.link:"/"!==i.node.original.href[0]?t+i.node.original.href:i.node.original.href:window.location.href=i.node.original.href}return!1}));const h=function(){setTimeout((function(){d.getNiceScroll().resize()}),250)};r.on("open_node.jstree",(function(e,t){o[t.node.id]=!0,localStorage.setItem("tree",JSON.stringify(o)),h()})),r.on("close_node.jstree",(function(e,t){o[t.node.id]&&(delete o[t.node.id],localStorage.setItem("tree",JSON.stringify(o))),h()}));let f=localStorage.getItem("TreeMinimizer")||"false";f=JSON.parse(f);let u=function(e){f=e;const t=$("#page-tree");let a=$("#page-tree").length&&!($("#main-page").length||$("#tables_tabls").length);e?($("body>.page_content").addClass("tree-minifyed"),$("#LeftTree").getNiceScroll().resize(),a&&(t.append($("#branch-title, #searchArea, #serverSearch")),t.append(r),r.trigger("after_open"))):($("body>.page_content").removeClass("tree-minifyed"),a&&($(".TreeContainer").append($("#branch-title, #searchArea, #serverSearch")),$(".TreeContainer").append(r),r.trigger("after_open"))),$("#table").data("pctable")&&$("#table").data("pctable").setWidthes(),p(),localStorage.setItem("TreeMinimizer",JSON.stringify(f)),h()};l||d.niceScroll({cursorwidth:7,mousescrollstep:190,mousescroll:190,autohidemode:!1,enablekeyboard:!1,cursoropacitymin:1,railoffset:{left:4},cursorcolor:"#e1e0df"}),$("#TreeMaximizer").on("click",(function(){if(l||window.innerWidth<=660){let e=$("<div>");e.append($("#branch-title")),e.append($("#leftTree")),App.mobilePanel('<a class="totum-brand" href="/"><span>'+$(".totum-brand span:first").text()+"</span></a>",e,{onhide:function(){const e=$("#page-tree");1===e.length?(r.appendTo(e),p()):(r.appendTo(".TreeContainer"),p())},cssClass:"mobile-panel mobile-menu"}),r.trigger("after_open")}else u(!1)})),$("#TreeMinimizer").on("click",(function(){u(!0)})),!0===f?setTimeout((function(){u(f)}),1):l?setTimeout((function(){1===$("#page-tree").length&&r.appendTo($("#page-tree")),p()}),10):p()}}();