LOGINJS=function(){let e=$('<div><div class="form-group"><label>Email:</label><input id="elseEmail"  type="text"\n                                                                      name="login"\n                                                                      value=""\n                                                                      class="form-control"\n                /></div></div>');if($("body").on("click","#recover",function(){let t=[{action:function(e){if(""==$("#elseEmail").val().trim())return void $("#elseEmail").addClass("error");let t=$('<form method="post"><input type="hidden" name="login" value=""><input type="hidden" name="recover" value="true"></form>');t.find('[name="login"]').val($("#elseEmail").val()),t.appendTo("body"),t.submit(),e.close()},label:"Отправить пароль на email"},{action:function(e){e.close()},label:"Отмена"}];BootstrapDialog.show({message:e,title:"Новый пароль",buttons:t,draggable:!0})}),$("body").on("click","#register",function(){let t=[{action:function(e){if(""==$("#elseEmail").val().trim())return void $("#elseEmail").addClass("error");let t=$('<form method="post"><input type="hidden" name="login" value=""><input type="hidden" name="register" value="true"></form>');t.find('[name="login"]').val($("#elseEmail").val()),t.appendTo("body"),t.submit(),e.close()},label:"Зарегистрировать и отправить пароль на email"},{action:function(e){e.close()},label:"Отмена"}];BootstrapDialog.show({message:e,title:"Регистрация",buttons:t,draggable:!0})}),sessionStorage.getItem("browserConfirm")||navigator.userAgent.match(/(chrome|safari|firefox|yandex(?=\/))\/?\s*(\d+)/i)&&!navigator.userAgent.match(/BlackBerry|iPod|Opera Mini|IEMobile/i))$("#auth_form").show();else{let e=$("#auth_form");$("body").html('<div style="width: 600px; margin: auto; padding-top: 50px; font-size: 16px; text-align: center;" id="comeinBlock"><img src="/imgs/start.png" alt=""><div style="padding-bottom: 10px;">Сервис оптимизирован под броузеры Chrome, Safari, Yandex, FireFox последних версий.</div><div><a href="#" id="comein" class="btn-default btn">Все равно хочу посмотреть</a></div></div>'),$("#comein").on("click",function(){sessionStorage.setItem("browserConfirm",!0),$("#comeinBlock").remove(),$("body").html(e),e.show()})}},$(function(){if(screen.width>window.MOBILE_MAX_WIDTH){let e=$("#main-page");if(e.length){let t=$(".page_content"),n=!1;const i=function(){e.height(window.innerHeight-100).niceScroll({cursorwidth:7,mousescrollstep:190,mousescroll:190,autohidemode:!1,enablekeyboard:!0,cursoropacitymin:1,railoffset:{left:4},cursorcolor:"#e1e0df"}),n=!0},a=function(){e.height("").getNiceScroll().remove(),n=!1},l=function(){t.is(".tree-minifyed")&&n?a():t.is(".tree-minifyed")||n||i()},o=document.getElementsByClassName("page_content")[0],s={attributes:!0,childList:!1,subtree:!1};new MutationObserver(l).observe(o,s),l()}}}),restModel=function(e){return{url:e,create:function(){return $.ajax({url:this.url,method:"post",data:data})},get:function(e){return $.ajax({url:this.url,method:"get",data:{id:e}})},save:function(e,t){return $.ajax({url:this.url,method:"PUT",data:$.extend(t,{id:e})})}}},$(function(){if(App.notifications=function(e){let t=App.models.table("/Table/");t.addPcTable({model:t}),e.data("withClick")||(e.data("withClick",!0),e.on("click",function(e){t.getNotificationsTable()}));let n={},i={},a=e.data("periodicity")||0;const l=function(){switch(document.visibilityState){case"hidden":n.jqXHR&&n.jqXHR.abort&&n.jqXHR.abort(),n={};break;case"visible":t.checkForNotifications(a,Object.keys(i),n).then(function(e){e.notifications&&e.notifications.length&&(i[e.notification_id]=App.showDatas.call(t,e.notifications,e.notification_id),i[e.notification_id].forEach(function(t){t&&t.$modal&&t.$modal.length&&t.$modal.on("hide.bs.modal",function(){delete i[e.notification_id]})})),e.deactivated&&e.deactivated.forEach&&e.deactivated.forEach(function(e){i[e]&&(i[e].forEach(function(e){e.simpleClose()}),delete i[e])}),App.checkNotificationManager(i),a>0&&l()}).fail(function(e){e&&e.error&&document.removeEventListener("visibilitychange",l)})}};return a>0&&(document.addEventListener("visibilitychange",l),l()),l},App.isTopWindow()){let e=$("#bell-notifications");e.length&&App.notifications(e)}}),$(function(){let e=$("#docs-link");const t=function(){let n=$(this).data("type"),i=$('<div class="tech-table" id="DocsPopover" data-type="'+n+'" style="min-height: 250px"></div>');$.post("https://docs.totum.online/index_"+n+".json",function(e){e&&e.length&&e.forEach(function(e){i.append('<div style="'+(e[2]||"")+'"><i class="fa fa-external-link"></i> <a href="http://docs.totum.online'+e[1]+'" target="totum-docs">'+e[0]+"</a></div>")})}),e.popover({html:!0,content:i,trigger:"manual",container:"body",placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),setTimeout(function(){e.popover("show"),$("#"+e.attr("aria-describedby")).css("top","45px"),$("body").one("click.DocsPopover",function(n){void 0!==n.altKey&&(e.popover("destroy"),e.one("click",t))})},50)};e.one("click",t)}),function(e,t){const n=e.MOBILE_MAX_WIDTH=1199,i={type:{isOn:!0,Val:"string"},width:{isOn:!0,Val:100},default:{isOn:!1,Val:""},regexp:{isOn:!1,Val:""},regexpErrorText:{isOn:!1,Val:""},required:{isOn:!0,Val:!1},showInWeb:{isOn:!0,Val:!0},insertable:{isOn:!0,Val:!0},dropdownView:{isOn:!0,Val:!0},addRoles:{isOn:!1,Val:["1"]},editable:{isOn:!0,Val:!0},editRoles:{isOn:!1,Val:["1"]},hidden:{isOn:!0,Val:!1},warningEditPanel:{isOn:!0,Val:!1},warningEditText:{isOn:!1,Val:"Точно изменить?"},warningEditRegExp:{isOn:!1,Val:"/^someValue$/"},url:{isOn:!0,Val:!1},openIn:{isOn:!1,Val:"iframe"},tableBreakBefore:{isOn:!0,Val:!1},sectionTitle:{isOn:!1,Val:""},panelColor:{isOn:!1,Val:""},webRoles:{isOn:!1,Val:["1"]},logRoles:{isOn:!1,Val:["1"]},showInWebOtherPlace:{isOn:!0,Val:!1},showInWebOtherPlacement:{isOn:!1,Val:"param"},showInWebOtherOrd:{isOn:!1,Val:null},showInXml:{isOn:!0,Val:!1},apiEditable:{isOn:!1,Val:!1},xmlEditRoles:{isOn:!1,Val:["1"]},xmlRoles:{isOn:!1,Val:["1"]},logging:{isOn:!0,Val:!0},code:{isOn:!1,Val:"= : "},codeOnlyInAdd:{isOn:!1,Val:!1},errorText:{isOn:!1,Val:""},codeAction:{isOn:!1,Val:"= :"},CodeActionOnAdd:{isOn:!1,Val:!1},CodeActionOnChange:{isOn:!1,Val:!1},format:{isOn:!1,Val:"f1=:"},help:{isOn:!1,Val:""}},a="#ee0c1f",l="#3fbf46",o="pcTableInsertRowPanel";var s=0;CodeMirror.defineMode("sections",function(){return{startState:function(){return{}},token:function(e,t){if(0===e.lineOracle.line)return e.skipToEnd(),t.isStart=!1,"sec-title";if(0===e.pos)return e.skipTo(":"),e.next(),t.isParamsPart=!0,"sec-param";{let n=e.string.substring(e.pos);if(t.isParamsPart&&n.match(":")){let i="sec-parts",a=":";return-1!==n.indexOf(",")?a=",":t.isParamsPart=!1,/^\s*\d+\s*$/.test(n.substring(0,n.indexOf(a)))&&(i="sec-num-parts"),e.skipTo(a),e.next(),i}return/^\s*(true|false)\s*$/.test(n)?(e.skipToEnd(),"boolean"):(e.skipToEnd(),"sec-value")}}}}),CodeMirror.sectionsAutoCloses=function(e){e.on("keyup",function(e,t){e.options.bigOneDialog&&t.ctrlKey&&"83"===(t.keyCode||t.which).toString()?(t.stopPropagation(),e.options.bigOneDialog.close()):t.ctrlKey&&"191"===(t.keyCode||t.which).toString()&&CodeMirror.commentMe(e),"27"===(t.keyCode||t.which).toString()?(e.state.completionActive&&e.state.completionActive.close(),t.stopPropagation()):{9:"tab",13:"enter",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",38:"up",40:"down",57:"("}[(t.keyCode||t.which).toString()]||CodeMirror.showHint(e,CodeMirror.hint.totumVars,{})})},function(){let n=App.functions||[],i=[];n.forEach(function(e){e.d||i.push(e.name)});let a={};n.forEach(function(e){a[e.name.toLowerCase()]=[e.t,0,e.p,e.n,e.m]});let l=["where","order","field","sfield","bfield","tfield","preview","parent","section","table","filter","fieldtitle"];CodeMirror.defaults.scrollbarStyle="overlay",CodeMirror.defineInitHook(function(n){try{if(!n.options.bigOneDialog&&screen.width>e.MOBILE_MAX_WIDTH){let i,a=t('<i class="fa fa-expand codemirror-expander" style="position: absolute;\n    right: 10px;\n    bottom: 10px;\n    z-index: 10000;\n    font-family: FontAwesome; cursor: pointer"></i>');t(n.display.wrapper).append(a),a.on("click",function(){i=t('<div class="HTMLEditor" id="bigOneCodemirror" style="height: 100%;"></div>');let a,l=n.getValue();e.top.BootstrapDialog.show({message:i,type:null,title:"Правка текстового поля",cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){n.setValue(a.getValue())},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"}),e.$modalHeader.find("button.close").css("font-size","16px").html('<i class="fa fa-compress"></i>')},onshown:function(t){a=CodeMirror(i.get(0),{mode:n.options.mode,value:l,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:t}),n.table&&(a.table=n.table);let o=Math.round(t.$modalContent.height()-t.$modalHeader.outerHeight()-40);a.getScrollerElement().style.minHeight=o+"px",i.find(".CodeMirror").css("min-heught",o),a.focus(),t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top})}})})}}catch(e){n.setValue(e.message)}});function o(e){if(e.getOption("disableInput")||"totum"!==e.getOption("mode"))return CodeMirror.Pass;var t=e.listSelections(),n=[];let i=!1;for(let r=0;r<t.length;r++){if(!t[r].empty())return CodeMirror.Pass;var l=t[r].head,o=e.getTokenAt(l,!0);if(o.state&&o.state.inFuncName||"function"==o.type||"error"==o.type){let c,d=o.string.toLowerCase(),f="";if(-1!==d.indexOf("/")?(c=d.substring(0,d.indexOf("/")),f=d.substring(d.indexOf("/"))):c=d.trimRight(),c=a[c]){let e="",t=0;if(f.length){e="(";let n=1,a=!0;f.split("/").forEach(function(t){if(0===t.length);else{a||(e+="; "),a=!1;let i=-1!==t.indexOf(":")&&""!==t.slice(t.indexOf(":")+1).trim();e+=t+(-1===t.indexOf(":")?": ":""),1!==n||i||(n=e.length)}}),1===n?n=e.length:i=!0,t+=n,e+=")"}else if(e=c[0],/:/.test(e)){let n=e.indexOf(":"),a=e.substring(n),l=a.substring(0,a.indexOf(";")||a.indexOf(")"));t+=n,-1!==l.indexOf("'")?t+=l.indexOf("'")+1:t+=2,i=!0}else t+=e.length;n[r]={text:e,newPos:CodeMirror.Pos(l.line,l.ch-f.length+t),replace:CodeMirror.Pos(l.line,l.ch-f.length)}}else n[r]={text:"()",newPos:CodeMirror.Pos(l.line,l.ch+1),replace:CodeMirror.Pos(l.line,l.ch)};let p=n[r];if(p){e.replaceRange(p.text,p.replace,t[r].anchor,"+insert");var s=e.listSelections().slice(0);s[r]={head:p.newPos,anchor:p.newPos},e.setSelections(s),i&&CodeMirror.showHint(e,CodeMirror.hint.totumVars,{})}}else e.replaceRange("()",CodeMirror.Pos(l.line,l.ch),t[r].anchor),e.setSelections([{head:CodeMirror.Pos(l.line,l.ch+1),anchor:CodeMirror.Pos(l.line,l.ch+1)}])}}CodeMirror.defineMode("totum",function(){return{startState:function(){return{inString:!1,isStart:!0,inFunction:!1,lineName:""}},token:function(e,n){function i(){return e.string.substring(e.start,e.pos)}function o(){"use strict";return e.skipToEnd(),"error"}n.lineNames=[];try{e.lineOracle.doc.cm.getValue().split("\n").forEach(function(e){return 0===e.trim().length||0===e.indexOf("//")?"":n.lineNames.push(e.replace(/^\s*~?\s*([a-zA-Z_0-9=]+)\s*:.*/,"$1"))})}catch(e){}if(0===e.pos||!0===n.isStart){if(e.string.match("^[\ts]*//"))return e.skipToEnd(),n.isStart=!1,"comment";let a="start";if(n.isStart=!0,/[\t\n]/.test(e.peek())&&e.next()){for(;/[\t\n]/.test(e.peek())&&e.next(););return"start-tabs"}return e.skipTo(":")?(n.lineName=i().trim(),"~"===n.lineName.substring(0,1)&&(a+=" fixed",n.lineName=n.lineName.substring(1)),/^[a-z0-9_]+\s*$/i.test(n.lineName)||"="===n.lineName||/^[fp][0-9]+\s*=\s*$/i.test(n.lineName)?(e.next(),t(e.lineOracle.doc.cm.getWrapperElement()).find(".cm-var-not-in").each(function(){let e=t(this).text();(e=e.replace(/\[.*/,""))!=="$"+n.lineName&&e!=="#$"+n.lineName&&e!=="$$"+n.lineName||t(this).removeClass("cm-var-not-in")}),n.lineNames.filter(function(e){return e===n.lineName}).length>1&&(a+=" dubbled"),n.isStart=!1,a):o()):o()}if(n.isStart=!1,e.match(/(math|json)`[^`]*`/))return"spec";switch(e.peek()){case" ":return e.next(),null;case"{":return e.next(),e.skipTo("}")?(e.next(),"inVars"):o();case'"':let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string"):o();case"#":e.next();let i="db_name";for(;/[a-z0-9_А-Яа-я\-\[\]\$\#".]/.test(e.peek())&&e.next(););let a=e.string.substring(e.start+1,e.pos);return/[^0-9a-z._]/.test(a.replace(/\[.*/g,"").slice(1))&&(i+=" tmp-error"),""===a?o():("$"===a[0]&&(a=a.replace(/\[.*/g,"").slice(1).trim(),-1===n.lineNames.indexOf(a)&&(i+=" var-not-in")),i);case"@":e.next();let l,s=e.peek();for(;/[a-z0-9_.\[\$\#"A-Z\]]/.test(l=e.peek())&&e.next();)s+=l;return/^[a-z0-9_]{3,}\.[a-z0-9_]{2,}(\[[a-zA-Z0-9_\$\#"]+\])*$/i.test(s)?"db_name":o();case"$":if(e.next(),"#"===e.peek()){for(e.next();/[a-z0-9_\-\[\]\$\#"]/i.test(e.peek())&&e.next(););return"code-var"}{for(;/[a-zA-Z0-9_\[\]\$\#"]/i.test(e.peek())&&e.next(););let t=e.string.substring(e.start,e.pos),i="variable",a=(t=t.replace(/\[.*/g,"")).substring(1);return"$"===a[0]&&(i+=" dollar-dollar",a=a.substring(1)),-1===n.lineNames.indexOf(a)&&(i+=" var-not-in"),i}case"t":if("true"===e.string.substring(e.start,e.start+4))return e.skipTo("e"),e.next(),"boolean";break;case"f":if("false"===e.string.substring(e.start,e.start+5))return e.skipTo("e"),e.next(),"boolean"}if(n.inFuncName=!1,!n.inFunction&&/[a-zA-Z]/.test(e.peek())){if(n.inFuncName=!0,e.skipTo("(")?n.inFunction=!0:e.skipToEnd(),!/^[a-zA-Z]+[0-9]*\s*$/.test(i()))return o();let t=a[i().trim().toLowerCase()];return t?(n.func=t,e.next(),"function"):o()}if(n.inFunction){if(")"===e.peek())return e.next(),n.inFunction=!1,n.functionParam="","function";if(!n.functionParam&&/[a-z_]/.test(e.peek())){if(e.skipTo(":")){let t=e.string.substring(e.start,e.pos);if(/^[a-z_]+\s*$/.test(t)){if(n.functionParam=t,e.next(),-1===n.func[2].indexOf(t))return o();let i="functionParam";return-1!==l.indexOf(t)&&(i+=" fieldParam"),-1!==n.func[3].indexOf(t)&&(i+=" reqParam"),n.func[4]&&-1!==n.func[4].indexOf(t)&&(i+=" multiParam"),i}return o()}return e.skipTo(")")?"error fieldParam":o()}if(!n.functionParam)return o();if(";"===e.peek())return e.next(),n.functionParam="","";if("order"===n.functionParam&&/[ad]/.test(e.peek())){if("asc"===e.string.substring(e.start,e.start+3))return e.next(),e.next(),e.next(),"";if("desc"===e.string.substring(e.start,e.start+4))return e.next(),e.next(),e.next(),e.next(),""}if("'"===e.peek()){let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string-name"):o()}}if("'"===e.peek()){let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string"):o()}if(/\d|%/.test(e.peek())){for(e.next();/[0-9.%]/.test(e.peek())&&e.next(););return/^\d+(\.\d+)?%?$/.test(e.string.substring(e.start,e.pos))?"number":o()}return/[+-\/*!<>=]/.test(e.peek())?(e.next(),"operator"):o()}}}),CodeMirror.registerHelper("hint","totumVars",function(e,n){return function(e,n,o,r){var f=e.getCursor(),h=o(e,f);if("error"!==h.type&&"string-name"!==h.type&&/\b(?:string|comment)\b/.test(h.type))return;var u=CodeMirror.innerMode(e.getMode(),h.state);if("json"===u.mode.helperType)return;h.state=u.state,h.inString=h.string,h.state.isDb_name=!1,h.state.showAll=!0,r.inStart=!0;let m,b=function(e,t,n){void 0!==n&&null!==n&&(e.replaceRange(n.text||n,t.from,t.to),n.curPos&&e.setCursor({line:t.from.line,ch:n.curPos}),n.showHint&&CodeMirror.showHint(e,CodeMirror.hint.totumVars,{}))};if(n=n.slice(),h.state.isStart||0===f.ch){n=[],h.string=h.string.replace(/^[\t]+/,"");let i="";/^~/.test(h.string)&&(h.string.replace(/^~/,""),i="~"),t(e.getWrapperElement()).find(".cm-var-not-in").each(function(){let e=t(this).text().replace(/^(\#|\$)?\$/,"").replace(/\[.*/,"");n.push({text:i+e+": ",displayText:e})})}else if(/^'.*?'?$/.test(h.string)&&-1!==l.indexOf(h.state.functionParam))if(h.state.showAll=!0,"''"===h.string?(h.end=h.end,h.start+=1,h.string=""):/'[a-z_0-9]+'/.test(h.string)?(h.start+=1,h.string=h.string.slice(1,f.ch-h.start)):(h.string=h.string.slice(1,f.ch-h.start),h.start+=1,h.end=f.ch,"'"===e.getLine(f.line)[f.ch]&&h.end++),"table"===h.state.functionParam){let e=c();n=[],Object.keys(e).forEach(function(t){n.push({text:t+"'",textVis:t,title:e[t].t,render:d,type:"item-string-name",hint:b,tab:!0})})}else{let t,i=e.getLine(f.line),a=i.substring(0,f.ch),l=i.substring(f.ch),o=l.substring(0,l.indexOf(")"));if(a=a.substring(a.lastIndexOf("("))+o,t=a.match(/table:\s*((\$#ntn)|'([a-z_0-9]*)')/)){let i=t[2]?e.table:t[3];n=[],Object.keys(s[i].f).forEach(function(e){n.push({text:e+"'",textVis:e,title:s[i].f[e],render:d,type:"item-string-name",curPos:f.ch+e.length+1,tab:!0})}),n.push({text:"id'",textVis:"id",title:"",render:d,type:"item-string-name",curPos:f.ch+3,tab:!0})}}else if(h.end>f.ch&&(h.end=f.ch,h.string=h.string.slice(0,f.ch-h.start)),0===h.string.indexOf("@")){r.inStart=!1,n=[];let e,t=c();if(h.string=h.string.slice(1,f.ch-h.start),h.start=h.start+1,h.end=f.ch,e=h.string.match(/^([a-z_0-9]+)\./)){let i=e[1];h.start+=(i+".").length,h.string=h.string.slice((i+".").length),t[i]&&t[i]["@"].length&&t[i]["@"].forEach(function(e){n.push({text:e,title:t[i].f[e],render:d,type:"item-db_name"})})}else Object.keys(t).forEach(function(e){t[e]["@"].length&&n.push({text:e+".",textVis:e,title:t[e].t,render:d,type:"item-db_name",showHint:!0,hint:b})})}else if("$#"===h.string.slice(0,2)){n=[{text:"$#lc",title:"Пустой лист",render:d,type:"item-code-var"},{text:"$#nd",title:"дата - Y-m-d",render:d,type:"item-code-var"},{text:"$#ndt",title:"дата-время - Y-m-d H:i",render:d,type:"item-code-var"},{text:"$#ndts",title:"дата-время с секундами - Y-m-d H:i:s",render:d,type:"item-code-var"},{text:"$#nu",title:"id пользователя",render:d,type:"item-code-var"},{text:"$#nr",title:"ids ролей пользователя",render:d,type:"item-code-var"},{text:"$#nti",title:"id таблицы",render:d,type:"item-code-var"},{text:"$#ntn",title:"NAME таблицы",render:d,type:"item-code-var"},{text:"$#nth",title:"HASH врем. таблицы",render:d,type:"item-code-var"},{text:"$#nci",title:"Cycle расчетной таблицы",render:d,type:"item-code-var"},{text:"$#nf",title:"NAME поля",render:d,type:"item-code-var"},{text:"$#nl",title:"Новая строка",render:d,type:"item-code-var"},{text:"$#ids",title:"id отмеченных галочками полей",render:d,type:"item-code-var"},{text:"$#nfv",title:"Значение текущего поля (для селектов/действий/форматов)",render:d,type:"item-code-var"},{text:"$#onfv",title:"Прошлое значение текущего поля",render:d,type:"item-code-var"},{text:"$#nh",title:"Текущий хост-name",render:d,type:"item-code-var"}];const e=function(e){let t=n.slice(),i=[];return t=t.filter(function(t){if(-1===e.indexOf(t.text))return!0;i.push(t)}),t=i.concat(t)};switch(h.state.functionParam){case"table":n=e(["$#ntn"]);break;case"cycle":n=e(["$#nci"]);break;case"field":n=e(["$#nf","$#nfv"])}}else if(m=h.string.match(/^(#?\$)/))n=[],h.string=h.string.slice(m[1].length,f.ch-h.start),h.start=h.start+m[1].length,h.end=f.ch,h.state.lineNames.forEach(function(e){-1===e.indexOf("=")&&n.push(e)});else if(m=h.string.match(/^\#/))n=[],h.string=h.string.slice(1,f.ch-h.start),h.start=h.start+1,h.end=f.ch,(m=h.string.match(/^([a-z]{1,3}\.)/))&&(h.string=h.string.slice(m[1].length),h.start+=m[1].length),e.table&&s[e.table]&&(Object.keys(s[e.table].f).forEach(function(t){n.push({text:t,title:s[e.table].f[t],render:d,type:"item-db-name"})}),n.push({text:"id",title:"",render:d,type:"item-db-name"}));else if(h.state.inFuncName){if(!h.state.inFunction)if(m=h.string.match(/^([a-zA-Z]+)\//)){let e;if(h.state.showAll=!0,e=a[m[1].toLowerCase()]){let t=h.start;h.start=h.start+h.string.lastIndexOf("/")+1,h.string=h.string.slice(h.string.lastIndexOf("/")+1,f.ch-t),h.end=f.ch,n=[],e[2].forEach(function(t){let i="";-1!==e[3].indexOf(t)&&(i+=" item-reqParam"),-1!==e[4].indexOf(t)&&(i+=" item-multiParam"),-1!==l.indexOf(t)&&(i+=" item-fieldParam"),n.push({text:t+": ",textVis:t,title:"",render:d,type:i})})}}else(n=i.slice()).push("true"),n.push("false")}else h.state.func&&("error fieldParam"===h.type||/(\(|;\s*)$/.test(e.getLine(f.line).slice(0,h.start)))?(n=[],h.state.func[2].forEach(function(t){let i="",a="";")"!==e.getLine(f.line).slice(f.ch).trim()&&(a="; "),-1!==h.state.func[3].indexOf(t)&&(i+=" item-reqParam"),-1!==h.state.func[4].indexOf(t)&&(i+=" item-multiParam"),-1!==l.indexOf(t)&&(i+=" item-fieldParam"),n.push({text:t+": "+a,textVis:t,title:"",render:d,type:i,hint:b,curPos:h.start+(t+": "+a).length-a.length})})):(n=["true","false"],"order"===h.state.functionParam&&(n=n.concat(["asc","desc"])));return{list:function(e,t,n){var i=[],a=[],l=e.string.toLowerCase();n&&n.globalScope;if(!e.state.showAll&&""===l)return found;return t.forEach(function(e){let t,o="";"string"==typeof e?t=e.toLowerCase():(t=e.text.toLowerCase(),e.title&&(o=e.title.toLowerCase())),p(i,t)||p(a,t)||(0===t.lastIndexOf(l,0)?i.push(e):0===o.lastIndexOf(l,0)?i.push(e):-1!==o.indexOf(l,0)?a.push(e):n.inStart||-1===t.indexOf(l)||a.push(e))}),1===i.length&&i[0]===l?[]:1===i.length&&i[0].text===l?[]:1===a.length&&a[0]===l?[]:1===a.length&&a[0].text===l?[]:i.concat(a)}(h,n,r),from:CodeMirror.Pos(f.line,h.start),to:CodeMirror.Pos(f.line,h.end)}}(e,f,function(e,t){return e.getTokenAt(t)},n)});let s=[],r=!1;const c=function(){if(0===s.length&&!r){r=!0;let e=t("#table").data("pctable");e&&e.isCreatorView&&e.model.getAllTables().then(function(e){s=e.tables})}return s},d=function(e,n,i){t(e).append('<span class="'+i.type+'">'+(i.textVis||i.text)+(""===i.title?"":' <span class="descr">'+i.title+"</span>")+"</span>")};let f=[];function p(e,t){return-1!==e.indexOf(t)}CodeMirror.defineOption("autoCloseFunctions",!1,function(e){"totum"===e.getOption("mode")&&function(e){c();var n={name:"autoCloseFunctions"};n["'('"]=o,n["')'"]=o,e.addKeyMap(n),e.on("keydown",function(e,t){"9"===(t.keyCode||t.which).toString()&&function(e,t,n){var i=e.getCursor();if(e.getTokenAt(i).state.inFunction){let a,l,o=e.getLine(i.line);if(n){for(";"===o[a=i.ch]&&a--;o[a]&&-1===[";","("].indexOf(o[a]);)a--;for(l=a;o[a]&&-1===[":","("].indexOf(o[a]);)a--;":"===o[a]&&" "===o[++a]&&a++,l=i.ch}else{for(a=i.ch;o[a]&&-1===[":",")"].indexOf(o[a]);)a++;for(":"===o[a]&&" "===o[++a]&&a++," "===o[a]&&a++,l=a;o[l]&&-1===[";",")"].indexOf(o[l]);)l++;t&&(a=i.ch)}return e.setSelection({line:i.line,ch:a},{line:i.line,ch:l}),!0}}(e,t.altKey,t.shiftKey)&&t.preventDefault()}),e.on("keyup",function(e,t){e.options.bigOneDialog&&t.ctrlKey&&"83"===(t.keyCode||t.which).toString()?(t.stopPropagation(),e.options.bigOneDialog.close()):t.ctrlKey&&"191"===(t.keyCode||t.which).toString()&&CodeMirror.commentMe(e),"27"===(t.keyCode||t.which).toString()?(e.state.completionActive&&e.state.completionActive.close(),t.stopPropagation()):{9:"tab",13:"enter",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",38:"up",40:"down",57:"("}[(t.keyCode||t.which).toString()]||CodeMirror.showHint(e,CodeMirror.hint.totumVars,{})}),e.on("dblclick",function(n){var i=e.getCursor(),a=e.getTokenAt(i).state;let l,o=t(e.getWrapperElement()),s=e.getLine(i.line),r=s.substring(0,i.ch);if(/^\s*~?\s*?[a-zA-Z0-9_]+$/.test(r))l=a.lineName;else{let e=i.ch-1;if(/[a-zA-Z0-9_]/.test(s[e])){for(;--e&&e>=0&&/[a-zA-Z0-9_]/.test(s[e]););if("$"===s[e]){let t=e+1;for(e=i.ch-1;++e&&s.length>e&&/[a-zA-Z0-9_]/.test(s[e]););l=s.substring(t,e)}}}l&&(new RegExp("^s*~?s*"+l+"s*:").test(o.find(".cm-start.light").text())?(o.find(".cm-variable").removeClass("light"),o.find(".cm-start").removeClass("light")):(o.find(".cm-variable").removeClass("light").each(function(){let e=t(this);e.text()==="$"+l&&e.addClass("light")}),o.find(".cm-start").removeClass("light").each(function(){let e=t(this);e.text().trim().replace("~","").replace(":","")===l&&e.addClass("light")})))})}(e),"sections"===e.getOption("mode")&&CodeMirror.sectionsAutoCloses(e)}),function(){"use strict";function t(e,t,n){this.cm=e,this.getHints=t,this.options=n,this.widget=this.onClose=null}function n(e){return"string"==typeof e?e:e.text}function i(t,i){this.completion=t,this.data=i;var a=this,l=t.cm,o=t.options,s=this.hints=e.top.document.createElement("ul");s.className="CodeMirror-hints",this.selectedHint=0;for(var r=i.list,c=0;c<r.length;++c){var d=s.appendChild(e.top.document.createElement("li")),f=r[c],p="CodeMirror-hint"+(c?"":" CodeMirror-hint-active");null!=f.className&&(p=f.className+" "+p),d.className=p,f.render?f.render(d,i,f):d.appendChild(e.top.document.createTextNode(f.displayText||n(f))),d.hintId=c}var h=l.cursorCoords(!1!==o.alignWithWord?i.from:null),u=h.left,m=h.bottom+3,b=!0;s.style.left=u+"px",s.style.top=m+"px";var g,v=e.innerWidth||Math.max(e.top.document.body.offsetWidth,e.top.document.documentElement.offsetWidth),_=e.innerHeight||Math.max(e.top.document.body.offsetHeight,e.top.document.documentElement.offsetHeight),w=s.getBoundingClientRect(),y=w.right-v,x=w.bottom-_;if(y>0&&(w.right-w.left>v&&(s.style.width=v-5+"px",y-=w.right-w.left-v),s.style.left=(u=h.left-y)+"px"),x>0){var k=w.bottom-w.top;w.top-(h.bottom-h.top)-k>0?(x=k+(h.bottom-h.top),b=!1):k>_&&(s.style.height=_-5+"px",x-=k-_),s.style.top=(m=h.bottom-x)+"px"}((o.container||e.top.document.body).appendChild(s),l.addKeyMap(this.keyMap=function(e,t){var n={Up:function(){t.moveFocus(-1)},Down:function(){t.moveFocus(1)},PageUp:function(){t.moveFocus(-t.menuSize())},PageDown:function(){t.moveFocus(t.menuSize())},Home:function(){t.setFocus(0)},End:function(){t.setFocus(t.length)},Enter:t.pick,Esc:t.close},i=e.customKeys?{}:n;function a(e,a){var l;l="string"!=typeof a?function(e){return a(e,t)}:n.hasOwnProperty(a)?n[a]:a,i[e]=l}if(e.customKeys)for(var l in e.customKeys)e.customKeys.hasOwnProperty(l)&&a(l,e.customKeys[l]);if(e.extraKeys)for(var l in e.extraKeys)e.extraKeys.hasOwnProperty(l)&&a(l,e.extraKeys[l]);return i}(o,{moveFocus:function(e){a.changeActive(a.selectedHint+e)},setFocus:function(e){a.changeActive(e)},menuSize:function(){return a.screenAmount()},length:r.length,close:function(){t.close()},pick:function(){a.pick()}})),!1!==o.closeOnUnfocus)&&(l.on("blur",this.onBlur=function(){g=setTimeout(function(){t.close()},100)}),l.on("focus",this.onFocus=function(){clearTimeout(g)}));var C=l.getScrollInfo();return l.on("scroll",this.onScroll=function(){var n=l.getScrollInfo(),i=l.getWrapperElement().getBoundingClientRect(),a=m+C.top-n.top,o=a-(e.pageYOffset||(e.top.document.documentElement||e.top.document.body).scrollTop);if(b||(o+=s.offsetHeight),o<=i.top||o>=i.bottom)return t.close();s.style.top=a+"px",s.style.left=u+C.left-n.left+"px"}),CodeMirror.on(s,"click",function(e){for(var t=e.target||e.srcElement;"SPAN"===t.nodeName;)t=t.parentNode;null!=t.hintId&&(a.changeActive(t.hintId),a.pick())}),CodeMirror.on(s,"mousedown",function(){setTimeout(function(){l.focus()},20)}),CodeMirror.signal(i,"select",r[0],s.firstChild),!0}CodeMirror.showHint=function(e,n,i){if(!e.somethingSelected()&&(null==n&&(n=e.getHelper(e.getCursor(),"hint")),null!=n)){e.state.completionActive&&e.state.completionActive.close();var a=e.state.completionActive=new t(e,n,i||{});if(CodeMirror.signal(e,"startCompletion",e),!a.options.async)return a.showHints(n(e,a.options));n(e,function(e){a.showHints(e)},a.options)}},CodeMirror.commentMe=function(e){var t=e.getCursor(),n=(e.getTokenAt(t).state,e.lineInfo(t.line));let i;(i=n.text.match(/^([\t\s]*)\/\//))?e.replaceRange("",{line:t.line,ch:i[1].length},{line:t.line,ch:i[0].length}):(i=n.text.match(/^[\t\s]*/),e.replaceRange("//",{line:t.line,ch:i[0].length},{line:t.line,ch:i[0].length}))},t.prototype={close:function(){this.active()&&(this.widget&&this.widget.close(),this.onClose&&this.onClose(),this.cm.state.completionActive=null,CodeMirror.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(e,t){var i=e.list[t];i.hint?i.hint(this.cm,e,i):this.cm.replaceRange(n(i),e.from,e.to),this.close();this.cm},showHints:function(e){if(!e||!e.list.length||!this.active())return this.close();this.showWidget(e)},showWidget:function(e){this.widget=new i(this,e),CodeMirror.signal(e,"shown");var t,n=null,a=this,l=this.options.closeCharacters||/[\s()\[\]{};:>,]/,o=this.cm.getCursor(),s=this.cm.getLine(o.line).length;function r(){t||(t=!0,a.close(),a.cm.off("cursorActivity",p),CodeMirror.signal(e,"close"))}function c(){return!!t||(a.widget?void 0:(r(),!0))}function d(){c()||(a.options.async?a.getHints(a.cm,f,a.options):f(a.getHints(a.cm,a.options)))}function f(e){if(!c()){if(!e||!e.list.length)return r();a.widget.close(),a.widget=new i(a,e)}}function p(){clearTimeout(n);var e=a.cm.getCursor(),t=a.cm.getLine(e.line);e.line!=o.line||t.length-e.ch!=s-o.ch||e.ch<o.ch||a.cm.somethingSelected()||e.ch&&l.test(t.charAt(e.ch-1))?a.close():n=setTimeout(d,170)}this.cm.on("cursorActivity",p),this.onClose=r}},i.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null,this.hints.parentNode.removeChild(this.hints),this.completion.cm.removeKeyMap(this.keyMap);var e=this.completion.cm;!1!==this.completion.options.closeOnUnfocus&&(e.off("blur",this.onBlur),e.off("focus",this.onFocus)),e.off("scroll",this.onScroll)}},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(e){if(e=Math.max(0,Math.min(e,this.data.list.length-1)),this.selectedHint!=e){var t=this.hints.childNodes[this.selectedHint];t.className=t.className.replace(" CodeMirror-hint-active",""),(t=this.hints.childNodes[this.selectedHint=e]).className+=" CodeMirror-hint-active",t.offsetTop<this.hints.scrollTop?this.hints.scrollTop=t.offsetTop-3:t.offsetTop+t.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=t.offsetTop+t.offsetHeight-this.hints.clientHeight+3),CodeMirror.signal(this.data,"select",this.data.list[this.selectedHint],t)}},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}}}()}(),function(){const e=function(e){return{doc:e.doc}};CodeMirror.extendMode("css",{commentStart:"/*",commentEnd:"*/",newlineAfterToken:function(e,t){return/^[;{}]$/.test(t)}}),CodeMirror.extendMode("javascript",{commentStart:"/*",commentEnd:"*/",newlineAfterToken:function(e,t,n,i){return this.jsonMode?/^[\[,{]$/.test(t)||/^}/.test(n):(";"!=t||!i.lexical||")"!=i.lexical.type)&&(/^[;{}]$/.test(t)&&!/^;/.test(n))}}),CodeMirror.extendMode("xml",{commentStart:"\x3c!--",commentEnd:"--\x3e",newlineAfterToken:function(e,t,n){return"tag"==e&&/>$/.test(t)||/^</.test(n)}}),CodeMirror.defineExtension("commentRange",function(e,t,n){var i=this,a=CodeMirror.innerMode(i.getMode(),i.getTokenAt(t).state).mode;i.operation(function(){if(e)i.replaceRange(a.commentEnd,n),i.replaceRange(a.commentStart,t),t.line==n.line&&t.ch==n.ch&&i.setCursor(t.line,t.ch+a.commentStart.length);else{var l=i.getRange(t,n),o=l.indexOf(a.commentStart),s=l.lastIndexOf(a.commentEnd);o>-1&&s>-1&&s>o&&(l=l.substr(0,o)+l.substring(o+a.commentStart.length,s)+l.substr(s+a.commentEnd.length)),i.replaceRange(l,t,n)}})}),CodeMirror.defineExtension("autoIndentRange",function(e,t){var n=this;this.operation(function(){for(var i=e.line;i<=t.line;i++)n.indentLine(i,"smart")})}),CodeMirror.defineExtension("autoFormatRange",function(t,n){var i=this,a=i.getMode(),l=i.getRange(t,n).split("\n"),o=CodeMirror.copyState(a,i.getTokenAt(t).state),s=i.getOption("tabSize"),r="",c=0,d=0==t.ch;function f(){r+="\n",d=!0,++c}for(var p=0;p<l.length;++p){for(var h=new CodeMirror.StringStream(l[p],s,e(i));!h.eol();){var u=CodeMirror.innerMode(a,o),m=a.token(h,o),b=h.current();h.start=h.pos,d&&!/\S/.test(b)||(r+=b,d=!1),!d&&u.mode.newlineAfterToken&&u.mode.newlineAfterToken(m,b,h.string.slice(h.pos)||l[p+1]||"",u.state)&&f()}!h.pos&&a.blankLine&&a.blankLine(o),d||f()}i.operation(function(){i.replaceRange(r,t,n);for(var e=t.line+1,a=t.line+c;e<=a;++e)i.indentLine(e,"smart");i.setSelection(t,i.getCursor(!1))})}),t(function(){})}();let r={};var c={sortable:!1,width:50,icon:"fa-font",editable:!1,required:!0,insertable:!1,type:"string",getPanelVal:e=>e,getEditVal:function(e){var t,n=e.val().trim(),i=!1;(!this.required||void 0!==n&&""!==n&&null!==n||(t="Поле "+this.title+" должно быть заполнено",i=!0),this.regexp&&""!==n)&&(new RegExp(this.regexp).test(n)||(t=this.regexpErrorText||'regexp не проходит - "'+this.regexp+'"',t='Ошибка заполнения поля "'+this.title+'": '+t,i=!0));if(i)throw t;return n},getEditElement:function(e,n,i,a,l,o,s){var r=t('<input type="text" class="form-control" name="cell_edit" autocomplete="off" autocorrect="off" />');void 0!==s&&r.attr("tabindex",s);var c=this;return n=n.v,r.val(n).on("keyup",function(e){switch(e.keyCode){case 13:try{r.data("enterClicked",!0),a(t(this),e)}catch(e){r.data("enterClicked",!1),App.popNotify(e,r,"default"),c.focusElement(r)}break;case 27:l(t(this),e)}}),r.on("blur",function(e){o(r,e)}),r.select()},checkEditRegExp:function(e){if(!this.warningEditRegExp)return!0;try{let t=this.warningEditRegExp.match(/^\/(.*?)\/([a-z]*)$/);return new RegExp(t[1],t[2]).test(e)}catch(e){return!0}},getCellText:function(e){if(!0===this.url&&e){let n=this.openIn||"window";switch(n){case"window":n="_self";break;case"newWindow":n="_blank"}let i=t('<a class="uri" target="'+n+'">').attr("href",e).text(e);return"iframe"===n&&i.attr("onclick","return App.aInIframe(this);"),i}return e},getPanelText:function(e,t,n){return this.getCellText(e,t,n)},getCopyText:function(e,n){let i=this.getPanelText(e.v,null,n);if("string"==typeof i)return i;const a=function(e){if(e&&e.each&&"[object Function]"==={}.toString.call(e.each)){let n="";return e.each(function(){""!==n&&(n+="; "),n+=t(this).text().replace(/\n/g,"; ")}),n}return e};if(null===i)return"";if("object"==typeof i&&!(i instanceof jQuery)){let e=t.Deferred();return i.done(function(t){e.resolve(a(t))}).fail(function(){e.resolve("Не удалось загрузить данные")}),e}return a(i)},focusElement:function(e){e.focus()},isDataModified:function(e,t){return t+="","null"===(e+="")&&(e=""),"null"===t&&(t=""),t===(this.errorText||"ОШБК!")&&(t=""),"undefined"===t&&(t=""),e!==t},getFilterDataByValue:function(e){let t=[];return this.addDataToFilter(t,e),Object.keys(t)[0]},addDataToFilter:function(e,t){let n;e[n=null===t.v?"null".hashCode():t.v.toString().hashCode()]="string"==typeof t.v?t.v.replace(/"/g,"&quot;"):t.v},checkIsFiltered:function(e,t){let n=e.v;var i=!1;return t.forEach(function(e){if(e===(null==n?"null":n.toString()).hashCode().toString())return i=!0,!1}),i},getCellTextInPanel:function(e,t,n){return this.getCellText(e,t,n)},getPanelColumnIndex:function(e){return e.f&&e.f.hide&&e.f.hide.panel?0:-1!==["text","comments","file","listRow"].indexOf(this.type)?1.5:this.multiple?1.5:1}};r.text={width:50,icon:"fa-align-left",type:"Text",isPanelField:!0,getEditVal:function(e){return e.data("val").trim()},getCellText:function(e){if(null===e)return"";let n=(e=e.toString()).length;return t("<div>").text(e.substring(0,this.viewTextMaxLength)+(n>this.viewTextMaxLength?"...":"")).text()},getValue:function(e,n,i){"use strict";if(i||"string"==typeof e&&e.length<this.viewTextMaxLength){let n=t.Deferred();return setTimeout(function(){e||(e=""),n.resolve({value:e})},20),n}let a={fieldName:this.name};return n.id&&(a.rowId=n.id),this.pcTable.model.getValue(a,this.table_id)},getPanelTextWithLinks:function(e,n=!0){let i;if("text"===this.textType)(i=t("<div>")).html(App.textWithLinks(e));else if(i=t('<div class="codeEditor">'),e&&e.trim()){let t={value:e,mode:this.getMode(),readOnly:!0,theme:"eclipse",lineNumbers:!0,lineWrapping:!0,bigOneDialog:!0,height:200};n?setTimeout(function(){CodeMirror(i.get(0),t)},10):i.html(App.textWithLinks(e)),i.on("panel-resize",function(){i.empty(),CodeMirror(i.get(0),t)})}return i},getHighCelltext:function(e,n,i){return"string"!=typeof e?"":t("<div>").text(e.trim())},getPanelText:function(e,n,i){if(null===e)return"";let a=this;if((e=e.toString()).length<=this.viewTextMaxLength)return a.getPanelTextWithLinks(e,!1).data("text",e);let l=t.Deferred();return this.getValue(e,i,!1).then(function(e){l.resolve(t("<div>").append(a.getPanelTextWithLinks(e.value,!1)).data("text",e.value))}).fail(function(){l.reject()}),l.promise()},getMode(){let e="text";switch(this.textType){case"html":e="text/html";break;case"totum":e="totum";break;case"markdown":e="text/x-markdown";break;case"xml":e="application/xml";break;case"css":e="text/css";break;case"javascript":e="text/javascript"}return e},getEditElement:function(n,i,a,l,o,s,r,c){let d,f=this,p=t("<div>"),h=t("<div>").css("min-height",200),u=t('<div class="HTMLEditor">');i=i.v||"";let m=function(){f.getValue(i,a,!c).then(function(n){let i;if(p.append(u),u.empty().appendTo(h),"json"===f.textType){i=new JSONEditor(u.get(0),{});try{""!==n.value&&i.setText(n.value)}catch(t){e.top.App.modal("Ошибка формата JSON ")}u.css("min-height",200);let a=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Вручную</a>').on("click",function(){let n=t("<div>"),a=t('<textarea class="form-control" style="height: 350px;">').val(JSON.stringify(i.get(),null,2)).appendTo(n),l=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:function(t){try{i.setText(a.val()),t.close()}catch(t){e.top.App.modal("Ошибка формата JSON")}}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];return f.pcTable.isMobile?App.mobilePanel("Ручное изменение json-поля",n,{buttons:l}):BootstrapDialog.show({message:n,type:null,title:"Ручное изменение json-поля",buttons:l,cssClass:"fieldparams-edit-panel",draggable:!0,onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1});u.find(".jsoneditor-menu").append(a)}else{let e=f.getMode(),l=t("<div>").appendTo(u),o={value:n.value.toString(),mode:e,minHeight:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0};"text"===e&&(o.lineNumbers=!1,o.lineWrapping=!0),(i=CodeMirror(l.get(0),o)).on("paste",function(e,t){setTimeout(function(){i.refresh()},1)}),f.pcTable&&"tables"===f.pcTable.tableRow.name&&(i.table=a.name.v||a.name),i.getScrollerElement().style.minHeight="350px",i.focus()}u.data("editor",i),p.data("editor",i)})};const b=function(e,t,n){"json"===f.textType?p.data("val",JSON.stringify(u.data("editor").get())):p.data("val",u.data("editor").getValue()),n||(l(p,{}),e.close())};d=[];let g={label:"Сохранить",cssClass:"btn-m btn-warning",action:b},v={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){o(p,{}),e.close()}};-1!==["xml","html"].indexOf(f.textType)&&d.unshift({label:"Форматировать",action:function(){let e=u.data("editor"),t=e.lineCount(),n=e.getValue().length;e.autoFormatRange({line:0,ch:0},{line:t,ch:n})}});let _="Текст поля <b>"+this.title+", "+f.textType+"</b>",w="ctrlS.textedit";if(c){let e=!1;setTimeout(function(){let n=p.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each(function(){let n=t(this),i={};i.label=n.data("name"),i.cssClass=n.attr("class").replace("btn-sm","btn-m"),i.icon=n.find("i").attr("class"),i.save=n.data("save"),i.click=n.data("click"),i.action=function(t){i.save&&b(t,0,!0),i.click({}),e=!0,t.close()},d.push(i)}),n.popover("destroy")):(d.push(g),d.push(v)),f.pcTable.isMobile?App.mobilePanel(_,h,{buttons:d,onhide:function(n){t("body").off(w),e||s(p,{})},onshown:function(e){m()},onshow:function(e){t("body").on(w,function(t){b(e)})}}):BootstrapDialog.show({message:h,type:null,title:_,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:d,onhide:function(n){t("body").off(w),e||o(p,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"}),m()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"100%"}),t("body").on(w,function(t){b(e)})}})},1),p.text("Редактирование в форме").addClass("edit-in-form")}else{p.on("focus click","button",function(){let e=d.splice();e.push(g),e.push(v);var n=t(this).closest("div");f.pcTable.isMobile?App.mobilePanel(_,h,{buttons:e,onhide:function(e){t("body").off(w),o(n,e)},onshown:function(e){m(),t("body").on(w,function(t){b(e)})}}):BootstrapDialog.show({message:h,type:null,cssClass:"fieldparams-edit-panel",title:_,buttons:e,draggable:!0,onhide:function(e){t("body").off(w),o(n,e)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),m(),e.$modalContent.css({width:900}),t("body").on(w,function(t){b(e)})}})});let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактировать текст");r&&e.attr("tabindex",r),p.append(e)}return p.data("val",i)},getEditPanelText(e){return this.getPanelTextWithLinks(e.v)},getCellTextInPanel:function(e,t,n){return this.getPanelTextWithLinks(e)},addPlaceholder(e,t){setTimeout(function(){e.data("editor").setOption("placeholder",t),e.data("editor").refresh()},100)}},r.checkbox={icon:"fa-check-square",getEditVal:function(e){return!!e.is(":checked")},getCellText:function(e){return!0===e?"✓":!1===e?"-":""},getEditElement:function(e,n,i,a,l,o,s){var r=t('<input type="checkbox" name="cell_edit"/>');s&&r.attr("tabindex",s),r.on("keyup",function(e){13==e.keyCode&&setTimeout(function(){a(r,e)},20)}),r.on("blur",function(e){setTimeout(function(){r.length&&r.closest("body").length&&l(r,e)},220)});return!0===n.v&&r.prop("checked",!0),r.on("click",function(e){a(r,e)}),r}},r.string={addPlaceholder:function(e,t){e.attr("placeholder",t)}},r.number={icon:"fa-hashtag",getEditVal:function(e){let t=e.val().trim();if(this.required&&(void 0===t||""===t||null===t))throw"Поле "+this.title+" должно быть заполнено";if(this.regexp&&!new RegExp(this.regexp).test(t)){let e=this.regexpErrorText||'regexp не проходит - "'+this.regexp+'"';throw e='Ошибка заполнения поля "'+this.title+'": '+e}if(""===t)return"";let n=t.replace(/[^\-()\d/*+.,%:\/]/g,"");if(!/^(\+|\*|\%|\/|\:)?(\-?[\d]+((\.|\,)[\d]+)?)%?$/.test(n))throw"Здесь должно быть число";return t=t.replace(/,/,".")},getCopyText:function(e,t,n){return null===e||void 0===e||""===e||null===e.v?"":e.v.toString().replace(/\./g,",")},getCellText:function(e,t,n){if(null===e||void 0===e||""===e)return"";if(this.currency){let t={};return this.dectimalPlaces&&(t.minimumFractionDigits=this.dectimalPlaces),parseFloat(e).toLocaleString("ru-RU",t)}return e},addPlaceholder:function(e,t){e.attr("placeholder",t)}},r.date={icon:"fa-calendar-o",getEditVal:function(e){if(this.required&&""==e.val().trim())throw"Поле должно быть заполнено";if(!e.val().trim())return"";let t=e.data("calendar").data("DateTimePicker").date();return this.getDbString(t)},getEditElement:function(e,n,i,a,l,o,s){var r=t('<input type="text" name="cell_edit" class="form-control" autocomplete="off" autocorrect="off" />');s&&r.attr("tabindex",s);var c=this;let d=this.getFormat();r.data("AppUin",App.getUn()),n=n.v,r.val(this.getViewString(n));let f,p=t("<div>");this.dateTime&&/d/i.test(d)&&(f="date-popover");var h=t("<div></div>").appendTo(p);let u,m,b;h.on("dp.change",function(e){if(null!==e.oldDate||!c.dateTime||r.val()&&""!==r.val())r.val(e.date.format(d));else{let t=e.date,n=moment();t.format("HH:mm")===n.format("HH:mm")&&(t=t.hours(0).minutes(0)),r.val(t.format(d)),g()}}),r.on("keyup",function(e){u&&clearTimeout(u),13===e.keyCode?(g(),a(t(this),e)):27===e.keyCode?l(t(this),e):e.keyCode>=48&&(u=setTimeout(function(){g()},2e3))});const g=function(){"use strict";let e=r.val();e=e?moment(e,d):"";try{h.data("DateTimePicker").date(e)}catch(e){}};if(setTimeout(function(){let e=r.closest("td").find(".cdiv");if(e.length>0){let n=e.data("bs.popover");n&&(p.append(n.options.content),e.popover("destroy")),b=t("#"+App.popNotify({$text:p,element:e,container:c.pcTable._container,isParams:!0,placement:"bottom",class:f})),r.on("focus click",function(){b.show()})}else r.on("focus click",function(){b||(m=App.popNotify(p,r),b=t("#"+m)),h.data("DateTimePicker").show(),b.show(),g()})},20),r.on("blur",function(e){setTimeout(function(){b&&b.is(":visible")&&(b.hide(),g(),o(r,e))},200)}),h.datetimepicker({inline:!0,format:d,useCurrent:!1,showClose:!1,locale:"ru",sideBySide:!0,collapse:!1}),n)try{h.data("DateTimePicker").date(c.getMoment(n))}catch(e){}else r.val("");return r.data("calendar",h),r},getCellText:function(e){return e&&null!==e?this.getViewString(e):""},getViewString:function(e){return e?this.dateTime?App.dateTimeFormats.covertFromDb(e,this.getFormat()):App.dateFormats.covertFromDb(e,this.getFormat()):""},getDbString:function(e){return e?this.dateTime?App.dateTimeFormats.covertToDb(e,this.getFormat()):App.dateFormats.covertToDb(e,this.getFormat()):""},getMoment:function(e){return this.dateTime?moment(e,App.dateTimeFormats.db):moment(e,App.dateFormats.db)},addDataToFilter:function(e,t){let n;n=null===t.v?"null".hashCode():t.v.toString().hashCode();let i=this.dateTime?App.dateTimeFormats:App.dateFormats;e[n]="string"==typeof t.v?i.covertFromDb(t.v):t.v},getFormat:function(){let e=this.dateFormat;e||(e=this.dateTime?"d.m.y H:i":"d.m.y");let t={d:"DD",D:"ddd",j:"M",z:"DDD",W:"W",m:"MM",M:"MMM",n:"M",y:"YY",Y:"YYYY",H:"HH",i:"mm",s:"ss"},n="";for(let i=0;i<e.length;i++){let a=e[i];n+=t[a]||a}return n}},r.unic={icon:"fa-fire"},function(){const n=function(e,t){e.attr("data-fileviewpreview",JSON.stringify({name:t.name,file:t.file}))};r.file={icon:"fa-file-image-o",getSize:function(e){return e>102400?" "+(Math.round(e/1048576*10)/10).toLocaleString()+"Mb":" "+Math.round(e/1024).toLocaleString()+"Kb"},getCellText:function(e){if(!e||null===e||0==e.length)return"";let i=t('<span style=""></span>');const a=function(e){let a;-1!==["png","jpg"].indexOf(e.ext)?(a=t('<img src="/fls/'+e.file+'_thumb.jpg" style="z-index: 200; max-height: 24px; padding-right: 4px;" class="file-image-preview" data-filename="'+e.file+'"/>'),n(a,e)):a='<img src="/imgs/file_ico.png" style="max-height: 24px;  padding-right: 4px;"/>';let l=t('<a href="/fls/'+e.file+'"  class="file-sell-text" download="'+t("<div>").text(e.name).html()+'" style="padding-right: 5px"></a>');i.append(a),l.append(e.name),i.append(l)};return e.length&&e.forEach&&e.forEach(a),i.children()},getCopyText:function(t,n){if(!(t=t.v)||null===t||0==t.length)return"";let i=this,a="";return t.forEach(function(t){""!==a&&(a+="\n"),a+=t.name+" "+e.location.protocol+"//"+e.location.host+"/fls/"+t.file+" "+i.getSize(t.size)}),a},getPanelText:function(i){if(!i||null===i||0==i.length)return"";let a=t('<div class="file-mini-panel">'),l=this,o="",s=Math.random();return i.forEach(function(i){let r="",c="";-1!==["jpg","png"].indexOf(i.ext)&&(r=t('<img src="/fls/'+i.file+"_thumb.jpg?rand="+s+'"/>'),c="with-img",n(r,i)),t("<div>").addClass(c).appendTo(a).append(r).append(t('<br/><a href="/fls/'+i.file+'" download="'+t("<div>").text(i.name).html()+'">').text(i.name)).append(l.getSize(i.size)),""!==o&&(o+="\n"),o+=e.location.protocol+"//"+e.location.host+"/fls/"+i.file}),a.data("text",o)},getEditVal:function(e){if(this.required&&""==e.data("val"))throw"Поле должно быть заполнено";return e.data("val")},getEditElement:function(e,n,i,a,l,o,s,r){let c,d,f=this,p=this.pcTable,h=t("<div>"),u=t("<div>").css("min-height",200),m=n.v||[],b=!1;const g=function(e){let n=t('<div class="filePart"><div><span class="name"></span><span class="size"></span><button class="btn btn-danger btn-xs remove"><i class="fa fa-remove"></i></button></div></div>'),a={name:e.name,type:e.type,tmpfile:e.tmpfile,size:e.size,file:e.file,ext:e.ext},l=new RegExp("^"+f.pcTable.tableRow.id+"_"+(i.id?i.id:""));if(e.file&&!l.test(e.file)&&n.find(".remove").remove(),n.data("file",a),n.find(".name").text(e.name),n.find(".size").text(f.getSize(e.size)),e.file){let i=t("<a>").attr("href","/fls/"+e.file).attr("download",e.name);n.find(".name").wrap(i),-1!==["jpg","png"].indexOf(e.ext)&&(t("<img>").attr("src","/fls/"+e.file+"_thumb.jpg?rand="+Math.random()).insertBefore(n.find(".name")),n.addClass("with-img"))}else n.append('<div class="progressbar">&nbsp;</div>');if(e.tmpfile){n.addClass("addFile"),n.find(".progressbar").text("Требуется сохранение элемента для привязки файла")}return n},v=function(e){d.$modalFooter.find("button:first").prop("disabled",e)},_=function(){u.empty();let e=t('<input type="file" name = "file" '+(f.multiple?"multiple":"")+' accept="'+f.accept+'" style="display: block; position: absolute; top: -3000px"/>'),n=t("<div>").appendTo(u),i=t('<button class="btn btn-default btn-sm">Добавить файл'+(f.multiple?"ы":"")+"</button>");n.append(i),i.wrap('<div class="addFilesButton">'),i.wrap("<div>");let a=t('<div class="ttm-dropzone" id="ttmDropzone">Перетащите сюда файл</div>').insertAfter(i.parent());a.on("dragenter",()=>a.addClass("highlight")),a.on("dragleave",()=>a.removeClass("highlight")),a.on("drop",e=>{if(e.preventDefault(),a.removeClass("highlight"),!a.is(".disabled")){if(!this.multiple&&e.originalEvent.dataTransfer.files.length>1)return App.notify("Поле принимает только один файл","Ошибка"),!1;o(e.originalEvent.dataTransfer.files)}return!1});const l=function(){f.multiple||(u.find(".filePart").length>0?(i.prop("disabled",!0),a.addClass("disabled")):(i.prop("disabled",!1),a.removeClass("disabled")))},o=function(e){if(e){let n=[];v(!0);for(let i=0,a=e.length;i<a;i++){let a=e[i],o=g(a).addClass("addFile").appendTo(u);l();let s=o.find(".progressbar"),r=new XMLHttpRequest,c=t.Deferred();o.on("click",".remove",function(){o.remove(),r.abort(),c.resolve(),l()}),r.upload.onprogress=function(e){s.css("box-shadow","inset "+Math.round(parseInt(s.width())*e.loaded/e.total).toString()+"px 0px 0 0 #85FF82"),e.loaded===e.total&&s.text("Проверка файла сервером")},r.onload=r.onerror=function(e){if(c.resolve(),200===this.status)try{let e=JSON.parse(this.responseText);if(e.fname)return s.text("Готово"),void(o.data("file").tmpfile=e.fname)}catch(e){}o.data("file",null),s.text("Ошибка").css({"box-shadow":"none","background-color":"#ffe486"})},r.open("POST",p.model.getUri(),!0);let d=new FormData;d.append("file",a),d.append("method","tmpFileUpload"),d.append("ajax",!0),r.send(d),n.push(c.promise())}t.when(...n).then(function(){v(!1)})}};m.forEach(function(e){let t=g(e).appendTo(u);t.on("click",".remove",function(){t.remove(),l()})}),l(),i.on("click",function(){t("body").append(e),e.click(),e.on("change",function(){o(this.files)})})},w=function(e){let n=[];e.$modalContent.find(".filePart").each(function(){let e=t(this).data("file");e&&n.push(e)}),h.data("val",n),m=n,b=!0,a(h,{}),e.close()};c=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:w},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){a(h,{}),e.close()}}];let y="Форма файлов <b>"+this.title+"</b>",x="ctrlS.textdialog",k=function(e){d=f.pcTable.isMobile?App.mobilePanel(y,u,{buttons:c,onhide:function(n){t("body").off(x),b||l(e,n)},onshown:function(e){_(),t("body").on(x,function(t){w(e)})}}):BootstrapDialog.show({message:u,type:null,cssClass:"fieldparams-edit-panel",title:y,draggable:!0,buttons:c,onhide:function(n){t("body").off(x),b||l(e,n)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:600}),_(),t("body").on(x,function(t){w(e)})}})};if(r)k(h),h.text("Редактирование в форме").addClass("edit-in-form");else{h.on("focus click","button",function(){k(t(this).closest("div"))});let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактировать поле");s&&e.attr("tabindex",s),h.append(e)}return h.data("val",m)},getEditPanelText:function(e){return this.getCellTextInPanel(e.v).children()},getCellTextInPanel:function(e){let i=t('<div class="panel-preview"></div>');return e&&e.length&&e.forEach&&e.forEach(function(e){let a;-1!==["png","jpg"].indexOf(e.ext)?(a=t('<img src="/fls/'+e.file+'_thumb.jpg" />'),n(a,e)):a='<img src="/imgs/file_ico.png" />';let l=t("<div>"+a+'<a href="/fls/'+e.file+'" download="'+t("<div>").text(e.name).html()+'"></a></div>');l.find("a").append(e.name),i.append(l)}),i},isDataModified:function(e,t){return(-1===[null,""].indexOf(e)||-1===[null,""].indexOf(t))&&(-1!==[null,""].indexOf(e)||-1!==[null,""].indexOf(t)||!Object.equals(t,e))}}}(),r.n=t.extend({},r.default,{name:"n",width:52,title:"Порядок",category:"column",hidden:!0,showInWeb:!0,getCellText:function(e,n,i){let a=i.f||{};return n.addClass("n"),!i.id||a.block||a.blockOrder||i.__inserted?"":t('<span class="btns"><button class="btn btn-xxs btn-default"><i class="fa fa-angle-up"></i></button> <button class="btn btn-xxs btn-default"><i class="fa fa-angle-down"></i></button></span>')}}),r.listRow=t.extend({},r.default,{icon:"fa-code",isPanelField:!0,getPanelTextAsTable:function(e){if("object"==typeof e&&null!==e&&e.settings&&e.data&&e.settings.columns&&e.settings.columns.length){const n=t('<table class="json-table">');let i=e.settings,a=i.columns;try{if(i.headRow){const e=t("<tr>").appendTo(n);"boolean"==typeof i.headRow?a.forEach(function(n){t("<td>").text(n).appendTo(e).addClass("head")}):a.forEach(function(n){t("<td>").text(i.headRow[n]).appendTo(e).addClass("head")})}return e.data.forEach(function(e){const l=t("<tr>").appendTo(n);a.forEach(function(n){let i=e[n];"string"==typeof i&&""!==i||(i=JSON.stringify(i));t("<td>").text(i).appendTo(l)}),i.headColumn&&l.find("td:first").addClass("head")}),n}catch(e){console.log(e)}}},getPanelText:function(e,n,i){let a=t.Deferred(),l=this;const o=function(e){let n=l.getPanelTextAsTable.call(l,e);if(n)return n.copyText=JSON.stringify(e),void a.resolve(n);a.resolve(t("<div>").text(JSON.stringify(e,null,2)))};return"string"!=typeof e?o(e):this.getValue(e,i,!1).then(function(e){o(e.value)}).fail(function(){a.reject()}),a.promise()},getValue:function(e,n,i){"use strict";let a=t.Deferred();if(i||"filter"===this.category||"object"==typeof e||!e)return a.resolve({value:e}),a;{let e={fieldName:this.name};n.id&&(e.rowId=n.id),this.pcTable.model.getValue(e,this.table_id).then(function(e){a.resolve(e)})}return a},getEditElement:function(n,i,a,l,o,s,r,c){let d,f=this,p=t("<div>"),h=t("<div>").css("min-height",200),u=t('<div class="HTMLEditor">');i=i.v||"";let m=function(){f.getValue(i,a,!c).then(function(n){let i;p.append(u),u.empty().appendTo(h),i=new JSONEditor(u.get(0),{});try{""!==n.value&&i.setText(JSON.stringify(n.value))}catch(t){e.top.App.modal("Ошибка формата JSON ")}u.css("min-height",200);let a=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Вручную</a>').on("click",function(){let n=t("<div>"),a=t('<textarea class="form-control" style="height: 350px;">').val(JSON.stringify(i.get(),null,2)).appendTo(n),l="Ручное изменение json-поля",o=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:function(t){try{i.setText(a.val()),t.close()}catch(t){e.top.App.modal("Ошибка формата JSON")}}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];return f.pcTable.isMobile?App.mobilePanel(l,n,{buttons:o}):e.top.BootstrapDialog.show({message:n,type:null,title:l,draggable:!0,cssClass:"fieldparams-edit-panel",buttons:o,onhide:function(e){},onshown:function(t){t.$modalContent.position({of:e.top})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1});u.find(".jsoneditor-menu").append(a),u.data("editor",i)})};const b=function(e,t,n){p.data("val",u.data("editor").get()),n||(l(p,{}),e.close())};d=[];let g={label:"Сохранить",cssClass:"btn-m btn-warning",action:b},v={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){o(p,{}),e.close()}},_="Текст поля <b>"+this.title+"</b>",w="ctrlS.textedit";if(c){let n=!1;setTimeout(function(){let i=p.closest("td").find(".cdiv");i.length>0?(i.data("bs.popover").options.content.find(".btn").each(function(){let e=t(this),i={};i.label=e.data("name"),i.cssClass=e.attr("class").replace("btn-sm","btn-m"),i.icon=e.find("i").attr("class"),i.save=e.data("save"),i.click=e.data("click"),i.action=function(e){i.save&&b(e,0,!0),i.click({}),n=!0,e.close()},d.push(i)}),i.popover("destroy")):(d.push(g),d.push(v)),f.pcTable.isMobile?App.mobilePanel(_,h,{buttons:d,onhide:function(e){t("body").off(w),n||s(p,{})},onshown:function(e){m()},onshow:function(e){t("body").on(w,function(t){b(e)})}}):e.top.BootstrapDialog.show({message:h,type:null,title:_,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:d,onhide:function(e){t("body").off(w),n||s(p,{})},onshown:function(n){n.$modalContent.position({of:t(e.top.document.body),my:"top+50px",at:"top"}),m()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:900,maxWidth:"99vw"}),t("body").on(w,function(t){b(e)})}})},1),p.text("Редактирование в форме").addClass("edit-in-form")}else{p.on("focus click","button",function(){let n=d.splice();n.push(g),n.push(v);var i=t(this).closest("div");f.pcTable.isMobile?App.mobilePanel(_,h,{buttons:n,onhide:function(e){t("body").off(w),o(i,e)},onshown:function(e){m(),t("body").on(w,function(t){b(e)})}}):e.top.BootstrapDialog.show({message:h,type:null,cssClass:"fieldparams-edit-panel",title:_,draggable:!0,buttons:n,onhide:function(n){t(e.top.document.body).off(w),o(i,n)},onshown:function(n){n.$modalHeader.css("cursor","pointer"),m(),n.$modalContent.css({width:900,maxWidth:"99vw"}),t(e.top.document.body).on(w,function(e){b(n)})}})});let n=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактировать список/json");r&&n.attr("tabindex",r),p.append(n)}return p.data("val",i)},isDataModified:function(e,t){return""===e&&(e=null),""===t&&(t=null),t!==e&&!Object.equals(e,t)},getEditVal:function(e){return e.data("val")},getCellText:function(e){return"string"!=typeof e?JSON.stringify(e):e},getHighCelltext(e,t,n){return this.getCellText(e)},getEditPanelText(e){return this.getCellText(e.v)}}),r.password={icon:"fa-lock",getEditVal:function(e){var t=e.val().trim(),n=!1;if(void 0!==t&&""!==t&&null!==t||(notify="Поле "+this.title+" должно быть заполнено",n=!0),n)throw notify;return t},getCellText:function(e){return"**PASSWORD**"},getEditElement:function(e,n,i,a,l,o,s){var r=t('<input type="password" name="cell_edit" class="form-control" readonly autocomplete="off" autocorrect="off" placeholder="'+(n?"Поменять пароль":"Новый пароль")+'"/>');setTimeout(function(){r&&r.removeAttr("readonly")},2e3),r.on("save-me",function(e){a(t(this),e)}),s&&r.attr("tabindex",s);var c=this;n=n.v,r.on("keyup",function(e){switch(e.keyCode){case 13:try{r.data("enterClicked",!0),a(t(this),e)}catch(e){r.data("enterClicked",!1),App.popNotify(e,r,"default"),c.focusElement(r)}break;case 27:l(t(this),e)}});return r.one("blur",function(e){setTimeout(function(){!function(e){o(r,e)}(e)},50)}),r.select()}},r.select={icon:"fa-th-list",getEditVal:function(e){if(e.data("input")){var t=e.data("input").selectpicker("val");return null===t&&this.multiple&&(t=[]),t}},loadPreviewPanel(n,i,a,l){let o=t.Deferred();return n.html('<div class="center"><i class="fa fa-spinner fa-spin"></i></div>'),this.pcTable.model.loadPreviewHtml(i,a,l).then(function(i){if(n){let a=t("<div>");i.previews.forEach(function(n){let i=t('<div class="preview">');switch(n[2]){case"file":e.imgRand=e.imgRand||Math.random(),Array.isArray(n[1])&&n[1].forEach(function(n){-1!==["jpg","png"].indexOf(n.ext)&&i.append(t('<a href="/fls/'+n.file+'" target="_blank">').html('<img src="/fls/'+n.file+"_thumb.jpg?rand="+e.imgRand+'"/><br/>')),i.append(t('<a href="/fls/'+n.file+'" target="_blank">').text(n.name+" "+Math.round(n.size/1024).toLocaleString("ru-RU")+" Kb"))});break;case"html":i.text(n[0]);break;case"text":i.text(App.textWithLinks(n[1]));break;case"currency":case"number":if("currency"===n[2])try{i.text(parseFloat(n[1]).toLocaleString("ru-RU"))}catch(e){i.text(n[1])}else i.text(n[1]);n[3].unitType&&i.append(" "+n[3].unitType);break;case"url":i=t("<div>").append(t('<a target="_blank">').text(n[1]).attr("href",n[1]));break;default:i=t("<div>").text(n[1])}a.append(t('<div class="title">').text(n[0])),a.append(i)}),n.empty().append(a)}o.resolve()}).fail(function(){o.reject()}),o},previewPanel:function(e,n){let i=t('<div id="selectPanel" class="text preview" style="white-space: pre-wrap; height: 200px;">'),a={};a="column"===this.category?e.data("id")?this.pcTable._getItemById(e.data("id")):this.pcTable._insertItem:this.pcTable.data_params,n.popover({html:!0,content:i,trigger:"manual",container:"body",placement:"auto right",animation:!1}).popover("show");let l=t("#"+n.attr("aria-describedby")).css("z-index",1e4);const o=function(){n.attr("aria-describedby")&&l.length&&(n.off(".preview"),l.off(".preview"),l.remove())};n.on("mouseout.preview",function(){setTimeout(function(){l&&!l.is(":hover")&&o()},300)}),l.on("mouseout.preview",function(){l.is(":hover")||!n||n.is(":hover")||o()}),n.one("remove destroy",function(){n.attr("aria-describedby")&&n.popover("destroy")}),this.loadPreviewPanel(i,e.data("field"),a,e.data("val")).then(function(){const e=function(){n&&!n.height()?o():setTimeout(e,500)};e()})},getEditElement:function(n,i,a,l,o,s,r,c,d){"use strict";i||(i={});let f,p,h,u=this,m=(i=t.extend(!0,{},i)).v||null;if(u.multiple&&"string"==typeof m)try{m=JSON.parse(m)}catch(e){m=[]}n&&n.data("input")?((f=(p=n).data("input")).data("is-rendered",!0),h=f.data("LISTs")):(p=t("<div>"),h={isListForLoad:!0,innerList:[],innerIndexed:[],isSliced:!0,isPreview:!1},u.list&&(h=u.list));let b=function(e){let n=t.Deferred(),i={};return Object.keys(a).forEach(function(e){/^\$/.test(e)||("id"===e?i[e]=a[e]:null!==a[e]&&"object"==typeof a[e]&&-1!==Object.keys(a[e]).indexOf("v")?i[e]=a[e].v:i[e]=a[e])}),p.isAttached()&&p.append('<i class="fa fa-cog fa-spin fa-3x loading" style="position: absolute; z-index: 1    right: 1px;    top: 1px;    font-size: 8px;"/>'),u.pcTable.model.getEditSelect(i,u.name,e,null).then(function(t){p.find(".loading").remove(),h.innerList=t.list?t.list:[],h.innerIndexed=t.indexed?t.indexed:{},h.isSliced=t.sliced,h.isPreview=t.previewdata,u.codeSelectIndividual||null!==e&&""!==e&&void 0!==e||h.isSliced||(u.list=h,h.isListForLoad=!1),n.resolve()},function(){n.reject()}),n.promise()};setTimeout(function(){p.length&&p.isAttached()&&p.find(".mark-loading").length&&p.find(".mark-loading").html('<i class="fa fa-spinner"></i>')},200);let g=0;const v=function(){a[u.name]&&a[u.name].replaceViewValue&&h.innerIndexed[a[u.name].v]&&(a[u.name].replaceViewValue(h.innerIndexed[a[u.name].v]),delete a[u.name].replaceViewValue);let t=p.closest("body");if(t&&t.length){let i=t.get(0).ownerDocument==document?e.$:e.top.$;const c=function(e,t){let n={"Выбранное":i('<optgroup label="Выбранное">'),"":i('<optgroup label="">')},l=n["Выбранное"];const o=function(e,t,n,l){l=l?i('<small class="text-muted">').text(l):"";let o=i("<option>").text(e),s=i("<div>").text(null===t||""===t?"["+e+"]":t);if(l&&s.append(l),s=s.html(),n)o.attr("data-content",'<span class="text" style="text-decoration: line-through">'+s+"</span>");else{let t=i('<span class="text" >'+s+"</span>");h.isPreview&&(t.addClass("select-with-preview"),t.attr("data-id",a.id),t.attr("data-field",u.name),t.attr("data-val",e)),o.data("content",t.get(0).outerHTML)}return o};let s=function(){return!0};if(t&&""!==t){let e=t.toLowerCase().replace("ё","е").split(" ");s=function(t){let n=null!==t?t.toString().toLowerCase().replace("ё","е"):"";return!e.some(function(e){return-1===n.indexOf(e)})}}let r,c={};if(e||"filter"===u.category){const t=function(e){null===e&&(e="");let t,n=h.innerIndexed[e];return t=n?o(e,n[0],!1,n[1]):o(e,e,!0,null),l.append(t),c[e]=1,!!n&&(s(n[0])||t.addClass("hidden"),!0)};u.multiple?Array.isArray(e)?(e.forEach(t),r=Object.keys(c)):void 0!==e&&(t(e),r=[e]):(t(e),r=e)}if("onlyVals"!==t){u.multiple||u.withEmptyVal&&""!==u.withEmptyVal.trim()&&"filter"!==u.category&&n[""].append(i("<option>").data("content",u.withEmptyVal).text(""));for(let e in h.innerList){let t=h.innerList[e];if(1===c[t])continue;let a=h.innerIndexed[t];if(!h.isSliced&&!s(a[0]))continue;let l=o(t,a[0]),r=a[1]?a[1]:"";n[r]||(n[r]=i('<optgroup label="'+r+'">')),n[r].append(l)}}if(f.empty(),Object.keys(n).forEach(function(e){f.append(n[e])}),!0===h.isSliced){let e=o(0,"Данные не полны. Воспользуйтесь поиском!");e.prop("disabled",!0),e.css("text-align","center"),f.append(e)}return f.selectpicker("refresh"),f.selectpicker("val",r),r};if(!n||!n.data("input")){let e=!1;const t=function(){let t="-----";return"filter"===u.category?(t="Пустое",u.selectFilterWithEmptyText&&(t=u.selectFilterWithEmptyText)):u.withEmptyVal&&""!==u.withEmptyVal.trim()?t=u.withEmptyVal:u.multiple&&d&&d.closest(".InsertPanel").length&&(t="Выберите",e=!0),t};f=i('<select class="form-control" '+(1==u.multiple?"multiple ":"")+' data-size="auto" style="display: none;" name="cell_insert" data-style="btn-sm btn-default" data-width="css-width" data-live-search="true" data-title="'+t()+'">').width(u.width),e&&f.attr("data-selected-text-format","static"),p.append(f),p.append('<div class="text-center mark-loading"></div>'),r&&f.attr("tabindex",r),f.data("AppUin",App.getUn()),p.data("input",f),f.data("LISTs",h)}p.find(".mark-loading").remove();let g=0===f.closest(".modal-body").length?u.pcTable._container:f.closest(".modal-body");if(f.data("container",g),c(m),!f.data("is-rendered")){let e;f.data("selectpicker").$searchbox.off().on("click.dropdown.data-api focus.dropdown.data-api touchend.dropdown.data-api",function(e){e.stopPropagation()});let t="";f.data("selectpicker").$searchbox.on("keyup",function(n){if("Escape"===n.key)return f.data("selectpicker").$button.click(),!0;let a=i(this).val();t!==a&&(t=a,e&&clearTimeout(e),e=setTimeout(function(){h.isListForLoad||h.isSliced?b.call(u,a).then(function(){c.call(u,m,a)}):c.call(u,m,a)},750))});let n=i(u).closest("td, .cell");if(0===f.closest(".InsertRow, .InsertPanel").length){let e=f.data("container");f.on("remove",function(){e.off("click.selectContainer."+f.data("AppUin")),e.off("keydown.selectContainer."+f.data("AppUin"))}),e.on("click.selectContainer."+f.data("AppUin"),function(e){let t=i(e.target);t.closest("td").is(".editing")||t.closest(".bootstrap-select").length||s(p,e)}),e.on("keydown.selectContainer."+f.data("AppUin"),function(e){if(27===e.keyCode)return f.data("keyPressed","Esc"),o(p,e),!1;if(13===e.keyCode&&f.data("enterPressed",!0),9!==e.keyCode&&16!==e.keyCode&&n.data("edited"),e.altKey||e.shiftKey){let t=e.altKey?"altKey":!!e.shiftKey&&"shiftKey";f.data("keyPressed",t)}}).on("keyup",function(e){f.removeData("keyPressed"),f.removeData("enterPressed")}),p.find("button").click()}f.on("hidden.bs.select",function(){let e=f.data("changed"),t={},n=f.data("keyPressed");n&&(t[n]=!0),u.multiple?e&&0===f.closest("td.edt").length&&l(p,t):setTimeout(function(){l(p,t)},200),f.data("changed",!1)}),f.on("show.bs.select",function(){c(m)}),f.on("shown.bs.select",function(){let e=f.data("selectpicker");e.$bsContainer.addClass("pcTable-selectpicker"),h.isPreview&&e.$bsContainer.addClass("select-with-preview"),e.$menuInner.height()<100&&e.$menuInner.find("li").length>6&&e.$menuInner.height(300),e.cropped||(e.cropped=!0,f.data("container").is(".pcTable-container")&&e.$menuInner.height(e.$menuInner.height()-4))}),f.on("changed.bs.select",function(){f.data("changed",!0);let e=[];if(m&&m.forEach&&m.forEach(function(t){e.push(t)}),m=f.val(),"filter"===u.category&&u.multiple){let t=m.length;if(e.length>m.length)0===m.length&&m.push("*NONE*");else{let t;m.some(function(n){if(-1===e.indexOf(n))return t=n,!0}),-1!==["*NONE*","*ALL*"].indexOf(t)?m=[t]:["*NONE*","*ALL*"].some(function(e){let t;if(-1!==(t=m.indexOf(e)))return m.splice(t,1),!0})}m.length!==t&&f.selectpicker("val",m)}}),f.on("remove",function(){f.data("selectpicker").$bsContainer.remove(),f.data("container").off("keydown.selectContainer."+f.data("AppUin")).off("click.selectContainer."+f.data("AppUin"))})}}else g<50&&(setTimeout(function(){v(f,m)},10*g+1),g++)};return!h||h.isListForLoad?b().then(function(){v.call(u)}):v(),p},getEditPanelText:function(e,t){if(this.multiple)return this.getPanelText(e.v,null,t)},getPanelText:function(e,n,i){let a=this,l=t("<div>"),o=i[a.name].v_;if(!a.multiple&&i[a.name].v_&&(o=[i[a.name].v_]),o)t.each(o,function(e,n){"use strict";let i=t("<div>").text(n[0]);n[1]?i.addClass("deleted_value"):1!==o.length&&i.add("select-item"),l.append(i)});else{if(null===e||""===e)return a.withEmptyVal?a.withEmptyVal:"";let n=e;if(a.multiple||(n=[n]),n||(n=[]),a.list){let e=[];for(let t=0;t<n.length;t++)e[t]=n[t].toString();for(let n=0;n<a.list.length;n++){let i=a.list[n];if(-1!==e.indexOf(i[2].toString())){let n=t("<span>").text(i[0]);i[1]?n.addClass("deleted_value"):1!==e.length&&n.add("select-item"),l.append(n)}}}}return l.children()},getCellText:function(e,n,i){let a=this,l=t("<div>"),o=i[a.name].v_;if(!a.multiple&&i[a.name].v_&&(o=[i[a.name].v_]),o)a.multiple&&o.length>1&&0==a.multySelectView?l.append('<span class="select-item">'+o.length+" элементов<span>"):0===o.length?l.append('<span class="select-item">'+this.getElementString(null)+"</span>"):t.each(o,function(n,i){"use strict";let s=t("<span>"),r=null;e&&(r="object"==typeof e?e[n]:e),s.text(a.getElementString(r,i)),i[1]?s.addClass("deleted_value"):1!==o.length&&s.add("select-item"),l.append(s)});else{if(null===e||""===e)return a.withEmptyVal?a.withEmptyVal:"";let n=e;if(a.multiple||(n=[n]),n||(n=[]),a.list){let e=[];for(let t=0;t<n.length;t++)e[t]=n[t].toString();for(let n=0;n<a.list.length;n++){let i=a.list[n];if(-1!==e.indexOf(i[2].toString())){let n=t("<span>").text(a.getElementString(i[2],i));i[1]?n.addClass("deleted_value"):1!==e.length&&n.add("select-item"),l.append(n)}}}}return l.children()},focusElement:function(e){let t=e.find("button"),n=this;0==t.length?setTimeout(function(){n.focusElement(e)},50):t.focus()},isDataModified:function(e,t){return(-1===[null,""].indexOf(e)||-1===[null,""].indexOf(t))&&(-1!==[null,""].indexOf(e)||-1!==[null,""].indexOf(t)||!Object.equals(t,e))},checkIsFiltered:function(e,t){let n,i;return this.multiple?(n=[],e&&e.v_&&e.v_.length&&e.v_.forEach(function(e){n.push(e[0].hashCode().toString())}),i=function(e){if(-1!==n.indexOf(e))return!0}):(n=(n=null===e.v_[0]?"null":e.v_[0].toString()).hashCode().toString(),i=function(e){if(e===n)return!0}),t.some(i)},checkEditRegExp:function(e){if(!this.warningEditRegExp)return!0;try{return this.multiple&&Array.isArray(e)?e.some(t=>new RegExp(this.warningEditRegExp).test(e)):new RegExp(this.warningEditRegExp).test(e)}catch(e){return!0}},addDataToFilter:function(e,t){const n=function(t){let n,i=t[0];null===i?n="null".hashCode():(n=i.toString().hashCode(),i=i.replace(/"/g,"&quot;")),e[n]=i};this.multiple?t&&t.v_.length&&t.v_.forEach(function(e){n(e)}):n(t.v_)},getElementString:function(e,t){"use strict";return null!==e&&void 0!==e||t&&t[0]?null===t[0]||""===t[0]?"["+(this.withEmptyVal||"")+"]":t[0]:this.withEmptyVal||""}},r.tree={icon:"fa-tree",FullView:!1,getEditVal:function(e){return e.data("val")},getEditElement:function(e,n,i,a,l,o,s,r){let c,d,f=this,p=e||t("<div>"),h=p.data("dialog")||t("<div>").css("min-height",200);p.data("dialog",h),n=n.v||"";let u=function(e){f.treePanel.call(f,h,i,n,a,l)};const m=function(e,t,n){let i=[];h.data("jstree").jstree("get_selected",!0).forEach(function(e){i.push(e.id)}),f.multiple||(i=i[0]||""),p.data("val",i),n||(a(p,{}),e.close())};c=[];let b={label:"Сохранить",cssClass:"btn-m btn-warning",action:m},g={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){l(p,{}),e.close()}},v="<b>"+this.title+"</b>",_="ctrlS.commentdialog";const w=function(e){f.pcTable.isMobile||(e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:.8*t("body").width()>800?800:.8*t("body").width()})),0===e.$modalBody.find("textarea").length&&u(),t("body").on(_,function(t){m(e,0,!1)})};if(r){let e=!1;setTimeout(function(){let n=p.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each(function(){d=t(this);let n={};n.label=d.data("name"),n.cssClass=d.attr("class").replace("btn-sm","btn-m"),n.icon=d.find("i").attr("class"),n.save=d.data("save"),n.click=d.data("click"),n.action=function(t){n.save&&m(t,0,!0),n.click({}),e=!0,t.close()},c.push(n)}),n.popover("destroy")):(c.push(b),c.push(g)),f.pcTable.isMobile?App.mobilePanel(v,h,{buttons:c,onhide:function(n){t("body").off(_),e||o(p,{})},onshow:w}):BootstrapDialog.show({message:h,type:null,title:v,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:c,onhide:function(n){t("body").off(_),e||o(p,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"})},onshow:w})},1),p.text("Редактирование в форме").addClass("edit-in-form")}else{let e=!1;p.off().on("focus click","button",function(){if(e)return!1;e=!0;let n=c.slice(0);n.push(b),n.push(g);var i=t(this).closest("div");f.pcTable.isMobile?App.mobilePanel(v,h,{buttons:n,onhide:function(n){e=!1,t("body").off(_),l(i,n)},onshow:w}):BootstrapDialog.show({message:h,type:null,cssClass:"fieldparams-edit-panel",title:v,draggable:!0,size:BootstrapDialog.SIZE_WIDE,buttons:n,onhide:function(n){e=!1,t("body").off(_),l(i,n)},onshow:w})}),0===p.find("button").length&&(d=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактирование в форме"),s&&d.attr("tabindex",s),p.append(d))}return p.data("val",n)},treePanel:function(e,n,i,a,l,o){let s=this,r=["themes","json_data","search"];s.multiple&&r.push("checkbox");let c=t('<div class="tree-search"><input class="form-control" type="text"></div>'),d=c.find("input");setTimeout(function(){d.focus()},200);let f=t("<div></div>"),p=0,h=!1,u="";d.keyup(function(){h&&clearTimeout(h),h=setTimeout(function(){if(f.closest("body").length){let e=d.val();u!==e&&(u=e,f.jstree(!0).search(e,0===p))}},750)}),e.html(c).append(f),e.data("jstree",f),!this.multiple&&this.withEmptyVal&&f.on("click",'li.jstree-node[aria-selected="true"]',function(e){return f.jstree(!0).deselect_node(t(this)),!1}),f.on("init.jstree",function(e,t){t.instance.settings.checkbox.cascade=""}).jstree({search:{show_only_matches:!0,case_insensitive:!0,show_only_matches_children:!0,search_callback:function(e,t){if(!t)return!1;let n=e.toLowerCase().replace("ё","е").split(" "),i=t.text.toLowerCase().replace("ё","е");return!n.some(function(e){return-1===i.indexOf(e)})},ajax:function(e,t){var i=this;s.getEditSelect(n,e,null).then(function(e){t.call(i,e[0])})}},massload:function(e,t){var i=this;p-=1,s.getEditSelect(n,"",e).then(function(e){Object.values(e[0]).forEach(function(e){e.forEach(function(e){!0===e.children&&(p+=1)})}),t.call(i,e[0])})},core:{check_callback:!0,open_parents:!0,data:function(e,t){var i=this;p-=1,s.getEditSelect(n,"","#"==e.id?null:e.id).then(function(e){e[0].forEach(function(e){!0===e.children&&(p+=1)}),t.call(i,e[0])})},themes:{icons:!1,name:"default"}},checkbox:{},plugins:r}),s.multiple&&"filter"===s.category&&f.on("select_node.jstree",function(e,t){-1!==["*ALL*","*NONE*"].indexOf(t.node.id)?t.selected.length>1&&t.selected.forEach(function(e){e!==t.node.id&&t.instance.deselect_node(f.jstree(!0).get_node(e))}):["*ALL*","*NONE*"].forEach(function(e){-1!==t.selected.indexOf(e)&&t.instance.deselect_node(f.jstree(!0).get_node(e))})})},getEditPanelText(e,t){return this.getCellText(e.v,null,t)},getEditSelect:function(e,n,i){let a=this,l=t.Deferred(),o={};return Object.keys(e).forEach(function(t){/^\$/.test(t)||("id"===t||null===e[t]||"object"!=typeof e[t]||-1===Object.keys(e[t]).indexOf("v")?o[t]=e[t]:o[t]=e[t].v)}),this.pcTable.model.getEditSelect(o,this.name,n,i,!0).then(function(e){let t=[e.list,e.indexed];a.codeSelectIndividual||(a.list=t),l.resolve(t)}),l},getPanelText:function(e,t,n){this.FullView=!0;let i=this.getCellText(e,t,n);return delete this.FullView,i},getCellText:function(e,n,i){let a=this,l=i[a.name].v_;if(e){if(a.multiple){if(Array.isArray(e)){if(0===e.length)return a.getElementSpan(null);if(1===e.length)return a.getElementSpan(e[0],l[0]);if("0"!==a.multySelectView||a.FullView){let n=t('<span class="select-item">');return e.forEach((e,t)=>n.append(a.getElementSpan(e,l[t]))),n}return t('<span class="select-item">'+e.length+" эл.<span>")}return a.getElementSpan(e,[e,0])}return a.getElementSpan(e,l)}return a.getElementString(null)},checkIsFiltered:function(e,t){let n,i;return this.multiple?(n=[],e&&e.v_&&e.v_.length&&e.v_.forEach(function(e){n.push(e[0].hashCode().toString())}),i=function(e){if(-1!==n.indexOf(e))return!0}):(n=(n=null===e.v_[0]?"null":e.v_[0].toString()).hashCode().toString(),i=function(e){if(e===n)return!0}),t.some(i)},addDataToFilter:function(e,t){const n=function(t){let n;n=null===t[0]?"null".hashCode():t[0].toString().hashCode(),e[n]=t[0].replace(/"/g,"&quot;")};this.multiple?t&&t.v_.length&&t.v_.forEach(function(e){n(e)}):n(t.v_)},getElementSpan:function(e,n){let i=t("<span>");return null!==e&&(i.text(this.getElementString(e,n)),1===n[1]&&i.addClass("deleted_value")),i},getElementString:function(e,t){"use strict";return null!==e&&void 0!==e||t&&t[0]?null===t[0]||""===t[0]?"["+(this.withEmptyVal||"")+"]":this.FullView&&t[2]||t[0]:this.withEmptyVal||""}},r.json={__addInput:function(e,n,i){var a=(n=n||{}).type||typeof i[e],l=12;"checkbox"==a&&(l=3),n.width&&(l=n.width);var o,s=t('<div class="field form-group">').attr("data-name",e).addClass("col-sm-"+l);switch(a){case"string":o=t("<input>").val(i[e]?i[e]:n.default?n.default:"");break;case"json":o=t('<div class="JSONEditor">').height(300);var r=new JSONEditor(o.get(0),{}),c=t('<a href="#">editText</a>').on("click",function(){var e=t("<div>"),n=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(r.get(),null,2)).appendTo(e);return e.dialog({title:"Содержимое JSON-поля",width:500,height:600,buttons:{"Сохранить":function(){r.setText(n.val()),e.dialog("close")},"Закрыть":function(){e.dialog("close")}}}),!1});o.find(".jsoneditor-menu").append(c),o.data("editor",r),r.set(i[e]?i[e]:n.default?JSON.parse(n.default):{});break;case"html":o=t('<div class="HTMLEditor">').height(300);var d=t("<div>").appendTo(o);r=CodeMirror(d.get(0),{value:i[e]?i[e]:n.default?n.default:"",mode:"text/html",height:"250px",readOnly:!1,theme:"eclipse",lineNumbers:!0,gutter:!0,indentWithTabs:!0,autoCloseTags:!0});setTimeout(function(){r.refresh()},20),o.data("editor",r);break;case"integer":o=t("<input>").val(i[e]?i[e]:n.default?n.default:"").attr("type","number"),void 0!==n.min&&o.attr("min",n.min),void 0!==n.max&&o.attr("max",n.max),void 0!==n.step&&o.attr("step",n.step);break;case"checkbox":o=t("<input>").attr("type","checkbox"),i[e]?o.prop("checked",!0):void 0===i[e]&&o.prop("checked",!0);break;case"select":o=t("<select>"),n.values&&t.each(n.values,function(e,n){o.append(t("<option>").attr("value",e).text(n))}),i[e]?o.val(i[e]):void 0===i[e]&&n.default&&o.val(n.default)}"checkbox"==a?(s.prepend(t("<label>").text(n.title?n.title:e).addClass("form-check-label")),o&&(o.data("type",a),s.find("label").prepend(o))):(s.prepend(t("<label>").text(n.title?n.title:e)),o&&o.data("type",a).addClass("form-control"),s.append(o)),s.data("type",a);var f=t(" <span>*</span>");return n.required?f.addClass("text-danger"):(f.text(""),f.addClass("glyphicon glyphicon-remove remove"),f.on("click",function(){var e=t(this).closest(".field");e.data("name");e.remove()})),s.find("label").after(f),s},getEditElement:function(e,n,i,a,l,o){var s,r=this,c=t("<div>"),d=t("<div>").css("min-height",200),f=t('<div class="jsonForm row">').appendTo(d);c.data("form",f),c.data("field",this);var p=this.jsonFields,h=n||{};"string"==typeof h&&(h=JSON.parse(h));var u=function(e){var t=r.__addInput(e,p[e],h);f.append(t)},m=t.extend({},h),b=0,g={"":[]};if(t.each(p,function(e,t){if(1==t.required||1==t.showInForm)u(e),void 0!==m[e]&&delete m[e];else if(void 0===m[e]){var n="";t.fGroup&&(n=t.fGroup,g[t.fGroup]||(g[t.fGroup]=[])),g[n].push(e),b++}}),t.each(m,function(e,t){u(e)}),b){var v=t('<div class="row elseFields">');let e=t('<select class="selectpicker form-control dropup" data-size="5" data-title="--Выбрать поле--">');1==App.keys(g).length?t.each(g[App.keys(g)[0]],function(n,i){e.append(t("<option>").attr("value",i).text(p[i].title?p[i].title:i))}):t.each(g,function(n,i){n=t('<optgroup label="'+n+'">');t.each(i,function(e,i){n.append(t("<option>").attr("value",i).text(p[i].title?p[i].title:i))}),e.append(n)}),v.prepend(t("<label>").text("Добавить поле")),e.addClass("form-control"),v.append(e),e.selectpicker("render"),e.on("change",function(){var n=t(this).val();e.find('option[value="'+n+'"]').remove(),u(n)}),d.append(v.wrap('<div style="padding:10px">').parent())}return s={"Сохранить":function(){var e={},n=f.find(".fullJSONEditor");1==n.length?e=n.data("editor").get():f.find("input, select, textarea, .JSONEditor, .HTMLEditor").not(".JSONEditor *").not(".HTMLEditor *").each(function(){var n=t(this),i=n.closest(".field").data("name");switch(n.closest(".field").data("type")){case"array":try{if(e[i]=n.data("editor").get(),!t.isArray(e[i]))throw"Ошибка структуры поля"}catch(e){throw App.notify("Ошибка структуры поля "+i),"Ошибка структуры поля"}break;case"object":case"json":try{if(e[i]=n.data("editor").get(),"object"!=typeof e[i])throw"Ошибка структуры поля"}catch(e){throw App.notify("Ошибка структуры поля "+i),"Ошибка структуры поля"}break;case"html":e[i]=n.data("editor").getValue();break;case"checkbox":case"boolean":e[i]=!!n.is(":checked");break;case"integer":e[i]=parseInt(n.val());break;default:e[i]=n.val()}}),c.data("val",JSON.stringify(e)),a(c,event),d.remove()},"Закрыть":function(){d.dialog("close")},"Редактор":function(){var e=f.height(),n=t('<div class="fullJSONEditor">').height(e+100),i=new JSONEditor(n.get(0),{});i.set(h);var a=t('<a href="#">editText</a>').on("click",function(){var n=t("<div>"),a=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(i.get(),null,2)).appendTo(n);return n.dialog({title:"Содержимое JSON-поля",width:500,height:e+100,buttons:{"Сохранить":function(){i.setText(a.val()),n.dialog("close")},"Закрыть":function(){n.dialog("close")}}}),!1});f.empty().append(n),f.next().empty(),n.data("editor",i),n.find(".jsoneditor-menu").append(a)}},i.id?(d.dialog({title:(i&&i.id?i.id:"")+" "+this.title,width:700,modal:!0,close:function(e){l(c,e),d.remove()},buttons:s}),c.text("Редактирование в форме").addClass("edit-in-form")):(c.on("focus click","button",function(){var e=t(this).closest("div");d.dialog({title:r.title||r.name,width:700,modal:!0,close:function(t){l(e,t),d.remove()},buttons:s})}),c.append(t('<button class="btn btn-default">').text(n||"Редактирование"))),c.data("val",n)},getEditVal:function(e){return e.data("val")},getCellText:function(e){return JSON.stringify(e)},focusElement:function(e){var t=e.find("button"),n=this;0===t.length?setTimeout(function(){n.focusElement(e)},50):t.focus()}},r.fieldParams=t.extend({},r.json,{icon:"fa-code",isPanelField:!0,isDataModified:function(e,t){return!Object.equals(t,e)},getEditElement:function(n,i,a,l,o,s,r,c){let d,f=this,p=t("<div>"),h=t("<div>").css("min-height",200),u=t('<div class="jsonForm">').appendTo(h);p.data("form",u),p.data("field",this);let m=function(e){let n=f.jsonFields;f.getValue(e,a,!c).then(function(e){let i=e.value;"string"==typeof i&&(i=JSON.parse(i));let l=t.extend({},i),o=function(e,t,i){let o=n.fieldSettings[e];if(!o)return!1;if(o.categories&&-1===o.categories.indexOf(a.category.v))return!1;let s={};switch(void 0===l[e]||void 0===l[e].isOn?(s.isOn=void 0!==l[e],s.Val=l[e],void 0===s.Val&&(s.Val=o.default),o.parent||"checkbox"!==o.type||!0!==s.Val||(s.isOn=!0),l[e]=s):s=l[e],e){case"codeSelect":let t="=: selectRowListForTree(table: ''; field: ''; order: '' asc; where:  '' = ; parent: ''; disabled:)";"tree"===u.find('div[data-name="type"] select').val()?s.Val===o.default&&(s.Val=t):s.Val===t&&(s.Val=o.default)}let r=!1,c=(n.fieldSettings[o.parent],l[o.parent]);o.parent&&-1!==t.indexOf(o.parent)&&(c&&!0===c.isOnCheck||(r=!0)),s.changed=function(){"use strict";!0===this.isOnCheck?u.find('[data-parent="'+e.toLowerCase()+'"]').show():u.find('[data-parent="'+e.toLowerCase()+'"]').hide().find('input[type="checkbox"]').prop("checked",!1).trigger("change")};let d=f.__addInput.call(f,e,o,s,a);u.append(d),o.parent&&(d.attr("data-parent",o.parent.toLowerCase()),r&&d.hide());let p=i[e]();return d.css("padding-left",19*p),d},s="string";l.type&&(s=l.type.Val||l.type);let r=function(){h.find(".codeEditor, .HTMLEditor").each(function(){t(this).data("editor")&&t(this).data("editor").refresh()})};!async function e(i){let s;u.empty(),"2"===a.table_id.v&&("data_src"===a.name.v||"data"===a.name.v)||a.table_name&&"tables_vidgets"===a.table_name.v&&("data_src"===a.name.v||"data"===a.name.v)?(s="data"===a.name.v?["width","showInWeb"]:["width","jsonFields","showInWeb","editable","insertable","required","logging","default","copyOnDuplicate"],i="fieldParams"):s=n.fieldListParams[i],"chart"===i&&(f.pcTable.chartTypes||(f.pcTable.chartTypes=(await f.pcTable.model.getChartTypes()).chartTypes),n.fieldSettings.chartType.values={},f.pcTable.chartTypes.map(e=>{n.fieldSettings.chartType.values[e.type]=e.title}));let c={type:function(){return 0}};s.forEach(function(e){let t=n.fieldSettings[e];t.parent&&-1!==s.indexOf(t.parent)?c[e]=function(){return c[t.parent]()+1}:c[e]=function(){return 0}}),l.type={isOn:!0,Val:i},o("type",s,c).find("select").on("change",function(){e(t(this).val())}),s.forEach(function(e){o(e,s,c)}),r()}(s)})},b=!1;const g=function(e){var n={},i=u.find(".fullJSONEditor");1===i.length?n=i.data("editor").get():u.find("input, select, textarea, .JSONEditor, .HTMLEditor, .codeEditor").not(".JSONEditor *").not(".HTMLEditor *").not(".codeEditor *").not('input[data-type="switcher"]').each(function(){var e=t(this);let i,a=e.closest(".field");var l=a.data("name");switch(e.closest(".field").data("type")){case"code":i=e.data("editor").getValue();break;case"json":try{if("object"!=typeof(i=e.data("editor").get()))throw"Ошибка структуры поля"}catch(e){throw App.notify("Ошибка структуры поля "+l),"Ошибка структуры поля"}break;case"html":i=e.data("editor").getValue();break;case"checkbox":i=!!e.is(":checked");break;case"integer":i=parseInt(e.val());break;default:i=e.val()}let o;isOnCheckbox=a.find('input[data-type="switcher"]'),o=0===isOnCheckbox.length?e.is(":visible"):isOnCheckbox.is(":checked"),n[l]={isOn:o,Val:i}}),p.data("val",n),l(p,event),b=!0,e.close()};d=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:g},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];let v="ctrlS.FieldParams";if(c)e.top.BootstrapDialog.show({message:h,type:BootstrapDialog.TYPE_DANGER,title:"Параметры поля <b>"+a.title.v+"</b>",buttons:d,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){b||o(p,e),t("body").off(v)},onshown:function(e){m(i.v),e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalDialog.width(1e3),t("body").on(v,function(t){g(e)})}}),p.text("Редактирование в форме").addClass("edit-in-form");else{let n=!1;p.on("focus click","button",function(){if(!n){n=!0;var l=t(this).closest("div");e.top.BootstrapDialog.show({message:h,type:BootstrapDialog.TYPE_DANGER,cssClass:"fieldparams-edit-panel",title:"Параметры поля <b>"+a.title.v+"</b>",buttons:d,draggable:!0,size:BootstrapDialog.SIZE_WIDE,onhide:function(e){o(l,e),t("body").off(v),n=!1},onshown:function(e){e.$modalDialog.width(1e3),e.$modalHeader.css("cursor","pointer"),m(i.v),t("body").on(v,function(t){g(e)})}})}});let l=t('<button class="btn btn-danger btn-sm text-edit-button">').text("Редактировать параметры");r&&l.attr("tabindex",r),p.append(l)}return p.data("val",i.v)},__addInput:function(n,i,a,l){let o=this;var s=(i=i||{}).type;let c,d;c=a.Val,d=a.isOn;var f,p=t('<div class="field form-group">').attr("data-name",n);let h,u=t("<span>").text(i.title?i.title:n);switch(s){case"code":f=t('<div class="codeEditor">');var m=t("<div>").appendTo(f);(b=CodeMirror(m.get(0),{value:c||(i.default?i.default:""),mode:"totum",height:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,gutter:!1,indentWithTabs:!0})).getScrollerElement().style.minHeight="150px",f.data("editor",b),b.table=l.table_name&&l.table_name.v?l.table_name.v:null;break;case"string":f=t("<input>").val(void 0!==c?c:i.default?i.default:"");break;case"json":f=t('<div class="JSONEditor">').height(500);var b=new JSONEditor(f.get(0),{}),g=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Вручную</a>').on("click",function(){var n=t("<div>"),i=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(b.get(),null,2)).appendTo(n);return BootstrapDialog.show({message:n,type:null,title:"Ручное изменение json-поля",buttons:[{label:"Сохранить",cssClass:"btn-m btn-warning",action:function(t){try{b.setText(i.val()),t.close()}catch(t){e.top.App.modal("Ошибка формата JSON")}}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){},onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1});if(f.find(".jsoneditor-menu").append(g),"chartOptions"===n){let e=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Заполнить настройками по умолчанию</a>');e.on("click",()=>{let e=t('div[data-name="chartType"] select').val();return o.pcTable.chartTypes.some(t=>{if(t.type==e)return b.setText(JSON.stringify(t.default_options)),!0}),!1}),f.find(".jsoneditor-menu").append(e)}f.data("editor",b);let a="string"==typeof c?JSON.parse(c):c;b.set(a);break;case"html":f=t('<div class="HTMLEditor">');m=t("<div>").appendTo(f);(b=CodeMirror(m.get(0),{value:c||(i.default?i.default:""),mode:"text/html",height:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0})).getScrollerElement().style.minHeight="150px",f.data("editor",b);break;case"integer":f=t("<input>").val(void 0!==c?c:i.default?i.default:"").attr("type","number"),void 0!==i.min&&f.attr("min",i.min),void 0!==i.max&&f.attr("max",i.max),void 0!==i.step&&f.attr("step",i.step);break;case"checkbox":f=t("<input>").attr("type","checkbox").data("type",s),c&&f.prop("checked",!0);break;case"select":if(f=t("<select>"),i.values){let e,a=i.valIcons||{};i.valuesOrder&&(e=i.valuesOrder.slice(0)),"type"===n&&(l.table_name&&l.name&&"tables_fields"===l.table_name.v&&"data_src"===l.name.v&&(e=["fieldParams"]),t.each(e,function(e,t){r[t]&&(a[t]="fa "+r[t].icon)}));const o=function(e,n){let i=t("<option>").attr("value",e).text(n);a[e]&&i.data("icon",a[e]),f.append(i)};e?e.forEach(function(e){o(e,i.values[e])}):t.each(i.values,o)}i.multiple&&(f.attr("multiple","multiple"),f.attr("size","2")),setTimeout(function(){f.selectpicker()},20),c?f.val(c):void 0===c&&i.default&&f.val(i.default)}return a.isOnCheck=!0,"checkbox"===s?(p.prepend(t('<label class="field-param-lable">').html(u).addClass("form-check-label").prepend(f).append('<a href="http://docs.totum.online/polya#fields-settings-'+n+'" target="_blank"><i class="fa fa-question-circle-o"></i></a>')),p.addClass("checkbox"),h=f,f.is(":checked")||(a.isOnCheck=!1,p.addClass("disabled"))):(p.prepend(t('<label class="field-param-lable">').html(u).append('<a href="http://docs.totum.online/polya#fields-settings-'+n+'" target="_blank"><i class="fa fa-question-circle-o"></i></a>')),f&&(f.data("type",s),f.data("editor")||f.addClass("form-control"),p.append(f)),!0!==i.required&&(h=t('<input type="checkbox" data-type="switcher"/>'),d?(a.isOnCheck=!0,h.prop("checked",!0)):(a.isOnCheck=!1,p.addClass("disabled")),p.find("label").prepend(h).addClass("switcheble"),p.addClass("checkbox"))),h&&h.on("change",function(){t(this).is(":checked")?!0!==a.isOnCheck&&(a.isOnCheck=!0,p.removeClass("disabled"),a.changed()):!1!==a.isOnCheck&&(a.isOnCheck=!1,p.addClass("disabled"),a.changed())}),p.data("type",s),p},getValue:function(e,n,i){"use strict";if(i){let n=t.Deferred();return n.resolve({value:e||{}}),n}let a={fieldName:this.name};return n.id&&(a.rowId=n.id),this.pcTable.model.getValue(a,this.table_id)},getPanelText:function(e){return JSON.stringify(e,null,2)},getCellText:function(e){return"Настройки поля"}}),r.button={icon:"fa-hand-pointer-o",getPanelText:function(e,t,n){let i=this.getCellText(e,t,n);return i.on("click",()=>(this.pcTable.selectedCells.empty(),this.pcTable.selectedCells.selectPanelDestroy(),this.pcTable._buttonClick(t,this,n),!1)),i.wrap("<div>"),i.parent()},getCellText:function(e,n,i){let a=this,l={};"column"===this.category?i.id?l=t.extend({},a.pcTable.f||{},i.f||{},i[a.name].f||{}):(l.block=!0,i[a.name].f&&i[a.name].f.icon&&(l.icon=i[a.name].f.icon)):l=t.extend({},a.pcTable.f||{},i[a.name].f||{}),n&&n.addClass("cell-button");const o=function(e){if(a.td_style&&"function"==typeof a.td_style){let t=a.td_style(l).Button;t&&e.css(t)}else if(a.pcTable.isMobile&&"column"!==a.category){let t={};l.background&&(t.backgroundColor=l.background),l.color&&(t.color=l.color),e.css(t)}};if(l.block||!this.pcTable.control.editing&&!this.pressableOnOnlyRead){let e=t('<button class="btn btn-default btn-xxs button-field" tabindex="-1" disabled>').text(this.buttonText||"");if(o(e),l.text&&e.text(l.text),l.comment){let n;n=t('<i class="cell-icon fa fa-info"></i>'),e.prepend(n),n.attr("title",l.comment)}else if(l.icon){let n=t('<i class="cell-icon fa fa-'+l.icon+'"></i>');e.prepend(n),""===e.text()&&(e.css("text-align","center"),n.css("float","none"))}return e}let s=t('<button class="btn btn-default btn-xxs button-field" tabindex="-1">').text(this.buttonText||"");if(o(s),l.text&&s.text(l.text),l.comment){let e;e=t('<i class="cell-icon fa fa-info"></i>'),s.prepend(e),e.attr("title",l.comment)}else if(l.icon){let e=t('<i class="cell-icon fa fa-'+l.icon+'"></i>');s.prepend(e),""===s.text()&&(s.css("text-align","center"),e.css("float","none"))}return s},btnOK:function(e){let t=e.find("button.button-field"),n=this;t.text("Выполнено"),e.data("clicked",!0),setTimeout(function(){e.removeData("clicked");let i=n.pcTable._getItemBytd.call(n.pcTable,e);t.replaceWith(n.getCellText.call(n,i[n.name],e,i))},2e3)}},r.link={icon:"fa-link"},r.comments={icon:"far fa-comments-o",getEditVal:function(e){return e.data("val")},getCellText:function(e){let n=this;if(0===e.n||!e.n)return"";let i=t("<span>"),a=t('<span class="comments">').text(e.c[0]+" "+e.c[1]+": "+e.c[2]).appendTo(i);return e.notViewed&&(a.addClass("notViewed"),n.decorationColor&&a.css("border-bottom-color",n.decorationColor)),i},getValue:function(e,n,i){"use strict";let a=this,l=t.Deferred();if(i)e||(e=[]),l.resolve({value:e});else if(0===e.n||1===e.n&&!e.cuted&&!e.notViewed)e||(e=[]),l.resolve({value:[e.c]});else if(e.n>1&&!e.notViewed&&e.all)l.resolve({value:e.c});else{let e={fieldName:this.name};n.id&&(e.rowId=n.id),l=this.pcTable.model.getValue(e,this.table_id)}return l.then(function(e){if(n[a.name].v.notViewed||n[a.name].notViewed){let e=t.Deferred();e.then(function(){let e;delete n[a.name].v.notViewed,delete n[a.name].notViewed,n.id?e=a.pcTable._getTdByFieldName(a.name,a.pcTable.data[n.id].$tr):(e=a.pcTable._paramsBlock.find('td[data-field="'+a.name+'"]')).length||(e=a.pcTable._footersBlock.find('td[data-field="'+a.name+'"]')),e&&e.length&&(e.find(".notViewed-num").remove(),e.find(".notViewed").removeClass("notViewed"))}),n[a.name].notViewed?a.pcTable.model.setCommentsViewed(n[a.name].v.length,a.name,n.id).then(function(){e.resolve()}):e.resolve()}}),l},getPanelText:function(e,n,i){let a=this,l=t.Deferred(),o=e||i[a.name];const s=function(e){let n=t('<div class="comments">');return t.each(e,function(e,t){n.append(a.getCommentLine(t))}),setTimeout(function(){n.closest("td").scrollTop(n.height())},100),n};return o.all?s(o.c):(this.getValue(o,i,!1).then(function(e){l.resolve(s(e.value))}).fail(function(){l.reject()}),l.promise())},getCommentLine:function(e){let n=t('<div class="comments-line">');return n.append(t('<span class="com_dt">').text(e[0])),n.append(" "),n.append(t('<span class="com_author">').text(e[1])),n.append(" "),n.append(t('<span class="com_text">').html(App.textWithLinks(e[2]))),n},getPanelVal:(e,t)=>e,getEditElement:function(e,n,i,a,l,o,s,r){let c,d=this,f=e||t("<div>"),p=f.data("dialog")||t("<div>").css("min-height",200);f.data("dialog",p),n=n.v||"";let h=function(e){d.getValue.call(d,n,i,!r).then(function(e){let n=t('<textarea type="text" style="height:90px;resize: vertical" class="form-control"/>');t.each(e.value,function(e,t){p.append(d.getCommentLine(t))}),p.append(t('<div class="comments-input">').append(n)),p.data("input",n),n.focus()})};const u=function(e,t,n){let i=p.find("textarea").val().trim();f.data("val",i),n||(a(f,{}),e.close())};c=[];let m={label:"Сохранить",cssClass:"btn-m btn-warning",action:u},b={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){l(f,{}),e.close()}},g="Комментарии поля <b>"+this.title+"</b>",v="ctrlS.commentdialog",_=!1;if(r)setTimeout(function(){let e=f.closest("td").find(".cdiv");e.length>0?(e.data("bs.popover").options.content.find(".btn").each(function(){let e=t(this),n={};n.label=e.data("name"),n.cssClass=e.attr("class").replace("btn-sm","btn-m"),n.icon=e.find("i").attr("class"),n.save=e.data("save"),n.click=e.data("click"),n.action=function(e){n.save&&u(e,0,!0),n.click({}),_=!0,e.close()},c.push(n)}),e.popover("destroy")):(c.push(m),c.push(b)),d.pcTable.isMobile?App.mobilePanel(g,p,{buttons:c,onhide:function(e){t("body").off(v),_||o(f,{})},onshown:function(e){h()},onshow:function(e){t("body").on(v,function(t){u(e,0,!1)})}}):BootstrapDialog.show({message:p,type:null,title:g,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:c,onhide:function(e){t("body").off(v),_||o(f,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"}),h()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:900}),t("body").on(v,function(t){u(e,0,!1)})}})},1),f.text("Редактирование в форме").addClass("edit-in-form");else{let e=!1;if(f.off().on("focus click","button",function(){if(e)return!1;e=!0;let n=c.slice(0);n.push(m),n.push(b);var i=t(this).closest("div");d.pcTable.isMobile?App.mobilePanel(g,p,{buttons:n,onhide:function(n){e=!1,t("body").off(v),l(i,n)},onshown:function(e){0===e.$modalBody.find("textarea").length&&h(),t("body").on(v,function(t){u(e,0,!1)})}}):BootstrapDialog.show({message:p,type:null,cssClass:"fieldparams-edit-panel",title:g,draggable:!0,size:BootstrapDialog.SIZE_WIDE,buttons:n,onhide:function(n){e=!1,t("body").off(v),l(i,n)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),0===e.$modalBody.find("textarea").length&&h(),e.$modalContent.css({width:900}),t("body").on(v,function(t){u(e,0,!1)})}})}),0===f.find("button").length){let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Добавить комментарий");s&&e.attr("tabindex",s),f.append(e)}}return f.data("val",null)},getCellTextInPanel:function(e,t,n,i){return this.getEditPanelText({v:e},n,i)},getEditPanelText:function(e,n,i){if(e){if(e.v.forEach){let n=t("<div>");return e.v.forEach(function(e){n.append(t("<div>").append(t('<span class="date">').text(e[0])).append(t('<span class="user">').text(e[1])).append(t('<span class="text">').text(e[2])))}),n.children()}{let n=t("<div>");return i[this.name]&&i[this.name].v&&i[this.name].v.forEach&&i[this.name].v.forEach(function(e){n.append(t("<div>").append(t('<span class="date">').text(e[0])).append(t('<span class="user">').text(e[1])).append(t('<span class="text">').text(e[2])))}),n.append(t('<div class="new-comment">').text(e.v)),n.children()}}},getValPreview(e){return this.getCellText({c:e[e.length-1],n:e.length})}},r.chart={icon:"fa-bar-chart",getCellText:function(e,n,i){let a=t("<div>");return i[this.name].ch&&this.loadChart(()=>{this.chartSimple(a,i[this.name].ch)}),a},async loadChart(n){if(e.ChartLoaded)e.ChartLoaded.then(n);else{let i,a;e.ChartLoaded=new Promise((e,t)=>{i=e,a=t}),e.ChartLoaded.then(n),t.getScript("/js/lib/chart.js").then(()=>{i()})}},chartSimple:function(n,i){let a=t('<canvas class="ttm-chart"></canvas>');n.html(a);let l={},o={...this.chartOptions};"column"===this.category||this.column?(a.attr("height","23"),l.layout={padding:{left:5,right:5,top:2,bottom:2}},l.scales={yAxes:[{display:!1}],xAxes:[{display:!1}]}):this.f&&this.f.height&&a.attr("height",this.f.height),e.innerWidth<("false"!==(localStorage.getItem("TreeMinimizer")||"false")?600:800)&&(l.layout={...o.layout,...{padding:{left:5,right:5,top:2,bottom:2}}},l.scales={},o.scales&&o.scales.yAxes?l.scales.yAxes=o.scales.yAxes.map(e=>({...e,display:!1})):l.scales.yAxes=[{display:!1}],o.scales&&o.scales.xAxes?l.scales.xAxes=o.scales.xAxes.map(e=>({...e,display:!1})):l.scales.xAxes=[{display:!1}],l.aspectRatio=o.aspectRatioMobile||(o.aspectRatio||2)/1.6);let s=a.get(0).getContext("2d"),r=o.type||"line";delete o.type;let c=i.values.map(()=>new Object);o.data&&o.data.datasets&&(c=o.data.datasets),i.datasets&&(c=i.datasets);let d=o.data||{};d.datasets=c,i.labels&&(d.labels=i.labels),delete o.data,c.forEach((e,t)=>{e.data=i.values[t]}),new Chart(s,{type:r,data:d,options:{...o,...l}}),this.pcTable._container.getNiceScroll&&this.pcTable._container.getNiceScroll().resize(),a.on("contextmenu",()=>!1),a.on("dblclick",()=>{e.top.BootstrapDialog.show({message:"<canvas></canvas>",draggable:!0,title:this.pcTable.__getCellTitle(this),cssClass:"dialog-chart-topper",onshown:e=>{new Chart(e.$modalBody.find("canvas").get(0).getContext("2d"),{type:r,data:d,options:o})}})})}},t.each(r,function(e,n){r[e]=t.extend({},c,n)}),App.pcTableMain=function(i,a){if(this.data_params=a.params||null,a=t.extend({},{tableRow:{},nSorted:!0,isCreatorView:!1,withCsvButtons:!1,withCsvEditButtons:!1,noDataRowClass:"pcTable-noDataRow",contanerClass:"pcTable-container",tableClass:"pcTable-table",width:null,checkIsUpdated:0,_containerId:"",scrollWrapper:null,tableWidth:0,control:{adding:!1,sorting:!1,deleting:!1,duplicating:!1},dataSorted:[],data:[],dataSortedVisible:[],mainFieldName:"id",insertRow:null,_container:null,_content:null,extraClastersBottom:null,extraClastersTop:null,dataSortedClasters:{t:[],m:[],b:[]},ScrollClasterized:null,_innerContainer:null,_header:null,_table:null,LogButton:null,model:null,fields:{},hidedFields:[],fieldCategories:{column:[],params:[],footer:[]},sorted:{field:"",direction:"asc"},_sorting:{},_filterable:!1,filtersClearButton:null,_indexes:{fieldByName:{}},beforeSpaceHide:!0},a),t.extend(this,a,!0),screen.width<=n&&(this.isCreatorView=!1,this.isMobile=!0),this.isCreatorView){if(0===t("#isCreator").length){let n=t('<span id="isCreator" class="btn btn-sm"><i class="fa-user-circle fa"></i></span>'),i=n;this.isMobile||localStorage.getItem("notCreator")?(i.addClass("btn-warning"),t(".plus-top-branch").hide()):i.addClass("btn-danger"),i.on("click",()=>{localStorage.getItem("notCreator")?localStorage.removeItem("notCreator"):localStorage.setItem("notCreator",!0),e.location.reload(!0)}),t("#docs-link").before(n)}(this.isMobile||localStorage.getItem("notCreator"))&&(this.isCreatorView=!1)}if(this.isCreatorView||Object.keys(this.fields).forEach(e=>{this.fields[e].webRoles&&1===this.fields[e].webRoles.length&&1===parseInt(this.fields[e].webRoles[0])&&delete this.fields[e]}),this.hidden_fields=this.hidden_fields||{},0===this.hidden_fields.length&&(this.hidden_fields={}),App.isTopWindow()&&(this.beforeSpaceHide=!1),i){this.refreshArraysFieldCategories(!0);let e=t(i);e.data("pctable",this),this._container=e,this.isCreatorView||this._container.addClass("worker-view"),this._containerId=this._container.attr("id"),this._containerId||(this._containerId="pcTable"+s++,this._container.attr("id",this._containerId)),this._init(),this.render(a.addVars)}else this.initForPanel(a);return this.model.addPcTable(this),this};let d=0;e.EditPanel=function(n,i,a,l,o={}){if(e.top!==e)return e.top.EditPanel.call(e.top,n,i,a,o);let s=t.extend(!0,{},a),r=this;r.pcTable=n,r.panelId="panel"+d++;let c=t.Deferred();this.$panel=t('<div class="InsertPanel">'),this.isNewPanel=!0,this.blockedFields={},this.bootstrapPanel=null;let f=s.id?"checkEditRow":"checkInsertRow",p=s.id?"saveEditRow":"add";this.panelType=s.id?"edit":"insert",this.editItem=s||{},t("body").trigger("pctable-opened",{type:"panel"}),r.resolved=!1,r.error={};let h={};return this.checkRow=function(e,n){let i=this;return new Promise(function(a,l){r.pcTable.model[f](i.getDataForPost(e),Object.keys(o)).then(function(e){"edit"==r.panelType&&n&&(h=t.extend(!0,{},e.row)),r.editRow.call(r,e),a(r)}).fail(l)})},this.saveRow=function(i,a){let l=this.getDataForPost();r.pcTable.model[p](l).then(function(i){if(2===n){let e=t("#table").data("pctable");e&&e.tableRow.id==r.editItem.table_id.v&&l.data_src.v&&l.data_src.v.width&&e.setColumnWidth(r.editItem.name.v,l.data_src.v.width.Val)}c.resolve(i),r.resolved=!0,t(e.top.document.body).trigger("pctable-closed",{type:"panel",json:i,method:r.panelType,tableId:r.pcTable.tableRow.id}),r.bootstrapPanel.close()}).fail(function(){if(a.length&&a.isAttached())i.$modal.find(".btn-save").prop("disabled",!1)})},this.editRow=function(n){"use strict";let a=!1;r.pcTable.f=n.f||{},r.editItem.f=n.row.f||{};let l=this.$panel.find(">div:first"),s=this.$panel.find(">div:last"),c=0,d=0,f=0;const p=function(e){return-1!==["text","comments","file","listRow"].indexOf(e.type)||e.multiple?1.5:1};if(l.length||(r.pcTable.fieldCategories.column.forEach(function(e,t){"n"!==e.name&&(c+=p(e),f++)}),c/=2,l=t("<div>").appendTo(this.$panel),f>1?s=t("<div>").appendTo(this.$panel):this.$panel.css("grid-template-columns","1fr")),r.pcTable.fieldCategories.column.forEach(function(i,u){if("n"===i.name)return;let m=r.$panel.find('div.cell[data-field-name="'+i.name+'"]'),b=r.editItem[i.name];r.editItem[i.name]=n.row[i.name],r.isEditable(i)&&(a=!0);let g=t.extend({},r.pcTable.f||{},r.editItem.f||{},r.editItem[i.name].f||{});if(!g.hide||!g.hide.extpanel){if(m.length)m.data("input")&&!g.block?(!b||i.isDataModified(r.editItem[i.name].v,b.v)||i.codeSelectIndividual||"insert"==r.panelType&&i.code&&!i.codeOnlyInAdd)&&r.createCell.call(r,m,i,u,g):r.createCell.call(r,m,i,u,g);else{let n=t('<div class="cell-wrapper" style="position: relative">'),a=t("<label>").text(i.title||i.name).prependTo(n);i.unitType&&a.text(a.text()+", "+i.unitType),t('<div class="btns pull-right">').prependTo(n);let o=p(i);n.attr("data-koeff",o),d>0&&2===f?s.append(n):d<c&&d+o>c?l.append(n):d+o<=c?l.append(n):s.append(n),d+=o,m=r.createCell.call(r,m,i,u,g,n);{let t=e.innerWidth-48;t=1===f?t<790?t:790:t<390?t:390,n.width(t)}setTimeout(()=>{let e=n.find(".btns").width();e>0&&(e+=3),a.css("max-width","calc(100% -  "+e+"px)")},2),i.linkToSelectTable&&n.append(' <a href="'+i.linkToSelectTable.link+'" class="color-primary-primary" style="font-size: 12px" target="_blank">'+i.linkToSelectTable.title+"</a> ")}if(g.hide&&g.hide.panel?m.parent().css("display","none"):m.parent().css("display",""),m.attr("data-field-name",i.name),m.attr("data-field-type",i.type),"edit"===r.panelType){if(Object.equals(h[i.name].v,r.editItem[i.name].v)&&h[i.name].h==r.editItem[i.name].h?m.parent().removeClass("edited"):"comments"===i.type?"string"==typeof r.editItem[i.name].v&&r.editItem[i.name].v.length?m.parent().addClass("edited"):m.parent().removeClass("edited"):m.parent().addClass("edited"),i.code&&!i.codeOnlyInAdd){let e=m.parent().find(".btns button.handled");e.length||(e=t('<button class="btn btn-sm btn-default handled" tabindex="'+(2*u+2)+'"></button>'),m.parent().find(".btns").prepend(e),r.isEditable(i)?(e.on("click",function(){!0===r.editItem[i.name].h?r.editItem[i.name].h=!1:r.editItem[i.name].h=!0,r.checkRow()}),e.prop("disabled",!1)):(e.prop("disabled","disabled"),r.editItem[i.name].h||e.remove())),e.removeClass("btn-warning").addClass("btn-default"),e.html('<i class="fa fa-hand-grab-o"></i>'),r.editItem[i.name].h&&(e.addClass("btn-warning").removeClass("btn-default"),-1!==Object.keys(r.editItem[i.name]).indexOf("c")&&r.editItem[i.name].c!==r.editItem[i.name].v&&e.html('<i class="fa fa-hand-paper-o"></i>'))}}else if(i.code&&!i.codeOnlyInAdd){let e=m.parent().find(".btns"),n=e.find(".handled");o[i.name]&&r.editItem[i.name].h?0===n.length&&(n=t('<button class="btn btn-sm btn-warning handled" tabindex="'+(2*u+2)+'"><i class="fa fa-hand-paper-o pull-right"></button>').on("click",()=>{delete o[i.name],r.checkRow()}),e.prepend(n)):1===n.length&&n.remove()}}},r),r.isNewPanel){let e="";if("edit"===this.panelType){let t;switch(r.pcTable.tableRow.id){case 1:if(r.pcTable.tableRow.main_field&&r.pcTable.fields[r.pcTable.tableRow.main_field]){let e=r.pcTable.tableRow.main_field;(t=r.editItem[e]||n.row[e])&&(t=t.v),t=' "'+t+'"'}t=t?"id "+(r.editItem.id||n.row.id)+" "+t:"id "+(r.editItem.id||n.row.id),e=!r.pcTable.control.editing||n.row.f.block&&!a?"Просмотр настроек таблицы <b> "+t+"</b>":"Редактирование настроек таблицы <b> "+t+"</b>";break;case 2:if(r.pcTable.tableRow.main_field&&r.pcTable.fields[r.pcTable.tableRow.main_field]){let e=r.pcTable.tableRow.main_field;(t=r.editItem[e]||n.row[e])&&(t=t.v),t=' "'+t+'"'}t=t?"id "+(r.editItem.id||n.row.id)+" "+t:"id "+(r.editItem.id||n.row.id),e=!r.pcTable.control.editing||n.row.f.block&&!a?"Просмотр поля таблицы "+r.editItem.table_name.v+"<b> "+t+"</b>":"Редактирование поля таблицы "+r.editItem.table_name.v+" <b> "+t+"</b>";break;default:if(r.pcTable.tableRow.main_field&&r.pcTable.fields[r.pcTable.tableRow.main_field]){let e=r.pcTable.tableRow.main_field;(t=r.editItem[e]||n.row[e])&&(t=t.v),t=' "'+t+'"'}t=t?"id "+(r.editItem.id||n.row.id)+" "+t:"id "+(r.editItem.id||n.row.id),e=!r.pcTable.control.editing||n.row.f.block&&!a?"Просмотр <b> "+t+"</b> таблицы <b>"+r.pcTable.tableRow.title+"</b>":"Редактирование <b> "+t+"</b> таблицы <b>"+r.pcTable.tableRow.title+"</b>"}}else switch(r.pcTable.tableRow.id){case 1:e="Добавление таблицы";break;case 2:e="Добавление поля";break;default:e="Добавление строки в таблицу <b>"+r.pcTable.tableRow.title+"</b>"}r.cleateBootstrapPanel.call(r,e,i,"insert"===r.type||a),r.isNewPanel=!1}},this.cleateBootstrapPanel=function(n,i,a){let o=this,s=[];a&&s.push({action:function(e,n){"use strict";if(Object.keys(r.error).length){let e=Object.keys(r.error)[0],n=r.error[e];return App.notify(n,t("<div>Ошибка в поле </div>").append(" в поле ").append(t("<span>").text(r.pcTable.fields[e].title))),!1}let i=e.$modal.find(".btn-save").prop("disabled","disabled");setTimeout(function(){r.pcTable.model.doAfterProcesses(function(){o.saveRow.call(o,e,i)})},250)},cssClass:"btn-warning btn-save",label:"Cохранить"}),l?s.push({action:function(e){c.resolve(void 0,!0),r.resolved=!0,e.close()},label:null,icon:"fa fa-"+(!0===l?"arrow-right":"times"),cssClass:"btn-m btn-default btn-empty-with-icon"}):s.push({action:function(e){e.close()},label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon"}),o.bootstrapPanel=BootstrapDialog.show({type:i||null,size:BootstrapDialog.SIZE_WIDE,message:o.$panel,cssClass:"edit-row-panel",title:n,buttons:s,draggable:!0,onhidden:function(){c.resolve(),r.resolved||t(e.top.document.body).trigger("pctable-closed",{type:"panel"}),t(e.top.document.body).off("."+r.panelId)},onshown:function(e){"use strict";e.indexedButtons[Object.keys(e.indexedButtons)[0]].attr("tabindex",500),2===Object.keys(e.indexedButtons).length&&e.indexedButtons[Object.keys(e.indexedButtons)[1]].attr("tabindex",501)}}),o.bootstrapPanel.$modalFooter.find(".btn-save").length&&(o.saveButton=o.bootstrapPanel.$modalFooter.find(".btn-save"))},this.createCell=function(i,a,l,s,c){let d=r.editItem||{};d[a.name]=d[a.name]||{},i.removeClass("error"),0===i.length?(i=t("<div data-name='"+a.name+"' class='cell'>").appendTo(c),a.code&&i.addClass("with-code")):c=i.parent();let f=c.find(".btns");if(f.find(".select-btns").remove(),!this.isEditable(a)){r.blockedFields[a.name]=!0;let e=t('<div class="'+("button"===a.type?"link":"")+' ttm--panel-data">');if("button"!==a.type&&s.text?e.text(s.text):(r.editItem[a.name].v||"button"===a.type)&&e.append(a.getCellTextInPanel(r.editItem[a.name].v,i,r.editItem,h)),"button"!==a.type)if(s.comment){let n;n=t('<i class="cell-icon fa fa-info"></i>'),e.prepend(n),n.attr("title",s.comment)}else s.icon&&e.prepend('<i class="cell-icon fa fa-'+s.icon+'"></i>');return a.unitType&&e.append(" "+a.unitType),"button"===a.type&&r.pcTable&&i.on("click",function(){r.pcTable._buttonClick.call(r.pcTable,i,a,d)}),i.html(e).data("input",null),i}r.blockedFields[a.name]=!1;let p,u=!1,m=(i.find("input,button").is(":focus"),async function(e,t,s){u=!0;let c=await async function(e){let t;try{t=a.getEditVal(e),i.removeClass("error"),delete r.error[a.name]}catch(t){return"name"===a.name&&2===n?(delete o.name,(await r.checkRow()).editItem.name.v):(r.error[a.name]=t,i.addClass("error"),App.popNotify(t,e,"default"),null)}return t}(e);if(null===c)Object.keys(r.error).length||r.FocusIt.call(r,l);else if(s||r.FocusIt.call(r,l+1),a.isDataModified(c,r.editItem[a.name].v)){let e={};if(e[a.name]={v:c},a.code&&!a.codeOnlyInAdd&&(e[a.name].h=!0),a.code&&"insert"===r.panelType&&(o[a.name]=!0),2===n)switch(a.name){case"table_id":delete o.version}r.checkRow(e)}u=!1}),b=function(e,t){return setTimeout(function(){e&&e.length&&e.isAttached()&&(u?u=!1:m(e,0,!0))},40),!1},g=function(e,t){m(e)},v=a.getEditElement(i.data("input"),r.editItem[a.name],r.editItem,m,g,b,50+l,!1,i);if(v.isAttached()||i.html(v),i.data("input",v),"select"===a.type&&a.changeSelectTable){let n=function(){let n=r.getDataForPost(),l=t(this).is(".source-add");l&&(n[a.name]=null);let o=0;t(e.top.document.body).on("pctable-opened.select-"+r.panelId,function(){o++}).on("pctable-closed.select-"+r.panelId,function(e,n){o--;let s=n&&"insert"===n.method&&n.json&&n.json.chdata&&n.json.chdata.rows;setTimeout(function(){if(0===o||s){let e=v;delete a.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),s&&(a.multiple?r.editItem[a.name].v.push(Object.keys(n.json.chdata.rows)[0]):r.editItem[a.name].v=Object.keys(n.json.chdata.rows)[0]),e.replaceWith(v=a.getEditElement(null,r.editItem[a.name],r.editItem,m,g,b)),i.data("input",v),r.checkRow(),!l&&r.pcTable.isMain&&r.pcTable.model.refresh(function(e){r.pcTable.table_modify.call(r.pcTable,e)}),t("body").off(".select-"+r.panelId)}},100)}),r.pcTable.model.selectSourceTableAction(a.name,n)},l=t('<span class="select-btns">').appendTo(f),o=t('<button class="btn btn-default-primary btn-sm"><i class="fa fa-edit"></i></button>');if(l.append(o),o.on("click",n),2===a.changeSelectTable){let e=t('<button class="btn btn-default-primary btn-sm source-add"><i class="fa fa-plus"></i></button>');l.append(e),e.on("click",n)}}if(a.getEditPanelText&&(p=a.getEditPanelText(r.editItem[a.name],r.editItem,h))){let e=i.find(".ttm--panel-data");e.length||(e=t('<div class="ttm--panel-data"/>').prependTo(i)),e.html(p),"comments"===a.type&&setTimeout(()=>{e.scrollTop(2e4)})}return i},this.getDataForPost=function(e={}){let t={};return r.editItem.id&&(t.id=r.editItem.id),r.pcTable.fieldCategories.column.forEach(function(n){if("n"===n.name)return;let i=e[n.name]||r.editItem[n.name];"comments"==n.type&&i&&"string"!=typeof i.v&&(i.v=null),i&&r.isEditable(n)?(t[n.name]={},"edit"===r.panelType?(t[n.name].v=i.v,n.code&&!n.codeOnlyInAdd&&(t[n.name].h=i.h||!1),t[n.name].v=n.getPanelVal.call(n,t[n.name].v,r.$panel.find('div.cell[data-field-name="'+n.name+'"]').data("input"))):(t[n.name]=i.v,t[n.name]=n.getPanelVal.call(n,t[n.name],r.$panel.find('div.cell[data-field-name="'+n.name+'"]').data("input")))):a[n.name]&&"insert"===r.panelType&&(t[n.name]=a[n.name].v)}),t},this.isEditable=function(e){if(!r.pcTable.control.editing)return!1;return!0!==t.extend({},r.pcTable.f||{},r.editItem.f||{},r.editItem[e.name].f||{}).block&&("insert"===this.panelType?e.insertable:e.editable)},this.FocusIt=function(e){return!1},"object"!=typeof r.pcTable?App.getPcTableById(r.pcTable).then(function(e){r.pcTable=e,r.checkRow({},!0)}):r.pcTable[0]?App.getPcTableById(r.pcTable[0],{sess_hash:r.pcTable[1]}).then(function(e){e.model.setLoadedTableData(r.pcTable[2]),r.pcTable=e,r.checkRow({},!0)}):r.checkRow({},!0),c.promise()},function(){let n,i=!1;t.extend(App.pcTableMain.prototype,{switchContainerNideScroll:function(e){let t=this;t.isAnonim||(n&&clearTimeout(n),n=setTimeout(()=>{e!==i&&(e?t._container.niceScroll({cursorwidth:7,mousescrollstep:90,scrollspeed:50,autohidemode:!1,enablekeyboard:!1,cursoropacitymin:1,railoffset:{left:-3},cursorcolor:"#e1e0df"}):t._container.getNiceScroll().remove(),i=e)},100))},addScrollsRules:function(){let e=this;this._innerContainer.append(this._table),e.isMobile||(this._innerContainer.on("scroll",function(){"use strict";e._removeEditCell()}),e.withoutScrolls||t(function(){e.switchContainerNideScroll(!0)}))},Scroll:function(){let n,i=this,a={};a.table=void 0;let l=!1,o=0,s=function(){let e=r();l!=(l=a.getClusterNum(e))&&a.insertToDOM(l);let n=t("table.pcTable-table");n.find("thead").height()+n.offset().top-t("#table").offset().top<=0?a.table?a.table.css({top:parseInt(t("#table").offset().top)-parseInt(t(".innerContainer").offset().top)}):function(){if(!a.table){a.table=t('<table class="scroll-head-row">').appendTo(i._innerContainer),a.table.width(i.tableWidth),a.table.append(t("table.pcTable-table thead").clone(!0)).attr("class",t("table.pcTable-table").attr("class")),a.table.find("th:not(.id) div, th:not(.id) .btn").remove(),a.table.find('th.id .pcTable-filters button[data-action="checkbox"]').remove(),a.table.find("th").removeClass("with-filter");let e=t('<div class="btn btn-default btn-xxs "><i class="fa fa-arrow-up"></i></div>').on("click",function(){i._container.scrollTop(i._container.find(".pcTable-rowsWrapper").offset().top-i.scrollWrapper.offset().top)});if(a.table.find("th.id .pcTable-filters:first").append(e),a.table.find("th.n").length){let e=i._innerContainer.find("th.n").find("i.fa-save").parent().clone(!0);a.table.find("th.n").append(t('<div class="pcTable-filters">').append(e))}}a.table.css({position:"absolute",top:parseInt(t("#table").offset().top)-parseInt(t(".innerContainer").offset().top)})}():a.table&&(a.table.remove(),a.table=void 0,i._content.off("scroll"))},r=function(){try{if(i.isAnonim){let e=t(document).scrollTop()-i._content.offset().top;return e<0?0:-e}return i._content.offset().top}catch(e){return 0}};(n=i.isAnonim?t(document):i._container).on("scroll",function(){clearTimeout(o),o=setTimeout(function(){s.call(i)},50)});let c={top_offset:0,bottom_offset:0,rows:t()};return t.extend(a,{rows_in_block:4,item_height:35,emptyCache:function(){c={}},getClusterNum:function(e){let t;return t=e>=0?0:Math.floor(-e/this.block_height),Math.max(t,0)},reloadScrollHead:function(){a.table&&(a.table.remove(),a.table=void 0),s.call(i)},generate:function(e){let t=i.dataSortedVisible,n=t.length;if(n<this.rows_in_block)return{top_offset:0,bottom_offset:0,rows:t};let a=Math.max(this.rows_in_block*e,0),l=a+this.rows_in_cluster+3*this.rows_in_block,o=Math.max(a*this.item_height,0),s=Math.max((n-l)*this.item_height,0),r=[];for(let e=a;e<l;e++)t[e]&&r.push(t[e]);return{top_offset:o,conteinerHeight:i._content.height(),i_start:a,bottom_offset:s,cluster_num:e,rows:r}},getRowsHeight:function(){0!==i.dataSortedVisible.length&&(this.block_height=this.item_height*this.rows_in_block,this.rows_in_cluster=Math.floor((e.innerHeight-i._container.offset().top)/this.item_height))},insertToDOM:function(e,t,n){if(i.isMobile)this.setHtml(i.dataSortedVisible,0,0,n);else{this.rows_in_cluster||this.getRowsHeight(),e||(e=this.getClusterNum(r()));let a=this.generate(e),l=a.rows.join(",");(n||this.checkChanges("data",l,c))&&this.setHtml(a.rows,a.top_offset,a.bottom_offset,n),t&&i._container.getNiceScroll&&i._container.getNiceScroll().resize()}},setHtml:function(e,n,a,l){i._content.find(".editing").each(function(e){i._removeEditing.call(i,e)});let o=i._content.empty().get(0);if(n&&o.appendChild(t('<tr style="height: '+n+'px;" class="loading-row"><td colspan="'+(i.fieldCategories.column.length+1)+'"></td></tr>').get(0)),0===i.dataSorted.length)o.appendChild(i._createNoDataRow().get(0));else if(0===i.dataSortedVisible.length)o.appendChild(i._createNoDataRow("По условиям фильтрации не выбрана ни одна строка").get(0));else for(let t in e){let n=e[t],a=i.data[n];a.$tr&&!l||i._createRow.call(i,a),a.$tr.data("item",a),o.appendChild(a.$tr.get(0))}a&&o.appendChild(t('<tr style="height: '+a+'px;" class="loading-row"><td colspan="'+(i.fieldCategories.column.length+1)+'"></td></tr>').get(0))},checkChanges:function(e,t,n){let i=t!=n[e];return n[e]=t,i}}),a}})}(),t.extend(App.pcTableMain.prototype,{sort:function(e,t){let n=this,i=e.name,a="number"===e.type,l=n.data;(n.nSorted="n"===e.name)||this._table.addClass("no-correct-n-filtered"),a?n.dataSorted=n.dataSorted.sort(function(e,n){let a,o,s=l[e][i].v,r=l[n][i].v,c=0;if(null===s)c=null===r?0:-t;else if(null===r)c=t;else{try{a=Big(s)}catch(e){a=Big(0)}try{o=Big(r)}catch(e){o=Big(0)}c=a.gt(o)?t:a.eq(o)?0:-t}return c}):"select"===e.type?n.dataSorted=n.dataSorted.sort(function(n,a){let o,s;const r=function(t){let n;return l[t][i].v_?e.multiple?(n="",l[t][i].v_.forEach(function(e){n+=e[0]})):n=l[t][i].v_[0]:n=l[t][i].v,n};return(o=r(n))===(s=r(a))?0:o>s?t:-t}):n.dataSorted=n.dataSorted.sort(function(e,n){let a,o;return(a=l[e][i].v||"")>(o=l[n][i].v||"")?t:a==o?0:-t}),this.dataSortedVisible=[],n.dataSorted.every(function(e){return n.data[e].$visible&&n.dataSortedVisible.push(e),!0}),n._refreshContentTable()}}),App.pcTableMain.prototype.isSelected=function(e,t){return!(!this.selectedCells||!this.selectedCells.ids[e]||-1===this.selectedCells.ids[e].indexOf(t))},App.pcTableMain.prototype._addSelectable=function(){var n=this;n.selectedCells={fieldName:null,ids:{},notRowCell:null,selectPanel:null,lastSelected:null,notRowCellEmpty:function(){if(this.notRowCell){this.notRowCell.removeClass("selected");let e=this.notRowCell.closest(".DataRow");1===e.length&&e.removeClass("selected"),this.notRowCell=null}},empty:function(){this.notRowCellEmpty();let e=this;Object.keys(this.ids).forEach(function(t){e.ids[t].forEach(function(e){let t=n._getItemById(e);t&&t.$tr&&(t.$tr.find(".selected").removeClass("selected"),t.$tr.removeClass("selected"))})}),this.ids={},this.lastSelected=null},getEditedData:function(e,t){let i={},a=!1;return Object.keys(n.selectedCells.ids).length>1&&(a=!0),Object.keys(n.selectedCells.ids).forEach(function(l){n.selectedCells.ids[l].forEach(function(o){let s=n.data[o],r=s[l].f?s[l].f.block:void 0;s.f.block&&!1!==r||r||!n.fields[l].editable||!n.fields[l].editGroup||a&&!n.fields[l].editGroupMultiColumns||(i[o]||(i[o]={}),i[o][l]=t?s[l].v:e)})}),i},remove:function(e,t){let i=this;if(!this.ids[t])return;let a={};this.ids[t].some(function(n,l){if(n==e)return i.ids[t].splice(l,1),0===i.ids[t].length&&delete i.ids[t],a[e]=!0,!0}),Object.keys(a).forEach(function(e){let t=!1;Object.keys(i.ids).some(function(n){if(-1!==i.ids[n].indexOf(parseInt(e)))return t=!0,!0}),t||n.data[e].$tr&&n.data[e].$tr.removeClass("selected")})},add:function(e,t){this.ids[t]||(this.ids[t]=[]),this.ids[t].push(e),n.data[e].$tr&&n.data[e].$tr.addClass("selected")},selectPanelDestroy:function(){let e=this;e.selectPanel&&(e.selectPanel.attr("aria-describedby")&&e.selectPanel.popover("destroy"),e.selectPanel=null),t("body").off(".selectPanelDestroy")},checkIfShowPanel:function(i){"use strict";let a=this;if(this.selectPanelDestroy(),i){let l,o=n._getFieldBytd(i),s=t('<div id="selectPanel" class="text">'),r=200,c=t('<div class="column-name"></div>').text(o.title);o.unitType&&c.append(", "+o.unitType),s.append(c),"text"===o.type&&c.append(", "+o.textType),s.append(c),l="column"===o.category?n._getItemBytd(i):n.data_params;let d="";if("column"===o.category){if(d='<span class="id-val">['+l.id+"]</span>",n.tableRow.main_field){let e=n.mainFieldName;void 0!==l[e].v_?"array"==typeof l[e].v_?l[e].v_.forEach(function(i,a){let o=t("<span>").text(n.fields[e].getElementString(l[e].v?l[e].v[a]:null,i));i[1]&&o.addClass("deleted_value"),d+=" "+o.html()}):d+=" "+t("<div>").text(n.fields[e].getElementString(l[e].v,l[e].v_)).html():d+=" "+t("<div>").text(l[e].v).html()}let e=t('<div class="row-name"></div>').html(d);s.append(e)}let f=l[o.name],p=t('<div id="selectPanelBig">'),h=t('<div class="field-value"><div class="copytext-wrapper"><div class="copytext"></div></div></div>').css("white-space","pre-wrap");n.isMobile?h.height("auto").css("min-height",40):h.height(r),p.append(h).appendTo(s);let u,m=h.find(".copytext");if(o.unitType&&null!==f.v&&m.attr("data-unit",o.unitType),f.f&&(f.f.text&&h.prepend(t('<div class="sp-element"><i class="fa fa-font"></i> </div>').append(f.f.text)),f.f.comment&&h.prepend(t('<div class="sp-element"><i class="fa fa-info"></i> </div>').append(f.f.comment))),f.h)if(void 0!==f.c){let e=f.c;f.c_&&(e=f.c_[0],f.c_[1]&&(e=t('<span class="deleted_value">').text(e))),h.append(t('<div><i class="fa fa-hand-paper-o"></i> Расчетное значение: </div>').append(e))}else h.append('<div><i class="fa fa-hand-grab-o pull-left"></i> Cовпадает с расчетным</div>');o.formatInPanel&&o.pcTable.model.getPanelFormats(o.name,l.id).then(e=>{if(e.panelFormats){let n;e.panelFormats.rows.forEach(n=>{switch(n.type){case"text":h.append(t('<div class="panel-text">').text(n.value));break;case"html":h.append(t('<div class="panel-html">').html(n.value));break;case"img":h.append(t('<div class="panel-img">').append(t("<img>").attr("src","/fls/"+n.value+"_thumb.jpg?rand="+Math.random())));break;case"buttons":if(n.value&&n.value.forEach){let i=[];n.value.forEach(n=>{let a=t('<button class="btn btn-default btn-xxs">').text(n.text);i.push(a),n.color&&a.css("color",n.color),n.background&&a.css("background-color",n.background),a.on("click",function(){o.pcTable.selectedCells.empty(),o.pcTable.selectedCells.selectPanelDestroy(),o.pcTable.model.panelButtonsClick(e.panelFormats.hash,n.ind).then(function(){a.refresh&&o.pcTable.model.refresh()})})}),h.append(t('<div class="panel-buttons">').append(i))}}}),e.panelFormats.hash&&(n=setInterval(()=>{s.closest("body").length||(clearInterval(n),o.pcTable.model.panelButtonsClear(e.panelFormats.hash))},100))}});let b=t('<div class="buttons"></div>'),g=[];if(i.is(".edt")&&(g.push({label:'<i class="fa fa-pencil-square-o"></i>',action:function(e){e.close(),i.dblclick()}}),t('<button class="btn btn-sm btn-default"><i class="fa fa-pencil-square-o"></i></button>').on("click",function(){return i.dblclick(),!1}).appendTo(b)),(u=t('<button class="btn btn-sm btn-default copy_me" disabled data-copied-text="Скопировано" title="Копировать "><i class="fa fa-copy"></i></button>')).on("click",function(){m.data("text")?App.copyMe(m.data("text")):App.copyMe(m.text());let e=t(this);return e.width(e.width()),e.button("copied"),setTimeout(function(){e.button("reset")},1e3),e.blur(),!1}),b.append(u),"tmp"!==n.tableRow.type&&o.logButton&&(g.push({label:"Лог",action:function(e){let t;n.mainFieldName&&l.id&&(t=l[n.mainFieldName].v),n.model.getFieldLog(o.name,l.id,t),e.close()}}),t('<button class="btn btn-sm btn-default" title="Лог ручных изменений по полю">Лог</button>').on("click",function(){let e;n.mainFieldName&&l.id&&(e=l[n.mainFieldName].v),n.model.getFieldLog(o.name,l.id,e);let i=t(this).addClass("disabled");return setTimeout(function(){i.removeClass("disabled")},1e3),!1}).appendTo(b)),"column"===o.category&&o.filterable&&(n.isValInFilters.call(n,o.name,f)?(g.push({label:'<i class="fa fa-filter" style="color: #ffe486"></i>',action:function(e){a.selectPanelDestroy(),n.removeValueFromFilters.call(n,o.name,f),e.close()}}),t('<button class="btn btn-sm btn-warning" title="Удалить из фильтра"><i class="fa fa-filter"></i></button>').on("click",function(){return a.selectPanelDestroy(),n.removeValueFromFilters.call(n,o.name,f),!1}).appendTo(b)):(g.push({label:'<i class="fa fa-filter"></i>',action:function(e){a.selectPanelDestroy(),n.addValueToFilters.call(n,o.name,f),n._container.scrollTop(n._filtersBlock.offset().top-n.scrollWrapper.offset().top),n.ScrollClasterized.insertToDOM.call(n.ScrollClasterized,0),e.close()}}),t('<button class="btn btn-sm btn-default" title="Добавить в фильтр"><i class="fa fa-filter"></i></button>').on("click",function(){return a.selectPanelDestroy(),n.addValueToFilters.call(n,o.name,f),n._container.scrollTop(n._filtersBlock.offset().top-n.scrollWrapper.offset().top),n.ScrollClasterized.insertToDOM.call(n.ScrollClasterized,0),!1}).appendTo(b))),!n.isMobile){let n=t('<button class="btn btn-sm btn-default"><i class="fa fa-expand" style="padding-top: 3px;" aria-hidden="true"></i></button>');n.on("click",function(){p.find(".field-value").height(""),p.find(".panel-img img").each((e,n)=>{(n=t(n)).attr("src",n.attr("src").replace("_thumb.jpg?","?"))}),e.top.BootstrapDialog.show({message:p,type:null,title:c.text()+(d?" / "+d:""),cssClass:"fieldparams-edit-panel",draggable:!0,onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"}),a.selectPanelDestroy()},onshown:function(t){t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top}),p.find(".field-value div.codeEditor").trigger("panel-resize")}})}),b.append(n),t('<button class="btn btn-sm btn-default" title="Закрыть панель"><i class="fa fa-times"></i></button>').on("click",function(){return a.selectPanelDestroy(),!1}).appendTo(b)}let v=o.getPanelText(f.v,s,l);if("select"===o.type){let e=t('<div class="previews">').appendTo(h);o.loadPreviewPanel(e,o.name,l,f.v)}n.isCreatorView&&-1!==["select","tree","date"].indexOf(o.type)&&h.append(t('<div class="creator-select-val">'+JSON.stringify(f.v)+"</div>"));const _=function(e){m.text(e),u.prop("disabled",!1)},w=function(e,t){m.html(e),e.data("text")?m.data("text",e.data("text")):m.data("text",t),u.prop("disabled",!1)},y=function(e){if("object"==typeof e&&null!==e)if(e instanceof jQuery){let n="";e.copyText?w(e,e.copyText):(e.each(function(){""!==n&&(n+="\n"),n+=t(this).text()}),""===n&&(n=e.text()),w(e,n))}else e.then?e.then(y):_(JSON.stringify(e));else _(e)};if(y(v),n.isCreatorView){let e;n.LOGS&&(e=n.LOGS,l&&l.id&&(e=n.LOGS[l.id]),e&&(e=e[o.name]));let i=t('<div style="padding-top: 10px">');if(e&&e.c){let n=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> c</i></button>');n.on("click",function(){App.logOutput(e.c)}),i.append(n)}if(e&&e.s){let n=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> s</i></button>');n.on("click",function(){App.logOutput(e.s)}),i.append(n)}if(e&&e.a){let n=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> a</i></button>');n.on("click",function(){App.logOutput(e.a)}),i.append(n)}if(e&&e.f){let n=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> f</i></button>');n.on("click",function(){App.logOutput(e.f)}),i.append(n)}i.children().length&&b.append(i)}if(this.selectPanel=i,n.isMobile||s.append(b),f.e&&h.append(t('<div style="padding-top: 5px;">').html(t("<span>").text(f.e).text().replace(/\[\[(.*?)\]\]/g,"<b>$1</b>"))),n.isMobile)App.mobilePanel(c,s,{buttons:g});else{let e="right",t=this.selectPanel.offset().left,i=n._container.offset().left,a=n._container.width(),l=this.selectPanel.width(),o=s.is(".text")?340:240;a-(t-i)-l<o&&(e="left",this.selectPanel.offset().left-i<o&&(e="bottom"));let r={isParams:!0,$text:s,element:this.selectPanel,container:n._container,placement:e,trigger:"manual"};App.popNotify(r)}t("body").on("click.selectPanelDestroy",function(e){0===t(e.target).closest("#selectPanel").length&&a.selectPanelDestroy()}).on("keyup.selectPanelDestroy",function(e){27==e.which&&a.selectPanelDestroy()})}return!1},copySepected:function(e,n){let i=this,a="",l=[],o=[],s={},r=[];Object.keys(i.selectedCells.ids).forEach(function(e){let t=i.selectedCells.ids[e];l=l.concat(t),o.push(e),t.forEach(function(t){s[t]||(s[t]={});let n=i.fields[e].getCopyText.call(i.fields[e],i.data[t][e],i.data[t]);"object"==typeof n?(r.push(n),n.done(function(n){s[t][e]=n})):s[t][e]=n})}),l=Array.from(new Set(l)),l=i.dataSortedVisible.filter(e=>-1!==l.indexOf(e)),o=Array.from(new Set(o));let c=[];i.fieldCategories.visibleColumns.forEach(function(e){-1!==o.indexOf(e.name)&&c.push(e.name)}),o=c;e&&(a+="id",o.forEach(function(e){a+="\t",a+=i.fields[e].title}));let d=n;t.when(...r).done(function(){l.forEach(function(t){""!==a&&(a+="\n");let n=!0;e&&(a+=t,n=!1),o.forEach(function(e){!0===n?n=!1:a+="\t";let i=s[t][e];void 0===i&&(i=""),"string"==typeof i&&i.replace(/\t/g,"").match(/[\s"]/)&&(i='"'+i.replace(/"/g,'""')+'"'),a+=i})}),App.copyMe(a),setTimeout(d,400)})},click:function(e,i){let a=n._table;if(e.closest("table").is(".pcTable-filtersTable"))return!1;if(!0===a.data("moved"))return a.data("moved",!1),!1;(function(){if(e.is(".val")){if(this.notRowCell&&-1!==this.notRowCell.index(e))n.selectedCells.empty();else{n.selectedCells.empty(),this.notRowCell=e,this.notRowCell.addClass("selected");let t=this.notRowCell.closest(".DataRow");1===t.length&&t.addClass("selected")}return void t("table.pcTable-table").removeClass("selected-multi").removeClass("selected-column")}this.notRowCellEmpty();let a=e.closest("tr"),l=n._getItemByTr(a),o=n._fieldByTd(e,a),s=o.name;if(i.altKey)e.is(".selected")?(n.selectedCells.remove(l.id,s),e.removeClass("selected")):(n.selectedCells.add(l.id,s),e.addClass("selected"),this.lastSelected=[s,l.id]);else if(i.shiftKey&&Object.keys(n.selectedCells.ids).length){let e=this,t=[],i="before";n.dataSortedVisible.some(function(n){if("before"===i){if((n===l.id||n===e.lastSelected[1])&&(i="doIt",t.push(n),l.id===e.lastSelected[1]))return!0}else if("doIt"===i&&(t.push(n),n===l.id||n===e.lastSelected[1]))return!0}),i="before";let a=function(i){t.forEach(function(t){let a=n.data[t];n.isSelected(i.name,t)||(e.add(t,i.name),a.$tr&&n._getTdByFieldName(i.name,a.$tr).addClass("selected"))})};n.fieldCategories.column.some(function(t){if(t.showMeWidth>0)if("before"===i){if((t.name===s||t.name===e.lastSelected[0])&&(i="doIt",a(t),s===e.lastSelected[0]))return!0}else if("doIt"===i&&(a(t),t.name===s||t.name===e.lastSelected[0]))return!0}),this.lastSelected=[s,l.id]}else{let t=n.isSelected(o.name,l.id);n.selectedCells.empty(),t||(n.selectedCells.add(l.id,s),e.addClass("selected"),this.lastSelected=[s,l.id])}let r=Object.keys(n.selectedCells.ids);r.length>1?t("table.pcTable-table").addClass("selected-multi"):1===r.length&&Object.values(n.selectedCells.ids)[0].length>1?t("table.pcTable-table").removeClass("selected-multi").addClass("selected-column"):t("table.pcTable-table").removeClass("selected-multi").removeClass("selected-column")}).call(this)}},this._container.on("contextmenu",".DataRow td:not(.editing,.n,.id), td.val:not(.editing)",function(e){let i=t(this);return n.selectedCells.selectPanel&&n.selectedCells.selectPanel.closest("td")[0]==i[0]?n.selectedCells.selectPanelDestroy():(n.selectedCells.selectPanelDestroy(),n.selectedCells.empty(),n.selectedCells.checkIfShowPanel(i),n.selectedCells.click(i,{})),!1}),this._container.on("click",".DataRow td:not(.editing,.id,.n), td.val:not(.editing)",function(i){if("file-image-preview"===i.target.className){let t=JSON.parse(i.target.getAttribute("data-fileviewpreview"));e.top.BootstrapDialog.show({title:t.name,message:'<div class="file-image-big"><img src="/fls/'+t.file+'" style="max-width: 100%; max-height: 100%"/></div>',type:null,draggable:!0})}else{let e=t(this);if(e.is(".cell-button")&&!e.find("button.button-field").is(":disabled")){let t=n._getFieldBytd(e);return n._buttonClick.call(n,e,t),!1}e.data("clicked")?e.removeData("clicked"):(e.data("clicked",1),setTimeout(function(){e.data("clicked")&&(e.removeData("clicked"),n.selectedCells.click(e,i))},200))}}),this._container.on("click","th.id .for-selected button",function(){let e=t(this),i=e.html();e.text("Скопировано"),n.selectedCells.copySepected.call(n,e.data("names"),function(){e.html(i)})})},App.pcTableMain.prototype.filters={},App.pcTableMain.prototype.__getFilterButton=function(e){var n="btn-default";(this.filters[e]&&this.filters[e].length||this.filters[e+"/h"])&&(n="btn-warning");var i=t('<button class="btn btn-xxs btn-filter"><span class="fa fa-filter"></span></button>').addClass(n);return t('<span class="filter-in-head">').append(i)},App.pcTableMain.prototype.filtersEmpty=function(){this.filters={},this._refreshHead(),this.__applyFilters()},App.pcTableMain.prototype.sessionStorageFilters={url:location.protocol+"//"+location.host+location.pathname,setFilters:function(e){let t={};e=e||{};try{t=JSON.parse(sessionStorage.getItem("pcTableFilters"))||{}}catch(e){}t[this.url]=e,sessionStorage.setItem("pcTableFilters",JSON.stringify(t))},getFilters:function(){let e={};try{e=(e=JSON.parse(sessionStorage.getItem("pcTableFilters")))[this.url]||{}}catch(e){}return e}};let f=!0;App.pcTableMain.prototype.__applyFilters=function(e=!1){let t=this;App.fullScreenProcesses.show(),this.filtersClearButton&&("tmp"!==t.tableRow.type&&this.sessionStorageFilters.setFilters(this.filters),this.selectedCells.empty(),Object.equals(this.filters,{})?this.filtersClearButton.addClass("btn-default").removeClass("btn-warning").attr("disabled",!0):(this.filtersClearButton.removeClass("btn-default").addClass("btn-warning").removeAttr("disabled"),f&&(App.blink(t.filtersClearButton,8,"#fff"),f=!1)));let n=this.dataSortedVisible.slice(),i=[];for(let e=0;e<this.dataSorted.length;e++){let t=this.dataSorted[e],n=this.data[t];this.__applyFiltersToItem(n),n.$visible&&i.push(t)}(e||JSON.stringify(n)!==JSON.stringify(i))&&(this.dataSortedVisible=i,this._refreshContentTable(!1,!0),this._headCellIdButtonsState()),App.fullScreenProcesses.hide()},App.pcTableMain.prototype.__applyFiltersToItem=function(e,t){let n=this,i=!0;for(let t in n.filters){if(!n.filters[t]||0===n.filters[t].length)continue;let a=n.filters[t];if("id"===t)-1===a.indexOf(e.id.toString())&&(i=!1);else{let l=t.toString().split("/");if(t=l[0],!n.fields[t])continue;switch(l[1]||"v"){case"v":n._getFieldbyName(t).checkIsFiltered(e[t],a)||(i=!1);break;case"h":switch(a){case"h":!0!==e[t].h&&(i=!1);break;case"n":!0===e[t].h&&(i=!1);break;case"hf":(!0!==e[t].h||e[t].hasOwnProperty("c"))&&(i=!1);break;case"hc":!0===e[t].h&&e[t].hasOwnProperty("c")||(i=!1)}}}if(!i)break}(e.$visible=i)||this.row_actions_uncheck(e)},App.pcTableMain.prototype.addValueToFilters=function(e,t){this.filters[e]||(this.filters[e]=[]);let n=this.fields[e];this.filters[e].push(n.getFilterDataByValue.call(n,t)),n.$th.find(".btn-filter").parent().replaceWith(this.__getFilterButton.call(this,e)),this.__applyFilters.call(this)},App.pcTableMain.prototype.isValInFilters=function(e,t){this.filters[e]||(this.filters[e]=[]);let n=this.fields[e],i=n.getFilterDataByValue.call(n,t);return-1!==this.filters[e].indexOf(i)},App.pcTableMain.prototype.removeValueFromFilters=function(e,t){const n=this;n.filters[e]||(n.filters[e]=[]);let i,a=n.fields[e],l=a.getFilterDataByValue.call(a,t);for(;-1!==(i=n.filters[e].indexOf(l));)n.filters[e].splice(i,1);0===n.filters[e].length&&delete n.filters[e],a.$th.find(".btn-filter").parent().replaceWith(n.__getFilterButton.call(n,e)),n.__applyFilters.call(n)},App.pcTableMain.prototype.__addFilterable=function(){const e=this;var n={};"tmp"!=e.tableRow.type&&(n=e.sessionStorageFilters.getFilters()),e.filters=n||{},this._header.on("click",".pcTable-filters > span button.btn-filter:not(#checkS)",function(n){let i=t(this);if(i.attr("aria-describedby"))return!0;let a=i.closest("th"),l=a.is(".id")?"id":a.data("field"),o=t('<div class="filter-div-button">'),s=t('<select class="selectpicker" data-size="6" multiple title="Выберите значения" data-style="btn-sm btn-default" data-width="css-width" data-live-search="true" data-selected-text-format="count">').appendTo(o);const r=function(){try{i.popover("destroy")}catch(e){}};let c,d=!1;const f=function(n){if(c&&clearTimeout(c),!d){if("filterRemove"===n)return d=!0,r(),delete e.filters[l],i.removeClass("btn-warning").addClass("btn-default"),void e.__applyFilters.call(e);if("setInvertFilters"===n){let e=Object.values(s.selectpicker("val")),n=[];t.each(s.data("options"),function(t,i){-1===e.indexOf(i)&&n.push(i)}),s.selectpicker("val",n)}c=setTimeout(function(){r(),JSON.stringify(e.filters[l]||[])!==JSON.stringify(s.selectpicker("val"))&&(e.filters[l]=s.selectpicker("val"),0===e.filters[l].length&&delete e.filters[l],"id"!==l||i.closest(".pcTable-table").is(".pcTable-table:first")||e._header.find("th.id .btn-filter").parent().replaceWith(e.__getFilterButton.call(e,l)),i.parent().replaceWith(e.__getFilterButton.call(e,l)),e.__applyFilters.call(e))},10)}};o=t('<div class="pcTable-filter-select" style="height: 220px;">').append(o),s.data("container",o);var p={};t.each(e.data,function(t,n){"id"===l?p[t.toString()]=t.toString():e.fields[l].addDataToFilter(p,n[l])});var h={};t.each(p,function(e,t){h[t]=e}),h=App.ksort(h);let u={},m=e.filters[l]?[...e.filters[l]]:[],b=0;const g=function(e){u={"Выбранное":t('<optgroup label="Выбранное">'),"":t('<optgroup label="">')};let n=function(){return!0};if(e&&""!==e){let t=e.toLowerCase().replace("ё","е").split(" ");n=function(e){let n=null!==e?e.toString().toLowerCase().replace("ё","е"):"";return!t.some(function(e){return-1===n.indexOf(e)})}}let i=!1,a=0;t.each(h,function(e,t){if("null"===e&&(e="null "),-1!==m.indexOf(t.toString())){let i=n(e);u["Выбранное"].append('<option data-content="'+e+'" '+(i?"":'style="display: none"')+">"+t+"</option>"),b+=i?1:0}else{if(!n(e))return!0;a>=100?i=!0:(u[""].append('<option data-content="'+e+' ">'+t+"</option>"),a++)}}),s.empty(),b||u["Выбранное"].attr("label",""),s.append(u["Выбранное"]),s.append(u[""]),i&&s.append('<option data-content="Данные не полны. Пользуйтесь поиском" disabled = disabled style="text-align: center; cursor: pointer">0</option>'),s.data("options",h),s.selectpicker("val",m),s.selectpicker("refresh")};s.on("change.bs.select",function(){m=s.val()}),g();let v=i.popover({html:!0,content:o,trigger:"manual",container:e._container,placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'});s.selectpicker("render").selectpicker("toggle"),i.one("remove",()=>{setTimeout(()=>{let e;v&&v.length&&v.attr("aria-describedby")&&(e=t("#"+v.attr("aria-describedby")))&&e.remove()},10)});let _=t('<div class="buttons" style="position: absolute; bottom: -10px; width: 100%; text-align: center">');if(t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px;">Прим.</span></span>').appendTo(_).on("click",function(){f("setSelectedFilters")}),t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px;">Инверт.</span></span>').appendTo(_).on("click",function(){f("setInvertFilters")}),t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px">Отмен.</span>').appendTo(_).on("click",function(){f("filterRemove")}),e.fields[l]&&e.fields[l].code&&!e.fields[l].codeOnlyInAdd){let n=t('<select data-title="Все" data-dropup-auto="false" class="dropup" data-container=".popover" data-style="btn btn-xxs filter-by-hand '+(e.filters[l+"/h"]?"btn-warning":"btn-default")+' "><option value="">Все</option><option value="n">Без руки</option><option value="h">С рукой все</option><option value="hf">С рукой как в расчете</option><option value="hc">С рукой отличающиеся</option></select>').appendTo(_).on("change",function(){return e.filters[l+"/h"]=n.selectpicker("val"),""===e.filters[l+"/h"]&&delete e.filters[l+"/h"],r(),i.parent().replaceWith(e.__getFilterButton.call(e,l)),e.__applyFilters.call(e),!1}).wrap('<span id="filterHand">');setTimeout(function(){n.selectpicker("render").selectpicker("val",e.filters[l+"/h"]||"");try{n.data("selectpicker").$menu.offset({bottom:15,left:-90}).css("border","1px solid grey")}catch(e){}},100)}e.PageData&&e.PageData.onPage&&e.PageData.allCount>e.PageData.onPage?(b?o.height(260):o.height(220),_.append('<div class="text-center ttm-paging-danges">Фильтрация по текущей странице</div>')):b?o.height(220):o.height(200),_.appendTo(o),s.on("hidden.bs.select",function(){f("setSelectedFilters")}),e.filters[l]&&s.selectpicker("val",e.filters[l]),setTimeout(function(){if(v&&v.length){let n;v.popover("show"),o.on("mouseenter","li",function(){let e=t(this);e.attr("title")||e.attr("title",e.text())}),"id"===l&&t("#"+i.attr("aria-describedby")).position({my:"left top",at:"left-3px bottom+10px",of:i}).find(".arrow").css("left","12px"),s.data("selectpicker")._searchStyle=function(){return"multiincludes"},s.data("selectpicker").$searchbox.focus(),s.data("selectpicker").$searchbox.off().on("click.dropdown.data-api focus.dropdown.data-api touchend.dropdown.data-api",function(e){e.stopPropagation()}),s.data("selectpicker").$searchbox.on("keydown",function(e){if("Escape"===e.key)return s.data("selectpicker").$button.click(),!0});let a="";s.data("selectpicker").$searchbox.on("keyup",function(e){let i=t(this).val();a!==i&&(a=i,n&&clearTimeout(n),n=setTimeout(function(){g(a)},750))}),e._container.on("click.filter filterPressed.filter",function(n){0!==t(n.target).closest("#filterHand").length||"filterPressed"!==n.type&&void 0===n.altKey||!t("#"+i.attr("aria-describedby")).is(":visible")||(e._container.off(".filter"),f("setSelectedFilters"))}),e._innerContainer.one("scroll.filter",function(n){t("#"+i.attr("aria-describedby")).is(":visible")&&(e._container.off(".filter"),f("setSelectedFilters"))})}},50),e._container.trigger("filterPressed")})},t.extend(App.pcTableMain.prototype,{_addEditable:function(){var e=this;this._container.on("dblclick","td.val:not(.editing), td.edt:not(.editing), .dataRows td:not(.editing,.id,.n)",function(n){let i=t(this),a=i.closest("tr");if(a.length&&a.is(".InsertRow"))return!1;if(i.is(".footer-name, .id, .footer-empty"))return!1;if(i.is(".edt"))e._createEditCell.call(e,i,!0);else{if(a.is(".DataRow")&&"cycles"===e.tableRow.type)return e.model.dblClick(e._getItemBytd(i).id,e._getFieldBytd(i).name),!1;let t=i.clone(!0).insertAfter(i);i.hide(),t.html('<span class="cell-value blocked" style="height: '+t.height()+'">Заблокировано</span>'),setTimeout(function(){t.remove(),i.show()},500)}}).on("click",".editCellsBlock .btn, td.edt .ttm-edit, td .ttm-panel",function(e){return t(this).is(".ttm-edit")?(t(this).closest("td").trigger("dblclick"),!1):t(this).is(".ttm-panel")?(t(this).closest("td").trigger("contextmenu"),!1):void t(this).data("click")(e)})},goToEditNextCell:function(e){return next},_buttonClick:function(n,i,a){if(n.data("clicked"))return!1;const l=function(){"use strict";let l,s={},r=n.parent();n.data("clicked",!0),"column"===i.category?(a=a||o._getItemBytd(n),l=a.id,s.item=l,s.fieldName=i.name):(s.item="params",s.fieldName=i.name),s.checked_ids=o.row_actions_get_checkedIds(),n.height(n.height()),n.find(".cell-value").hide();let c=t('<div class="text-center"><i class="fa fa-spinner" style="color: #000"></i></div>');n.append(c),o._saving=!0,o.model.click(s).then(function(t){if(o.table_modify.call(o,t),n.length&&n.isAttached())c.remove(),n.find(".cell-value").show();else if("column"===i.category){let e=o._getItemById(l).$tr;n=o._getTdByFieldName(i.name,e)}else n=r.find('[data-field="'+i.name+'"]');i.uncheckAfterClick&&o.row_actions_uncheck_all(),i.closeIframeAfterClick&&e.closeMe&&e.closeMe(),i.btnOK.call(i,n)}).fail(function(){n.length&&n.isAttached()&&(c.remove(),n.find(".cell-value").show(),n.removeData("clicked"))}).always(function(){o._saving=!1})};let o=this;if(i.warningEditPanel){let e={"Ок":function(e){e.close(),l()},"Отмена":function(e){e.close()}};App.confirmation(i.warningEditText||"Точно изменить?",e,"Подтверждение")}else l()},_saveEdited:function(e,n,i){let a=this;!0!==a._saving&&(a._saving=!0,this.model.save(n).then(function(t){a.table_modify.call(a,t,void 0,e),i&&i()}).always(function(){a._saving=!1,e.is("tr.DataRow")&&1===e.closest("table").length&&e.find(".editing").length?e.each(function(){a.refreshRow(t(this))}):e.is("td")&&e.find(".fa-spinner").length&&e.closest("body").length>0&&e.each(function(){let e=t(this),n=a._getItemBytd(e),i=a._getFieldBytd(e),l=a._createCell(n,i);"button"===i.type&&i.btnOK.call(i,l),e.replaceWith(l)})}))},_editFocusIndex:0,_editItem:null,_editPanel:null,_row_edit:function(e){let t=this;if(0===e.length)return!1;let n=e.shift();new EditPanel(t,null,{id:n},e.length>0).then(function(n,i){(n||i)&&(n&&t.table_modify.call(t,n),t._row_edit.call(t,e))}).then(function(){0===e.length&&t.row_actions_uncheck_all()})},_currentEditCellIndex:0,_removeEditing:function(e){e||(e=this._content.find("td.editing"));var t=this._createCell(this._getItemBytd(e),this._getFieldBytd(e));let n;return(n=e.attr("rowspan"))&&t.attr("rowspan",n),(n=e.data("field"))&&t.data("field",n),e.is(".val")&&t.addClass("val"),e.replaceWith(t),t},_saveEditCell:function(){this._editCell&&this._editCell.isAttached()&&this._editCell.is(".editCell")&&this._editCell.data("SaveMe")&&this._editCell.data("SaveMe")()},_removeEditCell:function(){this._editCell&&this._editCell.isAttached()&&this._editCell.is(".editCell")&&this._removeEditing(this._editCell),this._editCell=null},_setEditCell:function(e){this._saveEditCell(),this._editCell=e,e.addClass("editCell")},_setTdSaving:function(e){e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>')},_createEditCell:function(n,i,l){let o=this,s=this._getFieldBytd(n);this._setEditCell(n);n.parent();let r=n.closest("tr"),c=o._getColumnIndexByTd(n,r),d=function(e){if(!e)return!1;let t;switch(e){case"right":for(t=o._getTdByColumnIndex.call(o,r,++c);t.length;){if(!0===o._getFieldBytd.call(o,t).editable){t.trigger("dblclick");break}t=t.next("td")}break;case"down":for(t=r.next("tr");t.length&&t.is(".Blocked");)t=t.next("tr");o._getTdByColumnIndex.call(o,t,c).trigger("dblclick")}};if(!s.editable)return!1;let f=(l=l||this._getItemBytd(n)).id,p=t('<div class="editCellsBlock">');n.addClass("editing");let h,u,m=l[s.name],b=!1,g=function(e,t,n){let i=n||e.closest("td"),l=t||{};if(!i.length||!i.closest("body").length)return!1;var s=o._removeEditing.call(o,i);o._colorizeElement(s,a),d(l.altKey?"right":!!l.shiftKey&&"down")},v=function(e){o._removeEditing.call(o,n),d(e)};o.isSelected(s.name,l.id)?Object.keys(o.selectedCells.ids).length>1?(u=!0,h=!0):o.selectedCells.ids[s.name].length>1&&(h=!0):o.selectedCells.empty();let _=function(e,t,i){if(!i&&s.warningEditPanel&&s.checkEditRegExp.call(s,e))return void App.confirmation(s.warningEditText||"Точно изменить?",{"ОК":function(n){_(e,t,!0),n.close()},"Отменить":function(e){v(),e.close()}},"Предупреждение при изменении");n.html('<div class="text-center"><i class="fa fa-spinner"></i></div>');let a={};a[s.name]=e;let r={};l.id?r[l.id]=a:r.params=a,o._saveEdited.call(o,n,r,function(){d(t.altKey?"right":!!t.shiftKey&&"down")})},w=function(e,t){setTimeout(function(){if(b)return b=!1,!1;y(e,t)},150)},y=function(e,n,i){if(b=!0,!(i=i||!1)&&h)return!1;let a,l=e.closest("td");try{a=s.getEditVal(x)}catch(e){return t("#"+App.popNotify(e,l,"default")).css("z-index",1e3),void(b=!1)}let r=o._getItemBytd(l),c=n.altKey?"right":!!n.shiftKey&&"down";s.isDataModified(a,r[s.name].v)?_(a,n):v(c)};var x=s.getEditElement(void 0,m,l,y,g,w,null,i);m.f&&m.f.placeholder&&s.addPlaceholder&&s.addPlaceholder(x,m.f.placeholder),n.html(x),n.data("SaveMe",function(e){y(x,e=e||{})}),n.data("input",x);var k=t('<div class="cdiv">').css({height:0,width:"100%",position:"absolute",bottom:"0px"});n.append(k);var C=t('<button class="btn btn-sm btn-default" data-save="true" data-name="Сохранить"><i class="fa fa-save"></i></button>').data("click",function(e){b=!0,y(x,e,!0)});p.append(C);C=t('<button class="btn btn-sm btn-default btn-empty-with-icon"><i class="fa fa-times"></i></button>').data("click",function(e){b=!0;let t=e.altKey?"right":!!e.shiftKey&&"down";v(t)});if(p.append(C),h&&(u?s.editGroupMultiColumns:s.editGroup)){let e=function(){let e;b=!0;try{e=s.getEditVal(x)}catch(e){return void App.popNotify(e,n,"default")}let t=o._container.find("td.selected");o._setTdSaving(t);let i=o.selectedCells.getEditedData(e);o._saveEdited.call(o,t,i,!1)};(C=t('<button class="btn btn-sm btn-warning" data-save="true" data-name="Применить к выделенным"><i class="fa fa-database" title="Применить к выделенным"></i></button>')).data("click",function(){s.warningEditPanel?App.confirmation(s.warningEditText,{"ОК":function(t){e(),t.close()},"Отменить":function(e){v(),e.close()}},"Предупреждение при изменении"):e()}),p.append(C),s.code&&!s.codeOnlyInAdd&&((C=t('<button class="btn btn-sm btn-warning" data-name="Фиксировать выделенные"><i class="fa fa-hand-rock-o" title="Фиксировать"></i></button>')).data("click",function(){b=!0;let e=o._container.find("td.selected");o._setTdSaving(e);let t=o.selectedCells.getEditedData(null,!0);o._saveEdited.call(o,e.closest("tr"),t,!1)}),p.append(C),(C=t('<button class="btn btn-sm btn-danger" data-name="Сбросить ручные"><i class="fa fa-eraser" title="Сбросить ручные"></i></button>')).data("click",function(){b=!0;let e=o._container.find("td.selected");o._setTdSaving(e);let t=o.selectedCells.getEditedData("NULL");t.setValuesToDefaults=!0,o._saveEdited.call(o,e.closest("tr"),t,!1)}),p.append(C))}else l[s.name]&&1==l[s.name].h?((C=t('<button class="btn btn-sm btn-danger" data-name="Сбросить ручное"><i class="fa fa-eraser" title="Сбросить ручное"></i></button>')).data("click",function(){b=!0,n.html('<div class="text-center"><i class="fa fa-spinner"></i></div>');let e={};parseInt(f)||(f="params"),e[f]={},e[f][s.name]="NULL",e.setValuesToDefaults=!0,o._saveEdited.call(o,n,e,!1)}),p.append(C)):s.code&&!s.codeOnlyInAdd&&((C=t('<button class="btn btn-sm btn-default" data-name="Фиксировать"><i class="fa fa-hand-rock-o" title="Фиксировать"></i></button>')).data("click",function(){b=!0,n.html('<div class="text-center"><i class="fa fa-spinner"></i></div>');let e={};parseInt(f)||(f="params"),e[f]={},e[f][s.name]="params"===f?o.data_params[s.name].v:o.data[f][s.name].v,o._saveEdited.call(o,n,e,!1)}),p.append(C));if(s.changeSelectTable){let n=function(){b=!0;let n={};t.each(l,function(e,t){"$"!==e.substring(0,1)&&(n[e]=t)}),t(this).data("add-button")&&(n[s.name]=null);let i=0;return t(e.top.document.body).on("pctable-opened.select-"+s.name,function(){i++}).on("pctable-closed.select-"+s.name,function(e,n){i--;let a=n&&"insert"===n.method&&n.json&&n.json.chdata&&n.json.chdata.rows;setTimeout(function(){if(0===i||a){let e=x;delete s.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),l=t.extend(!0,{},l),a&&(s.multiple?l[s.name].v.push(Object.keys(n.json.chdata.rows)[0]):l[s.name].v=Object.keys(n.json.chdata.rows)[0]),a||"column"!==s.category||o.model.refresh(function(e){o.table_modify.call(o,e)}),l[s.name].replaceViewValue=function(e){"column"!=s.category&&(o.data_params[s.name].v_=e)},e.replaceWith(x=s.getEditElement(e,l[s.name],l,y,g,w)),t("body").off(".select-"+s.name)}},100)}),o.model.selectSourceTableAction(s.name,n),!1};(C=t('<button class="btn btn-sm btn-primary"><i class="fa fa-edit" title="Изменить в таблице-источнике"></i></button>')).on("click",n),p.append(C),2===s.changeSelectTable&&(C=t('<button class="btn btn-sm btn-primary" data-add-button="true"><i class="fa fa-plus" title="Добавить в таблицу-источник"></i></button>'),p.append(C),C.on("click",n))}let T=p.find("button").length;p.width(31*T);let S=t("#"+App.popNotify({$text:p,element:k,container:this._container,isParams:!0,placement:"bottom"})),I=parseInt(S.css("top"))-4;S.css("top",-1e7),setTimeout(function(){S.length&&S.isAttached()&&S.css("top",I)},3),s.focusElement(x)}}),function(e,t){t.extend(App.pcTableMain.prototype,{_orderSaveBtn:void 0,row_actions_add:function(){let e=this;e._table.on("click",".DataRow .id",function(){e.isMobile&&e.row_actions_panel_show.call(e,t(this))}),e._table.on("click",".DataRow .id button.dropdown",function(){e.row_dropdown.call(e,t(this))}),e._table.on("click",".DataRow .id .btn.chbox",function(n){return e._row_actions_checkbox_click.call(e,t(this).closest("tr"),n.shiftKey),!1}),e._table.on("mouseleave",function(){return t(this).blur(),!1}),e._table.on("click",".DataRow .id button.edit",function(){e.rows_edit.call(e,t(this).closest("tr"))}),e._container.on("click",".row_delete, .row_duplicate, .row_refresh, .cycle_refresh",function(){let n=t(this);n.is(".row_delete")?e.rows_delete.call(e,t(this).data("tr")):n.is(".row_duplicate")?e.row_duplicate.call(e,t(this).data("tr")):n.is(".row_refresh")?e.row_refresh.call(e,t(this).data("tr")):n.is(".cycle_refresh")&&e.isCreatorView&&"cycles"===e.tableRow.type&&e.cycle_refresh.call(e,t(this).data("tr"))})},_idCheckButton:t('<button class="btn btn-xxs chbox btn-default" data-action="checkbox"><span class="fa fa-square-o"></span></button>'),_checkStatusBar:t('<div class="check-status-bar"><span class="check-mark">✓ </span><span data-name="count_checked_rows">0</span><span class="from-mark"> из </span><span data-name="count_visible_rows">0</span></div>'),_headCellIdButtonsState:function(){"use strict";let e=this;this.row_actions_get_checkedIds().length>0?t("table.pcTable-table").addClass("with-checks"):t("table.pcTable-table").removeClass("with-checks"),this.dataSortedVisible.length!==this.__checkedRows.length?e._idCheckButton.html('<span class="fa fa-square-o"></span>'):e._idCheckButton.html('<span class="fa fa-check"></span>'),this._refreshCheckedStatus(),e.ScrollClasterized.reloadScrollHead.call(e.ScrollClasterized)},_addCellId:function(e,n){let i=t('<td class="id"><span class="nm">'+e.id+"</span></td>");return i.appendTo(n),this.row_actions_icons_add(i),!0===e.$checked&&this.row_actions_check(e,!0),i},_addCellNo:function(e,n){let i=t('<td class="No">--</td>');return i.appendTo(n),i},row_actions_uncheck_all:function(){"use strict";let e=this,t=this.row_actions_get_checkedIds();for(let n=0;n<t.length;n++){let i=e._getItemById(t[n]);e.row_actions_uncheck.call(e,i,!0)}this.__checkedRows=[],this._headCellIdButtonsState()},_refreshCheckedStatus:function(){this._checkStatusBar.find('[data-name="count_checked_rows"]:first').text(this.__checkedRows.length),this._checkStatusBar.find('[data-name="count_visible_rows"]:first').text(this.dataSortedVisible.length)},_row_actions_checkbox_click:function(e,n){let i=this,a=e.closest("tr"),l=this._getItemByTr(a),o=t.extend({},i._lastcheckAction||{});if(i._lastcheckAction={id:l.id,isCheck:!l.$checked},n){let e,t=[];if(o.id&&!l.$checked===o.isCheck&&-1!==(e=i.dataSortedVisible.indexOf(o.id))){let n=i.dataSortedVisible.indexOf(l.id);t=e<n?i.dataSortedVisible.slice(e+1,n+1):i.dataSortedVisible.slice(n,e)}else i.dataSortedVisible.some(function(e){if(i.data[e].$checked?t=[]:t.push(e),e===l.id)return!0});l.$checked?t.forEach(function(e){i.__checkedRows.splice(i.__checkedRows.indexOf(e),1),i.row_actions_uncheck(i.data[e],!0)}):t.forEach(function(e){i.__checkedRows.push(e),i.row_actions_check(i.data[e],!0)}),this._headCellIdButtonsState()}else l.$checked?this.row_actions_uncheck(l):this.row_actions_check(l)},row_actions_get_checkedIds:function(){return this.__checkedRows},row_actions_check:function(e,t){if(e.$checked=!0,e.$tr){e.$tr.find(".id:first").addClass("checked")}t||(this.__checkedRows.push(e.id),this._headCellIdButtonsState())},row_actions_uncheck:function(e,t){e.$checked&&(e.$checked=!1,e.$tr&&($tdId=e.$tr.find(".id"),$tdId.removeClass("checked"),$tdId.find(".chbox i").attr("class","fa fa-square-o")),t||(this.__checkedRows.splice(this.__checkedRows.indexOf(e.id),1),this._headCellIdButtonsState()))},row_actions_icons_add:function(e){"use strict";let n,i;n=this.tableRow.panel?t('<button class="btn btn-default edit"><i class="fa fa-th-large"></i></button>').on("mouseleave",function(){return t(this).blur(),!1}).css("margin-left",2):t(),this.control.editing&&(i=t('<button class="btn btn-default btn-xxs dropdown"  tabindex="-1" style=" margin-left: 2px;"><i class="fa fa-caret-down" style="font-size: 10px; width: 7px;"></i></button>'));let a=t('<button class="btn btn-default btn-xxs chbox"><i class="fa fa-square-o"></i></button>'),l=t('<span class="btn-group-xxs">');e.append(l).append(" ").append(a),i&&l.append(i),n&&l.append(n)},row_actions_panel_show:function(e){let n=e.closest("tr"),i=this._getItemByTr(n),a=i.id;const l=this;let o=t('<div id="row-mobile-panel"></div>');!0!==this.tableRow.panel?o.append(t('<div class="menu-item"><i class="fa fa-th-large"></i> Открыть панель</div>').css("color","gray")):o.append(t('<div class="menu-item row_panel"><i class="fa fa-th-large"></i> Открыть панель</div>').attr("data-tr",a)),!0!==this.control.duplicating||this.f.blockduplicate||i.f.blockduplicate?o.append(t('<div class="menu-item"><i class="fa fa-clone"></i> Дублировать</div>').css("color","gray")):o.append(t('<div class="menu-item row_duplicate"><i class="fa fa-clone"></i> Дублировать</div>').attr("data-tr",a)),-1!==["calcs","globcalcs"].indexOf(this.tableRow.type)?o.append(t('<div class="menu-item"><i class="fa fa-refresh"></i> Пересчитать</div>').css("color","gray")):o.append(t('<div class="menu-item row_refresh"><i class="fa fa-refresh"></i> Пересчитать</div>').attr("data-tr",a)),!this.control.deleting||this.f.blockdelete||i.f&&(i.f.block||i.f.blockdelete)?o.append(t('<div class="menu-item"><i class="fa fa-times"></i> Удалить</div>').css("color","gray")):o.append(t('<div class="menu-item row_delete"><i class="fa fa-times"></i> Удалить</div>').attr("data-tr",a));let s=App.mobilePanel(i[this.mainFieldName].v||"id: "+a,o);o.on("click",".row_delete, .row_duplicate, .row_refresh, .row_panel",function(){let e=t(this);e.is(".row_delete")?l.rows_delete.call(l,a):e.is(".row_duplicate")?l.row_duplicate.call(l,a):e.is(".row_refresh")?l.row_refresh.call(l,a):e.is(".row_panel")&&l.rows_edit.call(l,n),s.close()})},table_modify:function(e,n,i){"use strict";let a=this,l=0,o=0,s=i?i.data("field"):void 0;if(n&&(l=a.dataSorted.indexOf(n)+1,o=a.dataSortedVisible.indexOf(n)+1),e.chdata){let i=e.chdata.deleted||[],r=[];if(e.chdata.rows&&(e.refresh&&e.chdata.rows&&Object.keys(a.data).forEach(function(t){void 0===e.chdata.rows[t]&&i.push(parseInt(t))}),t.each(e.chdata.rows,function(e,t){let n=a._getItemById(t.id);void 0===n?r.push(t):a.refreshRow(n.$tr,n,t)}),r.length&&(App.isEmpty(a.data)&&a._content&&a._content.find(".pcTable-noDataRow").remove(),t.each(r,function(e,t){t.$visible=!0,t.$checked=!1,l||!a.tableRow.with_order_field||a.tableRow.new_row_in_sort||(t.__inserted=!0),a.data[t.id]=t;let i=l,s=o;!t.__after||n&&n.id===t.__after||(i=a.dataSorted.indexOf(t.__after)+1,s=a.dataSortedVisible.indexOf(t.__after)+1),a.dataSorted.splice(i,0,t.id),a.dataSortedVisible.splice(s,0,t.id),l++,o++}),n&&!a.isMobile&&setTimeout(function(){t.each(r,function(e,t){a.row_actions_check(a.data[t.id])})},50))),i.length&&(t.each(i,function(e,t){a._deleteItemById.call(a,t)}),App.isEmpty(a.data)&&a._content&&0===a._content.find("."+this.noDataRowClass).length&&a._content.append(a._createNoDataRow())),i.length||r.length||e.chdata.nsorted_ids&&a.nSorted&&!Object.equals(e.chdata.nsorted_ids,a.dataSorted)){if(e.chdata.nsorted_ids&&a.nSorted){let t=a.dataSortedVisible;a.dataSorted=e.chdata.nsorted_ids,t.length===a.dataSorted.length?a.dataSortedVisible=a.dataSorted:(a.dataSortedVisible=[],a.dataSorted.forEach(function(e){-1!==t.indexOf(e)&&a.dataSortedVisible.push(e)}))}this.ScrollClasterized.insertToDOM(void 0,!0)}let c={};if(e.chdata.params&&t.each(e.chdata.params,function(e,t){["v","v_","f","e","h","c","ch"].forEach(function(n){(void 0!==t[n]||a.data_params[e][n])&&(Object.equals(a.data_params[e][n],t[n])&&e!==s||(c[e]=!0,a.data_params[e][n]=t[n]))})}),e.chdata.fields&&t.each(e.chdata.fields,function(e,n){n.list&&!Object.equals(a.fields[e].list,n.list)&&(c[e]=!0,t.extend(a.fields[e],n))}),(e.chdata.params||e.chdata.fields)&&(a._refreshParamsBlock(c,!0),a._refreshFootersBlock(c,!0)),e.chdata.f){let t=e.chdata.f;["blockadd","blockdelete","blockorder","background","blockduplicate","block","tabletitle","rowstitle","fieldtitle","tablecomment"].forEach(function(e){if(e in t||e in a.f)if("object"==typeof t[e]){if(!Object.equals(t[e],a.f[e])){let n=Object.assign({},a.f[e]);a.f[e]=t[e],a.__formatFunctions[e]&&a.__formatFunctions[e].call(a,t[e],n)}}else t[e]!==a.f[e]&&(a.f[e]=t[e],a.__formatFunctions[e]&&a.__formatFunctions[e].call(a,t[e]))})}App.isEmpty(a.data)&&a._content&&a._content.empty().append(this._createNoDataRow())}e.updated&&(a.model.tableData.updated=JSON.parse(e.updated),a._refreshTitle()),e.filtersString&&a._refreshFiltersBlock.call(a,e),a._headCellIdButtonsState()},rows_edit:function(e){"use strict";let t=this,n=this.row_actions_get_checkedIds();return e&&-1===n.indexOf(t._getItemByTr(e).id)&&(this.row_actions_check(t._getItemByTr(e)),n=this.row_actions_get_checkedIds()),t._row_edit.call(t,n.slice()),!1},row_dropdown:function(e){"use strict";let n=t("<div>"),i=this._getItemByTr(e.closest("tr")),a=i.id;!0!==this.control.duplicating||this.f.blockduplicate||i.f.blockduplicate?n.append(t('<div class="menu-item"><i class="fa fa-clone"></i> Дублировать</div>').css("color","gray")):n.append(t('<div class="menu-item row_duplicate"><i class="fa fa-clone"></i> Дублировать</div>').attr("data-tr",a)),-1!==["calcs","globcalcs"].indexOf(this.tableRow.type)?n.append(t('<div class="menu-item"><i class="fa fa-refresh"></i> Пересчитать</div>').css("color","gray")):n.append(t('<div class="menu-item row_refresh"><i class="fa fa-refresh"></i> Пересчитать</div>').attr("data-tr",a)),this.isCreatorView&&"cycles"===this.tableRow.type&&n.append(t('<div class="menu-item cycle_refresh color-danger"><i class="fa fa-refresh"></i> Пересчитать цикл</div>').attr("data-tr",a)),!this.control.deleting||this.f.blockdelete||i.f&&(i.f.block||i.f.blockdelete)?n.append(t('<div class="menu-item"><i class="fa fa-times"></i> Удалить</div>').css("color","gray")):n.append(t('<div class="menu-item row_delete"><i class="fa fa-times"></i> Удалить</div>').attr("data-tr",a));let l=App.popNotify({isParams:!0,$text:n,element:e,container:this._container,trigger:"manual",placement:"bottom"});return t("#"+l).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",function(){n.remove()}).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px"),!1},__getCheckedRowsIds:function(e,n,i){"use strict";let a=this,l=this.row_actions_get_checkedIds();if(e&&-1===l.indexOf(e)){let t=a.data[e];this.row_actions_check(t),l=this.row_actions_get_checkedIds()}if(n){let e=!1;if(l.some(function(t){if(a.data[t].f&&(a.data[t].f.block||a.data[t].f[i]))return e=a.data[t],!0}),e){let n="";"id"!==a.mainFieldName&&(n=' "'+(n=e[a.mainFieldName]._v?e[a.mainFieldName]._v:e[a.mainFieldName].v)+'"');let i=t("<span>").html("Строка <b>id "+e.id+"</b>");if(""!==n){let e=i.find("b");e.text(e.text()+n)}return i.append(" заблокирована"),App.notify(i,"Действие не выполнено"),!1}}return l},row_refresh:function(e){"use strict";let t=this,n=this.__getCheckedRowsIds(e,!1),i=1===n.length?n[0]:null;if(n&&n.length){let e=[{label:"Пересчитать",action:function(e){t.model.refresh_rows(n).then(function(n){t.table_modify.call(t,n),e.close(),t.row_actions_uncheck_all()})}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:"Точно пересчитать "+n.length+" строк?",title:"Пересчет",buttons:e,onhidden:function(){1===n.length&&n[0]==i&&t.row_actions_uncheck_all()},draggable:!0})}},cycle_refresh:function(e){"use strict";let t=this,n=this.__getCheckedRowsIds(e,!1);if(n&&n.length){let e=[{label:"Пересчитать",action:function(e){t.model.refresh_cycles(n).then(function(n){t.table_modify.call(t,n),e.close(),t.row_actions_uncheck_all()})}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:"Точно пересчитать "+n.length+" циклов?",title:"Пересчет",buttons:e,draggable:!0})}},row_duplicate:function(e){"use strict";let n=this,i=this.__getCheckedRowsIds(e,!1);if(i&&i.length){let a=[{label:"Дублировать",cssClass:"btn-danger",action:function(a){let l={},o=[],s=[];n.dataSortedVisible.forEach(function(e){-1!==i.indexOf(e)&&s.push(e)}),i=s;const r=function(t){n.model.duplicate(i,l,e).then(function(i){n.table_modify.call(n,i,e),t&&t.close(),a.close(),n.row_actions_uncheck_all()})};for(let e in n.fieldCategories.column){let t=n.fieldCategories.column[e];"unic"===t.type&&o.push(t.name)}if(o.length){let e,s=t('<table class="simpleTable"><thead><tr><td class="id">id</td></tr></thead><tbody></tbody></table>'),c=s.find("thead tr"),d=s.find("tbody");"id"!==n.mainFieldName&&("unic"!==(e=n.fields[n.mainFieldName]).type?c.append(t("<td></td>").text(e.title)):e=null);for(let e in o){let i=n.fields[o[e]];c.append(t("<td></td>").text(i.title))}for(let a in i){let s=i[a],r=n.data[s],c=t("<tr>");l[s]={},c.append(t('<td class="id"></td>').text(s)),e&&c.append(t("<td></td>").text(r[e.name].v));for(let e in o){let i,a=n.fields[o[e]],d=t('<td class="input"></td>'),f=t("<input>").val(r[a.name].v);l[s][a.name]=r[a.name].v,f.on("keyup",function(){let e=t(this).val();l[s][a.name]=e,i&&(clearTimeout(i),i=null),""!==e?i=setTimeout(function(){n.model.checkUnic(a.name,e).then(function(e){e.ok?d.addClass("ok"):d.removeClass("ok")})},300):a.required?d.removeClass("ok"):d.addClass("ok")}),d.html(f),c.append(d)}d.append(c)}let f=[{label:"Дублировать",cssClass:"btn-m btn-warning",action:function(e){r(e)}},{label:"Отмена",action:function(e){e.close(),a.close()}}];BootstrapDialog.show({message:s,title:"Заполните значения для уникальных полей",buttons:f,draggable:!0})}else r()}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:"Точно дублировать "+i.length+" строк?",title:"Дублирование",buttons:a,draggable:!0})}},rows_delete:function(e){let t=this,n=this.__getCheckedRowsIds(e,!0,"blockdelete"),i=1===n.length?n[0]:null;if(n&&n.length){let e="Точно удалить "+n.length+" строк?",a="Удаление "+n.length+" строк?";if(1==n.length){let i="id-"+n[0];"id"!=t.mainFieldName&&(i=t.data[n[0]][t.mainFieldName],i="id-"+n[0]+' "'+(i.v_&&i.v_[0]?i.v_[0]:i.v)+'"'),e="Точно удалить строку "+i+"?",a="Удаление строки "+i+"?"}let l=[{label:"Удалить",cssClass:"btn-danger",action:function(e){e.close();const i=function(){t.model.delete(n).then(function(e){t.table_modify.call(t,e)})};t.tableRow.delete_timer>0?App.panelTimer(a,t.tableRow.delete_timer,i):i()}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:e,title:"Удаление",buttons:l,onhidden:function(){1===n.length&&n[0]==i&&t.row_actions_uncheck_all()},draggable:!0})}}})}(0,jQuery),t.extend(App.pcTableMain.prototype,{_insertItem:null,_insertRow:null,_insertButtons:null,_insertError:{},_currentInsertCellIndex:0,_addInsert:function(e){var t=this;this.control.adding&&(this._insertRow&&this._insertRow.length||(e&&(this._insertItem={},this.fieldCategories.column.forEach(function(n){e[n.name]&&(t._insertItem[n.name]={v:e[n.name]})})),this._insertRow=this._createInsertRow(null,0),this._insertButtonsChangeStatuses(),this._beforebody.prepend(this._insertRow),this._table.addClass("with-adding-row")))},_insertButtonsChangeStatuses:function(){this._insertRow?(this._insertButtons.find('[data-action="add"]').removeClass("btn-warning").addClass("btn-default").attr("disabled","disabled"),0===this.dataSortedVisible.length&&this._table.find(".pcTable-noDataRow button").removeClass("btn-warning").addClass("btn-default").attr("disabled","disabled")):(this._insertButtons.find('[data-action="add"]').addClass("btn-warning").removeClass("btn-default").removeAttr("disabled"),0===this.dataSortedVisible.length&&this._table.find(".pcTable-noDataRow button").addClass("btn-warning").removeClass("btn-default").removeAttr("disabled"))},_InsertAddInsertBtnsPanel:function(e){let n,i=this,a={};a['<span id="saveInsertRow" tabindex="'+i.fieldCategories.column.length+'">Сохранить</span>']=function(){n.is(".onSaving")||(n.addClass("onSaving"),i.__insertRowActions("saveInsertRow",function(){i._saveInsertRow("close").always(function(){n.removeClass("onSaving")})}))},a['<i class="fa fa-save"  tabindex="'+(i.fieldCategories.column.length+1)+'"></i>']=function(){n.is(".onSaving")||(n.addClass("onSaving"),i.__insertRowActions("saveInsertRow",function(){i._saveInsertRow.call(i).then(function(){n.removeClass("onSaving")})}))},a['<i class="fa fa-paste"  tabindex="'+(i.fieldCategories.column.length+2)+'"></i>']=function(){n.is(".onSaving")||(n.addClass("onSaving"),i.__insertRowActions("saveInsertRow",function(){i._saveInsertRow.call(i,"notClean").then(function(){n.removeClass("onSaving")})}))},a['<i class="fa fa-times" tabindex="'+(i.fieldCategories.column.length+3)+'"></i>']=function(){i._closeInsertRow.call(i,t(this).closest("#"+o))},n=this._addRowPanel(o,e,a)},__insertRowActionsStack:[],__insertRowActions:function(e,t){"use strict";let n=this;-1!==["saveInsertRow","clickSourceButton"].indexOf(e)&&setTimeout(function(){n.model.getDefferedProcess().then(t)},450)},_saveInsertRow:function(e){let n=this,i={},a=t.Deferred();if(Object.keys(n._insertError).length){let e=Object.keys(n._insertError)[0],i=n._insertError[e];App.notify(i,t("<div>Ошибка в поле </div>").append(" в поле ").append(t("<span>").text(n.fields[e].title||n.fields[e].name))),a.reject()}else{let l=function(){t.each(n._insertItem,function(e,t){"n"!==e&&(i[e]=t.v)}),n.model.add(i).then(function(t){switch(n.table_modify.call(n,t),n._currentInsertCellIndex=0,e){case"notClean":break;case"close":n._closeInsertRow();break;default:n._insertItem=null,n._insertRow.html('<td class="id"></td>'),n._createInsertRow(n._insertRow,0)}}).always(function(){a.resolve()})};n.model.doAfterProcesses(l)}return a.promise()},_addInsertRow:function(){let t=this;"cycles"===this.tableRow.type?t.model.add({}).then(function(n){n.firstTableId?e.location.href=e.location.pathname+"/"+n.chdata.rows[0].id+"/"+n.firstTableId:t.table_modify(n)}):t.isMobile?t._addInsertWithPanel():t._addInsert()},_getInsertButtons:function(){let n,i,a=this;return"cycles"===this.tableRow.type?i=n=function(){a.model.add({}).then(function(t){t.firstTableId?e.location.href=e.location.pathname+"/"+t.chdata.rows[0].id+"/"+t.firstTableId:a.table_modify(t)})}:(n=function(){a.isMobile?a._addInsertWithPanel():a._addInsert()},i=function(){a._addInsertWithPanel()}),this._insertButtons=t("<span>"),t('<button data-action="add" class="btn btn-sm btn-warning">Добавить</button>').width(80).on("click",n).appendTo(this._insertButtons),!a.isMobile&&this.tableRow.panel&&t('<button class="btn btn-warning btn-sm"><i class="fa fa-th-large"></i></button>').on("click",i).appendTo(this._insertButtons).css("margin-left",5),this._insertButtons},_addInsertWithPanel:function(e){let t=this;new EditPanel(t,null,e||{}).then(function(e){e&&t.table_modify.call(t,e)})},_closeInsertRow:function(){this._insertPanel?this._insertPanel=null:this._insertRow&&(this._insertRow.find("td").each(function(){t(this).remove()}),this._insertRow.remove(),this._insertRow=null),this._insertItem=null,this._insertButtonsChangeStatuses(),this._currentInsertCellIndex=0,this._table.removeClass("with-adding-row")},_createInsertRow:function(e,n,i){var a=this,o=a._insertItem||(a._insertItem={});e||(this.insertRow=e=t('<tr class="InsertRow" style="height: 35px;"><td class="id"></td></tr>'),this._InsertAddInsertBtnsPanel(e),this.insertRow.editedFields={}),a._currentInsertCellIndex||(a._currentInsertCellIndex=0);let s={};t.each(a._insertItem,function(e,t){"n"!==e&&(s[e]=t.v)});let r=[];return a.fieldCategories.visibleColumns.forEach(function(e){r.push(e.name)}),a.model.checkInsertRow(s,Object.keys(this.insertRow.editedFields)).then(function(n){o=n.row,t.each(a.fieldCategories.column,function(t,n){if(!n.showMeWidth)return void(a._insertItem[n.name]=o[n.name]);let s=r.indexOf(n.name);var c=e.find("td:eq("+(s+1)+")");let d=a._insertItem[n.name],f=a._insertItem[n.name]&&a._insertItem[n.name].force;if(a._insertItem[n.name]=o[n.name],c.length){let t="n"===n.name||a._insertItem[n.name].f&&!0===a._insertItem[n.name].f.block;if(c.data("input")&&!t){n.name;let t=!1;t=!f&&(null===o[n.name].v&&""==d.v||Object.equals(o[n.name].v,d.v)&&!n.codeSelectIndividual),(void 0===d||!t||"data_src"==n.name||"comments"==n.type||n.code&&!n.codeOnlyInAdd)&&(a._createInsertCell.call(a,c,n,e,s,"td",a._createInsertRow),i===n.name&&a._colorizeElement(c,l))}else c.replaceWith(a._createInsertCell.call(a,null,n,e,s,"td",a._createInsertRow))}else e.append(c=a._createInsertCell.call(a,null,n,e,s,"td",a._createInsertRow))}),a._insertFocusIt.call(a)}),e},_createInsertCell:function(n,i,l,o,s,r){s=s||"td";n=n||t("<"+s+">");var c=this;i.code&&n.addClass("with-code"),void 0===c._insertItem[i.name]&&(c._insertItem[i.name]=null);let d=c._insertItem[i.name]&&c._insertItem[i.name].f||{};if(!i.insertable||!0===d.block){let e=c._insertItem[i.name];if(e&&(e=e.v),n.empty().append(d.text?t("<span>").html(d.text):i.getCellText(e,n,c._insertItem)),d.comment){let e=t('<i class="fa fa-info pull-right" style="padding: 3px;">');e.attr("title",d.comment),n.prepend(e)}else if(d.icon&&"button"!==i.type){let e=t('<i class="fa fa-'+d.icon+' pull-right" style="padding: 3px;">');n.prepend(e)}return(d.icon||d.text||d.comment)&&n.on("click",()=>{let a=t("<div>"),l=t("<div>").text(e).appendTo(a);if(d.icon){let e=t('<i class="fa fa-'+d.icon+'" style="padding: 3px;">');l.prepend(e)}if(d.text){let e=t('<div><i class="fa fa-font" style="padding: 3px;"> </div>');e.append(d.text),a.append(e)}if(d.comment){let e=t('<div><i class="fa fa-info" style="padding: 3px;"> </div>');e.append(d.comment),a.append(e)}if(!c.isMobile){let e="right",i=a.offset().left,l=c._container.offset().left;c._container.width()-(i-l)-a.width()<(a.is(".text")?340:240)&&(e="left");let o={isParams:!0,$text:a,element:n,container:c._container,placement:e,trigger:"manual"};App.popNotify(o);let s="keyup.insertPanelDestroy",r="click.insertPanelDestroy";const d=function(){t("body").off(".selectPanelDestroy"),n.popover("destroy")};return t("body").on(r,function(e){0===t(e.target).closest("#selectPanel").length&&d()}).on(s,function(e){27==e.which&&d()}),!1}App.mobilePanel(i.title,a)}),n}i.help&&n.on("focus","input,button,select",function(e){let n=c._table.find("thead th #field-help-"+i.name),a=t(e.target);setTimeout(function(){n.trigger("open"),a.one("blur remove",function(){n.trigger("close")})},120)});var f=function(e){var t;try{t=i.getEditVal(e),delete c._insertError[i.name],m.removeClass("error")}catch(t){return m.addClass("error"),c._insertError[i.name]=t,App.popNotify(t,e,"default"),null}return t},p=function(e,t){var a=f(e);null===a?c._insertFocusIt.call(c):(c._currentInsertCellIndex=o+1,i.isDataModified(a,c._insertItem[i.name].v)?(c.insertRow.editedFields[i.name]=!0,c._insertItem[i.name].v=a,!0===i.isPanelField&&c._createInsertCell.call(c,n,i,l,o,s,r),r.call(c,l,c._currentInsertCellIndex,i.name)):c._insertFocusIt.call(c))},h=function(e,t){setTimeout(function(){let t=e.closest("td");if(!t.length||!t.closest("tr").length)return!1;let n=f(e);null===n?c._insertFocusIt.call(c):i.isDataModified(n,c._insertItem[i.name].v)&&(c.insertRow.editedFields[i.name]=!0,c._insertItem[i.name].v=n,!0===i.isPanelField&&c._createInsertCell.call(c,t,i,l,o,s,r),r.call(c,l,c._currentInsertCellIndex,i.name))},150)},u=function(e,t){let n=e.closest("td");if(!n.length||!n.closest("tr").length)return!1;let d=f(e),p=c._insertItem[i.name].v+"";i.isDataModified(d,p)&&(c._createInsertCell(n,i,l,o,s,r),c._colorizeElement(n,a))};let m=i.getEditElement(n.data("input"),c._insertItem[i.name],c._insertItem,p,u,h);if(d&&d.placeholder&&i.addPlaceholder&&i.addPlaceholder(m,d.placeholder),n.on("click focus","input,button,select",function(e){c._currentInsertCellIndex=o}),n.on("click focus",function(){c._currentInsertCellIndex=o}),m.isAttached()||n.html(m).data("input",m),i.code&&!i.codeOnlyInAdd){let e=n.find(".fa-hand-paper-o");this.insertRow.editedFields[i.name]&&c._insertItem[i.name].h?0===e.length&&(e=t('<i class="fa fa-hand-paper-o pull-right">').on("click",()=>{delete this.insertRow.editedFields[i.name],r.call(c,l,c._currentInsertCellIndex+1,i.name)}),n.prepend(e).addClass("ins-handed")):(1===e.length&&e.remove(),n.removeClass("ins-handed"))}if("select"===i.type&&2===i.changeSelectTable){n.addClass("with-source-add-button");let a=t('<button class="btn btn-default btn-sm source-add" tabindex="-1"><i class="fa fa-plus"></i></button>');n.prepend(a);let o=function(){let a={},o=c._insertItem;t.each(o,function(e,t){"$"!==e.substring(0,1)&&(a[e]=t)});a[i.name]=null;let s=0;return t(e.top.document.body).on("pctable-opened.select-add-"+i.name,function(){s++}).on("pctable-closed.select-add-"+i.name,function(e,a){s--;let d=a&&"insert"===a.method&&a.json&&a.json.chdata&&a.json.chdata.rows;if(0===s||d){let e=m;delete i.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),d&&(i.multiple?o[i.name].v.push(Object.keys(a.json.chdata.rows)[0]):o[i.name].v=Object.keys(a.json.chdata.rows)[0]),e.replaceWith(m=i.getEditElement(e,o[i.name],o,p,u,h)),t("body").off(".select-add-"+i.name),n.data("input",m),r.call(c,l,c._currentInsertCellIndex,i.name)}}),c.model.selectSourceTableAction(i.name,a),!1};a.on("click",function(){c.__insertRowActions("clickSourceButton",o)})}return n},_insertFocusIt:function(e){let n=this;if(!e)return setTimeout(function(){n._insertFocusIt.call(n,1)},10),!1;let i=!0,a=!!this._insertPanel,l=this.insertRow;if(a){if(!n._insertPanel)return!1;l=n._insertPanel.$modalBody}if(!l||!l.length)return!1;if(t.each(n.fieldCategories.visibleColumns,function(e,t){if(n._currentInsertCellIndex==e)return!t.insertable||n._insertItem&&n._insertItem[t.name]&&n._insertItem[t.name].f&&!0===n._insertItem[t.name].f.block?void n._currentInsertCellIndex++:(a?t.focusElement(l.find(".cell:eq("+e+")").data("input")):t.focusElement(n._getTdByColumnIndex(l,e+1).data("input")),i=!1,!1)}),i)if(a){n._insertPanel.indexedButtons[Object.keys(n._insertPanel.indexedButtons)[0]].focus()}else t("#saveInsertRow").parent().focus()}}),function(){let n=!1;const a=function(e){e.forEach(e=>{e.th.remove()})};t.extend(App.pcTableMain.prototype,{_rerenderColumnsFooter:function(){let e=this._createFootersTableBlock();this._footersBlock.replaceWith(e),this._footersBlock=e},_rerendParamsblock:function(){this._createParamsBlock(),this.isMobile&&this._refreshParamsBlock()},_rerendFiltersBlock:function(){this._filtersBlock.replaceWith($block=this._createFiltersBlock()),this._filtersBlock=$block,this._refreshFiltersBlock(this.data_params)},_rerendBottomFoolers:function(){this._createFootersSubtable(),this.isMobile&&this._refreshFootersBlock()},_renderTable:function(){let e=this;this._table=t("<table>").addClass(this.tableClass),this.notCorrectOrder&&this._table.addClass("no-correct-n-filtered"),this._table.append(this._createHead()).append(this._createFirstBody()).append(this._createBody()).append(this._createAfterBody()),this._footersBlock=this._createFootersTableBlock(),this._table.append(this._footersBlock),this._popovers=t('<div class="popovers">'),1===this.fieldCategories.column.length&&e._container.addClass("no-fields");let n=this.scrollWrapper=this._container.append('<div class="pcTable-scrollwrapper">').find(".pcTable-scrollwrapper");n.append(this._createBeforeSpace()).append(this._createTableText()),this.isCreatorView&&n.append(this._refreshHiddenFieldsBlock()),this._paramsBlock=this._createParamsBlock(n);let i=t('<div class="pcTable-rowsWrapper">').appendTo(n);i.append(this._createRowsTitle(i)).append(this._createFiltersBlock()).append(()=>{if(this.tableRow.pagination&&"0/0"!==this.tableRow.pagination)return this._pagination()}).append(this._rowsButtons()).append(this._innerContainer),this._footersSubTable=this._createFootersSubtable(n),n.append(this._footersSubTable).append(this._popovers),this.addScrollsRules(),this._seeCalcucatedValData(),this._seeSelectPreview(),this._clickstoCopyMe(),this.isCreatorView&&this._hideHell_storage.checkIssetFields.call(this)},_refreshHiddenFieldsBlock:function(){let e=this._hiddenFieldsBlock();return this.HiddenFieldsBlock&&this.HiddenFieldsBlock.replaceWith(e),this.HiddenFieldsBlock=e,this.HiddenFieldsBlock},_hiddenFieldsBlock:function(){let e,n,i=this,a=0,l=t('<div class="pcTable-hiddenFieldsTables">'),o=0;if(this.beforeSpaceHide||!this._hideHell_storage.getOpened.call(this))return l;let s=this._container.width()-100;return t.each(i.hidden_fields||[],function(r,c){a++;let d=c.width>0?c.width:100;(0===o||s<o+d)&&(e&&e.width(o),e=t("<table class='pcTable-hiddenFieldsTable'><thead><tr></tr></thead></table>\""),l.append(e),o=0,n=e.find("thead tr")),n.append(i._createHeadCell(r,c)),o+=c.width}),i.isCreatorView&&Object.keys(i.fields).forEach(function(r,c){let d=i.fields[r];if(d.showInWeb&&d.showMeWidth<1&&"n"!==d.name){a++;let r=d.width>0?d.width:100;(0===o||s<o+r)&&(e&&e.width(o),e=t("<table class='pcTable-hiddenFieldsTable'><thead><tr></tr></thead></table>\""),l.append(e),o=0,n=e.find("thead tr")),n.append(i._createHeadCell(c,d)),o+=d.width}}),e&&e.width(o),a?l:t('<div class="pcTable-hiddenFieldsTables">')},_clickstoCopyMe:function(){this._container.on("click",".copy_me",function(){let e=t(this);return!e.data("clicked")&&(e.data("clicked",!0),e.width(e.width()),e.data("text")?App.copyMe(e.data("text")):App.copyMe(e.text()),e.button("copied"),setTimeout(function(){e.button("reset"),e.removeData("clicked")},2e3),e.blur(),!1)})},_clicksToCodeView:function(){let n=this;this._container.on("click","th .roles",function(){let i=t(this);if(i.hasClass(".fa-sun-o")||i.hasClass("fa-certificate")){let a,l=n._getFieldBytd(i.closest("th")),o=t('<div class="HTMLEditor" id="bigOneCodemirror" style="height: 100%;"></div>');BootstrapDialog.show({message:o,type:null,title:"Просмотр кода поля "+l.title,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){mirror.setValue(a.getValue())},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"})},onshown:function(t){a=CodeMirror(o.get(0),{mode:"totum",value:l.code[0],theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:t,readOnly:!0}),mirror.table&&(a.table=mirror.table);let n=Math.round(t.$modalContent.height()-t.$modalHeader.outerHeight()-40);a.getScrollerElement().style.minHeight=n+"px",o.find(".CodeMirror").css("min-heught",n),a.focus(),t.$modalContent.position({my:"center top",at:"center top+30px",of:e})}})}})},_seeCalcucatedValData:function(){var e=this;this._container.on("mouseover","td .fa-hand-paper-o",function(){if(!e.isMobile){var n=t(this),i=n.closest("td");if(i.closest("tr").is(".InsertRow"))return!1;var a=e._getItemBytd(i),l=e._getFieldBytd(i),o=t("<div>");let s="";null===a[l.name].c||""===a[l.name].c||void 0===a[l.name].c?s="":"select"===l.type?l.multiple?t.each(a[l.name].c,function(e,t){""!==s&&(s+=", "),s+=l.getElementString(a[l.name].c[e],a[l.name].c_[e])}):s=l.getElementString(a[l.name].c,a[l.name].c_):"object"==typeof(s=l.getCellText(a[l.name].c,null,a,e))&&(s=s.text()),o.append(t("<div>Расчетное значение: </div>").append(t("<code>").text(s))),n.one("mouseout",function(){o.length&&(o.remove(),o=null)}),setTimeout(function(){o&&o.length&&App.popNotify(o,n)},500)}})},_seeSelectPreview:function(){var e=this;t("body").on("mouseover",".select-with-preview li",function(n){let i=t(this),a=setTimeout(function(){if(i.is(":hover")){let t=i.find("span.select-with-preview");e.fields[t.data("field")]&&e.fields[t.data("field")].previewPanel.call(e.fields[t.data("field")],t,i)}},300);i.one("mouseout",function(){a&&clearTimeout(a)})})},_getFavoriteStar:function(){let e=this.tableRow.__is_in_favorites=this.tableRow.__is_in_favorites||!1,n=t("#favorite-start"),i=this;return null===e?t():(0===n.length&&(n=t('<button class="btn btn-default btn-sm" id="favorite-start"></button>').on("click",function(){i.model.setTableFavorite(!n.is(".stared")).then(function(e){i.tableRow.__is_in_favorites=e.status,i._getFavoriteStar.call(i)})})),e?n.addClass("stared").text("★"):n.removeClass("stared").text("☆"),n)},_createBeforeSpace:function(){let n,a=this;if(this._beforeSpace=t('<div class="pcTable-beforeSpace">'),!a.beforeSpaceHide){a.LogButton=t(),n=t('<div class="pcTable-topButtons">');let e=t("#TOTUM_FOOTER");if(e.length&&n.append(e),a.isCreatorView){let i=t('<div class="creator-log-buttons">'),l=t('<button class="btn btn-danger btn-sm"><i class="fa" style="width: 12px"></i> Показать логи</button>').appendTo(i).on("click",function(){let e;const n=function(){let n=[];e.find("input:checked").each(function(e,i){n.push(t(i).attr("name"))}),n.length>0?l.find("i").attr("class","fa fa-check-square-o"):l.find("i").attr("class","fa fa-square-o"),t.cookie("pcTableLogs",JSON.stringify(n),{path:"/"}),a.FullLOGS=[],a.LOGS={},l.popover("destroy")};if(l.is("[aria-describedby]"))e=t("#"+l.attr("aria-describedby")),n();else{let i=t.cookie("pcTableLogs")||"[]";i=JSON.parse(i),(e=t("<div>")).append('<div><input type="checkbox" name="c"/> Код</div>'),e.append('<div><input type="checkbox" name="a"/> Код-действия</div>'),e.append('<div><input type="checkbox" name="s"/> Селекты</div>'),e.append('<div><input type="checkbox" name="f"/> Форматирование</div>'),e.append('<div><input type="checkbox" name="recalcs"/> Пересчеты и селекты</div>');let o=t('<button class="btn btn-xs"><i class="fa fa-table"></i></button>').on("click",function(){a.FieldLOGS?a.model.calcFieldsLog(JSON.stringify(a.FieldLOGS),a.FieldLOGSName||"Расчет вывода таблицы"):App.notify("Лог расчета полей пуст")});e.append(t('<div><input type="checkbox" name="flds"/> Время расчета полей </div>').append(o)),e.append('<div style="padding-top: 10px;"><button class="btn btn-sm btn-default">Применить</button></div>'),e.find("input").each(function(e,n){n=t(n),-1!==i.indexOf(n.attr("name"))&&n.prop("checked","checked")}),e.on("click","button",function(){n()}),l.popover({trigger:"manual",placement:"bottom",content:e,html:!0,animation:!1,container:a._container,onhide:function(){}}).popover("show")}}),o=l.find("i"),s=t.cookie("pcTableLogs")||"[]";(s=JSON.parse(s)).length>0?o.addClass("fa-check-square-o"):o.addClass("fa-square-o");let r=t('<button class="btn btn-danger btn-sm">Лог</button>').appendTo(i);a.LogButton=r,r.on("click",function(){a.FullLOGS&&0!==a.FullLOGS.length?App.logOutput(a.FullLOGS):App.logOutput("Лог пуст. Включите логирование и перегрузите страницу")}),e.length?e.append(i):i.appendTo(n),t('<button class="btn btn-danger btn-sm"><i class="fa fa-eraser" style="width: 13px"></i></button>').on("click",function(){a.FullLOGS=[],a.LOGS={}}).appendTo(i)}}let l=t('<span class="common-table-title">');if(!a.isMobile){l.append(this.fieldsHiddingGetButton(!0));t('<button class="btn btn-default btn-sm"><i class="fa fa-print"></i></button>').on("click",function(){a._print.call(a)}).appendTo(l);if(a.withCsvButtons){let e=t('<button class="btn btn-default btn-sm">CSV-экспорт</button>').on("click",function(){let n=t('<div><div class="menu-item" data-type="full">Полный</div><div class="menu-item"  data-type="rows">Только строки</div></div>');n.on("click",".menu-item",function(){let e=t(this).is('[data-type="full"]')?"full":"rows";n.remove(),a._csvExport(e)});let i=App.popNotify({isParams:!0,$text:n,element:e,container:this._container,trigger:"manual",placement:"bottom"});t("#"+i).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",function(){n.remove()}).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px")});l.append(e)}if(a.withCsvEditButtons&&this.control.editing){let e=t('<button class="btn btn-default btn-sm">CSV-импорт</button>').on("click",function(){let n=t('<div><div class="menu-item" data-type="full">Полный</div><div class="menu-item"  data-type="rows">Только строки</div></div>');n.on("click",".menu-item",function(){let e=t(this).is('[data-type="full"]')?"full":"rows";n.remove(),a._csvImportClick(e)});let i=App.popNotify({isParams:!0,$text:n,element:e,container:this._container,trigger:"manual",placement:"bottom"});t("#"+i).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",function(){n.remove()}).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px")});l.append(e)}}if(this.isAnonim||a.beforeSpaceHide||l.append(this._getFavoriteStar()),this.isCreatorView&&this.isMain){let l=t('<div class="creator-buttons">');t('<button class="btn btn-default btn-xxs field_name copy_me" data-copied-text="Скопировано"/>').text(this.tableRow.name).appendTo(l),t('<button class="btn btn-danger btn-xxs" title="Редактировать настройки таблицы"/>').html('<i class="fa fa-pencil-square-o"></i>').on("click",function(){new EditPanel(1,BootstrapDialog.TYPE_DANGER,{id:a.tableRow.id}).then(function(t){t&&e.location.reload(!0)})}).appendTo(l);let o={fl_name:[this.tableRow.id]};if(t('<a href="/Table/'+this.Tables.branchId+"/"+this.Tables.id+"/?"+t.param({f:o})+'" target="_blank" class="btn btn-danger btn-xxs" title="Открыть список таблиц"/>').html('<i class="fa fa-external-link"></i>').appendTo(l),o={f_table_categories:this.tableRow.category,f_table:this.tableRow.id},this.tableRow.__version&&(o.fl_version=this.tableRow.__version),t('<a href="/Table/'+this.Tables.branchId+"/"+this.TableFields.id+"/?"+t.param({f:o})+'" target="_blank" class="btn btn-danger btn-xxs" title="Открыть состав таблиц"/>').html('<i class="fa fa-external-link-square"></i>').appendTo(l),"calcs"===this.tableRow.type){l.append(" ");let e=t('<a href="/Table/'+this.TablesVersions.branchId+"/"+this.TablesVersions.id+"/?"+t.param({f:this.TablesVersions.version_filters})+'" target="_blank" class="btn btn-danger btn-xxs" title="Создание версий таблиц"><i class="fa fa-code-fork"></i></a>');l.append(e),l.append(" "),e=t('<a href="/Table/'+this.TablesCyclesVersions.branchId+"/"+this.TablesCyclesVersions.id+"/?"+t.param({f:this.TablesCyclesVersions.version_filters})+'" target="_blank" class="btn btn-danger btn-xxs" title="Изменение версий таблиц цикла"><i class="fa fa-random"></i></a>'),l.append(e)}let s=t('<div class="color-danger creator-table-title">'+ +this.tableRow.sort+' <i class="'+App.tableTypes[this.tableRow.type].icon+'"></i> '+App.tableTypes[this.tableRow.type].title+" ["+this.tableRow.actual+"]</div>");l.append(s),"calcs"===this.tableRow.type&&s.append(" / Версия "+this.tableRow.__version+" / Цикл "+this.tableRow.cycle_id);t('<button class="btn btn-danger btn-sm" id="hide-hell" disabled><i class="fa fa-times"></i></span></button>').on("click",function(){a._hideHell_storage.switchOpened.call(a)}).appendTo(l);l.appendTo(n);t('<button class="btn btn-danger btn-sm">Добавить поле</span></button>').width(113).on("click",function(){let t={table_id:{v:a.tableRow.id},data_src:{v:i}};a.tableRow.__version&&(t.version={v:a.tableRow.__version}),new EditPanel(2,BootstrapDialog.TYPE_DANGER,t).then(function(t){t&&e.location.reload(!0)})}).appendTo(l);l.appendTo(n)}if(a.beforeSpaceHide)this._beforeSpace_title=t('<div class="pcTable-title"><span class="bttns"/></div>').prependTo(this._beforeSpace);else if(this._beforeSpace.append(n),this._beforeSpace_title=t('<div class="pcTable-title"><span class="title"/><span class="bttns"/><div class="updated"/></div>').prependTo(this._beforeSpace),"calcs"===this.tableRow.type&&e.TREE_DATA){let n,i,a=t('<div class="pcTable-tabls"><ul class="nav nav-tabs"></div>'),l=a.find("ul");if(e.location.pathname.match(/^\/[^\/]+\/\d+\/\d+\/\d+\/\d+$/)){n=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+).*?$/,"$1"),i=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+\/[^\/]+).*?$/,"$1");let t=!1;e.TREE_DATA.forEach(e=>{e.isCycleTable&&(t||(e.isOneUserCycle||l.append('<li><a href="/Table/'+i+'/"><i class="fa fa-arrow-left"></a></li>'),t=!0),e.id==="table"+this.tableRow.id?l.append('<li class="active"><a class="tab-title">'+e.text+"</a></li>"):l.append('<li><a href="/Table/'+n+"/"+e.href+'">'+e.text+"</a></li>"))})}else{i=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+).*?$/,"$1");let t=!1;e.TREE_DATA.forEach(e=>{e.isCycleTable&&(t||(l.append('<li><a href="/Table/'+i+'/"><i class="fa fa-arrow-left"></a></li>'),t=!0),e.id==="table"+this.tableRow.id?l.append('<li class="active"><a class="tab-title">'+e.text+"</a></li>"):l.append('<li><a href="'+e.link+'">'+e.text+"</a></li>"))})}this._beforeSpace.append(a)}if(this._beforeSpace_title.append(l),this.tableRow.description){let e=t('<a class="btn btn-default btn-sm"><i class="fa fa-info"></i></a>'),n=t('<div class="table-description"/>').html(this.tableRow.description);e.appendTo(l);let i="table_description_switcher"+this.tableRow.id,a=localStorage.getItem(i)||localStorage.setItem(i,"1")||localStorage.getItem(i);const o=t=>{switch(t&&(a="1"===a?"0":"1"),a){case"1":n.show(),e.removeClass("btn-warning").addClass("btn-default");break;default:n.hide(),e.addClass("btn-warning").removeClass("btn-default")}localStorage.setItem(i,a),t&&this.ScrollClasterized.insertToDOM(0,!0)};o(),e.on("click",o),this._beforeSpace.append(n)}return this._beforeSpace},__$rowsButtons:null,_paginationCreateBlock:function(){let{offset:e,onPage:n,allCount:i}=this.PageData;if("0"==n)return"";let a,l,o,s,r=t("<span></span>"),c=0===e?0:Math.ceil(e/n),d=Math.ceil(i/n);a=e>0?t('<button class="btn btn-default btn-sm"><i class="fa fa-hand-o-left"></i></button>').on("click",()=>(this.model.loadPage(this,null,this.PageData.onPage,this.PageData.firstId),!1)):t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-hand-o-left"></i></button>'),e+n<i?(l=t('<button class="btn btn-default btn-sm"><i class="fa fa-hand-o-right"></i></button>').on("click",()=>{Object.keys(this.data);return this.model.loadPage(this,this.PageData.lastId,this.PageData.onPage),!1}),s=t('<button class="btn btn-default btn-sm"><i class="fa fa-long-arrow-right"></i></button>').on("click",()=>(this.model.loadPage(this,null,this.PageData.onPage,-1),!1))):(l=t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-hand-o-right"></i></button>'),s=t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-long-arrow-right"></i></button>')),o=c>0?t('<button class="btn btn-default btn-sm"><i class="fa fa-long-arrow-left"></i></button>').on("click",()=>(this.model.loadPage(this,0,this.PageData.onPage),!1)):t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-long-arrow-left"></i></button>');let f=t('<span id="ttm-onpage-input"></span>'),p=t('<input class="form-control" type="number">').appendTo(f).wrap("<span>");return p.val(n),p.on("change",()=>{this.PageData.onPage=p.val(),this.model.loadPage(this,0,p.val())}),r.append(o),r.append(a),r.append('<span class="ttm-pages">'+(c+1)+" из "+d+"</span>"),r.append(l),r.append(s),r.append(f),f.append(" из "+i),d>1&&r.addClass("ttm-pagination-warning"),r},_pagination(){if(void 0===this.PageData||this.PageData.loading){this.PageData||(this.PageData={$block:t('<div class="ttm-pagination"></div>')});let e=null;if(this.data){let t=Object.keys(this.data);t.length>0&&(e=t[t.length-1])}let n=this.tableRow.pagination.split("/"),i=this.isMobile?n[1]:n[0];return this.PageData.onPage=parseInt(i),this.model.loadPage(this,e,i),this.PageData.$block.empty().append('<i class="fa fa-spinner"></i>')}return this.PageData.$block.empty().append(this._paginationCreateBlock())},_rowsButtons:function(){let e,n=this;if(this.__$rowsButtons?e=this.__$rowsButtons.empty():(e=t('<div class="pcTable-buttons">'),this.__$rowsButtons=e),this.fieldCategories.column.length){if(this.control.adding&&!this.f.blockadd){let t=n._getInsertButtons();e.append(t)}let i=t('<button class="btn btn-default btn-sm" style="margin-left: 5px;" disabled>Сбросить <span class="fa fa-filter"></span></button>').width(82).on("click",function(){setTimeout(function(){n.filtersEmpty.call(n)},50)});e.append(i),this.filtersClearButton=i}if(this.f.tablecomment){let i=t('<div class="pcTable-tableComment">').on("click",function(){App.panel("Комментарий строчной части таблицы",n.f.tablecomment)});e.prepend(i.text(this.f.tablecomment)),setTimeout(function(){let e=0;e+=i.parent().find(">span").width()||0,e+=90,i.css("width","calc(100% - "+e+"px)")},1)}return e},_refreshContentTable:function(e,t){let n=this._content;t=t||!1,n.data("state","refreshing");App.fullScreenProcesses.showCog();this.ScrollClasterized.insertToDOM(0,t,e),App.fullScreenProcesses.hideCog(),n.data("state","ready"),n.trigger("refreshed"),this._popovers.empty()},_refreshTitle:function(){if(!this.beforeSpaceHide&&(this._beforeSpace_title.find(".title").text(this.f.tabletitle||this.tableRow.title),this.model.tableData&&this.model.tableData.updated)){let e;this.isAnonim||(e=moment(this.model.tableData.updated.dt,"YYY-MM-DD HH:mm").format("DD.MM HH:mm")+" (code: "+this.model.tableData.updated.code+")");let n=t('<div class="small">').text(e);this.tableRow.__blocked?n.append('<div class="">Блокирована'+(this.tableRow.license_error?": "+this.tableRow.license_error:"")+"</div>"):!1===this.control.editing&&n.append('<div class="">Только чтение</div>'),this._beforeSpace_title.find(".updated").html(n)}},_createTableText:function(){return this.tableText=t('<div class="pcTable-tableText"></div>').text(this.f.tabletext),this.tableText},_refreshTableText:function(){this.tableText.text(this.f.tabletext)},_createRowsTitle:function(e=null){let n=this;n.__sectionsCloses=n.__sectionsCloses||JSON.parse(localStorage.getItem("sectionCloses")||"{}");let i=n.tableRow.id+"/"+(n.tableRow.__version||0)+"/rows",a=t('<div class="pcTable-rowsTitle"></div>').on("click","i, span",function(){let e=t(this).closest(".pcTable-rowsWrapper");e.is(".pcTable-rowsClose")?(e.removeClass("pcTable-rowsClose"),delete n.__sectionsCloses[i],n.ScrollClasterized.reloadScrollHead()):(e.addClass("pcTable-rowsClose"),n.__sectionsCloses[i]=1),n.ScrollClasterized.insertToDOM(0,!0),localStorage.setItem("sectionCloses",JSON.stringify(n.__sectionsCloses))});return e&&e.is(".pcTable-rowsClose")&&!n.__sectionsCloses[i]?e.removeClass("pcTable-rowsClose"):e&&!e.is(".pcTable-rowsClose")&&n.__sectionsCloses[i]&&e.addClass("pcTable-rowsClose"),this.f.rowstitle?a.html(t("<span>").text(this.f.rowstitle)).prepend('<i class="fa">'):a.text(),a},_createFiltersBlock:function(){let n=this;t("<div>");if(this._filtersBlock=t("<div>"),this._filtersBlock.addClass("pcTable-filtersTables pcTable-section"),n.fieldCategories.filter.length){let i,a,l;this.___createClosedSection(this._filtersBlock,t('<div class="pcTable-sectionTitle"><span>Фильтры</span></div>').appendTo(this._filtersBlock),"flt"),this._filtersBlock.addClass("pcTable-filtersTables");let o,s=0,r=this._container.width()-140;const c=function(){if(i){const o=function(){let i=t(this);const a=function(){let a;a=i.is(".eraser")?"?":"?"+t.param({f:n._filtersBlock.data("cryptoFilters")||n.filtersString}),n.isMobile&&(a+="#go-buttons"),e.location.href=a};return setTimeout(function(){n.model.doAfterProcesses(()=>{setTimeout(a,100)})},500),!0};if(n.isMobile)i.after(t('<table class="pcTable-filtersTable" id="go-buttons"><tr><td><button class="btn btn-default btn-xs button-go">GO</button> <button class="btn btn-default btn-xs eraser button-go "><i class="fa fa-eraser"></i></button></td></tr></td></table>').on("click",".button-go",o));else{a.append('<th style="width: 69px;"></th>');let e=t('<td class="buttons-go">').html('<button class="btn btn-default btn-xs button-go">GO</button> <button class="btn btn-default btn-xs eraser button-go"><i class="fa fa-eraser"></i></button>').appendTo(l);i.width(s+69),e.on("click",".button-go",o)}}},d=(e,d)=>{d.hidden||((n.isMobile||0===s||r<s+d.width||d.tableBreakBefore)&&(n.isMobile||c(),i=t("<table class='pcTable-filtersTable'><thead><tr></tr></thead><tbody><tr></tr></tbody></table>").appendTo(this._filtersBlock),s=0,a=i.find("thead tr"),l=i.find("tbody tr")),void 0!==d.panelColor&&(o=d.panelColor),a.append(n._createHeadCell(e,d,o)),t("<td>").attr("data-field",d.name).appendTo(l),s+=d.width)};t.each(n.fieldCategories.filter,d),c()}return this._filtersBlock},_refreshFiltersBlock:function(e){let n=this;(e=e||{}).params?(t.each(n.fieldCategories.filter,function(t,i){n.data_params[i.name]=e.params[i.name]}),n._filtersBlock.data("cryptoFilters",e.filtersString)):n.filterData||(n.filterData={},t.each(n.fieldCategories.filter,function(e,i){n.filterData[i.name]=t.extend(!0,{},n.data_params[i.name])}),n.model.addFiltersData({filters:n.filtersString}));let i=[],a=[];return t.each(n.fieldCategories.filter,function(e,t){if(t.hidden)return;let l=n._createCell(n.data_params,t);n._filtersBlock.find('td[data-field="'+t.name+'"]').replaceWith(l),Object.equals(n.data_params[t.name].v,n.filterData[t.name].v)||i.push(l),"select"!==t.type||!n.data_params[t.name].v||"*NONE*"!==n.data_params[t.name].v&&"*NONE*"!==n.data_params[t.name].v[0]||a.push(l)}),i.length>0?(i.forEach(function(e){e.addClass("warning-backg")}),n._filtersBlock.removeClass("with_danger").addClass("with_changed")):a.length>0?(a.forEach(function(e){e.addClass("danger-backg")}),n._filtersBlock.removeClass("with_changed").addClass("with_danger")):(n._filtersBlock.removeClass("with_danger, with_changed"),n._filtersBlock.find(".danger-backg, .warning-backg").removeClass("danger-backg, warning-backg")),this._filtersBlock},__fillFloatBlock:function(e,n){let i,l,o,s=this,r="",c={_ALL:!0},d=0,f=!1,p=!1,h=!1,u=!1,m=!1,b=[];const g=(e,t,n,i)=>{e||(e={});const a=e=>{if(i){let t=e.split(/\s*\/\s*/);return t.length>1?{_big:l(t[0]),_small:l(t[1])}:{_big:l(e),_small:l(e)}}return l(e)},l=e=>{switch(e){case"false":case"FALSE":e=!1;break;case"true":case"TRUE":e=!0}return e=n(e)};return 2===t.length?e=a(t[1]):/^([a-z_0-9]+\s*,?\s*)+$/.test(t[1])?t[1].split(/\s*,\s*/).forEach(n=>{e[n]=a(t[2])}):e=a(t[1]),e};t.each(n,function(e,n){if(void 0!==n.panelColor?i=n.panelColor:n.panelColor=i,void 0!==n.sectionTitle){c={_ALL:!0},r=n.sectionTitle.trim(),d=0,f=!1,p=!1,h=!1,u=!1,o=n;let e={},i=r.match(/\*\*(.*)/);i&&(i[1].trim().split(/\s*;\s*/).forEach(t=>{let n=t.trim().split(/\s*:\s*/);if(n[0]=n[0].toLowerCase(),n.length>1)switch(n[0]){case"outline":p=g(p,n,e=>!0===e?"#e4e4e4":e,!0);break;case"title":e.title=e.title||{_ALL:!0};let t=g({},n,e=>e);"boolean"==typeof t?e.title._ALL=t:e.title={...e.title,...t};break;case"border":h=g(h,n,e=>!1===e?"transparent":e,!0);break;case"plate":f=g(f,n,e=>!1===e?"transparent":e,!0);break;case"platemh":u=g(u,n,e=>"string"==typeof e&&/^\d+$/.test(e)?e+"px":e,!0);break;case"plateh":m=g(m,n,e=>"string"==typeof e&&/^\d+$/.test(e)?e+"px":e,!0);break;case"gap":e.gap=g(e.gap,n,e=>e);break;default:switch(n[1]){case"true":case"TRUE":e[n[0]]=!0;break;case"false":case"FALSE":e[n[0]]=!1}}}),d=e.gap||d),c="title"in e?e.title:c,s.isCreatorView?r=r.replace(/(\*\*.*)/,""):!1===e.lable?r="":(r=r.replace(/(\*\*.*)/,""),r=t("<div>").text(r.trim()).html())}(!l||n.tableBreakBefore&&n.sectionTitle)&&(l=[],b.push({title:r,fields:l,withTitles:c,sectionGap:d,plate:f,sectionField:o,outline:p,border:h,plateh:m,platemh:u}),r=""),n.showMeWidth&&l.push({field:n,panelColor:i})});const v=(e,t)=>{let n=-1,i=e.fieldCell;t&&(i.prev().is("br")||i.is(":first-child")||i.prev().is('[data-type="blocknum"]')||("object"!=typeof t?n=t:e.format.blocknum in t?n=t[e.format.blocknum]:e.field.name in t&&(n=t[e.field.name]),n&&/^\d+$/.test(n)&&(n=parseInt(n)-1,n+="px"))),i.css("marginLeft",n)};b.forEach(n=>{let i=t('<div class="pcTable-section ">').appendTo(e),l=n.sectionGap;if(n.title||s.isCreatorView&&n.sectionField){let e=t("<span>").html(n.title);s.isCreatorView&&(t('<span class="danger"> <i class="fa fa-edit" style="font-size: 14px; padding-left: 10px;"></i></span>').on("click",()=>(this.__editSectionTitle(n.sectionField),!1)).appendTo(e),t('<span class="danger"> <i class="fa fa-times" style="font-size: 14px; padding-left: 5px;"></i></span>').on("click",()=>(this.__deleteSection(n.sectionField),!1)).appendTo(e)),s.___createClosedSection(i,t('<div class="pcTable-sectionTitle"></div>').html(e).appendTo(i),"p")}let o=t('<div class="pcTable-floatBlock">').appendTo(i);if(!o.is(":visible"))return void i.data("closedrender",!0);let r,c=0,d=[],f=[d],p=[f];n.fields.forEach((e,a)=>{e.field.tableBreakBefore&&0!==a&&(o=t('<div class="pcTable-floatBlock">').appendTo(i),f=[d=[]],p.push(f)),s.data_params[e.field.name]=s.data_params[e.field.name]||{},e.format=s.data_params[e.field.name].f||{};let l=e.format.blocknum||0;void 0!==e.format.blocknum&&i.addClass("sectionWithPannels"),(0===d.length||d[d.length-1].num!=l||e.field.tableBreakBefore&&0!==a)&&(r=t('<div class="pcTable-floatInner">').appendTo(o),l&&s.isCreatorView&&r.append('<div data-type="blocknum" style="position:absolute;z-index: 100; color: #ff8585; background-color: #fff; padding: 3px; font-size: 10px; right: 4px; top: 4px;">'+l+"</div>"),n.outline&&(l in n.outline?r.data("border-color",n.outline[l]):r.data("border-color",n.outline)),n.plate&&(l in n.plate?r.data("plate",n.plate[l]):r.data("plate",n.plate)),n.plateh&&(l in n.plateh?r.data("plateh",n.plateh[l]):r.data("plateh",n.plateh)),n.platehm&&(l in n.platehm?r.data("platehm",n.platehm[l]):r.data("platehm",n.platehm)),d.push({div:r,num:l,isWrappable:!1,sec:n,fields:[]}));let h=d[d.length-1];h.fields.length>0&&!e.format.nextline&&(h.isWrappable=!0),h.fields.push(e),e._showMeWidth=e.field.showMeWidth,e.format.breakwidth&&(e.field.showMeWidth=e.format.breakwidth),e.format.nextline&&a>0&&r.append("<br/>");let u=t("<div>").appendTo(r);u.width(e.field.showMeWidth+1),u.attr("data-field-type",e.field.type),e.field.isNoTitles=!1,"withTitles"in n&&(e.field.name in n.withTitles?e.field.isNoTitles=!n.withTitles[e.field.name]:l&&l in n.withTitles?e.field.isNoTitles=!n.withTitles[l]:"_ALL"in n.withTitles&&(e.field.isNoTitles=!n.withTitles._ALL));let m=s._createHeadCell(null,e.field,e.panelColor).appendTo(u),b=t('<div class="td-wrapper">').appendTo(u),g=s._createCell(s.data_params,e.field).appendTo(b);if(e.format.maxheight){let t={maxHeight:e.format.maxheight};e.format.height&&(t.minHeight=e.format.height,b.css("minHeight",e.format.height)),g.height(""),u.css(t),u.addClass("nonowrap")}else e.format.height&&(g.height(""),u.addClass("nonowrap"),u.height(e.format.height));e.field.isNoTitles?s.isCreatorView?m.addClass("no-titled"):m.empty():(m.css("display","table-cell"),e.th=m,m.height()>c&&(c=m.height())),e.td=g,e.th=m.width(""),e.tdWrapper=b,e.fieldCell=u,s.isCreatorView&&(e.format.glue&&u.addClass("f-glue"),e.format.fill&&u.addClass("f-fill"))}),n.fields.forEach(e=>{let t=0;if(e.th){e.th.css("display","");let n=21;s.isCreatorView&&(n=40),e.th.height(n),t=e.th.outerHeight()}e.format.maxheight?e.tdWrapper.css("maxHeight",e.format.maxheight-t-10):e.format.height&&!e.format.maxheight&&e.tdWrapper.css("height",e.format.height-t),v(e,l)});const h=function(e){if(!e.length)return 0;let t,n,i=e[0].div.parent(),a=i.position().left+parseInt(i.css("paddingLeft"))+i.width();for(let i in e){let i=e[e.length-1].div;i.w=!1;let a=i.position().left+i.outerWidth();(!t||a>t)&&(t=a,n=e[e.length-1])}return n.w=!0,a-t},u=function(e){let t=!0;return e.some((e,n)=>{if(h(e)<0)return t=!1,!0}),t};let m=!1;p.forEach(function(e,n){let i=0;for(;++i<400&&!u(e);)e.forEach(function(t,n){if(h(t)<0){m=!0;for(let e=t.length-1;e>=0;e--){let n=t[e];if(n.isWrappable&&n.w){let e,t,i;for(let a=n.fields.length-1;a>=1;a--){let l=n.fields[a];l.i=a,(!i||l.fieldCell.position().left>i)&&(i=l.fieldCell.position().left,e=l,t=a)}if(e&&!e.format.nextline&&!e.fieldCell.prev().is("br")){if(e.format.glue)for(;;){if(!e.i){e=null;break}if(t=(e=n.fields[e.i-1]).i,e.format.nextline||e.fieldCell.is(":first-child")||e.fieldCell.prev().is("br")){e=null;break}if(!e.format.glue)break}if(e){e.fieldCell.before('<br class="wrapped"/>'),e.fieldCell.nextAll("br.wrapped").remove();for(let e=t;e<=n.fields.length-1;e++)v(n.fields[e],l);return}}}}let n=e[0].length-1;if(n>0){let t=e[0][n];t.div.before("<br/>"),e.push([t]),e[0].splice(n,1),e.forEach(function(e){e.forEach(function(e){e.div.find("br.wrapped").remove(),e.fields.forEach(e=>v(e,l))})})}}});e.forEach(function(e,n){e.forEach(({div:e,fields:t})=>{t.forEach(e=>{e.format.breakwidth&&(e.fieldCell.css("width",e._showMeWidth),e.field.showMeWidth=e._showMeWidth)})}),function(e,n){if(!e.length)return;/Safari/.test(navigator.userAgent)&&e.forEach(function(e){e.div.width(100),e.div.width("")});let i=h(e),a=0+parseInt(e[0].div.css("paddingTop")),l=[],o=[],s=0;e.forEach(function(e){let t,i=null,r={width:0,fields:[]};e.fields.forEach(function(e){(e.format.maxwidth&&e.field.width<e.format.maxwidth||e.format.fill&&(n||e.fieldCell.position().top!==a||null===a))&&(i!=e.fieldCell.position().top&&(i=e.fieldCell.position().top,r={width:0,fields:[]},i!==a?o.push(r):l.push(r)),r.fields.push(e),r.width+=e.field.width,i===a&&(s+=e.field.width)),t=e.fieldCell})});const r=function(e){let n,i,a=e.fields[0].fieldCell.parent(),l=e.fields[0].fieldCell.position().top;a.find(">div").each(function(e,a){let o=t(a),s=o.position();s.top===l&&(!n||s.left>n)&&(n=s.left,i=o)});let o=a.width()+parseInt(a.css("paddingLeft"))-n-i.outerWidth(!0),s=0,r=0;for(;r++<100&&e.fields.length&&o>1;)e.fields.forEach(function(t,n){if(o>s){let i=Math.round(o/e.width*t.field.width);t.format.fill||t.format.maxwidth<=t.fieldCell.width()+i&&(i=t.format.maxwidth-t.fieldCell.width(),e.fields.splice(n,1),e.width-=t.field.width),s+=i,t.fieldCell.width(t.fieldCell.width()+i)}}),o-=s,s=0};l.forEach(r);let c=i,d=0,f=0;for(;c>1&&f++<6&&l.length;)l.forEach(function(e,t){e.fields.forEach(function(t,i){if(c>d){let a=Math.round(c/s*t.field.width);a>c-d&&(a=c-d),n&&t.format.fill||!(t.format.maxwidth<=t.fieldCell.width()+a)||(a=t.format.maxwidth-t.fieldCell.width(),e.fields.splice(i,1),s-=t.field.width),d+=a,t.fieldCell.width(t.fieldCell.width()+a)}}),0===e.fields.length&&l.splice(t,1)}),c-=d,d=0;o.forEach(r)}(e,m),e.forEach(({div:e,fields:t,sec:n,blocknum:i})=>{let l=[],o=!0;t.forEach(e=>{if(e.fieldCell.prev().is("br")&&(!s.isCreatorView&&l.length&&a(l),l=[],o=!0),e.field.isNoTitles?o&&l.push(e):(l=[],o=!1),n.border){let t;if(t=e.field.name in n.border?n.border[e.field.name]:i in n.border?n.border[i]:n.border){let n=n=>{let i=m?t._small:t._big,a={borderColor:i};return"transparent"===i?(n.background||e.panelColor||(a.backgroundColor="transparent"),"button"===e.field.type&&(e.fieldCell.addClass("no-border"),a.Button={},n.background&&(a.Button.backgroundColor=n.background),n.color&&(a.Button.color=n.color),e.td.find("button").css(a.Button),a.backgroundColor="transparent")):!0===i&&(a.borderColor="",a.backgroundColor=""),a};e.td.css(n(e.format)),e.field.td_style=n}}}),!s.isCreatorView&&l.length&&a(l);let r={};if(e.data("plateh")){let t=e.data("plateh"),n=m?t._small:t._big;!1!==n&&(r.height=n,r.overflow="auto")}if(e.data("platemh")){let t=e.data("platemh"),n=m?t._small:t._big;!1!==n&&(r.maxHeight=n,r.overflow="auto")}e.data("border-color")&&(r.borderColor=m?e.data("border-color")._small:e.data("border-color")._big),e.data("plate")&&(r.backgroundColor=m?e.data("plate")._small:e.data("plate")._big),e.css(r)})})})})},_createParamsBlock:function(e){let n=t("<div>");if(e)return n.appendTo(e),n;this._paramsBlock.replaceWith(n),this._paramsBlock=n;let i=this;if(i.fieldCategories.param)if(n.addClass("pcTable-paramsTables"),i.isMobile){let e,a,l,o,s,r="",c=!1;t.each(i.fieldCategories.param,function(d,f){void 0!==f.panelColor&&(o=f.panelColor),void 0!==f.sectionTitle&&(c=!1,(r=f.sectionTitle).match(/\*\*(.*)/)&&(r.match(/\*\*(.*)/)[1].trim().split(/\s*;\s*/).forEach(e=>{let t=e.trim().split(/\s*:\s*/);"nolable"===t[0]&&(t[1]&&"true"!==t[1].trim()||(r=""))}),r=r.replace(/(\*\*.*)/,""))),!f.showMeWidth||i.data_params[f.name].f&&i.data_params[f.name].f.hide&&i.data_params[f.name].f.hide.mobile||(e=t("<table class='pcTable-paramsTable'>"+(c?"":"<thead><tr></tr></thead>")+"<tbody><tr style='background-color: "+o+"'></tr></tbody></table>"),i.isMobile&&"button"===f.type&&(e=t("<table class='pcTable-paramsTable'><tbody><tr></tr></tbody></table>")),s&&!r||(s=t('<div class="pcTable-section">').appendTo(n),r&&i.___createClosedSection(s,t('<div class="pcTable-sectionTitle"></div>').html(t("<span>").text(r)).appendTo(s),"p")),r="",s.append(e),c||(a=e.find("thead tr")).append(i._createHeadCell(d,f,o)),(l=e.find("tbody tr")).append('<td data-field="'+f.name+'">'))})}else this.__fillFloatBlock(n,i.fieldCategories.param);return n},_refreshParamsBlock:function(e,n){var i=this;return i.fieldCategories.param&&t.each(i.fieldCategories.param,function(t,a){if(!a.showMeWidth||e&&!0!==e[a.name])return!0;let o=i._createCell(i.data_params,a),s=i._paramsBlock.find('td[data-field="'+a.name+'"]');s.css("minHeight")&&o.css("minHeight",s.css("minHeight")),s.replaceWith(o),n&&i._colorizeElement(o,l)}),this._paramsBlock},_createFootersSubtable:function(e){let n,i=this;if(n=t("<div class='pcTable-footersTables'>"),e)return n.appendTo(e),n;if(this._footersSubTable.replaceWith(n),this._footersSubTable=n,i.isMobile){let e,a,l,o,s,r,c=0,d=this._container.width()-100,f="";t.each(i.notTableFooterFields,function(p,h){void 0!==h.panelColor&&(o=h.panelColor),void 0!==h.sectionTitle&&(r=!1,(f=h.sectionTitle).match(/\*\*(.*)/)&&(f.match(/\*\*(.*)/)[1].trim().split(/\s*;\s*/).forEach(e=>{let t=e.trim().split(/\s*:\s*/);"nolable"===t[0]&&(t[1]&&"true"!==t[1].trim()||(f=""))}),f=f.replace(/(\*\*.*)/,""))),!h.showMeWidth||i.data_params[h.name].f&&i.data_params[h.name].f.hide&&i.data_params[h.name].f.hide.mobile||((i.isMobile||0===c||d<c+h.showMeWidth||h.tableBreakBefore)&&(e&&!i.isMobile&&e.width(c),e=t("<table class='pcTable-footersTable'><thead><tr></tr></thead><tbody><tr style='background-color: "+o+"'></tr></tbody></table>"),("button"===h.type||r)&&(e=t("<table class='pcTable-paramsTable'><tbody><tr></tr></tbody></table>")),s&&!f||(s=t('<div class="pcTable-section">').appendTo(n),f&&i.___createClosedSection(s,t('<div class="pcTable-sectionTitle"></div>').html(t("<span>").text(f)).appendTo(s),"f")),f="",s.append(e),c=0,a=e.find("thead tr"),l=e.find("tbody tr")),a.append(i._createHeadCell(p,h,o)),l.append('<td data-field="'+h.name+'">'),c+=h.showMeWidth)})}else this.__fillFloatBlock(n,i.notTableFooterFields);return n},_createFootersTableBlock:function(){let e,n=this;if(e=t("<tbody class='pcTable-footers'></tbody>"),n.fieldCategories.footer){let i={},a=0;t.each(n.fieldCategories.footer,function(e,t){!t.showMeWidth||n.data_params[t.name].f&&n.data_params[t.name].f.hide&&n.data_params[t.name].f.hide.mobile||(t.column||(t.column=""),i[t.column]||(i[t.column]=[]),i[t.column].push(t),t.column&&a<i[t.column].length&&(a=i[t.column].length))});let l=t(),o=0,s=0;for(;o<a;){let e=t('<tr><td class="id"></td></tr>'),a=t('<tr><td class="id"></td></tr>').data("pctableitemid","footers").data("pctablettemtndex","footers"+s++);t.each(n.fieldCategories.column,function(l,s){if(s.showMeWidth){let r=t("<td>");if(!i[s.name]||!i[s.name][o])return r.attr("rowspan",2),e.append(r),void r.addClass("footer-empty");if(r=n._createHeadCell(l,i[s.name][o],i[s.name][o].panelColor).addClass("footer-name"),e.append(r),i[s.name]&&i[s.name][o]){let e=i[s.name][o],t=n._createCell(n.data_params,e);t.attr("data-field",e.name),a.append(t)}}}),l=(l=l.add(e)).add(a),o++}e.html(l)}return e},___createClosedSection(e,n,i){const a=this;let l=e.parent().find(">div").index(e)+2,o=a.tableRow.id+"/"+(a.tableRow.__version||0)+"/"+i+"/"+l;a.__sectionsCloses=a.__sectionsCloses||JSON.parse(localStorage.getItem("sectionCloses")||"{}"),a.__sectionsCloses[o]&&e.addClass("closed"),t('<span class="btn-i"><i class="fa"></i></span>').prependTo(n),n.on("click","i, span",function(){let e=t(this).closest(".pcTable-section");if(e.is(".closed")){if(e.removeClass("closed"),delete a.__sectionsCloses[o],e.data("closedrender")){let e=a.scrollWrapper.parent().scrollTop();switch(i){case"p":a._rerendParamsblock();break;case"f":a._rerendBottomFoolers()}a.scrollWrapper.parent().scrollTop(e)}}else e.addClass("closed"),a.__sectionsCloses[o]=1;return localStorage.setItem("sectionCloses",JSON.stringify(a.__sectionsCloses)),a.ScrollClasterized.insertToDOM(null,!0),!1})},_refreshFootersBlock:function(e,n){let i=this,a=i._footersBlock.add(i._footersSubTable);return i.fieldCategories.footer&&t.each(i.fieldCategories.footer,function(t,o){if(!o.showMeWidth||e&&!0!==e[o.name])return!0;let s=i._createCell(i.data_params,o);s.attr("data-field",o.name),a.find('td[data-field="'+o.name+'"]').replaceWith(s),n&&i._colorizeElement(s,l)}),this._paramsBlock},_createHead:function(){return this._header=t("<thead>").append(this._createHeadRow()),this._header},_refreshHead:function(){return this._header.empty().append(this._createHeadRow()),this._header},_createFirstBody:function(){return this._beforebody=t("<tbody class='beforeRows'>").append('<tr class="extra-clasters">'),this.extraClastersTop=this._beforebody.find(".extra-clasters"),this._beforebody},_createAfterBody:function(){return this._afterbody=t("<tbody class='afterRows'>").append('<tr class="extra-clasters">'),this.extraClastersBottom=this._afterbody.find(".extra-clasters"),this._afterbody},_createBody:function(){return this._content=t("<tbody class='dataRows'>"),this._content},_createHeadRow:function(){let e=this,n=t("<tr>");e._createHeadCellId().appendTo(n);let i,a=n.find(".id").width();return e._table.removeClass("n-filtered"),t.each(this.fieldCategories.visibleColumns,function(t,l){let o;void 0!==l.panelColor&&(i=l.panelColor),"n"===l.name?(e._table.addClass("n-filtered"),o=e._createHeadCellNo()):o=e._createHeadCell(t,l,i),o.appendTo(n),a+=parseInt(l.showMeWidth)}),this.tableWidth=a,this._table.width(this.tableWidth),n},_createHeadCellId:function(){let e=this,n=t('<th class="id"><span>id</span></th>');if(null===e.tableRow.order_field||"id"===e.tableRow.order_field){let t=n.find("span").css("font-weight","bold");e.isCreatorView&&(!0===e.tableRow.order_desc?t.append(' <i class="fa fa-sort-amount-desc roles"></i>'):t.append(' <i class="fa fa-sort-amount-asc roles"></i>'))}let i=t('<div class="pcTable-filters"></div>'),a=t('<button class="btn btn-default btn-xxs" id="n-expander"><i class="fa fa-sort"></i></button>').on("click",function(){e.fieldCategories.visibleColumns.some(function(e){return"n"===e.name})?(e.fieldsHiddingHide.call(e,"n"),a.removeClass("btn-warning")):(e.fieldsHiddingHide.call(e,"n",!0),a.addClass("btn-warning")),e.ScrollClasterized.reloadScrollHead()});if(e.fieldCategories.visibleColumns.some(function(e){return"n"===e.name})&&a.addClass("btn-warning"),e.isMobile);else{let t=this._getIdFilterButton();i.append(a).append(" ").append(t).append(" ").append(e._idCheckButton)}return n.append(this._checkStatusBar),n.append(i),e._idCheckButton.off().on("click",function(){if(e._idCheckButton.find("span").is(".fa-check"))e.row_actions_uncheck_all.call(e),e.__checkedRows=[];else{for(let t=0;t<e.dataSortedVisible.length;t++){let n=e.dataSortedVisible[t],i=e._getItemById(n);e.row_actions_check.call(e,i,!0)}e.__checkedRows=e.dataSortedVisible.slice()}e._headCellIdButtonsState()}),i=t('<div class="pcTable-filters for-selected"><button class="btn btn-default btn-xxs"><i class="fa fa-copy"></i></button> <button class="btn btn-default btn-xxs" data-names="true"><i class="fa fa-clone"></i></button></div>'),n.append(i),this._refreshCheckedStatus(),n},_getIdFilterButton:function(){let e,n=this,i=t("<span>");return e=t('<button class="btn btn-xxs btn-filter" id="checkS"><span class="fa fa-circle-o"></span></button>').on("click",function(){e.is(".btn-warning")?(e.addClass("btn-default").removeClass("btn-warning").find("span").removeClass("fa-circle").addClass("fa-circle-o"),delete n.filters.id,i.find(".btn-filter:not(#checkS)").parent().replaceWith(n.__getFilterButton("id"))):(e.removeClass("btn-default").addClass("btn-warning").find("span").removeClass("fa-circle-o").addClass("fa-circle"),n.filters.id=n.__checkedRows.slice().map(function(e){return e.toString()})),n.__applyFilters(),n._headCellIdButtonsState()}),n.filters.id&&n.filters.id.length?e.addClass("btn-warning").removeClass("btn-default"):e.addClass("btn-default").removeClass("btn-warning"),i.append(e),i.append(n.__getFilterButton("id")),i},_createHeadCellNo:function(){let e=this,n=e.fields.n,i=t('<span class="cell-title">').text(n.title?n.title:n.name).attr("title",n.title),a=t('<button class="btn btn-default btn-xxs" style="width: 45px"><i class="fa fa-save"></i></button>'),l=t('<th class="n">').width(n.userWidth||n.width).append(i);return e.isCreatorView&&("n"===e.tableRow.order_field&&(!0===e.tableRow.order_desc?i.before('<i class="fa fa-sort-amount-desc roles"></i>'):i.before('<i class="fa fa-sort-amount-asc roles"></i>')),i.before("<br/>")),e._orderSaveBtn=a,!e.tableRow.with_order_field||e.f.blockorder||e.tableRow.__blocked?(a.prop("disabled",!0),this._table.addClass("no-correct-n-filtered")):a.on("click",function(){e.reOrderRowsSave.call(e)}),l.append(t('<div class="pcTable-filters">').append(a))},__getCellTitle:function(e){return Object.getPath(this.f,["fieldtitle",e.name],e.title)},_createHeadCell:function(a,l,o){let s=this,r=l.showMeWidth||l.width||100;"column"!==l.category&&r&&s.isMobile&&(r=100);let c=t("<th>").data("field",l.name);s.isMobile&&("column"===l.category&&l.editable&&(r+=20),r+=20),r&&c.width(r),s.fields[l.name]&&(s.fields[l.name].$th=c),void 0!==o&&""!==o&&(c.css("background-color",o),l.panelColor=o),l.webRoles&&1===l.webRoles.length&&"1"===l.webRoles[0].toString()&&c.addClass("admin-see"),"footer"===l.type&&l.column&&(c=t("<td>"));let d=this.__getCellTitle(l),f=t('<span class="cell-title">').text(d).attr("title",d).appendTo(c);if(s.isCreatorView){let e=t('<span class="creator-icons">').prependTo(f);const n=function(e){let t="";switch(e){case"param":t="fa-hand-o-up";break;case"column":t="fa-hand-o-right";break;case"filter":t="fa-hand-o-left";break;case"footer":t="fa-hand-o-down"}return t};!l.isHiddenField&&l.showMeWidth||e.append('<i class="fa '+n(l.category)+' roles"></i>'),!l.showInWeb||l.isHiddenField||l.showMeWidth||c.addClass("eye-hidden"),l.linkTableName&&e.append('<i class="fa fa-chain roles"></i>'),e.append('<i class="fa '+l.icon+' roles"></i>');let i=t('<i class="roles">'+(l._ord||l.ord)+"</i>");if(e.append(i),l._ord&&(i.addClass("reordered"),i.before('<i class="roles">'+l.ord+"</i>")),l._category&&i.before('<i class="fa '+n(l._category)+' roles reordered fa-bold"></i>'),"column"===l.category&&s.tableRow.order_field===l.name&&(i.css("font-weight","bold"),!0===s.tableRow.order_desc?e.append('<i class="fa fa-sort-amount-desc roles"></i>'):e.append('<i class="fa fa-sort-amount-asc roles"></i>')),l.codeAction){let n=t('<i class="fa fa-star roles"></i>');e.append(n);let i="";l.CodeActionOnAdd&&(""!==i&&(i+="\n"),i+="При добавлении"),l.CodeActionOnChange&&(""!==i&&(i+="\n"),i+="При изменении"),l.CodeActionOnDelete&&(""!==i&&(i+="\n"),i+="При удалении"),"button"===l.type&&(""!==i&&(i+="\n"),i+="При клике"),""===i&&n.removeClass("fa-star").addClass("fa-star-o"),n.attr("title",i)}l.code&&(l.codeOnlyInAdd?e.append('<i class="fa fa-cog-o roles"></i>'):e.append('<i class="fa fa-cogs roles"></i>'));const a=function(e){let t="";return e.forEach(function(e){""!==t&&(t+="\n"),t+=s.ROLESLIST[e.toString()]}),t};if(l.webRoles&&e.append(t('<i class="fa fa-eye roles"></i>').attr("title",a(l.webRoles))),"button"!==l.type){let n=!1;l.addRoles?e.append(t('<i class="fa fa-plus roles h"></i>').attr("title",a(l.addRoles))):l.insertable||("column"===l.category?l.editable?e.append(t('<i class="fa fa-plus roles h"></i>').attr("title","Добавление запрещено")):(e.append(t('<i class="fa fa-lock roles h"></i>').attr("title","Добавление и редактирование запрещено")),n=!0):l.editable||(e.append(t('<i class="fa fa-lock roles h"></i>').attr("title","Редактирование запрещено")),n=!0)),l.editRoles?e.append(t('<i class="fa fa-pencil roles h"></i>').attr("title",a(l.editRoles))):l.editable||n||e.append(t('<i class="fa fa-pencil roles h"></i>').attr("title","Редактирование запрещено")),l.logRoles&&e.append(t('<i class="fa fa-archive roles h"></i>').attr("title",a(l.logRoles)))}if(l.showInXml){let n="";l.xmlRoles&&(n=a(l.xmlRoles)),e.append(t('<i class="fa fa-exchange roles"></i>').attr("title",n))}}l.unitType&&f.append(", "+l.unitType);let p,h=t('<div class="pcTable-filters">');if(l.help&&l.help.length){s.isCreatorView||"column"===l.category||c.addClass("worker-with-i"),p=t('<span class="btn btn-xxs btn-default cell-help" tabindex="-1" id="field-help-'+l.name+'"><i class="fa fa-info"></i></span>'),s.isCreatorView&&/^\s*<admin>.*?<\/admin>\s*$/s.test(l.help)&&p.addClass("danger-backg"),p.appendTo(h);let e,i=t('<div class="i-inner-div">').html(l.help).width(230);s.isMobile?p.on("click",function(){App.mobilePanel("Поле "+l.title,l.help)}):p.on("click open close",function(n){let a=t(this);a.data("bs.popover")?"open"!==n.type&&(e&&clearTimeout(e),e=setTimeout(()=>{a.attr("aria-describedby")&&t("#"+a.attr("aria-describedby").length)&&a.popover("destroy")},120)):"close"!==n.type&&(p.popover({trigger:"manual",content:i,html:!0,placement:()=>{let e="bottom",t=300,n=s._container,o=a.offset().top-n.offset().top;return"column"===l.category&&s.insertRow||o>n.height()/2?(e="top",t=o-40):t=n.height()-o-70,i.css("max-height",t),e},container:s.scrollWrapper}),a.popover("show"))}),n||(n=!0,s._container.on("click escPressed",function(e){s._container.find('[id^="field-help"][aria-describedby^="popover"]').each(function(){t(this).attr("id")===e.target.id||t(e.target).closest("#"+t(this).attr("id")).length||t(this).trigger("close")})}))}if("column"===l.category&&l.filterable&&l.showMeWidth>0&&(c.addClass("with-filter2"),this.__getFilterButton(l.name).appendTo(h)),s.isCreatorView||!1!==l.dropdownView&&"column"===l.category){c.addClass("with-filter");let n=s.isCreatorView&&!(!1!==l.dropdownView&&"column"===l.category);(()=>{let a=t('<div class="cell-header-dropdown">'),o=t('<button class="btn btn-default btn-xxs"  tabindex="-1"><i class="fa fa-caret-down"></i></button>');l.pcTable?n&&o.addClass("field_name"):o.addClass("field_name");const r=function(t){t&&e.location.reload()};if(s.isCreatorView){let n=t('<div class="menu-item color-danger">');n.append('<i class="fa fa-pencil-square-o"></i> Изменить'),a.append(n);const c=function(){return new EditPanel(2,BootstrapDialog.TYPE_DANGER,{id:l.id}).then(r),!1};n.on("click",c),o.on("contextmenu",c),(n=t('<div class="menu-item color-danger">')).append('<i class="fa fa-clone"></i> Дублировать'),a.append(n),n.on("click",function(){App.getPcTableById(2).then(function(e){e.model.checkEditRow({id:l.id}).then(function(e){let n={},i={};t.each(e.row,function(e,t){"object"==typeof t&&(n[e]=t,i[e]=!0)}),new EditPanel(2,BootstrapDialog.TYPE_DANGER,n,!1,i).then(r)})})}),(n=t('<div class="menu-item color-danger">')).append('<i class="fa fa-plus"></i> Вставить после'),a.append(n),n.on("click",function(){App.getPcTableById(2,{afterField:l.ord}).then(function(e){let t={};t.ord={v:l.ord+10},t.category={v:l.category},t.table_id={v:s.tableRow.id},s.tableRow.__version&&(t.version={v:s.tableRow.__version}),t.data_src={v:i},new EditPanel(e,BootstrapDialog.TYPE_DANGER,t,!1,t).then(r)})}),("param"===l.category||"footer"===l.category&&""==l.column)&&((n=t('<div class="menu-item color-danger">')).append('<i class="fa fa-hand-scissors-o"></i> Секция'),a.append(n),n.on("click",()=>{this.__editSectionTitle(l)})),(n=t('<div class="menu-item color-danger">')).append('<i class="fa fa-refresh"></i> Изменить NAME'),a.append(n),n.on("click",function(){s.model.renameField(l.name)}),(n=t('<div class="menu-item color-danger">')).append('<i class="fa fa-times"></i> Удалить'),a.append(n),n.on("click",function(){let t=l.title;BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:"Удалить поле "+t+" из таблицы "+s.tableRow.title+"?",buttons:[{action:function(n,i){"use strict";n.close(),App.getPcTableById(2).then(function(n){App.panelTimer("Удаление поля "+t+" из таблицы "+s.tableRow.title,n.tableRow.delete_timer,function(){n.model.delete(l.id).then(function(){e.location.reload(!0)})})})},cssClass:"btn-warning",label:"Удалить"},{action:function(e){e.close()},label:"Отмена"}],draggable:!0})})}if("filter"!==l.category&&l.pcTable&&!s.isMobile){let e=t('<div class="menu-item">');e.append('<i class="fa fa-eye-slash"></i> Скрыть'),e.on("click",function(){o.popover("hide"),s.fieldsHiddingHide.call(s,l.name)}),e.appendTo(a),(e=t('<div class="menu-item">')).append('<i class="fa fa-arrows-h"></i> Ширина поля'),e.on("click",function(){o.popover("hide");let e=t('<div><input type="number" class="form-control" value="'+l.showMeWidth+'" style="padding-left: 2px;"/></div>');BootstrapDialog.show({message:e,title:"Ширина поля "+l.title,onshown:function(t){let n=e.find("input");n.focus(),n.on("keydown",function(n){13===n.keyCode&&(l.pcTable.setColumnWidth.call(l.pcTable,l.name,parseInt(e.find("input").val())),t.close())}),t.$modalDialog.width(500)},buttons:[{label:"Применить",action:function(t){let n=parseInt(e.find("input").val());t.close(),l.pcTable.setColumnWidth.call(l.pcTable,l.name,n)}},{label:"Отмена",action:function(e){e.close()}}],draggable:!0})}),e.appendTo(a)}if(l.showMeWidth>0&&"column"===l.category){{let e=t('<div class="menu-item">');e.append('<i class="fa fa-sort-alpha-asc"></i> Сортировать А-Я'),a.append(e),e.on("click",function(){s.sort(l,1)})}{let e=t('<div class="menu-item">');e.append('<i class="fa fa-sort-alpha-desc"></i> Сортировать Я-А'),a.append(e),e.on("click",function(){s.sort(l,-1)})}if("column"===l.category&&"number"===l.type){let e=t('<div class="menu-item">');e.append('<i class="fa fa-diamond"></i> Математические операции'),a.append(e),e.on("click",function(){let e=t("<div>"),n=0,i=0,a=null,o=null,r=0;s.dataSortedVisible.some(function(e){try{let t=Big(s.data[e][l.name].v);n=Big(n).plus(t),++i,null===a?a=t:t.gt(a)&&(a=t),null===o?o=t:t.lt(o)&&(o=t)}catch(e){++r}});let c=t('<table class="totum-math-operations"><thead><tr><th>Операция</th><th>Значение</th></tr></thead>').appendTo(e),d=t("<tbody>").appendTo(c),f=function(e,t){let n="";if(t=t||!1,l.unitType&&!t&&(n=" "+l.unitType),l.currency){let t={};return l.dectimalPlaces&&(t.minimumFractionDigits=l.dectimalPlaces),parseFloat(e).toLocaleString("ru-RU",t)+n}return e+n};t("<tr><td>Сумма</td><td>"+f(n)+"</td></tr>").appendTo(d),t("<tr><td>Кол-во чисел</td><td>"+f(i,!0)+"</td></tr>").appendTo(d),t("<tr><td>Среднее</td><td>"+f(Big(n).div(i).round(l.dectimalPlaces||0))+"</td></tr>").appendTo(d),t("<tr><td>Максимальное</td><td>"+f(a)+"</td></tr>").appendTo(d),t("<tr><td>Минимальное</td><td>"+f(o)+"</td></tr>").appendTo(d),t("<tr><td>Нечисл. элементов</td><td>"+f(r,!0)+"</td></tr>").appendTo(d);let p=l.title+(l.unitType?", "+l.unitType:"");s.isMobile?App.mobilePanel(p,e):BootstrapDialog.show({title:p,type:"edit",message:e,draggable:!0,onshown:function(e){e.$modalDialog.width(400)},buttons:[{action:function(e){e.close()},label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon"}]})})}}if(l.linkToSelectTable){let n=l.linkToSelectTable,i=t('<div class="menu-item color-primary">');i.append('<i class="fa fa-external-link"></i> '+n.title),a.append(i),i.on("click",function(){return e.open(n.link,"_blank").focus(),!1})}return o.popover({html:!0,content:a,trigger:"manual",container:s._container,placement:"auto bottom"}),o.on("click",function(){let e=t(this);"column"===l.category&&s.PageData&&s.PageData.onPage&&s.PageData.allCount>s.PageData.onPage?0===a.find(".column-dropdown").length&&a.append('<div class="column-dropdown">По текущей странице </div>'):a.find(".column-dropdown").remove(),e.data("bs.popover").tip().hasClass("in")||(e.popover("show"),setTimeout(function(){s._container.one("click",function(){e.popover("hide")})},20))}),o})().appendTo(h)}h.appendTo(c);let u=20*h.find(".btn").length+5;if(this.isCreatorView&&(0==l.showMeWidth||l.showMeWidth>50)){let e=t('<div class="th-left-bottom-buttons">').appendTo(c);"footer"===l.category&&l.column&&this.fields[l.column]&&!s.hidden_fields[l.name]&&(r=this.fields[l.column].width);t('<div class="btn  btn-xxs field_name copy_me"  tabindex="-1" data-copied-text="Скопировано">').text(l.name).appendTo(e).css("max-width",r-u)}return s.isMobile&&f.css("max-width",r-u-5),c},_createNoDataRow:function(e){let n=0;t.each(this.fields,function(e,t){n++});let i=this,a=t();return!e&&this.PageData&&this.PageData.loading?e="Подождите, таблица загружается":this.control.adding&&!this.f.blockadd&&(a=t('<button class="btn btn-warning btn-xxs">Добавить строку</button>').width(120).on("click",function(){i._addInsertRow()})),e=e||"Таблица пуста ",t("<tr>").addClass(this.noDataRowClass).append('<td class="id">').append(t("<td>").attr("colspan",n).append(e).append(a))},_createRow:function(e,n){n=n||[];let i=this;e.$tr||(e.$tr=t("<tr>"),e.$tr.height(35),e.$tr.data("item",e));let a=e.$tr.empty();a.attr("class","DataRow"),a.attr("data-pctableitemid",e.id),e.e_data&&1==e.e_data.b&&a.addClass("BlockedRow"),e.InsDel&&a.addClass("insDeleted"),this._addCellId(e,a);let o=0,s=this.fieldCategories.visibleColumns.length;if(this.fieldCategories.visibleColumns[o]&&"n"===this.fieldCategories.visibleColumns[o].name){let n=this.fieldCategories.visibleColumns[o],i=t("<td>");a.append(i.append('<span class="cell-value">').append(n.getCellText(null,i,e))),++o}for(;o<s;++o){let t,s=this.fieldCategories.visibleColumns[o];a.append(t=i._createCell(e,s)),n.indexOf(s.name)>-1&&i._colorizeElement(t,l)}},refreshRow:function(e,n,i){if(e&&e.is(".DataRow")||n){n||(n=this._getItemByTr(e));let l=[];if(i){for(var a in i)null!==i[a]&&"object"==typeof i[a]?i[a].changed?(l.push(a),delete i[a].changed):Object.equals(i[a],n[a])||l.push(a):i[a]!=n[a]&&l.push(a),n[a]=i[a];t.extend(n,i)}e&&this._createRow(n,l)}else this._isParamsArea(e)?this._refreshParamsBlock():this._isFootersArea(e)&&this._refreshFootersBlock()},_createCell:function(e,n){let i=this;var a=t("<td>");let l,o="";e[n.name]||(console.log("Не найдено поле "+n.name),console.log(e));try{l=t.extend({},i.f||{},e.f||{},e[n.name].f||{})}catch(t){console.log(t,e,n.name),l={}}let s=l.height>33||l.maxheight>33;!n.editable||!this.control.editing&&"filter"!==n.category||l.block||(a.addClass("edt"),n.editGroup&&(n.editGroupMultiColumns?a.addClass("e-gm").addClass("e-g"):a.addClass("e-g")),-1===["button","fieldParams"].indexOf(n.type)&&(i.isMobile||l.editbutton)&&(o='<button class="fa fa-edit pull-right ttm-edit ibtn"></button>')),i.isMobile&&"chart"!==n.type&&(o='<button class="fa fa-ellipsis-h ttm-panel pull-right ibtn"></button>'+o),l.block&&a.addClass("blocked"),"column"!==n.category&&a.attr("data-field",n.name);var r=t('<span class="cell-value">'),c=e[n.name];let d,f;if(n.code&&!n.codeOnlyInAdd&&a.addClass("with-code"),"column"!==n.category&&"chart"!==n.type&&a.data("field",n.name).addClass("val"),c){if(d=c.e,c.h&&(f=void 0!==c.c&&c.v!=c.c?t('<i class="fa fa-hand-paper-o pull-right cell-icon" aria-hidden="true"></i>'):t('<i class="fa fa-hand-rock-o pull-right cell-icon" aria-hidden="true"></i>'),i.isMobile&&f.addClass("ttm-panel")),c.d&&a.addClass("deleted_value"),c.e)if(n.errorText)r.text(n.errorText);else{let e=t('<i class="fa fa-exclamation-triangle pull-right" aria-hidden="true"></i>');i.isMobile?e.addClass("ttm-panel"):e.attr("title",c.e),a.append(e)}if(l.text&&"button"!=n.type)r.text(l.text);else if(!c.e||!n.errorText){var p=s?n.getHighCelltext?n.getHighCelltext(c.v,a,e):n.getPanelText?n.getPanelText(c.v,a,e):n.getCellText(c.v,a,e):n.getCellText(c.v,a,e);"object"==typeof p?r.html(p):r.text(p)}}if(l.comment&&"button"!=n.type&&a.append(t('<i class="cell-icon fa fa-info pull-right"></i>').attr("title",l.comment)),f&&a.append(f),o&&a.append(o),r.appendTo(a),l.text||!n.unitType||d||null===c.v||r.attr("data-unit-type"," "+n.unitType),n.css&&a.addClass(n.css),this.isSelected(n.name,e.id)&&a.addClass("selected"),n.isNoTitles&&"button"===n.type||"button"===n.type&&n.pcTable.isMobile&&"column"!==n.category||(l.background?a.css("background-color",l.background):n.panelColor&&a.css("background-color",n.panelColor),l.color&&a.css("color",l.color)),l.bold&&a.css("font-weight","bold"),l.align?a.css("text-align",l.align):l.tab&&a.css("padding-left",l.tab+"px"),l.decoration&&a.css("text-decoration",l.decoration),l.italic&&a.css("font-style","italic"),"button"!==n.type&&l.icon&&a.prepend('<i class="cell-icon fa fa-'+l.icon+'"></i>'),l.progress&&l.progresscolor){let e=function(){if(r.isAttached()){let e=Math.round(r.width()*parseInt(l.progress)/100);r.css("box-shadow","inset "+e.toString()+"px 0px 0 0 "+l.progresscolor)}else setTimeout(e,50)};e()}return n.format=l,n.td_style&&"function"==typeof n.td_style&&a.css(n.td_style(l)),a},_getLoadingSpinner:function(){return t('<div class="text-center"><i class="fa fa-spinner"></i></div>')},_colorizeElement:function(e,t,n){let i=10,a=function(){0===i?e.css("box-shadow",""):(e.css("box-shadow","inset 0 0 100px 100px "+App.hexToRGB(t,i/10)),i--,setTimeout(a,50))};a()},_TmpColorize:function(e,t,n){var i,a=this,l=0;t=t||"#ff0000";"#"!=(n=n||"#ffffff").substr(0,1)&&(n=App.rgb2hex(n));10==++l?i=n:(i=function(e,t,n){var i=parseInt(e.slice(1),16),a=(n=parseInt(n.slice(1),16),t<0?0:n>>16),l=t<0?0:n>>8&255,o=t<0?0:255&n,s=t<0?-1*t:t,r=i>>16,c=i>>8&255,d=255&i;return"#"+(16777216+65536*(Math.round((a-r)*s)+r)+256*(Math.round((l-c)*s)+c)+(Math.round((o-d)*s)+d)).toString(16).slice(1)}(t,.1,n))==t&&(i=n),e.css("background-color",i),i!=n?setTimeout(function(){a._TmpColorize(e,i,n)},50):e.data("backgroundcolor")||e.attr("style",e.attr("style").replace(/(background\-color:[^;"]+;?)/,""))},__deleteSection(e){App.panelTimer("Удаление секции",5,()=>{App.getPcTableById(2).then(function(t){t.model.checkEditRow({id:e.id}).then(n=>{let i=n.row.data_src.v;t.model.saveEditRow({data_src:{v:{...i,tableBreakBefore:{isOn:!1},sectionTitle:{isOn:!1,Val:i.sectionTitle}}},id:e.id}).then(t=>{e.tableBreakBefore=!1,delete e.sectionTitle,"param"===e.category?e.pcTable._rerendParamsblock():e.pcTable._rerendBottomFoolers()})})})})},__editSectionTitle(n){App.getPcTableById(2).then(function(i){i.model.checkEditRow({id:n.id}).then(a=>{let l,o=a.row.data_src.v,s="";o.sectionTitle&&"Val"in o.sectionTitle&&(s=o.sectionTitle.Val||"");let r=s.replace(/^(.*?)\*\*.*$/,"$1");/\*\*/.test(s)&&s.replace(/^.*?\*\*/,"").split(/\s*;\s*/).forEach(e=>{""!==e.trim()&&(r+="\n",r+=e.split(":").join(" : "))});let c=t('<div class="HTMLEditor">');e.top.BootstrapDialog.show({message:c,type:BootstrapDialog.TYPE_DANGER,title:"Редактирование секции",cssClass:"sectionTitle-edit-panel",draggable:!0,buttons:[{label:"Сохранить",action:e=>{(e=>{let t="";if(""!==e.trim()){let n=e.split(/\s*[\n\r]+\s*/),i=n[0];n.splice(0,1),t=i,n.length&&(t+="**"+n.join(";").replace(/\s*:\s*/g,":"))}let a=t;i.model.saveEditRow({data_src:{v:{...o,tableBreakBefore:{isOn:!0,Val:!0},sectionTitle:{isOn:!0,Val:a}}},id:n.id}).then(e=>{n.sectionTitle=a,n.tableBreakBefore=!0,"param"===n.category?n.pcTable._rerendParamsblock():n.pcTable._rerendBottomFoolers()})})(l.getValue()),e.close()}}],onhide:function(e){},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"}),(l=CodeMirror(c.get(0),{value:r,mode:"sections",minHeight:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!1,autoCloseTags:!1})).on("paste",function(e,t){setTimeout(function(){l.refresh()},1)})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"100%"})}})})})}})}(),t.extend(App.pcTableMain.prototype,{_addHorizontalDraggable:function(){this._innerContainer.off("mousedown.HorizontalDraggable mouseout").on("mousedown.HorizontalDraggable",function(e){for(var n=e;n;){if(t(e.target).is("input"))return!0;if(n==e.originalEvent)break;n=e.originalEvent}return t(this).data("x",e.clientX).data("scrollLeft",this.scrollLeft),!1}).on("mousemove",function(e){if(0===t(e.target).closest(".InsertRow").length&&"INPUT"!==e.target.tagName&&1===e.buttons&&0===e.button&&Math.abs(t(this).data("x")-e.clientX)>20){let n;t(this).data("moved",!0),n&&clearTimeout(n),n=setTimeout(function(){t(this).data("moved",!1)},200),this.scrollLeft=t(this).data("scrollLeft")+t(this).data("x")-e.clientX}})}}),App.pcTableMain.prototype._addRowPanel=function(e,n,i){var a=t('<div style="width: 165px;"><div class="buttons insert-row-buttons"></div></div>');if(void 0!==i){var l=a.find(".buttons").empty();t.each(i,function(e,n){if("function"==typeof n)var i=t('<button class="btn btn-sm btn-default">').html(e).on("click",n);else"object"==typeof n&&"checkbox"==n.type&&(i=t('<input type="checkbox">'),n.id&&i.attr("id",n.id),n.func&&i.on("change",n.func),i=i.wrap('<span style="font-size: 10px; padding-left: 8px;" >').parent().append(' <span style="padding-top: 2px;">'+e+"</span>"));l.append(" "),l.append(i)})}n.on("remove",function(){a.remove()});let o=this;return setTimeout(function(){let e={isParams:!0,$text:a,element:n,container:o._container,placement:"bottom",trigger:"manual"};App.popNotify(e);let i=n.attr("aria-describedby"),l=t("#"+i).addClass("warning-bg");l.find(".arrow").css("left","80%"),o._positionPanel.call(o,l,n),a.show()},50),a},App.pcTableMain.prototype._positionPanel=function(e,t){var n=t.position();this.tableWidth;return this._innerContainer.width()>this.tableWidth?e.position({my:"right top",at:"right+2px bottom+12px",of:t}):e.position({my:"right top",at:"right+2px top+"+(n.top+47)+"px ",of:this._innerContainer})},t.extend(App.pcTableMain.prototype,{_csvExport:function(e){"use strict";let t=this;this.model.csvExport(t.dataSortedVisible,e,Object.keys(App.filter(t.fields,(e,t)=>!!t.showMeWidth))).then(function(e){if(e.csv){let n=new Blob([e.csv],{type:"text/csv;charset=utf-8"});saveAs(n,t.tableRow.title+"."+t.model.tableData.updated.dt+".csv")}})},_csvImportClick:function(e){let n=this;t('<input type="file" accept="text/csv">').on("change",function(){if(this.files&&this.files[0]){let t=new FileReader;t.onload=function(t){let i=t.target.result;n._csvImportUpload.call(n,i,e)},t.onerror=function(e){console.log(e.target.error)},t.readAsDataURL(this.files[0])}}).click()},_csvImportUpload:function(e,n){let i=this,a={},l=Object.keys(App.filter(i.fields,(e,t)=>!!t.showMeWidth&&"column"===t.category)),o=function(){i.model.csvImport(e,n,a,"full"==n?[]:l).then(function(e){e.question?App.modal(e.question[1],"Вопрос про csv-загрузку",{"Отменить":"close","Загружаем":function(t){"use strict";t.modal("hide"),a[e.question[0]]=1,o()}}):e.ok&&i.table_modify.call(i,e)})};if("rows"===n){let e=t("<div></div>");l.forEach(n=>{e.append(t("<div>").text(i.fields[n].title||i.fields[n].name))});App.confirmation(e,{"Отменить":function(e){e.close()},"Загрузить":e=>{o(),e.close()}},"Проверьте соответствие структуры загружаемого файла последовательности полей")}else o()}}),function(){t.extend(App.pcTableMain.prototype,{___fieldsHiddingShowAllButton:null,_hideHell_storage:{isset_fields:!1,opened:null,blinkIt:!1,getOpened:function(){return null===this._hideHell_storage.opened&&(this._hideHell_storage.opened=a.getSavedOpenedVal(this.tableRow),!1===this._hideHell_storage.opened&&(this._hideHell_storage.blinkIt=!0)),this._hideHell_storage.opened},checkIssetFields:function(e){if(this.isCreatorView&&this._beforeSpace){let t=this._hideHell_storage.isset_fields;if(this._hideHell_storage.isset_fields=Object.keys(this.hidden_fields).length||Object.keys(this.fields).some(e=>"n"!==e&&(!this.fields[e].showMeWidth||this.fields[e].showMeWidth<1)),e||t!==this._hideHell_storage.isset_fields){let e=this._beforeSpace.find("#hide-hell").removeClass("btn-contour");this._hideHell_storage.isset_fields?(e.removeAttr("disabled"),this._hideHell_storage.opened?(e.find("i").addClass("fa-arrow-up").removeClass("fa-arrow-down").removeClass("fa-times"),e.addClass("btn-contour")):(e.find("i").removeClass("fa-arrow-up").addClass("fa-arrow-down").removeClass("fa-times"),this._hideHell_storage.blinkIt&&(App.blink(e,8,"#fff"),this._hideHell_storage.blinkIt=!1))):(e.attr("disabled","disabled"),e.find("i").addClass("fa-times").removeClass("fa-arrow-up").removeClass("fa-arrow-down"))}}},switchOpened:function(){this._hideHell_storage.opened=!this._hideHell_storage.opened,this._hideHell_storage.checkIssetFields.call(this,!0),a.saveOpenedVal(this.tableRow,this._hideHell_storage.opened),this._refreshHiddenFieldsBlock()}},fieldsHiddingHide:function(e,t){let n=l.get(this.tableRow)||{};t?n[e]=this.fields[e].width:delete n[e],this.setVisibleFields(n)},setVisibleColumns:function(){let e=this;this.fieldCategories.visibleColumns=[],this.fieldCategories.column.forEach(function(t){t.showMeWidth&&e.fieldCategories.visibleColumns.push(t)})},setColumnWidth:function(e,t){let n=l.get(this.tableRow)||{};n[e]=t,this.setVisibleFields(n)},loadVisibleFields:function(){let e={},t=l.getDate(this.tableRow);!t||""!=this.tableRow.fields_actuality&&this.tableRow.fields_actuality>t?(console.log("visibleFields updated"),this.setVisibleFields(e,!0,moment().format(App.dateTimeFormats.db))):(e=l.get(this.tableRow)||{},this.setVisibleFields(e,!0))},setVisibleFields:function(e,n,i){let a=this,o=!1,s=!1;e&&0===Object.keys(e).length?(e={},Object.values(a.fields).forEach(function(t){let n=t.hidden?0:t.width;n!=a.fields[t.name].showMeWidth&&("column"===t.category||"footer"===t.category&&t.column?o=!0:s=!0),a.fields[t.name].showMeWidth=n,e[t.name]=a.fields[t.name].showMeWidth})):Object.values(a.fields).forEach(function(t){let i;(i="filter"===t.category?t.width:void 0!==e[t.name]?parseInt(e[t.name]):n&&!t.hidden?t.width:0)!=a.fields[t.name].showMeWidth&&("column"===t.category||"footer"===t.category&&t.column?o=!0:s=!0),a.fields[t.name].showMeWidth=i,e[t.name]=a.fields[t.name].showMeWidth}),l.set(e,this.tableRow,i),this.setVisibleColumns(),t.each(this.data,function(e,t){delete a.data[e].$tr}),this._header&&(o&&(this._refreshHead(),this._refreshContentTable(!0),this._rerenderColumnsFooter(),this.fieldsHiddingGetButton(),this.isCreatorView&&(this._hideHell_storage.checkIssetFields.call(a),this._refreshHiddenFieldsBlock())),s&&this.setWidthes(),o&&this.ScrollClasterized.insertToDOM(null,!0)),this._insertRow&&this._closeInsertRow()},hideAdminViewFields:function(){let e=this,t=l.get(this.tableRow)||{};Object.keys(t).forEach(function(n){if(t[n]>0){let i=e.fields[n];(!i||i.webRoles&&1===i.webRoles.length&&"1"==i.webRoles[0])&&delete t[n]}}),this.setVisibleFields(t)},setDefaultVisibleFields:function(){let e={};Object.values(this.fields).forEach(function(t){t.hidden?e[t.name]=0:e[t.name]=t.width}),this.setVisibleFields.call(this,e)},fieldsHiddingShowPanel:function(){let n,i,a=this,l=t('<div class="hidding-form">');const s=function(e){e=e||t("#defaultEyeGroups"),r=a.tableRow.fields_sets||[],e.empty().append("<b>Наборы по умолчанию:</b> "),r.forEach(function(n,i){let l=t('<a href="#">').text(n.name).data("index",i);e.append(l.wrap("<span>").parent()),a.isCreatorView&&(i>0&&l.parent().append(t('<button class="btn btn-xxs field_name"><i class="fa fa-arrow-left"></i></button>').data("index",i)),l.parent().append(t('<button class="btn btn-xxs field_name"><i class="fa fa-remove"></i></button>').data("index",i)))}),e.off(),a.isCreatorView&&e.on("click",".btn",function(){if(t(this).find("i").is(".fa-remove")){let e=t(this);a.model.removeEyeGroupSet(e.data("index")).then(function(e){a.tableRow.fields_sets=e.sets,s()})}else{let e=t(this);a.model.leftEyeGroupSet(e.data("index")).then(function(e){a.tableRow.fields_sets=e.sets,s()})}}),e.on("click","a",function(){let e=t(this).data("index"),n=r[e].fields;if(Array.isArray(n)){let e={};n.forEach(function(t){a.fields[t]&&(e[t]=a.fields[t].width)}),n=e}a.setVisibleFields.call(a,n),i.close()})};let r=o.getNames(a.tableRow);if(r&&r.length){let e=t('<div class="fieldsHiddenSets">').appendTo(l);e.append("<b>Наборы:</b> "),r.forEach(function(n){let i=t('<a href="#">').text(n).data("name",n);e.append(i.wrap("<span>").parent());let l=i.parent();l.append(t('<button class="btn btn-xxs" data-action="remove"><i class="fa fa-remove"></i></button>').data("name",n)),a.isCreatorView&&l.append(t('<button class="btn btn-xxs field_name" data-action="addDefaultSet" title="Сохранить как набор по умолчанию"><i class="fa fa-save"></i></button>').data("name",n))}),e.on("click",".btn",function(){let e=t(this),n=e.data("name");if(a.isCreatorView&&"addDefaultSet"===t(this).data("action")){let t=o.get(a.tableRow,n)||[];a.model.AddEyeGroupSet(n,t).then(function(t){a.tableRow.fields_sets=t.sets,s(),o.remove(a.tableRow,n),e.parent().remove()})}else o.remove(a.tableRow,n),e.parent().remove()}),e.on("click","a",function(){let e=t(this).data("name"),n=o.get(a.tableRow,e)||[];a.setVisibleFields.call(a,n),i.close()})}r=a.tableRow.fields_sets||[];let c=t('<div class="fieldsHiddenSets" id="defaultEyeGroups">').appendTo(l);r&&r.length&&s(c),l.on("click",'input[type="checkbox"]',function(e){let i=t(this),a=i.closest(".hidding-form");if(e.shiftKey){a.find("input").index(i);let e=a.find("input").index(t(this));a.find("input").each(function(a){(e<=a&&a<n||e>=a&&a>n)&&t(this).prop("checked",!!i.is(":checked")&&"checked").trigger("change")})}else n=a.find("input").index(t(this))});let d=[{label:"Применить",action:function(e){let n={};l.find("input:checked").each(function(){let e=t(this);n[e.attr("name")]=parseInt(e.closest("div").find('input[type="number"]').val())||null}),a.setVisibleFields.call(a,n),e.close()}},{label:"По умолчанию",action:function(e){e.close(),a.setDefaultVisibleFields.call(a)}},{label:"Показать все",action:function(e){e.close();let t={};Object.values(a.fields).forEach(function(e){t[e.name]=e.width}),a.setVisibleFields.call(a,t)}},{label:"Создать набор",action:function(n){let i={};l.find("input:checked").each(function(){let e=t(this);i[e.attr("name")]=parseInt(e.closest("div").find('input[type="number"]').val())||null}),a.setVisibleFields.call(a,i),n.close();let s=t("<div></div>");s.append('<div style="padding-top: 10px;"><label>Название набора</label><input type="text" id="fieldsSetName" class="form-control"/></div>'),e.top.BootstrapDialog.show({message:s,title:"Сохранить набор полей",type:null,buttons:[{label:"Сохранить",action:function(e){let t=s.find("#fieldsSetName");""===t.val().trim()?t.addClass("error"):(o.set(a.tableRow,i,t.val().trim()),e.close())}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],draggable:!0})}},{label:"Отмена",action:function(e){e.close()}}];a.isCreatorView&&d.splice(2,0,{label:"Скрыть адм.поля",action:function(e){e.close(),a.hideAdminViewFields.call(a)}});let f={param:"Хэдер",column:"Колонки",footer:"Футер"};Object.keys(f).forEach(function(e){a.fieldCategories[e]&&a.fieldCategories[e].length&&(l.append('<div class="category-name">'+f[e]+"</div>"),t.each(a.fieldCategories[e],function(e,n){let i="";n.hidden&&(i=" (Скрыто по умолчанию)");let a=t('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="'+n.name+'" class="form-check-input"> '+n.title+i+'</label> <input type="number" placeholder="'+n.width+'" value="'+(n.showMeWidth&&n.showMeWidth!==n.width?n.showMeWidth:n.width)+'"/></div>');n.showMeWidth&&(a.find("input").prop("checked",!0),a.attr("data-checked",!0)),a.appendTo(l)}))}),l.on("change",'input[type="checkbox"]',function(){let e=t(this).closest("div");t(this).is(":checked")?e.attr("data-checked",!0):e.removeAttr("data-checked")}),i=e.top.BootstrapDialog.show({message:l,title:"Видимость полей",buttons:d,type:null,draggable:!0,onshow:function(e){a.isCreatorView&&e.$modalContent.css({width:"800px"})}})},fieldsHiddingGetButton:function(e){"use strict";let n=this;if(!this.___fieldsHiddingShowAllButton){let e;this.___fieldsHiddingShowAllButton=t('<button class="btn btn-sm"><span class="fa fa-eye-slash"></span></button>').on("click",function(){n.fieldsHiddingShowPanel.call(n)}).on("contextmenu",function(){return n.isCreatorView?e?(clearTimeout(e),e=null,n.hideAdminViewFields.call(n,!0)):e=setTimeout(function(){n.setDefaultVisibleFields.call(n),e=null},500):n.setDefaultVisibleFields.call(n),!1})}return Object.values(n.fields).some(function(e){if(e.showInWeb&&!e.hidden&&!e.showMeWidth)return!0})?(this.___fieldsHiddingShowAllButton.addClass("btn-warning"),this.___fieldsHiddingShowAllButton.removeClass("btn-default"),e&&App.blink(this.___fieldsHiddingShowAllButton,8,"#fff")):(this.___fieldsHiddingShowAllButton.addClass("btn-default"),this.___fieldsHiddingShowAllButton.removeClass("btn-warning")),this.___fieldsHiddingShowAllButton}});let n="pcTableShowFieldsWithDates",i=function(e){let t=e.id;return"calcs"===e.type&&(t+="$"+e.__version),t},a={saveOpenedVal:function(e,t){localStorage.setItem(this.getKeyString(e),t.toString())},getKeyString:function(e){return e.id+"/"+e.__version},getSavedOpenedVal:function(e){let t=localStorage.getItem(this.getKeyString(e));return!t||JSON.parse(t)}},l={set:function(e,t,a){let l=i(t),o={},s=e||{};try{o=JSON.parse(localStorage.getItem(n))||{}}catch(e){}a||!o[l]?o[l]=[s,a]:o[l][0]=s,localStorage.setItem(n,JSON.stringify(o))},get:function(e){let t=i(e);return l.getInner(t)[0]},getDate:function(e){let t=i(e);return l.getInner(t)[1]},getInner:function(e){let t;try{t=JSON.parse(localStorage.getItem(n))||{}}catch(e){t={}}return t[e]||[]}},o={set:function(e,t,n){let a=[],l="pcTableShowFieldsSets"+i(e),o=t||[];try{a=JSON.parse(localStorage.getItem(l))||{}}catch(e){}a[n]=o,localStorage.setItem(l,JSON.stringify(a))},get:function(e,t){let n,a="pcTableShowFieldsSets"+i(e);try{n=(n=JSON.parse(localStorage.getItem(a)))[t]}catch(e){}return null!==n&&void 0!==n||(n=void 0),n},getNames:function(e){let t,n="pcTableShowFieldsSets"+i(e);try{return t=JSON.parse(localStorage.getItem(n)),Object.keys(t)}catch(e){}return null!==t&&void 0!==t||(t=void 0),t},remove:function(e,t){let n,a="pcTableShowFieldsSets"+i(e);try{delete(n=JSON.parse(localStorage.getItem(a)))[t],localStorage.setItem(a,JSON.stringify(n))}catch(e){}}}}(),App.pcTableMain.prototype._print=function(){"use strict";let n=t('<div class="hidding-form">');const i=function(e){if(e.showMeWidth)return!0};this.fieldCategories.param.length&&this.fieldCategories.param.some(i)&&n.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="params" class="form-check-input" checked="checked"> Параметры</label></div>'),this.fieldCategories.filter.length&&n.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="filters" class="form-check-input" checked="checked"> Фильтры</label></div>'),this.fieldCategories.column.length&&this.fieldCategories.column.some(i)&&this.dataSortedVisible.length&&(n.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="rows" class="form-check-input" checked="checked"> Строчную часть</label></div>'),n.append('<div class="form-check no-bold" style="padding-left: 20px;"><label class="form-check-label"><input type="checkbox" name="with-id" class="form-check-input"> с id</label></div>')),this._footersBlock.find(".val").length&&n.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="column-footers" class="form-check-input" checked="checked"> Футеры колонок</label></div>'),this._footersSubTable.find(".val").length&&n.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="other-footers" class="form-check-input" checked="checked"> Футеры вне колонок</label></div>');let a=this,l=[{label:"Печать",action:function(e){let i=[];n.find("input:checked").each(function(){i.push(t(this).attr("name"))}),e.close(),a._printTable.call(a,i)}},{label:"Отмена",action:function(e){e.close()}}];e.top.BootstrapDialog.show({message:n,type:null,title:"Печать",buttons:l,draggable:!0})},App.pcTableMain.prototype._printTable=function(e){let t=this,n={fields:{}};-1!==e.indexOf("with-id")&&(n.fields.id=50);let i={params:t.fieldCategories.param,filters:t.fieldCategories.filter,rows:t.fieldCategories.column,"column-footers":t.fieldCategories.footer.filter(function(e){return""!==e.column}),"other-footers":t.fieldCategories.footer.filter(function(e){return""===e.column})};Object.keys(i).forEach(function(t){-1!==e.indexOf(t)&&i[t].forEach(function(e){"button"===e.type||e.showMeWidth<1||!e.showMeWidth||(n.fields[e.name]=e.showMeWidth)})}),-1!==e.indexOf("rows")&&(n.ids=t.dataSortedVisible),n.sosiskaMaxWidth=1100,t.model.printTable(n)},App.pcTableMain.prototype.reOrderRows=function(e,n){let i,a=this;if(a.tableRow.with_order_field&&!a.nSorted)return App.notify("Для работы поля порядок перезагрузите таблицу"),!1;let l,o=[];if(0===this.row_actions_get_checkedIds().length){if(o.push(e),(i=this.dataSorted.indexOf(e)+("after"===n?1:-1))<0)return}else{if(-1!==a.row_actions_get_checkedIds().indexOf(e))return App.notify("В качестве якоря для перемещения нужно выбрать не отмеченную строку"),!1;let t=this.row_actions_get_checkedIds().length;this.dataSorted.some(function(e,n){if(0===t)return!0;a.data[e].$checked&&(o.push(e),--t)})}o.forEach(function(e){a.dataSorted.splice(a.dataSorted.indexOf(e),1)}),l=void 0!==i?i:this.dataSorted.indexOf(e)+("after"===n?1:0),a.dataSorted.splice(l,0,...o),this.dataSortedVisible=[],a.dataSorted.forEach(function(e){a.data[e].$visible&&a.dataSortedVisible.push(e)}),a._refreshContentTable(),a.tableRow.with_order_field&&t("table.pcTable-table").addClass("reordered"),a.row_actions_uncheck_all()},App.pcTableMain.prototype.reOrderRowsSave=function(){let e=this;e._orderSaveBtn.prop("disabled",!0).find("i").attr("class","fa fa-cog"),this.model.saveOrder(this.dataSorted).then(function(n){e.table_modify(n),e._orderSaveBtn.prop("disabled",!1).find("i").attr("class","fa fa-save"),t("table.pcTable-table").removeClass("reordered")})},App.pcTableMain.prototype.addReOrderRowBind=function(){let e=this;e._innerContainer.on("click","td.n button",function(n){let i=t(this);e.tableRow.with_order_field&&!e.__getCheckedRowsIds(void 0,!0,"blockorder")||e.reOrderRows.call(e,e._getItemByTr.call(e,i.closest("tr")).id,1===i.find(".fa-angle-up").length?"before":"after")})},App.pcTableMain.prototype.__formatFunctions={blockadd:function(){this._closeInsertRow(),this._rowsButtons()},tablecomment:function(){this._rowsButtons()},blockorder:function(){this._refreshHead()},block:function(){this._refreshParamsBlock(),this._refreshContentTable(!0),this._refreshFootersBlock()},tabletitle:function(){this._refreshTitle()},text:function(){this._refreshTableText()},rowstitle:function(){this._container.find(".pcTable-rowsTitle:first").replaceWith(this._createRowsTitle())},fieldtitle:function(e,t){let n={};const i=function(e){return"footer"==e.category&&e.column?"tableFooter":e.category};for(const a in e)this.fields[a]&&e[a]!==t[a]&&(n[i(this.fields[a])]=!0);for(const a in t)this.fields[a]&&e[a]!==t[a]&&(n[i(this.fields[a])]=!0);for(const e in n)switch(e){case"param":this._rerendParamsblock();break;case"filter":this._rerendFiltersBlock();break;case"column":this._refreshHead();break;case"footer":this._rerendBottomFoolers();break;case"tableFooter":this._rerenderColumnsFooter()}}},t.extend(App.pcTableMain.prototype,{setWidthes:function(){"use strict";let n;this.isMobile?(n=5,this.switchContainerNideScroll(!1)):(n=t("body>.page_content:first").is(".tree-minifyed")?5:300,this.switchContainerNideScroll(!0)),this.width=t("body").width()-n,this._container.width(this.width),this.isMobile?this._innerContainer.width("auto"):this._innerContainer.width(this.width-80),this._rerendParamsblock(),this._rerendFiltersBlock(),this._refreshHead(),this._rerendBottomFoolers(),this.tableWidth<this._innerContainer.width()?this.isMobile?this.__$rowsButtons.width(this._table.width()):this.__$rowsButtons.width(this._table.width()-70):this.isMobile||this.__$rowsButtons.width(this._innerContainer.width()-5),this._container.width()<this._table.width()&&this._addHorizontalDraggable(),this._container.height(e.innerHeight-this._container.offset().top-10)},initForPanel:function(e){t.extend(!0,this,e),this.refreshArraysFieldCategories(!1);let n={};this.__checkedRows=[],this.rows.map(function(e){this.dataSorted.push(e.id),this.dataSortedVisible.push(e.id),n[e.id]=e,n[e.id].$checked=-1!==this.__checkedRows.indexOf(e.id)},this),this.data=n,this.model.setLoadedTableData(this.data)},closeCallbacks:[],_init:function(){let n=this;t(document).on({dragover:function(){return!1},drop:function(){return!1}}),this._container.addClass(this.contanerClass).addClass("pcTable-type-"+this.tableRow.type);let i=t("#nav-top-line");i.addClass("pcTable-type-"+this.tableRow.type),"tmp"===this.tableRow.type&&i.text("Будьте внимательны - это временная таблица"),this._innerContainer=t('<div class="innerContainer">');let a=!1;const l=function(){if(!a){a=!0;let e=n.closeCallbacks.length;n.closeCallbacks.forEach(function(e){e()}),n.closeCallbacks.splice(0,e),a=!1}};if(t("body").on("keyup",function(e){27===e.which&&(n._container.trigger("escPressed"),l())}),t("body").on("click",l),n._container.on("scroll",l),n._innerContainer.on("scroll",l),this.isCreatorView&&this._container.on("click",".creator-icons:not([aria-describedby])",function(e){let i=t(this);if(0===i.closest(".popover").length){let e=t('<div style="width:200px" class="creator-icons">');i.find("i").each(function(n,a){let l=t("<div>").append(a.outerHTML);0===n&&l.append(" "+i.closest("th").find(".field_name").text()),a.title&&l.append(" "+a.title),e.append(l)}),App.popNotify({isParams:!0,$text:e,element:i,trigger:"manual",placement:"top"}),setTimeout(function(){n.closeCallbacks.push(function(){i&&i.length&&i.popover("destroy")})},200)}}),n._container.on("contextmenu",function(e){let n=t(e.target);if(!n.closest(".popover").length&&!n.closest(".edit-row-panel").length)return!1}),this._container.append(this._innerContainer),this.addReOrderRowBind(),this.initRowsData(),!this.isMobile){let i;t(e).resize(function(){i&&clearTimeout(i),i=setTimeout(function(){n.setWidthes()},500)})}},refreshArraysFieldCategories:function(n){"use strict";n=n||!1;let i=this;i.hidden_fields=i.hidden_fields||{},t.each(i.hidden_fields,function(e,n){i.hidden_fields[e]=t.extend({},n,r[n.type],n),i.hidden_fields[e].isHiddenField=!0}),i.mainFieldName="id",i.fieldCategories={},["param","column","filter","footer"].forEach(function(e){i.fieldCategories[e]=[]});let a=[];try{a=(a=JSON.parse(decodeURIComponent(e.location.hash.substring(1))||"[]"))&&a.wc?a.wc:[]}catch(e){}let l=!1;const o=function(e,n){n.pcTable=i,-1===a.indexOf(n.category)&&((n=r[n.type]?t.extend({},c,r[n.type],n):t.extend({},c,n)).showInWebOtherOrd&&(n._ord=n.ord,n.ord=n.showInWebOtherOrd,l=!0),n.showInWebOtherPlacement&&(n._category=n.category,n.category=n.showInWebOtherPlacement,l=!0),i.fields[e]=n,n.showInWeb?i.fieldCategories[n.category].push(n):n.name&&(i.hidden_fields[n.name]=n))};if(n){o("n",{type:"n"});let e=t.extend({},this.fields);delete e.n,t.each(e,o)}else t.each(this.fields,o);l&&["param","column","filter","footer"].forEach(function(e){i.fieldCategories[e].sort(function(e,t){return e.ord-t.ord})}),i.notTableFooterFields=[],i.fieldCategories.footer.forEach(function(e){e.column||i.notTableFooterFields.push(e)}),this.tableRow.main_field&&this.fields[this.tableRow.main_field]&&(i.mainFieldName=this.tableRow.main_field)},render:function(e){let t=this;if(this.loadVisibleFields(),this._renderTable(),this._sorting.addSortable&&this._sorting.addSortable(this),this._addSelectable(),this._addEditable(),this._addSave(),this.row_actions_add(),this.__addFilterable(),this._refreshHead(),this.ScrollClasterized=this.Scroll(),t.checkIsUpdated>0){let e=2e3*parseInt(t.checkIsUpdated);setTimeout(function(){t.checkTableIsChanged.call(t,e)},e)}this.refresh(),this.setWidthes(),this.__applyFilters(),e&&(this.isMobile?t._addInsertWithPanel(e):t._addInsert(e))},_addSave:function(){t("body").on("keyup",function(e){(e.ctrlKey||e.metaKey)&&"s"===String.fromCharCode(e.which).toLowerCase()&&0===t("#bigOneCodemirror").length&&t("body").trigger("ctrlS")})},reloaded:function(){let e=t("#refresh-notify");e.length&&(e.closest(".alert").remove(),this.checkTableIsChanged(2e3*parseInt(this.checkIsUpdated)))},checkTableIsChanged:function(e){let n=this;document.hidden?setTimeout(function(){n.checkTableIsChanged.call(n,e)},1e3):n.model.checkTableIsChanged.call(n.model).then(function(i){if(i.no||n.model.tableData.updated.code===i.code)n.checkTableIsChanged.call(n,e);else{let a=function(){n.model.tableData.updated.code===i.code?n.checkTableIsChanged.call(n,e):(t.notify({message:'<div id="refresh-notify"><button class="btn btn-warning btn-sm" style="margin-right: 20px;">Обновить</button> <span>Таблица была изменена пользователем <b>'+i.username+"</b> в <b>"+App.dateFormats.covert(i.dt,"YY-MM-DD HH:mm","HH:mm DD.MM")+"</b> </span></div>"},{type:"warning",allow_dismiss:!1,delay:0}),t("#refresh-notify button").on("click",function(){n.model.refresh()}))};n.model.doAfterProcesses(function(){setTimeout(a,200)})}})},_getTableMainFieldName:function(e,t){let n;return Object.keys(e).some(function(i){let a=e[i];if(a.id==t)return n=a.name,!0}),n},_getFieldbyName:function(e){return this.fields[e]},_getColumnIndexByTd:function(e,t){return(t=t||e.closest("tr")).find("td").index(e)},_fieldByTd:function(e,t){let n=this._getColumnIndexByTd(e,t);return this.fieldCategories.visibleColumns[n-1]},_getRowIndexById:function(e){let t=this;for(let n in t.data)if(t.data[n].id==e)return n;return null},_getFieldBytd:function(e){return e.closest("tr").is(".DataRow")?this.fieldCategories.visibleColumns[e.closest("tr").find(e.prop("tagName")).index(e)-1]:this.fields[e.data("field")]},_isParamsArea:function(e){return e.closest("table").is(".pcTable-paramsTable")},_isFootersArea:function(e){return e.closest("tbody").is(".pcTable-footers")},_getItemBytd:function(e){let t=e.closest("tr");return this._getItemByTr(t)},_getItemByTr:function(e){return e.is(".DataRow")?this.data[e.data("pctableitemid")]:this.data_params},_getItemById:function(e){return this.data[e]},_deleteItemById:function(e){let t=this._getItemById(e);t&&t.$tr&&t.$tr.remove(),["dataSorted","dataSortedVisible","__checkedRows"].some(function(t){let n=this[t].indexOf(e);-1!==n&&this[t].splice(n,1)},this),delete this.data[e]},_getTdByFieldName:function(e,t){let n=0;return this.fieldCategories.visibleColumns.every(function(t,i){return e!=t.name||(n=i,!1)}),this._getTdByColumnIndex(t,n+1)},_getTdByColumnIndex:function(e,t){return e.find("td:eq("+t+")")},refresh:function(){this._refreshTitle(),this._refreshParamsBlock(),this._refreshFiltersBlock(this.data_params),this._refreshFootersBlock(),this._refreshContentTable()},initRowsData(){let e={};this.__checkedRows=[],this.dataSorted=[],this.dataSortedVisible=[],this.ScrollClasterized&&this.ScrollClasterized.emptyCache(),this.rows&&this.rows.map(function(t){this.dataSorted.push(t.id),this.dataSortedVisible.push(t.id),e[t.id]=t,e[t.id].$checked=-1!==this.__checkedRows.indexOf(t.id)},this),this.data=e,this.model.setLoadedTableData(this.data,this.PageData?this.PageData.offset:void 0,this.PageData?this.PageData.onPage:void 0)}})}(window,jQuery),App.models||(App.models={}),App.models.table=function(e,t,n){let i,a,l,o,s={},r=0,c=null;return n=n||{},{getUri:function(){return this.url},setLoadedTableData:function(e,t,n){i=e,a=t,l=n},addFiltersData:function(e){"use strict";n=$.extend(!0,{},n,e)},tableData:t,url:e,doAfterProcesses:function(e){let t=this;setTimeout(function(){t.getDefferedProcess().then(e)},50)},getDefferedProcess:function(){return new Promise((e,t)=>{Promise.all(Object.values(s)).then(()=>{e()})})},showLinks:function(e){App.showLInks(e.links,o.model),delete e.links},shoInterfaceDatas:function(e){App.showDatas.call(o.model,e.interfaceDatas),delete e.interfaceDatas},showPanels:function(e){App.showPanels(e.panels),delete e.panels},addPcTable:function(e){o=e},__ajax:function(e,d,f,p,h){"use strict";let u=this.url,m=!1,b=$.Deferred();h=h||{};let g=!1,v=!1,_=$.extend(!0,{},d,{tableData:t,ajax:!0},n,h);"checkTableIsChanged"===d.method||"checkForNotifications"===d.method?"checkForNotifications"!==d.method&&(_=$.extend({},d,{code:t.updated.code,ajax:!0},n),t.sess_hash&&(_.tableData={sess_hash:t.sess_hash})):(m=!0,p||setTimeout(function(){g||(App.fullScreenProcesses.showCog(),v=!0)},1e3)),void 0!==_.data&&"object"==typeof _.data&&(_.data=JSON.stringify(_.data)),i&&(_.ids=JSON.stringify(Object.keys(i))),void 0!==a&&(_.offset=a,_.onPage=l);let w=this,y=function(e){let t={edit:"Изменение",checkInsertRow:"Предварительное добавление",duplicate:"Дублирование",refresh_rows:"Пересчет строк",getTableData:"Загрузка информации о таблице",refresh:"Обновление данных таблицы",checkEditRow:"Предварительный расчет панели",saveEditRow:"Сохранение панели",save:"Изменение поля",click:"Нажатие кнопки",selectSourceTableAction:"Вызов панели",add:"Добавление строки",getEditSelect:"Загрузка селекта",delete:"Удаление"},n=$("#table").data("pctable");if(n){if(e.LOGS&&(n.LOGS||(n.LOGS={}),n.LOGS=$.extend(n.LOGS,e.LOGS)),e.FullLOGS){n.FullLOGS||(n.FullLOGS=[]);let i={text:t[_.method]||_.method};i.children=e.FullLOGS,e.FullLOGS.length&&(n.FullLOGS.push(i),App.blink(n.LogButton,8,"#fff"))}if(e.FieldLogs&&(n.FieldLOGSName=t[_.method]||_.method,n.FieldLOGS=e.FieldLogs),"loadPage"!==_.method&&n.PageData&&e.allCount){let t=!1;"offset"in e&&null!==e.offset&&n.PageData.offset!==e.offset&&(t=!0,n.PageData.offset=e.offset),"allCount"in e&&null!==e.allCount&&n.PageData.allCount!==e.allCount&&(t=!0,n.PageData.allCount=e.allCount),t&&n.PageData.$block.empty().append(n._paginationCreateBlock.call(n))}}if(e.error){var i=$("<div>").html(e.error.replace(/\[\[(.*?)\]\]/g,"<b>$1</b>"));if(e.log){let t=$('<button class="btn btn-xxs btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> c</i></button>');t.on("click",function(){BootstrapDialog.show({message:$('<pre style="max-height: '+($("body").height()-200)+'px; overflow: scroll">').css("font-size","11px").text(JSON.stringify(e.log,null,1)),type:BootstrapDialog.TYPE_DANGER,title:"Лог расчета",buttons:[{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],draggable:!0,onshown:function(e){e.$modalContent.position({of:window})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:1200})}})}),i.append(" "),i.append(t)}App.notify(i),b.reject(e)}else e.reload?window.location.href=window.location.href:(e.links&&e.links.length>0&&w.showLinks(e),e.interfaceDatas&&e.interfaceDatas.length>0&&w.shoInterfaceDatas(e),e.panels&&e.panels.length>0&&w.showPanels(e)),b.resolve(e)},x=function(e){let t,n;e&&200===e.status?e.responseJSON&&e.responseJSON.error?t=e.responseJSON.error:(t=$("<div>Ошибка выполнения операции  </div>"),o&&o.isCreatorView&&(t.append('<button class="btn danger-backg btn-xs" data-toggle="collapse" data-target="#notify-texh"><i class="fa fa-angle-down"></i><i class="fa fa-angle-up"></i></button>'),t.append($('<div id="notify-texh" class="collapse">').append($("<code>").text(e.responseText))))):!f&&e&&"abort"!=e.statusText&&"error"!=e.statusText?(t=e.statusText,n=200):f&&f.jqXHR&&"abort"!==f.jqXHR.statusText&&(t="Нет соединения с сервером",n=200),t&&-1===["checkTableIsChanged","checkForNotifications"].indexOf(d.method)&&(n?setTimeout(function(){App.notify(t)},n):App.notify(t),e.responseText),b.reject(e)},k=function(){(new Date).getTime()-c<150?setTimeout(k,50):(c=(new Date).getTime(),/\?/.test(u)?u+="&":u+="?",u+="rn="+Math.round(1e5*Math.random())+(_.method||""),$.ajax({url:u,method:e,data:_,dataType:"json",beforeSend:function(e,t){f&&(f.jqXHR=e)}}).then(y).fail(x))};k();let C,T=++r;s[T]=new Promise(e=>{C=e});let S=function(){setTimeout(()=>{delete s[T]},1e3),g=!0,v&&App.fullScreenProcesses.hideCog()};return m||(C(),C=(()=>{})),b.always(function(){setTimeout(S,100),C()}),b.promise()},delete:function(e){return 0!==e.length&&this.__ajax("post",{delete_ids:JSON.stringify(e),method:"delete"})},duplicate:function(e,t,n){return 0!==e.length&&this.__ajax("post",{duplicate_ids:JSON.stringify(e),data:t,insertAfter:n,method:"duplicate"})},dblClick:function(e,t){return this.__ajax("post",{field:t,id:e,method:"dblClick"})},getFieldLog:function(e,t,n){return this.__ajax("post",{field:e,id:t,method:"getFieldLog",rowName:n})},refresh_rows:function(e){return 0!==e.length&&this.__ajax("post",{refreash_ids:JSON.stringify(e),method:"refresh_rows"})},refresh_cycles:function(e){return 0!==e.length&&this.__ajax("post",{refreash_ids:JSON.stringify(e),method:"refresh_cycles"})},checkUnic:function(e,t){"use strict";return this.__ajax("post",{fieldName:e,fieldVal:t,method:"checkUnic"})},add:function(e){return this.__ajax("post",{data:e,method:"add"})},getValue:function(e,t){return this.__ajax("post",{data:e,method:"getValue",table_id:t})},getNotificationsTable:function(){return this.__ajax("post",{method:"getNotificationsTable"})},get:function(e){return this.__ajax("get",{id:e})},setTableFavorite:function(e){return this.__ajax("post",{status:e,method:"setTableFavorite"})},checkInsertRow:function(e,t){var n={};return $.each(e,function(e,t){void 0!=t&&(n[e]=t)}),this.__ajax("post",{data:n,editedFields:JSON.stringify(t),method:"checkInsertRow"})},checkEditRow:function(e){var t={};return $.each(e,function(e,n){void 0!=n&&(t[e]=n)}),this.__ajax("post",{data:t,method:"checkEditRow"})},checkTableIsChanged:function(){return this.__ajax("post",{method:"checkTableIsChanged",table_id:o.tableRow.id,cycle_id:o.tableRow.cycle_id})},checkForNotifications:function(e,t,n){return this.__ajax("post",{method:"checkForNotifications",periodicity:e,activeIds:t},n)},notificationUpdate:function(e,t,n,i){return this.__ajax("post",{method:"notificationUpdate",id:e,num:n,item:i,type:t})},selectSourceTableAction:function(e,t){return this.__ajax("post",{field_name:e,data:t,method:"selectSourceTableAction"})},saveEditRow:function(e){var t={};return $.each(e,function(e,n){void 0!==n&&(t[e]=n)}),this.__ajax("post",{data:t,method:"saveEditRow"})},getEditSelect:function(e,t,n,i,a){return this.__ajax("post",{data:{item:e,field:t},q:n,parentId:i,method:"getEditSelect"},void 0,!a)},loadPreviewHtml:function(e,t,n){return this.__ajax("post",{data:{item:function(e){let t={};return Object.keys(e).forEach(function(n){/^\$/.test(n)||("id"===n?t[n]=e[n]:null!==e[n]&&"object"==typeof e[n]&&-1!==Object.keys(e[n]).indexOf("v")?t[n]=e[n].v:t[n]=e[n])}),t}(t),field:e,val:n},method:"loadPreviewHtml"},null,!0)},save:function(e){let t={};return e.params&&Object.keys(e.params).some(function(e){if("filter"===o.fields[e].category)return o._filtersBlock.data("cryptoFilters")&&(t.filters=o._filtersBlock.data("cryptoFilters")),!0}),this.__ajax("post",{data:e,method:"edit"},null,null,t)},click:function(e){return this.__ajax("post",{data:e,method:"click"})},csvExport:function(e,t,n){return this.__ajax("post",{method:"csvExport",type:t,sorted_ids:JSON.stringify(e),visibleFields:JSON.stringify(n)})},csvImport:function(e,t,n,i){return this.__ajax("post",{csv:e,type:t,answers:n,method:"csvImport",visibleFields:JSON.stringify(i)})},getTableData:function(e){return this.__ajax("post",{method:"getTableData",tableData:{sess_hash:e}})},refresh:function(e){e=e||function(e){o.table_modify.call(o,e),o.reloaded.call(o)},this.__ajax("post",{method:"refresh"}).then(e)},saveOrder:function(e){return this.__ajax("post",{method:"saveOrder",orderedIds:JSON.stringify(e)})},setCommentsViewed:function(e,t,n){return this.__ajax("post",{method:"setCommentsViewed",nums:e,field_name:t,id:n})},AddEyeGroupSet:function(e,t){return this.__ajax("post",{method:"addEyeGroupSet",name:e,fields:t})},removeEyeGroupSet:function(e){return this.__ajax("post",{method:"removeEyeGroupSet",index:e})},leftEyeGroupSet:function(e){return this.__ajax("post",{method:"leftEyeGroupSet",index:e})},reUser:function(e){return this.__ajax("post",{method:"reuser",userId:e,location:window.location.pathname})},printTable:function(e){return this.__ajax("post",{method:"printTable",settings:JSON.stringify(e)})},getAllTables:function(){return this.__ajax("post",{method:"getAllTables"})},calcFieldsLog:function(e,t){return this.__ajax("post",{method:"calcFieldsLog",calc_fields_data:e,name:t})},renameField:function(e){return this.__ajax("post",{method:"renameField",name:e})},panelButtonsClick:function(e,t){return this.__ajax("post",{method:"panelButtonsClick",hash:e,index:t})},panelButtonsClear:function(e){return this.__ajax("post",{method:"panelButtonsClear",hash:e})},buttonsClick:function(e,t){return this.__ajax("post",{method:"linkButtonsClick",hash:e,index:t})},inputClick:function(e,t){return this.__ajax("post",{method:"linkInputClick",hash:e,val:t})},getChartTypes:function(){return this.__ajax("post",{method:"getChartTypes"})},getPanelFormats:function(e,t){return this.__ajax("post",{method:"getPanelFormats",field:e,id:t})},loadPage:function(e,t,n,i){let a={};return e&&e.filtersString&&(a.filters=e.filtersString),e.PageData.loading=!0,this.__ajax("post",{method:"loadPage",lastId:t,pageCount:n,prevLastId:i},null,null,a).then(function(t){let n;e.loadedPage=t.page,e.rows=t.rows,n=t.rows.length?{firstId:t.rows[0].id,lastId:t.rows[t.rows.length-1].id}:{firstId:0,lastId:0},e.PageData={...e.PageData,...{offset:t.offset,allCount:t.allCount,loading:!1},...n},e.initRowsData.call(e),e._refreshContentTable.call(e,!1,!0),e.__applyFilters.call(e,!0),e.PageData.$block.empty().append(e._paginationCreateBlock.call(e))})}}},$.fn.datetimepicker.defaults.icons.close="glyphicon glyphicon-ok",$.fn.datetimepicker.defaults.tooltips.close="Применить и закрыть",function(){window.Hlps||(window.Hlps={});var e=window.Hlps;e.selectpicker={},e.selectpicker.open=function(e){var t=$(e).data("selectpicker").$newElement.children()[0];(t=$(t)).attr("aria-expanded")&&"false"!==t.attr("aria-expanded")||t.click()},e.selectpicker.focus=function(e){var t=function(){var n=e.data("this");if(n&&e.is(".selectpicker")){var i=n.$newElement.children()[0];(i=$(i)).focus()}else{var a=0;setTimeout(function(){if(!(++a<4))return!1;t()},1+100*a)}};t()},e.selectpicker.getButton=function(e){var t=$(e).data("selectpicker").$newElement.children()[0];return t=$(t)}}(),function(){$(function(){let e=localStorage.getItem("topNavScroll"),t=$(".totbar-default.navbar-default");e>0&&t.scrollLeft(e),t.on("scroll",()=>{localStorage.setItem("topNavScroll",t.scrollLeft())})});const e=function(e){if(e){let t=e.chdata.rows[Object.keys(e.chdata.rows)[0]];const n=function(e,t){App.getPcTableById("tree").then(function(n){n.model.checkEditRow({id:e}).then(function(e){window.location.href="/Table/"+e.row.top.v+"/"+t})})};"calcs"===t.type.v?App.getPcTableById(1).then(function(e){e.model.checkEditRow({id:t.tree_node_id.v}).then(function(e){n(e.row.tree_node_id.v,t.tree_node_id.v)})}):n(t.tree_node_id.v,t.id)}};addTree=function(t,n,i){let a=$("div.page_content");if(!App.isTopWindow())return a.addClass("tree-minifyed iframed"),!1;window.TREE_DATA=n;let l=screen.width<=window.MOBILE_MAX_WIDTH;if(l?i=!1:($(window).on("resize",function(){window.innerWidth<=660&&!a.is(".tree-minifyed")&&u(!0)}),localStorage.getItem("notCreator")&&(i=!1)),$.jstree.defaults.core.dblclick_toggle=!1,$.jstree.defaults.core.expand_selected_onload=!0,$.jstree.defaults.core.force_text=!0,$.jstree.link_prefix=t,i){let t=$.jstree.core.prototype.redraw_node;$.jstree.core.prototype.redraw_node=function(n,i,a,l){let o=t.bind(this)(n,i,a,l),s=$(o).find(">a.edit-folder");if(s.length){let t=$('<i class="fa fa-edit edit-folder-icon"></i>');t.on("click",()=>(new EditPanel("tree",BootstrapDialog.TYPE_DANGER,{id:s.data("id")}).then(e),!1)),s.find(">i").after(t)}else{let t=$(o).find(">a.add_calcs_table");if(t.length){let n=$('<i class="fa fa-plus edit-folder-icon"></i>');n.on("click",()=>(new EditPanel(1,BootstrapDialog.TYPE_DANGER,{type:{v:"calcs"},tree_node_id:{v:t.data("id")}},{},{type:!0,tree_node_id:!0}).then(e),!1)),t.find(">i").after(n)}}return o}}let o,s=localStorage.getItem("tree")||"{}";s=JSON.parse(s),$.each(n,function(e,t){if(n[e].data={type:t.type},t.state&&t.state.selected&&(n[e].li_attr={class:"jstree-selected"}),s[t.id]&&(n[e].state||(n[e].state={}),n[e].state.opened=!0),t.href?n[e].a_attr={href:$.jstree.link_prefix+t.href}:t.link&&(n[e].a_attr={href:t.link}),i)switch(-1!==["link","anchor","folder"].indexOf(t.type)&&(t.a_attr=t.a_attr||{},t.a_attr={...t.a_attr,...{class:"edit-folder","data-id":t.id.substr(4)}}),t.type){case"folder":n.push({type:"plus",id:"plus-table"+t.id.substring(4),text:"Таблицу",parent:t.id,li_attr:{class:"jstree-creatorView"}}),n.push({type:"plus",id:"plus-folder"+t.id.substring(4),text:"Папку/Ссылку",parent:t.id,li_attr:{class:"jstree-creatorView"}});break;case"cycle_name":n.push({type:"plus",id:"plus-calcs"+t.parent.substring(4),text:"Таблицу",parent:t.id,li_attr:{class:"jstree-creatorView"}});break;case"table_cycles":t.a_attr={...t.a_attr,...{class:"add_calcs_table","data-id":t.id.substr(5)}}}}),i&&(o=t.match(/^.*?(\d+)/))&&(n.push({type:"plus",id:"plus-table"+o[1],text:"Таблицу",parent:"#",li_attr:{class:"jstree-creatorView"}}),n.push({type:"plus",id:"plus-folder"+o[1],text:"Папку/Ссылку",parent:"#",li_attr:{class:"jstree-creatorView"}}));let r=$("#leftTree"),c=$("#LeftTree"),d=()=>"tree_scroll_part_"+(window.top_branch||(window.location.pathname.match(/\/Table\/(\d+)/)||{1:0})[1]);const f=function(){r.jstree({state:{key:"leftTree"},core:{check_callback:!0,expand_selected_onload:!0,open_parents:!0,data:n,themes:{name:"default"}},types:{folder:{},plus:{icon:"fa fa-plus"},cycle_name:{icon:"fa fa-dot-circle-o"},text:{icon:"jstree-file"},table:{icon:"jstree-file"},table_simple:App.tableTypes.simple,table_version:App.tableTypes.version,table_calcs:App.tableTypes.calcs,table_tmp:App.tableTypes.tmp,table_globcalcs:App.tableTypes.globcalcs,table_cycles:App.tableTypes.cycles,table_data:{icon:"jstree-file"}},plugins:["types","themes"]}),p()};r.on("loaded.jstree after_open.jstree",function(e){let t=r.width();if(r.find("a.jstree-anchor").each(function(){let e=$(this),n=e.offset().left;e.width(t-n)}),"loaded"===e.type){let e=localStorage.getItem(d());e&&c.scrollTop(e),p()}}),r.on("select_node.jstree",function(t,n){switch(localStorage.setItem(d(),c.scrollTop()),(n.node.data?n.node.data.type:null)||n.node.type){case"plus":let t=n.node.id.substring(5,10);if("calcs"===t){let e=n.node.id.substring(11);n.node.parent.substring(5);new EditPanel(1,BootstrapDialog.TYPE_DANGER,{tree_node_id:{v:e},type:{v:"calcs"}}).then(function(e){e&&window.location.reload(!0)})}else if("table"===t){let t=n.node.id.length>10?n.node.id.substring(10):window.location.pathname.match(/^\/.*\/(\d+)\//)[1];new EditPanel(1,BootstrapDialog.TYPE_DANGER,{tree_node_id:{v:t}}).then(e)}else{let e=n.node.id.length>11?n.node.id.substring(11):window.location.pathname.match(/^\/.*\/(\d+)\//)[1];new EditPanel("tree",BootstrapDialog.TYPE_DANGER,{parent_id:{v:e}}).then(function(e){e&&window.location.reload(!0)})}return!1;case"link":window.location.href=n.node.a_attr.href;break;case"folder":case"project":return n.node.state.opened?($("#leftTree").jstree("close_node",n.node),s[n.node.id]&&(delete s[n.node.id],localStorage.setItem("tree",JSON.stringify(s)))):($("#leftTree").jstree("open_node",n.node),s[n.node.id]=!0,localStorage.setItem("tree",JSON.stringify(s))),!1;default:window.location.pathname.match(/^\/Table\//)?window.location.href=n.node.original.link?n.node.original.link:$.jstree.link_prefix+n.node.original.href:window.location.href=n.node.original.href}return!1});const p=function(){setTimeout(function(){c.getNiceScroll().resize()},250)};r.on("open_node.jstree",function(e,t){s[t.node.id]=!0,localStorage.setItem("tree",JSON.stringify(s)),p()}),r.on("close_node.jstree",function(e,t){s[t.node.id]&&(delete s[t.node.id],localStorage.setItem("tree",JSON.stringify(s))),p()});let h=localStorage.getItem("TreeMinimizer")||"false";h=JSON.parse(h);let u=function(e){h=e;const t=$("#page-tree");e?($("body>.page_content").addClass("tree-minifyed"),$("#LeftTree").getNiceScroll().resize(),t.length&&(t.append(r),r.trigger("after_open"))):($("body>.page_content").removeClass("tree-minifyed"),t.length&&($(".TreeContainer").append(r),r.trigger("after_open"))),$("#table").data("pctable")&&$("#table").data("pctable").setWidthes(),f(),localStorage.setItem("TreeMinimizer",JSON.stringify(h)),p()};l||c.niceScroll({cursorwidth:7,mousescrollstep:190,mousescroll:190,autohidemode:!1,enablekeyboard:!1,cursoropacitymin:1,railoffset:{left:4},cursorcolor:"#e1e0df"}),$("#TreeMaximizer").on("click",function(){if(l||window.innerWidth<=660){let e=$("<div>");e.append($("#branch-title")),e.append($("#leftTree")),App.mobilePanel('<a class="totum-brand" href="/"><span>'+$(".totum-brand span:first").text()+"</span></a>",e,{onhide:function(){const e=$("#page-tree");1===e.length?(r.appendTo(e),f()):(r.appendTo(".TreeContainer"),f())},cssClass:"mobile-panel mobile-menu"}),r.trigger("after_open")}else u(!1)}),$("#TreeMinimizer").on("click",function(){u(!0)}),!0===h?setTimeout(function(){u(h)},1):l?setTimeout(function(){1===$("#page-tree").length&&r.appendTo($("#page-tree")),f()},10):f()}}(),App.blink=function(e,t,n){let i=t||8,a=!0,l=function(){a?e.css("background-color",n):e.css("background-color",""),a=!a,--i>0&&setTimeout(l,300)};setTimeout(l,300)},App.mobilePanel=function(e,t,n){return n=n||{},window.top.BootstrapDialog.show($.extend({type:"edit",message:t,draggable:!0,title:e,cssClass:"mobile-panel "+(n.buttons?" with-buttons":"")},n))},App.panelTimer=function(e,t,n){let i,a=t,l=$("<div>");l.html(a);let o=BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:e,message:l,onhide:function(){i&&clearTimeout(i)},buttons:[{action:function(e){i&&clearTimeout(i),e.close()},label:"Отмена"}]}),s=function(){--a<=0?(o.close(),n()):(l.html(a),i=setTimeout(s,1e3))};s()},App.panel=function(e,t,n){return n=n||{},window.top.BootstrapDialog.show($.extend({type:"edit",message:t,draggable:!0,title:e,cssClass:"web-panel "+(n.buttons?" with-buttons ":"")+(n.class||"")},n))},App.setSessionStorage=function(e,t){sessionStorage.setItem(e,JSON.stringify(t))},BootstrapDialog.BUTTON_SIZES[BootstrapDialog.SIZE_NORMAL]="btn-m",BootstrapDialog.defaultOptions.animate=!1,BootstrapDialog.defaultOptions.closeByBackdrop=!1,BootstrapDialog.defaultOptions.nl2br=!1,BootstrapDialog.defaultOptions.type=null,BootstrapDialog.BootstrapDialogModal.prototype.resetScrollbar=function(){0===this.getGlobalOpenedDialogs().length&&this.$body.css("padding-right",5)},function(){let e,t,n=0,i=-1;setTimeout(()=>{(t=App.models.table("/Table/")).addPcTable({model:t})},10),App.checkNotificationManager=function(n){if(n=n||void 0,Object.keys(n).length>1){if(!e||!e.closest("body").length){let i;(e=$('<div data-notify="container" class="col-xs-11 col-sm-4 alert alert-warning" role="alert" id="notifies_manager" ><button type="button" aria-hidden="true" class="close" data-notify="dismiss">&times;</button><button class="timer" id="notification_clock_panel_all_timer"><i class="fa fa-clock-o"></i></button></div>')).appendTo("body"),e.find("button.close").on("click",function(){a(),e.remove(),e=null,t.notificationUpdate(Object.keys(n),"deactivate").then(function(){}),Object.values(n).forEach(e=>{e.forEach(e=>{e.$modal.remove()})}),n=[]}).on("remove",()=>{i&&i.popover("destroy")}),e.find("button.timer").on("click",function(){if($(this).is(".active"))return!1;$(this).addClass("active"),i=$(this),$div=$('<div><div id="notification_clock_panel_all"><span class="clocks-na">На</span> <input type="number" step="1" value="10" class="form-control"/> <select class="form-control"><option  selected value="1">минут</option><option value="2">часов</option><option value="3">дней</option></select> <button>Отложить все</button></button></div></div>'),$div.on("click","button",function(){let i=$div.find("input").val(),l=$div.find("select").val();a(),t.notificationUpdate(Object.keys(n),"later",i,l).then(function(){}),e.remove(),e=null,Object.values(n).forEach(e=>{e.forEach(e=>{e.$modal.remove()})}),n=[]}),i.popover({placement:"bottom",content:$div,html:!0,animation:!1,container:$("body")}).popover("show"),i.on("remove",a),setTimeout(()=>{$("body").on("click.notes",e=>{$(e.originalEvent.path[0]).closest("#notification_clock_panel_all").length||(i.popover("destroy"),a())})},20)});const a=function(){$("body").off("click.notes"),$("#notification_clock_panel_all_timer").removeClass("active")}}}else e&&(e.remove(),e=null)},App.showLInks=function(e,t){e.forEach(function(e){if(-1!==["top-iframe","iframe"].indexOf(e.target)&&window.top!=window)return void window.top.App.showLInks([e],t);let a=function(l){"use strict";if(e.postData){let i,o="_self";if("iframe"===l||"top-iframe"===l){let l="iframe"+ ++n;o=l;let s,r=BootstrapDialog.show({message:s=$('<iframe style="width: 100%; '+(e.width?"":"min-width: 500px;")+' height: 70vh; border: none" name = "'+l+'"></iframe>'),size:BootstrapDialog.SIZE_WIDE,title:e.title,draggable:!0,cssClass:"target-iframe",onhidden:function(){if(e.refresh){$("#table").data("pctable");t.refresh()}},onshown:function(t){if(e.width){let n=500;e.width>n&&(n=e.width),t.$modalDialog.width(n)}let n=s.get(0).contentWindow,i=function(){try{n.App&&n.App.setSessionStorage?n.App.setSessionStorage.call(n,"linkObject",e):setTimeout(i,200)}catch(e){}};i()},buttons:[{label:"Обновить",cssClass:"btn-m btn-default",action:function(){s.get(0).contentWindow.location.reload(),i.detach()}},{label:"Открыть",cssClass:"btn-m btn-default",action:function(e){a("self")}},{label:"Вкладка",cssClass:"btn-m btn-default",action:function(t){try{s.get(0).contentWindow.sessionStorage.linkObject&&(e=JSON.parse(s.get(0).contentWindow.sessionStorage.linkObject))}catch(e){}a("blank"),t.close()}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}]});s.on("load",function(){let e=s.get(0).contentWindow;try{e.closeMe=function(){r.close()}}catch(e){}})}else"blank"===l?o="_blank":"parent"===l?o="_parent":"top"===l?o="_top":window.parent!==window&&(sessionStorage.linkObject=JSON.stringify(e));i=$("<form>",{method:"post",action:e.uri,target:o});const s=function(e,t){"boolean"==typeof t&&(t=!0===t?"true":"false"),"string"==typeof t||"number"==typeof t||null===t?i.append($("<input>",{type:"hidden",name:e,value:t})):$.each(t,function(t,n){s(e+"["+t+"]",n)})};$.each(e.postData,function(e,t){s(e,t)}),i.appendTo("body").submit(),i.detach()}else switch(l){case"top":window.top.location.href=e.uri;break;case"parent":window.parent.location.href=e.uri;break;case"blank":let n=$('<a href="'+e.uri+'" target="_blank">link</a>');n.appendTo("body"),n.get(0).click(),n.remove();break;case"iframe":case"top-iframe":let o=e.uri;if(e.elseData){let t=[];!1===e.elseData.header&&t.push("param"),!1===e.elseData.footer&&t.push("footer"),o+="#"+encodeURIComponent(JSON.stringify({wc:t}))}let s=$('<iframe src="'+o+'" style="width: 100%; height: 70vh; border: none"></iframe>'),r=BootstrapDialog.show({message:s,draggable:!0,size:BootstrapDialog.SIZE_WIDE,title:e.title,cssClass:"target-iframe",onhidden:function(){e.refresh&&t.refresh(),i--},onshown:function(t){e.width&&t.$modalDialog.width(e.width),++i&&t.$modalDialog.css("margin-top",30+20*i);let n=s.get(0).contentWindow,a=function(){try{n.App&&n.App.setSessionStorage?n.App.setSessionStorage.call(n,"linkObject",e):setTimeout(a,200)}catch(e){}};a()},buttons:[{label:"Обновить",cssClass:"btn-m btn-default",action:function(){s.get(0).contentWindow.location.reload()}},{label:"Открыть",cssClass:"btn-m btn-default",action:function(t){try{s.get(0).contentWindow.sessionStorage.linkObject&&(e=JSON.parse(s.get(0).contentWindow.sessionStorage.linkObject))}catch(e){}a("self")}},{label:"Вкладка",cssClass:"btn-m btn-default",action:function(t){try{s.get(0).contentWindow.sessionStorage.linkObject&&(e=JSON.parse(s.get(0).contentWindow.sessionStorage.linkObject))}catch(e){}a("blank"),t.close()}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}]});s.on("load",function(){let e=s.get(0).contentWindow;try{e.closeMe=function(){r.close()}}catch(e){}});break;default:window.parent!=window&&(sessionStorage.linkObject=JSON.stringify(e)),window.location.href=e.uri}};a(e.target)})},App.showDatas=function(e,t){let n,i=[],l=this;return e.forEach(function(e){switch(e[0]){case"input":let o,s,r=$("<div>").html(e[1].html);r.find("#ttmInput").length?o=r.find("#ttmInput"):(o=$('<input type="text" class="form-control" id="ttmInput">'),e[1].value&&o.val(e[1].value),r.append(o),o.wrap("<div>"),o.on("keydown",e=>{13===e.keyCode&&c()}));let c=function(){l.inputClick(e[1].hash,o.val()).then(function(){e[1].refresh&&l.refresh(),s.close()})};setTimeout(()=>{o.focus()},1),n={buttons:[{label:e[1].button||"Сохранить",action:c},{label:"Отмена",action:function(e){e.close()}}],class:"linkButtons"},screen.width<=window.MOBILE_MAX_WIDTH?s=App.mobilePanel(e[1].title,r,n):(!n.width&&n.html||(n.onshown=function(e){n.width&&e.$modalDialog.width(n.width)}),s=App.panel(e[1].title,r,n));break;case"buttons":n={...e[1],buttons:[],class:"linkButtons"},e[1].buttons.forEach(function(t,i){n.buttons.push({id:"link-btn"+i,label:t.text,action:function(t){l.buttonsClick(e[1].hash,i).then(function(){e[1].buttons[i].refresh&&l.refresh(),t.close()})},icon:t.icon?"fa fa-"+t.icon:null,background:t.background,color:t.color})}),screen.width<=window.MOBILE_MAX_WIDTH?App.mobilePanel(e[1].title,$("<div>").html(e[1].html),n):(!n.width&&n.html||(n.onshown=function(e){n.width&&e.$modalDialog.width(n.width),n.html||e.$modalBody.remove(),n.buttons.forEach(t=>{let n=e.getButton(t.id);t.background&&n.css("background-color",t.background),t.color&&n.css("color",t.color)})}),App.panel(e[1].title,$("<div>").html(e[1].html),n));break;case"table":if(window.top!=window)return window.top.App.showDatas.call(l,[e]);i.push(function(e,t){let n;e.height&&(n=e.height,/^\d+$/.test(e.height)&&(n+="px"));let i="/Table/0/"+e.table_id+"?sess_hash="+e.sess_hash;"/"===window.location.pathname||/^\/Table\//.test(window.location.pathname)||(i=e.table_id+"?sess_hash="+e.sess_hash);let l=$('<iframe style="width: 100%; height: '+(n||"80vh")+'; border: none;" src="'+i+'">');$("body").append(l);let o=[];$("#table").data("pctable")&&$("#table").data("pctable").isCreatorView&&o.push({label:"В новой вкладке",cssClass:"btn-m btn-danger",action:function(e){window.open(i,"_blank");e.close()}});let s=a(e.title,l,e.width,e.refresh,null,t,o);l.on("load",function(){let e=l.get(0).contentWindow;e.closeMe=function(){s.close()}})}(e[1],l));break;case"text":i.push(function(e,t){a(e.title,e.text,e.width,e.refresh,null,t)}(e[1],l));break;case"print":i.push(function(e,t,n){if(App.fullScreenProcesses.showCog(),n){var i=new Blob([atob(n)],{type:"application/pdf"}),a=URL.createObjectURL(i),l=document.createElement("a");l.href=a,l.target="_blank",document.body.appendChild(l),l.click()}else{let n=$('<iframe style="width: 500px; height: 200px; position: absolute; top: -1000px; background: #fff;">').appendTo(window.top.document.body),i=n[0],a=i.contentWindow?i.contentWindow:i.contentDocument.defaultView;a.document.head.innerHTML="<style>"+t+"</style>",a.document.body.innerHTML=e;let l=a.document.body,o=$.Deferred(),s=0;const r=function(){l.scrollTop=l.scrollHeight+100,++s<100&&l.scrollTop>=l.scrollHeight?setTimeout(r,50):setTimeout(function(){o.resolve()},3e3)},c=function(){++s<100&&l.scrollHeight<200?setTimeout(c,50):(s=0,r())};c(),o.then(function(){App.fullScreenProcesses.hideCog(),setTimeout(function(){a.focus(),a.print()},250),setTimeout(function(){},1e4)})}}(e[1].body,e[1].styles));break;case"notification":let d,f,p=function(e){let t={x:20,y:70};return screen.width<=window.MOBILE_MAX_WIDTH&&(t.x=.09*window.innerWidth/2),e&&(t.y+=60),t}();e[1].text?f="<div>"+e[1].text+"</div>":(f=e[1].title+'<div class="body"></div>',setTimeout(()=>{d.$ele.find(".body").append(function(e,t){let n;e.height&&(n=e.height,/^\d+$/.test(e.height)&&(n+="px"));let i="/Table/0/"+e.table_id+"?sess_hash="+e.sess_hash;/^\/Table\//.test(window.location.pathname)||(i=e.table_id+"?sess_hash="+e.sess_hash);let a=$('<iframe style="width: 100%; height: '+(n||"80vh")+'; border: none;" src="'+i+'">');return a.on("load",function(){let e=a.get(0).contentWindow;e.closeMe=t,$(e.document.body).css("background-color","transparent")}),a}(e[1],()=>{d.$ele.remove()}))})),(d=$.notify({message:f},{offset:p,type:"warning",allow_dismiss:!0,delay:0,onClose:function(){d.$ele.data("deactivated")||l.notificationUpdate(t,"deactivate").then(function(){d.$ele.trigger("hide.bs.modal")})}})).$ele.find("button.close").after('<button class="timer"><i class="fa fa-clock-o"></i></button>'),d.$ele.css("transition","none"),d.$ele.on("click",".timer:not(.disabled)",function(){let e=$(this);e.addClass("disabled"),$div=$('<div><div id="notification_clock_panel"><span class="clocks-na">На</span> <input type="number" step="1" value="10" class="form-control"/> <select class="form-control"><option  selected value="1">минут</option><option value="2">часов</option><option value="3">дней</option></select> <button>Отложить</button></button></div></div>'),$div.on("click","button",function(){let i=$div.find("input").val(),a=$div.find("select").val();n(),l.notificationUpdate(t,"later",i,a).then(function(){}),e.popover("destroy"),d.$ele.data("deactivated",!0),d.$ele.find('button[data-notify="dismiss"]').click()});const n=function(){$("body").off("click.note"+t),e.removeClass("disabled")};e.popover({placement:"bottom",content:$div,html:!0,animation:!1,container:$("body")}).popover("show"),e.on("remove",n),setTimeout(()=>{$("body").on("click.note"+t,t=>{$(t.originalEvent.path[0]).closest("#notification_clock_panel").length||(e.popover("destroy"),n())})},20)}),i.push({$modal:d.$ele,simpleClose:()=>{d.$ele.data("deactivated",!0),d.$ele.find('button[data-notify="dismiss"]').click()},notification:d})}}),i},App.getPcTableById=function(e,t,n,i){let a=$.Deferred();return new App.models.table("/Table/0/"+e.toString(),{},{}).getTableData(t?t.sess_hash:null).then(function(l){if(i&&(!1===i.withHeader||!1===i.withFooter)){Object.values(l.fields).forEach(function(e,t){"param"===e.category&&!1===i.withHeader?delete l.fields[e.name]:"footer"===e.category&&!1===i.withFooter&&delete l.fields[e.name]}),delete i.withHeader,delete i.withFooter}l.model=new App.models.table("/Table/0/"+e.toString(),$.extend({updated:l.updated},t||{})),$.extend(!0,l,i);let o=new App.pcTableMain(n,l);a.resolve(o)}),a.promise()},App.showPanels=function(e){if(window.top!=window)return window.top.App.showPanels.call(window.top,e);let t={},n=$.Deferred();const i=function(){let a=e.shift(),l={};a.id?l.id=a.id:a.field&&(l=a.field);const o=function(t){new EditPanel(t.tableRow.id,null,l,e.length>0).then(function(t,l){if(t&&a.refresh){$("#table").data("pctable").model.refresh()}else if((t||l)&&e.length)return void i();n.resolve()})};a.uri!==window.location.pathname?t[a.uri]?o(t[a.uri]):new App.models.table(a.uri,{},{}).getTableData().then(function(e){e.model=new App.models.table(a.uri,{updated:e.updated}),t[a.uri]=new App.pcTableMain(null,e),o(t[a.uri])}):o($("#table").data("pctable"))};return i(),n};let a=function(e,t,n,a,l,o,s){return(s=s||[]).push({label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}),BootstrapDialog.show({message:t,title:e,type:l||null,draggable:!0,onhidden:function(){a&&("strong"===a?window.location.reload():o.refresh()),i--},onshown:function(e){n&&e.$modalDialog.width(n),++i&&e.$modalDialog.css("margin-top",30+20*i)},buttons:s})}}(),Object.equals=function(e,t){let n=[];return function e(t,i){if(t===i)return!0;if(t instanceof Date&&i instanceof Date)return+t==+i;if("object"!=typeof t||"object"!=typeof i||null===i||null===t)return!1;if(function(e,t){for(var i=n.length;i--;)if(!(n[i][0]!==e&&n[i][0]!==t||n[i][1]!==t&&n[i][1]!==e))return!0;return!1}(t,i))return!0;if(n.push([t,i]),Array.isArray(t)!==Array.isArray(i))return!1;if(Array.isArray(t)){if(t.length!==i.length)return!1;let n=t.length;for(;n--;)if(!e(t[n],i[n]))return!1}else{let n=Object.keys(t),a=n.length;if(Object.keys(i).length!==a)return!1;for(;a--;)if(!e(t[n[a]],i[n[a]]))return!1}return!0}(e,t)},Object.getPath=function(e,t,n){let i=e;for(let e=0;e<t.length;e++){let a=t[e];if("object"!=typeof i||!(a in i))return n;i=i[a]}return i},String.prototype.hashCode=function(){var e,t=0;if(0===this.length)return t;for(e=0;e<this.length;e++)t=(t<<5)-t+this.charCodeAt(e),t|=0;return t},App.confirmation=function(e,t,n){let i=[];return Object.keys(t).forEach(function(e){i.push({label:e,action:t[e]})}),BootstrapDialog.show({type:"edit",title:n,message:e,buttons:i,draggable:!0,onshow:function(e){e.$modalContent.css({width:"70vw",maxWidth:"800px"})},onshown:function(e){e.$modalContent.position({of:window})}})},App.copyMe=function(e){let t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)},App.dateFormats={base:"DD.MM.YY",db:"YYYY-MM-DD",covert:function(e,t,n){return moment(e,t).format(n)},covertToDb:function(e,t){return t=t||this.base,moment(e,t).format(this.db)},covertFromDb:function(e,t){return t=t||this.base,moment(e,this.db).format(t)},isValid:function(e,t){return t=t||this.base,moment(e,t).isValid()}},App.dateTimeFormats={base:"DD.MM.YY HH:mm",db:"YYYY-MM-DD HH:mm",covert:function(e,t,n){return moment(e,t).format(n)},covertToDb:function(e,t){return t=t||this.base,moment(e,t).format(this.db)},covertFromDb:function(e,t){return t=t||this.base,moment(e,this.db).format(t)},isValid:function(e,t){return t=t||this.base,moment(e,t).isValid()}},function(){let e="fa-cog",t=$("#big_loading i"),n=0;App.fullScreenProcesses={showCog:function(){1===++n&&App.fullScreenProcesses.show("fa-cog",!0)},hideCog:function(){--n<1&&(n=0,App.fullScreenProcesses.hide())}},App.fullScreenProcesses.show=function(n,i){i=i||!1,$("body").addClass("lock"),i&&!t.is(".fa-spin")?t.addClass("fa-spin"):!i&&t.is(".fa-spin")&&t.removeClass("fa-spin"),e!=n&&(t.removeClass(e).addClass(n),e=n),$("#big_loading").show().animate({opacity:1},250)},App.fullScreenProcesses.hide=function(e){$("body").removeClass("lock"),$("#big_loading").animate({opacity:0},250,function(){$("#big_loading").hide()})}}(),App.hexToRGB=function(e,t){var n=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return t?"rgba("+n+", "+i+", "+a+", "+t+")":"rgb("+n+", "+i+", "+a+")"},$.fn.extend({isAttached:function(){return 1===$(this).closest("html").length}}),App.isTopWindow=function(){let e=!1;try{e=window!=window.top||document!=top.document||self.location!=top.location}catch(t){e=!0}return!e},App.logOutput=function(e){let t=$('<div style="overflow-x: auto">'),n=[{label:"Развернуть все",cssClass:"btn-m btn-default",action:function(e){t.jstree("open_all")}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];"string"==typeof e&&n.splice(0,1),window.top.BootstrapDialog.show({message:t,type:BootstrapDialog.TYPE_DANGER,title:"Схема расчета",buttons:n,draggable:!0,cssClass:"log-output",onshown:function(n){n.$modalContent.position({of:window.top}),"string"==typeof e?t.html('<div style="color: white; ">'+e+"</div>"):t.jstree({state:{key:"leftTree"},core:{check_callback:!0,open_parents:!0,data:e,themes:{name:"default-dark"}},types:{folder:{},code:{icon:"fa fa-cog"},cogs:{icon:"fa fa-cogs"},error:{icon:"fa fa-exclamation-triangle"},list:{icon:"fa fa-code"},fixed:{icon:"fa fa-hand-rock-o"},param:{icon:"fa fa-hashtag"},execcode:{icon:"fa fa-magic"},recalcs:{icon:"fa fa-recycle"},clocks:{icon:"fa fa-clock-o"},mbs:{icon:"fa fa-database"},selects:{icon:"fa fa-navicon"},"!":{icon:"fa fa-exclamation"},table_simple:App.tableTypes.simple,table_version:App.tableTypes.version,table_calcs:App.tableTypes.calcs,table_tmp:App.tableTypes.tmp,table_globcalcs:App.tableTypes.globcalcs,table_cycles:App.tableTypes.cycles},plugins:["types","themes"]})},onshow:function(e){let t=.8*window.top.innerWidth;e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:t}),e.$modalContent.find(".modal-body").css("background-color","#333")}})},App.modal=function(e,t,n){var i=$('<div class="modal fade" id="appNotify" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title"></h4> </div> <div class="modal-body"> </div> <div class="modal-footer"> </div> </div> </div> </div>');if((l={body:i.find(".modal-body"),header:i.find(".modal-header"),title:i.find(".modal-title"),footer:i.find(".modal-footer"),block:i}).block.on("hidden.bs.modal",function(){$(this).remove()}),"object"==typeof e&&e instanceof jQuery?l.body.empty().append(e):l.body.html(e),t?l.title.html(t):l.header.hide(),n)if("object"==typeof n){var a=$("<div>"),l=l;$.each(n,function(e,t){if("close"!=t){var n="default";"object"==typeof t&&(t.class&&(n=t.class),t.func&&(t=t.func));var i=$('<button type="button" class="btn btn-'+n+'">'+e+"</button>");a.append(i),t&&"function"==typeof t&&i.on("click",function(){t(l.block)})}else a.append('<button type="button" class="btn btn-default" data-dismiss="modal">'+e+"</button>")}),l.footer.html(a.children())}else l.footer.html(n);else l.footer.hide();return l.block.modal("show").css("z-index","10000"),l.block},$.expr.pseudos.multiincludes=function(e,t,n){let i=$(e).find("a"),a=(i.data("tokens")||i.text()).toString().toUpperCase().replace("ё","е");return!n[3].toUpperCase().replace("ё","е").split(" ").some(function(e){return-1===a.indexOf(e)})},App.notify=function(e,t,n){BootstrapDialog.show({message:e,type:BootstrapDialog.TYPE_DEFAULT,title:t,buttons:[{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],onshow:function(e){t||e.$modalHeader.remove()}})},App.topNotify=function(e,t,n){t=t||"",$("#notifies").append('<div class="alert alert-success"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>'+t+"</strong>"+e+"</div>")},App.popNotify=function(e,t,n,i,a){let l,o="bottom",s={},r={};return e.isParams&&(s=e,e.element&&(t=e.element),e.timeout&&(n=e.timeout),e.container&&(i=e.container),e.trigger&&(a=e.trigger),e.placement&&(o=e.placement),e.class&&(l=e.class),e=e.$text),n=n||void 0,i=i||t.closest(".pcTable-scrollwrapper, .InsertPanel"),a=a||"manual",r=$.extend(r,{html:!0,content:e,trigger:a,container:i,placement:o,width:"70vw",animation:!1}),"default"==n&&(n=2e3),t.on("shown.bs.popover",function(){let e=t.data("bs.popover"),n=parseInt(e.$tip.css("left")),a=parseInt(e.$arrow.css("left"));if(n<0&&(e.$tip.css("left",0),e.$arrow.css("left",a+n+"px")),"bottom"===o){let n=t.offset().top+t.outerHeight(),a=e.$tip.offset().top,l=i.scrollTop()-i.offset().top;a-n>10&&e.$tip.css("top",n+2+l+(i.is(".InsertPanel")?$(".modal-dialog").offset().top:0))}}),t.popover(r),"manual"==a&&(t.popover("show"),l&&$("#"+t.attr("aria-describedby")).addClass(l)),t.on("remove destroy",function(){t&&t.attr("aria-describedby")&&t.popover("destroy")}),e.on&&e.on("remove destroy",function(){t.length&&t.attr("aria-describedby")&&$("#"+t.attr("aria-describedby")).length&&t.popover("destroy")}),n&&setTimeout(function(){t&&t.attr("aria-describedby")&&t.popover("destroy")},n),t.attr("aria-describedby")},App.ksort=function(e){var t=Object.keys(e).sort(),n={};for(var i in t)n[t[i]]=e[t[i]];return n},App.values=function(e){let t=[];for(let n in e)t.push(e[n]);return t},App.keys=function(e){let t=[];for(let n in e)t.push(n);return t},App.isEmpty=function(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;if("object"!=typeof e)return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0},App.filter=function(e,t){let n={};return Object.keys(e).forEach(function(i){t(i,e[i])&&(n[i]=e[i])}),n},App.openInIframe=function(e,t,n){n=n||"newIframe";let i=$('<iframe style="min-width: 500px; width: 100%; height: 70vh; border: none" name = "'+n+'"></iframe>');BootstrapDialog.show({message:i.attr("src",t),size:BootstrapDialog.SIZE_WIDE,title:e,buttons:[{label:"Обновить",cssClass:"btn-m btn-default",action:function(e){let a;a=$('<iframe style="min-width: 500px; width: 100%; height: 70vh; border: none" name = "'+n+'"></iframe>').attr("src",t),i.replaceWith(a),i=a}},{label:"Открыть",cssClass:"btn-m btn-default",action:function(e){$("<a>").attr("href",t).hide().appendTo("body").get(0).click(),e.close()}},{label:"Вкладка",cssClass:"btn-m btn-default",action:function(e){let n=$("<a>").attr("href",t).attr("target","_blank").hide().appendTo("body");n.get(0).click(),n.remove(),e.close()}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}]})},App.aInIframe=function(e){return e=$(e),App.openInIframe(e.text(),e.attr("href")),!1},App.reUserInterface=function(e,t){let n=$("#UserFio");n.css("cursor","pointer"),t&&App.blink(n,10,"#ffe486");const i=function(){let t=$('<div class="tech-table" style="height: 220px; width: 200px;"><div class="select-btn"></div><div></div></div>'),a=$('<select data-size="6" class="open" title="Выберите пользователя" data-style="btn-sm btn-default" data-live-search="true" data-width="100%">');Object.keys(e).forEach(function(t){a.append($("<option>").text(t).data("content",e[t]))});let l=t.find(".tech-table");t.find(".select-btn").append(a),n.popover({html:!0,content:t,trigger:"manual",container:"body",placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),a.selectpicker("render").selectpicker("toggle"),a.data("container",l),a.on("hide.bs.select",function(){return a.val()&&function(e){let t=App.models.table("/Table/",{},{}),n=$("#table").data("pctable")||{isCreatorView:!0};t.addPcTable(n),t.reUser(e)}(a.val()),$("body").off("click.FioPopover"),!1}),setTimeout(function(){a.selectpicker("render"),n.popover("show"),$("#"+n.attr("aria-describedby")).css("top","45px"),a.data("selectpicker").$searchbox.focus(),$("body").one("click.FioPopover",function(e){void 0!==e.altKey&&(n.popover("destroy"),n.one("click",i))})},50)};n.one("click",i)},App.rgb2hex=function(e){return(e=e.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i))&&4===e.length?"#"+("0"+parseInt(e[1],10).toString(16)).slice(-2)+("0"+parseInt(e[2],10).toString(16)).slice(-2)+("0"+parseInt(e[3],10).toString(16)).slice(-2):""},App.tableTypes={simple:{icon:"fa fa-table",title:"Простая"},version:{icon:"fa fa-calendar",title:"Версионная"},calcs:{icon:"fa fa-calculator",title:"Расчетная в цикле"},globcalcs:{icon:"fa fa-calculator",title:"Расчетная"},tmp:{icon:"fa fa-clock-o",title:"Временная"},cycles:{icon:"fa fa-circle-o",title:"Циклы"}},App.textWithLinks=function(e){return $("<div>").text(e).html().replace(/(https?:\/\/[^\s]+)/g,function(e){return'<a href="'+e+'" target="_blank">'+e+"</a>"})},function(){var e=0;App.getUn=function(){return e++}}();