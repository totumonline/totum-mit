LOGINJS=function(){let e=$('<div><div class="form-group"><label>Email:</label><input id="elseEmail"  type="text"\n                                                                      name="login"\n                                                                      value=""\n                                                                      class="form-control"\n                /></div></div>');if($("body").on("click","#recover",(function(){let t=[{action:function(e){if(""==$("#elseEmail").val().trim())return void $("#elseEmail").addClass("error");let t=$('<form method="post"><input type="hidden" name="login" value=""><input type="hidden" name="recover" value="true"></form>');t.find('[name="login"]').val($("#elseEmail").val()),t.appendTo("body"),t.submit(),e.close()},label:"Отправить пароль на email"},{action:function(e){e.close()},label:"Отмена"}];BootstrapDialog.show({message:e,title:"Новый пароль",buttons:t,draggable:!0})})),$("body").on("click","#register",(function(){let t=[{action:function(e){if(""==$("#elseEmail").val().trim())return void $("#elseEmail").addClass("error");let t=$('<form method="post"><input type="hidden" name="login" value=""><input type="hidden" name="register" value="true"></form>');t.find('[name="login"]').val($("#elseEmail").val()),t.appendTo("body"),t.submit(),e.close()},label:"Зарегистрировать и отправить пароль на email"},{action:function(e){e.close()},label:"Отмена"}];BootstrapDialog.show({message:e,title:"Регистрация",buttons:t,draggable:!0})})),sessionStorage.getItem("browserConfirm")||navigator.userAgent.match(/(chrome|safari|firefox|yandex(?=\/))\/?\s*(\d+)/i)&&!navigator.userAgent.match(/BlackBerry|iPod|Opera Mini|IEMobile/i))$("#auth_form").show();else{let e=$("#auth_form");$("body").html('<div style="width: 600px; margin: auto; padding-top: 50px; font-size: 16px; text-align: center;" id="comeinBlock"><img src="/imgs/start.png" alt=""><div style="padding-bottom: 10px;">Сервис оптимизирован под броузеры Chrome, Safari, Yandex, FireFox последних версий.</div><div><a href="#" id="comein" class="btn-default btn">Все равно хочу посмотреть</a></div></div>'),$("#comein").on("click",(function(){sessionStorage.setItem("browserConfirm",!0),$("#comeinBlock").remove(),$("body").html(e),e.show()}))}},$.fn.datetimepicker.defaults.icons.close="glyphicon glyphicon-ok",$.fn.datetimepicker.defaults.tooltips.close="Применить и закрыть",function(){window.Hlps||(window.Hlps={});var e=window.Hlps;e.selectpicker={},e.selectpicker.open=function(e){var t=$(e).data("selectpicker").$newElement.children()[0];(t=$(t)).attr("aria-expanded")&&"false"!==t.attr("aria-expanded")||t.click()},e.selectpicker.focus=function(e){var t=function(){var i=e.data("this");if(i&&e.is(".selectpicker")){var n=i.$newElement.children()[0];(n=$(n)).focus()}else{var a=0;setTimeout((function(){if(!(++a<4))return!1;t()}),1+100*a)}};t()},e.selectpicker.getButton=function(e){var t=$(e).data("selectpicker").$newElement.children()[0];return t=$(t)}}(),$((function(){if(screen.width>window.MOBILE_MAX_WIDTH){let e=$("#main-page");if(e.length){let t=$(".page_content"),i=!1;const n=function(){e.height(window.innerHeight-100).niceScroll({cursorwidth:7,mousescrollstep:190,mousescroll:190,autohidemode:!1,enablekeyboard:!0,cursoropacitymin:1,railoffset:{left:4},cursorcolor:"#e1e0df"}),i=!0},a=function(){e.height("").getNiceScroll().remove(),i=!1},l=function(){t.is(".tree-minifyed")&&i?a():t.is(".tree-minifyed")||i||n()},o=document.getElementsByClassName("page_content")[0],s={attributes:!0,childList:!1,subtree:!1};new MutationObserver(l).observe(o,s),l()}}})),function(){$((function(){let e=localStorage.getItem("topNavScroll"),t=$(".totbar-default.navbar-default");e>0&&t.scrollLeft(e),t.on("scroll",()=>{localStorage.setItem("topNavScroll",t.scrollLeft())})}));const e=function(e){if(e){let t=e.chdata.rows[Object.keys(e.chdata.rows)[0]];const i=function(e,t){App.getPcTableById("tree").then((function(i){i.model.checkEditRow({id:e}).then((function(e){window.location.href="/Table/"+e.row.top.v+"/"+t}))}))};"calcs"===t.type.v?App.getPcTableById(1).then((function(e){e.model.checkEditRow({id:t.tree_node_id.v}).then((function(e){i(e.row.tree_node_id.v,t.tree_node_id.v)}))})):i(t.tree_node_id.v,t.id)}};addTree=function(t,i,n){let a=$("div.page_content");if(!App.isTopWindow())return a.addClass("tree-minifyed iframed"),!1;window.TREE_DATA=i;let l=screen.width<=window.MOBILE_MAX_WIDTH;l?n=!1:($(window).on("resize",(function(){window.innerWidth<=660&&!a.is(".tree-minifyed")&&u(!0)})),localStorage.getItem("notCreator")&&(n=!1)),$.jstree.defaults.core.dblclick_toggle=!1,$.jstree.defaults.core.expand_selected_onload=!0,$.jstree.defaults.core.force_text=!0;let o,s=localStorage.getItem("tree")||"{}";s=JSON.parse(s),$.each(i,(function(e,a){if(i[e].data={type:a.type},a.state&&a.state.selected&&(i[e].li_attr={class:"jstree-selected"}),s[a.id]&&(i[e].state||(i[e].state={}),i[e].state.opened=!0),a.href?i[e].a_attr={href:(a.href.toString().match(/\/Table\//)?"":t)+a.href}:a.link&&(i[e].a_attr={href:a.link}),n)switch(-1!==["link","anchor","folder"].indexOf(a.type)&&(a.a_attr=a.a_attr||{},a.a_attr={...a.a_attr,class:"edit-folder","data-id":a.id.substr(4)}),a.type){case"folder":i.push({type:"plus",id:"plus-table"+a.id.substring(4),text:"Таблицу",parent:a.id,li_attr:{class:"jstree-creatorView"}}),i.push({type:"plus",id:"plus-folder"+a.id.substring(4),text:"Папку/Ссылку",parent:a.id,li_attr:{class:"jstree-creatorView"}});break;case"cycle_name":i.push({type:"plus",id:"plus-calcs"+a.parent.substring(4),text:"Таблицу",parent:a.id,li_attr:{class:"jstree-creatorView"}});break;case"table_cycles":a.a_attr={...a.a_attr,class:"add_calcs_table","data-id":a.id.substr(5)}}})),n&&(o=t.match(/^.*?(\d+)/))&&(i.push({type:"plus",id:"plus-table"+o[1],text:"Таблицу",parent:"#",li_attr:{class:"jstree-creatorView"}}),i.push({type:"plus",id:"plus-folder"+o[1],text:"Папку/Ссылку",parent:"#",li_attr:{class:"jstree-creatorView"}}));let r=$("#leftTree");n?r.on("init.jstree",(function(t,i){let n=$.jstree.core.prototype.redraw_node;r.jstree(!0).redraw_node=function(t,i,a,l){let o=n.bind(this)(t,i,a,l);if(t.match(/^tree/)){"folder"==r.jstree(!0).get_node(t).data.type&&$(o).addClass("tree-folder")}let s=$(o).find(">a.edit-folder");if(s.length){let t=$('<i class="fa fa-edit edit-folder-icon"></i>');t.on("click",()=>(new EditPanel("tree",BootstrapDialog.TYPE_DANGER,{id:s.data("id")}).then(e),!1)),s.find(">i").after(t)}else{let t=$(o).find(">a.add_calcs_table");if(t.length){let i=$('<i class="fa fa-plus edit-folder-icon"></i>');i.on("click",()=>(new EditPanel(1,BootstrapDialog.TYPE_DANGER,{type:{v:"calcs"},tree_node_id:{v:t.data("id")}},{},{type:!0,tree_node_id:!0}).then(e),!1)),t.find(">i").after(i)}}return o}})):r.on("init.jstree",(function(e,t){let i=$.jstree.core.prototype.redraw_node;r.jstree(!0).redraw_node=function(e,t,n,a){let l=i.bind(this)(e,t,n,a);if(e.match(/^tree/)){"folder"==r.jstree(!0).get_node(e).data.type&&$(l).addClass("tree-folder")}return l}}));let d=$("#LeftTree"),c=()=>"tree_scroll_part_"+(window.top_branch||(window.location.pathname.match(/\/Table\/(\d+)/)||{1:0})[1]);const p=function(){r.jstree({state:{key:"leftTree"},core:{check_callback:!0,expand_selected_onload:!0,open_parents:!0,data:i,themes:{name:"default"}},types:{folder:{},plus:{icon:"fa fa-plus"},cycle_name:{icon:"fa fa-dot-circle-o"},text:{icon:"jstree-file"},table:{icon:"jstree-file"},table_simple:App.tableTypes.simple,table_version:App.tableTypes.version,table_calcs:App.tableTypes.calcs,table_tmp:App.tableTypes.tmp,table_globcalcs:App.tableTypes.globcalcs,table_cycles:App.tableTypes.cycles,table_data:{icon:"jstree-file"}},plugins:["types","themes"]}),f()};r.on("loaded.jstree after_open.jstree",(function(e){let t=r.width();if(r.find("a.jstree-anchor").each((function(){let e=$(this),i=e.offset().left;e.width(t-i)})),"loaded"===e.type){let e=localStorage.getItem(c());e&&d.scrollTop(e),f()}})),r.on("select_node.jstree",(function(i,n){switch(localStorage.setItem(c(),d.scrollTop()),(n.node.data?n.node.data.type:null)||n.node.type){case"plus":let i=n.node.id.substring(5,10);if("calcs"===i){let e=n.node.id.substring(11);n.node.parent.substring(5);new EditPanel(1,BootstrapDialog.TYPE_DANGER,{tree_node_id:{v:e},type:{v:"calcs"}}).then((function(e){e&&window.location.reload(!0)}))}else if("table"===i){let t=n.node.id.length>10?n.node.id.substring(10):window.location.pathname.match(/^\/.*\/(\d+)\//)[1];new EditPanel(1,BootstrapDialog.TYPE_DANGER,{tree_node_id:{v:t}}).then(e)}else{let e=n.node.id.length>11?n.node.id.substring(11):window.location.pathname.match(/^\/.*\/(\d+)\//)[1];new EditPanel("tree",BootstrapDialog.TYPE_DANGER,{parent_id:{v:e}}).then((function(e){e&&window.location.reload(!0)}))}return!1;case"link":window.location.href=n.node.a_attr.href;break;case"folder":case"project":return n.node.state.opened?($("#leftTree").jstree("close_node",n.node),s[n.node.id]&&(delete s[n.node.id],localStorage.setItem("tree",JSON.stringify(s)))):($("#leftTree").jstree("open_node",n.node),s[n.node.id]=!0,localStorage.setItem("tree",JSON.stringify(s))),!1;default:window.location.pathname.match(/^\/Table\//)?window.location.href=n.node.original.link?n.node.original.link:t+n.node.original.href:window.location.href=n.node.original.href}return!1}));const f=function(){setTimeout((function(){d.getNiceScroll().resize()}),250)};r.on("open_node.jstree",(function(e,t){s[t.node.id]=!0,localStorage.setItem("tree",JSON.stringify(s)),f()})),r.on("close_node.jstree",(function(e,t){s[t.node.id]&&(delete s[t.node.id],localStorage.setItem("tree",JSON.stringify(s))),f()}));let h=localStorage.getItem("TreeMinimizer")||"false";h=JSON.parse(h);let u=function(e){h=e;const t=$("#page-tree");e?($("body>.page_content").addClass("tree-minifyed"),$("#LeftTree").getNiceScroll().resize(),t.length&&(t.append(r),r.trigger("after_open"))):($("body>.page_content").removeClass("tree-minifyed"),t.length&&($(".TreeContainer").append(r),r.trigger("after_open"))),$("#table").data("pctable")&&$("#table").data("pctable").setWidthes(),p(),localStorage.setItem("TreeMinimizer",JSON.stringify(h)),f()};l||d.niceScroll({cursorwidth:7,mousescrollstep:190,mousescroll:190,autohidemode:!1,enablekeyboard:!1,cursoropacitymin:1,railoffset:{left:4},cursorcolor:"#e1e0df"}),$("#TreeMaximizer").on("click",(function(){if(l||window.innerWidth<=660){let e=$("<div>");e.append($("#branch-title")),e.append($("#leftTree")),App.mobilePanel('<a class="totum-brand" href="/"><span>'+$(".totum-brand span:first").text()+"</span></a>",e,{onhide:function(){const e=$("#page-tree");1===e.length?(r.appendTo(e),p()):(r.appendTo(".TreeContainer"),p())},cssClass:"mobile-panel mobile-menu"}),r.trigger("after_open")}else u(!1)})),$("#TreeMinimizer").on("click",(function(){u(!0)})),!0===h?setTimeout((function(){u(h)}),1):l?setTimeout((function(){1===$("#page-tree").length&&r.appendTo($("#page-tree")),p()}),10):p()}}(),restModel=function(e){return{url:e,create:function(){return $.ajax({url:this.url,method:"post",data:data})},get:function(e){return $.ajax({url:this.url,method:"get",data:{id:e}})},save:function(e,t){return $.ajax({url:this.url,method:"PUT",data:$.extend(t,{id:e})})}}},$((function(){if(App.notifications=function(e){let t=App.models.table("/Table/");t.addPcTable({model:t}),e.data("withClick")||(e.data("withClick",!0),e.on("click",(function(e){t.getNotificationsTable()})));let i={},n={},a=e.data("periodicity")||0;const l=function(){switch(document.visibilityState){case"hidden":i.jqXHR&&i.jqXHR.abort&&i.jqXHR.abort(),i={};break;case"visible":t.checkForNotifications(a,Object.keys(n),i).then((function(e){e.notifications&&e.notifications.length&&(n[e.notification_id]=App.showDatas.call(t,e.notifications,e.notification_id),n[e.notification_id].forEach((function(t){t&&t.$modal&&t.$modal.length&&t.$modal.on("hide.bs.modal",(function(){delete n[e.notification_id]}))}))),e.deactivated&&e.deactivated.forEach&&e.deactivated.forEach((function(e){n[e]&&(n[e].forEach((function(e){e.simpleClose()})),delete n[e])})),App.checkNotificationManager(n),a>0&&l()})).fail((function(e){e&&e.error&&document.removeEventListener("visibilitychange",l)}))}};return a>0&&(document.addEventListener("visibilitychange",l),l()),l},App.isTopWindow()){let e=$("#bell-notifications");e.length&&App.notifications(e)}})),$((function(){let e=$("#docs-link");const t=function(){let i=$(this).data("type"),n=$('<div class="tech-table" id="DocsPopover" data-type="'+i+'" style="min-height: 250px"></div>');$.post("https://docs.totum.online/index_"+i+".json",(function(e){e&&e.length&&e.forEach((function(e){n.append('<div style="'+(e[2]||"")+'"><i class="fa fa-external-link"></i> <a href="http://docs.totum.online'+e[1]+'" target="totum-docs">'+e[0]+"</a></div>")}))})),e.popover({html:!0,content:n,trigger:"manual",container:"body",placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),setTimeout((function(){e.popover("show"),$("#"+e.attr("aria-describedby")).css("top","45px"),$("body").one("click.DocsPopover",(function(i){void 0!==i.altKey&&(e.popover("destroy"),e.one("click",t))}))}),50)};e.one("click",t)})),function(e,t){const i=e.MOBILE_MAX_WIDTH=1199,n={type:{isOn:!0,Val:"string"},width:{isOn:!0,Val:100},default:{isOn:!1,Val:""},regexp:{isOn:!1,Val:""},regexpErrorText:{isOn:!1,Val:""},required:{isOn:!0,Val:!1},showInWeb:{isOn:!0,Val:!0},insertable:{isOn:!0,Val:!0},dropdownView:{isOn:!0,Val:!0},addRoles:{isOn:!1,Val:["1"]},editable:{isOn:!0,Val:!0},editRoles:{isOn:!1,Val:["1"]},hidden:{isOn:!0,Val:!1},warningEditPanel:{isOn:!0,Val:!1},warningEditText:{isOn:!1,Val:"Точно изменить?"},warningEditRegExp:{isOn:!1,Val:"/^someValue$/"},url:{isOn:!0,Val:!1},openIn:{isOn:!1,Val:"iframe"},tableBreakBefore:{isOn:!0,Val:!1},sectionTitle:{isOn:!1,Val:""},panelColor:{isOn:!1,Val:""},webRoles:{isOn:!1,Val:["1"]},logRoles:{isOn:!1,Val:["1"]},showInWebOtherPlace:{isOn:!0,Val:!1},showInWebOtherPlacement:{isOn:!1,Val:"param"},showInWebOtherOrd:{isOn:!1,Val:null},showInXml:{isOn:!0,Val:!1},apiEditable:{isOn:!1,Val:!1},xmlEditRoles:{isOn:!1,Val:["1"]},xmlRoles:{isOn:!1,Val:["1"]},logging:{isOn:!0,Val:!0},code:{isOn:!1,Val:"= : "},codeOnlyInAdd:{isOn:!1,Val:!1},errorText:{isOn:!1,Val:""},codeAction:{isOn:!1,Val:"= :"},CodeActionOnAdd:{isOn:!1,Val:!1},CodeActionOnChange:{isOn:!1,Val:!1},format:{isOn:!1,Val:"f1=:"},help:{isOn:!1,Val:""}},a="#ee0c1f",l="#3fbf46",o="pcTableInsertRowPanel";var s=0;CodeMirror.defineMode("sections",(function(){return{startState:function(){return{}},token:function(e,t){if(0===e.lineOracle.line)return e.skipToEnd(),t.isStart=!1,"sec-title";if(0===e.pos)return e.skipTo(":"),e.next(),t.isParamsPart=!0,"sec-param";{let i=e.string.substring(e.pos);if(t.isParamsPart&&i.match(":")){let n="sec-parts",a=":";return-1!==i.indexOf(",")?a=",":t.isParamsPart=!1,/^\s*\d+\s*$/.test(i.substring(0,i.indexOf(a)))&&(n="sec-num-parts"),e.skipTo(a),e.next(),n}return/^\s*(true|false)\s*$/.test(i)?(e.skipToEnd(),"boolean"):(e.skipToEnd(),"sec-value")}}}})),CodeMirror.sectionsAutoCloses=function(e){e.on("keyup",(function(e,t){e.options.bigOneDialog&&t.ctrlKey&&"83"===(t.keyCode||t.which).toString()?(t.stopPropagation(),e.options.bigOneDialog.close()):t.ctrlKey&&"191"===(t.keyCode||t.which).toString()&&CodeMirror.commentMe(e),"27"===(t.keyCode||t.which).toString()?(e.state.completionActive&&e.state.completionActive.close(),t.stopPropagation()):{9:"tab",13:"enter",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",38:"up",40:"down",57:"("}[(t.keyCode||t.which).toString()]||CodeMirror.showHint(e,CodeMirror.hint.totumVars,{})}))},function(){let i=App.functions||[],n=[];i.forEach((function(e){e.d||n.push(e.name)}));let a={};i.forEach((function(e){a[e.name.toLowerCase()]=[e.t,0,e.p,e.n,e.m]}));let l=["where","order","field","sfield","bfield","tfield","preview","parent","section","table","filter","fieldtitle","fieldhide"];CodeMirror.defaults.scrollbarStyle="overlay",CodeMirror.defineInitHook((function(i){try{if(!i.options.bigOneDialog&&screen.width>e.MOBILE_MAX_WIDTH){let n,a=t('<i class="fa fa-expand codemirror-expander" style="position: absolute;\n    right: 10px;\n    bottom: 10px;\n    z-index: 10000;\n    font-family: FontAwesome; cursor: pointer"></i>');t(i.display.wrapper).append(a),a.on("click",(function(){n=t('<div class="HTMLEditor" id="bigOneCodemirror" style="height: 100%;"></div>');let a,l=i.getValue();e.top.BootstrapDialog.show({message:n,type:null,title:"Правка текстового поля",cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){i.setValue(a.getValue())},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"}),e.$modalHeader.find("button.close").css("font-size","16px").html('<i class="fa fa-compress"></i>')},onshown:function(t){a=CodeMirror(n.get(0),{mode:i.options.mode,value:l,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:t}),i.table&&(a.table=i.table);let o=Math.round(t.$modalContent.height()-t.$modalHeader.outerHeight()-40);a.getScrollerElement().style.minHeight=o+"px",n.find(".CodeMirror").css("min-heught",o),a.focus(),t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top})}})}))}}catch(e){i.setValue(e.message)}}));function o(e){if(e.getOption("disableInput")||"totum"!==e.getOption("mode"))return CodeMirror.Pass;var t=e.listSelections(),i=[];let n=!1;for(let r=0;r<t.length;r++){if(!t[r].empty())return CodeMirror.Pass;var l=t[r].head,o=e.getTokenAt(l,!0);if(o.state&&o.state.inFuncName||"function"==o.type||"error"==o.type){let d,c=o.string.toLowerCase(),p="";if(-1!==c.indexOf("/")?(d=c.substring(0,c.indexOf("/")),p=c.substring(c.indexOf("/"))):d=c.trimRight(),d=a[d]){let e="",t=0;if(p.length){e="(";let i=1,a=!0;p.split("/").forEach((function(t){if(0===t.length);else{a||(e+="; "),a=!1;let n=-1!==t.indexOf(":")&&""!==t.slice(t.indexOf(":")+1).trim();e+=t+(-1===t.indexOf(":")?": ":""),1!==i||n||(i=e.length)}})),1===i?i=e.length:n=!0,t+=i,e+=")"}else if(e=d[0],/:/.test(e)){let i=e.indexOf(":"),a=e.substring(i),l=a.substring(0,a.indexOf(";")||a.indexOf(")"));t+=i,-1!==l.indexOf("'")?t+=l.indexOf("'")+1:t+=2,n=!0}else t+=e.length;i[r]={text:e,newPos:CodeMirror.Pos(l.line,l.ch-p.length+t),replace:CodeMirror.Pos(l.line,l.ch-p.length)}}else i[r]={text:"()",newPos:CodeMirror.Pos(l.line,l.ch+1),replace:CodeMirror.Pos(l.line,l.ch)};let f=i[r];if(f){e.replaceRange(f.text,f.replace,t[r].anchor,"+insert");var s=e.listSelections().slice(0);s[r]={head:f.newPos,anchor:f.newPos},e.setSelections(s),n&&CodeMirror.showHint(e,CodeMirror.hint.totumVars,{})}}else e.replaceRange("()",CodeMirror.Pos(l.line,l.ch),t[r].anchor),e.setSelections([{head:CodeMirror.Pos(l.line,l.ch+1),anchor:CodeMirror.Pos(l.line,l.ch+1)}])}}CodeMirror.defineMode("totum",(function(){return{startState:function(){return{inString:!1,isStart:!0,inFunction:!1,lineName:""}},token:function(e,i){function n(){return e.string.substring(e.start,e.pos)}function o(){"use strict";return e.skipToEnd(),"error"}i.lineNames=[];try{e.lineOracle.doc.cm.getValue().split("\n").forEach((function(e){return 0===e.trim().length||0===e.indexOf("//")?"":e.match(/\s*[a-zA-Z_0-9=]+\s*:/)?i.lineNames.push(e.replace(/^\s*~?\s*([a-zA-Z_0-9=]+)\s*:.*/,"$1")):""}))}catch(e){}if(0===e.pos||!0===i.isStart){if(e.string.match("^[\ts]*//"))return e.skipToEnd(),i.isStart=!1,"comment";let a="start";if(i.isStart=!0,/[\t\n]/.test(e.peek())&&e.next()){for(;/[\t\n]/.test(e.peek())&&e.next(););return"start-tabs"}if(!e.skipTo(":"))return o();if(i.lineName=n().trim(),"~"===i.lineName.substring(0,1)&&(a+=" fixed",i.lineName=i.lineName.substring(1)),/^=|[a-z]{1,2}\d+=$/i.test(i.lineName))a+=" exec";else if(!/^[a-z0-9_]+$/i.test(i.lineName))return o();return e.next(),t(e.lineOracle.doc.cm.getWrapperElement()).find(".cm-var-not-in").each((function(){let e=t(this).text();e=e.replace(/\[.*/,""),e!=="$"+i.lineName&&e!=="#$"+i.lineName&&e!=="$$"+i.lineName||t(this).removeClass("cm-var-not-in")})),i.lineNames.filter((function(e){return e===i.lineName})).length>1&&(a+=" dubbled"),i.isStart=!1,a}if(i.isStart=!1,e.match(/(math|json)`[^`]*`/))return"spec";switch(e.peek()){case" ":return e.next(),null;case"{":return e.next(),e.skipTo("}")?(e.next(),"inVars"):o();case'"':let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string"):o();case"#":e.next();let n="db_name";for(;/[a-z0-9_А-Яа-я\-\[\]\$\#".]/.test(e.peek())&&e.next(););let a=e.string.substring(e.start+1,e.pos);return/[^0-9a-z._]/.test(a.replace(/\[.*/g,"").slice(1))&&(n+=" tmp-error"),""===a?o():("$"===a[0]&&(a=a.replace(/\[.*/g,"").slice(1).trim(),-1===i.lineNames.indexOf(a)&&(n+=" var-not-in")),n);case"@":e.next();let l,s=e.peek();for(;/[a-z0-9_.\[\$\#"A-Z\]]/.test(l=e.peek())&&e.next();)s+=l;return/^[a-z0-9_]{3,}\.[a-z0-9_]{2,}(\[[a-zA-Z0-9_\$\#"]+\])*$/i.test(s)?"db_name":o();case"$":if(e.next(),"#"===e.peek()){for(e.next();/[a-z0-9_\-\[\]\$\#"]/i.test(e.peek())&&e.next(););return"code-var"}{for(;/[a-zA-Z0-9_\[\]\$\#"]/i.test(e.peek())&&e.next(););let t=e.string.substring(e.start,e.pos);t=t.replace(/\[.*/g,"");let n="variable",a=t.substring(1);return"$"===a[0]&&(n+=" dollar-dollar",a=a.substring(1)),-1===i.lineNames.indexOf(a)&&(n+=" var-not-in"),n}case"t":if("true"===e.string.substring(e.start,e.start+4))return e.skipTo("e"),e.next(),"boolean";break;case"f":if("false"===e.string.substring(e.start,e.start+5))return e.skipTo("e"),e.next(),"boolean"}if(i.inFuncName=!1,!i.inFunction&&/[a-zA-Z]/.test(e.peek())){if(i.inFuncName=!0,e.skipTo("(")?i.inFunction=!0:e.skipToEnd(),!/^[a-zA-Z]+[0-9]*\s*$/.test(n()))return o();let t=a[n().trim().toLowerCase()];return t?(i.func=t,e.next(),"function"):o()}if(i.inFunction){if(")"===e.peek())return e.next(),i.inFunction=!1,i.functionParam="","function";if(!i.functionParam&&/[a-z_]/.test(e.peek())){if(e.skipTo(":")){let t=e.string.substring(e.start,e.pos);if(/^[a-z_]+\s*$/.test(t)){if(i.functionParam=t,e.next(),-1===i.func[2].indexOf(t))return o();let n="functionParam";return-1!==l.indexOf(t)&&(n+=" fieldParam"),-1!==i.func[3].indexOf(t)&&(n+=" reqParam"),i.func[4]&&-1!==i.func[4].indexOf(t)&&(n+=" multiParam"),n}return o()}return e.skipTo(")")?"error fieldParam":o()}if(!i.functionParam)return o();if(";"===e.peek())return e.next(),i.functionParam="","";if("order"===i.functionParam&&/[ad]/.test(e.peek())){if("asc"===e.string.substring(e.start,e.start+3))return e.next(),e.next(),e.next(),"";if("desc"===e.string.substring(e.start,e.start+4))return e.next(),e.next(),e.next(),e.next(),""}if("'"===e.peek()){let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string-name"):o()}}if("'"===e.peek()){let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string"):o()}if(/\d|%/.test(e.peek())){for(e.next();/[0-9.%]/.test(e.peek())&&e.next(););return/^\d+(\.\d+)?%?$/.test(e.string.substring(e.start,e.pos))?"number":o()}return/[\^+-\/*!<>=]/.test(e.peek())?(e.next(),"operator"):o()}}})),CodeMirror.registerHelper("hint","totumVars",(function(e,i){return function(e,i,o,r){var d=e.getCursor(),f=o(e,d);if("error"!==f.type&&"string-name"!==f.type&&/\b(?:string|comment)\b/.test(f.type))return;var u=CodeMirror.innerMode(e.getMode(),f.state);if("json"===u.mode.helperType)return;f.state=u.state,f.inString=f.string,f.state.isDb_name=!1,f.state.showAll=!0,r.inStart=!0;let m,b=function(e,t,i){null!=i&&(e.replaceRange(i.text||i,t.from,t.to),i.curPos&&e.setCursor({line:t.from.line,ch:i.curPos}),i.showHint&&CodeMirror.showHint(e,CodeMirror.hint.totumVars,{}))},g={text:"math``",textVis:"math``",title:"",render:p,type:"",curPos:f.start+5,hint:b,tab:!0},v={text:"json``",textVis:"json``",title:"",render:p,type:"",curPos:f.start+5,hint:b,tab:!0};if(i=i.slice(),f.state.isStart||0===d.ch){i=[],f.string=f.string.replace(/^[\t]+/,"");let n="";/^~/.test(f.string)&&(f.string.replace(/^~/,""),n="~"),t(e.getWrapperElement()).find(".cm-var-not-in").each((function(){let e=t(this).text().replace(/^(\#|\$)?\$/,"").replace(/\[.*/,"");i.push({text:n+e+": ",displayText:e})}))}else if(/^'.*?'?$/.test(f.string)&&-1!==l.indexOf(f.state.functionParam))if(f.state.showAll=!0,"''"===f.string?(f.end=f.end,f.start+=1,f.string=""):/'[a-z_0-9]+'/.test(f.string)?(f.start+=1,f.string=f.string.slice(1,d.ch-f.start)):(f.string=f.string.slice(1,d.ch-f.start),f.start+=1,f.end=d.ch,"'"===e.getLine(d.line)[d.ch]&&f.end++),"table"===f.state.functionParam){let e=c();i=[],Object.keys(e).forEach((function(t){i.push({text:t+"'",textVis:t,title:e[t].t,render:p,type:"item-string-name",hint:b,tab:!0})}))}else{let t,n=e.getLine(d.line),a=n.substring(0,d.ch),l=n.substring(d.ch),o=l.substring(0,l.indexOf(")"));if(a=a.substring(a.lastIndexOf("("))+o,t=a.match(/table:\s*((\$#ntn)|'([a-z_0-9]*)')/)){let n=t[2]?e.table:t[3];i=[],Object.keys(s[n].f).forEach((function(e){i.push({text:e+"'",textVis:e,title:s[n].f[e],render:p,type:"item-string-name",curPos:d.ch+e.length+1,tab:!0})})),i.push({text:"id'",textVis:"id",title:"",render:p,type:"item-string-name",curPos:d.ch+3,tab:!0})}}else if(f.end>d.ch&&(f.end=d.ch,f.string=f.string.slice(0,d.ch-f.start)),0===f.string.indexOf("@")){r.inStart=!1,i=[];let e,t=c();if(f.string=f.string.slice(1,d.ch-f.start),f.start=f.start+1,f.end=d.ch,e=f.string.match(/^([a-z_0-9]+)\./)){let n=e[1];f.start+=(n+".").length,f.string=f.string.slice((n+".").length),t[n]&&t[n]["@"].length&&t[n]["@"].forEach((function(e){i.push({text:e,title:t[n].f[e],render:p,type:"item-db_name"})}))}else Object.keys(t).forEach((function(e){t[e]["@"].length&&i.push({text:e+".",textVis:e,title:t[e].t,render:p,type:"item-db_name",showHint:!0,hint:b})}))}else if("$#"===f.string.slice(0,2)){i=[{text:"$#lc",title:"Пустой лист",render:p,type:"item-code-var"},{text:"$#nd",title:"дата - Y-m-d",render:p,type:"item-code-var"},{text:"$#ndt",title:"дата-время - Y-m-d H:i",render:p,type:"item-code-var"},{text:"$#ndts",title:"дата-время с секундами - Y-m-d H:i:s",render:p,type:"item-code-var"},{text:"$#nu",title:"id пользователя",render:p,type:"item-code-var"},{text:"$#nr",title:"ids ролей пользователя",render:p,type:"item-code-var"},{text:"$#nti",title:"id таблицы",render:p,type:"item-code-var"},{text:"$#ntn",title:"NAME таблицы",render:p,type:"item-code-var"},{text:"$#nth",title:"HASH врем. таблицы",render:p,type:"item-code-var"},{text:"$#nci",title:"Cycle расчетной таблицы",render:p,type:"item-code-var"},{text:"$#nf",title:"NAME поля",render:p,type:"item-code-var"},{text:"$#nl",title:"Новая строка",render:p,type:"item-code-var"},{text:"$#tb",title:"Табуляция",render:p,type:"item-code-var"},{text:"$#tpa",title:"Тип экшена код действия",render:p,type:"item-code-var"},{text:"$#ids",title:"id отмеченных галочками полей",render:p,type:"item-code-var"},{text:"$#nfv",title:"Значение текущего поля (для селектов/действий/форматов)",render:p,type:"item-code-var"},{text:"$#onfv",title:"Прошлое значение текущего поля",render:p,type:"item-code-var"},{text:"$#nh",title:"Текущий хост-name",render:p,type:"item-code-var"}];const e=function(e){let t=i.slice(),n=[];return t=t.filter((function(t){if(-1===e.indexOf(t.text))return!0;n.push(t)})),n.concat(t)};switch(f.state.functionParam){case"table":i=e(["$#ntn"]);break;case"cycle":i=e(["$#nci"]);break;case"field":i=e(["$#nf","$#nfv"])}}else if(m=f.string.match(/^(#?\$)/))i=[],f.string=f.string.slice(m[1].length,d.ch-f.start),f.start=f.start+m[1].length,f.end=d.ch,f.state.lineNames.forEach((function(e){-1===e.indexOf("=")&&i.push(e)}));else if(m=f.string.match(/^\#/))i=[],f.string=f.string.slice(1,d.ch-f.start),f.start=f.start+1,f.end=d.ch,(m=f.string.match(/^([a-z]{1,3}\.)/))&&(f.string=f.string.slice(m[1].length),f.start+=m[1].length),e.table&&s[e.table]&&(Object.keys(s[e.table].f).forEach((function(t){i.push({text:t,title:s[e.table].f[t],render:p,type:"item-db-name"})})),i.push({text:"id",title:"",render:p,type:"item-db-name"}));else if(f.state.inFuncName){if(!f.state.inFunction)if(m=f.string.match(/^([a-zA-Z]+)\//)){let e;if(f.state.showAll=!0,e=a[m[1].toLowerCase()]){let t=f.start;f.start=f.start+f.string.lastIndexOf("/")+1,f.string=f.string.slice(f.string.lastIndexOf("/")+1,d.ch-t),f.end=d.ch,i=[],e[2].forEach((function(t){let n="";-1!==e[3].indexOf(t)&&(n+=" item-reqParam"),-1!==e[4].indexOf(t)&&(n+=" item-multiParam"),-1!==l.indexOf(t)&&(n+=" item-fieldParam"),i.push({text:t+": ",textVis:t,title:"",render:p,type:n})}))}}else(i=n.slice()).push("true"),i.push("false"),i.push(g),i.push(v)}else f.state.func&&("error fieldParam"===f.type||/(\(|;\s*)$/.test(e.getLine(d.line).slice(0,f.start)))?(i=[],f.state.func[2].forEach((function(t){let n="",a="";")"!==e.getLine(d.line).slice(d.ch).trim()&&(a="; "),-1!==f.state.func[3].indexOf(t)&&(n+=" item-reqParam"),-1!==f.state.func[4].indexOf(t)&&(n+=" item-multiParam"),-1!==l.indexOf(t)&&(n+=" item-fieldParam"),i.push({text:t+": "+a,textVis:t,title:"",render:p,type:n,hint:b,curPos:f.start+(t+": "+a).length-a.length})}))):(i=["true","false"],"order"===f.state.functionParam&&(i=i.concat(["asc","desc"])));return{list:h(f,i,r),from:CodeMirror.Pos(d.line,f.start),to:CodeMirror.Pos(d.line,f.end)}}(e,f,(function(e,t){return e.getTokenAt(t)}),i)}));let s=[],r=!1,d=null;const c=function(){if((!d||d<Math.floor(Date.now()/1e3)-40)&&(d=Math.floor(Date.now()/1e3),s=[]),0===s.length&&!r){r=!0;let e=t("#table").data("pctable");e&&e.isCreatorView&&e.model.getAllTables().then((function(e){s=e.tables,r=!1}))}return s},p=function(e,i,n){t(e).append('<span class="'+n.type+'">'+(n.textVis||n.text)+(""===n.title?"":' <span class="descr">'+n.title+"</span>")+"</span>")};let f=[];function h(e,t,i){var n=[],a=[],l=e.string.toLowerCase();i&&i.globalScope;if(!e.state.showAll&&""===l)return found;return t.forEach((function(e){let t,o="";if("string"==typeof e?t=e.toLowerCase():(t=e.text.toLowerCase(),e.title&&(o=e.title.toLowerCase())),!u(n,t)&&!u(a,t)){0===t.lastIndexOf(l,0)||0===o.lastIndexOf(l,0)?n.push(e):-1!==o.indexOf(l,0)?a.push(e):i.inStart||-1===t.indexOf(l)||a.push(e)}})),1===n.length&&n[0]===l||1===n.length&&n[0].text===l||1===a.length&&a[0]===l||1===a.length&&a[0].text===l?[]:n.concat(a)}function u(e,t){return-1!==e.indexOf(t)}CodeMirror.defineOption("autoCloseFunctions",!1,(function(e){"totum"===e.getOption("mode")&&function(e){c();var i={name:"autoCloseFunctions"};i["'('"]=o,i["')'"]=o,e.addKeyMap(i),e.on("keydown",(function(e,t){"9"===(t.keyCode||t.which).toString()&&function(e,t,i){var n=e.getCursor();if(e.getTokenAt(n).state.inFunction){let a,l,o=e.getLine(n.line);if(i){for(a=n.ch,";"===o[a]&&a--;o[a]&&-1===[";","("].indexOf(o[a]);)a--;for(l=a;o[a]&&-1===[":","("].indexOf(o[a]);)a--;":"===o[a]&&(a++," "===o[a]&&a++),l=n.ch}else{for(a=n.ch;o[a]&&-1===[":",")"].indexOf(o[a]);)a++;for(":"===o[a]&&(a++," "===o[a]&&a++)," "===o[a]&&a++,l=a;o[l]&&-1===[";",")"].indexOf(o[l]);)l++;t&&(a=n.ch)}return e.setSelection({line:n.line,ch:a},{line:n.line,ch:l}),!0}}(e,t.altKey,t.shiftKey)&&t.preventDefault()})),e.on("keyup",(function(e,t){e.options.bigOneDialog&&t.ctrlKey&&"83"===(t.keyCode||t.which).toString()?(t.stopPropagation(),e.options.bigOneDialog.close()):t.ctrlKey&&"191"===(t.keyCode||t.which).toString()&&CodeMirror.commentMe(e),"27"===(t.keyCode||t.which).toString()?(e.state.completionActive&&e.state.completionActive.close(),t.stopPropagation()):{9:"tab",13:"enter",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",38:"up",40:"down",57:"("}[(t.keyCode||t.which).toString()]||CodeMirror.showHint(e,CodeMirror.hint.totumVars,{})})),e.on("dblclick",(function(i){var n=e.getCursor(),a=e.getTokenAt(n).state;let l,o=t(e.getWrapperElement()),s=e.getLine(n.line),r=s.substring(0,n.ch);if(/^\s*~?\s*?[a-zA-Z0-9_]+$/.test(r))l=a.lineName;else{let e=n.ch-1;if(/[a-zA-Z0-9_]/.test(s[e])){for(;--e&&e>=0&&/[a-zA-Z0-9_]/.test(s[e]););if("$"===s[e]){let t=e+1;for(e=n.ch-1;++e&&s.length>e&&/[a-zA-Z0-9_]/.test(s[e]););l=s.substring(t,e)}}}if(l){if(new RegExp("^s*~?s*"+l+"s*:").test(o.find(".cm-start.light").text()))o.find(".light").removeClass("light");else{o.find(".light").removeClass("light");let e=new RegExp("\\$"+l+"\\b");o.find(".cm-variable,.cm-inVars,.cm-spec").each((function(){let i=t(this);i.text().match(e)&&i.addClass("light")})),o.find(".cm-start").each((function(){let e=t(this);e.text().trim().replace("~","").replace(":","")===l&&e.addClass("light")}))}}}))}(e),"sections"===e.getOption("mode")&&CodeMirror.sectionsAutoCloses(e)})),function(){"use strict";function t(e,t,i){this.cm=e,this.getHints=t,this.options=i,this.widget=this.onClose=null}function i(e){return"string"==typeof e?e:e.text}function n(t,n){this.completion=t,this.data=n;var a=this,l=t.cm,o=t.options,s=this.hints=e.top.document.createElement("ul");s.className="CodeMirror-hints",this.selectedHint=0;for(var r=n.list,d=0;d<r.length;++d){var c=s.appendChild(e.top.document.createElement("li")),p=r[d],f="CodeMirror-hint"+(d?"":" CodeMirror-hint-active");null!=p.className&&(f=p.className+" "+f),c.className=f,p.render?p.render(c,n,p):c.appendChild(e.top.document.createTextNode(p.displayText||i(p))),c.hintId=d}var h=l.cursorCoords(!1!==o.alignWithWord?n.from:null),u=h.left,m=h.bottom+3,b=!0;s.style.left=u+"px",s.style.top=m+"px";var g,v=e.innerWidth||Math.max(e.top.document.body.offsetWidth,e.top.document.documentElement.offsetWidth),w=e.innerHeight||Math.max(e.top.document.body.offsetHeight,e.top.document.documentElement.offsetHeight),_=s.getBoundingClientRect(),y=_.right-v,x=_.bottom-w;if(y>0&&(_.right-_.left>v&&(s.style.width=v-5+"px",y-=_.right-_.left-v),s.style.left=(u=h.left-y)+"px"),x>0){var k=_.bottom-_.top;_.top-(h.bottom-h.top)-k>0?(x=k+(h.bottom-h.top),b=!1):k>w&&(s.style.height=w-5+"px",x-=k-w),s.style.top=(m=h.bottom-x)+"px"}((o.container||e.top.document.body).appendChild(s),l.addKeyMap(this.keyMap=function(e,t){var i={Up:function(){t.moveFocus(-1)},Down:function(){t.moveFocus(1)},PageUp:function(){t.moveFocus(-t.menuSize())},PageDown:function(){t.moveFocus(t.menuSize())},Home:function(){t.setFocus(0)},End:function(){t.setFocus(t.length)},Enter:t.pick,Esc:t.close},n=e.customKeys?{}:i;function a(e,a){var l;l="string"!=typeof a?function(e){return a(e,t)}:i.hasOwnProperty(a)?i[a]:a,n[e]=l}if(e.customKeys)for(var l in e.customKeys)e.customKeys.hasOwnProperty(l)&&a(l,e.customKeys[l]);if(e.extraKeys)for(var l in e.extraKeys)e.extraKeys.hasOwnProperty(l)&&a(l,e.extraKeys[l]);return n}(o,{moveFocus:function(e){a.changeActive(a.selectedHint+e)},setFocus:function(e){a.changeActive(e)},menuSize:function(){return a.screenAmount()},length:r.length,close:function(){t.close()},pick:function(){a.pick()}})),!1!==o.closeOnUnfocus)&&(l.on("blur",this.onBlur=function(){g=setTimeout((function(){t.close()}),100)}),l.on("focus",this.onFocus=function(){clearTimeout(g)}));var C=l.getScrollInfo();return l.on("scroll",this.onScroll=function(){var i=l.getScrollInfo(),n=l.getWrapperElement().getBoundingClientRect(),a=m+C.top-i.top,o=a-(e.pageYOffset||(e.top.document.documentElement||e.top.document.body).scrollTop);if(b||(o+=s.offsetHeight),o<=n.top||o>=n.bottom)return t.close();s.style.top=a+"px",s.style.left=u+C.left-i.left+"px"}),CodeMirror.on(s,"click",(function(e){for(var t=e.target||e.srcElement;"SPAN"===t.nodeName;)t=t.parentNode;null!=t.hintId&&(a.changeActive(t.hintId),a.pick())})),CodeMirror.on(s,"mousedown",(function(){setTimeout((function(){l.focus()}),20)})),CodeMirror.signal(n,"select",r[0],s.firstChild),!0}CodeMirror.showHint=function(e,i,n){if(!e.somethingSelected()&&(null==i&&(i=e.getHelper(e.getCursor(),"hint")),null!=i)){e.state.completionActive&&e.state.completionActive.close();var a=e.state.completionActive=new t(e,i,n||{});if(CodeMirror.signal(e,"startCompletion",e),!a.options.async)return a.showHints(i(e,a.options));i(e,(function(e){a.showHints(e)}),a.options)}},CodeMirror.commentMe=function(e){var t=e.getCursor(),i=(e.getTokenAt(t).state,e.lineInfo(t.line));let n;(n=i.text.match(/^([\t\s]*)\/\//))?e.replaceRange("",{line:t.line,ch:n[1].length},{line:t.line,ch:n[0].length}):(n=i.text.match(/^[\t\s]*/),e.replaceRange("//",{line:t.line,ch:n[0].length},{line:t.line,ch:n[0].length}))},t.prototype={close:function(){this.active()&&(this.widget&&this.widget.close(),this.onClose&&this.onClose(),this.cm.state.completionActive=null,CodeMirror.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(e,t){var n=e.list[t];n.hint?n.hint(this.cm,e,n):this.cm.replaceRange(i(n),e.from,e.to),this.close();this.cm},showHints:function(e){if(!e||!e.list.length||!this.active())return this.close();this.showWidget(e)},showWidget:function(e){this.widget=new n(this,e),CodeMirror.signal(e,"shown");var t,i=null,a=this,l=this.options.closeCharacters||/[\s()\[\]{};:>,]/,o=this.cm.getCursor(),s=this.cm.getLine(o.line).length;function r(){t||(t=!0,a.close(),a.cm.off("cursorActivity",f),CodeMirror.signal(e,"close"))}function d(){return!!t||(a.widget?void 0:(r(),!0))}function c(){d()||(a.options.async?a.getHints(a.cm,p,a.options):p(a.getHints(a.cm,a.options)))}function p(e){if(!d()){if(!e||!e.list.length)return r();a.widget.close(),a.widget=new n(a,e)}}function f(){clearTimeout(i);var e=a.cm.getCursor(),t=a.cm.getLine(e.line);e.line!=o.line||t.length-e.ch!=s-o.ch||e.ch<o.ch||a.cm.somethingSelected()||e.ch&&l.test(t.charAt(e.ch-1))?a.close():i=setTimeout(c,170)}this.cm.on("cursorActivity",f),this.onClose=r}},n.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null,this.hints.parentNode.removeChild(this.hints),this.completion.cm.removeKeyMap(this.keyMap);var e=this.completion.cm;!1!==this.completion.options.closeOnUnfocus&&(e.off("blur",this.onBlur),e.off("focus",this.onFocus)),e.off("scroll",this.onScroll)}},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(e){if(e=Math.max(0,Math.min(e,this.data.list.length-1)),this.selectedHint!=e){var t=this.hints.childNodes[this.selectedHint];t.className=t.className.replace(" CodeMirror-hint-active",""),(t=this.hints.childNodes[this.selectedHint=e]).className+=" CodeMirror-hint-active",t.offsetTop<this.hints.scrollTop?this.hints.scrollTop=t.offsetTop-3:t.offsetTop+t.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=t.offsetTop+t.offsetHeight-this.hints.clientHeight+3),CodeMirror.signal(this.data,"select",this.data.list[this.selectedHint],t)}},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}}}()}(),function(){const e=function(e){return{doc:e.doc}};CodeMirror.extendMode("css",{commentStart:"/*",commentEnd:"*/",newlineAfterToken:function(e,t){return/^[;{}]$/.test(t)}}),CodeMirror.extendMode("javascript",{commentStart:"/*",commentEnd:"*/",newlineAfterToken:function(e,t,i,n){return this.jsonMode?/^[\[,{]$/.test(t)||/^}/.test(i):(";"!=t||!n.lexical||")"!=n.lexical.type)&&(/^[;{}]$/.test(t)&&!/^;/.test(i))}}),CodeMirror.extendMode("xml",{commentStart:"\x3c!--",commentEnd:"--\x3e",newlineAfterToken:function(e,t,i){return"tag"==e&&/>$/.test(t)||/^</.test(i)}}),CodeMirror.defineExtension("commentRange",(function(e,t,i){var n=this,a=CodeMirror.innerMode(n.getMode(),n.getTokenAt(t).state).mode;n.operation((function(){if(e)n.replaceRange(a.commentEnd,i),n.replaceRange(a.commentStart,t),t.line==i.line&&t.ch==i.ch&&n.setCursor(t.line,t.ch+a.commentStart.length);else{var l=n.getRange(t,i),o=l.indexOf(a.commentStart),s=l.lastIndexOf(a.commentEnd);o>-1&&s>-1&&s>o&&(l=l.substr(0,o)+l.substring(o+a.commentStart.length,s)+l.substr(s+a.commentEnd.length)),n.replaceRange(l,t,i)}}))})),CodeMirror.defineExtension("autoIndentRange",(function(e,t){var i=this;this.operation((function(){for(var n=e.line;n<=t.line;n++)i.indentLine(n,"smart")}))})),CodeMirror.defineExtension("autoFormatRange",(function(t,i){var n=this,a=n.getMode(),l=n.getRange(t,i).split("\n"),o=CodeMirror.copyState(a,n.getTokenAt(t).state),s=n.getOption("tabSize"),r="",d=0,c=0==t.ch;function p(){r+="\n",c=!0,++d}for(var f=0;f<l.length;++f){for(var h=new CodeMirror.StringStream(l[f],s,e(n));!h.eol();){var u=CodeMirror.innerMode(a,o),m=a.token(h,o),b=h.current();h.start=h.pos,c&&!/\S/.test(b)||(r+=b,c=!1),!c&&u.mode.newlineAfterToken&&u.mode.newlineAfterToken(m,b,h.string.slice(h.pos)||l[f+1]||"",u.state)&&p()}!h.pos&&a.blankLine&&a.blankLine(o),c||p()}n.operation((function(){n.replaceRange(r,t,i);for(var e=t.line+1,a=t.line+d;e<=a;++e)n.indentLine(e,"smart");n.setSelection(t,n.getCursor(!1))}))})),t((function(){}))}();let r={};var d={sortable:!1,width:50,icon:"fa-font",editable:!1,required:!0,insertable:!1,type:"string",getPanelVal:e=>e,getEditVal:function(e){var t,i=e.val().trim(),n=!1;(!this.required||void 0!==i&&""!==i&&null!==i||(t="Поле "+this.title+" должно быть заполнено",n=!0),this.regexp&&""!==i)&&(new RegExp(this.regexp).test(i)||(t=this.regexpErrorText||'regexp не проходит - "'+this.regexp+'"',t='Ошибка заполнения поля "'+this.title+'": '+t,n=!0));if(n)throw t;return i},getEditElement:function(e,i,n,a,l,o,s){var r=t('<input type="text" class="form-control" name="cell_edit" autocomplete="off" autocorrect="off" />');void 0!==s&&r.attr("tabindex",s);var d=this;return i=i.v,r.val(i).on("keyup",(function(e){switch(e.keyCode){case 13:try{r.data("enterClicked",!0),a(t(this),e)}catch(e){r.data("enterClicked",!1),App.popNotify(e,r,"default"),d.focusElement(r)}break;case 27:l(t(this),e)}})),r.on("blur",(function(e){o(r,e)})),r.select()},checkEditRegExp:function(e){if(!this.warningEditRegExp)return!0;try{let t=this.warningEditRegExp.match(/^\/(.*?)\/([a-z]*)$/);return new RegExp(t[1],t[2]).test(e)}catch(e){return!0}},getCellText:function(e){if(!0===this.url&&e){let i=this.openIn||"window";switch(i){case"window":i="_self";break;case"newWindow":i="_blank"}let n=t('<a class="uri" target="'+i+'">').attr("href",e).text(e);return"iframe"===i&&n.attr("onclick","return App.aInIframe(this);"),n}return e},getPanelText:function(e,t,i){return this.getCellText(e,t,i)},getCopyText:function(e,i){let n=this.getPanelText(e.v,null,i);if("string"==typeof n)return n;const a=function(e){if(e&&e.each&&"[object Function]"==={}.toString.call(e.each)){let i="";return e.each((function(){""!==i&&(i+="; "),i+=t(this).text().replace(/\n/g,"; ")})),i}return e};if(null===n)return"";if("object"==typeof n&&!(n instanceof jQuery)){let e=t.Deferred();return n.done((function(t){e.resolve(a(t))})).fail((function(){e.resolve("Не удалось загрузить данные")})),e}return a(n)},focusElement:function(e){e.focus()},isDataModified:function(e,t){return"null"===(e+="")&&(e=""),"null"===(t+="")&&(t=""),t===(this.errorText||"ОШБК!")&&(t=""),"undefined"===t&&(t=""),e!==t},getFilterDataByValue:function(e){let t=[];return this.addDataToFilter(t,e),Object.keys(t)},addDataToFilter:function(e,t){let i,n="Пустое";null===t.v||""===t.v?i="".hashCode():(i=t.v.toString().hashCode(),n="string"==typeof t.v?t.v.replace(/"/g,"&quot;"):t.v+" "),e[i]=n},checkIsFiltered:function(e,t){let i={};return this.addDataToFilter(i,e),t.some((function(e){return e in i}))},getCellTextInPanel:function(e,t,i){return this.getCellText(e,t,i)},getPanelColumnIndex:function(e){return e.f&&e.f.hide&&e.f.hide.panel?0:-1!==["text","comments","file","listRow"].indexOf(this.type)||this.multiple?1.5:1},getHighCelltext:function(e,t,i){return this.getPanelText?this.getPanelText(e,t,i):this.getCellText(e,t,i)}};r.text={width:50,icon:"fa-align-left",type:"Text",isPanelField:!0,getEditVal:function(e){return e.data("val").trim()},getCellText:function(e){if(null===e)return"";let i=(e=e.toString()).length;return t("<div>").text(e.substring(0,this.viewTextMaxLength)+(i>this.viewTextMaxLength?"...":"")).text()},getValue:function(e,i,n){"use strict";if(n||"string"==typeof e&&e.length<this.viewTextMaxLength){let i=t.Deferred();return setTimeout((function(){e||(e=""),i.resolve({value:e})}),20),i}let a={fieldName:this.name};return i.id&&(a.rowId=i.id),this.pcTable.model.getValue(a,this.table_id)},getPanelTextWithLinks:function(e,i=!0){let n;if("text"===this.textType)n=t("<div>"),n.html(App.textWithLinks(e));else if(n=t('<div class="codeEditor">'),e&&e.trim()){let t={value:e,mode:this.getMode(),readOnly:!0,theme:"eclipse",lineNumbers:!0,lineWrapping:!0,bigOneDialog:!0,height:200};i?setTimeout((function(){CodeMirror(n.get(0),t)}),10):n.html(App.textWithLinks(e)),n.on("panel-resize",(function(){n.empty(),CodeMirror(n.get(0),t)}))}return n},getHighCelltext:function(e,i,n){return"string"!=typeof e?"":t("<div>").text(e.trim())},getPanelText:function(e,i,n){if(null===e)return"";e=e.toString();let a=this;if(e.length<=this.viewTextMaxLength)return a.getPanelTextWithLinks(e,!1).data("text",e);let l=t.Deferred();return this.getValue(e,n,!1).then((function(e){l.resolve(t("<div>").append(a.getPanelTextWithLinks(e.value,!1)).data("text",e.value))})).fail((function(){l.reject()})),l.promise()},getMode(){let e="text";switch(this.textType){case"html":e="text/html";break;case"totum":e="totum";break;case"markdown":e="text/x-markdown";break;case"xml":e="application/xml";break;case"css":e="text/css";break;case"javascript":e="text/javascript"}return e},getEditElement:function(i,n,a,l,o,s,r,d){let c,p=this,f=t("<div>"),h=t("<div>").css("min-height",200),u=t('<div class="HTMLEditor">');n=n.v||"";let m=function(){p.getValue(n,a,!d).then((function(i){let n;if(f.append(u),u.empty().appendTo(h),"json"===p.textType){n=new JSONEditor(u.get(0),{});try{""!==i.value&&n.setText(i.value)}catch(t){e.top.App.modal("Ошибка формата JSON ")}u.css("min-height",200);let a=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Вручную</a>').on("click",(function(){let i=t("<div>"),a=t('<textarea class="form-control" style="height: 350px;">').val(JSON.stringify(n.get(),null,2)).appendTo(i),l=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:function(t){try{n.setText(a.val()),t.close()}catch(t){e.top.App.modal("Ошибка формата JSON")}}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];return p.pcTable.isMobile?App.mobilePanel("Ручное изменение json-поля",i,{buttons:l}):BootstrapDialog.show({message:i,type:null,title:"Ручное изменение json-поля",buttons:l,cssClass:"fieldparams-edit-panel",draggable:!0,onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1}));u.find(".jsoneditor-menu").append(a)}else{let e=p.getMode(),l=t("<div>").appendTo(u),o={value:i.value.toString(),mode:e,minHeight:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0};"text"===e&&(o.lineNumbers=!1,o.lineWrapping=!0),n=CodeMirror(l.get(0),o),n.on("paste",(function(e,t){setTimeout((function(){n.refresh()}),1)})),p.pcTable&&"tables"===p.pcTable.tableRow.name&&(n.table=a.name.v||a.name),n.getScrollerElement().style.minHeight="350px",n.focus()}u.data("editor",n),f.data("editor",n)}))};const b=function(e,t,i){"json"===p.textType?f.data("val",JSON.stringify(u.data("editor").get())):f.data("val",u.data("editor").getValue()),i||(l(f,{}),e.close())};c=[];let g={label:"Сохранить",cssClass:"btn-m btn-warning",action:b},v={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){o(f,{}),e.close()}};-1!==["xml","html"].indexOf(p.textType)&&c.unshift({label:"Форматировать",action:function(){let e=u.data("editor"),t=e.lineCount(),i=e.getValue().length;e.autoFormatRange({line:0,ch:0},{line:t,ch:i})}});let w="Текст поля <b>"+this.title+", "+p.textType+"</b>",_="ctrlS.textedit";if(d){let e=!1;setTimeout((function(){let i=f.closest("td").find(".cdiv");i.length>0?(i.data("bs.popover").options.content.find(".btn").each((function(){let i=t(this),n={};n.label=i.data("name"),n.cssClass=i.attr("class").replace("btn-sm","btn-m"),n.icon=i.find("i").attr("class"),n.save=i.data("save"),n.click=i.data("click"),n.action=function(t){n.save&&b(t,0,!0),n.click({}),e=!0,t.close()},c.push(n)})),i.popover("destroy")):(c.push(g),c.push(v)),p.pcTable.isMobile?App.mobilePanel(w,h,{buttons:c,onhide:function(i){t("body").off(_),e||s(f,{})},onshown:function(e){m()},onshow:function(e){t("body").on(_,(function(t){return b(e),!1}))}}):BootstrapDialog.show({message:h,type:null,title:w,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:c,onhide:function(i){t("body").off(_),e||o(f,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"}),m()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"100%"}),t("body").on(_,(function(t){return b(e),!1}))}})}),1),f.text("Редактирование в форме").addClass("edit-in-form")}else{f.on("focus click","button",(function(){let e=c.splice();e.push(g),e.push(v);var i=t(this).closest("div");p.pcTable.isMobile?App.mobilePanel(w,h,{buttons:e,onhide:function(e){t("body").off(_),o(i,e)},onshown:function(e){m(),t("body").on(_,(function(t){return b(e),!1}))}}):BootstrapDialog.show({message:h,type:null,cssClass:"fieldparams-edit-panel",title:w,buttons:e,draggable:!0,onhide:function(e){t("body").off(_),o(i,e)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),m(),e.$modalContent.css({width:900}),t("body").on(_,(function(t){return b(e),!1}))}})}));let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактировать текст");r&&e.attr("tabindex",r),f.append(e)}return f.data("val",n)},getEditPanelText(e){return this.getPanelTextWithLinks(e.v)},getCellTextInPanel:function(e,t,i){return this.getPanelTextWithLinks(e)},addPlaceholder(e,t){setTimeout((function(){e.data("editor").setOption("placeholder",t),e.data("editor").refresh()}),100)}},r.checkbox={icon:"fa-check-square",getEditVal:function(e){return!!e.is(":checked")},getCellText:function(e){return!0===e?"✓":!1===e?"-":""},getEditElement:function(e,i,n,a,l,o,s){var r=t('<input type="checkbox" name="cell_edit"/>');s&&r.attr("tabindex",s),r.on("keyup",(function(e){13==e.keyCode&&setTimeout((function(){a(r,e)}),20)})),r.on("blur",(function(e){setTimeout((function(){r.length&&r.closest("body").length&&l(r,e)}),220)}));return!0===i.v&&r.prop("checked",!0),r.on("click",(function(e){a(r,e)})),r}},r.string={addPlaceholder:function(e,t){e.attr("placeholder",t)}},r.number={icon:"fa-hashtag",getEditVal:function(e){let t=e.val().trim();if(void 0===t||""===t||null===t){if(this.required)throw"Поле "+this.title+" должно быть заполнено";return""}if(this.regexp&&!new RegExp(this.regexp).test(t)){let e=this.regexpErrorText||'regexp не проходит - "'+this.regexp+'"';throw e='Ошибка заполнения поля "'+(this.title||this.name)+'": '+e,e}let i=t.replace(/[^\-()\d/*+.,%:\/]/g,"");if(!/^(\+|\*|\%|\/|\:)?(\-?[\d]+((\.|\,)[\d]+)?)%?$/.test(i))throw"Здесь должно быть число";return t=t.replace(/,/,"."),t},getCopyText:function(e,t,i){return null==e||""===e||null===e.v?"":e.v.toString().replace(/\./g,",")},getCellText:function(e,t,i){if(null==e||""===e)return"";if(this.currency){const t=function(e,t,i,n){var a=isFinite(+e)?+e:0,l=isFinite(+t)?Math.abs(t):0,o=void 0===n?" ":n,s=void 0===i?",":i,r=(l?function(e,t){var i=Math.pow(10,t);return Math.round(e*i)/i}(a,l):Math.round(a)).toString().split(".");return r[0].length>3&&(r[0]=r[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,o)),(r[1]||"").length<l&&(r[1]=r[1]||"",r[1]+=new Array(l-r[1].length+1).join("0")),r.join(s)};let i,n;return"dectimalSeparator"in this&&(i=this.dectimalSeparator),"thousandthSeparator"in this&&(n=this.thousandthSeparator),(null!==e&&"prefix"in this?this.prefix:"")+t(parseFloat(e),this.dectimalPlaces||0,i,n)+(null!==e&&"postfix"in this?this.postfix:"")}return e},addPlaceholder:function(e,t){e.attr("placeholder",t)}},r.date={icon:"fa-calendar-o",getEditVal:function(e){if(this.required&&""==e.val().trim())throw"Поле должно быть заполнено";if(!e.val().trim())return"";let t=e.data("calendar").data("DateTimePicker").date();return this.getDbString(t)},getEditElement:function(e,i,n,a,l,o,s){var r=t('<input type="text" name="cell_edit" class="form-control" autocomplete="off" autocorrect="off" />');s&&r.attr("tabindex",s);var d=this;let c=this.getFormat();r.data("AppUin",App.getUn()),i=i.v,r.val(this.getViewString(i));let p,f=t("<div>");this.dateTime&&/d/i.test(c)&&(p="date-popover");var h=t("<div></div>").appendTo(f);let u,m,b;h.on("dp.change",(function(e){if(null!==e.oldDate||!d.dateTime||r.val()&&""!==r.val())r.val(e.date.format(c));else{let t=e.date,i=moment();t.format("HH:mm")===i.format("HH:mm")&&(t=t.hours(0).minutes(0)),r.val(t.format(c)),g()}})),r.on("keyup",(function(e){u&&clearTimeout(u),13===e.keyCode?(g(),a(t(this),e)):27===e.keyCode?l(t(this),e):e.keyCode>=48&&(u=setTimeout((function(){g()}),2e3))}));const g=function(){"use strict";let e=r.val();e=e?moment(e,c):"";try{h.data("DateTimePicker").date(e)}catch(e){}};if(setTimeout((function(){let e=r.closest("td").find(".cdiv");if(e.length>0){let i=e.data("bs.popover");i&&(f.append(i.options.content),e.popover("destroy")),b=t("#"+App.popNotify({$text:f,element:e,container:d.pcTable._container,isParams:!0,placement:"bottom",class:p})),r.on("focus click",(function(){b.show()}))}else r.on("focus click",(function(){b||(m=App.popNotify(f,r),b=t("#"+m)),h.data("DateTimePicker").show(),b.show(),g()}))}),20),r.on("blur",(function(e){setTimeout((function(){b&&b.is(":visible")&&(b.hide(),g(),o(r,e))}),200)})),h.datetimepicker({inline:!0,format:c,useCurrent:!1,showClose:!1,locale:"ru",sideBySide:!0,collapse:!1}),i)try{h.data("DateTimePicker").date(d.getMoment(i))}catch(e){}else r.val("");return r.data("calendar",h),r},getCellText:function(e){return e&&null!==e?this.getViewString(e):""},getViewString:function(e){return e?this.dateTime?App.dateTimeFormats.covertFromDb(e,this.getFormat()):App.dateFormats.covertFromDb(e,this.getFormat()):""},getDbString:function(e){return e?this.dateTime?App.dateTimeFormats.covertToDb(e,this.getFormat()):App.dateFormats.covertToDb(e,this.getFormat()):""},getMoment:function(e){return this.dateTime?moment(e,App.dateTimeFormats.db):moment(e,App.dateFormats.db)},addDataToFilter:function(e,t){let i,n="Пустое";null===t.v||""===t.v?i="".hashCode():(i=t.v.toString().hashCode(),n="string"==typeof t.v?this.getCellText(t.v):t.v),e[i]=n},getFormat:function(){let e=this.dateFormat;e||(e=this.dateTime?"d.m.y H:i":"d.m.y");let t={d:"DD",D:"ddd",j:"M",z:"DDD",W:"W",m:"MM",M:"MMM",n:"M",y:"YY",Y:"YYYY",H:"HH",i:"mm",s:"ss"},i="";for(let n=0;n<e.length;n++){let a=e[n];i+=t[a]||a}return i}},r.unic={icon:"fa-fire"},function(){const i=function(e,t){e.attr("data-fileviewpreview",JSON.stringify({name:t.name,file:t.file}))};r.file={icon:"fa-file-image-o",getSize:function(e){return e>102400?" "+(Math.round(e/1048576*10)/10).toLocaleString()+"Mb":" "+Math.round(e/1024).toLocaleString()+"Kb"},getCellText:function(e){if(!e||null===e||0==e.length)return"";let n=t('<span style=""></span>');const a=function(e){let a;-1!==["png","jpg"].indexOf(e.ext)?(a=t('<img src="/fls/'+e.file+'_thumb.jpg" style="z-index: 200; max-height: 24px; padding-right: 4px;" class="file-image-preview" data-filename="'+e.file+'"/>'),i(a,e)):a="pdf"===e.ext?'<img src="/imgs/file_ico_pdf.png" style="max-height: 24px;  padding-right: 4px;" class="file-pdf-preview" data-filename="/fls/'+e.file+'"/>':'<img src="/imgs/file_ico.png" style="max-height: 24px;  padding-right: 4px;"/>';let l=t('<a href="/fls/'+e.file+'"  class="file-sell-text" download="'+t("<div>").text(e.name).html()+'" style="padding-right: 5px"></a>');n.append(a),l.append(e.name),n.append(l)};return e.length&&e.forEach&&e.forEach(a),n.children()},getCopyText:function(t,i){if(!(t=t.v)||null===t||0==t.length)return"";let n=this,a="";return t.forEach((function(t){""!==a&&(a+="\n"),a+=t.name+" "+e.location.protocol+"//"+e.location.host+"/fls/"+t.file+" "+n.getSize(t.size)})),a},getPanelText:function(n){if(!n||null===n||0==n.length)return"";let a=t('<div class="file-mini-panel">'),l=this,o="",s=Math.random();return n.forEach((function(n){let r="",d="";-1!==["jpg","png"].indexOf(n.ext)&&(r=t('<img src="/fls/'+n.file+"_thumb.jpg?rand="+s+'"/>'),d="with-img",i(r,n)),t("<div>").addClass(d).appendTo(a).append(r).append(t('<br/><a href="/fls/'+n.file+'" download="'+t("<div>").text(n.name).html()+'">').text(n.name)).append(l.getSize(n.size)),""!==o&&(o+="\n"),o+=e.location.protocol+"//"+e.location.host+"/fls/"+n.file})),a.data("text",o)},getEditVal:function(e){if(this.required&&""==e.data("val"))throw"Поле должно быть заполнено";return e.data("val")},getEditElement:function(e,i,n,a,l,o,s,r){let d,c,p=this,f=this.pcTable,h=t("<div>"),u=t("<div>").css("min-height",200),m=i.v||[],b=!1;const g=function(e){let i=t('<div class="filePart"><div><span class="name"></span><span class="size"></span><button class="btn btn-danger btn-xs remove"><i class="fa fa-remove"></i></button></div></div>'),a={name:e.name,type:e.type,tmpfile:e.tmpfile,size:e.size,file:e.file,ext:e.ext};new RegExp("^"+p.pcTable.tableRow.id+"_"+(n.id?n.id:""));if(i.data("file",a),i.find(".name").text(e.name),i.find(".size").text(p.getSize(e.size)),e.file){let n=t("<a>").attr("href","/fls/"+e.file).attr("download",e.name);i.find(".name").wrap(n),-1!==["jpg","png"].indexOf(e.ext)&&(t("<img>").attr("src","/fls/"+e.file+"_thumb.jpg?rand="+Math.random()).insertBefore(i.find(".name")),i.addClass("with-img"))}else i.append('<div class="progressbar">&nbsp;</div>');if(e.tmpfile){i.addClass("addFile"),i.find(".progressbar").text("Требуется сохранение элемента для привязки файла")}return i},v=function(e){c.$modalFooter.find("button:first").prop("disabled",e)},w=function(){u.empty();let e=t('<input type="file" name = "file" '+(p.multiple?"multiple":"")+' accept="'+p.accept+'" style="display: block; position: absolute; top: -3000px"/>'),i=t("<div>").appendTo(u),n=t('<button class="btn btn-default btn-sm">Добавить файл'+(p.multiple?"ы":"")+"</button>");i.append(n),n.wrap('<div class="addFilesButton">'),n.wrap("<div>");let a=t('<div class="ttm-dropzone" id="ttmDropzone">Перетащите сюда файл</div>').insertAfter(n.parent());a.on("dragenter",()=>a.addClass("highlight")),a.on("dragleave",()=>a.removeClass("highlight")),a.on("drop",e=>{if(e.preventDefault(),a.removeClass("highlight"),!a.is(".disabled")){if(!this.multiple&&e.originalEvent.dataTransfer.files.length>1)return App.notify("Поле принимает только один файл","Ошибка"),!1;o(e.originalEvent.dataTransfer.files)}return!1});const l=function(){p.multiple||(u.find(".filePart").length>0?(n.prop("disabled",!0),a.addClass("disabled")):(n.prop("disabled",!1),a.removeClass("disabled")))},o=function(e){if(e){let i=[];v(!0);for(let n=0,a=e.length;n<a;n++){let a=e[n],o=g(a).addClass("addFile").appendTo(u);l();let s=o.find(".progressbar"),r=new XMLHttpRequest,d=t.Deferred();o.on("click",".remove",(function(){o.remove(),r.abort(),d.resolve(),l()})),r.upload.onprogress=function(e){s.css("box-shadow","inset "+Math.round(parseInt(s.width())*e.loaded/e.total).toString()+"px 0px 0 0 #85FF82"),e.loaded===e.total&&s.text("Проверка файла сервером")},r.onload=r.onerror=function(e){if(d.resolve(),200===this.status)try{let e=JSON.parse(this.responseText);if(e.fname)return s.text("Готово"),void(o.data("file").tmpfile=e.fname)}catch(e){}o.data("file",null),s.text("Ошибка").css({"box-shadow":"none","background-color":"#ffe486"})},r.open("POST",f.model.getUri(),!0);let c=new FormData;c.append("file",a),c.append("method","tmpFileUpload"),c.append("ajax",!0),r.send(c),i.push(d.promise())}t.when(...i).then((function(){v(!1)}))}};m.forEach((function(e){let t=g(e).appendTo(u);t.on("click",".remove",(function(){t.remove(),l()}))})),l(),n.on("click",(function(){t("body").append(e),e.click(),e.on("change",(function(){o(this.files)}))}))},_=function(e){let i=[];e.$modalContent.find(".filePart").each((function(){let e=t(this).data("file");e&&i.push(e)})),h.data("val",i),m=i,b=!0,a(h,{}),e.close()};d=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:_},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){a(h,{}),e.close()}}];let y="Форма файлов <b>"+this.title+"</b>",x="ctrlS.textdialog",k=function(e){c=p.pcTable.isMobile?App.mobilePanel(y,u,{buttons:d,onhide:function(i){t("body").off(x),b||l(e,i)},onshown:function(e){w(),t("body").on(x,(function(t){_(e)}))}}):BootstrapDialog.show({message:u,type:null,cssClass:"fieldparams-edit-panel",title:y,draggable:!0,buttons:d,onhide:function(i){t("body").off(x),b||l(e,i)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:600}),w(),t("body").on(x,(function(t){_(e)}))}})};if(r)k(h),h.text("Редактирование в форме").addClass("edit-in-form");else{h.on("focus click","button",(function(){k(t(this).closest("div"))}));let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактировать поле");s&&e.attr("tabindex",s),h.append(e)}return h.data("val",m)},getEditPanelText:function(e){return this.getCellTextInPanel(e.v).children()},getCellTextInPanel:function(e){let n=t('<div class="panel-preview"></div>');return e&&e.length&&e.forEach&&e.forEach((function(e){let a;-1!==["png","jpg"].indexOf(e.ext)?(a=t('<img src="/fls/'+e.file+'_thumb.jpg" />'),i(a,e)):a='<img src="/imgs/file_ico.png" />';let l=t("<div>"+a+'<a href="/fls/'+e.file+'" download="'+t("<div>").text(e.name).html()+'"></a></div>');l.find("a").append(e.name),n.append(l)})),n},isDataModified:function(e,t){return(-1===[null,""].indexOf(e)||-1===[null,""].indexOf(t))&&(-1!==[null,""].indexOf(e)||-1!==[null,""].indexOf(t)||!Object.equals(t,e))}}}(),r.n=t.extend({},r.default,{name:"n",width:52,title:"Порядок",category:"column",hidden:!0,showInWeb:!0,getCellText:function(e,i,n){let a=n.f||{};return i.addClass("n"),!n.id||a.block||a.blockorder||n.__inserted?"":t('<span class="btns"><button class="btn btn-xxs btn-default"><i class="fa fa-angle-up"></i></button> <button class="btn btn-xxs btn-default"><i class="fa fa-angle-down"></i></button></span>')}}),r.listRow=t.extend({},r.default,{icon:"fa-code",isPanelField:!0,getPanelTextAsTable:function(e){if("object"==typeof e&&null!==e&&e.settings&&e.data&&e.settings.columns&&e.settings.columns.length){const i=t('<table class="json-table">');let n=e.settings,a=n.columns;try{if(n.headRow){const e=t("<tr>").appendTo(i);"boolean"==typeof n.headRow?a.forEach((function(i){t("<td>").text(i).appendTo(e).addClass("head")})):a.forEach((function(i){t("<td>").text(n.headRow[i]).appendTo(e).addClass("head")}))}return e.data.forEach((function(e){const l=t("<tr>").appendTo(i);a.forEach((function(i){let n=e[i];"string"==typeof n&&""!==n||(n=JSON.stringify(n));t("<td>").text(n).appendTo(l)})),n.headColumn&&l.find("td:first").addClass("head")})),i}catch(e){console.log(e)}}},getPanelText:function(e,i,n){let a=t.Deferred(),l=this;const o=function(e){let i=l.getPanelTextAsTable.call(l,e);if(i)return i.copyText=JSON.stringify(e),void a.resolve(i);a.resolve(t("<div>").text(JSON.stringify(e,null,2)))};return"string"!=typeof e?o(e):this.getValue(e,n,!1).then((function(e){o(e.value)})).fail((function(){a.reject()})),a.promise()},getValue:function(e,i,n){"use strict";let a=t.Deferred();if(n||"filter"===this.category||"object"==typeof e||!e)return a.resolve({value:e}),a;{let e={fieldName:this.name};i.id&&(e.rowId=i.id),this.pcTable.model.getValue(e,this.table_id).then((function(e){a.resolve(e)}))}return a},getEditElement:function(i,n,a,l,o,s,r,d){let c,p=this,f=t("<div>"),h=t("<div>").css("min-height",200),u=t('<div class="HTMLEditor">');n=n.v||"";let m=function(){p.getValue(n,a,!d).then((function(i){let n;f.append(u),u.empty().appendTo(h),n=new JSONEditor(u.get(0),{});try{""!==i.value&&n.setText(JSON.stringify(i.value))}catch(t){e.top.App.modal("Ошибка формата JSON ")}u.css("min-height",200);let a=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Вручную</a>').on("click",(function(){let i=t("<div>"),a=t('<textarea class="form-control" style="height: 350px;">').val(JSON.stringify(n.get(),null,2)).appendTo(i),l="Ручное изменение json-поля",o=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:function(t){try{n.setText(a.val()),t.close()}catch(t){e.top.App.modal("Ошибка формата JSON")}}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];return p.pcTable.isMobile?App.mobilePanel(l,i,{buttons:o}):e.top.BootstrapDialog.show({message:i,type:null,title:l,draggable:!0,cssClass:"fieldparams-edit-panel",buttons:o,onhide:function(e){},onshown:function(t){t.$modalContent.position({of:e.top})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1}));u.find(".jsoneditor-menu").append(a),u.data("editor",n)}))};const b=function(e,t,i){f.data("val",u.data("editor").get()),i||(l(f,{}),e.close())};c=[];let g={label:"Сохранить",cssClass:"btn-m btn-warning",action:b},v={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){o(f,{}),e.close()}},w="Текст поля <b>"+this.title+"</b>",_="ctrlS.textedit";if(d){let i=!1;setTimeout((function(){let n=f.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each((function(){let e=t(this),n={};n.label=e.data("name"),n.cssClass=e.attr("class").replace("btn-sm","btn-m"),n.icon=e.find("i").attr("class"),n.save=e.data("save"),n.click=e.data("click"),n.action=function(e){n.save&&b(e,0,!0),n.click({}),i=!0,e.close()},c.push(n)})),n.popover("destroy")):(c.push(g),c.push(v)),p.pcTable.isMobile?App.mobilePanel(w,h,{buttons:c,onhide:function(e){t("body").off(_),i||s(f,{})},onshown:function(e){m()},onshow:function(e){t("body").on(_,(function(t){b(e)}))}}):e.top.BootstrapDialog.show({message:h,type:null,title:w,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:c,onhide:function(e){t("body").off(_),i||s(f,{})},onshown:function(i){i.$modalContent.position({of:t(e.top.document.body),my:"top+50px",at:"top"}),m()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:900,maxWidth:"99vw"}),t("body").on(_,(function(t){b(e)}))}})}),1),f.text("Редактирование в форме").addClass("edit-in-form")}else{f.on("focus click","button",(function(){let i=c.splice();i.push(g),i.push(v);var n=t(this).closest("div");p.pcTable.isMobile?App.mobilePanel(w,h,{buttons:i,onhide:function(e){t("body").off(_),o(n,e)},onshown:function(e){m(),t("body").on(_,(function(t){b(e)}))}}):e.top.BootstrapDialog.show({message:h,type:null,cssClass:"fieldparams-edit-panel",title:w,draggable:!0,buttons:i,onhide:function(i){t(e.top.document.body).off(_),o(n,i)},onshown:function(i){i.$modalHeader.css("cursor","pointer"),m(),i.$modalContent.css({width:900,maxWidth:"99vw"}),t(e.top.document.body).on(_,(function(e){b(i)}))}})}));let i=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактировать список/json");r&&i.attr("tabindex",r),f.append(i)}return f.data("val",n)},isDataModified:function(e,t){return""===e&&(e=null),""===t&&(t=null),t!==e&&!Object.equals(e,t)},getEditVal:function(e){return e.data("val")},getCellText:function(e){return"string"!=typeof e?JSON.stringify(e):e},getHighCelltext(e,t,i){return this.getCellText(e)},getEditPanelText(e){return this.getCellText(e.v)}}),r.password={icon:"fa-lock",getEditVal:function(e){var t=e.val().trim(),i=!1;if(void 0!==t&&""!==t&&null!==t||(notify="Поле "+this.title+" должно быть заполнено",i=!0),i)throw notify;return t},getCellText:function(e){return"**PASSWORD**"},getEditElement:function(e,i,n,a,l,o,s){var r=t('<input type="password" name="cell_edit" class="form-control"  autocomplete="new-password" autocorrect="off" placeholder="'+(i&&i.v?"Поменять пароль":"Новый пароль")+'"/>');r.on("save-me",(function(e){a(t(this),e)})),s&&r.attr("tabindex",s);var d=this;i=i.v,r.on("keyup",(function(e){switch(e.keyCode){case 13:try{r.data("enterClicked",!0),a(t(this),e)}catch(e){r.data("enterClicked",!1),App.popNotify(e,r,"default"),d.focusElement(r)}break;case 27:l(t(this),e)}}));return r.one("blur",(function(e){setTimeout((function(){!function(e){o(r,e)}(e)}),50)})),r.select()}},r.select={icon:"fa-th-list",getEditVal:function(e){if(e.data("input")){var t=e.data("input").selectpicker("val");return null===t&&this.multiple&&(t=[]),t}},loadPreviewPanel(i,n,a,l){let o=t.Deferred();return i.html('<div class="center"><i class="fa fa-spinner fa-spin"></i></div>'),this.pcTable.model.loadPreviewHtml(n,a,l).then((function(n){if(i){let a=t("<div>");n.previews.forEach((function(i){let n=t('<div class="preview">');switch(i[2]){case"file":e.imgRand=e.imgRand||Math.random(),Array.isArray(i[1])&&i[1].forEach((function(i){-1!==["jpg","png"].indexOf(i.ext)&&n.append(t('<a href="/fls/'+i.file+'" target="_blank">').html('<img src="/fls/'+i.file+"_thumb.jpg?rand="+e.imgRand+'"/><br/>')),n.append(t('<a href="/fls/'+i.file+'" target="_blank">').text(i.name+" "+Math.round(i.size/1024).toLocaleString("ru-RU")+" Kb"))}));break;case"html":n.text(i[0]);break;case"text":n.text(App.textWithLinks(i[1]));break;case"currency":case"number":if("currency"===i[2])try{n.text(parseFloat(i[1]).toLocaleString("ru-RU"))}catch(e){n.text(i[1])}else n.text(i[1]);i[3].unitType&&n.append(" "+i[3].unitType);break;case"url":n=t("<div>").append(t('<a target="_blank">').text(i[1]).attr("href",i[1]));break;default:n=t("<div>").text(i[1])}a.append(t('<div class="title">').text(i[0])),a.append(n)})),i.empty().append(a)}o.resolve()})).fail((function(){o.reject()})),o},previewPanel:function(e,i){let n=t('<div id="selectPanel" class="text preview" style="white-space: pre-wrap; height: 200px;">'),a={};a="column"===this.category?e.data("id")?this.pcTable._getItemById(e.data("id")):this.pcTable._insertItem:this.pcTable.data_params,i.popover({html:!0,content:n,trigger:"manual",container:"body",placement:"auto right",animation:!1}).popover("show");let l=t("#"+i.attr("aria-describedby")).css("z-index",1e4);const o=function(){i.attr("aria-describedby")&&l.length&&(i.off(".preview"),l.off(".preview"),l.remove())};i.on("mouseout.preview",(function(){setTimeout((function(){l&&!l.is(":hover")&&o()}),300)})),l.on("mouseout.preview",(function(){l.is(":hover")||!i||i.is(":hover")||o()})),i.one("remove destroy",(function(){i.attr("aria-describedby")&&i.popover("destroy")})),this.loadPreviewPanel(n,e.data("field"),a,e.data("val")).then((function(){const e=function(){i&&!i.height()?o():setTimeout(e,500)};e()}))},getEditElement:function(i,n,a,l,o,s,r,d,c){"use strict";n||(n={}),n=t.extend(!0,{},n);let p,f,h,u=this,m=n.v||null;if(u.multiple&&"string"==typeof m)try{m=JSON.parse(m)}catch(e){m=[]}i&&i.data("input")?(f=i,p=f.data("input"),p.data("is-rendered",!0),h=p.data("LISTs")):(f=t("<div>"),h={isListForLoad:!0,innerList:[],innerIndexed:[],isSliced:!0,isPreview:!1},u.list&&(h=u.list));let b=function(e){let i=t.Deferred(),n={};return Object.keys(a).forEach((function(e){/^\$/.test(e)||("id"===e?n[e]=a[e]:e===u.name?n[e]=m:null!==a[e]&&"object"==typeof a[e]&&-1!==Object.keys(a[e]).indexOf("v")?n[e]=a[e].v:n[e]=a[e])})),f.isAttached()&&f.append('<i class="fa fa-cog fa-spin fa-3x loading" style="position: absolute; z-index: 1    right: 1px;    top: 1px;    font-size: 8px;"/>'),u.pcTable.model.getEditSelect(n,u.name,e,null).then((function(t){f.find(".loading").remove(),h.innerList=t.list?t.list:[],h.innerIndexed=t.indexed?t.indexed:{},h.isSliced=t.sliced,h.isPreview=t.previewdata,u.codeSelectIndividual||null!==e&&""!==e&&void 0!==e||h.isSliced||(u.list=h,h.isListForLoad=!1),i.resolve()}),(function(){i.reject()})),i.promise()};setTimeout((function(){f.length&&f.isAttached()&&f.find(".mark-loading").length&&f.find(".mark-loading").html('<i class="fa fa-spinner"></i>')}),200);let g=0;const v=function(){a[u.name]&&a[u.name].replaceViewValue&&h.innerIndexed[a[u.name].v]&&(a[u.name].replaceViewValue(h.innerIndexed[a[u.name].v]),delete a[u.name].replaceViewValue);let t=f.closest("body");if(t&&t.length){let n=t.get(0).ownerDocument==document?e.$:e.top.$;const d=function(e,t){let i={"Выбранное":n('<optgroup label="Выбранное">'),"":n('<optgroup label="">')},l=i["Выбранное"];const o=function(e,t,i,l){l=l?n('<small class="text-muted">').text(l):"";let o=n("<option>").attr("value",e),s=n("<div>").text(null===t||""===t?"["+e+"]":t);if(l&&s.append(l),s=s.html(),i)o.attr("data-content",'<span class="text" style="text-decoration: line-through">'+s+"</span>");else{let t=n('<span class="text" >'+s+"</span>");h.isPreview&&(t.addClass("select-with-preview"),t.attr("data-id",a.id),t.attr("data-field",u.name),t.attr("data-val",e)),o.data("content",t.get(0).outerHTML)}return o};let s=function(){return!0};if(t&&""!==t){let e=t.toLowerCase().replace("ё","е").split(" ");s=function(t){let i=null!==t?t.toString().toLowerCase().replace("ё","е"):"";return!e.some((function(e){return-1===i.indexOf(e)}))}}let r,d={};if(e||"filter"===u.category){const t=function(e){null===e&&(e="");let t,i=h.innerIndexed[e];return t=i?o(e,i[0],!1,i[1]):o(e,e,!0,null),l.append(t),d[e]=1,!!i&&(s(i[0])||t.addClass("hidden"),!0)};u.multiple?Array.isArray(e)?(e.forEach(t),r=Object.keys(d)):void 0!==e&&(t(e),r=[e]):(t(e),r=e)}if("onlyVals"!==t){u.multiple||u.withEmptyVal&&""!==u.withEmptyVal.trim()&&"filter"!==u.category&&i[""].append(n("<option>").data("content",u.withEmptyVal).text(""));for(let e in h.innerList){let t=h.innerList[e];if(1===d[t])continue;let a=h.innerIndexed[t];if(!h.isSliced&&!s(a[0]))continue;let l=o(t,a[0]),r=a[1]?a[1]:"";i[r]||(i[r]=n('<optgroup label="'+r+'">')),i[r].append(l)}}if(p.empty(),Object.keys(i).forEach((function(e){p.append(i[e])})),!0===h.isSliced){let e=o(0,"Данные не полны. Воспользуйтесь поиском!");e.prop("disabled",!0),e.css("text-align","center"),p.append(e)}return p.selectpicker("refresh"),p.selectpicker("val",r),r};if(!i||!i.data("input")){let e=!1;const t=function(){let t="-----";return"filter"===u.category?(t="Пустое",u.selectFilterWithEmptyText&&(t=u.selectFilterWithEmptyText)):u.withEmptyVal&&""!==u.withEmptyVal.trim()?t=u.withEmptyVal:u.multiple&&c&&c.closest(".InsertPanel").length&&(t="Выберите",e=!0),t};p=n('<select class="form-control" '+(1==u.multiple?"multiple ":"")+' data-size="auto" style="display: none;" name="cell_insert" data-style="btn-sm btn-default" data-width="css-width" data-live-search="true" data-title="'+t()+'">').width(u.width),e&&p.attr("data-selected-text-format","static"),f.append(p),f.append('<div class="text-center mark-loading"></div>'),r&&p.attr("tabindex",r),p.data("AppUin",App.getUn()),f.data("input",p),p.data("LISTs",h)}f.find(".mark-loading").remove();let g=0===p.closest(".modal-body").length?u.pcTable._container:p.closest(".modal-body");if(p.data("container",g),d(m),!p.data("is-rendered")){let t;p.data("selectpicker").$searchbox.off().on("click.dropdown.data-api focus.dropdown.data-api touchend.dropdown.data-api",(function(e){e.stopPropagation()}));let i="";p.data("selectpicker").$searchbox.on("keyup",(function(e){if("Escape"===e.key)return p.data("selectpicker").$button.click(),!0;let a=n(this).val();i!==a&&(i=a,t&&clearTimeout(t),t=setTimeout((function(){h.isListForLoad||h.isSliced?b.call(u,a).then((function(){d.call(u,m,a)})):d.call(u,m,a)}),750))}));let a=n(u).closest("td, .cell");if(0===p.closest(".InsertRow, .InsertPanel").length){let e=p.data("container");p.on("remove",(function(){e.off("click.selectContainer."+p.data("AppUin")),e.off("keydown.selectContainer."+p.data("AppUin"))})),e.on("click.selectContainer."+p.data("AppUin"),(function(e){let t=n(e.target);t.closest("td").is(".editing")||t.closest(".bootstrap-select").length||s(f,e)})),e.on("keydown.selectContainer."+p.data("AppUin"),(function(e){if(27===e.keyCode)return p.data("keyPressed","Esc"),o(f,e),!1;if(13===e.keyCode&&p.data("enterPressed",!0),9!==e.keyCode&&16!==e.keyCode&&a.data("edited"),e.altKey||e.shiftKey){let t=e.altKey?"altKey":!!e.shiftKey&&"shiftKey";p.data("keyPressed",t)}})).on("keyup",(function(e){p.removeData("keyPressed"),p.removeData("enterPressed")})),setTimeout((function(){if(p.data("selectpicker").$bsContainer.offset().top>f.find("button").offset().top){let e=p.closest("td").find(".cdiv").data("bs.popover");e.applyPlacement(e.getCalculatedOffset("top",e.getPosition(),e.$tip.width()+8,e.$tip.height()+33),"top"),e.$tip.removeClass("bottom").addClass("top")}}),10)}p.on("hidden.bs.select",(function(){let e=p.data("changed"),t={},i=p.data("keyPressed");i&&(t[i]=!0),u.multiple?e&&0===p.closest("td.edt").length&&l(f,t):setTimeout((function(){l(f,t)}),200),p.data("changed",!1)})),p.on("show.bs.select",(function(){d(m)})),p.on("shown.bs.select",(function(){let t=p.data("selectpicker");t.$bsContainer.addClass("pcTable-selectpicker"),h.isPreview&&t.$bsContainer.addClass("select-with-preview"),t.$menuInner.height()<100&&t.$menuInner.find("li").length>6&&t.$menuInner.height(300);let i=t.$menu.get(0).getBoundingClientRect();if(i.right>e.innerWidth-20){let n=i.right-e.innerWidth+20,a=t.$menuInner.width();t.$menuInner.width(a-n).css("overflow-x","scroll")}else t.$menuInner.width("auto");t.cropped||(t.cropped=!0,p.data("container").is(".pcTable-container")&&t.$menuInner.height(t.$menuInner.height()-4))})),p.on("changed.bs.select",(function(){p.data("changed",!0);let e=[];if(m&&m.forEach&&m.forEach((function(t){e.push(t)})),m=p.val(),"filter"===u.category&&u.multiple){let t=m.length;if(e.length>m.length)0===m.length&&m.push("*NONE*");else{let t;m.some((function(i){if(-1===e.indexOf(i))return t=i,!0})),-1!==["*NONE*","*ALL*"].indexOf(t)?m=[t]:["*NONE*","*ALL*"].some((function(e){let t;if(-1!==(t=m.indexOf(e)))return m.splice(t,1),!0}))}m.length!==t&&p.selectpicker("val",m)}})),p.on("remove",(function(){p.data("selectpicker").$bsContainer.remove(),p.data("container").off("keydown.selectContainer."+p.data("AppUin")).off("click.selectContainer."+p.data("AppUin"))})),0===p.closest(".InsertRow, .InsertPanel").length&&f.find("button").click()}}else g<50&&(setTimeout((function(){v(p,m)}),10*g+1),g++)};return!h||h.isListForLoad?b().then((function(){v.call(u)})):v(),f},getEditPanelText:function(e,t){if(this.multiple)return this.getPanelText(e.v,null,t)},getPanelText:function(e,i,n){let a=this,l=t("<div>"),o=n[a.name].v_;if(!a.multiple&&n[a.name].v_&&(o=[n[a.name].v_]),o)t.each(o,(function(e,i){"use strict";let n=t("<div>").text(i[0]+(a.multiple&&a.unitType?" "+a.unitType:""));i[1]?n.addClass("deleted_value"):1!==o.length&&n.add("select-item"),l.append(n)}));else{if(null===e||""===e)return a.withEmptyVal?a.withEmptyVal:"";let i=e;if(a.multiple||(i=[i]),i||(i=[]),a.list){let e=[];for(let t=0;t<i.length;t++)e[t]=i[t].toString();for(let i=0;i<a.list.length;i++){let n=a.list[i];if(-1!==e.indexOf(n[2].toString())){let i=t("<span>").text(n[0]);n[1]?i.addClass("deleted_value"):1!==e.length&&i.add("select-item"),l.append(i)}}}}return l.children()},getCellText:function(e,i,n){let a=this,l=t("<div>"),o=n[a.name].v_;if(!a.multiple&&n[a.name].v_&&(o=[n[a.name].v_]),o)a.multiple&&o.length>1&&0==a.multySelectView?l.append('<span class="select-item">'+o.length+" элементов<span>"):0===o.length?l.append('<span class="select-item">'+this.getElementString(null)+"</span>"):t.each(o,(function(i,n){"use strict";let s=t("<span>"),r=null;e&&(r="object"==typeof e?e[i]:e),s.text(a.getElementString(r,n)),n[1]?s.addClass("deleted_value"):1!==o.length&&s.add("select-item"),l.append(s)}));else{if(null===e||""===e)return a.withEmptyVal?a.withEmptyVal:"";let i=e;if(a.multiple||(i=[i]),i||(i=[]),a.list){let e=[];for(let t=0;t<i.length;t++)e[t]=i[t].toString();for(let i=0;i<a.list.length;i++){let n=a.list[i];if(-1!==e.indexOf(n[2].toString())){let i=t("<span>").text(a.getElementString(n[2],n));n[1]?i.addClass("deleted_value"):1!==e.length&&i.add("select-item"),l.append(i)}}}}return l.children()},focusElement:function(e){let t=e.find("button"),i=this;0==t.length?setTimeout((function(){i.focusElement(e)}),50):t.focus()},isDataModified:function(e,t){return(-1===[null,""].indexOf(e)||-1===[null,""].indexOf(t))&&(-1!==[null,""].indexOf(e)||-1!==[null,""].indexOf(t)||!Object.equals(t,e))},checkEditRegExp:function(e){if(!this.warningEditRegExp)return!0;try{return this.multiple&&Array.isArray(e)?e.some(t=>new RegExp(this.warningEditRegExp).test(e)):new RegExp(this.warningEditRegExp).test(e)}catch(e){return!0}},addDataToFilter:function(e,t){const i=function(t){let i,n=t[0],a="Пустое";null===n||""===n?i="".hashCode():(i=n.toString().hashCode(),a=n.replace(/"/g,"&quot;")),e[i]=a};this.multiple?t&&t.v_.length?t.v_.forEach((function(e){i(e)})):i({0:""}):i(t.v_)},getElementString:function(e,t){"use strict";let i;return null==e&&(t&&t[0]||(i=this.withEmptyVal||"")),void 0!==i||null!==t[0]&&""!==t[0]||(i="["+(this.withEmptyVal||"")+"]"),void 0===i&&(i=t[0]),this.multiple&&this.unitType&&(i+=" "+this.unitType),i},sourceButtonClick:function(i,n){let a=t.Deferred(),l={},o=this,s=this.pcTable;t.each(i,(function(e,t){"$"!==e.substring(0,1)&&(l[e]=t)})),n&&(l[o.name]=null);let r,d=0;return t(e.top.document.body).on("pctable-opened.select-"+o.name,(function(){d++})).on("pctable-closed.select-"+o.name,(function(e,i){d--,i&&i.json&&(r=i);let n=i&&"insert"===i.method&&i.json&&i.json.chdata&&i.json.chdata.rows;setTimeout((function(){(0===d||n)&&(t("body").off(".select-"+o.name),a.resolve(r))}),100)})),s.model.selectSourceTableAction(o.name,l),a}},function(){t.jstree;r.tree={icon:"fa-tree",FullView:!1,getEditVal:function(e){return e.data("val")},getEditElement:function(e,i,n,a,l,o,s,r){let d,c,p=this,f=e||t("<div>"),h=f.data("dialog")||t("<div>").css("min-height",200);f.data("dialog",h),i=i.v||"";const u=function(e,t,i){let n=[];h.data("jstree").jstree("get_selected",!0).forEach((function(e){n.push(e.id)})),p.multiple||(n=n[0]||""),f.data("val",n),i||(a(f,{}),e.close())};let m=function(e){p.treePanel.call(p,h,n,i)};d=[];let b={label:"Сохранить",cssClass:"btn-m btn-warning",action:u},g={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){l(f,{}),e.close()}},v="<b>"+this.title+"</b>",w="ctrlS.commentdialog";const _=function(e){p.pcTable.isMobile||(e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:.8*t("body").width()>800?800:.8*t("body").width()})),0===e.$modalBody.find("textarea").length&&m(),t("body").on(w,(function(t){u(e,0,!1)}))};if(r){let e=!1;setTimeout((function(){let i=f.closest("td").find(".cdiv");i.length>0?(i.data("bs.popover").options.content.find(".btn").each((function(){c=t(this);let i={};i.label=c.data("name"),i.cssClass=c.attr("class").replace("btn-sm","btn-m"),i.icon=c.find("i").attr("class"),i.save=c.data("save"),i.click=c.data("click"),i.action=function(t){i.save&&u(t,0,!0),i.click({}),e=!0,t.close()},d.push(i)})),i.popover("destroy")):(d.push(b),d.push(g)),p.pcTable.isMobile?App.mobilePanel(v,h,{buttons:d,onhide:function(i){t("body").off(w),e||o(f,{})},onshow:_}):BootstrapDialog.show({message:h,type:null,title:v,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:d,onhide:function(i){t("body").off(w),e||o(f,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"})},onshow:_})}),1),f.text("Редактирование в форме").addClass("edit-in-form")}else{let e=!1;f.off().on("focus click","button",(function(){if(e)return!1;e=!0;let i=d.slice(0);i.push(b),i.push(g);var n=t(this).closest("div");p.pcTable.isMobile?App.mobilePanel(v,h,{buttons:i,onhide:function(i){e=!1,t("body").off(w),l(n,i)},onshow:_}):BootstrapDialog.show({message:h,type:null,cssClass:"fieldparams-edit-panel",title:v,draggable:!0,size:BootstrapDialog.SIZE_WIDE,buttons:i,onhide:function(i){e=!1,t("body").off(w),l(n,i)},onshow:_})})),0===f.find("button").length&&(c=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактирование в форме"),s&&c.attr("tabindex",s),f.append(c))}return f.data("val",i)},treePanel:function(e,i){let n=this,a=t.extend(!0,{},i),l=["themes","json_data","search"];n.multiple&&l.push("checkbox");let o=t('<div class="tree-search"><input class="form-control" type="text"></div>'),s=o.find("input");setTimeout(()=>{s.focus()},200);let r=t("<div></div>"),d=0,c=!1,p="";s.keyup((function(){c&&clearTimeout(c),c=setTimeout((function(){if(r.closest("body").length){let e=s.val();p!==e&&(p=e,r.jstree(!0).search(e,0===d))}}),750)})),e.html(o).append(r),e.data("jstree",r),!this.multiple&&this.withEmptyVal&&r.on("click",'li.jstree-node[aria-selected="true"]',(function(e){return r.jstree(!0).deselect_node(t(this)),!1}));let f=null;r.on("init.jstree",(function(e,i){i.instance.settings.checkbox.cascade="";let l=t.jstree.core.prototype.redraw_node;n.changeSelectTable&&(r.jstree(!0).redraw_node=function(e,i,o,s){let d=l.bind(this)(e,i,o,s),c=r.jstree(!0).get_node(e),p=!0,h=2===n.changeSelectTable&&n.parentName;n.treeAutoTree||(c.original.id.toString().match(/^\d+$/)?h=!1:p=!1);const u=function(){r.jstree(!0).refresh(!1,!0)};let m=t(d).find(">a i:first");if(p&&($icon1=t('<i class="fa fa-edit edit-tree-icon"></i>'),m.after($icon1),$icon1.on("click",()=>(new EditPanel(n.selectTable,null,{id:c.id}).then(()=>{f={},Object.values(r.jstree(!0)._model.data).forEach(e=>{f[e.id]=!!e.state.opened}),u()}),!1)),m=$icon1),h){let e=t('<i class="fa fa-plus edit-tree-icon"></i>');m.after(e),e.on("click",()=>(new EditPanel(n.selectTable,null,{[n.parentName]:{v:c.id.replace("PP/","")}}).then(e=>{if(f={},Object.values(r.jstree(!0)._model.data).forEach(e=>{f[e.id]=!!e.state.opened}),f[c.id]=!0,e.chdata.rows&&Object.keys(e.chdata.rows).length){let t=Object.keys(e.chdata.rows)[0];n.multiply?a[n.name].v.push(t):a[n.name].v=t}u()}),!1))}return d})})).jstree({search:{show_only_matches:!0,case_insensitive:!0,show_only_matches_children:!0,search_callback:function(e,t){if(!t)return!1;let i=e.toLowerCase().replace("ё","е").split(" "),n=t.text.toLowerCase().replace("ё","е");return!i.some((function(e){return-1===n.indexOf(e)}))},ajax:function(e,t){var i=this;n.getEditSelect(a,e,null).then((function(e){t.call(i,e[0])}))}},massload:function(e,t){var i=this;d-=1,n.getEditSelect(a,"",e).then((function(e){Object.values(e[0]).forEach((function(e){e.forEach((function(e){!0===e.children&&(d+=1)}))})),t.call(i,e[0])}))},core:{check_callback:!0,open_parents:!0,data:function(e,t){var i=this;d-=1,n.getEditSelect(a,"","#"==e.id?null:e.id).then((function(e){e[0].forEach((function(e){f&&f[e.id]&&(e.state={opened:!0,...e.state||{}},!0===e.children&&(d+=1))})),t.call(i,e[0])}))},themes:{icons:!1,name:"default"}},checkbox:{},plugins:l}),n.multiple&&"filter"===n.category&&r.on("select_node.jstree",(function(e,t){-1!==["*ALL*","*NONE*"].indexOf(t.node.id)?t.selected.length>1&&t.selected.forEach((function(e){e!==t.node.id&&t.instance.deselect_node(r.jstree(!0).get_node(e))})):["*ALL*","*NONE*"].forEach((function(e){-1!==t.selected.indexOf(e)&&t.instance.deselect_node(r.jstree(!0).get_node(e))}))}))},getEditPanelText(e,t){return this.getCellText(e.v,null,t)},getEditSelect:function(e,i,n){let a=this,l=t.Deferred(),o={};return Object.keys(e).forEach((function(t){/^\$/.test(t)||("id"===t||null===e[t]||"object"!=typeof e[t]||-1===Object.keys(e[t]).indexOf("v")?o[t]=e[t]:o[t]=e[t].v)})),this.pcTable.model.getEditSelect(o,this.name,i,n,!0).then((function(e){let t=[e.list,e.indexed];a.codeSelectIndividual||(a.list=t),a.parentName=e.parent,l.resolve(t)})),l},getPanelText:function(e,t,i){this.FullView=!0;let n=this.getCellText(e,t,i);return delete this.FullView,n},getCellText:function(e,i,n){let a=this;if("tree"===a.name&&n.__tree&&("self"===a.treeViewType||n.tree_category&&n.tree_category.v)){let e=n.__tree,i=n.tree.f||{},a=i.icon||(e.opened?"folder-open":"folder"),l=t('<i class="fa fa-'+a+'"></i>').data("treeRow",e.v),o=t('<span class="tree-view">').css("padding-left",10*e.level).append(l);return!1!==i.expand?(l.addClass("treeRow"),o.append(t('<button class="btn btn-default btn-xxs treeRow dbl"><i class="fa fa-arrows-v"></i></button>').data("treeRow",e.v))):l.css("margin-right",8),o.append(i.text||e.t),o}{let i=n[a.name].v_;if(e){if(a.multiple){if(Array.isArray(e)){if(0===e.length)return a.getElementSpan(null);if(1===e.length)return a.getElementSpan(e[0],i[0]);if("0"!==a.multySelectView||a.FullView){let n=t('<span class="select-item">');return e.forEach((e,t)=>n.append(a.getElementSpan(e,i[t]))),n}return t('<span class="select-item">'+e.length+" эл.<span>")}return a.getElementSpan(e,[e,0])}return a.getElementSpan(e,i)}return a.getElementString(null)}},checkIsFiltered:function(e,t){let i,n;return this.multiple?(i=[],e&&e.v_&&e.v_.length&&e.v_.forEach((function(e){i.push(e[0].hashCode().toString())})),n=function(e){if(-1!==i.indexOf(e))return!0}):(i=null===e.v_[0]?"null":e.v_[0].toString(),i=i.hashCode().toString(),n=function(e){if(e===i)return!0}),t.some(n)},addDataToFilter:function(e,t){const i=function(t){let i;i=null===t[0]?"null".hashCode():t[0].toString().hashCode(),e[i]=t[0].replace(/"/g,"&quot;")};this.multiple?t&&t.v_.length&&t.v_.forEach((function(e){i(e)})):i(t.v_)},getElementSpan:function(e,i){let n=t("<span>");return null!==e&&(n.text(this.getElementString(e,i)),1===i[1]&&n.addClass("deleted_value")),n},getElementString:function(e,t){"use strict";return null!=e||t&&t[0]?null===t[0]||""===t[0]?"["+(this.withEmptyVal||"")+"]":this.FullView&&t[2]||t[0]:this.withEmptyVal||""}}}(),r.json={__addInput:function(e,i,n){var a=(i=i||{}).type||typeof n[e],l=12;"checkbox"==a&&(l=3),i.width&&(l=i.width);var o,s=t('<div class="field form-group">').attr("data-name",e).addClass("col-sm-"+l);switch(a){case"string":o=t("<input>").val(n[e]?n[e]:i.default?i.default:"");break;case"json":o=t('<div class="JSONEditor">').height(300);var r=new JSONEditor(o.get(0),{}),d=t('<a href="#">editText</a>').on("click",(function(){var e=t("<div>"),i=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(r.get(),null,2)).appendTo(e);return e.dialog({title:"Содержимое JSON-поля",width:500,height:600,buttons:{"Сохранить":function(){r.setText(i.val()),e.dialog("close")},"Закрыть":function(){e.dialog("close")}}}),!1}));o.find(".jsoneditor-menu").append(d),o.data("editor",r),r.set(n[e]?n[e]:i.default?JSON.parse(i.default):{});break;case"html":o=t('<div class="HTMLEditor">').height(300);var c=t("<div>").appendTo(o);r=CodeMirror(c.get(0),{value:n[e]?n[e]:i.default?i.default:"",mode:"text/html",height:"250px",readOnly:!1,theme:"eclipse",lineNumbers:!0,gutter:!0,indentWithTabs:!0,autoCloseTags:!0});setTimeout((function(){r.refresh()}),20),o.data("editor",r);break;case"integer":o=t("<input>").val(n[e]?n[e]:i.default?i.default:"").attr("type","number"),void 0!==i.min&&o.attr("min",i.min),void 0!==i.max&&o.attr("max",i.max),void 0!==i.step&&o.attr("step",i.step);break;case"checkbox":o=t("<input>").attr("type","checkbox"),(n[e]||void 0===n[e])&&o.prop("checked",!0);break;case"select":o=t("<select>"),i.values&&t.each(i.values,(function(e,i){o.append(t("<option>").attr("value",e).text(i))})),n[e]?o.val(n[e]):void 0===n[e]&&i.default&&o.val(i.default)}"checkbox"==a?(s.prepend(t("<label>").text(i.title?i.title:e).addClass("form-check-label")),o&&(o.data("type",a),s.find("label").prepend(o))):(s.prepend(t("<label>").text(i.title?i.title:e)),o&&o.data("type",a).addClass("form-control"),s.append(o)),s.data("type",a);var p=t(" <span>*</span>");return i.required?p.addClass("text-danger"):(p.text(""),p.addClass("glyphicon glyphicon-remove remove"),p.on("click",(function(){var e=t(this).closest(".field");e.data("name");e.remove()}))),s.find("label").after(p),s},getEditElement:function(e,i,n,a,l,o){var s,r=this,d=t("<div>"),c=t("<div>").css("min-height",200),p=t('<div class="jsonForm row">').appendTo(c);d.data("form",p),d.data("field",this);var f=this.jsonFields,h=i||{};"string"==typeof h&&(h=JSON.parse(h));var u=function(e){var t=r.__addInput(e,f[e],h);p.append(t)},m=t.extend({},h),b=0,g={"":[]};if(t.each(f,(function(e,t){if(1==t.required||1==t.showInForm)u(e),void 0!==m[e]&&delete m[e];else if(void 0===m[e]){var i="";t.fGroup&&(i=t.fGroup,g[t.fGroup]||(g[t.fGroup]=[])),g[i].push(e),b++}})),t.each(m,(function(e,t){u(e)})),b){var v=t('<div class="row elseFields">');let e=t('<select class="selectpicker form-control dropup" data-size="5" data-title="--Выбрать поле--">');1==App.keys(g).length?t.each(g[App.keys(g)[0]],(function(i,n){e.append(t("<option>").attr("value",n).text(f[n].title?f[n].title:n))})):t.each(g,(function(i,n){i=t('<optgroup label="'+i+'">');t.each(n,(function(e,n){i.append(t("<option>").attr("value",n).text(f[n].title?f[n].title:n))})),e.append(i)})),v.prepend(t("<label>").text("Добавить поле")),e.addClass("form-control"),v.append(e),e.selectpicker("render"),e.on("change",(function(){var i=t(this).val();e.find('option[value="'+i+'"]').remove(),u(i)})),c.append(v.wrap('<div style="padding:10px">').parent())}return s={"Сохранить":function(){var e={},i=p.find(".fullJSONEditor");1==i.length?e=i.data("editor").get():p.find("input, select, textarea, .JSONEditor, .HTMLEditor").not(".JSONEditor *").not(".HTMLEditor *").each((function(){var i=t(this),n=i.closest(".field").data("name");switch(i.closest(".field").data("type")){case"array":try{if(e[n]=i.data("editor").get(),!t.isArray(e[n]))throw"Ошибка структуры поля"}catch(e){throw App.notify("Ошибка структуры поля "+n),"Ошибка структуры поля"}break;case"object":case"json":try{if(e[n]=i.data("editor").get(),"object"!=typeof e[n])throw"Ошибка структуры поля"}catch(e){throw App.notify("Ошибка структуры поля "+n),"Ошибка структуры поля"}break;case"html":e[n]=i.data("editor").getValue();break;case"checkbox":case"boolean":e[n]=!!i.is(":checked");break;case"integer":e[n]=parseInt(i.val());break;default:e[n]=i.val()}})),d.data("val",JSON.stringify(e)),a(d,event),c.remove()},"Закрыть":function(){c.dialog("close")},"Редактор":function(){var e=p.height(),i=t('<div class="fullJSONEditor">').height(e+100),n=new JSONEditor(i.get(0),{});n.set(h);var a=t('<a href="#">editText</a>').on("click",(function(){var i=t("<div>"),a=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(n.get(),null,2)).appendTo(i);return i.dialog({title:"Содержимое JSON-поля",width:500,height:e+100,buttons:{"Сохранить":function(){n.setText(a.val()),i.dialog("close")},"Закрыть":function(){i.dialog("close")}}}),!1}));p.empty().append(i),p.next().empty(),i.data("editor",n),i.find(".jsoneditor-menu").append(a)}},n.id?(c.dialog({title:(n&&n.id?n.id:"")+" "+this.title,width:700,modal:!0,close:function(e){l(d,e),c.remove()},buttons:s}),d.text("Редактирование в форме").addClass("edit-in-form")):(d.on("focus click","button",(function(){var e=t(this).closest("div");c.dialog({title:r.title||r.name,width:700,modal:!0,close:function(t){l(e,t),c.remove()},buttons:s})})),d.append(t('<button class="btn btn-default">').text(i||"Редактирование"))),d.data("val",i)},getEditVal:function(e){return e.data("val")},getCellText:function(e){return JSON.stringify(e)},focusElement:function(e){var t=e.find("button"),i=this;0===t.length?setTimeout((function(){i.focusElement(e)}),50):t.focus()}},r.fieldParams=t.extend({},r.json,{icon:"fa-code",isPanelField:!0,isDataModified:function(e,t){return!Object.equals(t,e)},getEditVal:function(e){return e.data("checkVal")&&e.data("checkVal")(),e.data("val")},getEditElement:function(i,n,a,l,o,s,r,d,c){let p,f=this,h=t("<div>"),u=t("<div>").css("min-height",200),m=t('<div class="jsonForm">').appendTo(u);i&&(h=i,m=h.find(".jsonForm")),h.data("form",m),h.data("field",this);let b,g=!1,v=function(){};try{b=c.data("firstLoad").data_src.v}catch(e){}let w=function(e){let i,n,l=f.jsonFields;f.getValue(e,a,!d).then((function(e){let o=e.value;"string"==typeof o&&(o=JSON.parse(o));let s=t.extend({},o),r=function(e,o,r){let d=l.fieldSettings[e];if(!d)return!1;if(d.categories&&-1===d.categories.indexOf(a.category.v))return!1;if(d.names&&-1===d.names.indexOf(a.name.v))return!1;let c={};switch(void 0===s[e]||void 0===s[e].isOn?(c.isOn=void 0!==s[e],c.Val=s[e],void 0===c.Val&&(c.Val=d.default),d.parent||"checkbox"!==d.type||!0!==c.Val||(c.isOn=!0),s[e]=c):c=s[e],e){case"codeSelect":let e="=: selectRowListForTree(table: ''; field: ''; order: '' asc; where:  '' = ; parent: ''; disabled:)";"tree"===m.find('div[data-name="type"] select').val()?c.Val===d.default&&(c.Val=e):c.Val===e&&(c.Val=d.default)}let p=!1,h=(l.fieldSettings[d.parent],s[d.parent]);d.parent&&-1!==o.indexOf(d.parent)&&(h&&!0===h.isOnCheck||(p=!0)),c.changed=function(){"use strict";!0===this.isOnCheck?m.find('[data-parent="'+e.toLowerCase()+'"]').show():m.find('[data-parent="'+e.toLowerCase()+'"]').hide().find('input[type="checkbox"]').prop("checked",!1).trigger("change")};let u=f.__addInput.call(f,e,d,c,a,v);if("center"!==(d.align||"center")){if(!i){let e=t('<div class="fParams-grid">');i=t("<div>").appendTo(e),n=t("<div>").appendTo(e),m.append(e)}"left"===d.align?i.append(u):n.append(u)}else m.append(u),i=n=null;d.parent&&(u.attr("data-parent",d.parent.toLowerCase()),p&&u.hide());let b=r[e]();return u.css("padding-left",19*b),u},d="string";s.type&&(d=s.type.Val||s.type);!async function e(i){let n;m.empty(),("2"!==a.table_id.v||"data_src"!==a.name.v&&"data"!==a.name.v)&&(!a.table_name||"tables_vidgets"!==a.table_name.v||"data_src"!==a.name.v&&"data"!==a.name.v)?n=l.fieldListParams[i]:(n="data"===a.name.v?["width","showInWeb"]:["width","jsonFields","showInWeb","editable","insertable","required","logging","default","copyOnDuplicate"],i="fieldParams"),"chart"===i&&(f.pcTable.chartTypes||(f.pcTable.chartTypes=(await f.pcTable.model.getChartTypes()).chartTypes),l.fieldSettings.chartType.values={},f.pcTable.chartTypes.map(e=>{l.fieldSettings.chartType.values[e.type]=e.title}));let o={type:function(){return 0}};n.forEach((function(e){let t=l.fieldSettings[e];t.parent&&-1!==n.indexOf(t.parent)?o[e]=function(){return o[t.parent]()+1}:o[e]=function(){return 0}})),s.type={isOn:!0,Val:i},r("type",n,o).find("select").on("change",(function(){e(t(this).val())})),n.forEach((function(e){r(e,n,o)})),u.find(".codeEditor, .HTMLEditor").each((function(){t(this).data("editor")&&t(this).data("editor").refresh()}))}(d)}))};const _=function(e){if(e&&e.close||!d){var i={},n=m.find(".fullJSONEditor");1===n.length?i=n.data("editor").get():m.find("input, select, textarea, .JSONEditor, .HTMLEditor, .codeEditor").not(".JSONEditor *").not(".HTMLEditor *").not(".codeEditor *").not('input[data-type="switcher"]').each((function(){var e=t(this);let n,a=e.closest(".field");var l=a.data("name");switch(e.closest(".field").data("type")){case"code":n=e.data("editor").getValue();break;case"json":try{if(n=e.data("editor").get(),"object"!=typeof n)throw"Ошибка структуры поля"}catch(e){throw App.notify("Ошибка структуры поля "+l),"Ошибка структуры поля"}break;case"html":n=e.data("editor").getValue();break;case"checkbox":n=!!e.is(":checked");break;case"integer":n=parseInt(e.val());break;default:n=e.val()}let o;isOnCheckbox=a.find('input[data-type="switcher"]'),o=0===isOnCheckbox.length?e.is(":visible"):isOnCheckbox.is(":checked"),i[l]={isOn:o,Val:n}})),h.data("val",i),g=!0,e&&e.close&&(l(h,event),e.close())}};d||h.data("checkVal",_),p=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:_},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];return d?(e.top.BootstrapDialog.show({message:u,type:BootstrapDialog.TYPE_DANGER,title:"Параметры поля <b>"+a.title.v+"</b>",buttons:p,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){g||o(h,e),t("body").off("ctrlS.FieldParams")},onshown:function(e){w(n.v),e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalDialog.width(1e3),t("body").on("ctrlS.FieldParams",(function(t){return setTimeout(()=>{_(e)},10),!1}))}}),h.text("Редактирование в форме").addClass("edit-in-form")):(w(n.v),h.append(m),h.addClass("fieldparams-edit-panel")),h.data("val",n.v).data("input",m)},__addInput:function(i,n,a,l,o){let s=this;var d=(n=n||{}).type;let c,p;c=a.Val,p=a.isOn;var f,h=t('<div class="field form-group">').attr("data-name",i);let u,m=t("<span>").text(n.title?n.title:i);switch(d){case"code":(f=t('<div class="codeEditor">')).data("editor",!0),setTimeout(()=>{var e=t("<div>").appendTo(f),i=CodeMirror(e.get(0),{value:c||(n.default?n.default:""),mode:"totum",height:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,gutter:!1,indentWithTabs:!0});i.on("blur",()=>{o()}),f.data("editor",i),i.getScrollerElement().style.minHeight="150px",i.table=l.table_name&&l.table_name.v?l.table_name.v:null});break;case"string":f=t("<input>").val(void 0!==c?c:n.default?n.default:"");break;case"json":f=t('<div class="JSONEditor">').height(500).on("blur",o);var b=new JSONEditor(f.get(0),{}),g=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Вручную</a>').on("click",(function(){var i=t("<div>"),n=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(b.get(),null,2)).appendTo(i);return BootstrapDialog.show({message:i,type:null,title:"Ручное изменение json-поля",buttons:[{label:"Сохранить",cssClass:"btn-m btn-warning",action:function(t){try{b.setText(n.val()),t.close()}catch(t){e.top.App.modal("Ошибка формата JSON")}}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){},onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1}));if(f.find(".jsoneditor-menu").append(g),"chartOptions"===i){let e=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Заполнить настройками по умолчанию</a>');e.on("click",()=>{let e=t('div[data-name="chartType"] select').val();return s.pcTable.chartTypes.some(t=>{if(t.type==e)return b.setText(JSON.stringify(t.default_options)),!0}),!1}),f.find(".jsoneditor-menu").append(e)}f.data("editor",b);let a="string"==typeof c?JSON.parse(c):c;b.set(a);break;case"html":(f=t('<div class="HTMLEditor">')).data("editor",!0),setTimeout(()=>{var e=t("<div>").appendTo(f),i=CodeMirror(e.get(0),{value:c||(n.default?n.default:""),mode:"text/html",height:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0});i.on("blur",o),i.getScrollerElement().style.minHeight="150px",f.data("editor",i)});break;case"integer":f=t("<input>").val(void 0!==c?c:n.default?n.default:"").attr("type","number"),void 0!==n.min&&f.attr("min",n.min),void 0!==n.max&&f.attr("max",n.max),void 0!==n.step&&f.attr("step",n.step);break;case"checkbox":f=t("<input>").attr("type","checkbox").data("type",d),c&&f.prop("checked",!0);break;case"select":if(f=t("<select>"),n.values){let e,a=n.valIcons||{};n.valuesOrder&&(e=n.valuesOrder.slice(0)),"type"===i&&(l.table_name&&l.name&&"tables_fields"===l.table_name.v&&"data_src"===l.name.v&&(e=["fieldParams"]),t.each(e,(function(e,t){r[t]&&(a[t]="fa "+r[t].icon)})));const o=function(e,i){let n=t("<option>").attr("value",e).text(i);a[e]&&n.data("icon",a[e]),f.append(n)};e?e.forEach((function(e){o(e,n.values[e])})):t.each(n.values,o)}n.multiple&&(f.attr("multiple","multiple"),f.attr("size","2")),f.css("visibility","hidden"),f.outerHeight(34);let p=void 0===c&&n.default?n.default:c;setTimeout((function(){f.selectpicker(),f.css("visibility","visible")}),10),f.val(p)}return a.isOnCheck=!0,"checkbox"===d?(h.prepend(t('<label class="field-param-lable">').html(m).addClass("form-check-label").prepend(f).append('<a href="http://docs.totum.online/polya#fields-settings-'+i+'" target="_blank"><i class="fa fa-question-circle-o"></i></a>')),h.addClass("checkbox"),u=f,f.is(":checked")||(a.isOnCheck=!1,h.addClass("disabled"))):(h.prepend(t('<label class="field-param-lable">').html(m).append('<a href="http://docs.totum.online/polya#fields-settings-'+i+'" target="_blank"><i class="fa fa-question-circle-o"></i></a>')),f&&(f.data("type",d),f.data("editor")||(f.addClass("form-control"),f.on("change",o)),h.append(f)),!0!==n.required&&(u=t('<input type="checkbox" data-type="switcher"/>'),p?(a.isOnCheck=!0,u.prop("checked",!0)):(a.isOnCheck=!1,h.addClass("disabled")),h.find("label").prepend(u).addClass("switcheble"),h.addClass("checkbox"))),u&&u.on("change",(function(){t(this).is(":checked")?!0!==a.isOnCheck&&(a.isOnCheck=!0,h.removeClass("disabled"),a.changed()):!1!==a.isOnCheck&&(a.isOnCheck=!1,h.addClass("disabled"),a.changed()),o()})),h.data("type",d),h},getValue:function(e,i,n){"use strict";if(n){let i=t.Deferred();return i.resolve({value:e||{}}),i}let a={fieldName:this.name};return i.id&&(a.rowId=i.id),this.pcTable.model.getValue(a,this.table_id)},getPanelText:function(e){return JSON.stringify(e,null,2)},getCellText:function(e){return"Настройки поля"}}),r.button={icon:"fa-hand-pointer-o",getPanelText:function(e,t,i){let n=this.getCellText(e,t,i);return n.on("click",()=>(this.pcTable.selectedCells.empty(),this.pcTable.selectedCells.selectPanelDestroy(),this.pcTable._buttonClick(t,this,i),!1)),n.wrap("<div>"),n.parent()},getCellText:function(e,i,n){let a=this,l={};"column"===this.category?n.id?l=t.extend({},a.pcTable.f||{},n.f||{},n[a.name].f||{}):(l.block=!0,n[a.name]&&n[a.name].f&&n[a.name].f.icon&&(l.icon=n[a.name].f.icon)):l=t.extend({},a.pcTable.f||{},n[a.name].f||{}),i&&i.addClass("cell-button");const o=function(e){if(a.td_style&&"function"==typeof a.td_style){let t=a.td_style(l).Button;t&&e.css(t)}else if(n.__td_style&&"function"==typeof n.__td_style){let t=n.__td_style(l);t.Button&&e.css(t.Button),t.td&&i.css(t.td)}else if(a.pcTable.isMobile&&"column"!==a.category){let t={};l.background&&(t.backgroundColor=l.background),l.color&&(t.color=l.color),e.css(t)}};if(l.block||!this.pcTable.control.editing&&!this.pressableOnOnlyRead){let e=t('<button class="btn btn-default btn-xxs button-field" tabindex="-1" disabled>').text(this.buttonText||"");if(o(e),l.text&&e.text(l.text),l.comment){let i;i=t('<i class="cell-icon fa fa-info"></i>'),e.prepend(i),i.attr("title",l.comment)}else if(l.icon){let i=t('<i class="cell-icon fa fa-'+l.icon+'"></i>');e.prepend(i),""===e.text()&&(e.css("text-align","center"),i.css("float","none"))}return e}let s=t('<button class="btn btn-default btn-xxs button-field" tabindex="-1">').text(this.buttonText||"");if(o(s),l.text&&s.text(l.text),l.comment){let e;e=t('<i class="cell-icon fa fa-info"></i>'),s.prepend(e),e.attr("title",l.comment)}else if(l.icon){let e=t('<i class="cell-icon fa fa-'+l.icon+'"></i>');s.prepend(e),""===s.text()&&(s.css("text-align","center"),e.css("float","none"))}return s},btnOK:function(e,t){let i=e.find("button.button-field"),n=this;i.text("Выполнено"),e.data("clicked",!0),setTimeout((function(){e.length&&e.removeData("clicked"),t&&i.replaceWith(n.getCellText.call(n,t[n.name],e,t))}),2e3)}},r.link={icon:"fa-link"},r.comments={icon:"far fa-comments-o",getEditVal:function(e){return e.data("val")},getCellText:function(e){let i=this;if(0===e.n||!e.n)return"";let n=t("<span>"),a=t('<span class="comments">').text(e.c[0]+" "+e.c[1]+": "+e.c[2]).appendTo(n);return e.notViewed&&(a.addClass("notViewed"),i.decorationColor&&a.css("border-bottom-color",i.decorationColor)),n},getValue:function(e,i,n){"use strict";let a=this,l=t.Deferred();if(n)e||(e=[]),l.resolve({value:e});else if(0===e.n||1===e.n&&!e.cuted&&!e.notViewed)e||(e=[]),l.resolve({value:[e.c]});else if(e.n>1&&!e.notViewed&&e.all)l.resolve({value:e.c});else{let e={fieldName:this.name};i.id&&(e.rowId=i.id),l=this.pcTable.model.getValue(e,this.table_id)}return l.then((function(e){if(i[a.name].v.notViewed||i[a.name].notViewed){let e=t.Deferred();e.then((function(){let e;delete i[a.name].v.notViewed,delete i[a.name].notViewed,i.id?e=a.pcTable._getTdByFieldName(a.name,a.pcTable.data[i.id].$tr):(e=a.pcTable._paramsBlock.find('td[data-field="'+a.name+'"]'),e.length||(e=a.pcTable._footersBlock.find('td[data-field="'+a.name+'"]'))),e&&e.length&&(e.find(".notViewed-num").remove(),e.find(".notViewed").removeClass("notViewed"))})),i[a.name].notViewed?a.pcTable.model.setCommentsViewed(i[a.name].v.length,a.name,i.id).then((function(){e.resolve()})):e.resolve()}})),l},getPanelText:function(e,i,n){let a=this,l=t.Deferred(),o=e||n[a.name];const s=function(e){let i=t('<div class="comments">');return t.each(e,(function(e,t){i.append(a.getCommentLine(t))})),setTimeout((function(){i.closest("td").scrollTop(i.height())}),100),i};return o.all?s(o.c):(this.getValue(o,n,!1).then((function(e){l.resolve(s(e.value))})).fail((function(){l.reject()})),l.promise())},getCommentLine:function(e){let i=t('<div class="comments-line">');return i.append(t('<span class="com_dt">').text(e[0])),i.append(" "),i.append(t('<span class="com_author">').text(e[1])),i.append(" "),i.append(t('<span class="com_text">').html(App.textWithLinks(e[2]))),i},getPanelVal:(e,t)=>e,getEditElement:function(e,i,n,a,l,o,s,r){let d,c=this,p=e||t("<div>"),f=p.data("dialog")||t("<div>").css("min-height",200);p.data("dialog",f),i=i.v||"";let h=function(e){c.getValue.call(c,i,n,!r).then((function(e){let i=t('<textarea type="text" style="height:90px;resize: vertical" class="form-control"/>');t.each(e.value,(function(e,t){f.append(c.getCommentLine(t))})),f.append(t('<div class="comments-input">').append(i)),f.data("input",i),i.focus()}))};const u=function(e,t,i){let n=f.find("textarea").val().trim();p.data("val",n),i||(a(p,{}),e.close())};d=[];let m={label:"Сохранить",cssClass:"btn-m btn-warning",action:u},b={label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){l(p,{}),e.close()}},g="Комментарии поля <b>"+this.title+"</b>",v="ctrlS.commentdialog",w=!1;if(r)setTimeout((function(){let e=p.closest("td").find(".cdiv");e.length>0?(e.data("bs.popover").options.content.find(".btn").each((function(){let e=t(this),i={};i.label=e.data("name"),i.cssClass=e.attr("class").replace("btn-sm","btn-m"),i.icon=e.find("i").attr("class"),i.save=e.data("save"),i.click=e.data("click"),i.action=function(e){i.save&&u(e,0,!0),i.click({}),w=!0,e.close()},d.push(i)})),e.popover("destroy")):(d.push(m),d.push(b)),c.pcTable.isMobile?App.mobilePanel(g,f,{buttons:d,onhide:function(e){t("body").off(v),w||o(p,{})},onshown:function(e){h()},onshow:function(e){t("body").on(v,(function(t){u(e,0,!1)}))}}):BootstrapDialog.show({message:f,type:null,title:g,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:d,onhide:function(e){t("body").off(v),w||o(p,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"}),h()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:900}),t("body").on(v,(function(t){u(e,0,!1)}))}})}),1),p.text("Редактирование в форме").addClass("edit-in-form");else{let e=!1;if(p.off().on("focus click","button",(function(){if(e)return!1;e=!0;let i=d.slice(0);i.push(m),i.push(b);var n=t(this).closest("div");c.pcTable.isMobile?App.mobilePanel(g,f,{buttons:i,onhide:function(i){e=!1,t("body").off(v),l(n,i)},onshown:function(e){0===e.$modalBody.find("textarea").length&&h(),t("body").on(v,(function(t){u(e,0,!1)}))}}):BootstrapDialog.show({message:f,type:null,cssClass:"fieldparams-edit-panel",title:g,draggable:!0,size:BootstrapDialog.SIZE_WIDE,buttons:i,onhide:function(i){e=!1,t("body").off(v),l(n,i)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),0===e.$modalBody.find("textarea").length&&h(),e.$modalContent.css({width:900}),t("body").on(v,(function(t){u(e,0,!1)}))}})})),0===p.find("button").length){let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Добавить комментарий");s&&e.attr("tabindex",s),p.append(e)}}return p.data("val",null)},getCellTextInPanel:function(e,t,i,n){return this.getEditPanelText({v:e},i,n)},getEditPanelText:function(e,i,n){if(e){if(e.v.forEach){let i=t("<div>");return e.v.forEach((function(e){i.append(t("<div>").append(t('<span class="date">').text(e[0])).append(t('<span class="user">').text(e[1])).append(t('<span class="text">').text(e[2])))})),i.children()}{let i=t("<div>");return n[this.name]&&n[this.name].v&&n[this.name].v.forEach&&n[this.name].v.forEach((function(e){i.append(t("<div>").append(t('<span class="date">').text(e[0])).append(t('<span class="user">').text(e[1])).append(t('<span class="text">').text(e[2])))})),i.append(t('<div class="new-comment">').text(e.v)),i.children()}}},getValPreview(e){return this.getCellText({c:e[e.length-1],n:e.length})}},r.chart={icon:"fa-bar-chart",getCellText:function(e,i,n){let a=t("<div>");return n[this.name].ch&&this.loadChart(()=>{this.chartSimple(a,n[this.name].ch)}),a},async loadChart(i){if(e.ChartLoaded)e.ChartLoaded.then(i);else{let n,a;e.ChartLoaded=new Promise((e,t)=>{n=e,a=t}),e.ChartLoaded.then(i),t.getScript("/js/lib/chart.js").then(()=>{n()})}},chartSimple:function(i,n){let a=t('<canvas class="ttm-chart"></canvas>');i.html(a);let l={},o={...this.chartOptions};"column"===this.category||this.column?(a.attr("height","23"),l.layout={padding:{left:5,right:5,top:2,bottom:2}},l.scales={yAxes:[{display:!1}],xAxes:[{display:!1}]}):this.f&&this.f.height&&a.attr("height",this.f.height),e.innerWidth<("false"!==(localStorage.getItem("TreeMinimizer")||"false")?600:800)&&(l.layout={...o.layout,padding:{left:5,right:5,top:2,bottom:2}},l.scales={},o.scales&&o.scales.yAxes?l.scales.yAxes=o.scales.yAxes.map(e=>({...e,display:!1})):l.scales.yAxes=[{display:!1}],o.scales&&o.scales.xAxes?l.scales.xAxes=o.scales.xAxes.map(e=>({...e,display:!1})):l.scales.xAxes=[{display:!1}],l.aspectRatio=o.aspectRatioMobile||(o.aspectRatio||2)/1.6);let s=a.get(0).getContext("2d"),r=o.type||"line";delete o.type;let d=n.values.map(()=>new Object);o.data&&o.data.datasets&&(d=o.data.datasets),n.datasets&&(d=n.datasets);let c=o.data||{};c.datasets=d,n.labels&&(c.labels=n.labels),delete o.data,d.forEach((e,t)=>{e.data=n.values[t]}),new Chart(s,{type:r,data:c,options:{...o,...l}}),this.pcTable._container.getNiceScroll&&this.pcTable._container.getNiceScroll().resize(),a.on("contextmenu",()=>!1),a.on("dblclick",()=>{e.top.BootstrapDialog.show({message:"<canvas></canvas>",draggable:!0,title:this.pcTable.__getCellTitle(this),cssClass:"dialog-chart-topper",onshown:e=>{new Chart(e.$modalBody.find("canvas").get(0).getContext("2d"),{type:r,data:c,options:o})}})})}},t.each(r,(function(e,i){r[e]=t.extend({},d,i)})),App.pcTableMain=function(n,a){if(this.data_params=a.params||null,a=t.extend({},{tableRow:{},nSorted:!0,isCreatorView:!1,withCsvButtons:!1,withCsvEditButtons:!1,noDataRowClass:"pcTable-noDataRow",contanerClass:"pcTable-container",tableClass:"pcTable-table",width:null,isTreeView:!1,treeReloadRows:[],tree:[],treeIndex:{},treeSort:[],checkIsUpdated:0,_containerId:"",scrollWrapper:null,tableWidth:0,control:{adding:!1,sorting:!1,deleting:!1,duplicating:!1},dataSorted:[],data:[],dataSortedVisible:[],mainFieldName:"id",insertRow:null,_container:null,_content:null,openedPanels:{},extraClastersBottom:null,extraClastersTop:null,dataSortedClasters:{t:[],m:[],b:[]},ScrollClasterized:null,_innerContainer:null,_header:null,_table:null,LogButton:null,model:null,fields:{},hidedFields:[],fieldCategories:{column:[],params:[],footer:[]},sorted:{field:"",direction:"asc"},_sorting:{},_filterable:!1,filtersClearButton:null,_indexes:{fieldByName:{}},beforeSpaceHide:!0},a),t.extend(this,a,!0),screen.width<=i&&(this.isCreatorView=!1,this.isMobile=!0),this.isCreatorView){if(0===t("#isCreator").length){let i=t('<span id="isCreator" class="btn btn-sm"><i class="fa-user-circle fa"></i></span>'),n=i;this.isMobile||localStorage.getItem("notCreator")?(n.addClass("btn-warning"),t(".plus-top-branch").hide()):n.addClass("btn-danger"),n.on("click",()=>{localStorage.getItem("notCreator")?localStorage.removeItem("notCreator"):localStorage.setItem("notCreator",!0),e.location.reload(!0)}),t("#docs-link").before(i)}(this.isMobile||localStorage.getItem("notCreator"))&&(this.isCreatorView=!1)}if(this.isCreatorView||Object.keys(this.fields).forEach(e=>{this.fields[e].webRoles&&1===this.fields[e].webRoles.length&&1===parseInt(this.fields[e].webRoles[0])&&delete this.fields[e]}),this.hidden_fields=this.hidden_fields||{},0===this.hidden_fields.length&&(this.hidden_fields={}),App.isTopWindow()&&(this.beforeSpaceHide=!1),n){this.refreshArraysFieldCategories(!0);let e=t(n);e.data("pctable",this),this._container=e,this.isCreatorView||this._container.addClass("worker-view"),this._containerId=this._container.attr("id"),this._containerId||(this._containerId="pcTable"+s++,this._container.attr("id",this._containerId)),this._init(),this.render(a.addVars)}else this.initForPanel(a);return this.model.addPcTable(this),this};let c=0;e.EditPanel=function(i,n,a,l,o={}){if(e.top!==e)return e.top.EditPanel.call(e.top,i,n,a,l,o);let s=t.extend(!0,{},a),r=this;r.pcTable=i,r.panelId="panel"+c++;let d=2===i||"object"==typeof i&&2===i.tableRow.id,p=t.Deferred();this.$panel=t('<div class="InsertPanel">'),this.isNewPanel=!0,this.blockedFields={},this.bootstrapPanel=null;let f=s.id?"checkEditRow":"checkInsertRow",h=s.id?"saveEditRow":"add";this.panelType=s.id?"edit":"insert",this.editItem=s||{},t("body").trigger("pctable-opened",{type:"panel"}),r.resolved=!1,r.error={};let u={};this.checkRow=async function(e,i){let n=this;const a=()=>new Promise((function(a,l){r.pcTable.model[f](n.getDataForPost(e),Object.keys(o)).then((function(e){"edit"==r.panelType&&i&&(u=t.extend(!0,{},e.row)),r.editRow.call(r,e),a(r)})).fail(l)}));return r.beforeSave&&!i&&(e=await r.beforeSave(e)),a()},this.saveRow=function(i,n){let a=this.getDataForPost();r.pcTable.model[h](a).then((function(i){if(d){let e=t("#table").data("pctable");e&&e.tableRow.id==r.editItem.table_id.v&&a.data_src.v&&a.data_src.v.width&&e.setColumnWidth(r.editItem.name.v,a.data_src.v.width.Val)}p.resolve(i),r.resolved=!0,t(e.top.document.body).trigger("pctable-closed",{type:"panel",json:i,method:r.panelType,tableId:r.pcTable.tableRow.id}),r.bootstrapPanel.close()})).fail((function(){if(n.length&&n.isAttached()){i.$modal.find(".btn-save").prop("disabled",!1)}}))},this.editRow=function(i){"use strict";let a=!1;r.pcTable.f=i.f||{},r.editItem.f=i.row.f||{};let l=this.$panel.find(">div:first"),s=this.$panel.find(">div:eq(2)"),c=this.$panel.find(">div:eq(3)"),p=[],f=0,h=0,m=0;const b=function(e){return-1!==["text","comments","file","listRow"].indexOf(e.type)||e.multiple?1.5:1};if(l.length||(r.pcTable.fieldCategories.panel_fields.forEach((function(e,n){if("n"===e.name)return;let a=t.extend({},r.pcTable.f||{},r.editItem.f||{},i.row[e.name].f||{});a.hide&&a.hide.extpanel||(f+=b(e),m++)})),f/=2,l=t("<div>").appendTo(this.$panel),p.column1=l,d?(s=t("<div>").appendTo(this.$panel),c=t("<div>").appendTo(this.$panel),p.column2=s,p.column3=c):m>1?(s=t("<div>").appendTo(this.$panel),p.column2=s):this.$panel.css("grid-template-columns","1fr")),r.pcTable.fieldCategories.panel_fields.forEach((function(n,c){let g=r.$panel.find('div.cell[data-field-name="'+n.name+'"]'),v=r.editItem[n.name];r.editItem[n.name]=i.row[n.name],r.isEditable(n)&&(a=!0);let w=t.extend({},r.pcTable.f||{},r.editItem.f||{},r.editItem[n.name].f||{});if(!w.hide||!w.hide.extpanel){if(g.length)g.data("input")&&!w.block?(!v||n.isDataModified(r.editItem[n.name].v,v.v)||n.codeSelectIndividual||"insert"==r.panelType&&n.code&&!n.codeOnlyInAdd||"fieldParams"===n.type)&&r.createCell.call(r,g,n,c,w):r.createCell.call(r,g,n,c,w);else{let i=t('<div class="cell-wrapper" style="position: relative">'),a=t("<label>").text(n.title||n.name).prependTo(i);n.unitType&&a.text(a.text()+", "+n.unitType),t('<div class="btns pull-right">').prependTo(i);let o=b(n);if(i.attr("data-koeff",o),"fieldParams"===n.type)this.$panel.append(i),i.width("100%"),i.attr("data-name",n.name),i.css({"grid-column-start":1,"grid-column-end":4}),g=r.createCell.call(r,g,n,c,w,i);else{if(d)if(0===c)this.$panel.prepend(i.css({"grid-column-start":1,"grid-column-end":4}));else{let e=Math.floor((c+1)/2);7===c&&(e=3),p["column"+e].append(i)}else h>0&&2===m?s.append(i):h<f&&h+o>f||h+o<=f?l.append(i):s.append(i);h+=o,g=r.createCell.call(r,g,n,c,w,i);{let t=e.innerWidth-48;t=d?"auto":1===m?t<790?t:790:t<390?t:390,i.width(t)}}setTimeout(()=>{let e=i.find(".btns").width();e>0&&(e+=3),a.css("max-width","calc(100% -  "+e+"px)")},2),n.linkToSelectTable&&i.append(' <a href="'+n.linkToSelectTable.link+'" class="color-primary-primary" style="font-size: 12px" target="_blank">'+n.linkToSelectTable.title+"</a> ")}if(w.hide&&w.hide.panel?g.parent().css("display","none"):g.parent().css("display",""),g.attr("data-field-name",n.name),g.attr("data-field-type",n.type),"edit"===r.panelType){let e,i=r.editItem[n.name].v;if(e="fieldParams"===n.type||Object.equals(u[n.name].v,i),e&&u[n.name].h==r.editItem[n.name].h?g.parent().removeClass("edited"):"comments"===n.type?"string"==typeof r.editItem[n.name].v&&r.editItem[n.name].v.length?g.parent().addClass("edited"):g.parent().removeClass("edited"):g.parent().addClass("edited"),n.code&&!n.codeOnlyInAdd){let e=g.parent().find(".btns button.handled");e.length||(e=t('<button class="btn btn-sm btn-default handled" tabindex="'+(2*c+2)+'"></button>'),g.parent().find(".btns").prepend(e),r.isEditable(n)?(e.on("click",(function(){!0===r.editItem[n.name].h?r.editItem[n.name].h=!1:r.editItem[n.name].h=!0,r.checkRow()})),e.prop("disabled",!1)):(e.prop("disabled","disabled"),r.editItem[n.name].h||e.remove())),e.removeClass("btn-warning").addClass("btn-default"),e.html('<i class="fa fa-hand-grab-o"></i>'),r.editItem[n.name].h&&(e.addClass("btn-warning").removeClass("btn-default"),-1!==Object.keys(r.editItem[n.name]).indexOf("c")&&r.editItem[n.name].c!==r.editItem[n.name].v&&e.html('<i class="fa fa-hand-paper-o"></i>'))}}else if(n.code&&!n.codeOnlyInAdd){let e=g.parent().find(".btns"),i=e.find(".handled");o[n.name]&&r.editItem[n.name].h?0===i.length&&(i=t('<button class="btn btn-sm btn-warning handled" tabindex="'+(2*c+2)+'"><i class="fa fa-hand-paper-o pull-right"></button>').on("click",()=>{delete o[n.name],r.checkRow()}),e.prepend(i)):1===i.length&&i.remove()}}}),r),r.isNewPanel){let e="";if("edit"===this.panelType){let t;switch(r.pcTable.tableRow.id){case 1:if(r.pcTable.tableRow.main_field&&r.pcTable.fields[r.pcTable.tableRow.main_field]){let e=r.pcTable.tableRow.main_field;t=r.editItem[e]||i.row[e],t&&(t=t.v),t=' "'+t+'"'}t=t?"id "+(r.editItem.id||i.row.id)+" "+t:"id "+(r.editItem.id||i.row.id),e=!r.pcTable.control.editing||i.row.f.block&&!a?"Просмотр настроек таблицы <b> "+t+"</b>":"Редактирование настроек таблицы <b> "+t+"</b>";break;case 2:if(r.pcTable.tableRow.main_field&&r.pcTable.fields[r.pcTable.tableRow.main_field]){let e=r.pcTable.tableRow.main_field;t=r.editItem[e]||i.row[e],t&&(t=t.v),t=' "'+t+'"'}t=t?"id "+(r.editItem.id||i.row.id)+" "+t:"id "+(r.editItem.id||i.row.id),e=!r.pcTable.control.editing||i.row.f.block&&!a?"Просмотр поля таблицы "+r.editItem.table_name.v+"<b> "+t+"</b>":"Редактирование поля таблицы "+r.editItem.table_name.v+" <b> "+t+"</b>";break;default:if(r.pcTable.tableRow.main_field&&r.pcTable.fields[r.pcTable.tableRow.main_field]){let e=r.pcTable.tableRow.main_field;t=r.editItem[e]||i.row[e],t&&(t=t.v),t=' "'+t+'"'}t=t?"id "+(r.editItem.id||i.row.id)+" "+t:"id "+(r.editItem.id||i.row.id),e=!r.pcTable.control.editing||i.row.f.block&&!a?"Просмотр <b> "+t+"</b> таблицы <b>"+r.pcTable.tableRow.title+"</b>":"Редактирование <b> "+t+"</b> таблицы <b>"+r.pcTable.tableRow.title+"</b>"}}else switch(r.pcTable.tableRow.id){case 1:e="Добавление таблицы";break;case 2:e="Добавление поля";break;default:e="Добавление строки в таблицу <b>"+r.pcTable.tableRow.title+"</b>"}r.cleateBootstrapPanel.call(r,e,n,"insert"===r.type||a),r.isNewPanel=!1}},this.cleateBootstrapPanel=function(i,n,a){let o,s=this,c=[];a&&(o=function(e,i){"use strict";if(Object.keys(r.error).length){let e=Object.keys(r.error)[0],i=r.error[e];return App.notify(i,t("<div>Ошибка в поле </div>").append(" в поле ").append(t("<span>").text(r.pcTable.fields[e].title))),!1}let n=e.$modal.find(".btn-save").prop("disabled","disabled");r.beforeSave&&r.beforeSave(),setTimeout((function(){r.pcTable.model.doAfterProcesses((function(){s.saveRow.call(s,e,n)}))}),250)},c.push({action:o,cssClass:"btn-warning btn-save",label:"Cохранить"})),l?(s.close=function(){p.resolve(void 0,!0),t(e.top.document.body).trigger("pctable-closed",{type:"panel"}),r.resolved=!0,s.bootstrapPanel.close()},c.push({action:s.close,label:null,icon:"fa fa-"+(!0===l?"arrow-right":"times"),cssClass:"btn-m btn-default btn-empty-with-icon"})):(s.close=function(){s.bootstrapPanel.close()},c.push({action:s.close,label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon"}));s.bootstrapPanel=BootstrapDialog.show({type:n||null,size:BootstrapDialog.SIZE_WIDE,message:s.$panel,cssClass:"edit-row-panel"+(d?" edit-field-panel":""),title:i,buttons:c,draggable:!0,onhidden:function(){t("body").off("ctrlS.EditPanel"),p.resolve(),r.resolved||t(e.top.document.body).trigger("pctable-closed",{type:"panel"}),t(e.top.document.body).off("."+r.panelId)},onshown:function(e){"use strict";o&&t("body").on("ctrlS.EditPanel",(function(i){1===t(".bootstrap-dialog").length&&(t(document.activeElement).blur(),o(e))})),e.indexedButtons[Object.keys(e.indexedButtons)[0]].attr("tabindex",500),2===Object.keys(e.indexedButtons).length&&e.indexedButtons[Object.keys(e.indexedButtons)[1]].attr("tabindex",501)}}),s.bootstrapPanel.$modalFooter.find(".btn-save").length&&(s.saveButton=s.bootstrapPanel.$modalFooter.find(".btn-save"))},this.createCell=function(i,n,a,l,s){let c=r.editItem||{};c[n.name]=c[n.name]||{},i.removeClass("error"),0===i.length?(i=t("<div data-name='"+n.name+"' class='cell'>").appendTo(s),n.code&&i.addClass("with-code")):s=i.parent();let p=s.find(".btns");if(p.find(".select-btns").remove(),!this.isEditable(n)){r.blockedFields[n.name]=!0;let e=t('<div class="'+("button"===n.type?"link":"")+' ttm--panel-data">');if("button"!==n.type&&l.text?e.text(l.text):(r.editItem[n.name].v||"button"===n.type)&&e.append(n.getCellTextInPanel(r.editItem[n.name].v,i,r.editItem,u)),"button"!==n.type)if(l.comment){let i;i=t('<i class="cell-icon fa fa-info"></i>'),e.prepend(i),i.attr("title",l.comment)}else l.icon&&e.prepend('<i class="cell-icon fa fa-'+l.icon+'"></i>');return n.unitType&&e.append(" "+n.unitType),"button"===n.type&&r.pcTable?i.on("click",(function(){r.pcTable._buttonClick.call(r.pcTable,i,n,c)})):n.CodeActionOnClick&&!s.find(".edit-btn").length&&s.append(t('<button class="btn btn-sm btn-default edit-btn" style="width: 100%"><i class="fa fa-hand-pointer-o"></i></button>').on("click",()=>{r.pcTable.model.dblClick(c.id,n.name).then(e=>{})})),i.html(e).data("input",null),i}r.blockedFields[n.name]=!1;let f=async function(e){let t;try{t=n.getEditVal(e),i.removeClass("error"),delete r.error[n.name]}catch(t){if("name"===n.name&&d){return delete o.name,(await r.checkRow()).editItem.name.v}return r.error[n.name]=t,i.addClass("error"),App.popNotify(t,e,"default"),null}return t},h=!1,m=(i.find("input,button").is(":focus"),async function(e,t,i){h=!0;let l=await f(e);if(null===l)Object.keys(r.error).length||r.FocusIt.call(r,a);else if(i||r.FocusIt.call(r,a+1),n.isDataModified(l,r.editItem[n.name].v)){let e={};if(e[n.name]={v:l},n.code&&!n.codeOnlyInAdd&&(e[n.name].h=!0),n.code&&"insert"===r.panelType&&(o[n.name]=!0),d)switch(n.name){case"table_id":delete o.version}r.checkRow(e)}h=!1}),b=function(e,t){return setTimeout((function(){e&&e.length&&e.isAttached()&&(h?h=!1:m(e,0,!0))}),40),!1},g=function(e,t){m(e)};i.data("firstLoad",u);let v,w=n.getEditElement(i.data("input"),r.editItem[n.name],r.editItem,m,g,b,50+a,!1,i);if(d&&"fieldParams"===n.type&&(r.beforeSave=async function(e){let t=await f(w);if(r.editItem[n.name]={v:t},e)return e[n.name]={v:t},e}),w.isAttached()||i.html(w),i.data("input",w),"select"===n.type&&n.changeSelectTable){let a=function(){let a=r.getDataForPost(),l=t(this).is(".source-add");l&&(a[n.name]=null);let o=0;t(e.top.document.body).on("pctable-opened.select-"+r.panelId,(function(){o++})).on("pctable-closed.select-"+r.panelId,(function(e,a){o--;let s=a&&"insert"===a.method&&a.json&&a.json.chdata&&a.json.chdata.rows;setTimeout((function(){if(0===o||s){let e=w;delete n.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),s&&(n.multiple?r.editItem[n.name].v.push(Object.keys(a.json.chdata.rows)[0]):r.editItem[n.name].v=Object.keys(a.json.chdata.rows)[0]),e.replaceWith(w=n.getEditElement(null,r.editItem[n.name],r.editItem,m,g,b)),i.data("input",w),r.checkRow(),!l&&r.pcTable.isMain&&r.pcTable.model.refresh((function(e){r.pcTable.table_modify.call(r.pcTable,e)})),t("body").off(".select-"+r.panelId)}}),100)})),r.pcTable.model.selectSourceTableAction(n.name,a)},l=t('<span class="select-btns">').appendTo(p),o=t('<button class="btn btn-default-primary btn-sm"><i class="fa fa-edit"></i></button>');if(l.append(o),o.on("click",a),2===n.changeSelectTable){let e=t('<button class="btn btn-default-primary btn-sm source-add"><i class="fa fa-plus"></i></button>');l.append(e),e.on("click",a)}}if(n.getEditPanelText&&(v=n.getEditPanelText(r.editItem[n.name],r.editItem,u))){let e=i.find(".ttm--panel-data");e.length||(e=t('<div class="ttm--panel-data"/>').prependTo(i)),e.html(v),"comments"===n.type&&setTimeout(()=>{e.scrollTop(2e4)})}return i},this.getDataForPost=function(e={}){let t={};return r.editItem.id&&(t.id=r.editItem.id),r.pcTable.fieldCategories.panel_fields.forEach((function(i){let n=e[i.name]||r.editItem[i.name];"comments"==i.type&&n&&"string"!=typeof n.v&&(n.v=null),n&&r.isEditable(i)?(t[i.name]={},"edit"===r.panelType?(t[i.name].v=n.v,i.code&&!i.codeOnlyInAdd&&(t[i.name].h=n.h||!1),t[i.name].v=i.getPanelVal.call(i,t[i.name].v,r.$panel.find('div.cell[data-field-name="'+i.name+'"]').data("input"))):(t[i.name]=n.v,t[i.name]=i.getPanelVal.call(i,t[i.name],r.$panel.find('div.cell[data-field-name="'+i.name+'"]').data("input")))):a[i.name]&&"insert"===r.panelType&&(t[i.name]=a[i.name].v)})),t},this.isEditable=function(e){if(!r.pcTable.control.editing)return!1;return!0!==t.extend({},r.pcTable.f||{},r.editItem.f||{},r.editItem[e.name].f||{}).block&&("insert"===this.panelType?e.insertable:e.editable)},this.FocusIt=function(e){return!1};const m=()=>{};return"object"!=typeof r.pcTable?App.getPcTableById(r.pcTable).then((function(e){r.pcTable=e,e.isPanel=!0,e._refreshContentTable=m,r.checkRow({},!0),r.editItem.id&&e.model.setLoadedTableData({[r.editItem.id]:{}})})):r.pcTable[0]?App.getPcTableById(r.pcTable[0],{sess_hash:r.pcTable[1]}).then((function(e){r.pcTable[2]&&e.model.setLoadedTableData(r.pcTable[2]),r.pcTable=e,e.isPanel=!0,e._refreshContentTable=m,r.checkRow({},!0)})):r.checkRow({},!0),p.promise()},function(){let i,n=!1;t.extend(App.pcTableMain.prototype,{switchContainerNideScroll:function(e){let t=this;t.isAnonim||(i&&clearTimeout(i),i=setTimeout(()=>{e!==n&&(e?t._container.niceScroll({cursorwidth:7,mousescrollstep:90,scrollspeed:50,autohidemode:!1,enablekeyboard:!1,cursoropacitymin:1,railoffset:{left:-3},cursorcolor:"#e1e0df"}):t._container.getNiceScroll().remove(),n=e)},100))},addScrollsRules:function(){let e=this;this._innerContainer.append(this._table),e.isMobile||(this._innerContainer.on("scroll",(function(){"use strict";e._removeEditCell()})),e.withoutScrolls||t((function(){e.switchContainerNideScroll(!0)})))},Scroll:function(){let i,n=this,a={};a.table=void 0;let l=!1,o=0,s=function(){let e=r();l!=(l=a.getClusterNum(e))&&a.insertToDOM(l);let i=t("table.pcTable-table");i.find("thead").height()+i.offset().top-t("#table").offset().top<=0?a.table?a.table.css({top:parseInt(t("#table").offset().top)-parseInt(t(".innerContainer").offset().top)}):function(){if(!a.table){a.table=t('<table class="scroll-head-row">').appendTo(n._innerContainer),a.table.width(n.tableWidth),a.table.append(t("table.pcTable-table thead").clone(!0)).attr("class",t("table.pcTable-table").attr("class")),a.table.find("th:not(.id) div, th:not(.id) .btn").remove(),a.table.find('th.id .pcTable-filters button[data-action="checkbox"]').remove(),a.table.find("th").removeClass("with-filter");let e=t('<div class="btn btn-default btn-xxs "><i class="fa fa-arrow-up"></i></div>').on("click",(function(){n._container.scrollTop(n._container.find(".pcTable-rowsWrapper").offset().top-n.scrollWrapper.offset().top)}));if(a.table.find("th.id .pcTable-filters:first").append(e),a.table.find("th.n").length){let e=n._innerContainer.find("th.n").find("i.fa-save").parent().clone(!0);a.table.find("th.n").append(t('<div class="pcTable-filters">').append(e))}}a.table.css({position:"absolute",top:parseInt(t("#table").offset().top)-parseInt(t(".innerContainer").offset().top)})}():a.table&&(a.table.remove(),a.table=void 0,n._content.off("scroll"))},r=function(){try{if(n.isAnonim){let e=t(document).scrollTop()-n._content.offset().top;return e<0?0:-e}return n._content.offset().top}catch(e){return 0}};i=n.isAnonim?t(document):n._container,i.on("scroll",(function(){clearTimeout(o),o=setTimeout((function(){s.call(n)}),50)}));let d={top_offset:0,bottom_offset:0,rows:t()};return t.extend(a,{rows_in_block:4,item_height:35,emptyCache:function(){d={}},getClusterNum:function(e){let t;return t=e>=0?0:Math.floor(-e/this.block_height),Math.max(t,0)},reloadScrollHead:function(){a.table&&(a.table.remove(),a.table=void 0),s.call(n)},generate:function(e){let t,i,a,l,o,s=n.dataSortedVisible,r=s.length;if(r<this.rows_in_block)return{top_offset:0,bottom_offset:0,rows:s};do{t=Math.max(this.rows_in_block*e,0),i=t+this.rows_in_cluster+3*this.rows_in_block,a=Math.max(t*this.item_height,0),l=Math.max((r-i)*this.item_height,0),o=[];for(let e=t;e<i;e++)s[e]&&o.push(s[e])}while(e>0&&0===o.length&&--e>-1);return{top_offset:a,conteinerHeight:n._content.height(),i_start:t,bottom_offset:l,cluster_num:e,rows:o}},getRowsHeight:function(){0!==n.dataSortedVisible.length&&(this.block_height=this.item_height*this.rows_in_block,this.rows_in_cluster=Math.floor((e.innerHeight-n._container.offset().top)/this.item_height))},insertToDOM:function(e,t,i){if(n.isMobile)this.setHtml(n.dataSortedVisible,0,0,i);else{this.rows_in_cluster||this.getRowsHeight(),e||(e=this.getClusterNum(r()));let a=this.generate(e),l=a.rows.join(",");(i||this.checkChanges("data",l,d))&&this.setHtml(a.rows,a.top_offset,a.bottom_offset,i),t&&n._container.getNiceScroll&&n._container.getNiceScroll().resize()}},setHtml:function(e,i,a,l){n._content.find(".editing").each((function(e){n._removeEditing.call(n,e)}));let o=n._content.empty().get(0);if(i&&o.appendChild(t('<tr style="height: '+i+'px;" class="loading-row"><td colspan="'+(n.fieldCategories.column.length+1)+'"></td></tr>').get(0)),0===n.dataSorted.length)o.appendChild(n._createNoDataRow().get(0));else if(0===n.dataSortedVisible.length)o.appendChild(n._createNoDataRow("По условиям фильтрации не выбрана ни одна строка").get(0));else for(let t in e){let i=e[t];if("object"!=typeof i){let e=n.data[i];e.$tr&&!l||n._createRow.call(n,e),e.$tr.data("item",e),o.appendChild(e.$tr.get(0))}else o.appendChild(n._createTreeFolderRow.call(n,i).get(0))}a&&o.appendChild(t('<tr style="height: '+a+'px;" class="loading-row"><td colspan="'+(n.fieldCategories.column.length+1)+'"></td></tr>').get(0))},checkChanges:function(e,t,i){let n=t!=i[e];return i[e]=t,n}}),a}})}(),t.extend(App.pcTableMain.prototype,{sort:function(e,t){let i,n=this,a=e.name,l="number"===e.type,o=n.data;if((n.nSorted="n"===e.name)||this._table.addClass("no-correct-n-filtered"),i=l?function(e,i){let n,l,s=o[e][a].v,r=o[i][a].v,d=0;if(null===s)d=null===r?0:-t;else if(null===r)d=t;else{try{n=Big(s)}catch(e){n=Big(0)}try{l=Big(r)}catch(e){l=Big(0)}d=n.gt(l)?t:n.eq(l)?0:-t}return d}:"select"===e.type?function(i,n){let l,s;const r=function(t){let i;return o[t][a].v_?e.multiple?(i="",o[t][a].v_.forEach((function(e){i+=e[0]}))):i=o[t][a].v_[0]:i=o[t][a].v,null===i&&(i=""),i};return l=r(i),s=r(n),l===s?0:l>s?t:-t}:function(e,i){let n,l;return n=o[e][a].v+"",l=o[i][a].v+"",n>l?t:n==l?0:-t},n.isTreeView)if("tree"!==a&&"self"!==n.fields.tree.treeViewType){let e=[],t=[...n.dataSorted];n.dataSorted=[];const a=()=>{e.length&&(e=e.sort(i),n.dataSorted.push(...e),e=[])};t.forEach(t=>{"object"==typeof t?(a(),n.dataSorted.push(t)):e.push(t)}),a()}else{let e=(e,i)=>(a_=n.treeIndex[e].t||"",b_=n.treeIndex[i].t||"",a_===b_?0:a_>b_?t:-t);"tree"!==a&&(e=(e,t)=>i(n.treeIndex[e].row.id,n.treeIndex[t].row.id));const l=t=>{let i=n.treeIndex[t];i.trees=i.trees.sort(e),i.trees.forEach(l)};n.treeSort=n.treeSort.sort(e),n.treeSort.forEach(l),n.treeApply()}else n.dataSorted=n.dataSorted.sort(i);n.dataSortedVisible=[];for(let e=0;e<this.dataSorted.length;e++){let t=this.dataSorted[e];if("object"==typeof t)n.dataSortedVisible.push(t);else{let e=this.data[t];this.__applyFiltersToItem(e),e.$visible&&n.dataSortedVisible.push(t)}}n._refreshContentTable()}}),App.pcTableMain.prototype.isSelected=function(e,t){return!(!this.selectedCells||!this.selectedCells.ids[e]||-1===this.selectedCells.ids[e].indexOf(t))},App.pcTableMain.prototype.getSelectPanel=function(i,n,a){let l=this,o=l.selectedCells;o.selectPanelDestroy();let s=t('<div id="selectPanel" class="text">'),r=t('<div class="column-name"></div>').text(i.title);i.unitType&&r.append(", "+i.unitType),s.append(r),"text"===i.type&&r.append(", "+i.textType),s.append(r);let d="";if("column"===i.category){if(d='<span class="id-val">['+n.id+"]</span>",l.tableRow.main_field){let e=l.mainFieldName;void 0!==n[e].v_?"array"==typeof n[e].v_?n[e].v_.forEach((function(i,a){let o=t("<span>").text(l.fields[e].getElementString(n[e].v?n[e].v[a]:null,i));i[1]&&o.addClass("deleted_value"),d+=" "+o.html()})):d+=" "+t("<div>").text(l.fields[e].getElementString(n[e].v,n[e].v_)).html():d+=" "+t("<div>").text(n[e].v).html()}let e=t('<div class="row-name"></div>').html(d);s.append(e)}let c=n[i.name],p=t('<div id="selectPanelBig">'),f=t('<div class="field-value"><div class="copytext-wrapper"><div class="copytext"></div></div></div>').css("white-space","pre-wrap");l.isMobile?f.height("auto").css("min-height",40):f.height(200),p.append(f).appendTo(s);let h=f.find(".copytext");if(!i.unitType||null===c.v||"select"===i.type&&i.multiple||h.attr("data-unit",i.unitType),c.f&&(c.f.text&&f.prepend(t('<div class="sp-element"><i class="fa fa-font"></i> </div>').append(c.f.text)),c.f.comment&&f.prepend(t('<div class="sp-element"><i class="fa fa-info"></i> </div>').append(c.f.comment))),c.h&&c.f&&!1!==c.f.showhand)if(void 0!==c.c){let e=c.c;c.c_&&(e=c.c_[0],c.c_[1]&&(e=t('<span class="deleted_value">').text(e))),f.append(t('<div><i class="fa fa-hand-paper-o"></i> Расчетное значение: </div>').append(e))}else f.append('<div><i class="fa fa-hand-grab-o pull-left"></i> Cовпадает с расчетным</div>');let u,m=t('<div><div class="center"><i class="fa fa-spinner fa-spin"></i></div></div>');if(i.formatInPanel&&(f.append(m),m.data("loadFormats",(function(){i.pcTable.model.getPanelFormats(i.name,n.id).then(e=>{if(m.empty(),e.panelFormats){let n;e.panelFormats.rows.forEach(n=>{switch(n.type){case"text":m.append(t('<div class="panel-text">').text(n.value));break;case"html":m.append(t('<div class="panel-html">').html(n.value));break;case"img":m.append(t('<div class="panel-img">').append(t("<img>").attr("src","/fls/"+n.value+"_thumb.jpg?rand="+Math.random())));break;case"buttons":if(n.value&&n.value.forEach){let a=[];n.value.forEach(n=>{let l=t('<button class="btn btn-default btn-xxs">').text(n.text);a.push(l),n.color&&l.css("color",n.color),n.background&&l.css("background-color",n.background),l.on("click",(function(){i.pcTable.selectedCells.empty(),i.pcTable.selectedCells.selectPanelDestroy(),i.pcTable.model.panelButtonsClick(e.panelFormats.hash,n.ind).then((function(e){n.refresh&&i.pcTable.model.refresh()}))}))}),m.append(t('<div class="panel-buttons">').append(a))}}}),e.panelFormats.hash&&(n=setInterval(()=>{s.closest("body").length||(clearInterval(n),i.pcTable.model.panelButtonsClear(e.panelFormats.hash))},1e3))}})}))),i.selectTable&&i.changeSelectTable){let e=t('<div><div class="center"></div></div>');if(i.multi){if(c.v&&c.v.length){let a=t('<button class="btn btn-default btn-xxs"></button>').text("Редактировать").on("click",()=>{i.sourceButtonClick(n)});e.append(t('<div class="panel-buttons">').append(a)).appendTo(f)}}else if(c.v){let a=t('<button class="btn btn-default btn-xxs"></button>').text("Редактировать").on("click",()=>{i.sourceButtonClick(n).then(e=>{e&&e.json&&e.json.updated&&l.model.refresh()})});e.append(t('<div class="panel-buttons">').append(a)).appendTo(f)}}let b=t('<div class="buttons"></div>'),g=[];if(a.is(".edt")&&(g.push({label:'<i class="fa fa-pencil-square-o"></i>',action:function(e){e.close(),a.dblclick()}}),t('<button class="btn btn-sm btn-default"><i class="fa fa-pencil-square-o"></i></button>').on("click",(function(){return a.dblclick(),!1})).appendTo(b)),u=t('<button class="btn btn-sm btn-default copy_me" disabled data-copied-text="Скопировано" title="Копировать "><i class="fa fa-copy"></i></button>'),u.on("click",(function(){h.data("text")?App.copyMe(h.data("text")):App.copyMe(h.text());let e=t(this);return e.width(e.width()),e.button("copied"),setTimeout((function(){e.button("reset")}),1e3),e.blur(),!1})),b.append(u),"tmp"!==l.tableRow.type&&i.logButton&&(g.push({label:"Лог",action:function(e){let t;l.mainFieldName&&n.id&&(t=n[l.mainFieldName].v),l.model.getFieldLog(i.name,n.id,t),e.close()}}),t('<button class="btn btn-sm btn-default" title="Лог ручных изменений по полю">Лог</button>').on("click",(function(){let e;l.mainFieldName&&n.id&&(e=n[l.mainFieldName].v),l.model.getFieldLog(i.name,n.id,e);let a=t(this).addClass("disabled");return setTimeout((function(){a.removeClass("disabled")}),1e3),!1})).appendTo(b)),"column"===i.category&&i.filterable&&(l.isValInFilters.call(l,i.name,c)?(g.push({label:'<i class="fa fa-filter" style="color: #ffe486"></i>',action:function(e){o.selectPanelDestroy(),l.removeValueFromFilters.call(l,i.name,c),e.close()}}),t('<button class="btn btn-sm btn-warning" title="Удалить из фильтра"><i class="fa fa-filter"></i></button>').on("click",(function(){return o.selectPanelDestroy(),l.removeValueFromFilters.call(l,i.name,c),!1})).appendTo(b)):(g.push({label:'<i class="fa fa-filter"></i>',action:function(e){o.selectPanelDestroy(),l.addValueToFilters.call(l,i.name,c),l._container.scrollTop(l._filtersBlock.offset().top-l.scrollWrapper.offset().top),l.ScrollClasterized.insertToDOM.call(l.ScrollClasterized,0),e.close()}}),t('<button class="btn btn-sm btn-default" title="Добавить в фильтр"><i class="fa fa-filter"></i></button>').on("click",(function(){return o.selectPanelDestroy(),l.addValueToFilters.call(l,i.name,c),l._container.scrollTop(l._filtersBlock.offset().top-l.scrollWrapper.offset().top),l.ScrollClasterized.insertToDOM.call(l.ScrollClasterized,0),!1})).appendTo(b))),!l.isMobile){let i=t('<button class="btn btn-sm btn-default"><i class="fa fa-expand" style="padding-top: 3px;" aria-hidden="true"></i></button>');i.on("click",(function(){p.find(".field-value").height(""),p.find(".panel-img img").each((e,i)=>{(i=t(i)).attr("src",i.attr("src").replace("_thumb.jpg?","?"))}),e.top.BootstrapDialog.show({message:p,type:null,title:r.text()+(d?" / "+d:""),cssClass:"fieldparams-edit-panel",draggable:!0,onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"}),o.selectPanelDestroy()},onshown:function(t){t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top}),p.find(".field-value div.codeEditor").trigger("panel-resize")}})})),b.append(i),t('<button class="btn btn-sm btn-default" title="Закрыть панель"><i class="fa fa-times"></i></button>').on("click",(function(){return o.selectPanelDestroy(),!1})).appendTo(b)}let v=i.getPanelText(c.v,s,n);if("select"===i.type){let e=t('<div class="previews">').appendTo(f);i.loadPreviewPanel(e,i.name,n,c.v).then((function(){m.data("loadFormats")&&m.data("loadFormats")()}))}else m.data("loadFormats")&&m.data("loadFormats")();l.isCreatorView&&-1!==["select","tree","date"].indexOf(i.type)&&f.append(t('<div class="creator-select-val">'+JSON.stringify(c.v)+"</div>"));const w=function(e){h.text(e),u.prop("disabled",!1)},_=function(e,t){h.html(e),e.data("text")?h.data("text",e.data("text")):h.data("text",t),u.prop("disabled",!1)},y=function(e){if("object"==typeof e&&null!==e)if(e instanceof jQuery){let i="";e.copyText?_(e,e.copyText):(e.each((function(){""!==i&&(i+="\n"),i+=t(this).text()})),""===i&&(i=e.text()),_(e,i))}else e.then?e.then(y):w(JSON.stringify(e));else w(e)};if(y(v),l.isCreatorView){let e;l.LOGS&&(e=l.LOGS,n&&n.id&&(e=l.LOGS[n.id]),e&&(e=e[i.name]));let a=t('<div style="padding-top: 10px">');if(e&&e.c){let i=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> c</i></button>');i.on("click",(function(){App.logOutput(e.c)})),a.append(i)}if(e&&e.s){let i=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> s</i></button>');i.on("click",(function(){App.logOutput(e.s)})),a.append(i)}if(e&&e.a){let i=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> a</i></button>');i.on("click",(function(){App.logOutput(e.a)})),a.append(i)}if(e&&e.f){let i=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> f</i></button>');i.on("click",(function(){App.logOutput(e.f)})),a.append(i)}a.children().length&&b.append(a)}if(l.isMobile||s.append(b),c.e&&f.append(t('<div style="padding-top: 5px;">').html(t("<span>").text(c.e).text().replace(/\[\[(.*?)\]\]/g,"<b>$1</b>"))),l.isMobile)App.mobilePanel(r,s,{buttons:g});else{let e="right",t=a.offset().left,i=l._container.offset().left,n=l._container.width(),o=a.width(),r=s.is(".text")?340:240;n-(t-i)-o<r&&(e="left",a.offset().left-i<r&&(e="bottom"));let d={isParams:!0,$text:s,element:a,container:l._container,placement:e,trigger:"manual"};App.popNotify(d)}return t("body").on("click.selectPanelDestroy",(function(e){0===t(e.target).closest("#selectPanel").length&&o.selectPanelDestroy()})).on("keyup.selectPanelDestroy",(function(e){27==e.which&&o.selectPanelDestroy()})),a},App.pcTableMain.prototype._addSelectable=function(){var i=this;i.selectedCells={fieldName:null,ids:{},notRowCell:null,times:null,lastSelected:null,notRowCellEmpty:function(){if(this.notRowCell){this.notRowCell.removeClass("selected");let e=this.notRowCell.closest(".DataRow");1===e.length&&e.removeClass("selected"),this.notRowCell=null}},empty:function(){this.notRowCellEmpty();let e=this;Object.keys(this.ids).forEach((function(t){e.ids[t].forEach((function(e){let t=i._getItemById(e);t&&t.$tr&&(t.$tr.find(".selected").removeClass("selected"),t.$tr.removeClass("selected"))}))})),this.ids={},this.lastSelected=null},getEditedData:function(e,t){let n={},a=!1;return Object.keys(i.selectedCells.ids).length>1&&(a=!0),Object.keys(i.selectedCells.ids).forEach((function(l){i.selectedCells.ids[l].forEach((function(o){let s=i.data[o],r=s[l].f?s[l].f.block:void 0;s.f.block&&!1!==r||r||!i.fields[l].editable||!i.fields[l].editGroup||a&&!i.fields[l].editGroupMultiColumns||(n[o]||(n[o]={}),n[o][l]=t?s[l].v:e)}))})),n},remove:function(e,t){let n=this;if(!this.ids[t])return;let a={};this.ids[t].some((function(i,l){if(i==e)return n.ids[t].splice(l,1),0===n.ids[t].length&&delete n.ids[t],a[e]=!0,!0})),Object.keys(a).forEach((function(e){let t=!1;Object.keys(n.ids).some((function(i){if(-1!==n.ids[i].indexOf(parseInt(e)))return t=!0,!0})),t||i.data[e].$tr&&i.data[e].$tr.removeClass("selected")}))},add:function(e,t){this.ids[t]||(this.ids[t]=[]),this.ids[t].push(e),i.data[e].$tr&&i.data[e].$tr.addClass("selected")},selectPanelDestroy:function(){let e=this;e.selectPanel&&(e.selectPanel.attr("aria-describedby")&&e.selectPanel.popover("destroy"),e.selectPanel=null),t("body").off(".selectPanelDestroy")},checkIfShowPanel:function(e){"use strict";if(this.selectPanelDestroy(),e){let t,n=i._getFieldBytd(e);t="column"===n.category?i._getItemBytd(e):i.data_params,this.selectPanel=i.getSelectPanel.call(i,n,t,e)}return!1},copySepected:function(e,i){let n=this,a="",l=[],o=[],s={},r=[];Object.keys(n.selectedCells.ids).forEach((function(e){let t=n.selectedCells.ids[e];l=l.concat(t),o.push(e),t.forEach((function(t){s[t]||(s[t]={});let i=n.fields[e].getCopyText.call(n.fields[e],n.data[t][e],n.data[t]);"object"==typeof i?(r.push(i),i.done((function(i){s[t][e]=i}))):s[t][e]=i}))})),l=Array.from(new Set(l)),l=n.dataSortedVisible.filter(e=>-1!==l.indexOf(e)),o=Array.from(new Set(o));let d=[];n.fieldCategories.visibleColumns.forEach((function(e){-1!==o.indexOf(e.name)&&d.push(e.name)})),o=d,e&&(a+="id",o.forEach((function(e){a+="\t",a+=n.fields[e].title})));let c=i;t.when(...r).done((function(){l.forEach((function(t){""!==a&&(a+="\n");let i=!0;e&&(a+=t,i=!1),o.forEach((function(e){!0===i?i=!1:a+="\t";let n=s[t][e];void 0===n&&(n=""),"string"==typeof n&&n.replace(/\t/g,"").match(/[\s"]/)&&(n='"'+n.replace(/"/g,'""')+'"'),a+=n}))})),App.copyMe(a),setTimeout(c,400)}))},click:function(e,n){let a=i._table;return!e.closest("table").is(".pcTable-filtersTable")&&(!0===a.data("moved")?(a.data("moved",!1),!1):n.originalEvent&&n.originalEvent.path&&n.originalEvent.path[0]&&t(n.originalEvent.path[0]).is(".asUrl")?(i.actionOnClick(e),!1):void function(){if(e.is(".val")){if(this.notRowCell&&-1!==this.notRowCell.index(e))i.selectedCells.empty();else{i.selectedCells.empty(),this.notRowCell=e,this.notRowCell.addClass("selected");let t=this.notRowCell.closest(".DataRow");1===t.length&&t.addClass("selected")}return void t("table.pcTable-table").removeClass("selected-multi").removeClass("selected-column")}this.notRowCellEmpty();let a=e.closest("tr"),l=i._getItemByTr(a),o=i._fieldByTd(e,a),s=o.name;if(n.altKey)e.is(".selected")?(i.selectedCells.remove(l.id,s),e.removeClass("selected")):(i.selectedCells.add(l.id,s),e.addClass("selected"),this.lastSelected=[s,l.id]);else if(n.shiftKey&&Object.keys(i.selectedCells.ids).length){let e=this,t=[],n="before";i.dataSortedVisible.some((function(i){if("before"===n){if((i===l.id||i===e.lastSelected[1])&&(n="doIt",t.push(i),l.id===e.lastSelected[1]))return!0}else if("doIt"===n&&(t.push(i),i===l.id||i===e.lastSelected[1]))return!0})),n="before";let a=function(n){t.forEach((function(t){let a=i.data[t];i.isSelected(n.name,t)||(e.add(t,n.name),a.$tr&&i._getTdByFieldName(n.name,a.$tr).addClass("selected"))}))};i.fieldCategories.column.some((function(t){if(t.showMeWidth>0)if("before"===n){if((t.name===s||t.name===e.lastSelected[0])&&(n="doIt",a(t),s===e.lastSelected[0]))return!0}else if("doIt"===n&&(a(t),t.name===s||t.name===e.lastSelected[0]))return!0})),this.lastSelected=[s,l.id]}else{let t=i.isSelected(o.name,l.id);i.selectedCells.empty(),t||(i.selectedCells.add(l.id,s),e.addClass("selected"),this.lastSelected=[s,l.id])}let r=Object.keys(i.selectedCells.ids);r.length>1?t("table.pcTable-table").addClass("selected-multi"):1===r.length&&Object.values(i.selectedCells.ids)[0].length>1?t("table.pcTable-table").removeClass("selected-multi").addClass("selected-column"):t("table.pcTable-table").removeClass("selected-multi").removeClass("selected-column")}.call(this))}},this._container.on("contextmenu",".DataRow td:not(.editing,.n,.id), td.val:not(.editing)",(function(e){let n=t(this);return i.selectedCells.selectPanel&&i.selectedCells.selectPanel.closest("td")[0]==n[0]?i.selectedCells.selectPanelDestroy():(i.selectedCells.selectPanelDestroy(),i.selectedCells.empty(),i.selectedCells.checkIfShowPanel(n),i.selectedCells.click(n,{})),!1})),this._container.on("click",".DataRow td:not(.editing,.id,.n), td.val:not(.editing)",(function(n){if("file-image-preview"===n.target.className){let t=JSON.parse(n.target.getAttribute("data-fileviewpreview"));e.top.BootstrapDialog.show({title:t.name,message:'<div class="file-image-big"><img src="/fls/'+t.file+'" style="max-width: 100%; max-height: 100%"/></div>',type:null,draggable:!0})}else{if("file-pdf-preview"===n.target.className)return e.open(n.target.getAttribute("data-filename")),!1;{let e=t(this);if(e.is(".cell-button")&&!e.find("button.button-field").is(":disabled")){let t=i._getFieldBytd(e);return i._buttonClick.call(i,e,t),!1}e.data("clicked")?e.removeData("clicked"):(e.data("clicked",1),setTimeout((function(){e.data("clicked")&&(e.removeData("clicked"),i.selectedCells.click(e,n))}),200))}}})),this._container.on("click","th.id .for-selected button",(function(){let e=t(this),n=e.html();e.text("Скопировано"),i.selectedCells.copySepected.call(i,e.data("names"),(function(){e.html(n)}))}))},App.pcTableMain.prototype.filters={},App.pcTableMain.prototype.__getFilterButton=function(e){var i="btn-default";(this.filters[e]&&this.filters[e].length||this.filters[e+"/h"])&&(i="btn-warning");var n=t('<button class="btn btn-xxs btn-filter"><span class="fa fa-filter"></span></button>').addClass(i);return t('<span class="filter-in-head">').append(n)},App.pcTableMain.prototype.filtersEmpty=function(){this.filters={},this._refreshHead(),this.__applyFilters()},App.pcTableMain.prototype.sessionStorageFilters={url:location.protocol+"//"+location.host+location.pathname,setFilters:function(e){let t={};e=e||{};try{t=JSON.parse(sessionStorage.getItem("pcTableFilters"))||{}}catch(e){}t[this.url]=e,sessionStorage.setItem("pcTableFilters",JSON.stringify(t))},getFilters:function(){let e={};try{e=JSON.parse(sessionStorage.getItem("pcTableFilters")),e=e[this.url]||{}}catch(e){}return e}};let p=!0;App.pcTableMain.prototype.__applyFilters=function(e=!1){let t=this;App.fullScreenProcesses.show(),this.filtersClearButton&&("tmp"!==t.tableRow.type&&this.sessionStorageFilters.setFilters(this.filters),this.selectedCells&&this.selectedCells.empty(),Object.equals(this.filters,{})?this.filtersClearButton.addClass("btn-default").removeClass("btn-warning").attr("disabled",!0):(this.filtersClearButton.removeClass("btn-default").addClass("btn-warning").removeAttr("disabled"),p&&(App.blink(t.filtersClearButton,8,"#fff"),p=!1)));let i=[];this.isTreeView?this.dataSortedVisible.forEach(e=>{"object"!=typeof e&&i.push(e)}):i=this.dataSortedVisible.slice();let n=[],a=[];for(let e=0;e<this.dataSorted.length;e++){let t=this.dataSorted[e];if("object"==typeof t)n.push(t);else{let e=this.data[t];this.__applyFiltersToItem(e),e.$visible&&(n.push(t),a.push(t))}}(e||JSON.stringify(i)!==JSON.stringify(a))&&(this.dataSortedVisible=n,this._refreshContentTable(!1,!0),this._headCellIdButtonsState()),App.fullScreenProcesses.hide()},App.pcTableMain.prototype.__applyFiltersToItem=function(e,t){let i=this,n=!0;for(let t in i.filters){if(!i.filters[t]||0===i.filters[t].length)continue;let a=i.filters[t];if("id"===t)-1===a.indexOf(e.id.toString())&&(n=!1);else{let l=t.toString().split("/");if(t=l[0],!i.fields[t])continue;switch(l[1]||"v"){case"v":i._getFieldbyName(t).checkIsFiltered(e[t],a)||(n=!1);break;case"h":switch(a){case"h":!0!==e[t].h&&(n=!1);break;case"n":!0===e[t].h&&(n=!1);break;case"hf":(!0!==e[t].h||e[t].hasOwnProperty("c"))&&(n=!1);break;case"hc":!0===e[t].h&&e[t].hasOwnProperty("c")||(n=!1)}}}if(!n)break}(e.$visible=n)||this.row_actions_uncheck(e)},App.pcTableMain.prototype.addValueToFilters=function(e,t){const i=this;i.filters[e]||(i.filters[e]=[]);let n=i.fields[e];i.filters[e].push(...n.getFilterDataByValue.call(n,t)),n.$th&&n.$th.find(".btn-filter").parent().replaceWith(i.__getFilterButton.call(i,e)),i.__applyFilters.call(i)},App.pcTableMain.prototype.isValInFilters=function(e,t){this.filters[e]||(this.filters[e]=[]);let i=this.fields[e],n=i.getFilterDataByValue.call(i,t);return this.filters[e].some(e=>-1!==n.indexOf(e))},App.pcTableMain.prototype.removeValueFromFilters=function(e,t){const i=this;i.filters[e]||(i.filters[e]=[]);let n=i.fields[e],a=n.getFilterDataByValue.call(n,t),l=0,o=[...i.filters[e]];i.filters[e].forEach((e,t)=>{-1!==a.indexOf(e)&&(o.splice(t-l,1),l++)}),i.filters[e]=o,0===i.filters[e].length&&delete i.filters[e],n.$th&&n.$th.find(".btn-filter").parent().replaceWith(i.__getFilterButton.call(i,e)),i.__applyFilters.call(i)},App.pcTableMain.prototype.loadFilters=function(){var e={};"tmp"!=this.tableRow.type&&(e=this.sessionStorageFilters.getFilters()),this.filters=e||{}},App.pcTableMain.prototype.__addFilterable=function(){const e=this;this.loadFilters(),this.viewType||this._header.on("click",".pcTable-filters > span button.btn-filter:not(#checkS)",(function(i){let n=t(this);if(n.attr("aria-describedby"))return!0;let a=n.closest("th"),l=a.is(".id")?"id":a.data("field"),o=t('<div class="filter-div-button">'),s=t('<select class="selectpicker" data-size="6" multiple title="Выберите значения" data-style="btn-sm btn-default" data-width="css-width" data-live-search="true" data-selected-text-format="count">').appendTo(o);const r=function(){try{n.popover("destroy")}catch(e){}};let d,c=!1;const p=function(i){if(d&&clearTimeout(d),!c){if("filterRemove"===i)return c=!0,r(),delete e.filters[l],n.removeClass("btn-warning").addClass("btn-default"),void e.__applyFilters.call(e);if("setInvertFilters"===i){let e=Object.values(s.selectpicker("val")),i=[];t.each(s.data("options"),(function(t,n){-1===e.indexOf(n)&&i.push(n)})),s.data("add-options",i)}d=setTimeout((function(){r(),s.data("add-options")?(f=s.data("add-options"),s.data("add-options",null)):f=s.selectpicker("val"),JSON.stringify(e.filters[l]||[])!==JSON.stringify(f)&&(e.filters[l]=f,0===e.filters[l].length&&delete e.filters[l],"id"!==l||n.closest(".pcTable-table").is(".pcTable-table:first")||e._header.find("th.id .btn-filter").parent().replaceWith(e.__getFilterButton.call(e,l)),n.parent().replaceWith(e.__getFilterButton.call(e,l)),e.__applyFilters.call(e))}),10)}};o=t('<div class="pcTable-filter-select" style="height: 220px;">').append(o),s.data("container",o);var f={};Object.values(e.dataSorted).forEach((function(t){"object"!=typeof t&&("id"===l?f[t.toString()]=t.toString():e.fields[l].addDataToFilter(f,e.data[t][l]))}));var h={};t.each(f,(function(e,t){h[t]=e})),h=App.ksort(h);let u={},m=e.filters[l]?[...e.filters[l]]:[],b=0;const g=function(e){u={"Выбранное":t('<optgroup label="Выбранное">'),"":t('<optgroup label="">')};let i=function(){return!0};if(e&&""!==e){let t=e.toLowerCase().replace("ё","е").split(" ");i=function(e){let i=null!==e?e.toString().toLowerCase().replace("ё","е"):"";return!t.some((function(e){return-1===i.indexOf(e)}))}}let n=!1,a=0;t.each(h,(function(e,t){if("null"===e&&(e="null "),-1!==m.indexOf(t.toString())){let n=i(e);u["Выбранное"].append('<option data-content="'+e+'" '+(n?"":'style="display: none"')+">"+t+"</option>"),b+=n?1:0}else{if(!i(e))return!0;a>=100?n=!0:(u[""].append('<option data-content="'+e+' ">'+t+"</option>"),a++)}})),s.empty(),b||u["Выбранное"].attr("label",""),s.append(u["Выбранное"]),s.append(u[""]),n&&s.append('<option data-content="Данные не полны. Пользуйтесь поиском" disabled = disabled style="text-align: center; cursor: pointer">0</option>'),s.data("options",h),s.selectpicker("val",m),s.selectpicker("refresh")};s.on("change.bs.select",(function(){m=s.val()})),g();let v=n.popover({html:!0,content:o,trigger:"manual",container:e._container,placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'});s.selectpicker("render").selectpicker("toggle"),n.one("remove",()=>{setTimeout(()=>{let e;v&&v.length&&v.attr("aria-describedby")&&(e=t("#"+v.attr("aria-describedby")))&&e.remove()},10)});let w=t('<div class="buttons" style="position: absolute; bottom: -10px; width: 100%; text-align: center">');if(t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px;">Прим.</span></span>').appendTo(w).on("click",(function(){p("setSelectedFilters")})),t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px;">Инверт.</span></span>').appendTo(w).on("click",(function(){p("setInvertFilters")})),t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px">Отмен.</span>').appendTo(w).on("click",(function(){p("filterRemove")})),e.fields[l]&&e.fields[l].code&&!e.fields[l].codeOnlyInAdd){let i=t('<select data-title="Все" data-dropup-auto="false" class="dropup" data-container=".popover" data-style="btn btn-xxs filter-by-hand '+(e.filters[l+"/h"]?"btn-warning":"btn-default")+' "><option value="">Все</option><option value="n">Без руки</option><option value="h">С рукой все</option><option value="hf">С рукой как в расчете</option><option value="hc">С рукой отличающиеся</option></select>').appendTo(w).on("change",(function(){return e.filters[l+"/h"]=i.selectpicker("val"),""===e.filters[l+"/h"]&&delete e.filters[l+"/h"],r(),n.parent().replaceWith(e.__getFilterButton.call(e,l)),e.__applyFilters.call(e),!1})).wrap('<span id="filterHand">');setTimeout((function(){i.selectpicker("render").selectpicker("val",e.filters[l+"/h"]||"");try{i.data("selectpicker").$menu.offset({bottom:15,left:-90}).css("border","1px solid grey")}catch(e){}}),100)}e.PageData&&e.PageData.onPage&&e.PageData.allCount>e.PageData.onPage?(b?o.height(260):o.height(220),w.append('<div class="text-center ttm-paging-danges">Фильтрация по текущей странице</div>')):b?o.height(220):o.height(200),w.appendTo(o),s.on("hidden.bs.select",(function(){p("setSelectedFilters")})),e.filters[l]&&s.selectpicker("val",e.filters[l]),setTimeout((function(){if(v&&v.length){let i;v.popover("show"),o.on("mouseenter","li",(function(){let e=t(this);e.attr("title")||e.attr("title",e.text())})),"id"===l&&t("#"+n.attr("aria-describedby")).position({my:"left top",at:"left-3px bottom+10px",of:n}).find(".arrow").css("left","12px"),s.data("selectpicker")._searchStyle=function(){return"multiincludes"},s.data("selectpicker").$searchbox.focus(),s.data("selectpicker").$searchbox.off().on("click.dropdown.data-api focus.dropdown.data-api touchend.dropdown.data-api",(function(e){e.stopPropagation()})),s.data("selectpicker").$searchbox.on("keydown",(function(e){if("Escape"===e.key)return s.data("selectpicker").$button.click(),!0}));let a="";s.data("selectpicker").$searchbox.on("keyup",(function(e){let n=t(this).val();a!==n&&(a=n,i&&clearTimeout(i),i=setTimeout((function(){g(a)}),750))})),e._container.on("click.filter filterPressed.filter",(function(i){0!==t(i.target).closest("#filterHand").length||"filterPressed"!==i.type&&void 0===i.altKey||!t("#"+n.attr("aria-describedby")).is(":visible")||(e._container.off(".filter"),p("setSelectedFilters"))})),e._innerContainer.one("scroll.filter",(function(i){t("#"+n.attr("aria-describedby")).is(":visible")&&(e._container.off(".filter"),p("setSelectedFilters"))}))}}),50),e._container.trigger("filterPressed")}))},t.extend(App.pcTableMain.prototype,{_addEditable:function(){var e=this;let i=this._container;e.actionOnClick=function(e,t){let i=e.clone(!0).insertAfter(e);e.hide(),t=t||this._getFieldBytd(e),i.html('<span class="cell-value blocked" style="height: '+i.height()+'">Выполняется</span>');let n=e.closest(".DataRow").length?this._getItemBytd(e):{};return this.model.dblClick(n.id,t.name).always(t=>{i.remove(),e.show(),this.table_modify(t)}),!1},i.on("dblclick","td.val:not(.editing), td.edt:not(.editing), .dataRows tr:not(.treeRow) td:not(.editing,.id,.n)",(function(i){let n=t(this),a=n.closest("tr");if(a.length&&a.is(".InsertRow"))return!1;if(n.is(".footer-name, .id, .footer-empty"))return!1;if(n.is(".edt"))e._createEditCell.call(e,n,!0);else{let t=e._getFieldBytd.call(e,n);if(t.CodeActionOnClick)e.actionOnClick(n,t);else{if(a.is(".DataRow")&&"cycles"===e.tableRow.type)return e.model.dblClick(e._getItemBytd(n).id,e._getFieldBytd(n).name),!1;let t=n.clone(!0).insertAfter(n);n.hide(),t.html('<span class="cell-value blocked" style="height: '+t.height()+'">Заблокировано</span>'),setTimeout((function(){t.remove(),n.show()}),500)}}})).on("click",".editCellsBlock .btn, td.edt .ttm-edit, td .ttm-panel",(function(e){return t(this).is(".ttm-edit")?(t(this).closest("td").trigger("dblclick"),!1):t(this).is(".ttm-panel")?(t(this).closest("td").trigger("contextmenu"),!1):void t(this).data("click")(e)}))},goToEditNextCell:function(e){return next},_buttonClick:function(i,n,a){if(i.data("clicked"))return!1;const l=function(){"use strict";let l,s={};i.parent();i.data("clicked",!0),"column"===n.category?(a=a||o._getItemBytd(i),l=a.id,s.item=l,s.fieldName=n.name):(a=a||o.data_params,s.item="params",s.fieldName=n.name),s.checked_ids=o.row_actions_get_checkedIds(),i.height(i.height()),i.find(".cell-value, .ttm--panel-data").hide();let r=t('<div class="text-center"><i class="fa fa-spinner" style="color: #000"></i></div>');i.append(r),o._saving=!0,o.model.click(s).then((function(t){o.table_modify.call(o,t),i.length&&i.isAttached()?(r.remove(),i.find(".cell-value, .ttm--panel-data").show()):a="column"===n.category?o._getItemById(l):o.data_params,n.uncheckAfterClick&&o.row_actions_uncheck_all(),n.closeIframeAfterClick&&e.closeMe&&e.closeMe(),n.btnOK.call(n,i,a)})).fail((function(){i.length&&i.isAttached()&&(r.remove(),i.find(".cell-value, .ttm--panel-data").show(),i.removeData("clicked"))})).always((function(){o._saving=!1}))};let o=this;if(n.warningEditPanel){let e={"Ок":function(e){e.close(),l()},"Отмена":function(e){e.close()}};App.confirmation(n.warningEditText||"Точно изменить?",e,"Подтверждение")}else l()},_saveEdited:function(e,i,n){let a=this;!0!==a._saving&&(a._saving=!0,this.model.save(i).then(t=>{a.table_modify.call(a,t,void 0,e),n&&n()}).always(()=>{a._saving=!1,e.is("tr.DataRow")&&1===e.closest("table").length&&e.find(".editing").length?e.each(()=>{a.refreshRow(t(this))}):e.is("td")&&e.find(".fa-spinner").length&&e.closest("body").length>0&&e.each((function(){let e=t(this),i=a._getItemBytd(e),n=a._getFieldBytd(e),l=a._createCell(i,n);"button"===n.type&&n.btnOK.call(n,l,i),e.replaceWith(l)}))}))},_editFocusIndex:0,_editItem:null,_editPanel:null,_row_edit:function(e){let t=this;if(0===e.length)return!1;let i=e.shift();new EditPanel(t,null,{id:i},e.length>0).then((function(i,n){(i||n)&&(i&&t.table_modify.call(t,i),t._row_edit.call(t,e))})).then((function(){0===e.length&&t.row_actions_uncheck_all()}))},_currentEditCellIndex:0,_removeEditing:function(e){e||(e=this._content.find("td.editing"));var t=this._createCell(this._getItemBytd(e),this._getFieldBytd(e));let i;return(i=e.attr("rowspan"))&&t.attr("rowspan",i),(i=e.data("field"))&&t.data("field",i),e.is(".val")&&t.addClass("val"),e.replaceWith(t),t},_saveEditCell:function(){this._editCell&&this._editCell.isAttached()&&this._editCell.is(".editCell")&&this._editCell.data("SaveMe")&&this._editCell.data("SaveMe")()},_removeEditCell:function(){this._editCell&&this._editCell.isAttached()&&this._editCell.is(".editCell")&&this._removeEditing(this._editCell),this._editCell=null},_setEditCell:function(e){this._saveEditCell(),this._editCell=e,e.addClass("editCell")},_setTdSaving:function(e){e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>')},_createEditCell:function(e,i,n){let l=this,o=this._getFieldBytd(e);this._setEditCell(e);e.parent();let s=e.closest("tr"),r=l._getColumnIndexByTd(e,s),d=function(e){if(!e)return!1;let t;switch(e){case"right":for(t=l._getTdByColumnIndex.call(l,s,++r);t.length;){if(!0===l._getFieldBytd.call(l,t).editable){t.trigger("dblclick");break}t=t.next("td")}break;case"down":for(t=s.next("tr");t.length&&t.is(".Blocked");)t=t.next("tr");l._getTdByColumnIndex.call(l,t,r).trigger("dblclick")}};if(!o.editable)return!1;let c=(n=n||this._getItemBytd(e)).id,p=t('<div class="editCellsBlock">');e.addClass("editing");let f,h,u=n[o.name],m=!1,b=function(e,t,i){let n=i||e.closest("td"),o=t||{};if(!n.length||!n.closest("body").length)return!1;var s=l._removeEditing.call(l,n);l._colorizeElement(s,a),d(o&&o.altKey?"right":!(!o||!o.shiftKey)&&"down")},g=function(t){l._removeEditing.call(l,e),d(t)};l.isSelected(o.name,n.id)?Object.keys(l.selectedCells.ids).length>1?(h=!0,f=!0):l.selectedCells.ids[o.name].length>1&&(f=!0):l.selectedCells.empty();let v=function(t,i,a){if(!a&&o.warningEditPanel&&o.checkEditRegExp.call(o,t))return void App.confirmation(o.warningEditText||"Точно изменить?",{"ОК":function(e){v(t,i,!0),e.close()},"Отменить":function(e){g(),e.close()}},"Предупреждение при изменении");e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>');let s={};s[o.name]=t;let r={};n.id?r[n.id]=s:r.params=s,l._saveEdited.call(l,e,r,(function(){d(i&&i.altKey?"right":!(!i||!i.shiftKey)&&"down")}))},w=function(e,t){setTimeout((function(){if(m)return m=!1,!1;_(e,t)}),150)},_=function(e,i,n){if(m&&!n)return!1;if(m=!0,!(n=n||!1)&&f)return!1;let a,s=e.closest("td");try{a=o.getEditVal(y)}catch(e){return t("#"+App.popNotify(e,s,"default")).css("z-index",1e3),void(m=!1)}let r=l._getItemBytd(s),d=i&&i.altKey?"right":!(!i||!i.shiftKey)&&"down";!o.name in r||!o.isDataModified(a,r[o.name].v)?g(d):v(a,i)};var y=o.getEditElement(void 0,u,n,_,b,w,null,i);u.f&&u.f.placeholder&&o.addPlaceholder&&o.addPlaceholder(y,u.f.placeholder),e.html(y),e.data("SaveMe",(function(e){_(y,e=e||{})})),e.data("input",y);var x=t('<div class="cdiv">').css({height:0,width:"100%",position:"absolute",bottom:"0px"});e.append(x);var k=t('<button class="btn btn-sm btn-default" data-save="true" data-name="Сохранить"><i class="fa fa-save"></i></button>').data("click",(function(e){m=!0,_(y,e,!0)}));p.append(k);k=t('<button class="btn btn-sm btn-default btn-empty-with-icon"><i class="fa fa-times"></i></button>').data("click",(function(e){m=!0;let t=e.altKey?"right":!!e.shiftKey&&"down";g(t)}));if(p.append(k),f&&(h?o.editGroupMultiColumns:o.editGroup)){k=t('<button class="btn btn-sm btn-warning" data-save="true" data-name="Применить к выделенным"><i class="fa fa-database" title="Применить к выделенным"></i></button>');let i=function(){let t;m=!0;try{t=o.getEditVal(y)}catch(t){return void App.popNotify(t,e,"default")}let i=l._container.find("td.selected");l._setTdSaving(i);let n=l.selectedCells.getEditedData(t);l._saveEdited.call(l,i,n,!1)};k.data("click",(function(){o.warningEditPanel?App.confirmation(o.warningEditText,{"ОК":function(e){i(),e.close()},"Отменить":function(e){g(),e.close()}},"Предупреждение при изменении"):i()})),p.append(k),o.code&&!o.codeOnlyInAdd&&((k=t('<button class="btn btn-sm btn-warning" data-name="Фиксировать выделенные"><i class="fa fa-hand-rock-o" title="Фиксировать"></i></button>')).data("click",(function(){m=!0;let e=l._container.find("td.selected");l._setTdSaving(e);let t=l.selectedCells.getEditedData(null,!0);l._saveEdited.call(l,e.closest("tr"),t,!1)})),p.append(k),(k=t('<button class="btn btn-sm btn-danger" data-name="Сбросить ручные"><i class="fa fa-eraser" title="Сбросить ручные"></i></button>')).data("click",(function(){m=!0;let e=l._container.find("td.selected");l._setTdSaving(e);let t=l.selectedCells.getEditedData("NULL");t.setValuesToDefaults=!0,l._saveEdited.call(l,e.closest("tr"),t,!1)})),p.append(k))}else n[o.name]&&1==n[o.name].h?((k=t('<button class="btn btn-sm btn-danger" data-name="Сбросить ручное"><i class="fa fa-eraser" title="Сбросить ручное"></i></button>')).data("click",(function(){m=!0,e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>');let t={};parseInt(c)||(c="params"),t[c]={},t[c][o.name]="NULL",t.setValuesToDefaults=!0,l._saveEdited.call(l,e,t,!1)})),p.append(k)):o.code&&!o.codeOnlyInAdd&&"filter"!==o.category&&((k=t('<button class="btn btn-sm btn-default" data-name="Фиксировать"><i class="fa fa-hand-rock-o" title="Фиксировать"></i></button>')).data("click",(function(){m=!0,e.html('<div class="text-center"><i class="fa fa-spinner"></i></div>');let t={};parseInt(c)||(c="params"),t[c]={},t[c][o.name]="params"===c?l.data_params[o.name].v:l.data[c][o.name].v,l._saveEdited.call(l,e,t,!1)})),p.append(k));if(o.changeSelectTable&&"select"===o.type){let e=function(){m=!0,sourcePanelOpened=!0,setTimeout(()=>{y.click()},3);let e=t(this).data("add-button");return o.sourceButtonClick(n,e).then(e=>{let i=e&&"insert"===e.method&&e.json&&e.json.chdata&&e.json.chdata.rows,a=y;delete o.list,a.data("input").data("LISTs")&&(a.data("input").data("LISTs").isListForLoad=!0),n=t.extend(!0,{},n),i&&(o.multiple?(n[o.name].v=o.getEditVal(y),n[o.name].v.push(Object.keys(e.json.chdata.rows)[0])):n[o.name].v=Object.keys(e.json.chdata.rows)[0]),i||"column"!==o.category||l.model.refresh((function(e){l.table_modify.call(l,e)})),n[o.name].replaceViewValue=function(e){"column"!=o.category&&(l.data_params[o.name].v_=e)},a.replaceWith(y=o.getEditElement(a,n[o.name],n,_,b,w)),m=!1}),!1};(k=t('<button class="btn btn-sm btn-primary"><i class="fa fa-edit" title="Изменить в таблице-источнике"></i></button>')).on("click",e),p.append(k),2===o.changeSelectTable&&(k=t('<button class="btn btn-sm btn-primary" data-add-button="true"><i class="fa fa-plus" title="Добавить в таблицу-источник"></i></button>'),p.append(k),k.on("click",e))}let C=p.find("button").length;p.width(31*C);let T=t("#"+App.popNotify({$text:p,element:x,container:this._container,isParams:!0,placement:"bottom"})),S=parseInt(T.css("top"))-4;T.css("top",-1e7),setTimeout((function(){T.length&&T.isAttached()&&T.css("top",S)}),3),o.focusElement(y)}}),function(e,t){t.extend(App.pcTableMain.prototype,{_orderSaveBtn:void 0,row_actions_add:function(){let e=this;e._table.on("click",".DataRow .id",(function(){e.isMobile&&e.row_actions_panel_show.call(e,t(this))})),e._table.on("click",".DataRow .id button.dropdown",(function(){e.row_dropdown.call(e,t(this))})),e._table.on("click",".DataRow .id .btn.chbox",(function(i){return e._row_actions_checkbox_click.call(e,t(this).closest("tr"),i.shiftKey),!1})),e._table.on("mouseleave",(function(){return t(this).blur(),!1})),e._table.on("click",".DataRow .id button.edit",(function(){e.rows_edit.call(e,t(this).closest("tr"))})),e._container.on("click",".row_delete, .row_duplicate, .row_refresh, .cycle_refresh",(function(){let i=t(this);i.is(".row_delete")?e.rows_delete.call(e,t(this).data("tr")):i.is(".row_duplicate")?e.row_duplicate.call(e,t(this).data("tr")):i.is(".row_refresh")?e.row_refresh.call(e,t(this).data("tr")):i.is(".cycle_refresh")&&e.isCreatorView&&"cycles"===e.tableRow.type&&e.cycle_refresh.call(e,t(this).data("tr"))}))},_idCheckButton:t('<button class="btn btn-xxs chbox btn-default" data-action="checkbox"><span class="fa fa-square-o"></span></button>'),_checkStatusBar:t('<div class="check-status-bar"><span class="check-mark">✓ </span><span data-name="count_checked_rows">0</span><span class="from-mark"> из </span><span data-name="count_visible_rows">0</span></div>'),_headCellIdButtonsState:function(){"use strict";let e=this;this.row_actions_get_checkedIds().length>0?t("table.pcTable-table").addClass("with-checks"):t("table.pcTable-table").removeClass("with-checks"),this.dataSortedVisible.filter(e=>"object"!=typeof e||e.row).length!==this.__checkedRows.length?e._idCheckButton.html('<span class="fa fa-square-o"></span>'):e._idCheckButton.html('<span class="fa fa-check"></span>'),this._refreshCheckedStatus(),e.ScrollClasterized.reloadScrollHead.call(e.ScrollClasterized)},_addCellId:function(e,i){let n=t('<td class="id"><span class="nm">'+e.id+"</span></td>");return n.appendTo(i),this.row_actions_icons_add(n),!0===e.$checked&&this.row_actions_check(e,!0),n},_addCellNo:function(e,i){let n=t('<td class="No">--</td>');return n.appendTo(i),n},row_actions_uncheck_all:function(){"use strict";let e=this,t=this.row_actions_get_checkedIds();for(let i=0;i<t.length;i++){let n=e._getItemById(t[i]);e.row_actions_uncheck.call(e,n,!0)}this.__checkedRows=[],this._headCellIdButtonsState()},_refreshCheckedStatus:function(){this._checkStatusBar.find('[data-name="count_checked_rows"]:first').text(this.__checkedRows.length),this._checkStatusBar.find('[data-name="count_visible_rows"]:first').text(this.dataSortedVisible.filter(e=>"object"!=typeof e||e.row).length)},_row_actions_checkbox_click:function(e,i){let n=this,a=e.closest("tr"),l=this._getItemByTr(a),o=t.extend({},n._lastcheckAction||{});if(n._lastcheckAction={id:l.id,isCheck:!l.$checked},i){let e,t=[];if(o.id&&!l.$checked===o.isCheck&&-1!==(e=n.dataSortedVisible.indexOf(o.id))){let i=n.dataSortedVisible.indexOf(l.id);t=e<i?n.dataSortedVisible.slice(e+1,i+1):n.dataSortedVisible.slice(i,e)}else n.dataSortedVisible.some((function(e){if(n.data[e].$checked?t=[]:t.push(e),e===l.id)return!0}));l.$checked?t.forEach((function(e){n.__checkedRows.splice(n.__checkedRows.indexOf(e),1),n.row_actions_uncheck(n.data[e],!0)})):t.forEach((function(e){n.__checkedRows.push(e),n.row_actions_check(n.data[e],!0)})),this._headCellIdButtonsState()}else l.$checked?this.row_actions_uncheck(l):this.row_actions_check(l)},row_actions_get_checkedIds:function(){return this.__checkedRows},row_actions_check:function(e,t){if(e.$checked=!0,e.$tr){e.$tr.find(".id:first").addClass("checked")}t||(this.__checkedRows.push(e.id),this._headCellIdButtonsState())},row_actions_uncheck:function(e,t){e.$checked&&(e.$checked=!1,e.$tr&&($tdId=e.$tr.find(".id"),$tdId.removeClass("checked"),$tdId.find(".chbox i").attr("class","fa fa-square-o")),t||(this.__checkedRows.splice(this.__checkedRows.indexOf(e.id),1),this._headCellIdButtonsState()))},row_actions_icons_add:function(e){"use strict";let i,n;i=this.tableRow.panel?t('<button class="btn btn-default edit"><i class="fa fa-th-large"></i></button>').on("mouseleave",(function(){return t(this).blur(),!1})).css("margin-left",2):t(),this.control.editing&&(n=t('<button class="btn btn-default btn-xxs dropdown"  tabindex="-1" style=" margin-left: 2px;"><i class="fa fa-caret-down" style="font-size: 10px; width: 7px;"></i></button>'));let a=t('<button class="btn btn-default btn-xxs chbox"><i class="fa fa-square-o"></i></button>'),l=t('<span class="btn-group-xxs">');e.append(l).append(" ").append(a),n&&l.append(n),i&&l.append(i)},row_actions_panel_show:function(e){let i=e.closest("tr"),n=this._getItemByTr(i),a=n.id;const l=this;let o=t('<div id="row-mobile-panel"></div>');!0!==this.tableRow.panel?o.append(t('<div class="menu-item"><i class="fa fa-th-large"></i> Открыть панель</div>').css("color","gray")):o.append(t('<div class="menu-item row_panel"><i class="fa fa-th-large"></i> Открыть панель</div>').attr("data-tr",a)),!0!==this.control.duplicating||this.f.blockduplicate||n.f.blockduplicate?o.append(t('<div class="menu-item"><i class="fa fa-clone"></i> Дублировать</div>').css("color","gray")):o.append(t('<div class="menu-item row_duplicate"><i class="fa fa-clone"></i> Дублировать</div>').attr("data-tr",a)),-1!==["calcs","globcalcs"].indexOf(this.tableRow.type)?o.append(t('<div class="menu-item"><i class="fa fa-refresh"></i> Пересчитать</div>').css("color","gray")):o.append(t('<div class="menu-item row_refresh"><i class="fa fa-refresh"></i> Пересчитать</div>').attr("data-tr",a)),!this.control.deleting||this.f.blockdelete||n.f&&(n.f.block||n.f.blockdelete)?o.append(t('<div class="menu-item"><i class="fa fa-times"></i> Удалить</div>').css("color","gray")):o.append(t('<div class="menu-item row_delete"><i class="fa fa-times"></i> Удалить</div>').attr("data-tr",a));let s=App.mobilePanel(n[this.mainFieldName].v||"id: "+a,o);o.on("click",".row_delete, .row_duplicate, .row_refresh, .row_panel",(function(){let e=t(this);e.is(".row_delete")?l.rows_delete.call(l,a):e.is(".row_duplicate")?l.row_duplicate.call(l,a):e.is(".row_refresh")?l.row_refresh.call(l,a):e.is(".row_panel")&&l.rows_edit.call(l,i),s.close()}))},table_modify:function(e,i,n){"use strict";let a=this,l=0,o=0,s=n?n.data("field"):void 0;if(a.isPanel&&delete e.chdata.params,i&&(l=a.dataSorted.indexOf(i)+1,o=a.dataSortedVisible.indexOf(i)+1),e.chdata){let n=e.chdata.deleted||[],r=[];if(e.chdata.rows&&(e.refresh&&e.chdata.rows&&Object.keys(a.data).forEach((function(t){void 0===e.chdata.rows[t]&&n.push(parseInt(t))})),e.chdata.tree&&e.chdata.tree.forEach((e,t)=>{this.getTreeBranch(e,t)}),t.each(e.chdata.rows,(function(e,t){let i=a._getItemById(t.id);void 0===i?r.push(t):a.refreshRow(i.$tr,i,t)})),r.length)){App.isEmpty(a.data)&&a._content&&a._content.find(".pcTable-noDataRow").remove();let n=[];t.each(r,(function(t,s){if(s.$visible=!0,s.$checked=!1,l||!a.tableRow.with_order_field||a.tableRow.new_row_in_sort||(s.__inserted=!0),a.data[s.id]=s,a.isTreeView)a.placeInTree(s,null,!0),this.treeRefresh=!0;else{let t=l,r=o;!s.__after||i&&i.id===s.__after?"order"in e.chdata&&n.push(s.id):(t=a.dataSorted.indexOf(s.__after)+1,r=a.dataSortedVisible.indexOf(s.__after)+1),a.dataSorted.splice(t,0,s.id),a.dataSortedVisible.splice(r,0,s.id),l++,o++}})),i&&!a.isMobile&&setTimeout((function(){t.each(r,(function(e,t){a.row_actions_check(a.data[t.id])}))}),50)}if(n.length&&(t.each(n,(function(e,t){a._deleteItemById.call(a,t)})),App.isEmpty(a.data)&&a._content&&0===a._content.find("."+this.noDataRowClass).length&&a._content.append(a._createNoDataRow())),n.length||r.length||e.chdata.nsorted_ids&&a.nSorted&&!Object.equals(e.chdata.nsorted_ids,a.dataSorted)){if(e.chdata.nsorted_ids&&a.nSorted){let t=a.dataSortedVisible;a.dataSorted=e.chdata.nsorted_ids,t.length===a.dataSorted.length?a.dataSortedVisible=a.dataSorted:(a.dataSortedVisible=[],a.dataSorted.forEach((function(e){-1!==t.indexOf(e)&&a.dataSortedVisible.push(e)})))}this._refreshContentTable(0,!1,!0)}e.chdata.order&&(this.dataSorted=e.chdata.order,a.dataSortedVisible=[],a.dataSorted.forEach(e=>{this.data[e].$visible&&a.dataSortedVisible.push(e)}),this._refreshContentTable(0,!1,!0));let d={};if(e.chdata.params&&t.each(e.chdata.params,(function(e,t){["v","v_","f","e","h","c","ch"].forEach((function(i){a.data_params[e]&&(void 0!==t[i]||a.data_params[e][i])&&(Object.equals(a.data_params[e][i],t[i])&&e!==s||(d[e]=!0,a.data_params[e][i]=t[i]))}))})),e.chdata.fields&&t.each(e.chdata.fields,(function(e,i){i.list&&!Object.equals(a.fields[e].list,i.list)&&(d[e]=!0,t.extend(a.fields[e],i))})),(e.chdata.params||e.chdata.fields)&&(a._refreshParamsBlock(d,!0),a._refreshFootersBlock(d,!0)),e.chdata.f){let t=e.chdata.f;["blockadd","blockdelete","blockorder","background","blockduplicate","block","tabletitle","rowstitle","fieldtitle","tablecomment"].forEach((function(e){if(e in t||e in a.f)if("object"==typeof t[e]){if(!Object.equals(t[e],a.f[e])){let i=Object.assign({},a.f[e]);a.f[e]=t[e],a.__formatFunctions[e]&&a.__formatFunctions[e].call(a,t[e],i)}}else t[e]!==a.f[e]&&(a.f[e]=t[e],a.__formatFunctions[e]&&a.__formatFunctions[e].call(a,t[e]))}))}App.isEmpty(a.data)&&a._content&&a._content.empty().append(this._createNoDataRow()),this.treeRefresh&&this.treeApply()}e.updated&&(a.model.tableData.updated=JSON.parse(e.updated),a._refreshTitle()),a.isPanel||(e.filtersString&&a._refreshFiltersBlock.call(a,e),a._headCellIdButtonsState(),a.ScrollClasterized.insertToDOM(null,!0))},rows_edit:function(e){"use strict";let t=this,i=this.row_actions_get_checkedIds();return e&&-1===i.indexOf(t._getItemByTr(e).id)&&(this.row_actions_check(t._getItemByTr(e)),i=this.row_actions_get_checkedIds()),t._row_edit.call(t,i.slice()),!1},row_dropdown:function(e){"use strict";let i=t("<div>"),n=this._getItemByTr(e.closest("tr")),a=n.id;!0!==this.control.duplicating||this.f.blockduplicate||n.f.blockduplicate?i.append(t('<div class="menu-item"><i class="fa fa-clone"></i> Дублировать</div>').css("color","gray")):i.append(t('<div class="menu-item row_duplicate"><i class="fa fa-clone"></i> Дублировать</div>').attr("data-tr",a)),-1!==["calcs","globcalcs"].indexOf(this.tableRow.type)?i.append(t('<div class="menu-item"><i class="fa fa-refresh"></i> Пересчитать</div>').css("color","gray")):i.append(t('<div class="menu-item row_refresh"><i class="fa fa-refresh"></i> Пересчитать</div>').attr("data-tr",a)),this.isCreatorView&&"cycles"===this.tableRow.type&&i.append(t('<div class="menu-item cycle_refresh color-danger"><i class="fa fa-refresh"></i> Пересчитать цикл</div>').attr("data-tr",a)),!this.control.deleting||this.f.blockdelete||n.f&&(n.f.block||n.f.blockdelete)?i.append(t('<div class="menu-item"><i class="fa fa-times"></i> Удалить</div>').css("color","gray")):i.append(t('<div class="menu-item row_delete"><i class="fa fa-times"></i> Удалить</div>').attr("data-tr",a));let l=App.popNotify({isParams:!0,$text:i,element:e,container:this._container,trigger:"manual",placement:"bottom"});return t("#"+l).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",(function(){i.remove()})).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px"),!1},__getCheckedRowsIds:function(e,i,n){"use strict";let a=this,l=this.row_actions_get_checkedIds();if(e&&-1===l.indexOf(e)){let t=a.data[e];this.row_actions_check(t),l=this.row_actions_get_checkedIds()}if(i){let e=!1;if(l.some((function(t){if(a.data[t].f&&(a.data[t].f.block||a.data[t].f[n]))return e=a.data[t],!0})),e){let i="";"id"!==a.mainFieldName&&(i=e[a.mainFieldName]._v?e[a.mainFieldName]._v:e[a.mainFieldName].v,i=' "'+i+'"');let n=t("<span>").html("Строка <b>id "+e.id+"</b>");if(""!==i){let e=n.find("b");e.text(e.text()+i)}return n.append(" заблокирована"),App.notify(n,"Действие не выполнено"),!1}}return l},getRowTitle(e){return"id"!==this.mainFieldName?e[this.mainFieldName]._v?e[this.mainFieldName]._v:e[this.mainFieldName].v:e.id},row_refresh:function(e){"use strict";let t=this,i=this.__getCheckedRowsIds(e,!1),n=1===i.length?i[0]:null;if(i&&i.length){let e=[{label:"Пересчитать",action:function(e){t.model.refresh_rows(i).then((function(i){t.table_modify.call(t,i),e.close(),t.row_actions_uncheck_all()}))}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:"Точно пересчитать "+i.length+" строк?",title:"Пересчет",buttons:e,onhidden:function(){1===i.length&&i[0]==n&&t.row_actions_uncheck_all()},draggable:!0})}},cycle_refresh:function(e){"use strict";let t=this,i=this.__getCheckedRowsIds(e,!1);if(i&&i.length){let e=[{label:"Пересчитать",action:function(e){t.model.refresh_cycles(i).then((function(i){t.table_modify.call(t,i),e.close(),t.row_actions_uncheck_all()}))}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:"Точно пересчитать "+i.length+" циклов?",title:"Пересчет",buttons:e,draggable:!0})}},row_duplicate:function(e){"use strict";let i=this,n=this.__getCheckedRowsIds(e,!1);if(n&&n.length){let a=[{label:"Дублировать",cssClass:"btn-danger",action:function(a){let l={},o=[],s=[];i.dataSortedVisible.forEach((function(e){-1!==n.indexOf(e)&&s.push(e)})),n=s;const r=function(t){i.model.duplicate(n,l,e).then((function(n){i.table_modify.call(i,n,e),t&&t.close(),a.close(),i.row_actions_uncheck_all()}))};for(let e in i.fieldCategories.column){let t=i.fieldCategories.column[e];"unic"===t.type&&o.push(t.name)}if(o.length){let e,s=t('<table class="simpleTable"><thead><tr><td class="id">id</td></tr></thead><tbody></tbody></table>'),d=s.find("thead tr"),c=s.find("tbody");"id"!==i.mainFieldName&&(e=i.fields[i.mainFieldName],"unic"!==e.type?d.append(t("<td></td>").text(e.title)):e=null);for(let e in o){let n=i.fields[o[e]];d.append(t("<td></td>").text(n.title))}for(let a in n){let s=n[a],r=i.data[s],d=t("<tr>");l[s]={},d.append(t('<td class="id"></td>').text(s)),e&&d.append(t("<td></td>").text(r[e.name].v));for(let e in o){let n,a=i.fields[o[e]],c=t('<td class="input"></td>'),p=t("<input>").val(r[a.name].v);l[s][a.name]=r[a.name].v,p.on("keyup",(function(){let e=t(this).val();l[s][a.name]=e,n&&(clearTimeout(n),n=null),""!==e?n=setTimeout((function(){i.model.checkUnic(a.name,e).then((function(e){e.ok?c.addClass("ok"):c.removeClass("ok")}))}),300):a.required?c.removeClass("ok"):c.addClass("ok")})),c.html(p),d.append(c)}c.append(d)}let p=[{label:"Дублировать",cssClass:"btn-m btn-warning",action:function(e){r(e)}},{label:"Отмена",action:function(e){e.close(),a.close()}}];BootstrapDialog.show({message:s,title:"Заполните значения для уникальных полей",buttons:p,draggable:!0})}else r()}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:"Точно дублировать "+n.length+" строк?",title:"Дублирование",buttons:a,draggable:!0})}},rows_delete:function(e){let t=this,i=this.__getCheckedRowsIds(e,!0,"blockdelete"),n=1===i.length?i[0]:null;if(i&&i.length){let e="Точно удалить "+i.length+" строк?",a="Удаление "+i.length+" строк?";if(1==i.length){let n="id-"+i[0];"id"!=t.mainFieldName&&(n=t.data[i[0]][t.mainFieldName],n="id-"+i[0]+' "'+(n.v_&&n.v_[0]?n.v_[0]:n.v)+'"'),e="Точно удалить строку "+n+"?",a="Удаление строки "+n+"?"}let l=[{label:"Удалить",cssClass:"btn-danger",action:function(e){e.close();const n=function(){t.model.delete(i).then((function(e){t.table_modify.call(t,e)}))};t.tableRow.delete_timer>0?App.panelTimer(a,t.tableRow.delete_timer,n):n()}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:e,title:"Удаление",buttons:l,onhidden:function(){1===i.length&&i[0]==n&&t.row_actions_uncheck_all()},draggable:!0})}}})}(0,jQuery),t.extend(App.pcTableMain.prototype,{_insertItem:null,_insertRow:null,_insertButtons:null,_addButtons:null,_insertError:{},_currentInsertCellIndex:0,_addInsert:function(e){var t=this;this.control.adding&&(this._insertRow&&this._insertRow.length||(e&&(this._insertItem={},this.fieldCategories.column.forEach((function(i){e[i.name]&&(t._insertItem[i.name]={v:e[i.name]})}))),this._insertRow=this._createInsertRow(null,0),this._insertButtonsChangeStatuses(),this._beforebody.prepend(this._insertRow),this._table.addClass("with-adding-row")))},_insertButtonsChangeStatuses:function(){this._insertRow?(this._insertButtons&&this._insertButtons.find('[data-action="add"]').removeClass("btn-warning").addClass("btn-default").attr("disabled","disabled"),0===this.dataSortedVisible.length&&this._table.find(".pcTable-noDataRow button").removeClass("btn-warning").addClass("btn-default").attr("disabled","disabled")):(this._insertButtons&&this._insertButtons.find('[data-action="add"]').addClass("btn-warning").removeClass("btn-default").removeAttr("disabled"),0===this.dataSortedVisible.length&&this._table.find(".pcTable-noDataRow button").addClass("btn-warning").removeClass("btn-default").removeAttr("disabled"))},_InsertAddInsertBtnsPanel:function(e){let i,n=this,a={'<span id="saveInsertRow">Сохранить</span>':function(){i.is(".onSaving")||(i.addClass("onSaving"),n.__insertRowActions("saveInsertRow",(function(){n._saveInsertRow("close").always((function(){i.removeClass("onSaving")}))})))},'<i class="fa fa-save"></i>':function(){i.is(".onSaving")||(i.addClass("onSaving"),n.__insertRowActions("saveInsertRow",(function(){n._saveInsertRow.call(n).always((function(){i.removeClass("onSaving")}))})))},'<i class="fa fa-paste"></i>':function(){i.is(".onSaving")||(i.addClass("onSaving"),n.__insertRowActions("saveInsertRow",(function(){n._saveInsertRow.call(n,"notClean").always((function(){i.removeClass("onSaving")}))})))},'<i class="fa fa-times"></i>':function(){n._closeInsertRow.call(n,t(this).closest("#"+o))}};i=this._addRowPanel(o,e,a),this._addButtons=i.find("button:not(:last)")},__insertRowActionsStack:[],__insertRowActions:function(e,t){"use strict";let i=this;-1!==["saveInsertRow","clickSourceButton"].indexOf(e)&&setTimeout((function(){i.model.getDefferedProcess().then(t)}),450)},_saveInsertRow:function(e){let i=this,n={},a=t.Deferred();if(Object.keys(i._insertError).length){let e=Object.keys(i._insertError)[0],n=i._insertError[e];App.notify(n,t("<div>Ошибка в поле </div>").append(" в поле ").append(t("<span>").text(i.fields[e].title||i.fields[e].name))),i._currentInsertCellIndex=i.fieldCategories.visibleColumns.findIndex((function(t){if(t.name===e)return!0})),i._insertFocusIt(),a.reject()}else{let l=function(){t.each(i._insertItem,(function(e,t){"n"!==e&&(n[e]=t.v)})),i.model.add(n).then((function(t){switch(i.table_modify.call(i,t),i._currentInsertCellIndex=0,e){case"notClean":break;case"close":i._closeInsertRow();break;default:i._insertItem=null,i._insertRow.html('<td class="id"></td>'),i._createInsertRow(i._insertRow,0)}})).always((function(){a.resolve()}))};i.model.doAfterProcesses(l)}return a.promise()},_addInsertRow:function(){let t=this;"cycles"===this.tableRow.type?t.model.add({}).then((function(i){i.firstTableId?e.location.href=e.location.pathname+"/"+i.chdata.rows[0].id+"/"+i.firstTableId:t.table_modify(i)})):t.isMobile?t._addInsertWithPanel():t._addInsert()},_getInsertButtons:function(){let i,n,a=this;return"cycles"===this.tableRow.type?n=i=function(){a.model.add({}).then((function(t){t.firstTableId?e.location.href=e.location.pathname+"/"+t.chdata.rows[0].id+"/"+t.firstTableId:a.table_modify(t)}))}:(i=function(){a.isMobile?a._addInsertWithPanel():a._addInsert()},n=function(){a._addInsertWithPanel()}),this._insertButtons=t("<span>"),"panels"===this.viewType?t('<button data-action="add" class="btn btn-sm btn-warning">Добавить</button>').width(80).on("click",n).appendTo(this._insertButtons):(2!==this.tableRow.id&&t('<button data-action="add" class="btn btn-sm btn-warning">Добавить</button>').width(80).on("click",i).appendTo(this._insertButtons),!a.isMobile&&this.tableRow.panel&&t('<button class="btn btn-warning btn-sm"><i class="fa fa-th-large"></i></button>').on("click",n).appendTo(this._insertButtons).css("margin-left",5)),this._insertButtons},_addInsertWithPanel:function(e){let t=this;new EditPanel(t,null,e||{}).then((function(e){e&&t.table_modify.call(t,e)}))},_closeInsertRow:function(){this._insertPanel?this._insertPanel=null:this._insertRow&&(this._insertRow.find("td").each((function(){t(this).remove()})),this._insertRow.remove(),this._insertRow=null),this._insertItem=null,this._insertButtonsChangeStatuses(),this._currentInsertCellIndex=0,this._table.removeClass("with-adding-row")},_createInsertRow:function(e,i,n){var a=this,o=a._insertItem||(a._insertItem={});e||(this.insertRow=e=t('<tr class="InsertRow" style="height: 35px;"><td class="id"></td></tr>'),this._InsertAddInsertBtnsPanel(e),this.insertRow.editedFields={}),a._currentInsertCellIndex||(a._currentInsertCellIndex=0);let s={};t.each(a._insertItem,(function(e,t){"n"!==e&&(s[e]=t.v)}));let r=[];return a.fieldCategories.visibleColumns.forEach((function(e){r.push(e.name)})),a.model.checkInsertRow(s,Object.keys(this.insertRow.editedFields)).then((function(i){o=i.row;let s=2;t.each(a.fieldCategories.column,(function(t,i){if(!i.showMeWidth)return void(a._insertItem[i.name]=o[i.name]);let d=r.indexOf(i.name);var c=e.find("td:eq("+(d+1)+")");let p=a._insertItem[i.name],f=a._insertItem[i.name]&&a._insertItem[i.name].force;if(a._insertItem[i.name]=o[i.name],c.length){let t="n"===i.name||a._insertItem[i.name].f&&!0===a._insertItem[i.name].f.block;if(c.data("input")&&!t){i.name;let t=!1;t=!f&&(null===o[i.name].v&&""==p.v||Object.equals(o[i.name].v,p.v)&&!i.codeSelectIndividual),(void 0===p||!t||"data_src"==i.name||"comments"==i.type||i.code&&!i.codeOnlyInAdd)&&(a._createInsertCell.call(a,c,i,e,d,"td",a._createInsertRow),n===i.name&&a._colorizeElement(c,l))}else c.replaceWith(a._createInsertCell.call(a,null,i,e,d,"td",a._createInsertRow))}else e.append(c=a._createInsertCell.call(a,null,i,e,d,"td",a._createInsertRow));c.data("input")&&c.data("input").attr("tabindex",s++)})),a._addButtons.each((function(e,i){t(i).attr("tabindex",s++)})),a._insertFocusIt.call(a)})),e},_createInsertCell:function(i,n,l,o,s,r){s=s||"td";i=i||t("<"+s+">");var d=this;n.code&&i.addClass("with-code"),void 0===d._insertItem[n.name]&&(d._insertItem[n.name]=null);let c=d._insertItem[n.name]&&d._insertItem[n.name].f||{};if(!n.insertable||!0===c.block){let e=d._insertItem[n.name];if(e&&(e=e.v),i.empty().append(t('<span class="cell-value">').html(c.text?c.text:n.getCellText(e,i,d._insertItem))),c.comment){let e=t('<i class="fa fa-info pull-right" style="padding: 3px;">');e.attr("title",c.comment),i.prepend(e)}else if(c.icon&&"button"!==n.type){let e=t('<i class="fa fa-'+c.icon+' pull-right" style="padding: 3px;">');i.prepend(e)}return(c.icon||c.text||c.comment)&&i.on("click",()=>{let a=t("<div>"),l=t("<div>").text(e).appendTo(a);if(c.icon){let e=t('<i class="fa fa-'+c.icon+'" style="padding: 3px;">');l.prepend(e)}if(c.text){let e=t('<div><i class="fa fa-font" style="padding: 3px;"> </div>');e.append(c.text),a.append(e)}if(c.comment){let e=t('<div><i class="fa fa-info" style="padding: 3px;"> </div>');e.append(c.comment),a.append(e)}if(!d.isMobile){let e="right",n=a.offset().left,l=d._container.offset().left;d._container.width()-(n-l)-a.width()<(a.is(".text")?340:240)&&(e="left");let o={isParams:!0,$text:a,element:i,container:d._container,placement:e,trigger:"manual"};App.popNotify(o);let s="keyup.insertPanelDestroy",r="click.insertPanelDestroy";const c=function(){t("body").off(".selectPanelDestroy"),i.popover("destroy")};return t("body").on(r,(function(e){0===t(e.target).closest("#selectPanel").length&&c()})).on(s,(function(e){27==e.which&&c()})),!1}App.mobilePanel(n.title,a)}),i}n.help&&i.on("focus","input,button,select",(function(e){let i=d._table.find("thead th #field-help-"+n.name),a=t(e.target);setTimeout((function(){i.trigger("open"),a.one("blur remove",(function(){i.trigger("close")}))}),120)}));var p=function(e){var t;try{t=n.getEditVal(e),delete d._insertError[n.name],m.removeClass("error")}catch(e){return m.addClass("error"),d._insertError[n.name]=e,null}return t},f=function(e,t){var a=p(e);null===a?d._insertFocusIt.call(d):(d._currentInsertCellIndex=o+1,n.isDataModified(a,d._insertItem[n.name].v)?(d.insertRow.editedFields[n.name]=!0,d._insertItem[n.name].v=a,!0===n.isPanelField&&d._createInsertCell.call(d,i,n,l,o,s,r),r.call(d,l,d._currentInsertCellIndex,n.name)):d._insertFocusIt.call(d))},h=function(e,t){setTimeout((function(){let t=e.closest("td");if(!t.length||!t.closest("tr").length)return!1;let i=p(e);n.isDataModified(i,d._insertItem[n.name].v)&&(d._currentInsertCellIndex++,d.insertRow.editedFields[n.name]=!0,d._insertItem[n.name].v=i,!0===n.isPanelField&&d._createInsertCell.call(d,t,n,l,o,s,r),r.call(d,l,d._currentInsertCellIndex,n.name))}),150)},u=function(e,t){let i=e.closest("td");if(!i.length||!i.closest("tr").length)return!1;let c=p(e),f=d._insertItem[n.name].v+"";n.isDataModified(c,f)&&(d._createInsertCell(i,n,l,o,s,r),d._colorizeElement(i,a))};let m=n.getEditElement(i.data("input"),d._insertItem[n.name],d._insertItem,f,u,h);if(c&&c.placeholder&&n.addPlaceholder&&n.addPlaceholder(m,c.placeholder),i.on("click focus","input,button,select",(function(e){setTimeout(()=>{d._currentInsertCellIndex=o},200)})),i.on("click focus",(function(){d._currentInsertCellIndex=o})),m.isAttached()||i.html(m).data("input",m),n.code&&!n.codeOnlyInAdd){let e=i.find(".fa-hand-paper-o");this.insertRow.editedFields[n.name]&&d._insertItem[n.name].h?0===e.length&&(e=t('<i class="fa fa-hand-paper-o pull-right">').on("click",()=>{delete this.insertRow.editedFields[n.name],r.call(d,l,d._currentInsertCellIndex+1,n.name)}),i.prepend(e).addClass("ins-handed")):(1===e.length&&e.remove(),i.removeClass("ins-handed"))}if("select"===n.type&&2===n.changeSelectTable){i.addClass("with-source-add-button");let a=t('<button class="btn btn-default btn-sm source-add" tabindex="-1"><i class="fa fa-plus"></i></button>');i.prepend(a);let o=function(){let a={},o=d._insertItem;t.each(o,(function(e,t){"$"!==e.substring(0,1)&&(a[e]=t)}));a[n.name]=null;let s=0;return t(e.top.document.body).on("pctable-opened.select-add-"+n.name,(function(){s++})).on("pctable-closed.select-add-"+n.name,(function(e,a){s--;let c=a&&"insert"===a.method&&a.json&&a.json.chdata&&a.json.chdata.rows;if(0===s||c){let e=m;delete n.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),c&&(n.multiple?o[n.name].v.push(Object.keys(a.json.chdata.rows)[0]):o[n.name].v=Object.keys(a.json.chdata.rows)[0]),e.replaceWith(m=n.getEditElement(e,o[n.name],o,f,u,h)),t("body").off(".select-add-"+n.name),i.data("input",m),r.call(d,l,d._currentInsertCellIndex,n.name)}})),d.model.selectSourceTableAction(n.name,a),!1};a.on("click",(function(){d.__insertRowActions("clickSourceButton",o)}))}return i},_insertFocusIt:function(e){let i=this;if(!e)return setTimeout((function(){i._insertFocusIt.call(i,1)}),10),!1;let n=!0,a=!!this._insertPanel,l=this.insertRow;if(a){if(!i._insertPanel)return!1;l=i._insertPanel.$modalBody}if(!l||!l.length)return!1;if(t.each(i.fieldCategories.visibleColumns,(function(e,t){if(i._currentInsertCellIndex==e)return!t.insertable||i._insertItem&&i._insertItem[t.name]&&i._insertItem[t.name].f&&!0===i._insertItem[t.name].f.block?void i._currentInsertCellIndex++:(a?t.focusElement(l.find(".cell:eq("+e+")").data("input")):t.focusElement(i._getTdByColumnIndex(l,e+1).data("input")),n=!1,!1)})),n)if(a){i._insertPanel.indexedButtons[Object.keys(i._insertPanel.indexedButtons)[0]].focus()}else t("#saveInsertRow").parent().focus()}}),function(){const i=function(e){e.forEach(e=>{let t=e.th.outerHeight();e.th.remove(),e.tdWrapper.data("height")&&e.tdWrapper.css("height",e.tdWrapper.data("height")+parseInt(t))})};t.extend(App.pcTableMain.prototype,{_rerenderColumnsFooter:function(){let e=this._createFootersTableBlock();this._footersBlock.replaceWith(e),this._footersBlock=e},_rerendParamsblock:function(){this._createParamsBlock(),this.isMobile&&this._refreshParamsBlock()},_rerendFiltersBlock:function(){this._filtersBlock.replaceWith($block=this._createFiltersBlock()),this._filtersBlock=$block,this._refreshFiltersBlock(this.data_params)},_rerendBottomFoolers:function(){this._createFootersSubtable(),this.isMobile&&this._refreshFootersBlock()},_renderTable:function(){let e=this;this._table=t("<table>").addClass(this.tableClass),this.notCorrectOrder&&this._table.addClass("no-correct-n-filtered"),this._table.append(this._createHead()).append(this._createFirstBody()).append(this._createBody()).append(this._createAfterBody()),this._footersBlock=this._createFootersTableBlock(),this._table.append(this._footersBlock),this._popovers=t('<div class="popovers">'),e.isTreeView?e._connectTreeView.call(e):this.addReOrderRowBind(),1===this.fieldCategories.column.length&&e._container.addClass("no-fields");let i=this.scrollWrapper=this._container.append('<div class="pcTable-scrollwrapper">').find(".pcTable-scrollwrapper");i.append(this._createBeforeSpace()).append(this._createTableText()),this.isCreatorView&&i.append(this._refreshHiddenFieldsBlock()),this._paramsBlock=this._createParamsBlock(i);let n=t('<div class="pcTable-rowsWrapper">').appendTo(i);n.append(this._createRowsTitle(n)).append(this._createFiltersBlock()).append(()=>{if(this.tableRow.pagination&&"0/0"!==this.tableRow.pagination)return this._pagination()}).append(this._rowsButtons()).append(this._innerContainer),this._footersSubTable=this._createFootersSubtable(i),i.append(this._footersSubTable).append(this._popovers),this.addScrollsRules(),this._seeCalcucatedValData(),this._seeSelectPreview(),this._clickstoCopyMe(),this.isCreatorView&&this._hideHell_storage.checkIssetFields.call(this)},_refreshHiddenFieldsBlock:function(){let e=this._hiddenFieldsBlock();return this.HiddenFieldsBlock&&this.HiddenFieldsBlock.replaceWith(e),this.HiddenFieldsBlock=e,this.HiddenFieldsBlock},_hiddenFieldsBlock:function(){let e,i,n=this,a=0,l=t('<div class="pcTable-hiddenFieldsTables">'),o=0;if(this.beforeSpaceHide||!this._hideHell_storage.getOpened.call(this))return l;let s=this._container.width()-100;return t.each(n.hidden_fields||[],(function(r,d){a++;let c=d.width>0?d.width:100;(0===o||s<o+c)&&(e&&e.width(o),e=t("<table class='pcTable-hiddenFieldsTable'><thead><tr></tr></thead></table>\""),l.append(e),o=0,i=e.find("thead tr")),i.append(n._createHeadCell(r,d)),o+=d.width})),n.isCreatorView&&Object.keys(n.fields).forEach((function(r,d){let c=n.fields[r];if(c.showInWeb&&c.showMeWidth<1&&"n"!==c.name){a++;let r=c.width>0?c.width:100;(0===o||s<o+r)&&(e&&e.width(o),e=t("<table class='pcTable-hiddenFieldsTable'><thead><tr></tr></thead></table>\""),l.append(e),o=0,i=e.find("thead tr")),i.append(n._createHeadCell(d,c)),o+=c.width}})),e&&e.width(o),a?l:t('<div class="pcTable-hiddenFieldsTables">')},_clickstoCopyMe:function(){this._container.on("click",".copy_me",(function(){let e=t(this);return e.data("clicked")||(e.data("clicked",!0),e.width(e.width()),e.data("text")?App.copyMe(e.data("text")):App.copyMe(e.text()),e.button("copied"),setTimeout((function(){e.button("reset"),e.removeData("clicked")}),2e3),e.blur()),!1}))},_clicksToCodeView:function(){let i=this;this._container.on("click","th .roles",(function(){let n=t(this);if(n.hasClass(".fa-sun-o")||n.hasClass("fa-certificate")){let a,l=i._getFieldBytd(n.closest("th")),o=t('<div class="HTMLEditor" id="bigOneCodemirror" style="height: 100%;"></div>');BootstrapDialog.show({message:o,type:null,title:"Просмотр кода поля "+l.title,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){mirror.setValue(a.getValue())},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"})},onshown:function(t){a=CodeMirror(o.get(0),{mode:"totum",value:l.code[0],theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:t,readOnly:!0}),mirror.table&&(a.table=mirror.table);let i=Math.round(t.$modalContent.height()-t.$modalHeader.outerHeight()-40);a.getScrollerElement().style.minHeight=i+"px",o.find(".CodeMirror").css("min-heught",i),a.focus(),t.$modalContent.position({my:"center top",at:"center top+30px",of:e})}})}}))},_seeCalcucatedValData:function(){var e=this;this._container.on("mouseover","td .fa-hand-paper-o",(function(){if(!e.isMobile){var i=t(this),n=i.closest("td");if(n.closest("tr").is(".InsertRow"))return!1;var a=e._getItemBytd(n),l=e._getFieldBytd(n),o=t("<div>");let s="";null===a[l.name].c||""===a[l.name].c||void 0===a[l.name].c?s="":"select"===l.type?l.multiple?t.each(a[l.name].c,(function(e,t){""!==s&&(s+=", "),s+=l.getElementString(a[l.name].c[e],a[l.name].c_[e])})):s=l.getElementString(a[l.name].c,a[l.name].c_):(s=l.getCellText(a[l.name].c,null,a,e),"object"==typeof s&&(s=s.text())),o.append(t("<div>Расчетное значение: </div>").append(t("<code>").text(s))),i.one("mouseout",(function(){o.length&&(o.remove(),o=null)})),setTimeout((function(){o&&o.length&&App.popNotify(o,i)}),500)}}))},_seeSelectPreview:function(){var e=this;t("body").on("mouseover",".select-with-preview li",(function(i){let n=t(this),a=setTimeout((function(){if(n.is(":hover")){let t=n.find("span.select-with-preview");e.fields[t.data("field")]&&e.fields[t.data("field")].previewPanel.call(e.fields[t.data("field")],t,n)}}),300);n.one("mouseout",(function(){a&&clearTimeout(a)}))}))},_getFavoriteStar:function(){let e=this.tableRow.__is_in_favorites=this.tableRow.__is_in_favorites||!1,i=t("#favorite-start"),n=this;return null===e?t():(0===i.length&&(i=t('<button class="btn btn-default btn-sm" id="favorite-start"></button>').on("click",(function(){n.model.setTableFavorite(!i.is(".stared")).then((function(e){n.tableRow.__is_in_favorites=e.status,n._getFavoriteStar.call(n)}))}))),e?i.addClass("stared").text("★"):i.removeClass("stared").text("☆"),i)},_createBeforeSpace:function(){let i,a=this;if(this._beforeSpace=t('<div class="pcTable-beforeSpace">'),!a.beforeSpaceHide){a.LogButton=t(),i=t('<div class="pcTable-topButtons">');let e=t("#TOTUM_FOOTER");if(e.length&&i.append(e),a.isCreatorView){let n=t('<div class="creator-log-buttons">'),l=t('<button class="btn btn-danger btn-sm"><i class="fa" style="width: 12px"></i> Показать логи</button>').appendTo(n).on("click",(function(){let e;const i=function(){let i=[];e.find("input:checked").each((function(e,n){i.push(t(n).attr("name"))})),i.length>0?l.find("i").attr("class","fa fa-check-square-o"):l.find("i").attr("class","fa fa-square-o"),t.cookie("pcTableLogs",JSON.stringify(i),{path:"/"}),a.FullLOGS=[],a.LOGS={},l.popover("destroy")};if(l.is("[aria-describedby]"))e=t("#"+l.attr("aria-describedby")),i();else{let n=t.cookie("pcTableLogs")||"[]";n=JSON.parse(n),e=t("<div>"),e.append('<div><input type="checkbox" name="c"/> Код</div>'),e.append('<div><input type="checkbox" name="a"/> Код-действия</div>'),e.append('<div><input type="checkbox" name="s"/> Селекты</div>'),e.append('<div><input type="checkbox" name="f"/> Форматирование</div>'),e.append('<div><input type="checkbox" name="recalcs"/> Пересчеты и селекты</div>');let o=t('<div><input type="checkbox" name="flds"/> Время расчета полей </div>');e.append(o),a.FieldLOGS&&a.FieldLOGS.length&&a.FieldLOGS.forEach(e=>{let i=t('<div style="cursor: pointer"><button class="btn btn-xs"><i class="fa fa-table"></i></button> '+e.name+"</div>").on("click",(function(){a.model.calcFieldsLog(JSON.stringify(e.data),e.name)}));o.append(i)}),e.append('<div style="padding-top: 10px;"><button class="btn btn-sm btn-default">Применить</button></div>'),e.find("input").each((function(e,i){i=t(i),-1!==n.indexOf(i.attr("name"))&&i.prop("checked","checked")})),e.on("click","button",(function(){i()})),l.popover({trigger:"manual",placement:"bottom",content:e,html:!0,animation:!1,container:a._container,onhide:function(){}}).popover("show")}})),o=l.find("i"),s=t.cookie("pcTableLogs")||"[]";s=JSON.parse(s),s.length>0?o.addClass("fa-check-square-o"):o.addClass("fa-square-o");let r=t('<button class="btn btn-danger btn-sm">Лог</button>').appendTo(n);a.LogButton=r,r.on("click",(function(){a.FullLOGS&&0!==a.FullLOGS.length?App.logOutput(a.FullLOGS):App.logOutput("Лог пуст. Включите логирование и перегрузите страницу")})),e.length?e.append(n):n.appendTo(i),t('<button class="btn btn-danger btn-sm"><i class="fa fa-eraser" style="width: 13px"></i></button>').on("click",(function(){a.FullLOGS=[],a.FieldLOGS=[],a.LOGS={}})).appendTo(n)}}let l=t('<span class="common-table-title">');if(!a.isMobile){l.append(this.fieldsHiddingGetButton(!0));t('<button class="btn btn-default btn-sm"><i class="fa fa-print"></i></button>').on("click",(function(){a._print.call(a)})).appendTo(l);if(a.withCsvButtons){let e=t('<button class="btn btn-default btn-sm">CSV-экспорт</button>').on("click",(function(){let i=t('<div><div class="menu-item" data-type="full">Полный</div><div class="menu-item"  data-type="rows">Только строки</div></div>');i.on("click",".menu-item",(function(){let e=t(this).is('[data-type="full"]')?"full":"rows";i.remove(),a._csvExport(e)}));let n=App.popNotify({isParams:!0,$text:i,element:e,container:this._container,trigger:"manual",placement:"bottom"});t("#"+n).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",(function(){i.remove()})).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px")}));l.append(e)}if(a.withCsvEditButtons&&this.control.editing){let e=t('<button class="btn btn-default btn-sm">CSV-импорт</button>').on("click",(function(){let i=t('<div><div class="menu-item" data-type="full">Полный</div><div class="menu-item"  data-type="rows">Только строки</div></div>');i.on("click",".menu-item",(function(){let e=t(this).is('[data-type="full"]')?"full":"rows";i.remove(),a._csvImportClick(e)}));let n=App.popNotify({isParams:!0,$text:i,element:e,container:this._container,trigger:"manual",placement:"bottom"});t("#"+n).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",(function(){i.remove()})).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px")}));l.append(e)}}if(this.isAnonim||a.beforeSpaceHide||l.append(this._getFavoriteStar()),this.tableRow.panels_view&&"both"===this.tableRow.panels_view.state){let i;i="panels"!==this.viewType?t('<button class="btn btn-default btn-sm"><i class="fa fa-address-card-o"></i></button>').on("click",()=>{this.model.panelsView(!0).then(()=>{e.location.reload()})}):t('<button class="btn btn-default btn-sm"><i class="fa fa-table"></i></button>').on("click",()=>{this.model.panelsView(!1).then(()=>{e.location.reload()})}),l.append(i)}if(this.isCreatorView&&this.isMain){let l=t('<div class="creator-buttons">');t('<button class="btn btn-default btn-xxs field_name copy_me" data-copied-text="Скопировано"/>').text(this.tableRow.name).appendTo(l),t('<button class="btn btn-danger btn-xxs" title="Редактировать настройки таблицы"/>').html('<i class="fa fa-pencil-square-o"></i>').on("click",(function(){new EditPanel(1,BootstrapDialog.TYPE_DANGER,{id:a.tableRow.id}).then((function(t){t&&e.location.reload(!0)}))})).appendTo(l);let o={fl_name:[this.tableRow.id]};if(t('<a href="/Table/'+this.Tables.branchId+"/"+this.Tables.id+"/?"+t.param({f:o})+'" target="_blank" class="btn btn-danger btn-xxs" title="Открыть список таблиц"/>').html('<i class="fa fa-external-link"></i>').appendTo(l),o={f_table_categories:this.tableRow.category,f_table:this.tableRow.id},this.tableRow.__version&&(o.fl_version=this.tableRow.__version),t('<a href="/Table/'+this.Tables.branchId+"/"+this.TableFields.id+"/?"+t.param({f:o})+'" target="_blank" class="btn btn-danger btn-xxs" title="Открыть состав таблиц"/>').html('<i class="fa fa-external-link-square"></i>').appendTo(l),"calcs"===this.tableRow.type){l.append(" ");let e=t('<a href="/Table/'+this.TablesVersions.branchId+"/"+this.TablesVersions.id+"?"+t.param({f:this.calcstable_cycle_version_filters})+'" target="_blank" class="btn btn-danger btn-xxs" title="Создание версий таблиц"><i class="fa fa-code-fork"></i></a>');l.append(e),l.append(" "),e=t('<a href="/Table/'+this.TablesCyclesVersions.branchId+"/"+this.TablesCyclesVersions.id+"?"+t.param({f:this.calcstable_versions_filters})+'" target="_blank" class="btn btn-danger btn-xxs" title="Изменение версий таблиц цикла"><i class="fa fa-random"></i></a>'),l.append(e)}let s=t('<div class="color-danger creator-table-title">'+ +this.tableRow.sort+' <i class="'+App.tableTypes[this.tableRow.type].icon+'"></i> '+App.tableTypes[this.tableRow.type].title+" ["+this.tableRow.actual+"]</div>");l.append(s),"calcs"===this.tableRow.type&&s.append(" / Версия "+this.tableRow.__version+" / Цикл "+this.tableRow.cycle_id);t('<button class="btn btn-danger btn-sm" id="hide-hell" disabled><i class="fa fa-times"></i></span></button>').on("click",(function(){a._hideHell_storage.switchOpened.call(a)})).appendTo(l);l.appendTo(i);t('<button class="btn btn-danger btn-sm">Добавить поле</span></button>').width(113).on("click",(function(){let t={table_id:{v:a.tableRow.id},data_src:{v:n}};a.tableRow.__version&&(t.version={v:a.tableRow.__version}),new EditPanel(2,BootstrapDialog.TYPE_DANGER,t).then((function(t){t&&e.location.reload(!0)}))})).appendTo(l);l.appendTo(i)}if(a.beforeSpaceHide)this._beforeSpace_title=t('<div class="pcTable-title"><span class="bttns"/></div>').prependTo(this._beforeSpace);else if(this._beforeSpace.append(i),this._beforeSpace_title=t('<div class="pcTable-title"><span class="title"/><span class="bttns"/><div class="updated"/></div>').prependTo(this._beforeSpace),"calcs"===this.tableRow.type&&e.TREE_DATA){let i,n,a=t('<div class="pcTable-tabls"><ul class="nav nav-tabs"></div>'),l=a.find("ul");if(e.location.pathname.match(/^\/[^\/]+\/\d+\/\d+\/\d+\/\d+$/)){i=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+).*?$/,"$1"),n=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+\/[^\/]+).*?$/,"$1");let t=!1;e.TREE_DATA.forEach(e=>{e.isCycleTable&&(t||(e.isOneUserCycle||l.append('<li><a href="/Table/'+n+'/"><i class="fa fa-arrow-left"></a></li>'),t=!0),e.id==="table"+this.tableRow.id?l.append('<li class="active"><a class="tab-title">'+e.text+"</a></li>"):l.append('<li><a href="/Table/'+i+"/"+e.href+'">'+e.text+"</a></li>"))})}else{n=e.location.pathname.replace(/^\/[^\/]+\/([^\/]+).*?$/,"$1");let t=!1;e.TREE_DATA.forEach(e=>{e.isCycleTable&&(t||(l.append('<li><a href="/Table/'+n+'/"><i class="fa fa-arrow-left"></a></li>'),t=!0),e.id==="table"+this.tableRow.id?l.append('<li class="active"><a class="tab-title">'+e.text+"</a></li>"):l.append('<li><a href="'+e.link+'">'+e.text+"</a></li>"))})}this._beforeSpace.append(a)}if(this._beforeSpace_title.append(l),this.tableRow.description){let e=t('<a class="btn btn-default btn-sm"><i class="fa fa-info"></i></a>'),i=t('<div class="table-description"/>').html(this.tableRow.description);e.appendTo(l);let n="table_description_switcher"+this.tableRow.id,a=localStorage.getItem(n)||localStorage.setItem(n,"1")||localStorage.getItem(n);const o=t=>{switch(t&&(a="1"===a?"0":"1"),a){case"1":i.show(),e.removeClass("btn-warning").addClass("btn-default");break;default:i.hide(),e.addClass("btn-warning").removeClass("btn-default")}localStorage.setItem(n,a),t&&this.ScrollClasterized.insertToDOM(0,!0)};o(),e.on("click",o),this._beforeSpace.append(i)}return this._beforeSpace},__$rowsButtons:null,_paginationCreateBlock:function(){let{offset:e,onPage:i,allCount:n}=this.PageData;if("0"==i)return"";let a,l,o,s,r=t("<span></span>"),d=0===e?0:Math.ceil(e/i),c=Math.ceil(n/i);a=e>0?t('<button class="btn btn-default btn-sm"><i class="fa fa-hand-o-left"></i></button>').on("click",()=>(this.model.loadPage(this,null,this.PageData.onPage,this.PageData.firstId),!1)):t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-hand-o-left"></i></button>'),e+i<n?(l=t('<button class="btn btn-default btn-sm"><i class="fa fa-hand-o-right"></i></button>').on("click",()=>{Object.keys(this.data);return this.model.loadPage(this,this.PageData.lastId,this.PageData.onPage),!1}),s=t('<button class="btn btn-default btn-sm"><i class="fa fa-long-arrow-right"></i></button>').on("click",()=>(this.model.loadPage(this,null,this.PageData.onPage,-1),!1))):(l=t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-hand-o-right"></i></button>'),s=t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-long-arrow-right"></i></button>')),o=d>0?t('<button class="btn btn-default btn-sm"><i class="fa fa-long-arrow-left"></i></button>').on("click",()=>(this.model.loadPage(this,0,this.PageData.onPage),!1)):t('<button class="btn btn-default btn-sm" disabled><i class="fa fa-long-arrow-left"></i></button>');let p=t('<span id="ttm-onpage-input"></span>'),f=t('<input class="form-control" type="number">').appendTo(p).wrap("<span>");return f.val(i),f.on("change",()=>{this.PageData.onPage=parseInt(f.val()),this.model.loadPage(this,0,f.val())}),r.append(o),r.append(a),r.append('<span class="ttm-pages">'+(d+1)+" из "+c+"</span>"),r.append(l),r.append(s),r.append(p),p.append(" из "+n),c>1&&(r.addClass("ttm-pagination-warning"),p.append(' <i class="fa fa-square"></i>')),r},_pagination(){if(void 0===this.PageData||this.PageData.loading){if(this.PageData||(this.PageData={$block:t('<div class="ttm-pagination"></div>')}),this.data){let e=Object.keys(this.data);e.length>0&&(n=e[e.length-1])}let e=this.tableRow.pagination.split("/"),i=this.isMobile?e[1]:e[0],n=e[2]||null;return this.PageData.onPage=parseInt(i),this.model.loadPage(this,n,i),this.PageData.$block.empty().append('<i class="fa fa-spinner"></i>')}return this.PageData.$block.empty().append(this._paginationCreateBlock())},rowButtonsCalcWidth:function(){this.tableWidth<this._innerContainer.width()?this.isMobile?this.__$rowsButtons.width(this._table.width()):this.__$rowsButtons.width(this._table.width()-70):this.isMobile||this.__$rowsButtons.width(this._innerContainer.width()-5)},_rowsButtons:function(){let e,i=this;if(this.__$rowsButtons?e=this.__$rowsButtons.empty():(e=t('<div class="pcTable-buttons">'),this.__$rowsButtons=e),this.fieldCategories.column.length){if(this.control.adding&&!this.f.blockadd){let t=i._getInsertButtons();e.append(t)}if(!this.isTreeView){let n=t('<button class="btn btn-default btn-sm" style="margin-left: 5px;" disabled>Сбросить <span class="fa fa-filter"></span></button>').width(82).on("click",(function(){setTimeout((function(){i.filtersEmpty.call(i)}),50)}));e.append(n),this.filtersClearButton=n}}if(this.f.tablecomment){let n=t('<div class="pcTable-tableComment">').on("click",(function(){App.panel("Комментарий строчной части таблицы",i.f.tablecomment)}));e.prepend(n.text(this.f.tablecomment)),setTimeout((function(){let e=0;e+=n.parent().find(">span").width()||0,e+=90,n.css("width","calc(100% - "+e+"px)")}),1)}return e},_refreshContentTable:function(e,t){let i=this._content;t=t||!1,i.data("state","refreshing");App.fullScreenProcesses.showCog();this.ScrollClasterized.insertToDOM(0,t,e),App.fullScreenProcesses.hideCog(),i.data("state","ready"),i.trigger("refreshed"),this._popovers.empty()},_refreshTitle:function(){if(!this.beforeSpaceHide&&(this._beforeSpace_title.find(".title").text(this.f.tabletitle||this.tableRow.title),this.model.tableData&&this.model.tableData.updated)){let e;this.isAnonim||(e=moment(this.model.tableData.updated.dt,"YYY-MM-DD HH:mm").format("DD.MM HH:mm")+" (code: "+this.model.tableData.updated.code+")");let i=t('<div class="small">').text(e);this.tableRow.__blocked?i.append('<div class="">Блокирована'+(this.tableRow.license_error?": "+this.tableRow.license_error:"")+"</div>"):!1===this.control.editing&&i.append('<div class="">Только чтение</div>'),this._beforeSpace_title.find(".updated").html(i)}},_createTableText:function(){return this.tableText=t('<div class="pcTable-tableText"></div>').html(this.f.tabletext),this.f.tablehtml&&this.tableText.append(this.f.tablehtml),this.tableText},_refreshTableText:function(){this.tableText.text(this.f.tabletext)},_createRowsTitle:function(e=null){let i=this;i.__sectionsCloses=i.__sectionsCloses||JSON.parse(localStorage.getItem("sectionCloses")||"{}");let n=i.tableRow.id+"/"+(i.tableRow.__version||0)+"/rows",a=t('<div class="pcTable-rowsTitle"></div>').on("click","i, span",(function(){let e=t(this).closest(".pcTable-rowsWrapper");e.is(".pcTable-rowsClose")?(e.removeClass("pcTable-rowsClose"),delete i.__sectionsCloses[n],i.ScrollClasterized.reloadScrollHead()):(e.addClass("pcTable-rowsClose"),i.__sectionsCloses[n]=1),i.ScrollClasterized.insertToDOM(0,!0),localStorage.setItem("sectionCloses",JSON.stringify(i.__sectionsCloses))}));return e&&e.is(".pcTable-rowsClose")&&!i.__sectionsCloses[n]?e.removeClass("pcTable-rowsClose"):e&&!e.is(".pcTable-rowsClose")&&i.__sectionsCloses[n]&&e.addClass("pcTable-rowsClose"),this.f.rowstitle?a.html(t("<span>").text(this.f.rowstitle)).prepend('<i class="fa">'):a.text(),a},_createFiltersBlock:function(){let i=this;t("<div>");if(this._filtersBlock=t("<div>"),this._filtersBlock.addClass("pcTable-filtersTables pcTable-section"),i.fieldCategories.filter.length){let n,a,l;this.___createClosedSection(this._filtersBlock,t('<div class="pcTable-sectionTitle"><span>Фильтры</span></div>').appendTo(this._filtersBlock),"flt"),this._filtersBlock.addClass("pcTable-filtersTables");let o,s=0,r=this._container.width()-140;const d=function(){if(n){const o=function(){let n=t(this);const a=function(){let a;a=n.is(".eraser")?"?":"?"+t.param({f:i._filtersBlock.data("cryptoFilters")||i.filtersString}),i.isMobile&&(a+="#go-buttons"),e.location.href=a};return setTimeout((function(){i.model.doAfterProcesses(()=>{setTimeout(a,100)})}),500),!0};if(i.isMobile)n.after(t('<table class="pcTable-filtersTable" id="go-buttons"><tr><td><button class="btn btn-default btn-xs button-go">GO</button> <button class="btn btn-default btn-xs eraser button-go "><i class="fa fa-eraser"></i></button></td></tr></td></table>').on("click",".button-go",o));else{a.append('<th style="width: 69px;"></th>');let e=t('<td class="buttons-go">').html('<button class="btn btn-default btn-xs button-go">GO</button> <button class="btn btn-default btn-xs eraser button-go"><i class="fa fa-eraser"></i></button>').appendTo(l);n.width(s+69),e.on("click",".button-go",o)}}},c=(e,c)=>{c.hidden||((i.isMobile||0===s||r<s+c.width||c.tableBreakBefore)&&(i.isMobile||d(),n=t("<table class='pcTable-filtersTable'><thead><tr></tr></thead><tbody><tr></tr></tbody></table>").appendTo(this._filtersBlock),s=0,a=n.find("thead tr"),l=n.find("tbody tr")),void 0!==c.panelColor&&(o=c.panelColor),a.append(i._createHeadCell(e,c,o)),t("<td>").attr("data-field",c.name).appendTo(l),s+=c.width)};t.each(i.fieldCategories.filter,c),d()}return this._filtersBlock},_refreshFiltersBlock:function(e){let i=this;(e=e||{}).params?(t.each(i.fieldCategories.filter,(function(t,n){i.data_params[n.name]=e.params[n.name]})),i._filtersBlock.data("cryptoFilters",e.filtersString)):i.filterData||(i.filterData={},t.each(i.fieldCategories.filter,(function(e,n){i.filterData[n.name]=t.extend(!0,{},i.data_params[n.name])})),i.model.addFiltersData({filters:i.filtersString}));let n=[],a=[];return t.each(i.fieldCategories.filter,(function(e,t){if(t.hidden)return;let l=i._createCell(i.data_params,t);i._filtersBlock.find('td[data-field="'+t.name+'"]').replaceWith(l),Object.equals(i.data_params[t.name].v,i.filterData[t.name].v)||n.push(l),"select"!==t.type||!i.data_params[t.name].v||"*NONE*"!==i.data_params[t.name].v&&"*NONE*"!==i.data_params[t.name].v[0]||a.push(l)})),n.length>0?(n.forEach((function(e){e.addClass("warning-backg")})),i._filtersBlock.removeClass("with_danger").addClass("with_changed")):a.length>0?(a.forEach((function(e){e.addClass("danger-backg")})),i._filtersBlock.removeClass("with_changed").addClass("with_danger")):(i._filtersBlock.removeClass("with_danger, with_changed"),i._filtersBlock.find(".danger-backg, .warning-backg").removeClass("danger-backg, warning-backg")),this._filtersBlock},__fillFloatBlock:function(e,n){let a,l,o=this,s="",r={_ALL:!0},d=0,c=!1,p=!1,f=!1,h=!1,u=!1,m=[];const b=(e,t,i,n)=>{e||(e={});const a=e=>{if(n){let t=e.split(/\s*\/\s*/);return t.length>1?{_big:l(t[0]),_small:l(t[1])}:{_big:l(e),_small:l(e)}}return l(e)},l=e=>{switch(e){case"false":case"FALSE":e=!1;break;case"true":case"TRUE":e=!0}return e=i(e)};return 2===t.length?e=a(t[1]):/^([a-z_0-9]+\s*,?\s*)+$/.test(t[1])?t[1].split(/\s*,\s*/).forEach(i=>{e[i]=a(t[2])}):e=a(t[1]),e};t.each(n,(function(e,i){let n=!1;if(void 0!==i.sectionTitle){r={_ALL:!0},s=i.sectionTitle.trim(),d=0,c=!1,p=!1,f=!1,h=!1,l=i;let e={},a=s.match(/\*\*(.*)/);a&&(a[1].trim().split(/\s*;\s*/).forEach(t=>{let i=t.trim().split(/\s*:\s*/);if(i[0]=i[0].toLowerCase(),i.length>1)switch(i[0]){case"outline":p=b(p,i,e=>!0===e?"#e4e4e4":e,!0);break;case"title":e.title=e.title||{_ALL:!0};let t=b({},i,e=>e);"boolean"==typeof t?e.title._ALL=t:e.title={...e.title,...t};break;case"border":f=b(f,i,e=>!1===e?"transparent":e,!0);break;case"plate":c=b(c,i,e=>!1===e?"transparent":e,!0);break;case"platemh":h=b(h,i,e=>"string"==typeof e&&/^\d+$/.test(e)?e+"px":e,!0);break;case"plateh":u=b(u,i,e=>"string"==typeof e&&/^\d+$/.test(e)?e+"px":e,!0);break;case"gap":e.gap=b(e.gap,i,e=>e);break;default:switch(i[1]){case"true":case"TRUE":e[i[0]]=!0;break;case"false":case"FALSE":e[i[0]]=!1}}}),d=e.gap||d),r="title"in e?e.title:r,o.isCreatorView?(s=s.replace(/(\*\*.*)/,""),n=!1===e.lable||""===s):!1===e.lable?s="":(s=s.replace(/(\*\*.*)/,""),s=t("<div>").text(s.trim()).html())}(!a||i.tableBreakBefore&&i.sectionTitle)&&(a=[],m.push({title:s,lableLowOpacity:n,fields:a,withTitles:r,sectionGap:d,plate:c,sectionField:l,outline:p,border:f,plateh:u,platemh:h}),s=""),i.showMeWidth&&a.push({field:i,panelColor:void 0})}));const g=(e,t)=>{let i=-1,n=e.fieldCell;t&&(n.prev().is("br")||n.is(":first-child")||n.prev().is('[data-type="blocknum"]')||("object"!=typeof t?i=t:e.format.blocknum in t?i=t[e.format.blocknum]:e.field.name in t&&(i=t[e.field.name]),i&&/^\d+$/.test(i)&&(i=parseInt(i)-1,i+="px"))),n.css("marginLeft",i)};m.forEach(a=>{let l=t('<div class="pcTable-section ">').appendTo(e),s=a.sectionGap;if(a.title||o.isCreatorView&&a.sectionField){let e=t("<span>").html(a.title);o.isCreatorView&&(t('<span class="danger"> <i class="fa fa-edit" style="font-size: 14px; padding-left: 10px;"></i></span>').on("click",()=>(this.__editSectionTitle(a.sectionField),!1)).appendTo(e),t('<span class="danger"> <i class="fa fa-times" style="font-size: 14px; padding-left: 5px;"></i></span>').on("click",()=>(this.__deleteSection(a.sectionField),!1)).appendTo(e)),o.___createClosedSection(l,t('<div class="pcTable-sectionTitle"></div>').html(e).appendTo(l),"param"===n[0].category?"p":"f"),a.lableLowOpacity&&l.find(".pcTable-sectionTitle").addClass("lowOpacity")}let r=t('<div class="pcTable-floatBlock">').appendTo(l);if(!r.is(":visible"))return void l.data("closedrender",!0);let d,c=0,p=[],f=[p],h=[f];a.fields.forEach((e,i)=>{e.field.tableBreakBefore&&0!==i&&(r=t('<div class="pcTable-floatBlock">').appendTo(l),p=[],f=[p],h.push(f)),o.data_params[e.field.name]=o.data_params[e.field.name]||{},e.format=o.data_params[e.field.name].f||{};let n=e.format.blocknum||0;void 0!==e.format.blocknum&&l.addClass("sectionWithPannels"),(0===p.length||p[p.length-1].num!=n||e.field.tableBreakBefore&&0!==i)&&(d=t('<div class="pcTable-floatInner">').appendTo(r),n&&o.isCreatorView&&d.append('<div data-type="blocknum" style="position:absolute;z-index: 100; color: #ff8585; background-color: #fff; padding: 3px; font-size: 10px; right: 4px; top: 4px;">'+n+"</div>"),a.outline&&(n in a.outline?d.data("border-color",a.outline[n]):d.data("border-color",a.outline)),a.plate&&(n in a.plate?d.data("plate",a.plate[n]):d.data("plate",a.plate)),a.plateh&&(n in a.plateh?d.data("plateh",a.plateh[n]):d.data("plateh",a.plateh)),a.platehm&&(n in a.platehm?d.data("platehm",a.platehm[n]):d.data("platehm",a.platehm)),p.push({div:d,num:n,isWrappable:!1,sec:a,fields:[]}));let s=p[p.length-1];s.fields.length>0&&!e.format.nextline&&(s.isWrappable=!0),s.fields.push(e),e._showMeWidth=e.field.showMeWidth,e.format.breakwidth&&(e.field.showMeWidth=e.format.breakwidth),e.format.nextline&&i>0&&d.append("<br/>");let u=t("<div>").appendTo(d);u.width(e.field.showMeWidth+1),u.attr("data-field-type",e.field.type),e.field.isNoTitles=!1,"withTitles"in a&&(e.field.name in a.withTitles?e.field.isNoTitles=!a.withTitles[e.field.name]:n&&n in a.withTitles?e.field.isNoTitles=!a.withTitles[n]:"_ALL"in a.withTitles&&(e.field.isNoTitles=!a.withTitles._ALL));let m=o._createHeadCell(null,e.field,e.panelColor).appendTo(u),b=t('<div class="td-wrapper">').appendTo(u),g=o._createCell(o.data_params,e.field).appendTo(b);if(e.format.maxheight){let t={maxHeight:e.format.maxheight};e.format.height&&(t.minHeight=e.format.height,b.css("minHeight",e.format.height)),g.height(""),u.css(t),u.addClass("nonowrap")}else e.format.height&&(g.height(""),u.addClass("nonowrap"),u.height(e.format.height));e.field.isNoTitles?o.isCreatorView?m.addClass("no-titled"):m.empty():(m.css("display","table-cell"),e.th=m,m.height()>c&&(c=m.height())),e.td=g,e.th=m.width(""),e.tdWrapper=b,e.fieldCell=u,o.isCreatorView&&(e.format.glue&&u.addClass("f-glue"),e.format.fill&&u.addClass("f-fill"))}),a.fields.forEach(e=>{let t=0;if(e.th){e.th.css("display","");let i=21;o.isCreatorView&&(i=40),e.th.height(i),t=e.th.outerHeight()}e.format.maxheight?e.tdWrapper.css("maxHeight",e.format.maxheight-t-10):e.format.height&&!e.format.maxheight&&(e.tdWrapper.css("height",e.format.height-t),e.tdWrapper.data("height",e.format.height-t)),g(e,s)});const u=function(e){if(!e.length)return 0;let t,i,n=e[0].div.parent(),a=n.position().left+parseInt(n.css("paddingLeft"))+n.width();for(let n in e){let n=e[e.length-1].div;n.w=!1;let a=n.position().left+n.outerWidth();(!t||a>t)&&(t=a,i=e[e.length-1])}return i.w=!0,a-t},m=function(e){let t=!0;return e.some((e,i)=>{if(u(e)<0)return t=!1,!0}),t};let b=!1;h.forEach((function(e,n){let a=0;for(;++a<400&&!m(e);)e.forEach((function(t,i){if(u(t)<0){b=!0;for(let e=t.length-1;e>=0;e--){let i=t[e];if(i.isWrappable&&i.w){let e,t,n;for(let a=i.fields.length-1;a>=1;a--){let l=i.fields[a];l.i=a,(!n||l.fieldCell.position().left>n)&&(n=l.fieldCell.position().left,e=l,t=a)}if(e&&!e.format.nextline&&!e.fieldCell.prev().is("br")){if(e.format.glue)for(;;){if(!e.i){e=null;break}if(e=i.fields[e.i-1],t=e.i,e.format.nextline||e.fieldCell.is(":first-child")||e.fieldCell.prev().is("br")){e=null;break}if(!e.format.glue)break}if(e){e.fieldCell.before('<br class="wrapped"/>'),e.fieldCell.nextAll("br.wrapped").remove();for(let e=t;e<=i.fields.length-1;e++)g(i.fields[e],s);return}}}}let i=e[0].length-1;if(i>0){let t=e[0][i];t.div.before("<br/>"),e.push([t]),e[0].splice(i,1),e.forEach((function(e){e.forEach((function(e){e.div.find("br.wrapped").remove(),e.fields.forEach(e=>g(e,s))}))}))}}}));e.forEach((function(e,n){e.forEach(({div:e,fields:t})=>{t.forEach(e=>{e.format.breakwidth&&(e.fieldCell.css("width",e._showMeWidth),e.field.showMeWidth=e._showMeWidth)})}),function(e,i){if(!e.length)return;/Safari/.test(navigator.userAgent)&&e.forEach((function(e){e.div.width(100),e.div.width("")}));let n=u(e),a=0+parseInt(e[0].div.css("paddingTop")),l=[],o=[],s=0;e.forEach((function(e){let t,n=null,r={width:0,fields:[]};e.fields.forEach((function(e){(e.format.maxwidth&&e.field.width<e.format.maxwidth||e.format.fill&&(i||e.fieldCell.position().top!==a||null===a))&&(n!=e.fieldCell.position().top&&(n=e.fieldCell.position().top,r={width:0,fields:[]},n!==a?o.push(r):l.push(r)),r.fields.push(e),r.width+=e.field.width,n===a&&(s+=e.field.width)),t=e.fieldCell}))}));const r=function(e){let i,n,a=e.fields[0].fieldCell.parent(),l=e.fields[0].fieldCell.position().top;a.find(">div").each((function(e,a){let o=t(a),s=o.position();s.top===l&&(!i||s.left>i)&&(i=s.left,n=o)}));let o=a.width()+parseInt(a.css("paddingLeft"))-i-n.outerWidth(!0),s=0,r=0;for(;r++<100&&e.fields.length&&o>1;)e.fields.forEach((function(t,i){if(o>s){let n=Math.round(o/e.width*t.field.width);t.format.fill||t.format.maxwidth<=t.fieldCell.width()+n&&(n=t.format.maxwidth-t.fieldCell.width(),e.fields.splice(i,1),e.width-=t.field.width),s+=n,t.fieldCell.width(t.fieldCell.width()+n)}})),o-=s,s=0};l.forEach(r);let d=n,c=0,p=0;for(;d>1&&p++<6&&l.length;)l.forEach((function(e,t){e.fields.forEach((function(t,n){if(d>c){let a=Math.round(d/s*t.field.width);a>d-c&&(a=d-c),i&&t.format.fill||!(t.format.maxwidth<=t.fieldCell.width()+a)||(a=t.format.maxwidth-t.fieldCell.width(),e.fields.splice(n,1),s-=t.field.width),c+=a,t.fieldCell.width(t.fieldCell.width()+a)}})),0===e.fields.length&&l.splice(t,1)})),d-=c,c=0;o.forEach(r)}(e,b),e.forEach(({div:e,fields:t,sec:n,blocknum:a})=>{let l=[],s=!0;t.forEach(e=>{if(e.fieldCell.prev().is("br")&&(!o.isCreatorView&&l.length&&i(l),l=[],s=!0),e.field.isNoTitles?s&&l.push(e):(l=[],s=!1),n.border){let t;if(t=e.field.name in n.border?n.border[e.field.name]:a in n.border?n.border[a]:n.border,t){let i=i=>{let n=b?t._small:t._big,a={borderColor:n};return"transparent"===n?(i.background||e.panelColor||(a.backgroundColor="transparent"),"button"===e.field.type&&(e.fieldCell.addClass("no-border"),a.Button={},i.background&&(a.Button.backgroundColor=i.background),i.color&&(a.Button.color=i.color),e.td.find("button").css(a.Button),a.backgroundColor="transparent")):!0===n&&(a.borderColor="",a.backgroundColor="","button"===e.field.type&&(e.fieldCell.removeClass("no-border"),a.Button={},a.Button.backgroundColor="",a.Button.color=i.color,e.td.find("button").css(a.Button))),a};e.td.css(i(e.format)),e.field.td_style=i}else e.td.css(func_format(e.format)),e.field.td_style=func_format}}),!o.isCreatorView&&l.length&&i(l);let r={};if(e.data("plateh")){let t=e.data("plateh"),i=b?t._small:t._big;!1!==i&&(r.height=i,r.overflow="auto")}if(e.data("platemh")){let t=e.data("platemh"),i=b?t._small:t._big;!1!==i&&(r.maxHeight=i,r.overflow="auto")}e.data("border-color")&&(r.borderColor=b?e.data("border-color")._small:e.data("border-color")._big),e.data("plate")&&(r.backgroundColor=b?e.data("plate")._small:e.data("plate")._big),e.css(r)})}))}))})},_createParamsBlock:function(e){let i=t("<div>");if(e)return i.appendTo(e),i;this._paramsBlock&&(this._paramsBlock.replaceWith(i),this._paramsBlock=i);let n=this;if(n.fieldCategories.param)if(i.addClass("pcTable-paramsTables"),n.isMobile){let e,a,l,o,s="",r=!1;t.each(n.fieldCategories.param,(function(d,c){let p;void 0!==c.panelColor&&(p=c.panelColor),void 0!==c.sectionTitle&&(r=!1,s=c.sectionTitle,s.match(/\*\*(.*)/)&&(s.match(/\*\*(.*)/)[1].trim().split(/\s*;\s*/).forEach(e=>{let t=e.trim().split(/\s*:\s*/);"nolable"===t[0]&&(t[1]&&"true"!==t[1].trim()||(s=""))}),s=s.replace(/(\*\*.*)/,""))),!c.showMeWidth||n.data_params[c.name].f&&n.data_params[c.name].f.hide&&n.data_params[c.name].f.hide.mobile||(e=t("<table class='pcTable-paramsTable'>"+(r?"":"<thead><tr></tr></thead>")+"<tbody><tr style='background-color: "+p+"'></tr></tbody></table>"),n.isMobile&&"button"===c.type&&(e=t("<table class='pcTable-paramsTable'><tbody><tr></tr></tbody></table>")),o&&!s||(o=t('<div class="pcTable-section">').appendTo(i),s&&n.___createClosedSection(o,t('<div class="pcTable-sectionTitle"></div>').html(t("<span>").text(s)).appendTo(o),"p")),s="",o.append(e),r||(a=e.find("thead tr"),a.append(n._createHeadCell(d,c,p))),l=e.find("tbody tr"),l.append('<td data-field="'+c.name+'">'))}))}else this.__fillFloatBlock(i,n.fieldCategories.param);return i},_refreshParamsBlock:function(e,i){var n=this;return n.fieldCategories.param&&t.each(n.fieldCategories.param,(function(t,a){if(!a.showMeWidth||e&&!0!==e[a.name])return!0;let o=n._createCell(n.data_params,a),s=n._paramsBlock.find('td[data-field="'+a.name+'"]');s.css("minHeight")&&o.css("minHeight",s.css("minHeight")),s.replaceWith(o),i&&n._colorizeElement(o,l)})),this._paramsBlock},_createFootersSubtable:function(e){let i,n=this;if(i=t("<div class='pcTable-footersTables'>"),e)return i.appendTo(e),i;if(this._footersSubTable.replaceWith(i),this._footersSubTable=i,n.isMobile){let e,a,l,o,s,r=0,d=this._container.width()-100,c="";t.each(n.notTableFooterFields,(function(p,f){let h;void 0!==f.panelColor&&(h=f.panelColor),void 0!==f.sectionTitle&&(s=!1,c=f.sectionTitle,c.match(/\*\*(.*)/)&&(c.match(/\*\*(.*)/)[1].trim().split(/\s*;\s*/).forEach(e=>{let t=e.trim().split(/\s*:\s*/);"nolable"===t[0]&&(t[1]&&"true"!==t[1].trim()||(c=""))}),c=c.replace(/(\*\*.*)/,""))),!f.showMeWidth||n.data_params[f.name].f&&n.data_params[f.name].f.hide&&n.data_params[f.name].f.hide.mobile||((n.isMobile||0===r||d<r+f.showMeWidth||f.tableBreakBefore)&&(e&&!n.isMobile&&e.width(r),e=t("<table class='pcTable-footersTable'><thead><tr></tr></thead><tbody><tr style='background-color: "+h+"'></tr></tbody></table>"),("button"===f.type||s)&&(e=t("<table class='pcTable-paramsTable'><tbody><tr></tr></tbody></table>")),o&&!c||(o=t('<div class="pcTable-section">').appendTo(i),c&&n.___createClosedSection(o,t('<div class="pcTable-sectionTitle"></div>').html(t("<span>").text(c)).appendTo(o),"f")),c="",o.append(e),r=0,a=e.find("thead tr"),l=e.find("tbody tr")),a.append(n._createHeadCell(p,f,h)),l.append('<td data-field="'+f.name+'">'),r+=f.showMeWidth)}))}else this.__fillFloatBlock(i,n.notTableFooterFields);return i},_createFootersTableBlock:function(){let e,i=this;if(e=t("<tbody class='pcTable-footers'></tbody>"),i.fieldCategories.footer){let n={},a=0;t.each(i.fieldCategories.footer,(function(e,t){!t.showMeWidth||i.data_params[t.name].f&&i.data_params[t.name].f.hide&&i.data_params[t.name].f.hide.mobile||(t.column||(t.column=""),n[t.column]||(n[t.column]=[]),n[t.column].push(t),t.column&&a<n[t.column].length&&(a=n[t.column].length))}));let l=t(),o=0,s=0;for(;o<a;){let e=t('<tr><td class="id"></td></tr>'),a=t('<tr><td class="id"></td></tr>').data("pctableitemid","footers").data("pctablettemtndex","footers"+s++);t.each(i.fieldCategories.column,(function(l,s){if(s.showMeWidth){let r=t("<td>");if(!n[s.name]||!n[s.name][o])return r.attr("rowspan",2),e.append(r),void r.addClass("footer-empty");if(r=i._createHeadCell(l,n[s.name][o],n[s.name][o].panelColor).addClass("footer-name"),e.append(r),n[s.name]&&n[s.name][o]){let e=n[s.name][o],t=i._createCell(i.data_params,e);t.attr("data-field",e.name),a.append(t)}}})),l=l.add(e),l=l.add(a),o++}e.html(l)}return e},___createClosedSection(e,i,n){const a=this;let l=e.parent().find(">div").index(e)+2,o=a.tableRow.id+"/"+(a.tableRow.__version||0)+"/"+n+"/"+l;a.__sectionsCloses=a.__sectionsCloses||JSON.parse(localStorage.getItem("sectionCloses")||"{}"),a.__sectionsCloses[o]&&e.addClass("closed"),t('<span class="btn-i"><i class="fa"></i></span>').prependTo(i),i.on("click","i, span",(function(){let e=t(this).closest(".pcTable-section");if(e.is(".closed"))if(e.removeClass("closed"),delete a.__sectionsCloses[o],e.data("closedrender")){let e=a.scrollWrapper.parent().scrollTop();switch(n){case"p":a._rerendParamsblock();break;case"f":a._rerendBottomFoolers()}a.scrollWrapper.parent().scrollTop(e)}else e.find("td").each((function(){let e=t(this);e.data("addProgress")&&e.data("addProgress")()}));else e.addClass("closed"),a.__sectionsCloses[o]=1;return localStorage.setItem("sectionCloses",JSON.stringify(a.__sectionsCloses)),a.ScrollClasterized.insertToDOM(null,!0),!1}))},_refreshFootersBlock:function(e,i){let n=this,a=n._footersBlock.add(n._footersSubTable);return n.fieldCategories.footer&&t.each(n.fieldCategories.footer,(function(t,o){if(!o.showMeWidth||e&&!0!==e[o.name])return!0;let s=n._createCell(n.data_params,o);s.attr("data-field",o.name),a.find('td[data-field="'+o.name+'"]').replaceWith(s),i&&n._colorizeElement(s,l)})),this._paramsBlock},_createHead:function(){return this._header=t("<thead>").append(this._createHeadRow()),this._header},_refreshHead:function(){return this._header.empty().append(this._createHeadRow()),this._header},_createFirstBody:function(){return this._beforebody=t("<tbody class='beforeRows'>").append('<tr class="extra-clasters">'),this.extraClastersTop=this._beforebody.find(".extra-clasters"),this._beforebody},_createAfterBody:function(){return this._afterbody=t("<tbody class='afterRows'>").append('<tr class="extra-clasters">'),this.extraClastersBottom=this._afterbody.find(".extra-clasters"),this._afterbody},_createBody:function(){return this._content=t("<tbody class='dataRows'>"),this._content},_createHeadRow:function(){let e=this,i=t("<tr>");this.fieldCategories.visibleColumns.length?e._container.removeClass("withNoColumns"):e._container.addClass("withNoColumns"),e._createHeadCellId().appendTo(i);let n=i.find(".id").width();return e._table.removeClass("n-filtered"),t.each(this.fieldCategories.visibleColumns,(function(t,a){let l,o;void 0!==a.panelColor&&(l=a.panelColor),"n"===a.name?(e._table.addClass("n-filtered"),o=e._createHeadCellNo()):o=e._createHeadCell(t,a,l),o.appendTo(i),n+=parseInt(a.showMeWidth)})),this.tableWidth=n,this._table.width(this.tableWidth),i},_createHeadCellId:function(){let e=this,i=t('<th class="id"><span>id</span></th>');if(null===e.tableRow.order_field||"id"===e.tableRow.order_field){let t=i.find("span").css("font-weight","bold");e.isCreatorView&&(!0===e.tableRow.order_desc?t.append(' <i class="fa fa-sort-amount-desc roles"></i>'):t.append(' <i class="fa fa-sort-amount-asc roles"></i>'))}let n=t('<div class="pcTable-filters"></div>'),a=t('<button class="btn btn-default btn-xxs" id="n-expander"><i class="fa fa-sort"></i></button>');if(this.isTreeView?a.prop("disabled",!0):a.on("click",(function(){e.fieldCategories.visibleColumns.some((function(e){return"n"===e.name}))?(e.fieldsHiddingHide.call(e,"n"),a.removeClass("btn-warning")):(e.fieldsHiddingHide.call(e,"n",!0),a.addClass("btn-warning")),e.ScrollClasterized.reloadScrollHead()})),e.fieldCategories.visibleColumns.some((function(e){return"n"===e.name}))&&a.addClass("btn-warning"),e.isMobile);else{let t=this._getIdFilterButton();n.append(a).append(" ").append(t).append(" ").append(e._idCheckButton)}return i.append(this._checkStatusBar),i.append(n),e._idCheckButton.off().on("click",(function(){if(e._idCheckButton.find("span").is(".fa-check"))e.row_actions_uncheck_all.call(e),e.__checkedRows=[];else for(let t=0;t<e.dataSortedVisible.length;t++){let i=e.dataSortedVisible[t],n="object"!=typeof i?e._getItemById(i):i.row;n&&!n.$checked&&(e.row_actions_check.call(e,n,!0),e.__checkedRows.push(n.id))}e._headCellIdButtonsState()})),n=t('<div class="pcTable-filters for-selected"><button class="btn btn-default btn-xxs"><i class="fa fa-copy"></i></button> <button class="btn btn-default btn-xxs" data-names="true"><i class="fa fa-clone"></i></button></div>'),i.append(n),this._refreshCheckedStatus(),i},_getIdFilterButton:function(){let e,i=this,n=t("<span>");return e=t('<button class="btn btn-xxs btn-filter" id="checkS"><span class="fa fa-circle-o"></span></button>').on("click",(function(){e.is(".btn-warning")?(e.addClass("btn-default").removeClass("btn-warning").find("span").removeClass("fa-circle").addClass("fa-circle-o"),delete i.filters.id,n.find(".btn-filter:not(#checkS)").parent().replaceWith(i.__getFilterButton("id"))):(e.removeClass("btn-default").addClass("btn-warning").find("span").removeClass("fa-circle-o").addClass("fa-circle"),i.filters.id=i.__checkedRows.slice().map((function(e){return e.toString()}))),i.__applyFilters(),i._headCellIdButtonsState()})),i.filters.id&&i.filters.id.length?e.addClass("btn-warning").removeClass("btn-default"):e.addClass("btn-default").removeClass("btn-warning"),n.append(e),n.append(i.__getFilterButton("id")),n},_createHeadCellNo:function(){let e=this,i=e.fields.n,n=t('<span class="cell-title">').text(i.title?i.title:i.name).attr("title",i.title),a=t('<button class="btn btn-default btn-xxs" style="width: 45px"><i class="fa fa-save"></i></button>'),l=t('<th class="n">').width(i.userWidth||i.width).append(n);return e.isCreatorView&&("n"===e.tableRow.order_field&&(!0===e.tableRow.order_desc?n.before('<i class="fa fa-sort-amount-desc roles"></i>'):n.before('<i class="fa fa-sort-amount-asc roles"></i>')),n.before("<br/>")),e._orderSaveBtn=a,!e.tableRow.with_order_field||e.f.blockorder||e.tableRow.__blocked?(a.prop("disabled",!0),this._table.addClass("no-correct-n-filtered")):a.on("click",(function(){e.reOrderRowsSave.call(e)})),l.append(t('<div class="pcTable-filters">').append(a))},__getCellTitle:function(e){return Object.getPath(this.f,["fieldtitle",e.name],e.title)},_createHeadCell:function(i,a,l){let o=this,s=a.showMeWidth||a.width||100;"column"!==a.category&&s&&o.isMobile&&(s=100);let r=t("<th>").data("field",a.name);o.isMobile&&("column"===a.category&&a.editable&&(s+=20),s+=20),s&&r.width(s),o.fields[a.name]&&(o.fields[a.name].$th=r),void 0!==l&&""!==l&&(r.css("background-color",l),a.panelColor=l),a.webRoles&&1===a.webRoles.length&&"1"===a.webRoles[0].toString()&&r.addClass("admin-see"),"footer"===a.type&&a.column&&(r=t("<td>"));let d=this.__getCellTitle(a),c=t('<span class="cell-title">').text(d).attr("title",d).appendTo(r);if(o.isCreatorView){let e=t('<span class="creator-icons">').prependTo(c);const i=function(e){let t="";switch(e){case"param":t="fa-hand-o-up";break;case"column":t="fa-hand-o-right";break;case"filter":t="fa-hand-o-left";break;case"footer":t="fa-hand-o-down"}return t};!a.isHiddenField&&a.showMeWidth||e.append('<i class="fa '+i(a.category)+' roles"></i>'),!a.showInWeb||a.isHiddenField||a.showMeWidth||r.addClass("eye-hidden"),a.linkTableName&&e.append('<i class="fa fa-chain roles"></i>'),e.append('<i class="fa '+a.icon+' roles"></i>');let n=t('<i class="roles">'+(a._ord||a.ord)+"</i>");if(e.append(n),a._ord&&(n.addClass("reordered"),n.before('<i class="roles">'+a.ord+"</i>")),a._category&&n.before('<i class="fa '+i(a._category)+' roles reordered fa-bold"></i>'),"column"===a.category&&o.tableRow.order_field===a.name&&(n.css("font-weight","bold"),!0===o.tableRow.order_desc?e.append('<i class="fa fa-sort-amount-desc roles"></i>'):e.append('<i class="fa fa-sort-amount-asc roles"></i>')),a.codeAction){let i=t('<i class="fa fa-star roles"></i>');e.append(i);let n="";a.CodeActionOnAdd&&(""!==n&&(n+="\n"),n+="При добавлении"),a.CodeActionOnChange&&(""!==n&&(n+="\n"),n+="При изменении"),a.CodeActionOnDelete&&(""!==n&&(n+="\n"),n+="При удалении"),"button"===a.type&&(""!==n&&(n+="\n"),n+="При клике"),""===n&&i.removeClass("fa-star").addClass("fa-star-o"),i.attr("title",n)}a.code&&!a.linkFieldName&&(a.codeOnlyInAdd?e.append('<i class="fa fa-cog-o roles"></i>'):e.append('<i class="fa fa-cogs roles"></i>'));const l=function(e){let t="";return e.forEach((function(e){""!==t&&(t+="\n"),t+=o.ROLESLIST[e.toString()]})),t};if(a.webRoles&&e.append(t('<i class="fa fa-eye roles"></i>').attr("title",l(a.webRoles))),"button"!==a.type){let i=!1;a.addRoles?e.append(t('<i class="fa fa-plus roles h"></i>').attr("title",l(a.addRoles))):a.insertable||("column"===a.category?a.editable?e.append(t('<i class="fa fa-plus roles h"></i>').attr("title","Добавление запрещено")):(e.append(t('<i class="fa fa-lock roles h"></i>').attr("title","Добавление и редактирование запрещено")),i=!0):a.editable||(e.append(t('<i class="fa fa-lock roles h"></i>').attr("title","Редактирование запрещено")),i=!0)),a.editRoles?e.append(t('<i class="fa fa-pencil roles h"></i>').attr("title",l(a.editRoles))):a.editable||i||e.append(t('<i class="fa fa-pencil roles h"></i>').attr("title","Редактирование запрещено")),a.logRoles&&e.append(t('<i class="fa fa-archive roles h"></i>').attr("title",l(a.logRoles)))}if(a.showInXml){let i="";a.xmlRoles&&(i=l(a.xmlRoles)),e.append(t('<i class="fa fa-exchange roles"></i>').attr("title",i))}}a.unitType&&c.append(", "+a.unitType);let p,f=t('<div class="pcTable-filters">');if(a.help&&a.help.length){o.isCreatorView||"column"===a.category||r.addClass("worker-with-i"),p=t('<span class="btn btn-xxs btn-default cell-help" tabindex="-1" id="field-help-'+a.name+'"><i class="fa fa-info"></i></span>'),o.isCreatorView&&/^\s*<admin>.*?<\/admin>\s*$/s.test(a.help)&&p.addClass("danger-backg"),p.appendTo(f);let e,i=t('<div class="i-inner-div">').html(a.help).width(230);o.isMobile?p.on("click",(function(){App.mobilePanel("Поле "+a.title,a.help)})):p.on("click open close",(function(n){let l=t(this);l.data("bs.popover")?"open"!==n.type&&(e&&clearTimeout(e),e=setTimeout(()=>{l.attr("aria-describedby")&&t("#"+l.attr("aria-describedby").length)&&l.popover("destroy")},120)):"close"!==n.type&&(p.popover({trigger:"manual",content:i,html:!0,placement:()=>{let e="bottom",t=300,n=o._container,s=l.offset().top-n.offset().top;return"column"===a.category&&o.insertRow||s>n.height()/2?(e="top",t=s-40):t=n.height()-s-70,i.css("max-height",t),e},container:o.scrollWrapper}),l.popover("show"))})),o.addThHelpCloser()}if("column"===a.category&&!o.isTreeView&&a.filterable&&a.showMeWidth>0&&(r.addClass("with-filter2"),this.__getFilterButton(a.name).appendTo(f)),o.isCreatorView||!1!==a.dropdownView&&"column"===a.category){r.addClass("with-filter");let i=o.isCreatorView&&!(!1!==a.dropdownView&&"column"===a.category);(()=>{let l=t('<div class="cell-header-dropdown">'),s=t('<button class="btn btn-default btn-xxs"  tabindex="-1"><i class="fa fa-caret-down"></i></button>');a.pcTable?i&&s.addClass("field_name"):s.addClass("field_name");const r=function(t){t&&e.location.reload()};if(o.isCreatorView){let i=t('<div class="menu-item color-danger">');i.append('<i class="fa fa-pencil-square-o"></i> Изменить'),l.append(i);const d=function(){return new EditPanel(2,BootstrapDialog.TYPE_DANGER,{id:a.id}).then(r),!1};i.on("click",d),s.on("contextmenu",d),i=t('<div class="menu-item color-danger">'),i.append('<i class="fa fa-clone"></i> Дублировать'),l.append(i),i.on("click",(function(){App.getPcTableById(2).then((function(e){e.model.checkEditRow({id:a.id}).then((function(e){let i={},n={};t.each(e.row,(function(e,t){"object"==typeof t&&(i[e]=t,n[e]=!0)})),new EditPanel(2,BootstrapDialog.TYPE_DANGER,i,!1,n).then(r)}))}))})),i=t('<div class="menu-item color-danger">'),i.append('<i class="fa fa-plus"></i> Вставить после'),l.append(i),i.on("click",(function(){App.getPcTableById(2,{afterField:a.ord}).then((function(e){let t={};t.ord={v:a.ord+10},t.category={v:a.category},t.table_id={v:o.tableRow.id},o.tableRow.__version&&(t.version={v:o.tableRow.__version}),t.data_src={v:n},new EditPanel(e,BootstrapDialog.TYPE_DANGER,t,!1,t).then(r)}))})),("param"===a.category||"footer"===a.category&&""==a.column)&&(i=t('<div class="menu-item color-danger">'),i.append('<i class="fa fa-hand-scissors-o"></i> Секция'),l.append(i),i.on("click",()=>{this.__editSectionTitle(a)})),i=t('<div class="menu-item color-danger">'),i.append('<i class="fa fa-refresh"></i> Изменить NAME'),l.append(i),i.on("click",(function(){o.model.renameField(a.name)})),i=t('<div class="menu-item color-danger">'),i.append('<i class="fa fa-times"></i> Удалить'),l.append(i),i.on("click",(function(){let t=a.title;BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:"Удалить поле "+t+" из таблицы "+o.tableRow.title+"?",buttons:[{action:function(i,n){"use strict";i.close(),App.getPcTableById(2).then((function(i){App.panelTimer("Удаление поля "+t+" из таблицы "+o.tableRow.title,i.tableRow.delete_timer,(function(){i.model.delete(a.id).then((function(){e.location.reload(!0)}))}))}))},cssClass:"btn-warning",label:"Удалить"},{action:function(e){e.close()},label:"Отмена"}],draggable:!0})}))}if("filter"!==a.category&&a.pcTable&&!o.isMobile){let e=t('<div class="menu-item">');a.showMeWidth?(e.append('<i class="fa fa-eye-slash"></i> Скрыть'),e.on("click",(function(){s.popover("hide"),o.fieldsHiddingHide.call(o,a.name)}))):(e.append('<i class="fa fa-eye-slash"></i> Показать'),e.on("click",(function(){s.popover("hide"),o.setColumnWidth.call(o,a.name,a.width,a.id)}))),e.appendTo(l),e=t('<div class="menu-item">'),e.append('<i class="fa fa-arrows-h"></i> Ширина поля'),e.on("click",(function(){s.popover("hide");let e=t('<div><input type="number" class="form-control" value="'+a.showMeWidth+'" style="padding-left: 2px;"/></div>'),i=[{label:"Применить",action:function(t){let i=parseInt(e.find("input").val());t.close(),a.pcTable.setColumnWidth.call(a.pcTable,a.name,i)}},{label:"Отмена",action:function(e){e.close()}}];o.isCreatorView&&i.splice(0,0,{label:"По умолчанию",cssClass:"btn-m btn-danger",action:function(t){let i=parseInt(e.find("input").val());t.close(),a.pcTable.setColumnWidth.call(a.pcTable,a.name,i,a.id)}}),BootstrapDialog.show({message:e,title:"Ширина поля "+a.title,onshown:function(t){let i=e.find("input");i.focus(),i.on("keydown",(function(i){13===i.keyCode&&(a.pcTable.setColumnWidth.call(a.pcTable,a.name,parseInt(e.find("input").val())),t.close())})),t.$modalDialog.width(500)},buttons:i,draggable:!0})})),e.appendTo(l)}if(a.showMeWidth>0&&"column"===a.category&&!o.isTreeView){{let e=t('<div class="menu-item">');e.append('<i class="fa fa-sort-alpha-asc"></i> Сортировать А-Я'),l.append(e),e.on("click",(function(){o.sort(a,1)}))}{let e=t('<div class="menu-item">');e.append('<i class="fa fa-sort-alpha-desc"></i> Сортировать Я-А'),l.append(e),e.on("click",(function(){o.sort(a,-1)}))}if("column"===a.category&&"number"===a.type){let e=t('<div class="menu-item">');e.append('<i class="fa fa-diamond"></i> Математические операции'),l.append(e),e.on("click",(function(){let e=t("<div>"),i=0,n=0,l=null,s=null,r=0;o.dataSortedVisible.some((function(e){try{let t=Big(o.data[e][a.name].v);i=Big(i).plus(t),++n,(null===l||t.gt(l))&&(l=t),(null===s||t.lt(s))&&(s=t)}catch(e){++r}}));let d=t('<table class="totum-math-operations"><thead><tr><th>Операция</th><th>Значение</th></tr></thead>').appendTo(e),c=t("<tbody>").appendTo(d),p=function(e,t){let i="";if(t=t||!1,a.unitType&&!t&&(i=" "+a.unitType),a.currency){let t={};return a.dectimalPlaces&&(t.minimumFractionDigits=a.dectimalPlaces),parseFloat(e).toLocaleString("ru-RU",t)+i}return e+i};t("<tr><td>Сумма</td><td>"+p(i)+"</td></tr>").appendTo(c),t("<tr><td>Кол-во чисел</td><td>"+p(n,!0)+"</td></tr>").appendTo(c),t("<tr><td>Среднее</td><td>"+p(Big(i).div(n).round(a.dectimalPlaces||0))+"</td></tr>").appendTo(c),t("<tr><td>Максимальное</td><td>"+p(l)+"</td></tr>").appendTo(c),t("<tr><td>Минимальное</td><td>"+p(s)+"</td></tr>").appendTo(c),t("<tr><td>Нечисл. элементов</td><td>"+p(r,!0)+"</td></tr>").appendTo(c);let f=a.title+(a.unitType?", "+a.unitType:"");o.isMobile?App.mobilePanel(f,e):BootstrapDialog.show({title:f,type:"edit",message:e,draggable:!0,onshown:function(e){e.$modalDialog.width(400)},buttons:[{action:function(e){e.close()},label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon"}]})}))}}if(a.linkToSelectTable){let i=a.linkToSelectTable,n=t('<div class="menu-item color-primary">');n.append('<i class="fa fa-external-link"></i> '+i.title),l.append(n),n.on("click",(function(){return e.open(i.link,"_blank").focus(),!1}))}return s.popover({html:!0,content:l,trigger:"manual",container:o._container,placement:"auto bottom"}),s.on("click",(function(){let e=t(this);"column"===a.category&&o.PageData&&o.PageData.onPage&&o.PageData.allCount>o.PageData.onPage?0===l.find(".column-dropdown").length&&l.append('<div class="column-dropdown">По текущей странице </div>'):l.find(".column-dropdown").remove(),e.data("bs.popover").tip().hasClass("in")||(e.popover("show"),setTimeout((function(){o._container.one("click",(function(){e.popover("hide")}))}),20))})),s})().appendTo(f)}f.appendTo(r);let h=20*f.find(".btn").length+5;if(this.isCreatorView&&(!a.showMeWidth||a.showMeWidth>50)){let e=t('<div class="th-left-bottom-buttons">').appendTo(r);"footer"===a.category&&a.column&&this.fields[a.column]&&!o.hidden_fields[a.name]&&(s=this.fields[a.column].width);t('<div class="btn  btn-xxs field_name copy_me"  tabindex="-1" data-copied-text="Скопировано">').text(a.name).appendTo(e).css("max-width",s-h)}return o.isMobile&&c.css("max-width",s-h-5),r},_createNoDataRow:function(e){let i=0;t.each(this.fields,(function(e,t){i++}));let n=this,a=t();return!e&&this.PageData&&this.PageData.loading?e="Подождите, таблица загружается":this.control.adding&&!this.f.blockadd&&(a=t('<button class="btn btn-warning btn-xxs">Добавить строку</button>').width(120).on("click",(function(){n._addInsertRow()}))),e=e||"Таблица пуста ",t("<tr>").addClass(this.noDataRowClass).append('<td class="id">').append(t("<td>").attr("colspan",i).append(e).append(a))},_createRow:function(e,i){i=i||[];let n=this;e.$tr||(e.$tr=t("<tr>"),e.$tr.height(35),e.$tr.data("item",e));let a=e.$tr.empty();a.attr("class","DataRow"),a.attr("data-pctableitemid",e.id),e.e_data&&1==e.e_data.b&&a.addClass("BlockedRow"),e.InsDel&&a.addClass("insDeleted"),this._addCellId(e,a);let o=0,s=this.fieldCategories.visibleColumns.length;if(this.fieldCategories.visibleColumns[o]&&"n"===this.fieldCategories.visibleColumns[o].name){let i=this.fieldCategories.visibleColumns[o],n=t("<td>");a.append(n.append('<span class="cell-value">').append(i.getCellText(null,n,e))),++o}for(;o<s;++o){let t,s=this.fieldCategories.visibleColumns[o];a.append(t=n._createCell(e,s)),i.indexOf(s.name)>-1&&n._colorizeElement(t,l)}return e.$tr},addThHelpCloser:function(){if(!this.pcTableContainerFieldHelpEvent){let e=this;this.pcTableContainerFieldHelpEvent=!0,this._container.on("click escPressed",(function(i){e._container.find('[id^="field-help"][aria-describedby^="popover"]').each((function(){t(this).attr("id")===i.target.id||t(i.target).closest("#"+t(this).attr("id")).length||t(this).trigger("close")}))}))}},refreshRow:function(e,i,n){if(e&&e.is(".DataRow")||i){i||(i=this._getItemByTr(e));let l=[];if(n){let e,o=!1;for(var a in this.isTreeView&&(e={id:i.id,tree:{v:i.tree.v},tree_category:{v:i.tree_category?i.tree_category.v:null}}),n)null!==n[a]&&"object"==typeof n[a]?n[a].changed?(l.push(a),delete n[a].changed,o=!0):!Object.equals(n[a],i[a])&&a in this.fields&&"listRow"!==this.fields[a].type&&(l.push(a),o=!0):n[a]!=i[a]&&(l.push(a),o=!0),i[a]=n[a];o&&(t.extend(i,n),this.isTreeView&&this.placeInTree(i,e,!0))}e&&this._createRow(i,l)}else this._isParamsArea(e)?this._refreshParamsBlock():this._isFootersArea(e)&&this._refreshFootersBlock()},_createCell:function(e,i){let n=this;var a=t("<td>");let l,o="";e[i.name]||(console.log("Не найдено поле "+i.name),console.log(e));try{l=t.extend({},n.f||{},e.f||{},e[i.name].f||{})}catch(t){console.log(t,e,i.name),l={}}let s=l.height>33||l.maxheight>33;!i.editable||!this.control.editing&&"filter"!==i.category||l.block||(a.addClass("edt"),i.editGroup&&(i.editGroupMultiColumns?a.addClass("e-gm").addClass("e-g"):a.addClass("e-g")),-1===["button","fieldParams"].indexOf(i.type)&&(n.isMobile||l.editbutton)&&(o='<button class="fa fa-edit pull-right ttm-edit ibtn"></button>')),n.isMobile&&"chart"!==i.type&&(o='<button class="fa fa-ellipsis-h ttm-panel pull-right ibtn"></button>'+o),l.block&&a.addClass("blocked"),"column"!==i.category&&a.attr("data-field",i.name);var r=t('<span class="cell-value">'),d=e[i.name];let c,p,f;if(i.linkFieldName||!i.code||i.codeOnlyInAdd||a.addClass("with-code"),"column"!==i.category&&"chart"!==i.type&&a.data("field",i.name).addClass("val"),d){if(c=d.e,!d.h||"showhand"in l&&!0!==l.showhand||(p=void 0!==d.c&&d.v!=d.c?t('<i class="fa fa-hand-paper-o pull-right cell-icon" aria-hidden="true"></i>'):t('<i class="fa fa-hand-rock-o pull-right cell-icon" aria-hidden="true"></i>'),n.isMobile&&p.addClass("ttm-panel")),d.d&&a.addClass("deleted_value"),d.e&&(i.errorText?r.text(i.errorText):(f=t('<i class="fa fa-exclamation-triangle pull-right" aria-hidden="true"></i>'),n.isMobile?f.addClass("ttm-panel"):f.attr("title",d.e),a.append(f))),!l.text||"button"==i.type||n.isTreeView&&"tree"===i.name&&e.__tree&&("self"===i.treeViewType||e.tree_category&&e.tree_category.v)){if(!d.e||!i.errorText){var h=s?i.getHighCelltext(d.v,a,e):i.getCellText(d.v,a,e);"object"==typeof h?r.html(h):r.text(h)}}else r.text(l.text);i.CodeActionOnClickAsUrl&&r.addClass("asUrl")}if(l.comment&&"button"!=i.type&&a.append(t('<i class="cell-icon fa fa-info pull-right"></i>').attr("title",l.comment)),p&&a.append(p),o&&a.append(o),r.appendTo(a),l.text||!i.unitType||c||null===d.v||"postfix"in i||"select"===i.type&&i.multiple||r.attr("data-unit-type"," "+i.unitType),i.css&&a.addClass(i.css),this.isSelected(i.name,e.id)&&a.addClass("selected"),"button"===i.type&&i.pcTable.isMobile&&"column"!==i.category||(l.background?a.css("background-color",l.background):i.panelColor&&a.css("background-color",i.panelColor),l.color&&a.css("color",l.color)),l.bold&&a.css("font-weight","bold"),l.align?a.css("text-align",l.align):l.tab&&a.css("padding-left",l.tab+"px"),l.decoration&&a.css("text-decoration",l.decoration),l.italic&&a.css("font-style","italic"),"tree"===i.type&&h&&"object"==typeof h&&h.is(".tree-view")?f&&f.remove():l.icon&&"button"!==i.type&&a.prepend('<i class="cell-icon fa fa-'+l.icon+'"></i>'),l.progress&&l.progresscolor){let e=function(){if(r.isAttached()){let e=Math.round(r.width()*parseInt(l.progress)/100);r.css("box-shadow","inset "+e.toString()+"px 0px 0 0 "+l.progresscolor)}else setTimeout(e,50)};n.isMobile&&a.data("addProgress",(function(){let e=a.find(".cell-value");e.css("box-shadow","inset "+Math.round(e.width()*parseInt(l.progress)/100).toString()+"px 0px 0 0 "+l.progresscolor)})),e()}return i.format=l,i.td_style&&"function"==typeof i.td_style&&a.css(i.td_style(l)),a},_getLoadingSpinner:function(){return t('<div class="text-center"><i class="fa fa-spinner"></i></div>')},_colorizeElement:function(e,t,i){let n=10,a=function(){0===n?e.css("box-shadow",""):(e.css("box-shadow","inset 0 0 100px 100px "+App.hexToRGB(t,n/10)),n--,setTimeout(a,50))};a()},_TmpColorize:function(e,t,i){var n,a=this;t=t||"#ff0000";"#"!=(i=i||"#ffffff").substr(0,1)&&(i=App.rgb2hex(i));(n=function(e,t,i){var n=parseInt(e.slice(1),16),a=(i=parseInt(i.slice(1),16),t<0?0:i>>16),l=t<0?0:i>>8&255,o=t<0?0:255&i,s=t<0?-1*t:t,r=n>>16,d=n>>8&255,c=255&n;return"#"+(16777216+65536*(Math.round((a-r)*s)+r)+256*(Math.round((l-d)*s)+d)+(Math.round((o-c)*s)+c)).toString(16).slice(1)}(t,.1,i))==t&&(n=i),e.css("background-color",n),n!=i?setTimeout((function(){a._TmpColorize(e,n,i)}),50):e.data("backgroundcolor")||e.attr("style",e.attr("style").replace(/(background\-color:[^;"]+;?)/,""))},__deleteSection(e){App.panelTimer("Удаление секции",5,()=>{App.getPcTableById(2).then((function(t){t.model.checkEditRow({id:e.id}).then(i=>{let n=i.row.data_src.v;t.model.saveEditRow({data_src:{v:{...n,tableBreakBefore:{isOn:!1},sectionTitle:{isOn:!1,Val:n.sectionTitle.Val}}},id:e.id}).then(t=>{e.tableBreakBefore=!1,delete e.sectionTitle,"param"===e.category?e.pcTable._rerendParamsblock():e.pcTable._rerendBottomFoolers()})})}))})},__editSectionTitle(i){App.getPcTableById(2).then((function(n){n.model.checkEditRow({id:i.id}).then(a=>{let l,o=a.row.data_src.v,s="";o.sectionTitle&&"Val"in o.sectionTitle&&(s=o.sectionTitle.Val||"");let r=s.replace(/^(.*?)\*\*.*$/,"$1");/\*\*/.test(s)&&s.replace(/^.*?\*\*/,"").split(/\s*;\s*/).forEach(e=>{""!==e.trim()&&(r+="\n",r+=e.split(":").join(" : "))});let d=t('<div class="HTMLEditor">');e.top.BootstrapDialog.show({message:d,type:BootstrapDialog.TYPE_DANGER,title:"Редактирование секции",cssClass:"sectionTitle-edit-panel",draggable:!0,buttons:[{label:"Сохранить",action:e=>{(e=>{let t="";if(""!==e.trim()){let i=e.split(/\s*[\n\r]+\s*/),n=i[0];i.splice(0,1),t=n,i.length&&(t+="**"+i.join(";").replace(/\s*:\s*/g,":"))}let a=t;n.model.saveEditRow({data_src:{v:{...o,tableBreakBefore:{isOn:!0,Val:!0},sectionTitle:{isOn:!0,Val:a}}},id:i.id}).then(e=>{i.sectionTitle=a,i.tableBreakBefore=!0,"param"===i.category?i.pcTable._rerendParamsblock():i.pcTable._rerendBottomFoolers()})})(l.getValue()),e.close()}}],onhide:function(e){},onshown:function(i){i.$modalContent.position({of:t(e.top.document.body),my:"top+50px",at:"center top"}),l=CodeMirror(d.get(0),{value:r,mode:"sections",minHeight:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!1,autoCloseTags:!1}),l.on("paste",(function(e,t){setTimeout((function(){l.refresh()}),1)}))},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"100%"})}})})}))}})}(),t.extend(App.pcTableMain.prototype,{_addHorizontalDraggable:function(){this._innerContainer.off("mousedown.HorizontalDraggable mouseout").on("mousedown.HorizontalDraggable",(function(e){for(var i=e;i;){if(t(e.target).is("input"))return!0;if(i==e.originalEvent)break;i=e.originalEvent}return t(this).data("x",e.clientX).data("scrollLeft",this.scrollLeft),!1})).on("mousemove",(function(e){if(0===t(e.target).closest(".InsertRow").length&&"INPUT"!==e.target.tagName&&1===e.buttons&&0===e.button&&Math.abs(t(this).data("x")-e.clientX)>20){let i;t(this).data("moved",!0),i&&clearTimeout(i),i=setTimeout((function(){t(this).data("moved",!1)}),200),this.scrollLeft=t(this).data("scrollLeft")+t(this).data("x")-e.clientX}}))}}),App.pcTableMain.prototype._addRowPanel=function(e,i,n){var a=t('<div style="width: 165px;"><div class="buttons insert-row-buttons"></div></div>');if(void 0!==n){var l=a.find(".buttons").empty();t.each(n,(function(e,i){if("function"==typeof i)var n=t('<button class="btn btn-sm btn-default">').html(e).on("click",i);else"object"==typeof i&&"checkbox"==i.type&&(n=t('<input type="checkbox">'),i.id&&n.attr("id",i.id),i.func&&n.on("change",i.func),n=n.wrap('<span style="font-size: 10px; padding-left: 8px;" >').parent().append(' <span style="padding-top: 2px;">'+e+"</span>"));l.append(" "),l.append(n)}))}i.on("remove",(function(){a.remove()}));let o=this;return setTimeout((function(){let e={isParams:!0,$text:a,element:i,container:o._container,placement:"bottom",trigger:"manual"};App.popNotify(e);let n=i.attr("aria-describedby"),l=t("#"+n).addClass("warning-bg");l.find(".arrow").css("left","80%"),o._positionPanel.call(o,l,i),a.show()}),50),a},App.pcTableMain.prototype._positionPanel=function(e,t){t.position();let i=this.tableWidth-120;this._innerContainer.width()>this.tableWidth?e.css({left:i}):e.css({left:this._innerContainer.width()-120})},t.extend(App.pcTableMain.prototype,{_csvExport:function(e){"use strict";let t=this;this.model.csvExport(t.dataSortedVisible,e,Object.keys(App.filter(t.fields,(e,t)=>!!t.showMeWidth))).then((function(e){if(e.csv){let i=new Blob([e.csv],{type:"text/csv;charset=utf-8"});saveAs(i,t.tableRow.title+"."+t.model.tableData.updated.dt+".csv")}}))},_csvImportClick:function(e){let i=this;t('<input type="file" accept="text/csv">').on("change",(function(){if(this.files&&this.files[0]){let t=new FileReader;t.onload=function(t){let n=t.target.result;i._csvImportUpload.call(i,n,e)},t.onerror=function(e){console.log(e.target.error)},t.readAsDataURL(this.files[0])}})).click()},_csvImportUpload:function(e,i){let n=this,a={},l=Object.keys(App.filter(n.fields,(e,t)=>!!t.showMeWidth&&"column"===t.category)),o=function(){n.model.csvImport(e,i,a,"full"==i?[]:l).then((function(e){e.question?App.modal(e.question[1],"Вопрос про csv-загрузку",{"Отменить":"close","Загружаем":function(t){"use strict";t.modal("hide"),a[e.question[0]]=1,o()}}):e.ok&&n.table_modify.call(n,e)}))};if("rows"===i){let e=t("<div></div>");l.forEach(i=>{e.append(t("<div>").text(n.fields[i].title||n.fields[i].name))});App.confirmation(e,{"Отменить":function(e){e.close()},"Загрузить":e=>{o(),e.close()}},"Проверьте соответствие структуры загружаемого файла последовательности полей")}else o()}}),function(){t.extend(App.pcTableMain.prototype,{___fieldsHiddingShowAllButton:null,_hideHell_storage:{isset_fields:!1,opened:null,blinkIt:!1,getOpened:function(){return null===this._hideHell_storage.opened&&(this._hideHell_storage.opened=a.getSavedOpenedVal(this.tableRow),!1===this._hideHell_storage.opened&&(this._hideHell_storage.blinkIt=!0)),this._hideHell_storage.opened},checkIssetFields:function(e){if(this.isCreatorView&&this._beforeSpace){let t=this._hideHell_storage.isset_fields;if(this._hideHell_storage.isset_fields=Object.keys(this.hidden_fields).length||Object.keys(this.fields).some(e=>"n"!==e&&(!this.fields[e].showMeWidth||this.fields[e].showMeWidth<1)),e||t!==this._hideHell_storage.isset_fields){let e=this._beforeSpace.find("#hide-hell").removeClass("btn-contour");this._hideHell_storage.isset_fields?(e.removeAttr("disabled"),this._hideHell_storage.opened?(e.find("i").addClass("fa-arrow-up").removeClass("fa-arrow-down").removeClass("fa-times"),e.addClass("btn-contour")):(e.find("i").removeClass("fa-arrow-up").addClass("fa-arrow-down").removeClass("fa-times"),this._hideHell_storage.blinkIt&&(App.blink(e,8,"#fff"),this._hideHell_storage.blinkIt=!1))):(e.attr("disabled","disabled"),e.find("i").addClass("fa-times").removeClass("fa-arrow-up").removeClass("fa-arrow-down"))}}},switchOpened:function(){this._hideHell_storage.opened=!this._hideHell_storage.opened,this._hideHell_storage.checkIssetFields.call(this,!0),a.saveOpenedVal(this.tableRow,this._hideHell_storage.opened),this._refreshHiddenFieldsBlock()}},fieldsHiddingHide:function(e,t){let i=l.get(this.tableRow)||{};t?i[e]=this.fields[e].width:delete i[e],this.setVisibleFields(i)},setVisibleColumns:function(){let e=this;this.fieldCategories.visibleColumns=[],this.fieldCategories.column.forEach((function(t){t.showMeWidth&&e.fieldCategories.visibleColumns.push(t)}))},setColumnWidth:function(e,t,i){let n=l.get(this.tableRow)||{};n[e]=t;let a=this;i?App.getPcTableById(2).then((function(e){e.model.checkEditRow({id:i}).then((function(l){l.row&&(l.row.data_src.v.width.Val=parseInt(t),e.model.save({[i]:l.row}).then((function(){a.setVisibleFields(n)})))}))})):this.setVisibleFields(n)},loadVisibleFields:function(e){let t={},i=l.getDate(this.tableRow);e=e||{},!i||""!=this.tableRow.fields_actuality&&this.tableRow.fields_actuality>i?this.setVisibleFields(t,!0,moment().format(App.dateTimeFormats.db),e):(t=l.get(this.tableRow)||{},this.setVisibleFields(t,!0,void 0,e))},setVisibleFields:function(e,t,i,n){let a=this,o=!1,s=!1;n=n||{},e&&0===Object.keys(e).length?(e={},Object.values(a.fields).forEach((function(t){let i=t.hidden&&!1!==n[t.name]||!0===n[t.name]?0:t.width;i!=a.fields[t.name].showMeWidth&&("column"===t.category||"footer"===t.category&&t.column?o=!0:s=!0),a.fields[t.name].showMeWidth=i,e[t.name]=a.fields[t.name].showMeWidth}))):Object.values(a.fields).forEach((function(i){let l;l="filter"===i.category?i.width:void 0!==e[i.name]?parseInt(e[i.name]):t&&!i.hidden?i.width:0,i.name in n&&(l=!0===n[i.name]?0:i.width),l!=a.fields[i.name].showMeWidth&&("column"===i.category||"footer"===i.category&&i.column?o=!0:s=!0),a.fields[i.name].showMeWidth=l,e[i.name]=a.fields[i.name].showMeWidth})),l.set(e,this.tableRow,i),this.setVisibleColumns(),this._header&&(s&&this.setWidthes(),o&&(this._refreshHead(),this.rowButtonsCalcWidth(),this._refreshContentTable(!0),this._rerenderColumnsFooter(),this.isCreatorView&&(this._hideHell_storage.checkIssetFields.call(a),this._refreshHiddenFieldsBlock()),Object.keys(this.data).forEach(e=>{delete this.data[e].$tr}),this.ScrollClasterized.insertToDOM(null,!0,!0))),this.fieldsHiddingGetButton(),this._insertRow&&this._closeInsertRow()},hideAdminViewFields:function(){let e=this,t=l.get(this.tableRow)||{};Object.keys(t).forEach((function(i){if(t[i]>0){let n=e.fields[i];(!n||n.webRoles&&1===n.webRoles.length&&"1"==n.webRoles[0])&&delete t[i]}})),this.setVisibleFields(t)},setDefaultVisibleFields:function(){let e={};Object.values(this.fields).forEach((function(t){t.hidden?e[t.name]=0:e[t.name]=t.width})),this.setVisibleFields.call(this,e)},fieldsHiddingShowPanel:function(){let i,n,a=this,l=t('<div class="hidding-form">');const s=function(e){e=e||t("#defaultEyeGroups"),r=a.tableRow.fields_sets||[],e.empty().append("<b>Наборы по умолчанию:</b> "),r.forEach((function(i,n){let l=t('<a href="#">').text(i.name).data("index",n);e.append(l.wrap("<span>").parent()),a.isCreatorView&&(n>0&&l.parent().append(t('<button class="btn btn-xxs field_name"><i class="fa fa-arrow-left"></i></button>').data("index",n)),l.parent().append(t('<button class="btn btn-xxs field_name"><i class="fa fa-remove"></i></button>').data("index",n)))})),e.off(),a.isCreatorView&&e.on("click",".btn",(function(){if(t(this).find("i").is(".fa-remove")){let e=t(this);a.model.removeEyeGroupSet(e.data("index")).then((function(e){a.tableRow.fields_sets=e.sets,s()}))}else{let e=t(this);a.model.leftEyeGroupSet(e.data("index")).then((function(e){a.tableRow.fields_sets=e.sets,s()}))}})),e.on("click","a",(function(){let e=t(this).data("index"),i=r[e].fields;if(Array.isArray(i)){let e={};i.forEach((function(t){a.fields[t]&&(e[t]=a.fields[t].width)})),i=e}a.setVisibleFields.call(a,i),n.close()}))};let r=o.getNames(a.tableRow);if(r&&r.length){let e=t('<div class="fieldsHiddenSets">').appendTo(l);e.append("<b>Наборы:</b> "),r.forEach((function(i){let n=t('<a href="#">').text(i).data("name",i);e.append(n.wrap("<span>").parent());let l=n.parent();l.append(t('<button class="btn btn-xxs" data-action="remove"><i class="fa fa-remove"></i></button>').data("name",i)),a.isCreatorView&&l.append(t('<button class="btn btn-xxs field_name" data-action="addDefaultSet" title="Сохранить как набор по умолчанию"><i class="fa fa-save"></i></button>').data("name",i))})),e.on("click",".btn",(function(){let e=t(this),i=e.data("name");if(a.isCreatorView&&"addDefaultSet"===t(this).data("action")){let t=o.get(a.tableRow,i)||[];a.model.AddEyeGroupSet(i,t).then((function(t){a.tableRow.fields_sets=t.sets,s(),o.remove(a.tableRow,i),e.parent().remove()}))}else o.remove(a.tableRow,i),e.parent().remove()})),e.on("click","a",(function(){let e=t(this).data("name"),i=o.get(a.tableRow,e)||[];a.setVisibleFields.call(a,i),n.close()}))}r=a.tableRow.fields_sets||[];let d=t('<div class="fieldsHiddenSets" id="defaultEyeGroups">').appendTo(l);r&&r.length&&s(d),l.on("click",'input[type="checkbox"]',(function(e){let n=t(this),a=n.closest(".hidding-form");if(e.shiftKey){a.find("input").index(n);let e=a.find("input").index(t(this));a.find("input").each((function(a){(e<=a&&a<i||e>=a&&a>i)&&t(this).prop("checked",!!n.is(":checked")&&"checked").trigger("change")}))}else i=a.find("input").index(t(this))}));let c=[{label:"Применить",action:function(e){let i={};l.find("input:checked").each((function(){let e=t(this);i[e.attr("name")]=parseInt(e.closest("div").find('input[type="number"]').val())||null})),a.setVisibleFields.call(a,i),e.close()}},{label:"По умолчанию",action:function(e){e.close(),a.setDefaultVisibleFields.call(a)}},{label:"Показать все",action:function(e){e.close();let t={};Object.values(a.fields).forEach((function(e){t[e.name]=e.width})),a.setVisibleFields.call(a,t)}},{label:"Создать набор",action:function(i){let n={};l.find("input:checked").each((function(){let e=t(this);n[e.attr("name")]=parseInt(e.closest("div").find('input[type="number"]').val())||null})),a.setVisibleFields.call(a,n),i.close();let s=t("<div></div>");s.append('<div style="padding-top: 10px;"><label>Название набора</label><input type="text" id="fieldsSetName" class="form-control"/></div>'),e.top.BootstrapDialog.show({message:s,title:"Сохранить набор полей",type:null,buttons:[{label:"Сохранить",action:function(e){let t=s.find("#fieldsSetName");""===t.val().trim()?t.addClass("error"):(o.set(a.tableRow,n,t.val().trim()),e.close())}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],draggable:!0})}},{label:"Отмена",action:function(e){e.close()}}];a.isCreatorView&&c.splice(2,0,{label:"Скрыть адм.поля",action:function(e){e.close(),a.hideAdminViewFields.call(a)}});let p={param:"Хэдер",column:"Колонки",footer:"Футер"};Object.keys(p).forEach((function(e){a.fieldCategories[e]&&a.fieldCategories[e].length&&(l.append('<div class="category-name">'+p[e]+"</div>"),t.each(a.fieldCategories[e],(function(e,i){let n="";i.hidden&&(n=" (Скрыто по умолчанию)");let a=t('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="'+i.name+'" class="form-check-input"> '+i.title+n+'</label> <input type="number" placeholder="'+i.width+'" value="'+(i.showMeWidth&&i.showMeWidth!==i.width?i.showMeWidth:i.width)+'"/></div>');i.showMeWidth&&(a.find("input").prop("checked",!0),a.attr("data-checked",!0)),a.appendTo(l)})))})),l.on("change",'input[type="checkbox"]',(function(){let e=t(this).closest("div");t(this).is(":checked")?e.attr("data-checked",!0):e.removeAttr("data-checked")})),n=e.top.BootstrapDialog.show({message:l,title:"Видимость полей",buttons:c,type:null,draggable:!0,onshow:function(e){a.isCreatorView&&e.$modalContent.css({width:"800px"})}})},fieldsHiddingGetButton:function(e){"use strict";let i=this;if(!this.___fieldsHiddingShowAllButton){let e;this.___fieldsHiddingShowAllButton=t('<button class="btn btn-sm"><span class="fa fa-eye-slash"></span></button>').on("click",(function(){i.fieldsHiddingShowPanel.call(i)})).on("contextmenu",(function(){return i.isCreatorView?e?(clearTimeout(e),e=null,i.hideAdminViewFields.call(i,!0)):e=setTimeout((function(){i.setDefaultVisibleFields.call(i),e=null}),500):i.setDefaultVisibleFields.call(i),!1}))}return Object.values(i.fields).some((function(e){if(e.showInWeb&&!e.hidden&&!e.showMeWidth)return!0}))?(this.___fieldsHiddingShowAllButton.addClass("btn-warning"),this.___fieldsHiddingShowAllButton.removeClass("btn-default"),e&&App.blink(this.___fieldsHiddingShowAllButton,8,"#fff")):(this.___fieldsHiddingShowAllButton.addClass("btn-default"),this.___fieldsHiddingShowAllButton.removeClass("btn-warning")),this.___fieldsHiddingShowAllButton}});let i="pcTableShowFieldsWithDates",n=function(e){let t=e.id;return"calcs"===e.type&&(t+="$"+e.__version),t},a={saveOpenedVal:function(e,t){localStorage.setItem(this.getKeyString(e),t.toString())},getKeyString:function(e){return e.id+"/"+e.__version},getSavedOpenedVal:function(e){let t=localStorage.getItem(this.getKeyString(e));return!t||JSON.parse(t)}},l={set:function(e,t,a){let l=n(t),o={},s=e||{};try{o=JSON.parse(localStorage.getItem(i))||{}}catch(e){}a||!o[l]?o[l]=[s,a]:o[l][0]=s,localStorage.setItem(i,JSON.stringify(o))},get:function(e){let t=n(e);return l.getInner(t)[0]},getDate:function(e){let t=n(e);return l.getInner(t)[1]},getInner:function(e){let t;try{t=JSON.parse(localStorage.getItem(i))||{}}catch(e){t={}}return t[e]||[]}},o={set:function(e,t,i){let a=[],l="pcTableShowFieldsSets"+n(e),o=t||[];try{a=JSON.parse(localStorage.getItem(l))||{}}catch(e){}a[i]=o,localStorage.setItem(l,JSON.stringify(a))},get:function(e,t){let i,a="pcTableShowFieldsSets"+n(e);try{i=JSON.parse(localStorage.getItem(a)),i=i[t]}catch(e){}return null==i&&(i=void 0),i},getNames:function(e){let t,i="pcTableShowFieldsSets"+n(e);try{return t=JSON.parse(localStorage.getItem(i)),Object.keys(t)}catch(e){}return null==t&&(t=void 0),t},remove:function(e,t){let i,a="pcTableShowFieldsSets"+n(e);try{i=JSON.parse(localStorage.getItem(a)),delete i[t],localStorage.setItem(a,JSON.stringify(i))}catch(e){}}}}(),App.pcTableMain.prototype._print=function(){"use strict";let i=t('<div class="hidding-form">');const n=function(e){if(e.showMeWidth)return!0};this.fieldCategories.param.length&&this.fieldCategories.param.some(n)&&i.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="params" class="form-check-input" checked="checked"> Параметры</label></div>'),this.fieldCategories.filter.length&&i.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="filters" class="form-check-input" checked="checked"> Фильтры</label></div>'),this.fieldCategories.column.length&&this.fieldCategories.column.some(n)&&this.dataSortedVisible.length&&(i.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="rows" class="form-check-input" checked="checked"> Строчную часть</label></div>'),i.append('<div class="form-check no-bold" style="padding-left: 20px;"><label class="form-check-label"><input type="checkbox" name="with-id" class="form-check-input"> с id</label></div>')),this._footersBlock.find(".val").length&&i.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="column-footers" class="form-check-input" checked="checked"> Футеры колонок</label></div>'),this._footersSubTable.find(".val").length&&i.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="other-footers" class="form-check-input" checked="checked"> Футеры вне колонок</label></div>');let a=this,l=[{label:"Печать",action:function(e){let n=[];i.find("input:checked").each((function(){n.push(t(this).attr("name"))})),e.close(),a._printTable.call(a,n)}},{label:"Отмена",action:function(e){e.close()}}];e.top.BootstrapDialog.show({message:i,type:null,title:"Печать",buttons:l,draggable:!0})},App.pcTableMain.prototype._printTable=function(e){let t=this,i={fields:{}};-1!==e.indexOf("with-id")&&(i.fields.id=50);let n={params:t.fieldCategories.param,filters:t.fieldCategories.filter,rows:t.fieldCategories.column,"column-footers":t.fieldCategories.footer.filter((function(e){return""!==e.column})),"other-footers":t.fieldCategories.footer.filter((function(e){return""===e.column}))};Object.keys(n).forEach((function(t){-1!==e.indexOf(t)&&n[t].forEach((function(e){"button"===e.type||e.showMeWidth<1||!e.showMeWidth||(i.fields[e.name]=e.showMeWidth)}))})),-1!==e.indexOf("rows")&&(i.ids=t.dataSortedVisible),i.sosiskaMaxWidth=1100,t.model.printTable(i)},App.pcTableMain.prototype.reOrderRows=function(e,i){let n,a=this;if(a.tableRow.with_order_field&&!a.nSorted)return App.notify("Для работы поля порядок перезагрузите таблицу"),!1;let l=[];if(0===this.row_actions_get_checkedIds().length){l.push(e);let t=this.dataSortedVisible.indexOf(e)+("after"===i?1:-1);if(t<0||!(t in this.dataSortedVisible))return;if(this.data[this.dataSortedVisible[t]].f&&this.data[this.dataSortedVisible[t]].f.blockorder)return void App.notify("Нельзя перемещать строку "+this.getRowTitle(this.data[this.dataSortedVisible[t]]));n=this.dataSorted.indexOf(this.dataSortedVisible[t]),l.forEach((function(e){a.dataSorted.splice(a.dataSorted.indexOf(e),1)}))}else{if(-1!==a.row_actions_get_checkedIds().indexOf(e))return App.notify("В качестве якоря для перемещения нужно выбрать не отмеченную строку"),!1;let t=this.row_actions_get_checkedIds().length;this.dataSorted.some((function(e,i){if(0===t)return!0;a.data[e].$checked&&(l.push(e),--t)})),l.forEach((function(e){a.dataSorted.splice(a.dataSorted.indexOf(e),1)})),n=this.dataSorted.indexOf(e)+("after"===i?1:0)}a.dataSorted.splice(n,0,...l),this.dataSortedVisible=[],a.dataSorted.forEach((function(e){a.data[e].$visible&&a.dataSortedVisible.push(e)})),a._refreshContentTable(),a.tableRow.with_order_field&&t("table.pcTable-table").addClass("reordered"),a.row_actions_uncheck_all()},App.pcTableMain.prototype.reOrderRowsSave=function(){let e=this;e._orderSaveBtn.prop("disabled",!0).find("i").attr("class","fa fa-cog"),this.model.saveOrder(this.dataSorted).then((function(i){e.table_modify(i),e._orderSaveBtn.prop("disabled",!1).find("i").attr("class","fa fa-save"),t("table.pcTable-table").removeClass("reordered")}))},App.pcTableMain.prototype.addReOrderRowBind=function(){let e=this;e._innerContainer.on("click","td.n button",(function(i){let n=t(this);e.tableRow.with_order_field&&!e.__getCheckedRowsIds(void 0,!0,"blockorder")||e.reOrderRows.call(e,e._getItemByTr.call(e,n.closest("tr")).id,1===n.find(".fa-angle-up").length?"before":"after")}))},App.pcTableMain.prototype.__formatFunctions={blockadd:function(){this._closeInsertRow(),this._rowsButtons()},tablecomment:function(){this._rowsButtons()},blockorder:function(){this._refreshHead()},block:function(){this._refreshParamsBlock(),this._refreshContentTable(!0),this._refreshFootersBlock()},tabletitle:function(){this._refreshTitle()},text:function(){this._refreshTableText()},rowstitle:function(){this._container.find(".pcTable-rowsTitle:first").replaceWith(this._createRowsTitle())},fieldtitle:function(e,t){let i={};const n=function(e){return"footer"==e.category&&e.column?"tableFooter":e.category};for(const a in e)this.fields[a]&&e[a]!==t[a]&&(i[n(this.fields[a])]=!0);for(const a in t)this.fields[a]&&e[a]!==t[a]&&(i[n(this.fields[a])]=!0);for(const e in i)switch(e){case"param":this._rerendParamsblock();break;case"filter":this._rerendFiltersBlock();break;case"column":this._refreshHead();break;case"footer":this._rerendBottomFoolers();break;case"tableFooter":this._rerenderColumnsFooter()}}},App.pcTableMain.prototype._connectTreeView=function(){let e=this;this._content.on("click",".treeRow",(function(){let i=t(this);i.is(".dbl")?e._actionTreeFolderRow.call(e,i,!0):e._actionTreeFolderRow.call(e,i)})),this.model.loadTreeBranches=function(e,t,i){return this.__ajax("post",{method:"loadTreeBranches",branchIds:e,withParents:t,recurcive:i},null,null,this.filtersString||{})}},App.pcTableMain.prototype._createTreeFolderRow=function(e,i){if(e.row&&this.data[e.row.id]){let t={...e};delete t.row,e.row.__tree=t;let n=i||this._createRow(e.row);return this.data[e.row.id].__tree=t,e.tr=this.data[e.row.id].$tr=n}{let n=i||t('<tr><td class="id"></td></tr>'),a=t('<i class="fa fa-folder'+(e.opened?"-open":"")+' treeRow"></i>').data("treeRow",e.v),l=t('<span class="tree-view">').append(a);l.append(t('<button class="btn btn-default btn-xxs treeRow dbl"><i class="fa fa-arrows-v"></i></button>').data("treeRow",e.v));let o=t('<td colspan="'+(this.fieldCategories.column.length-1)+'" class="tree-view-td" style="padding-left: '+(7+10*e.level)+'px"></td>');return o.append(l),o.append(e.t),n.append(o),e.tr=n}},App.pcTableMain.prototype.treeApply=function(){this.treeReloadRows.length?this.model.loadTreeBranches(this.treeReloadRows,!0).then(e=>{e.tree&&e.tree.forEach((e,t)=>{this.getTreeBranch(e,t)}),e.rows&&this._treeApplyRows(e.rows),this.treeReloadRows=[],this._treeRefresh(),this.__applyFilters(!0),this.ScrollClasterized.insertToDOM(null,!0,!0)}):(this._treeRefresh(),this.__applyFilters(!0),this.ScrollClasterized.insertToDOM(null,!0,!0))},App.pcTableMain.prototype._closeTreeFolderRow=function(e,t,i){e.opened=!1,i=i||0,t?(this.treeIndex[e.v].trees.forEach(e=>{this._closeTreeFolderRow(this.treeIndex[e],!0,i+1)}),i||this.treeApply()):this.treeApply()},App.pcTableMain.prototype._actionTreeFolderRow=function(e,i){let n=this.treeIndex[t(e).data("treeRow")];e&&t(e).closest("td").html("Загрузка"),n.opened?this._closeTreeFolderRow(n,i):this._expandTreeFolderRow(n,i)},App.pcTableMain.prototype._expandTreeFolderRow=function(e,t,i){let n=!1;i||(n=!0,i={counter:0});const a=()=>{this.treeIndex[e.v].trees.forEach(e=>{i.counter++,this._expandTreeFolderRow(this.treeIndex[e],!0,i)})};e.l?(e.opened=!0,t?(a(),i.counter<1?this.treeApply():i.counter--):this.treeApply()):this.model.loadTreeBranches([e.v],null,!!t).then(n=>{e.opened=!0,e.l=!0,n.tree&&n.tree.forEach((e,t)=>{this.getTreeBranch(e,t)}),n.rows&&this._treeApplyRows(n.rows),(!t||i.counter--<1)&&this.treeApply()})},App.pcTableMain.prototype._treeRefresh=function(){const e=(t,i)=>{i=i||0,t.forEach(t=>{this.treeIndex[t].level=i,0!==i||"opened"in this.treeIndex[t]||(this.treeIndex[t].opened=!0),this.dataSorted.push(this.treeIndex[t]),this.treeIndex[t].opened&&(this.dataSorted.push(...this.treeIndex[t].sorted),e(this.treeIndex[t].trees,i+1))})};this.dataSorted=[];let t=[...this.treeSort];""==t[0]&&0===this.treeIndex[""].sorted.length&&delete t[0],e(t)},App.pcTableMain.prototype._treeApplyRows=function(e){e.map(e=>{this.placeInTree(e),e.id in this.data||(this.data[e.id]=e,this.data[e.id].$checked=-1!==this.__checkedRows.indexOf(e.id))},this)},App.pcTableMain.prototype.placeInTree=function(e,t,i){let n="sorted";if("self"===this.fields.tree.treeViewType&&(n="trees"),t){if(e&&!(e.tree&&e.tree.v!==t.tree.v||e.tree_category&&e.tree_category.v!==t.tree_category.v))return;let i=t?t.tree.v:void 0;if(null===i&&(i=""),"other"===this.fields.tree.treeViewType&&t.tree_category&&t.tree_category.v&&this.treeIndex[t.tree_category.v]&&this.treeIndex[t.tree_category.v].row&&this.treeIndex[t.tree_category.v].row.id===t.id&&delete this.treeIndex[t.tree_category.v].row,i in this.treeIndex){let e=this.treeIndex[i][n].indexOf(t.id.toString());-1!==e&&this.treeIndex[i][n].splice(e,1)}this.treeRefresh=!0}if(e){if("other"===this.fields.tree.treeViewType&&e.tree_category&&e.tree_category.v&&this.treeIndex[e.tree_category.v])this.treeIndex[e.tree_category.v].row=e;else{let t=e.tree.v||"";"self"===this.fields.tree.treeViewType&&(e.id in this.treeIndex?this.treeIndex[e.id].row=e:n="sorted"),t in this.treeIndex&&this.treeIndex[t].l?(-1===this.treeIndex[t][n].indexOf(e.id.toString())&&this.treeIndex[t][n].push(e.id.toString()),i&&this.openTreeWithParent(this.treeIndex[t])):t&&this.treeReloadRows.push(t)}this.treeRefresh=!0}},App.pcTableMain.prototype.openTreeWithParent=function(e){e.opened=!0,e.p&&this.treeIndex[e.p]&&this.openTreeWithParent(this.treeIndex[e.p])},App.pcTableMain.prototype.treeDeletingRow=function(e){let t=this.data[e];t&&this.placeInTree(null,t)},App.pcTableMain.prototype.getTreeBranch=function(e){if(null===e.v?e.v="":e.v=e.v.toString(),this.treeIndex[e.v]||(this.treeIndex[e.v]={...e},this.treeIndex[e.v].sorted=this.treeIndex[e.v].sorted||[],this.treeIndex[e.v].trees=this.treeIndex[e.v].trees||[]),this.treeIndex[e.v].l="l"in e?e.l:"l"in this.treeIndex[e.v]?this.treeIndex[e.v].l:""===e.v,this.treeIndex[e.v].opened="opened"in e?e.opened:"opened"in this.treeIndex[e.v]?this.treeIndex[e.v].opened:""===e.v,void 0!==e.p&&this.treeIndex[e.v].p!=e.p&&void 0!==this.treeIndex[e.v].p&&this.treeIndex[e.v].p in this.treeIndex){let t=this.treeIndex[this.treeIndex[e.v].p].trees.indexOf(this.treeIndex[e.v].v);-1!==t&&this.treeIndex[this.treeIndex[e.v].p].trees.splice(t,1)}if(e.p){let t=this.getTreeBranch({v:e.p});-1===t.trees.indexOf(e.v)&&t.trees.push(e.v)}else e.t&&-1===this.treeSort.indexOf(e.v)&&this.treeSort.push(e.v);return Object.keys(e).forEach(t=>{this.treeIndex[e.v][t]=e[t]}),this.treeIndex[e.v]},function(){const e=function(e){let i=this.data[e],n=i.$tr||t('<div class="panelsView-card pcTable-floatInner">').css({"min-height":this.tableRow.panels_view.height+"px",height:this.tableRow.panels_view.height,width:this.tableRow.panels_view.width});if(i.$tr=n.empty(),n.data("id",e),this.tableRow.panels_view.fields.forEach(a=>{let l=t("<td>"),o={};o.height=a.height,l.data("name",a.field),a.border||(o["border-color"]="transparent",o["background-color"]="transparent");let s,r=this.fields[a.field];try{s=t.extend({},this.f||{},i.f||{},i[a.field].f&&i[a.field].f||{})}catch(e){console.log(e,i,a.field),s={}}if("button"!=r.type){if(s.color&&(o["font-color"]=s.color),s.background&&(o["background-color"]=s.background),s.text)l.text(s.text);else{let e=r.getHighCelltext(i[a.field].v,l,i);null!==e&&"object"==typeof e?e.then&&"function"==typeof e.then?(l.html('<div class="text-center"><i class="fa fa-spinner"></i></div>'),e.then(e=>{"object"==typeof e?l.html(e):l.text(e)})):l.html(e):l.text(e),r.unitType&&""!==e&&l.append(" "+r.unitType)}if(s.comment?l.prepend(t('<i class="fa fa-help">').attr("title",s.comment)):s.icon&&l.prepend(t('<i class="fa">').addClass("fa-"+s.icon)),l.attr("data-field-type",r.type).addClass("nonowrap"),!1!==s.showhand&&i[a.field].h){let e,n=i[a.field];e=void 0!==n.c&&n.v!=n.c?t('<i class="fa fa-hand-paper-o pull-right cell-icon" aria-hidden="true"></i>'):t('<i class="fa fa-hand-rock-o pull-right cell-icon" aria-hidden="true"></i>'),l.append(e)}}else{i.__td_style=function(){let e={td:{},Button:{}};return s.background&&(e.Button.backgroundColor=s.background),s.color&&(e.Button.color=s.color),e.td.backgroundColor="transparent",e},l.html(r.getCellText(i[a.field].v,l,i)),l.find("button").on("click",()=>{this._buttonClick(l,r,i)})}if(s.bold&&(o["font-weight"]="bold"),s.italic&&(o["font-style"]="italic"),s.decoration&&(o["text-decoration"]=s.decoration),s.align&&(o["text-align"]=s.align),s.color&&(o.color=s.color),s.tab&&(o["padding-left"]=s.tab),s.progress&&s.progresscolor){let e=function(){if(l.isAttached()){let e=Math.round(l.width()*parseInt(s.progress)/100);l.css("box-shadow","inset "+e.toString()+"px 0px 0 0 "+s.progresscolor)}else setTimeout(e,50)};e()}l.css(o);let d=t("<div>").append(l),c=this;if(a.title){let i=t("<th>").text(this.fields[a.field].title);r.help&&(r.helpFunc||(c.addThHelpCloser(),r.helpFunc=function(e){let i,n=t(this);return n.data("bs.popover")?"open"!==e.type&&(i&&clearTimeout(i),i=setTimeout(()=>{n.attr("aria-describedby")&&t("#"+n.attr("aria-describedby").length)&&n.popover("destroy")},120)):"close"!==e.type&&(c._container.trigger("click"),setTimeout(()=>{let e=t('<div class="i-inner-div">').html(r.help).width(230);n.popover({trigger:"manual",content:e,html:!0,placement:()=>{let t=c._container;n.offset().top,t.offset().top;return e.css("max-height",300),"bottom"},container:c.scrollWrapper}),n.popover("show")},150)),!1}),i.prepend(t('<button class="btn btn-default btn-xxs cell-help" id="field-help-'+r.name+"-"+e+'"><i class="fa fa-info"></i></button>').on("click open close",r.helpFunc))),d.prepend(i)}n.append(d)}),this.tableRow.panels_view.controls){if(!this.pcTableControllsEvents){this.pcTableControllsEvents=!0;let e=this;this._innerContainer.on("click",".panel-controls button",(function(){let i=t(this),n=i.closest(".panelsView-card").data("id");switch(i.data("action")){case"duplicate":e.row_duplicate(n);break;case"delete":e.rows_delete(n);break;case"recalculate":e.row_refresh(n);break;case"panel":e._row_edit([n])}return!1}))}let a=t('<div class="panel-controls">');a.append('<span class="panle-id">id '+e+"</span>"),this.tableRow.panel&&a.append('<button class="btn btn-default btn-xxs" data-action="panel"><i class="fa fa-th-large"></i></span>'),!this.control.duplicating||this.f.blockduplicate||i.f.blockduplicate||a.append('<button class="btn btn-default btn-xxs" data-action="duplicate"><i class="fa fa-clone"></i></span>'),!this.control.deleting||this.f.blockdelete||i.f.blockdelete||a.append('<button class="btn btn-default btn-xxs" data-action="delete"><i class="fa fa-times"></i></span>'),a.append('<button class="btn btn-default btn-xs" data-action="recalculate"><i class="fa fa-refresh"></i></span>'),n.append(a)}return n},i=function(e){if(this.kanban){const i=e=>{let i=t.Deferred(),n=[];return e.parent().find(".panelsView-card").each((e,i)=>{n.push(t(i).data("id"))}),n.length>1?(n.forEach(e=>{this.dataSorted.splice(this.dataSorted.indexOf(e),1)}),this.dataSorted.push(...n),this.model.saveOrder(n).then(e=>{this.table_modify(e)})):(i.resolve(),i.promise())};t(e).find(".kanban").sortable({items:".panelsView-card",connectWith:this.fields[this.tableRow.panels_view.kanban].editable?".kanban":void 0,stop:(e,n)=>{let a=t(n.item),l=a.data("id");a.prev().data("id");App.fullScreenProcesses.show("sorting");let o=this.data[l][this.tableRow.panels_view.kanban];this.data[l][this.tableRow.panels_view.kanban]!=a.parent().data("value")?(o=a.closest(".kanban").data("value"),this.model.save({[l]:{[this.tableRow.panels_view.kanban]:o}}).then(e=>{this.tableRow.with_order_field?i(a).always(()=>{this._container.getNiceScroll().resize(),App.fullScreenProcesses.hide("sorting")}):(this.table_modify(e),this._container.getNiceScroll().resize(),App.fullScreenProcesses.hide("sorting"))})):this.tableRow.with_order_field&&i(a).always(()=>{App.fullScreenProcesses.hide("sorting")})}})}else t(e).data("sortableAdded")||(t(e).data("sortableAdded",1),t(e).sortable({stop:(e,i)=>{let n=t(i.item),a=n.data("id"),l=n.prev().data("id"),o=[...this.dataSorted];this.dataSorted.splice(this.dataSorted.indexOf(a),1),l?this.dataSorted.splice(this.dataSorted.indexOf(l)+1,0,a):this.dataSorted.splice(0,0,a),this.dataSortedVisible=[],this.dataSorted.forEach(e=>{this.data[e].$visible&&this.dataSortedVisible.push(e)}),Object.equals(o,this.dataSorted)||(App.fullScreenProcesses.show("sorting"),this.model.saveOrder(this.dataSorted).then(e=>{this.table_modify(e)}).always(()=>{App.fullScreenProcesses.hide("sorting")}))}}))},n=function(){let e=this._content||t('<div class="pcTable-floatBlock">');if(e.each((e,t)=>{!this.tableRow.with_order_field&&!this.kanban||!this.control.editing||this.f.blockorder||this.f.blockedit||setTimeout(()=>{i.call(this,t)},1)}),e.empty(),this.__applyFilters(),this.dataSortedVisible.length)if(this.kanban){this._innerContainer.addClass("kanbanInnerContainer"),e.addClass("kanbanWrapper").empty(),e.css("grid-template-columns","1fr ".repeat(this.kanban.length));let i=0;this.kanban.forEach(n=>{let a=(this.tableRow.panels_view.panels_in_kanban||1)*(parseInt(this.tableRow.panels_view.width)+10)-10;n.$div=t('<div class="kanban"></div>').data("value",n[0]).width(a),i&&(i+=20),i+=a,n.$div.append(t('<div class="kanban-title">').text(n[1]).attr("data-value",n[0]));let l=t('<div class="kanban-cards">');n.$div.append(l);let o=n[0];e.append(n.$div),this.dataSortedVisible.forEach(e=>{(this.data[e][this.tableRow.panels_view.kanban].v||"")==o&&l.append(this._getRowCard(e))})}),e.width(i),this.tableWidth=i}else this.dataSortedVisible.forEach(t=>{let i=this._getRowCard(t);e.append(i)});else e.append('<div class="no-panels">Нет данных</div>');return setTimeout(()=>{this._container.getNiceScroll().resize()}),e},a=function(){let e=this;this._sorting={},this._table=t("<table>").addClass(this.tableClass),this.notCorrectOrder&&this._table.addClass("no-correct-n-filtered"),this._popovers=t('<div class="popovers">'),1===this.fieldCategories.column.length&&e._container.addClass("no-fields");let i=this.scrollWrapper=this._container.append('<div class="pcTable-scrollwrapper">').find(".pcTable-scrollwrapper");i.append(this._createBeforeSpace()).append(this._createTableText()),this.isCreatorView&&i.append(this._refreshHiddenFieldsBlock()),this._paramsBlock=this._createParamsBlock(i);let n,a,l=t('<div class="pcTable-rowsWrapper">').appendTo(i);l.append(this._createRowsTitle(l)).append(this._createFiltersBlock()).append(this._rowsButtons()).append(this._innerContainer),this._footersBlock=t(),this._content=this._refreshContentTable().appendTo(this._innerContainer),this.tableRow.panels_view.css&&this._container.prepend(t("<style>").text(this.tableRow.panels_view.css)),this._innerContainer.addClass("panelsView"),this._footersSubTable=this._createFootersSubtable(i),i.append(this._footersSubTable).append(this._popovers),this._seeCalcucatedValData(),this._seeSelectPreview(),this._clickstoCopyMe(),"cycles"==e.tableRow.type&&this._content.on("dblclick",".panelsView-card",(function(){let i=t(this).data("id");e.model.dblClick(i)})),this._content.on("contextmenu",".panelsView-card td",(function(){n&&n.removeClass("selected");let i=t(this),a=e.data[i.closest(".panelsView-card").data("id")],l=i.data("name");i.data("panel")&&i.data("panel").isAttached()&&e.selectedCells.selectPanel===i.data("panel")?(e.selectedCells.selectPanelDestroy(),i.data("panel",null)):(i.data("panel",e.selectedCells.selectPanel=e.getSelectPanel.call(e,e.fields[l],a,i)),n=i.addClass("selected"))})),this._content.on("click",".panelsView-card",(function(e){if(e.originalEvent&&e.originalEvent.path&&!t(e.originalEvent.path[0]).is("button, .fa")){let e=t(this);a&&a.get(0)===e.get(0)?(e.removeClass("selected"),a=null):(a&&a.removeClass("selected"),a=e.addClass("selected"))}})),this.isCreatorView&&this._hideHell_storage.checkIssetFields.call(this)},l=function(e,i,n){e.is(".panelsView-card")&&(t.extend(i,n),this._getRowCard(i.id))};App.pcTableMain.prototype._renderTablePanelView=function(){if(this.loadFilters(),this._renderTable=a.bind(this),this._getRowCard=e.bind(this),this._refreshHead=()=>{},this.Scroll=()=>({reloadScrollHead:()=>{},insertToDOM:()=>{this._refreshContentTable()}}),this.kanban){let e,i,n,a=this._container,l=!1;const o=()=>{i=i||this._container.find(".kanbanWrapper.pcTable-floatBlock");let e=i.offset();if(e.top<0){if(!n){let a={left:e.left,"grid-template-columns":i.css("grid-template-columns"),width:i.width()};n=t('<div class="kanbanWrapper pcTable-floatBlock cln">').css(a),t(".kanban").each((function(){let e=t(this),i=t("<div class='kanban'>").width(e.width()).append(e.find(".kanban-title").clone());n.append(i)}))}l||(l=!0,this._innerContainer.append(n))}else l&&(l=!1,n.detach())};a.on("scroll",()=>{clearTimeout(e),e=setTimeout(()=>{o()},50)}),this.rowButtonsCalcWidth=function(){this.tableWidth<this._innerContainer.width()?this.__$rowsButtons.width(this.tableWidth):this.isMobile||this.__$rowsButtons.width(this._innerContainer.width())}}else this.rowButtonsCalcWidth=function(){this.tableWidth=0,this._innerContainer.find(".panelsView-card").toArray().some(e=>{let i=t(e),n=i.offset().left+i.width();if(!(n>this.tableWidth))return!0;this.tableWidth=n}),this.tableWidth-=this._innerContainer.offset().left+50,this.isMobile||this.__$rowsButtons.width(this.tableWidth)};this.refreshRow=l.bind(this),this._refreshContentTable=n.bind(this),this._getItemBytd=function(e){return this.data[e.closest(".panelsView-card").data("id")]||this.data_params},this._getFieldBytd=function(e){return 0===e.closest(".panelsView-card").length?this.fields[e.data("field")]:this.fields[e.data("name")]}}}(),t.extend(App.pcTableMain.prototype,{setWidthes:function(){"use strict";let i;this.isMobile?(i=5,this.switchContainerNideScroll(!1)):(i=t("body>.page_content:first").is(".tree-minifyed")?5:300,this.switchContainerNideScroll(!0)),this.width=t("body").width()-i,this._container.width(this.width),this.isMobile?this._innerContainer.width("auto"):this._innerContainer.width(this.width-80),this._rerendParamsblock(),this.isCreatorView&&this._refreshHiddenFieldsBlock(),this._rerendFiltersBlock(),this._refreshHead(),this._rerendBottomFoolers(),this.rowButtonsCalcWidth(),this._container.width()<this._table.width()&&this._addHorizontalDraggable(),this._container.height(e.innerHeight-this._container.offset().top-10)},initForPanel:function(e){t.extend(!0,this,e),this.refreshArraysFieldCategories(!1);let i={};this.__checkedRows=[],this.rows.map((function(e){this.dataSorted.push(e.id),this.dataSortedVisible.push(e.id),i[e.id]=e,i[e.id].$checked=-1!==this.__checkedRows.indexOf(e.id)}),this),this.data=i,this.model.setLoadedTableData(this.data)},closeCallbacks:[],_init:function(){let i=this;t(document).on({dragover:function(){return!1},drop:function(){return!1}}),this._container.addClass(this.contanerClass).addClass("pcTable-type-"+this.tableRow.type);let n=t("#nav-top-line");n.addClass("pcTable-type-"+this.tableRow.type),"tmp"===this.tableRow.type&&n.text("Будьте внимательны - это временная таблица"),this._innerContainer=t('<div class="innerContainer">');let a=!1;const l=function(){if(!a){a=!0;let e=i.closeCallbacks.length;i.closeCallbacks.forEach((function(e){e()})),i.closeCallbacks.splice(0,e),a=!1}};if(t("body").on("keyup",(function(e){27===e.which&&(i._container.trigger("escPressed"),l())})),t("body").on("click",l),i._container.on("scroll",l),i._innerContainer.on("scroll",l),this.isCreatorView&&this._container.on("click",".creator-icons:not([aria-describedby])",(function(e){let n=t(this);if(0===n.closest(".popover").length){let e=t('<div style="width:200px" class="creator-icons">');n.find("i").each((function(i,a){let l=t("<div>").append(a.outerHTML);0===i&&l.append(" "+n.closest("th").find(".field_name").text()),a.title&&l.append(" "+a.title),e.append(l)})),App.popNotify({isParams:!0,$text:e,element:n,trigger:"manual",placement:"top"}),setTimeout((function(){i.closeCallbacks.push((function(){n&&n.length&&n.popover("destroy")}))}),200)}})),i._container.on("contextmenu",(function(e){let i=t(e.target);if(!i.closest(".popover").length&&!i.closest(".edit-row-panel").length)return!1})),this._container.append(this._innerContainer),this.initRowsData(),!this.isMobile){let n;t(e).resize((function(){n&&clearTimeout(n),n=setTimeout((function(){i.setWidthes()}),500)}))}},refreshArraysFieldCategories:function(){"use strict";let i=this;i.hidden_fields=i.hidden_fields||{},t.each(i.hidden_fields,(function(e,n){i.hidden_fields[e]=t.extend({},n,r[n.type],n),i.hidden_fields[e].isHiddenField=!0})),i.mainFieldName="id",i.fieldCategories={},["param","column","filter","footer","panel_fields"].forEach((function(e){i.fieldCategories[e]=[]}));let n=[];try{n=JSON.parse(decodeURIComponent(e.location.hash.substring(1))||"[]"),n=n&&n.wc?n.wc:[]}catch(e){}let a=!1;const l=function(e,l){l.pcTable=i,-1===n.indexOf(l.category)&&((l=r[l.type]?t.extend({},d,r[l.type],l):t.extend({},d,l)).showInWebOtherOrd&&(l._ord=l.ord,l.ord=l.showInWebOtherOrd,a=!0),l.showInWebOtherPlacement&&(l._category=l.category,l.category=l.showInWebOtherPlacement,a=!0),i.fields[e]=l,l.showInWeb?"column"===l.category?("n"!==l.name&&i.fieldCategories.panel_fields.push(l),"tree"===l.name&&"column"===l.category&&l.treeViewType?(i.isTreeView=!0,i.fieldCategories[l.category].unshift(l)):i.fieldCategories[l.category].push(l)):i.fieldCategories[l.category].push(l):l.name&&(i.hidden_fields[l.name]=l))};l("n",{type:"n"});let o=t.extend({},this.fields);delete o.n,t.each(o,l),a&&["param","column","filter","footer"].forEach((function(e){i.fieldCategories[e].sort((function(e,t){return e.ord-t.ord}))})),i.notTableFooterFields=[],i.fieldCategories.footer.forEach((function(e){e.column||i.notTableFooterFields.push(e)})),this.tableRow.main_field&&this.fields[this.tableRow.main_field]&&(i.mainFieldName=this.tableRow.main_field)},render:function(e){let t=this;if(this.loadVisibleFields(this.f&&this.f.fieldhide?this.f.fieldhide:void 0),"panels"!==this.viewType||this.isMobile||this._renderTablePanelView(),this.ScrollClasterized=this.Scroll(),this._renderTable(),this._sorting.addSortable&&this._sorting.addSortable(this),this._addSelectable(),this._addEditable(),this._addSave(),this.row_actions_add(),this.__addFilterable(),this._refreshHead(),t.checkIsUpdated>0){let e=2e3*parseInt(t.checkIsUpdated);setTimeout((function(){t.checkTableIsChanged.call(t,e)}),e)}this.refresh(),this.setWidthes(),this.__applyFilters(),e&&(this.isMobile?t._addInsertWithPanel(e):t._addInsert(e))},_addSave:function(){t("body").on("keyup",(function(e){(e.ctrlKey||e.metaKey)&&"s"===String.fromCharCode(e.which).toLowerCase()&&0===t("#bigOneCodemirror").length&&t("body").trigger("ctrlS")}))},reloaded:function(){let e=t("#refresh-notify");e.length&&(e.closest(".alert").remove(),this.checkTableIsChanged(2e3*parseInt(this.checkIsUpdated)))},checkTableIsChanged:function(e){let i=this;document.hidden?setTimeout((function(){i.checkTableIsChanged.call(i,e)}),1e3):i.model.checkTableIsChanged.call(i.model).then((function(n){if(n.no||i.model.tableData.updated.code===n.code)i.checkTableIsChanged.call(i,e);else{let a=function(){i.model.tableData.updated.code===n.code?i.checkTableIsChanged.call(i,e):(t.notify({message:'<div id="refresh-notify"><button class="btn btn-warning btn-sm" style="margin-right: 20px;">Обновить</button> <span>Таблица была изменена пользователем <b>'+n.username+"</b> в <b>"+App.dateFormats.covert(n.dt,"YY-MM-DD HH:mm","HH:mm DD.MM")+"</b> </span></div>"},{type:"warning",allow_dismiss:!1,delay:0}),t("#refresh-notify button").on("click",(function(){i.model.refresh()})))};i.model.doAfterProcesses((function(){setTimeout(a,200)}))}}))},_getTableMainFieldName:function(e,t){let i;return Object.keys(e).some((function(n){let a=e[n];if(a.id==t)return i=a.name,!0})),i},_getFieldbyName:function(e){return this.fields[e]},_getColumnIndexByTd:function(e,t){return(t=t||e.closest("tr")).find("td").index(e)},_fieldByTd:function(e,t){let i=this._getColumnIndexByTd(e,t);return this.fieldCategories.visibleColumns[i-1]},_getRowIndexById:function(e){let t=this;for(let i in t.data)if(t.data[i].id==e)return i;return null},_getFieldBytd:function(e){return e.closest("tr").is(".DataRow")?this.fieldCategories.visibleColumns[e.closest("tr").find(e.prop("tagName")).index(e)-1]:this.fields[e.data("field")]},_isParamsArea:function(e){return e.closest("table").is(".pcTable-paramsTable")},_isFootersArea:function(e){return e.closest("tbody").is(".pcTable-footers")},_getItemBytd:function(e){let t=e.closest("tr");return this._getItemByTr(t)},_getItemByTr:function(e){return e.is(".DataRow")?this.data[e.data("pctableitemid")]:this.data_params},_getItemById:function(e){return this.data[e]},_deleteItemById:function(e){let t=this._getItemById(e);t&&t.$tr&&t.$tr.remove(),this.openedPanels[e]&&this.openedPanels[e].close(),["dataSorted","dataSortedVisible","__checkedRows"].some((function(t){let i=this[t].indexOf(e);-1!==i&&this[t].splice(i,1)}),this),this.isTreeView&&this.treeDeletingRow(e),delete this.data[e]},_getTdByFieldName:function(e,t){let i=0;return this.fieldCategories.visibleColumns.every((function(t,n){return e!=t.name||(i=n,!1)})),this._getTdByColumnIndex(t,i+1)},_getTdByColumnIndex:function(e,t){return e.find("td:eq("+t+")")},refresh:function(){this._refreshTitle(),this._refreshParamsBlock(),this._refreshFiltersBlock(this.data_params),this._refreshFootersBlock(),this._refreshContentTable()},initRowsData:function(){if(this.__checkedRows=[],this.dataSorted=[],this.dataSortedVisible=[],this.ScrollClasterized&&this.ScrollClasterized.emptyCache(),this.isTreeView)this.tree.forEach((e,t)=>{this.getTreeBranch(e,t)}),this.rows&&this._treeApplyRows(this.rows),setTimeout(()=>{this.treeApply()}),this.model.setLoadedTableData(this.data);else{let e={};this.rows&&this.rows.map((function(t){this.dataSorted.push(t.id),this.dataSortedVisible.push(t.id),e[t.id]=t,e[t.id].$checked=-1!==this.__checkedRows.indexOf(t.id)}),this),this.data=e,this.model.setLoadedTableData(this.data,this.PageData?this.PageData.offset:void 0,this.PageData?this.PageData.onPage:void 0)}}})}(window,jQuery),App.models||(App.models={}),App.models.table=function(e,t,i){let n,a,l,o,s={},r=0,d=null;const c=function(e){let t={};return Object.keys(e).forEach((function(i){/^\$/.test(i)||("id"===i?t[i]=e[i]:null!==e[i]&&"object"==typeof e[i]&&-1!==Object.keys(e[i]).indexOf("v")?t[i]=e[i].v:t[i]=e[i])})),t};return i=i||{},{getUri:function(){return this.url},setLoadedTableData:function(e,t,i){n=e,a=t,l=i},addFiltersData:function(e){"use strict";i=$.extend(!0,{},i,e)},tableData:t,url:e,doAfterProcesses:function(e){let t=this;setTimeout((function(){t.getDefferedProcess().then(e)}),50)},getDefferedProcess:function(){return new Promise((e,t)=>{Promise.all(Object.values(s)).then(()=>{e()})})},showLinks:function(e){App.showLInks(e.links,o.model),delete e.links},shoInterfaceDatas:function(e){App.showDatas.call(o.model,e.interfaceDatas,null,window),delete e.interfaceDatas},showPanels:function(e){App.showPanels(e.panels),delete e.panels},addPcTable:function(e){o=e},__ajax:function(e,c,p,f,h){"use strict";let u=this.url,m=!1,b=$.Deferred();h=h||{};let g=!1,v=!1,w=$.extend(!0,{},c,{tableData:t,ajax:!0},i,h);"checkTableIsChanged"===c.method||"checkForNotifications"===c.method?"checkForNotifications"!==c.method&&(w=$.extend({},c,{code:t.updated.code,ajax:!0},i),t.sess_hash&&(w.tableData={sess_hash:t.sess_hash})):(m=!0,f||setTimeout((function(){g||(App.fullScreenProcesses.showCog(),v=!0)}),1e3)),void 0!==w.data&&"object"==typeof w.data&&(w.data=JSON.stringify(w.data)),n&&(w.ids=JSON.stringify(Object.keys(n))),void 0!==a&&(w.offset=a,w.onPage=l);let _=this,y=function(e){let t={edit:"Изменение",checkInsertRow:"Предварительное добавление",duplicate:"Дублирование",refresh_rows:"Пересчет строк",loadPage:"Загрузка страницы",getTableData:"Загрузка информации о таблице",refresh:"Обновление данных таблицы",checkEditRow:"Предварительный расчет панели",saveEditRow:"Сохранение панели",save:"Изменение поля",click:"Нажатие кнопки",selectSourceTableAction:"Вызов панели",add:"Добавление строки",getEditSelect:"Загрузка селекта",delete:"Удаление"},i=$("#table").data("pctable");if(i){if(e.LOGS&&(i.LOGS||(i.LOGS={}),i.LOGS=$.extend(i.LOGS,e.LOGS)),e.FullLOGS){i.FullLOGS||(i.FullLOGS=[]);let n={text:t[w.method]||w.method};n.children=e.FullLOGS,e.FullLOGS.length&&(i.FullLOGS.push(n),App.blink(i.LogButton,8,"#fff"))}if(e.FieldLOGS&&Object.keys(e.FieldLOGS).length&&(i.FieldLOGS=i.FieldLOGS||[],i.FieldLOGS.push({data:e.FieldLOGS,name:t[w.method]||w.method})),"loadPage"!==w.method&&i.PageData&&e.allCount){let t=!1;"offset"in e&&null!==e.offset&&i.PageData.offset!==e.offset&&(t=!0,i.PageData.offset=e.offset),"allCount"in e&&null!==e.allCount&&i.PageData.allCount!==e.allCount&&(t=!0,i.PageData.allCount=e.allCount),t&&i.PageData.$block.empty().append(i._paginationCreateBlock.call(i))}}if(e.error){var n=$("<div>").html(e.error.replace(/\[\[(.*?)\]\]/g,"<b>$1</b>"));if(e.log){let t=$('<button class="btn btn-xxs btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> c</i></button>');t.on("click",(function(){BootstrapDialog.show({message:$('<pre style="max-height: '+($("body").height()-200)+'px; overflow: scroll">').css("font-size","11px").text(JSON.stringify(e.log,null,1)),type:BootstrapDialog.TYPE_DANGER,title:"Лог расчета",buttons:[{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],draggable:!0,onshown:function(e){e.$modalContent.position({of:window})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:1200})}})})),n.append(" "),n.append(t)}App.notify(n),b.reject(e)}else e.reload?window.location.href=window.location.href:(e.links&&e.links.length>0&&_.showLinks(e),e.interfaceDatas&&e.interfaceDatas.length>0&&_.shoInterfaceDatas(e),e.panels&&e.panels.length>0&&_.showPanels(e)),b.resolve(e)},x=function(e){let t,i;e&&200===e.status?e.responseJSON&&e.responseJSON.error?t=e.responseJSON.error:(t=$("<div>Ошибка выполнения операции  </div>"),o&&o.isCreatorView&&(t.append('<button class="btn danger-backg btn-xs" data-toggle="collapse" data-target="#notify-texh"><i class="fa fa-angle-down"></i><i class="fa fa-angle-up"></i></button>'),t.append($('<div id="notify-texh" class="collapse">').append($("<code>").text(e.responseText))))):!p&&e&&"abort"!=e.statusText&&"error"!=e.statusText?(t=e.statusText,i=200):p&&p.jqXHR&&"abort"!==p.jqXHR.statusText&&(t="Нет соединения с сервером",i=200),t&&-1===["checkTableIsChanged","checkForNotifications"].indexOf(c.method)&&(i?setTimeout((function(){App.notify(t)}),i):App.notify(t),e.responseText),b.reject(e)},k=function(){(new Date).getTime()-d<150?setTimeout(k,50):(d=(new Date).getTime(),/\?/.test(u)?u+="&":u+="?",u+="rn="+Math.round(1e5*Math.random())+(w.method||""),$.ajax({url:u,method:e,data:w,dataType:"json",beforeSend:function(e,t){p&&(p.jqXHR=e)}}).then(y).fail(x))};k();let C,T=++r;s[T]=new Promise(e=>{C=e});let S=function(){setTimeout(()=>{delete s[T]},1e3),g=!0,v&&App.fullScreenProcesses.hideCog()};return m||(C(),C=()=>{}),b.always((function(){setTimeout(S,100),setTimeout(C,50)})),b.promise()},delete:function(e){return 0!==e.length&&this.__ajax("post",{delete_ids:JSON.stringify(e),method:"delete"})},duplicate:function(e,t,i){return 0!==e.length&&this.__ajax("post",{duplicate_ids:JSON.stringify(e),data:t,insertAfter:i,method:"duplicate"})},dblClick:function(e,t){return this.__ajax("post",{field:t,id:e,method:"dblClick"})},getFieldLog:function(e,t,i){return this.__ajax("post",{field:e,id:t,method:"getFieldLog",rowName:i})},refresh_rows:function(e){return 0!==e.length&&this.__ajax("post",{refreash_ids:JSON.stringify(e),method:"refresh_rows"})},refresh_cycles:function(e){return 0!==e.length&&this.__ajax("post",{refreash_ids:JSON.stringify(e),method:"refresh_cycles"})},checkUnic:function(e,t){"use strict";return this.__ajax("post",{fieldName:e,fieldVal:t,method:"checkUnic"})},add:function(e){return this.__ajax("post",{data:e,method:"add"})},getValue:function(e,t){return this.__ajax("post",{data:e,method:"getValue",table_id:t})},getNotificationsTable:function(){return this.__ajax("post",{method:"getNotificationsTable"})},get:function(e){return this.__ajax("get",{id:e})},setTableFavorite:function(e){return this.__ajax("post",{status:e,method:"setTableFavorite"})},checkInsertRow:function(e,t){var i={};return $.each(e,(function(e,t){null!=t&&(i[e]=t)})),this.__ajax("post",{data:i,editedFields:JSON.stringify(t),method:"checkInsertRow"})},checkEditRow:function(e){var t={};return $.each(e,(function(e,i){null!=i&&(t[e]=i)})),this.__ajax("post",{data:t,method:"checkEditRow"})},checkTableIsChanged:function(){return this.__ajax("post",{method:"checkTableIsChanged",table_id:o.tableRow.id,cycle_id:o.tableRow.cycle_id})},checkForNotifications:function(e,t,i){return this.__ajax("post",{method:"checkForNotifications",periodicity:e,activeIds:t},i)},notificationUpdate:function(e,t,i,n){return this.__ajax("post",{method:"notificationUpdate",id:e,num:i,item:n,type:t})},selectSourceTableAction:function(e,t){return this.__ajax("post",{field_name:e,data:t,method:"selectSourceTableAction"})},saveEditRow:function(e){var t={};return $.each(e,(function(e,i){void 0!==i&&(t[e]=i)})),this.__ajax("post",{data:t,method:"saveEditRow"})},getEditSelect:function(e,t,i,n,a){return this.__ajax("post",{data:{item:e,field:t},q:i,parentId:n,method:"getEditSelect"},void 0,!a)},loadPreviewHtml:function(e,t,i){return this.__ajax("post",{data:{item:c(t),field:e,val:i},method:"loadPreviewHtml"},null,!0)},save:function(e){let t={};return e.params&&Object.keys(e.params).some((function(e){if("filter"===o.fields[e].category)return o._filtersBlock.data("cryptoFilters")&&(t.filters=o._filtersBlock.data("cryptoFilters")),!0})),this.__ajax("post",{data:e,method:"edit"},null,null,t)},click:function(e){return this.__ajax("post",{data:e,method:"click"})},csvExport:function(e,t,i){return this.__ajax("post",{method:"csvExport",type:t,sorted_ids:JSON.stringify(e),visibleFields:JSON.stringify(i)})},csvImport:function(e,t,i,n){return this.__ajax("post",{csv:e,type:t,answers:i,method:"csvImport",visibleFields:JSON.stringify(n)})},getTableData:function(e){return this.__ajax("post",{method:"getTableData",tableData:{sess_hash:e}})},panelsView:function(e){return this.__ajax("post",{method:"panelsViewCookie",switcher:e?1:0})},refresh:function(e){let t;e=e||function(e){o.table_modify.call(o,e),o.reloaded.call(o)},o.treeIndex&&(t={},Object.keys(o.treeIndex).forEach(e=>{t[e]=o.treeIndex[e].l?1:0}),t=JSON.stringify(t)),this.__ajax("post",{method:"refresh",tree:t}).then((function(t){try{e(t)}catch(e){window.location.reload()}}))},saveOrder:function(e){return this.__ajax("post",{method:"saveOrder",orderedIds:JSON.stringify(e)})},setCommentsViewed:function(e,t,i){return this.__ajax("post",{method:"setCommentsViewed",nums:e,field_name:t,id:i})},AddEyeGroupSet:function(e,t){return this.__ajax("post",{method:"addEyeGroupSet",name:e,fields:t})},removeEyeGroupSet:function(e){return this.__ajax("post",{method:"removeEyeGroupSet",index:e})},leftEyeGroupSet:function(e){return this.__ajax("post",{method:"leftEyeGroupSet",index:e})},reUser:function(e){return this.__ajax("post",{method:"reuser",userId:e,location:window.location.pathname})},printTable:function(e){return this.__ajax("post",{method:"printTable",settings:JSON.stringify(e)})},getAllTables:function(){return this.__ajax("post",{method:"getAllTables"})},calcFieldsLog:function(e,t){return this.__ajax("post",{method:"calcFieldsLog",calc_fields_data:e,name:t})},renameField:function(e){return this.__ajax("post",{method:"renameField",name:e})},panelButtonsClick:function(e,t){return this.__ajax("post",{method:"panelButtonsClick",hash:e,index:t})},panelButtonsClear:function(e){return this.__ajax("post",{method:"panelButtonsClear",hash:e})},buttonsClick:function(e,t){return this.__ajax("post",{method:"linkButtonsClick",hash:e,index:t})},inputClick:function(e,t){return this.__ajax("post",{method:"linkInputClick",hash:e,val:t})},getChartTypes:function(){return this.__ajax("post",{method:"getChartTypes"})},getPanelFormats:function(e,t){return this.__ajax("post",{method:"getPanelFormats",field:e,id:t})},loadUserButtons:function(){return this.__ajax("post",{method:"loadUserButtons"})},userButtonsClick:function(e,t){return this.__ajax("post",{method:"userButtonsClick",hash:e,index:t})},loadPage:function(e,t,i,n){let a={};return e&&e.filtersString&&(a.filters=e.filtersString),e.PageData.loading=!0,this.__ajax("post",{method:"loadPage",lastId:t,pageCount:i,prevLastId:n},null,null,a).then((function(t){let i;e.loadedPage=t.page,e.rows=t.rows,i=t.rows.length?{firstId:t.rows[0].id,lastId:t.rows[t.rows.length-1].id}:{firstId:0,lastId:0},e.PageData={...e.PageData,offset:t.offset,allCount:t.allCount,loading:!1,...i},e.initRowsData.call(e),e._refreshContentTable.call(e,!1,!0),e.__applyFilters.call(e,!0),e.PageData.$block.empty().append(e._paginationCreateBlock.call(e))}))}}},App.blink=function(e,t,i){let n=t||8,a=!0,l=function(){e&&(a?e.css("background-color",i):e.css("background-color",""),a=!a,n--,n>0&&setTimeout(l,300))};setTimeout(l,300)},App.mobilePanel=function(e,t,i){return i=i||{},window.top.BootstrapDialog.show($.extend({type:"edit",message:t,draggable:!0,title:e,cssClass:"mobile-panel "+(i.buttons?" with-buttons":"")},i))},App.panelTimer=function(e,t,i){let n,a=t,l=$("<div>");l.html(a);let o=BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:e,message:l,onhide:function(){n&&clearTimeout(n)},buttons:[{action:function(e){n&&clearTimeout(n),e.close()},label:"Отмена"}]}),s=function(){--a<=0?(o.close(),i()):(l.html(a),n=setTimeout(s,1e3))};s()},App.panel=function(e,t,i){return i=i||{},window.top.BootstrapDialog.show($.extend({type:"edit",message:t,draggable:!0,title:e,cssClass:"web-panel "+(i.buttons?" with-buttons ":"")+(i.class||"")},i))},App.setSessionStorage=function(e,t){sessionStorage.setItem(e,JSON.stringify(t))},BootstrapDialog.BUTTON_SIZES[BootstrapDialog.SIZE_NORMAL]="btn-m",BootstrapDialog.defaultOptions.animate=!1,BootstrapDialog.defaultOptions.closeByBackdrop=!1,BootstrapDialog.defaultOptions.nl2br=!1,BootstrapDialog.defaultOptions.type=null,BootstrapDialog.BootstrapDialogModal.prototype.resetScrollbar=function(){0===this.getGlobalOpenedDialogs().length&&this.$body.css("padding-right",5)},function(){let e,t,i=0,n=-1;setTimeout(()=>{t=App.models.table("/Table/"),t.addPcTable({model:t})},10),App.checkNotificationManager=function(i){if(i=i||void 0,Object.keys(i).length>1){if(!e||!e.closest("body").length){let n;e=$('<div data-notify="container" class="col-xs-11 col-sm-4 alert alert-warning" role="alert" id="notifies_manager" ><button type="button" aria-hidden="true" class="close" data-notify="dismiss">&times;</button><button class="timer" id="notification_clock_panel_all_timer"><i class="fa fa-clock-o"></i></button></div>'),e.appendTo("body"),e.find("button.close").on("click",(function(){a(),e.remove(),e=null,t.notificationUpdate(Object.keys(i),"deactivate").then((function(){})),Object.values(i).forEach(e=>{e.forEach(e=>{e.$modal.remove()})}),i=[]})).on("remove",()=>{n&&n.popover("destroy")}),e.find("button.timer").on("click",(function(){if($(this).is(".active"))return!1;$(this).addClass("active"),n=$(this),$div=$('<div><div id="notification_clock_panel_all"><span class="clocks-na">На</span> <input type="number" step="1" value="10" class="form-control"/> <select class="form-control"><option  selected value="1">минут</option><option value="2">часов</option><option value="3">дней</option></select> <button>Отложить все</button></button></div></div>'),$div.on("click","button",(function(){let n=$div.find("input").val(),l=$div.find("select").val();a(),t.notificationUpdate(Object.keys(i),"later",n,l).then((function(){})),e.remove(),e=null,Object.values(i).forEach(e=>{e.forEach(e=>{e.$modal.remove()})}),i=[]})),n.popover({placement:"bottom",content:$div,html:!0,animation:!1,container:$("body")}).popover("show"),n.on("remove",a),setTimeout(()=>{$("body").on("click.notes",e=>{$(e.originalEvent.path[0]).closest("#notification_clock_panel_all").length||(n.popover("destroy"),a())})},20)}));const a=function(){$("body").off("click.notes"),$("#notification_clock_panel_all_timer").removeClass("active")}}}else e&&(e.remove(),e=null)},App.showLInks=function(e,t){e.forEach((function(e){if(-1!==["top-iframe","iframe"].indexOf(e.target)&&window.top!=window)return void window.top.App.showLInks([e],t);let a=function(l){"use strict";if(e.postData){let n,o="_self";if("iframe"===l||"top-iframe"===l){let l="iframe"+ ++i;o=l;let s,r=BootstrapDialog.show({message:s=$('<iframe style="width: 100%; '+(e.width?"":"min-width: 500px;")+' height: 70vh; border: none" name = "'+l+'"></iframe>'),size:BootstrapDialog.SIZE_WIDE,title:e.title,draggable:!0,cssClass:"target-iframe",onhidden:function(){if(e.refresh){$("#table").data("pctable");t.refresh()}},onshown:function(t){if(e.width){let i=500;e.width>i&&(i=e.width),t.$modalDialog.width(i)}let i=s.get(0).contentWindow,n=function(){try{i.App&&i.App.setSessionStorage?i.App.setSessionStorage.call(i,"linkObject",e):setTimeout(n,200)}catch(e){}};n()},buttons:[{label:"Обновить",cssClass:"btn-m btn-default",action:function(){s.get(0).contentWindow.location.reload(),n.detach()}},{label:"Открыть",cssClass:"btn-m btn-default",action:function(e){a("self")}},{label:"Вкладка",cssClass:"btn-m btn-default",action:function(e){window.open(s.get(0).contentWindow.location,"_blank"),e.close()}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}]});s.on("load",(function(){let e=s.get(0).contentWindow;try{e.closeMe=function(){r.close()}}catch(e){}}))}else"blank"===l?o="_blank":"parent"===l?o="_parent":"top"===l?o="_top":window.parent!==window&&(sessionStorage.linkObject=JSON.stringify(e));n=$("<form>",{method:"post",action:e.uri,target:o});const s=function(e,t){"boolean"==typeof t&&(t=!0===t?"true":"false"),"string"==typeof t||"number"==typeof t||null===t?n.append($("<input>",{type:"hidden",name:e,value:t})):$.each(t,(function(t,i){s(e+"["+t+"]",i)}))};$.each(e.postData,(function(e,t){s(e,t)})),n.appendTo("body").submit(),n.detach()}else switch(l){case"top":window.top.location.href=e.uri;break;case"parent":window.parent.location.href=e.uri;break;case"blank":let i=$('<a href="'+e.uri+'" target="_blank">link</a>');i.appendTo("body"),i.get(0).click(),i.remove();break;case"iframe":case"top-iframe":let l=e.uri;if(e.elseData){let t=[];!1===e.elseData.header&&t.push("param"),!1===e.elseData.footer&&t.push("footer"),l+="#"+encodeURIComponent(JSON.stringify({wc:t}))}let o=$('<iframe src="'+l+'" style="width: 100%; height: 70vh; border: none"></iframe>'),s=BootstrapDialog.show({message:o,draggable:!0,size:BootstrapDialog.SIZE_WIDE,title:e.title,cssClass:"target-iframe",onhidden:function(){e.refresh&&t.refresh(),n--},onshown:function(t){e.width&&t.$modalDialog.width(e.width),++n&&t.$modalDialog.css("margin-top",30+20*n);let i=o.get(0).contentWindow,a=function(){try{i.App&&i.App.setSessionStorage?i.App.setSessionStorage.call(i,"linkObject",e):setTimeout(a,200)}catch(e){}};a()},buttons:[{label:"Обновить",cssClass:"btn-m btn-default",action:function(){o.get(0).contentWindow.location.reload()}},{label:"Открыть",cssClass:"btn-m btn-default",action:function(t){try{o.get(0).contentWindow.sessionStorage.linkObject&&(e=JSON.parse(o.get(0).contentWindow.sessionStorage.linkObject))}catch(e){}a("self")}},{label:"Вкладка",cssClass:"btn-m btn-default",action:function(e){window.open(o.get(0).contentWindow.location,"_blank"),e.close()}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}]});o.on("load",(function(){let e=o.get(0).contentWindow;try{e.closeMe=function(){s.close()}}catch(e){}}));break;default:window.parent!=window&&(sessionStorage.linkObject=JSON.stringify(e)),window.location.href=e.uri}};a(e.target)}))},App.showDatas=function(e,t,i){let n,l=[],o=this;return e.forEach((function(e){switch(e[0]){case"input":let s,r,d=$("<div>").html(e[1].html);d.find("#ttmInput").length?s=d.find("#ttmInput"):(s=$('<input type="text" class="form-control" id="ttmInput">'),e[1].type&&(s.attr("type",e[1].type),"password"===e[1].type&&s.attr("autocomplete","off")),e[1].value&&s.val(e[1].value),d.append(s),s.wrap("<div>"),s.on("keydown",e=>{13===e.keyCode&&c()}));let c=function(){o.inputClick(e[1].hash,s.val()).then((function(){e[1].close&&i&&i.closeMe?window.closeMe():e[1].refresh&&o.refresh(),r.close()}))};setTimeout(()=>{s.focus()},1),n={buttons:[{label:e[1].button||"Сохранить",action:c},{label:"Отмена",action:function(e){e.close()}}],class:"linkButtons"},screen.width<=window.MOBILE_MAX_WIDTH?r=App.mobilePanel(e[1].title,d,n):(!n.width&&n.html||(n.onshown=function(e){n.width&&e.$modalDialog.width(n.width)}),r=App.panel(e[1].title,d,n));break;case"buttons":n={...e[1],buttons:[],class:"linkButtons"},e[1].buttons.forEach((function(t,a){n.buttons.push({id:"link-btn"+a,label:t.text,action:function(t){o.buttonsClick(e[1].hash,a).then((function(){e[1].close&&i&&i.closeMe?window.closeMe():e[1].buttons[a].refresh&&o.refresh(),t.close()}))},icon:t.icon?"fa fa-"+t.icon:null,background:t.background,color:t.color})})),screen.width<=window.MOBILE_MAX_WIDTH?App.mobilePanel(e[1].title,$("<div>").html(e[1].html),n):(!n.width&&n.html||(n.onshown=function(e){n.width&&e.$modalDialog.width(n.width),n.html||e.$modalBody.remove(),n.buttons.forEach(t=>{let i=e.getButton(t.id);t.background&&i.css("background-color",t.background),t.color&&i.css("color",t.color)})}),App.panel(e[1].title,$("<div>").html(e[1].html),n));break;case"table":if(window.top!=window)return window.top.App.showDatas.call(o,[e]);l.push(function(e,t){let i;e.height&&(i=e.height,/^\d+$/.test(e.height)&&(i+="px"));let n="/Table/0/"+e.table_id+"?sess_hash="+e.sess_hash;"/"===window.location.pathname||/^\/Table\//.test(window.location.pathname)||(n=e.table_id+"?sess_hash="+e.sess_hash);let l=$('<iframe style="width: 100%; height: '+(i||"80vh")+'; border: none;" src="'+n+'">');$("body").append(l);let o=[];$("#table").data("pctable")&&$("#table").data("pctable").isCreatorView&&o.push({label:"В новой вкладке",cssClass:"btn-m btn-danger",action:function(e){window.open(l.get(0).contentWindow.location,"_blank");e.close()}});let s=a(e.title,l,e.width,e.refresh,null,t,o);l.on("load",(function(){l.get(0).contentWindow.closeMe=function(){s.close()}}))}(e[1],o));break;case"text":l.push(function(e,t){a(e.title,e.text,e.width,e.refresh,null,t)}(e[1],o));break;case"print":l.push(function(e,t,i){if(App.fullScreenProcesses.showCog(),i){var n=new Blob([atob(i)],{type:"application/pdf"}),a=URL.createObjectURL(n),l=document.createElement("a");l.href=a,l.target="_blank",document.body.appendChild(l),l.click()}else{let i=$('<iframe style="width: 500px; height: 200px; position: absolute; top: -1000px; background: #fff;">').appendTo(window.top.document.body)[0],n=i.contentWindow?i.contentWindow:i.contentDocument.defaultView;n.document.head.innerHTML="<style>"+t+"</style>",n.document.body.innerHTML=e;let a=n.document.body,l=$.Deferred(),o=0;const s=function(){a.scrollTop=a.scrollHeight+100,++o<100&&a.scrollTop>=a.scrollHeight?setTimeout(s,50):setTimeout((function(){l.resolve()}),2e3)},r=function(){++o<100&&a.scrollHeight<200?setTimeout(r,50):(o=0,s())};r(),l.then((function(){App.fullScreenProcesses.hideCog(),setTimeout((function(){n.focus(),n.print()}),250),setTimeout((function(){}),1e4)}))}}(e[1].body,e[1].styles));break;case"notification":let p,f,h=function(e){let t={x:20,y:70};return screen.width<=window.MOBILE_MAX_WIDTH&&(t.x=.09*window.innerWidth/2),e&&(t.y+=60),t}();e[1].text?f="<div>"+e[1].text+"</div>":(f=e[1].title+'<div class="body"></div>',setTimeout(()=>{p.$ele.find(".body").append(function(e,t){let i;e.height&&(i=e.height,/^\d+$/.test(e.height)&&(i+="px"));let n="/Table/0/"+e.table_id+"?sess_hash="+e.sess_hash;/^\/Table\//.test(window.location.pathname)||(n=e.table_id+"?sess_hash="+e.sess_hash);let a=$('<iframe style="width: 100%; height: '+(i||"80vh")+'; border: none;" src="'+n+'">');return a.on("load",(function(){let e=a.get(0).contentWindow;e.closeMe=t,$(e.document.body).css("background-color","transparent")})),a}(e[1],()=>{p.$ele.remove()}))})),p=$.notify({message:f},{offset:h,type:"warning",allow_dismiss:!0,delay:0,onClose:function(){p.$ele.data("deactivated")||o.notificationUpdate(t,"deactivate").then((function(){p.$ele.trigger("hide.bs.modal")}))}}),p.$ele.find("button.close").after('<button class="timer"><i class="fa fa-clock-o"></i></button>'),p.$ele.css("transition","none"),p.$ele.on("click",".timer:not(.disabled)",(function(){let e=$(this);e.addClass("disabled"),$div=$('<div><div id="notification_clock_panel"><span class="clocks-na">На</span> <input type="number" step="1" value="10" class="form-control"/> <select class="form-control"><option  selected value="1">минут</option><option value="2">часов</option><option value="3">дней</option></select> <button>Отложить</button></button></div></div>'),$div.on("click","button",(function(){let n=$div.find("input").val(),a=$div.find("select").val();i(),o.notificationUpdate(t,"later",n,a).then((function(){})),e.popover("destroy"),p.$ele.data("deactivated",!0),p.$ele.find('button[data-notify="dismiss"]').click()}));const i=function(){$("body").off("click.note"+t),e.removeClass("disabled")};e.popover({placement:"bottom",content:$div,html:!0,animation:!1,container:$("body")}).popover("show"),e.on("remove",i),setTimeout(()=>{$("body").on("click.note"+t,t=>{$(t.originalEvent.path[0]).closest("#notification_clock_panel").length||(e.popover("destroy"),i())})},20)})),l.push({$modal:p.$ele,simpleClose:()=>{p.$ele.data("deactivated",!0),p.$ele.find('button[data-notify="dismiss"]').click()},notification:p})}})),l},App.getPcTableById=function(e,t,i,n){let a=$.Deferred();return new App.models.table("/Table/0/"+e.toString(),{},{}).getTableData(t?t.sess_hash:null).then((function(l){if(n&&(!1===n.withHeader||!1===n.withFooter)){Object.values(l.fields).forEach((function(e,t){("param"===e.category&&!1===n.withHeader||"footer"===e.category&&!1===n.withFooter)&&delete l.fields[e.name]})),delete n.withHeader,delete n.withFooter}l.model=new App.models.table("/Table/0/"+e.toString(),$.extend({updated:l.updated},t||{})),$.extend(!0,l,n);let o=new App.pcTableMain(i,l);a.resolve(o)})),a.promise()},App.showPanels=function(e){if(window.top!=window)return window.top.App.showPanels.call(window.top,e);let t={},i=$.Deferred();const n=function(){let a=e.shift(),l={},o={};a.id?l.id=a.id:a.field&&(l=a.field,o=l);const s=function(t){new EditPanel(t.tableRow.id,null,l,e.length>0,o).then((function(t,l){if((t||l)&&e.length)n();else{if(a.refresh){$("#table").data("pctable").model.refresh()}i.resolve()}}))};a.uri!==window.location.pathname?t[a.uri]?s(t[a.uri]):new App.models.table(a.uri,{},{}).getTableData().then((function(e){e.model=new App.models.table(a.uri,{updated:e.updated}),t[a.uri]=new App.pcTableMain(null,e),s(t[a.uri])})):s($("#table").data("pctable"))};return n(),i};let a=function(e,t,i,a,l,o,s){return(s=s||[]).push({label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}),BootstrapDialog.show({message:t,title:e,type:l||null,draggable:!0,onhidden:function(){a&&("strong"===a?window.location.reload():o.refresh()),n--},onshown:function(e){i&&e.$modalDialog.width(i),++n&&e.$modalDialog.css("margin-top",30+20*n)},buttons:s})}}(),Object.equals=function(e,t){let i=[];return function e(t,n){if(t===n)return!0;if(t instanceof Date&&n instanceof Date)return+t==+n;if("object"!=typeof t||"object"!=typeof n||null===n||null===t)return!1;if(function(e,t){for(var n=i.length;n--;)if(!(i[n][0]!==e&&i[n][0]!==t||i[n][1]!==t&&i[n][1]!==e))return!0;return!1}(t,n))return!0;if(i.push([t,n]),Array.isArray(t)!==Array.isArray(n))return!1;if(Array.isArray(t)){if(t.length!==n.length)return!1;let i=t.length;for(;i--;)if(!e(t[i],n[i]))return!1}else{let i=Object.keys(t),a=i.length;if(Object.keys(n).length!==a)return!1;for(;a--;)if(!e(t[i[a]],n[i[a]]))return!1}return!0}(e,t)},Object.getPath=function(e,t,i){let n=e;for(let e=0;e<t.length;e++){let a=t[e];if("object"!=typeof n||!(a in n))return i;n=n[a]}return n},String.prototype.hashCode=function(){var e,t=0;if(0===this.length)return t;for(e=0;e<this.length;e++)t=(t<<5)-t+this.charCodeAt(e),t|=0;return t},App.confirmation=function(e,t,i){let n=[];return Object.keys(t).forEach((function(e){n.push({label:e,action:t[e]})})),BootstrapDialog.show({type:"edit",title:i,message:e,buttons:n,draggable:!0,onshow:function(e){e.$modalContent.css({width:"70vw",maxWidth:"800px"})},onshown:function(e){e.$modalContent.position({of:window})}})},App.copyMe=function(e){let t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)},App.dateFormats={base:"DD.MM.YY",db:"YYYY-MM-DD",covert:function(e,t,i){return moment(e,t).format(i)},covertToDb:function(e,t){return t=t||this.base,moment(e,t).format(this.db)},covertFromDb:function(e,t){return t=t||this.base,moment(e,this.db).format(t)},isValid:function(e,t){return t=t||this.base,moment(e,t).isValid()}},App.dateTimeFormats={base:"DD.MM.YY HH:mm",db:"YYYY-MM-DD HH:mm",covert:function(e,t,i){return moment(e,t).format(i)},covertToDb:function(e,t){return t=t||this.base,moment(e,t).format(this.db)},covertFromDb:function(e,t){return t=t||this.base,moment(e,this.db).format(t)},isValid:function(e,t){return t=t||this.base,moment(e,t).isValid()}},function(){let e="fa-cog",t=$("#big_loading i"),i=0;App.fullScreenProcesses={showCog:function(){i++,1===i&&App.fullScreenProcesses.show("fa-cog",!0)},hideCog:function(){i--,i<1&&(i=0,App.fullScreenProcesses.hide())}},App.fullScreenProcesses.show=function(i,n){n=n||!1,$("body").addClass("lock"),n&&!t.is(".fa-spin")?t.addClass("fa-spin"):!n&&t.is(".fa-spin")&&t.removeClass("fa-spin"),e!=i&&(t.removeClass(e).addClass(i),e=i),$("#big_loading").show().animate({opacity:1},250)},App.fullScreenProcesses.hide=function(e){$("body").removeClass("lock"),$("#big_loading").animate({opacity:0},250,(function(){$("#big_loading").hide()}))}}(),App.hexToRGB=function(e,t){var i=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return t?"rgba("+i+", "+n+", "+a+", "+t+")":"rgb("+i+", "+n+", "+a+")"},$.fn.extend({isAttached:function(){return 1===$(this).closest("html").length}}),App.isTopWindow=function(){let e=!1;try{e=window!=window.top||document!=top.document||self.location!=top.location}catch(t){e=!0}return!e},App.logOutput=function(e){let t=$('<div style="overflow-x: auto">'),i=[{label:"Развернуть все",cssClass:"btn-m btn-default",action:function(e){t.jstree("open_all")}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}];"string"==typeof e&&i.splice(0,1),window.top.BootstrapDialog.show({message:t,type:BootstrapDialog.TYPE_DANGER,title:"Схема расчета",buttons:i,draggable:!0,cssClass:"log-output",onshown:function(i){i.$modalContent.position({of:window.top}),"string"==typeof e?t.html('<div style="color: white; ">'+e+"</div>"):t.jstree({state:{key:"leftTree"},core:{check_callback:!0,open_parents:!0,data:e,themes:{name:"default-dark"}},types:{folder:{},code:{icon:"fa fa-cog"},cogs:{icon:"fa fa-cogs"},error:{icon:"fa fa-exclamation-triangle"},list:{icon:"fa fa-code"},fixed:{icon:"fa fa-hand-rock-o"},param:{icon:"fa fa-hashtag"},execcode:{icon:"fa fa-magic"},recalcs:{icon:"fa fa-recycle"},clocks:{icon:"fa fa-clock-o"},mbs:{icon:"fa fa-database"},selects:{icon:"fa fa-navicon"},"!":{icon:"fa fa-exclamation"},table_simple:App.tableTypes.simple,table_version:App.tableTypes.version,table_calcs:App.tableTypes.calcs,table_tmp:App.tableTypes.tmp,table_globcalcs:App.tableTypes.globcalcs,table_cycles:App.tableTypes.cycles},plugins:["types","themes"]}).on("click","a.jstree-anchor",(function(){let e,i,n=t.jstree(!0).get_node(this.id);try{e=JSON.parse(n.text),i=""}catch(t){try{let t=n.text.match(/^([a-zA-Z_0-1]+)\s*:\s*(.*)$/);e=JSON.parse(t[2]),i=t[1]}catch(t){e=n.text}}if(e){if("string"==typeof e){element=$('<div class="HTMLEditor" id="bigOneCodemirror">').height(500);var a=new CodeMirror(element.get(0),{value:e,mode:"text/html",height:"500px",readOnly:!0,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0});let t=setInterval(()=>{element.isAttached()&&(a.refresh(),clearInterval(t))},50)}else element=$('<div class="JSONEditor">').height(500),a=new JSONEditor(element.get(0),{mode:"view"},e);window.top.BootstrapDialog.show({message:element,title:i,onshown:function(e){e.$modalContent.position({of:window.top})},onshow:function(e){let t=.8*window.top.innerWidth;e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:t})}})}}))},onshow:function(e){let t=.8*window.top.innerWidth;e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:t}),e.$modalContent.find(".modal-body").css("background-color","#333")}})},App.modal=function(e,t,i){var n=$('<div class="modal fade" id="appNotify" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title"></h4> </div> <div class="modal-body"> </div> <div class="modal-footer"> </div> </div> </div> </div>');if((l={body:n.find(".modal-body"),header:n.find(".modal-header"),title:n.find(".modal-title"),footer:n.find(".modal-footer"),block:n}).block.on("hidden.bs.modal",(function(){$(this).remove()})),"object"==typeof e&&e instanceof jQuery?l.body.empty().append(e):l.body.html(e),t?l.title.html(t):l.header.hide(),i)if("object"==typeof i){var a=$("<div>"),l=l;$.each(i,(function(e,t){if("close"!=t){var i="default";"object"==typeof t&&(t.class&&(i=t.class),t.func&&(t=t.func));var n=$('<button type="button" class="btn btn-'+i+'">'+e+"</button>");a.append(n),t&&"function"==typeof t&&n.on("click",(function(){t(l.block)}))}else a.append('<button type="button" class="btn btn-default" data-dismiss="modal">'+e+"</button>")})),l.footer.html(a.children())}else l.footer.html(i);else l.footer.hide();return l.block.modal("show").css("z-index","10000"),l.block},$.expr.pseudos.multiincludes=function(e,t,i){let n=$(e).find("a"),a=(n.data("tokens")||n.text()).toString().toUpperCase().replace("ё","е");return!i[3].toUpperCase().replace("ё","е").split(" ").some((function(e){return-1===a.indexOf(e)}))},App.notify=function(e,t,i){let n=$.Deferred();return window.top.BootstrapDialog.show({message:e,type:BootstrapDialog.TYPE_DEFAULT,title:t,buttons:[{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}],onshow:function(e){t||e.$modalHeader.remove(),e.$modal.css("z-index",2e3),n.resolve(e)}}),n},App.topNotify=function(e,t,i){t=t||"",$("#notifies").append('<div class="alert alert-success"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>'+t+"</strong>"+e+"</div>")},App.popNotify=function(e,t,i,n,a){let l,o="bottom",s={},r={};return e.isParams&&(s=e,e.element&&(t=e.element),e.timeout&&(i=e.timeout),e.container&&(n=e.container),e.trigger&&(a=e.trigger),e.placement&&(o=e.placement),e.class&&(l=e.class),e=e.$text),i=i||void 0,n=n||t.closest(".pcTable-scrollwrapper, .InsertPanel"),a=a||"manual",r=$.extend(r,{html:!0,content:e,trigger:a,container:n,placement:o,width:"70vw",animation:!1}),"default"==i&&(i=2e3),t.on("shown.bs.popover",(function(){let e=t.data("bs.popover"),i=parseInt(e.$tip.css("left")),a=parseInt(e.$arrow.css("left"));if(i<0&&(e.$tip.css("left",0),e.$arrow.css("left",a+i+"px")),"bottom"===o){let i=t.offset().top+t.outerHeight(),a=e.$tip.offset().top,l=n.scrollTop()-n.offset().top;a-i>10&&e.$tip.css("top",i+2+l+(n.is(".InsertPanel")?$(".modal-dialog").offset().top:0))}})),t.popover(r),"manual"==a&&(t.popover("show"),l&&$("#"+t.attr("aria-describedby")).addClass(l)),t.on("remove destroy",(function(){t&&t.attr("aria-describedby")&&t.popover("destroy")})),e.on&&e.on("remove destroy",(function(){t.length&&t.attr("aria-describedby")&&$("#"+t.attr("aria-describedby")).length&&t.popover("destroy")})),i&&setTimeout((function(){t&&t.attr("aria-describedby")&&t.popover("destroy")}),i),t.attr("aria-describedby")},App.ksort=function(e){var t=Object.keys(e).sort(),i={};for(var n in t)i[t[n]]=e[t[n]];return i},App.values=function(e){let t=[];for(let i in e)t.push(e[i]);return t},App.keys=function(e){let t=[];for(let i in e)t.push(i);return t},App.isEmpty=function(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;if("object"!=typeof e)return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0},App.filter=function(e,t){let i={};return Object.keys(e).forEach((function(n){t(n,e[n])&&(i[n]=e[n])})),i},App.openInIframe=function(e,t,i){i=i||"newIframe";let n=$('<iframe style="min-width: 500px; width: 100%; height: 70vh; border: none" name = "'+i+'"></iframe>');BootstrapDialog.show({message:n.attr("src",t),size:BootstrapDialog.SIZE_WIDE,title:e,buttons:[{label:"Обновить",cssClass:"btn-m btn-default",action:function(e){let a;a=$('<iframe style="min-width: 500px; width: 100%; height: 70vh; border: none" name = "'+i+'"></iframe>').attr("src",t),n.replaceWith(a),n=a}},{label:"Открыть",cssClass:"btn-m btn-default",action:function(e){$("<a>").attr("href",t).hide().appendTo("body").get(0).click(),e.close()}},{label:"Вкладка",cssClass:"btn-m btn-default",action:function(e){let i=$("<a>").attr("href",t).attr("target","_blank").hide().appendTo("body");i.get(0).click(),i.remove(),e.close()}},{label:null,icon:"fa fa-times",cssClass:"btn-m btn-default btn-empty-with-icon",action:function(e){e.close()}}]})},App.aInIframe=function(e){return e=$(e),App.openInIframe(e.text(),e.attr("href")),!1},App.reUserInterface=function(e,t,i,n){let a=$("#UserFio");a.css("cursor","pointer");let l=App.models.table("/Table/",{},{isCreatorView:n}),o=$("#table").data("pctable")||{model:l};l.addPcTable(o),i&&App.blink(a,10,"#ffe486"),a.on("click",(function(i){if(a.attr("aria-describedby"))return!0;let o,s=$('<div class="tech-table" style="width: 200px;"></div>');if(t.length){s.height(125);let e=$('<div class="panel-buttons">');s.prepend(e),t.forEach(t=>{let i=$('<button class="btn btn-default btn-xxs"></button>').text(t.title).on("click",()=>{window.location.href="/Table/0/"+t.name});e.append(i)})}else if(!n){s.height(60);let e=$("<div>");s.prepend(e),l.loadUserButtons().then(t=>{t.panelFormats&&t.panelFormats.rows.forEach(i=>{switch(i.type){case"text":e.append($('<div class="panel-text">').text(i.value));break;case"html":e.append($('<div class="panel-html">').html(i.value));break;case"img":e.append($('<div class="panel-img">').append($("<img>").attr("src","/fls/"+i.value+"_thumb.jpg?rand="+Math.random())));break;case"buttons":if(i.value&&i.value.forEach){let n=[];i.value.forEach(e=>{let i=$('<button class="btn btn-default btn-xxs">').text(e.text);n.push(i),e.color&&i.css("color",e.color),e.background&&i.css("background-color",e.background),i.on("click",(function(){l.userButtonsClick(t.panelFormats.hash,e.ind).then((function(t){e.refresh&&l.refresh()}))}))}),e.append($('<div class="panel-buttons">').append(n))}}})})}if(Object.keys(e).length){let i=$('<div class="select-btn"></div>').appendTo(s);o=$('<select data-size="'+(t.length?13-t.length-1:n?13:11)+'" class="open" title="Выберите пользователя" data-style="btn-sm btn-default" data-live-search="true" data-width="100%">'),Object.keys(e).forEach((function(t){o.append($("<option>").text(t).data("content",e[t]))})),i.append(o)}a.popover({html:!0,content:s,trigger:"manual",container:"body",placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),o&&(s.height(350),o.selectpicker("render").selectpicker("toggle"),o.data("container",s),o.on("hide.bs.select",(function(){return o.val()&&l.reUser(o.val()),!1})),setTimeout((function(){a.popover("show"),o.selectpicker("render"),$("#"+a.attr("aria-describedby")).css("top","45px"),o.data("selectpicker").$searchbox.focus()}),300)),setTimeout(()=>{a.popover("show"),$("body").one("click.FioPopover",(function(e){void 0!==e.altKey&&a.popover("destroy")}))},300)}))},App.rgb2hex=function(e){return(e=e.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i))&&4===e.length?"#"+("0"+parseInt(e[1],10).toString(16)).slice(-2)+("0"+parseInt(e[2],10).toString(16)).slice(-2)+("0"+parseInt(e[3],10).toString(16)).slice(-2):""},App.tableTypes={simple:{icon:"fa fa-table",title:"Простая"},version:{icon:"fa fa-calendar",title:"Версионная"},calcs:{icon:"fa fa-calculator",title:"Расчетная в цикле"},globcalcs:{icon:"fa fa-calculator",title:"Расчетная"},tmp:{icon:"fa fa-clock-o",title:"Временная"},cycles:{icon:"fa fa-circle-o",title:"Циклы"}},App.textWithLinks=function(e){return $("<div>").text(e).html().replace(/(https?:\/\/[^\s]+)/g,(function(e){return'<a href="'+e+'" target="_blank">'+e+"</a>"}))},function(){var e=0;App.getUn=function(){return e++}}();